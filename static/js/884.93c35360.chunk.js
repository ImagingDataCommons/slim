"use strict";(self.webpackChunkslim=self.webpackChunkslim||[]).push([[884],{7884:(e,t,n)=>{n.d(t,{Z:()=>mt});var i=n(5671),a=n(3144),o=n(7326),r=n(9340),s=n(1129),l=n(2791),c=n(3504),d=n(6871),u=n(3695),h=n(586),p=n(9135),v=n(4165),m=n(5861),f=n(6014),g=n(6658),S=n(2810),y=n(394),C=n(3949),I=n(184),b=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e="horizontal",t="14px";void 0!==this.props.hasLongValues&&this.props.hasLongValues&&(e="vertical",t="20px");var n=this.props.attributes.map((function(e,n){var i=(0,S.Z)();return(0,I.jsx)(y.Z.Item,{label:e.name,labelStyle:{lineHeight:t},contentStyle:{fontWeight:600,whiteSpace:"pre-line",lineHeight:"14px"},span:1,children:e.value},i)})),i=null;return void 0!==this.props.icon&&(i=(0,I.jsx)(this.props.icon,{})),(0,I.jsxs)(C.Z,{title:this.props.header,extra:i,size:"small",hoverable:this.props.selectable,bordered:void 0!==this.props.header,actions:this.props.methods,children:[(0,I.jsx)(y.Z,{column:1,size:"small",layout:e,bordered:!1,children:n}),this.props.children]})}}]),n}(l.Component);const w=b;const D=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e=[];return null!=this.props.metadata.ClinicalTrialSponsorName&&e.push.apply(e,[{name:"Sponsor Name",value:this.props.metadata.ClinicalTrialSponsorName},{name:"Protocol ID",value:this.props.metadata.ClinicalTrialProtocolID},{name:"Protocol Name",value:this.props.metadata.ClinicalTrialProtocolName},{name:"Site Name",value:this.props.metadata.ClinicalTrialSiteName}]),null!=this.props.metadata.ClinicalTrialTimePointID&&e.push({name:"Time Point ID",value:this.props.metadata.ClinicalTrialTimePointID}),(0,I.jsx)(w,{attributes:e})}}]),n}(l.Component);function x(e){return"object"===typeof e&&null!==e&&void 0!==e&&void 0!==e.Alphabetic?e.Alphabetic.split("^").join(" "):""}function Z(e){if(null!==e&&void 0!==e){var t=e.substring(0,4),n=e.substring(4,6),i=e.substring(6,8);return"".concat(t,"-").concat(n,"-").concat(i)}return""}function V(e){if(null!==e&&void 0!==e){var t=e.substring(0,2),n=e.substring(2,4),i=e.substring(4,6);return"".concat(t,":").concat(n,":").concat(i)}return""}function P(e){return null!==e&&void 0!==e?{F:"Female",M:"Male",O:"Other"}[e]:""}const R=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e=[{name:"ID",value:this.props.metadata.PatientID},{name:"Name",value:x(this.props.metadata.PatientName)},{name:"Gender",value:P(this.props.metadata.PatientSex)},{name:"Birthdate",value:Z(this.props.metadata.PatientBirthDate)}];return(0,I.jsx)(w,{attributes:e})}}]),n}(l.Component);const O=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e=[{name:"Accession #",value:this.props.metadata.AccessionNumber},{name:"ID",value:this.props.metadata.StudyID},{name:"Date",value:Z(this.props.metadata.StudyDate)},{name:"Time",value:V(this.props.metadata.StudyTime)}];return(0,I.jsx)(w,{attributes:e})}}]),n}(l.Component);var j=n(1413);const M=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).state={isLoading:!1},a.overviewViewport=l.createRef(),a.overviewViewer=void 0,a.overviewViewer=void 0,a}return(0,a.Z)(n,[{key:"componentDidMount",value:function(){if(this.setState({isLoading:!0}),this.props.slide.overviewImages.length>0){var e=this.props.slide.overviewImages[0];null!==this.overviewViewport.current&&(this.overviewViewport.current.innerHTML="",console.info("instantiate viewer for OVERVIEW image of series "+e.SeriesInstanceUID),this.overviewViewer=new g.viewer.OverviewImageViewer({client:this.props.client,metadata:e,resizeFactor:1}),this.overviewViewer.render({container:this.overviewViewport.current}))}this.setState({isLoading:!1})}},{key:"render",value:function(){void 0!==this.overviewViewer&&(this.overviewViewer.render({container:this.overviewViewport.current}),this.overviewViewer.resize());var e=[],t=this.props.slide.description;return null!=t&&""!==t&&e.push({name:"Description",value:t}),this.state.isLoading?(0,I.jsx)(p.fCD,{}):(0,I.jsx)(f.Z.Item,(0,j.Z)((0,j.Z)({style:{height:"100%"}},this.props),{},{children:(0,I.jsx)(w,{header:this.props.slide.containerIdentifier,attributes:e,selectable:!0,children:(0,I.jsx)("div",{style:{height:"100px"},ref:this.overviewViewport})})}),this.props.slide.seriesInstanceUIDs[0])}}]),n}(l.Component);const U=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;(0,i.Z)(this,n);for(var a=arguments.length,o=new Array(a),r=0;r<a;r++)o[r]=arguments[r];return(e=t.call.apply(t,[this].concat(o))).state={selectedSeriesInstanceUID:e.props.selectedSeriesInstanceUID},e}return(0,a.Z)(n,[{key:"componentDidMount",value:function(){this.props.onSeriesSelection({seriesInstanceUID:this.state.selectedSeriesInstanceUID})}},{key:"render",value:function(){for(var e=this,t=this.props.metadata,n=[],i=0;i<t.length;++i){var a=t[i],o=(0,I.jsx)(M,{slide:a,client:this.props.client},a.seriesInstanceUIDs[0]);n.push(o)}var r;return void 0!==this.state.selectedSeriesInstanceUID&&null!==this.state.selectedSeriesInstanceUID&&(r=[this.state.selectedSeriesInstanceUID]),(0,I.jsx)(f.Z,{style:{width:"100%"},selectedKeys:r,onSelect:function(t){var n=t.key;t.keyPath,t.domEvent,t.selectedKeys;console.info('select slide "'.concat(n,'"')),e.setState({selectedSeriesInstanceUID:n.toString()}),e.props.onSeriesSelection({seriesInstanceUID:n.toString()})},mode:"inline",inlineIndent:0,children:n})}}]),n}(l.Component);var T=n(3433),k=n(3734),A=n(2014),E=n(3099),L=n(9220),N=n(7309),q=n(6106),G=n(478),_=n(8030),F=n(8201),z=n(5581),B=n(4925),W=["isVisible","onVisibilityChange"];const H=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).handleVisibilityChange=a.handleVisibilityChange.bind((0,o.Z)(a)),a}return(0,a.Z)(n,[{key:"handleVisibilityChange",value:function(e,t){this.props.onVisibilityChange({roiUID:this.props.roi.uid,isVisible:e})}},{key:"render",value:function(){var e="ROI ".concat(this.props.index+1),t=[],n=this.props,i=(n.isVisible,n.onVisibilityChange,(0,B.Z)(n,W));return this.props.roi.evaluations.forEach((function(e){var n=e.ConceptNameCodeSequence[0].CodeValue,i=e.ConceptNameCodeSequence[0].CodeMeaning,a="".concat(i);if(e.ValueType===F.sr.valueTypes.ValueTypes.CODE){var o=e.ConceptCodeSequence[0].CodeMeaning;"276214006"===n?t.push({name:"Property category",value:"".concat(o)}):"121071"===n?t.push({name:"Property type",value:"".concat(o)}):"111001"===n?t.push({name:"Algorithm Name",value:"".concat(o)}):t.push({name:a,value:"".concat(o)})}else if(e.ValueType===F.sr.valueTypes.ValueTypes.TEXT){var r=e;t.push({name:a,value:r.TextValue})}})),this.props.roi.measurements.forEach((function(e){var n=e.ConceptNameCodeSequence[0].CodeMeaning,i="".concat(n),a=e.MeasuredValueSequence[0],o=a.NumericValue.toPrecision(6),r=a.MeasurementUnitsCodeSequence[0].CodeValue;t.push({name:i,value:"".concat(o," ").concat(r)})})),(0,I.jsxs)(E.Z,{align:"start",children:[(0,I.jsx)("div",{style:{paddingLeft:"14px"},children:(0,I.jsx)(z.Z,{size:"small",onChange:this.handleVisibilityChange,checked:this.props.isVisible,checkedChildren:(0,I.jsx)(p.dSq,{}),unCheckedChildren:(0,I.jsx)(p.tgn,{})})}),(0,I.jsx)(f.Z.Item,(0,j.Z)((0,j.Z)({style:{height:"100%",paddingLeft:"3px"}},i),{},{children:(0,I.jsx)(w,{header:e,attributes:t,selectable:!0,hasLongValues:!0})}),this.props.roi.uid)]})}}]),n}(l.Component);const Y=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).handleMenuItemSelection=a.handleMenuItemSelection.bind((0,o.Z)(a)),a.handleVisibilityChange=a.handleVisibilityChange.bind((0,o.Z)(a)),a}return(0,a.Z)(n,[{key:"handleVisibilityChange",value:function(e,t){var n=this;e?this.props.rois.forEach((function(t){n.props.onVisibilityChange({roiUID:t.uid,isVisible:e})})):this.props.visibleRoiUIDs.forEach((function(t){n.props.onVisibilityChange({roiUID:t,isVisible:e})}))}},{key:"handleMenuItemSelection",value:function(e){this.props.onSelection({roiUID:e.key})}},{key:"render",value:function(){var e=this,t=this.props.rois.map((function(t,n){return(0,I.jsx)(H,{roi:t,index:n,isVisible:e.props.visibleRoiUIDs.has(t.uid),onVisibilityChange:e.props.onVisibilityChange},t.uid)}));return(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)("div",{style:{paddingLeft:"14px",paddingTop:"7px",paddingBottom:"7px"},children:(0,I.jsx)(z.Z,{size:"small",onChange:this.handleVisibilityChange,checked:this.props.visibleRoiUIDs.size>0,checkedChildren:(0,I.jsx)(p.dSq,{}),unCheckedChildren:(0,I.jsx)(p.tgn,{})})}),(0,I.jsx)(f.Z,{selectedKeys:(0,T.Z)(this.props.selectedRoiUIDs.values()),onSelect:this.handleMenuItemSelection,onClick:this.handleMenuItemSelection,children:t})]})}}]),n}(l.Component);var K=n(914),X=n(6272),Q=n(8243),J=n(1333),$=n(3020),ee=n(2414),te=["annotationGroup","defaultStyle","isVisible","metadata","onVisibilityChange","onStyleChange"];const ne=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).handleVisibilityChange=a.handleVisibilityChange.bind((0,o.Z)(a)),a.handleMeasurementSelection=a.handleMeasurementSelection.bind((0,o.Z)(a)),a.handleOpacityChange=a.handleOpacityChange.bind((0,o.Z)(a)),a.state={isVisible:a.props.isVisible,currentStyle:{opacity:a.props.defaultStyle.opacity}},a}return(0,a.Z)(n,[{key:"handleVisibilityChange",value:function(e,t){this.props.onVisibilityChange({annotationGroupUID:this.props.annotationGroup.uid,isVisible:e})}},{key:"handleOpacityChange",value:function(e){this.props.onStyleChange({annotationGroupUID:this.props.annotationGroup.uid,styleOptions:{opacity:e}}),this.setState({currentStyle:{opacity:e}})}},{key:"handleMeasurementSelection",value:function(e,t){if(void 0!==e){var n=e.split("-"),i=new F.sr.coding.CodedConcept({value:n[1],schemeDesignator:n[0],meaning:t.children});this.props.onStyleChange({annotationGroupUID:this.props.annotationGroup.uid,styleOptions:{measurement:i}}),this.setState((function(e){return{currentStyle:{opacity:e.currentStyle.opacity,measurement:i}}}))}else this.setState((function(e){return{currentStyle:{opacity:e.currentStyle.opacity}}}))}},{key:"render",value:function(){var e,t=this,n="Annotation Group ".concat(this.props.annotationGroup.number),i=[{name:"Label",value:this.props.annotationGroup.label},{name:"Algorithm Name",value:this.props.annotationGroup.algorithmName},{name:"Property category",value:this.props.annotationGroup.propertyCategory.CodeMeaning},{name:"Property type",value:this.props.annotationGroup.propertyType.CodeMeaning}],a=this.props.metadata.AnnotationGroupSequence.findIndex((function(e){return e.AnnotationGroupUID===t.props.annotationGroup.uid})),o=(null!==(e=this.props.metadata.AnnotationGroupSequence[a].MeasurementsSequence)&&void 0!==e?e:[]).map((function(e){var n=e.ConceptNameCodeSequence[0],i="".concat(n.CodingSchemeDesignator,"-").concat(n.CodeValue);return(0,I.jsx)(k.Z.Option,{value:i,dropdownMatchSelectWidth:!1,size:"small",disabled:!t.props.isVisible,children:n.CodeMeaning},i)})),r=(0,I.jsxs)("div",{children:[(0,I.jsxs)(q.Z,{justify:"start",align:"middle",gutter:[8,8],children:[(0,I.jsx)(K.Z,{span:6,children:"Opacity"}),(0,I.jsx)(K.Z,{span:12,children:(0,I.jsx)(X.Z,{range:!1,min:0,max:1,step:.01,value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})}),(0,I.jsx)(K.Z,{span:6,children:(0,I.jsx)(Q.Z,{min:0,max:1,size:"small",step:.1,style:{width:"65px"},value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})})]}),(0,I.jsx)(J.Z,{plain:!0,children:"Exploration"}),(0,I.jsxs)(q.Z,{justify:"start",align:"middle",gutter:[8,8],children:[(0,I.jsx)(K.Z,{span:8,children:"Measurement"}),(0,I.jsx)(K.Z,{span:16,children:(0,I.jsx)(k.Z,{style:{minWidth:"65px",width:"90%"},onSelect:this.handleMeasurementSelection,defaultValue:void 0,children:o},"annotation-group-measurements")})]})]}),s=this.props,l=(s.annotationGroup,s.defaultStyle,s.isVisible,s.metadata,s.onVisibilityChange,s.onStyleChange,(0,B.Z)(s,te));return(0,I.jsx)(f.Z.Item,(0,j.Z)((0,j.Z)({style:{height:"100%",paddingLeft:"3px"}},l),{},{children:(0,I.jsxs)(E.Z,{align:"start",children:[(0,I.jsx)("div",{style:{paddingLeft:"14px"},children:(0,I.jsxs)(E.Z,{direction:"vertical",align:"end",children:[(0,I.jsx)(z.Z,{size:"small",onChange:this.handleVisibilityChange,checked:this.props.isVisible,checkedChildren:(0,I.jsx)(p.dSq,{}),unCheckedChildren:(0,I.jsx)(p.tgn,{})}),(0,I.jsx)($.Z,{placement:"left",content:r,overlayStyle:{width:"350px"},title:"Display Settings",children:(0,I.jsx)(N.Z,{type:"primary",shape:"circle",icon:(0,I.jsx)(ee.Z,{})})})]})}),(0,I.jsx)(w,{header:n,attributes:i,selectable:!0,hasLongValues:!0})]})}),this.props.annotationGroup.uid)}}]),n}(l.Component);const ie=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e=this,t=this.props.annotationGroups.map((function(t,n){var i=t.uid;return(0,I.jsx)(ne,{annotationGroup:t,metadata:e.props.metadata[i],isVisible:e.props.visibleAnnotationGroupUIDs.has(i),defaultStyle:e.props.defaultAnnotationGroupStyles[i],onVisibilityChange:e.props.onAnnotationGroupVisibilityChange,onStyleChange:e.props.onAnnotationGroupStyleChange},t.uid)}));return(0,I.jsx)(f.Z,{selectable:!1,children:t})}}]),n}(l.Component);const ae=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).handleClick=a.handleClick.bind((0,o.Z)(a)),a}return(0,a.Z)(n,[{key:"handleClick",value:function(e){void 0!==this.props.onClick&&this.props.onClick(e)}},{key:"render",value:function(){var e,t,n,i=this.props.icon;return void 0===i?null:(null!=this.props.label&&(t=(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(J.Z,{type:"vertical"}),this.props.label]})),n=null!==(e=this.props.isSelected)&&void 0!==e&&e?(0,I.jsx)(N.Z,{onClick:this.handleClick,icon:(0,I.jsx)(i,{}),type:"primary",style:{lineHeight:"1.0"},children:t}):(0,I.jsx)(N.Z,{onClick:this.handleClick,icon:(0,I.jsx)(i,{}),type:"default",style:{lineHeight:"1.0"},children:t}),void 0!==this.props.tooltip?(0,I.jsx)(L.Z,{title:this.props.tooltip,children:n}):n)}}]),n}(l.Component);const oe=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){if(void 0===this.props.metadata)return null;var e=[{name:"Manufacturer",value:this.props.metadata.Manufacturer},{name:"Model Name",value:this.props.metadata.ManufacturerModelName},{name:"Device Serial Number",value:this.props.metadata.DeviceSerialNumber},{name:"Software Versions",value:this.props.metadata.SoftwareVersions}];return null!=this.props.metadata.InstitutionName&&e.push({name:"Institution Name",value:this.props.metadata.InstitutionName}),(0,I.jsx)(w,{attributes:e,hasLongValues:!0})}}]),n}(l.Component);var re=function(e){var t=e.content,n=e.name,i=[];return t.forEach((function(e){(function(e,t){var n=e.ConceptNameCodeSequence[0];return n.CodeValue===t.CodeValue&&n.CodingSchemeDesignator===t.CodingSchemeDesignator})(e,n)&&i.push(e)})),i},se=function(e,t){return e.ValueType===t},le=function(e){var t=re({content:e.ContentSequence,name:new F.sr.coding.CodedConcept({value:"126010",schemeDesignator:"DCM",meaning:"Imaging Measurements"})});if(1!==t.length)throw new Error('Content item "Imaging Measurements" not found.Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report".');var n=t[0],i=re({content:n.ContentSequence,name:new F.sr.coding.CodedConcept({value:"125007",schemeDesignator:"DCM",meaning:"Measurement Group"})}),a=[];return i.forEach((function(e){var t,n=[],i=e,o=re({content:i.ContentSequence,name:new F.sr.coding.CodedConcept({value:"112040",schemeDesignator:"DCM",meaning:"Tracking Unique Identifier"})});if(0===o.length)throw new Error('Content item "Tracking Unique Identifier" not found. Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1410 "Planar ROI Measurements and Qualitative Evaluations".');var r=o[0];if(0===(o=re({content:i.ContentSequence,name:new F.sr.coding.CodedConcept({value:"121071",schemeDesignator:"DCM",meaning:"Finding"})})).length)throw new Error('Content item "Finding" not found. Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1410 "Planar ROI Measurements and Qualitative Evaluations".');if(0!==(o=re({content:i.ContentSequence,name:new F.sr.coding.CodedConcept({value:"111001",schemeDesignator:"DCM",meaning:"Algorithm Name"})})).length){var s=o[0];n.push(s),t="Device"}else t="Person";if(0!==(o=re({content:i.ContentSequence,name:new F.sr.coding.CodedConcept({value:"111003",schemeDesignator:"DCM",meaning:"Algorithm Version"})})).length){var l=o[0];n.push(l)}if(0===(o=re({content:i.ContentSequence,name:new F.sr.coding.CodedConcept({value:"111030",schemeDesignator:"DCM",meaning:"Image Region"})})).length)throw new Error('Content item "Image Region" not found. Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1410 "Planar ROI Measurements and Qualitative Evaluations".');var c,d=o[0];if("POINT"===d.GraphicType)c=new g.scoord3d.Point({frameOfReferenceUID:d.ReferencedFrameOfReferenceUID,coordinates:d.GraphicData});else{for(var u=[],h=0;h<d.GraphicData.length;h+=3)u.push(d.GraphicData.slice(h,h+3));if("POLYGON"===d.GraphicType)c=new g.scoord3d.Polygon({frameOfReferenceUID:d.ReferencedFrameOfReferenceUID,coordinates:u});else if("MULTIPOINT"===d.GraphicType)c=new g.scoord3d.MultiPoint({frameOfReferenceUID:d.ReferencedFrameOfReferenceUID,coordinates:u});else if("POLYLINE"===d.GraphicType)c=new g.scoord3d.Polyline({frameOfReferenceUID:d.ReferencedFrameOfReferenceUID,coordinates:u});else if("ELLIPSE"===d.GraphicType)c=new g.scoord3d.Ellipse({frameOfReferenceUID:d.ReferencedFrameOfReferenceUID,coordinates:u});else{if("ELLIPSOID"!==d.GraphicType)throw new Error('Content item "Image Region" has unknown graphic type '+'"'.concat(d.GraphicType,'". ')+'Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1410 "Planar ROI Measurements and Qualitative Evaluations".');c=new g.scoord3d.Ellipsoid({frameOfReferenceUID:d.ReferencedFrameOfReferenceUID,coordinates:u})}}n.push.apply(n,(0,T.Z)(function(e){var t=e.content,n=[];return t.forEach((function(e){if(se(e,F.sr.valueTypes.ValueTypes.CODE)){var t=e;n.push(t)}})),n}({content:i.ContentSequence})));var p=function(e){var t=e.content,n=[];return t.forEach((function(e){if(se(e,F.sr.valueTypes.ValueTypes.NUM)){var t=e;n.push(t)}})),n}({content:i.ContentSequence}),v=new g.roi.ROI({scoord3d:c,uid:(0,S.Z)(),properties:{trackingUID:r.UID,observerType:t,evaluations:n,measurements:p}});a.push(v)})),a},ce=(0,a.Z)((function e(t){(0,i.Z)(this,e),this.PersonObserverName=void 0,this.PersonObserverLoginName=void 0,this.DeviceObserverUID=void 0,this.DeviceObserverName=void 0,this.SpecimenUID=void 0,this.SpecimenIdentifier=void 0,this.ContainerIdentifier=void 0,this.ROIs=[];var n=re({content:t.ContentSequence,name:new F.sr.coding.CodedConcept({value:"121039",schemeDesignator:"DCM",meaning:"Specimen UID"})});if(0===n.length)throw new Error('Content item "Specimen UID" not found. Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1001 "Observation Context" -> TID 1006 "Subject Context" -> TID 1009 "Subject Context, Specimen".');var a=n[0];if(this.SpecimenUID=a.UID,0===(n=re({content:t.ContentSequence,name:new F.sr.coding.CodedConcept({value:"121041",schemeDesignator:"DCM",meaning:"Specimen Identifier"})})).length)throw new Error('Content item "Specimen Identifier" not found. Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1001 "Observation Context" -> TID 1006 "Subject Context" -> TID 1009 "Subject Context, Specimen".');var o=n[0];if(this.SpecimenIdentifier=o.TextValue,0===(n=re({content:t.ContentSequence,name:new F.sr.coding.CodedConcept({value:"111700",schemeDesignator:"DCM",meaning:"Specimen Container Identifier"})})).length)throw new Error('Content item "Specimen Container Identifier" not found. Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1001 "Observation Context" -> TID 1006 "Subject Context" -> TID 1009 "Subject Context, Specimen".');var r=n[0];if(this.ContainerIdentifier=r.TextValue,0!==(n=re({content:t.ContentSequence,name:new F.sr.coding.CodedConcept({value:"121008",schemeDesignator:"DCM",meaning:"Person Observer Name"})})).length){var s=n[0];this.PersonObserverName=s.PersonName}if(0!==(n=re({content:t.ContentSequence,name:new F.sr.coding.CodedConcept({value:"128774",schemeDesignator:"DCM",meaning:"Person Observer's Login Name"})})).length){var l=n[0];this.PersonObserverLoginName=l.TextValue}if((n=re({content:t.ContentSequence,name:new F.sr.coding.CodedConcept({value:"121012",schemeDesignator:"DCM",meaning:"Device Observer UID"})})).length>0){var c=n[0];this.DeviceObserverUID=c.UID}if(0!==(n=re({content:t.ContentSequence,name:new F.sr.coding.CodedConcept({value:"121013",schemeDesignator:"DCM",meaning:"Device Observer Name"})})).length){var d=n[0];this.DeviceObserverName=d.TextValue}this.ROIs=le(t)}));const de=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e=new ce(this.props.dataset),t=[{name:"ID",value:e.ContainerIdentifier}],n=[{name:"ID",value:e.SpecimenIdentifier}],i=[{name:"Name",value:e.PersonObserverName}],a=e.ROIs.map((function(e,t){var n="Region ".concat(t+1),i=[];return e.evaluations.forEach((function(e){e.ValueType===F.sr.valueTypes.ValueTypes.CODE?i.push({name:e.ConceptNameCodeSequence[0].CodeMeaning,value:e.ConceptCodeSequence[0].CodeMeaning}):e.ValueType===F.sr.valueTypes.ValueTypes.TEXT&&i.push({name:e.ConceptNameCodeSequence[0].CodeMeaning,value:e.TextValue})})),(0,I.jsx)(w,{header:n,attributes:i},e.uid)}));return(0,I.jsxs)("div",{children:[(0,I.jsx)(J.Z,{orientation:"left",children:"Patient"}),(0,I.jsx)(R,{metadata:this.props.dataset}),(0,I.jsx)(J.Z,{orientation:"left",children:"Case"}),(0,I.jsx)(O,{metadata:this.props.dataset}),(0,I.jsx)(J.Z,{orientation:"left",children:"Slide"}),(0,I.jsx)(w,{attributes:t}),(0,I.jsx)(J.Z,{orientation:"left",children:"Specimen"}),(0,I.jsx)(w,{attributes:n}),(0,I.jsx)(J.Z,{orientation:"left",children:"Observer"}),(0,I.jsx)(w,{attributes:i}),(0,I.jsx)(J.Z,{orientation:"left",children:"Annotations"}),a]})}}]),n}(l.Component);var ue=n(2126);const he=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e,t=null;return void 0!==this.props.groups&&(t=this.props.groups.map((function(e,t){return(0,I.jsx)(w,{header:e.name,attributes:e.attributes},t)}))),e=void 0!==this.props.type?"".concat(this.props.type,": ").concat(this.props.identifier):this.props.identifier,(0,I.jsxs)(ue.ZP.Item,{children:[(0,I.jsx)(w,{header:e,attributes:this.props.attributes,hasLongValues:this.props.hasLongValues,children:t}),this.props.children]},this.props.uid)}}]),n}(l.Component);new F.sr.coding.CodedConcept({value:"17636008",schemeDesignator:"SCT",meaning:"Specimen collection"}),new F.sr.coding.CodedConcept({value:"433465004",schemeDesignator:"SCT",meaning:"Sampling of tissue specimen"}),new F.sr.coding.CodedConcept({value:"127790008",schemeDesignator:"SCT",meaning:"Specimen staining"}),new F.sr.coding.CodedConcept({value:"9265001",schemeDesignator:"SCT",meaning:"Specimen processing"});var pe={FIXATIVE:new F.sr.coding.CodedConcept({value:"430864009",schemeDesignator:"SCT",meaning:"Tissue fixative"}),EMBEDDING_MEDIUM:new F.sr.coding.CodedConcept({value:"430863003",schemeDesignator:"SCT",meaning:"Embedding medium"})},ve=(0,j.Z)({SPECIMEN_IDENTIFIER:new F.sr.coding.CodedConcept({value:"121041",schemeDesignator:"DCM",meaning:"Specimen identifier"}),PARENT_SPECIMEN_IDENTIFIER:new F.sr.coding.CodedConcept({value:"111705",schemeDesignator:"DCM",meaning:"Parent specimen identifier"}),PROCESSING_TYPE:new F.sr.coding.CodedConcept({value:"111701",schemeDesignator:"DCM",meaning:"Processing type"}),DATETIME_OF_PROCESSING:new F.sr.coding.CodedConcept({value:"111702",schemeDesignator:"DCM",meaning:"Datetime of processing"}),PROCESSING_STEP_DESCRIPTION:new F.sr.coding.CodedConcept({value:"111703",schemeDesignator:"DCM",meaning:"Processing step description"}),COLLECTION_METHOD:new F.sr.coding.CodedConcept({value:"17636008",schemeDesignator:"SCT",meaning:"Specimen collection"}),SAMPLING_METHOD:new F.sr.coding.CodedConcept({value:"111704",schemeDesignator:"DCM",meaning:"Sampling method"}),STAIN:new F.sr.coding.CodedConcept({value:"424361007",schemeDesignator:"SCT",meaning:"Using substance"})},pe);const me=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e,t=this;if(void 0===this.props.metadata)return null;var n=this.props.metadata.SpecimenDescriptionSequence[this.props.index],i=[];if(void 0!==n.SpecimenShortDescription&&i.push({name:"Description",value:n.SpecimenShortDescription}),void 0!==n.PrimaryAnatomicStructureSequence&&n.PrimaryAnatomicStructureSequence.length>0){var a=n.PrimaryAnatomicStructureSequence;i.push({name:"Anatomical structure",value:a.map((function(e){return e.CodeMeaning})).join(", ")})}(null!==(e=n.SpecimenPreparationSequence)&&void 0!==e?e:[]).forEach((function(e,n){e.SpecimenPreparationStepContentItemSequence.forEach((function(e,n){var a=new F.sr.coding.CodedConcept({value:e.ConceptNameCodeSequence[0].CodeValue,schemeDesignator:e.ConceptNameCodeSequence[0].CodingSchemeDesignator,meaning:e.ConceptNameCodeSequence[0].CodeMeaning});if(e.ValueType===F.sr.valueTypes.ValueTypes.CODE){var o=new F.sr.coding.CodedConcept({value:e.ConceptCodeSequence[0].CodeValue,schemeDesignator:e.ConceptCodeSequence[0].CodingSchemeDesignator,meaning:e.ConceptCodeSequence[0].CodeMeaning});a.equals(ve.PROCESSING_TYPE)||(a.equals(ve.COLLECTION_METHOD)?i.push({name:"Collection method",value:o.CodeMeaning}):a.equals(ve.FIXATIVE)?i.push({name:"Tissue fixative",value:o.CodeMeaning}):a.equals(ve.EMBEDDING_MEDIUM)?i.push({name:"Tissue embedding medium",value:o.CodeMeaning}):a.equals(ve.STAIN)&&t.props.showstain&&i.push({name:"Tissue stain",value:o.CodeMeaning}))}else e.ValueType===F.sr.valueTypes.ValueTypes.TEXT&&(a.equals(ve.STAIN)&&t.props.showstain?i.push({name:"Tissue stain",value:e.TextValue}):a.equals(ve.PARENT_SPECIMEN_IDENTIFIER)&&i.push({name:"Parent specimen",value:e.TextValue}))}))}));var o=n.SpecimenUID,r=n.SpecimenIdentifier;return(0,I.jsx)(he,{uid:o,identifier:r,attributes:i,hasLongValues:!0},o)}}]),n}(l.Component);const fe=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e,t=this;if(void 0===this.props.metadata)return null;var n=(null!==(e=this.props.metadata.SpecimenDescriptionSequence)&&void 0!==e?e:[]).map((function(e,n){return(0,I.jsx)(me,{index:n,metadata:t.props.metadata,showstain:t.props.showstain},e.SpecimenUID)}));return(0,I.jsx)(ue.ZP,{style:{overflowY:"auto"},children:n})}}]),n}(l.Component);var ge=n(681),Se=n(5594),ye=n(2622),Ce=n(4215),Ie=n(8272),be=["defaultStyle","isRemovable","isVisible","metadata","onVisibilityChange","onStyleChange","onRemoval","opticalPath"];const we=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).handleVisibilityChange=a.handleVisibilityChange.bind((0,o.Z)(a)),a.handleOpacityChange=a.handleOpacityChange.bind((0,o.Z)(a)),a.handleLimitChange=a.handleLimitChange.bind((0,o.Z)(a)),a.handleLowerLimitChange=a.handleLowerLimitChange.bind((0,o.Z)(a)),a.handleUpperLimitChange=a.handleUpperLimitChange.bind((0,o.Z)(a)),a.handleColorRChange=a.handleColorRChange.bind((0,o.Z)(a)),a.handleColorGChange=a.handleColorGChange.bind((0,o.Z)(a)),a.handleColorBChange=a.handleColorBChange.bind((0,o.Z)(a)),a.handleRemoval=a.handleRemoval.bind((0,o.Z)(a)),a.getCurrentColors=a.getCurrentColors.bind((0,o.Z)(a)),a.state={isVisible:a.props.isVisible,currentStyle:{opacity:a.props.defaultStyle.opacity,color:a.props.defaultStyle.color,paletteColorLookupTable:a.props.defaultStyle.paletteColorLookupTable,limitValues:a.props.defaultStyle.limitValues}},a}return(0,a.Z)(n,[{key:"componentDidUpdate",value:function(e,t){this.props.defaultStyle!==e.defaultStyle&&this.setState({currentStyle:this.props.defaultStyle})}},{key:"handleVisibilityChange",value:function(e,t){var n=this.props.opticalPath.identifier;this.setState({isVisible:e}),this.props.onVisibilityChange({opticalPathIdentifier:n,isVisible:e})}},{key:"handleOpacityChange",value:function(e){var t=this.props.opticalPath.identifier;this.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{opacity:e}}),this.setState((function(t){return{currentStyle:{color:t.currentStyle.color,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:e,limitValues:t.currentStyle.limitValues}}}))}},{key:"handleColorRChange",value:function(e){var t=this.props.opticalPath.identifier;if(void 0!==this.state.currentStyle.color){var n=[Array.isArray(e)?e[0]:e,this.state.currentStyle.color[1],this.state.currentStyle.color[2]];this.setState((function(e){return{currentStyle:{color:n,paletteColorLookupTable:e.currentStyle.paletteColorLookupTable,opacity:e.currentStyle.opacity,limitValues:e.currentStyle.limitValues}}})),this.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{color:n}})}}},{key:"handleColorGChange",value:function(e){var t=this.props.opticalPath.identifier;if(void 0!==this.state.currentStyle.color){var n=[this.state.currentStyle.color[0],Array.isArray(e)?e[0]:e,this.state.currentStyle.color[2]];this.setState((function(e){return{currentStyle:{color:n,paletteColorLookupTable:e.currentStyle.paletteColorLookupTable,opacity:e.currentStyle.opacity,limitValues:e.currentStyle.limitValues}}})),this.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{color:n}})}}},{key:"handleColorBChange",value:function(e){var t=this.props.opticalPath.identifier;if(void 0!==this.state.currentStyle.color){var n=[this.state.currentStyle.color[0],this.state.currentStyle.color[1],Array.isArray(e)?e[0]:e];this.setState((function(e){return{currentStyle:{color:n,paletteColorLookupTable:e.currentStyle.paletteColorLookupTable,opacity:e.currentStyle.opacity,limitValues:e.currentStyle.limitValues}}})),this.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{color:n}})}}},{key:"getCurrentColors",value:function(){var e=function(e){return"#"+(16777216+(e[0]<<16)+(e[1]<<8)+e[2]).toString(16).slice(1)};return null!=this.props.defaultStyle.paletteColorLookupTable?this.props.defaultStyle.paletteColorLookupTable.data.map((function(t){return e(t)})):null!=this.state.currentStyle.color?["#000000",e(this.state.currentStyle.color)]:["white","white"]}},{key:"handleLowerLimitChange",value:function(e){var t=this.props.opticalPath.identifier;void 0!==this.state.currentStyle.limitValues&&(this.setState((function(t){return void 0!==t.currentStyle.limitValues?{currentStyle:{color:t.currentStyle.color,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:t.currentStyle.opacity,limitValues:[e,t.currentStyle.limitValues[1]]}}:{currentStyle:{color:t.currentStyle.color,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:t.currentStyle.opacity,limitValues:t.currentStyle.limitValues}}})),this.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{limitValues:[e,this.state.currentStyle.limitValues[1]]}}))}},{key:"handleUpperLimitChange",value:function(e){var t=this.props.opticalPath.identifier;void 0!==this.state.currentStyle.limitValues&&(this.setState((function(t){return void 0!==t.currentStyle.limitValues?{currentStyle:{color:t.currentStyle.color,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:t.currentStyle.opacity,limitValues:[t.currentStyle.limitValues[0],e]}}:{currentStyle:{color:t.currentStyle.color,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:t.currentStyle.opacity,limitValues:t.currentStyle.limitValues}}})),this.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{limitValues:[this.state.currentStyle.limitValues[0],e]}}))}},{key:"handleLimitChange",value:function(e){var t=this.props.opticalPath.identifier;this.setState((function(t){return{currentStyle:{color:t.currentStyle.color,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:t.currentStyle.opacity,limitValues:e}}})),this.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{limitValues:e}})}},{key:"handleRemoval",value:function(){var e=this.props.opticalPath.identifier;this.props.onRemoval(e)}},{key:"render",value:function(){var e,t=this.props.opticalPath.identifier,n=this.props.opticalPath.description,i=[];void 0!==this.props.opticalPath.illuminationWaveLength&&i.push({name:"Illumination wavelength",value:"".concat(this.props.opticalPath.illuminationWaveLength," nm")}),void 0!==this.props.opticalPath.illuminationColor&&i.push({name:"Illumination color",value:this.props.opticalPath.illuminationColor.CodeMeaning}),(null!==(e=this.props.metadata[0].SpecimenDescriptionSequence)&&void 0!==e?e:[]).forEach((function(e){var t;(null!==(t=e.SpecimenPreparationSequence)&&void 0!==t?t:[]).forEach((function(e,t){e.SpecimenPreparationStepContentItemSequence.forEach((function(e,t){var n=new F.sr.coding.CodedConcept({value:e.ConceptNameCodeSequence[0].CodeValue,schemeDesignator:e.ConceptNameCodeSequence[0].CodingSchemeDesignator,meaning:e.ConceptNameCodeSequence[0].CodeMeaning});if(e.ValueType===F.sr.valueTypes.ValueTypes.CODE){var a=new F.sr.coding.CodedConcept({value:e.ConceptCodeSequence[0].CodeValue,schemeDesignator:e.ConceptCodeSequence[0].CodingSchemeDesignator,meaning:e.ConceptCodeSequence[0].CodeMeaning});n.equals(ve.PROCESSING_TYPE)||n.equals(ve.STAIN)&&i.push({name:"Tissue stain",value:a.CodeMeaning})}else e.ValueType===F.sr.valueTypes.ValueTypes.TEXT&&(n.equals(ve.PROCESSING_TYPE)||n.equals(ve.STAIN)&&i.push({name:"Tissue stain",value:e.TextValue}))}))}))}));var a,o,r=Math.pow(2,this.props.metadata[0].BitsAllocated)-1,s=null!=n?"".concat(t,": ").concat(n):t;if(this.props.opticalPath.isMonochromatic){var l,c;l=null!=this.state.currentStyle.color?(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(J.Z,{plain:!0,children:"Color"}),(0,I.jsxs)(q.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,I.jsx)(K.Z,{span:5,children:"Red"}),(0,I.jsx)(K.Z,{span:14,children:(0,I.jsx)(X.Z,{range:!1,min:0,max:255,step:1,value:this.state.currentStyle.color[0],onChange:this.handleColorRChange})}),(0,I.jsx)(K.Z,{span:5,children:(0,I.jsx)(Q.Z,{min:0,max:255,size:"small",style:{width:"65px"},value:this.state.currentStyle.color[0],onChange:this.handleColorRChange})})]}),(0,I.jsxs)(q.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,I.jsx)(K.Z,{span:5,children:"Green"}),(0,I.jsx)(K.Z,{span:14,children:(0,I.jsx)(X.Z,{range:!1,min:0,max:255,step:1,value:this.state.currentStyle.color[1],onChange:this.handleColorGChange})}),(0,I.jsx)(K.Z,{span:5,children:(0,I.jsx)(Q.Z,{min:0,max:255,size:"small",style:{width:"65px"},value:this.state.currentStyle.color[1],onChange:this.handleColorGChange})})]}),(0,I.jsxs)(q.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,I.jsx)(K.Z,{span:5,children:"Blue"}),(0,I.jsx)(K.Z,{span:14,children:(0,I.jsx)(X.Z,{range:!1,min:0,max:255,step:1,value:this.state.currentStyle.color[2],onChange:this.handleColorBChange})}),(0,I.jsx)(K.Z,{span:5,children:(0,I.jsx)(Q.Z,{min:0,max:255,size:"small",style:{width:"65px"},value:this.state.currentStyle.color[2],onChange:this.handleColorBChange})})]})]}):(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(J.Z,{plain:!0,children:"Color"}),"Custom pseudo-coloring is disabled because pixels are colorized via a provided palette color lookup table."]}),null!=this.state.currentStyle.limitValues&&(c=(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(J.Z,{plain:!0,children:"Values of interest"}),(0,I.jsxs)(q.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,I.jsx)(K.Z,{span:6,children:(0,I.jsx)(Q.Z,{min:0,max:this.state.currentStyle.limitValues[1],size:"small",style:{width:"75px"},value:this.state.currentStyle.limitValues[0],onChange:this.handleLowerLimitChange})}),(0,I.jsx)(K.Z,{span:12,children:(0,I.jsx)(X.Z,{range:!0,min:0,max:r,step:1,value:[this.state.currentStyle.limitValues[0],this.state.currentStyle.limitValues[1]],onChange:this.handleLimitChange})}),(0,I.jsx)(K.Z,{span:6,children:(0,I.jsx)(Q.Z,{min:this.state.currentStyle.limitValues[0],max:r,size:"small",style:{width:"75px"},value:this.state.currentStyle.limitValues[1],onChange:this.handleUpperLimitChange})})]})]})),a=(0,I.jsxs)("div",{children:[c,l,(0,I.jsx)(J.Z,{plain:!0}),(0,I.jsxs)(q.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,I.jsx)(K.Z,{span:6,children:"Opacity"}),(0,I.jsx)(K.Z,{span:12,children:(0,I.jsx)(X.Z,{range:!1,min:0,max:1,step:.01,value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})}),(0,I.jsx)(K.Z,{span:6,children:(0,I.jsx)(Q.Z,{min:0,max:1,size:"small",step:.1,style:{width:"65px"},value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})})]})]});var d=this.getCurrentColors();o=(0,I.jsx)(Se.Z,{offset:[-20,20],count:" ",style:{borderStyle:"solid",borderWidth:"1px",borderColor:"gray",visibility:this.state.isVisible?"visible":"hidden",backgroundImage:"linear-gradient(to right, ".concat(d.toString(),")")},children:(0,I.jsx)(w,{header:s,attributes:i,selectable:!0,hasLongValues:!0})})}else a=(0,I.jsx)("div",{children:(0,I.jsxs)(q.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,I.jsx)(K.Z,{span:6,children:"Opacity"}),(0,I.jsx)(K.Z,{span:12,children:(0,I.jsx)(X.Z,{range:!1,min:0,max:1,step:.01,value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})}),(0,I.jsx)(K.Z,{span:6,children:(0,I.jsx)(Q.Z,{min:0,max:1,size:"small",step:.1,style:{width:"60px"},value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})})]})}),o=(0,I.jsx)(w,{header:s,attributes:i,selectable:!0,hasLongValues:!0});var u=[];this.props.isRemovable&&u.push((0,I.jsx)(L.Z,{title:"Remove Optical Path",children:(0,I.jsx)(N.Z,{type:"default",shape:"circle",icon:(0,I.jsx)(ye.Z,{}),onClick:this.handleRemoval})}));var h=this.props,p=(h.defaultStyle,h.isRemovable,h.isVisible,h.metadata,h.onVisibilityChange,h.onStyleChange,h.onRemoval,h.opticalPath,(0,B.Z)(h,be));return(0,I.jsx)(f.Z.Item,(0,j.Z)((0,j.Z)({style:{height:"100%",paddingLeft:"3px"}},p),{},{children:(0,I.jsxs)(E.Z,{align:"start",children:[(0,I.jsx)("div",{style:{paddingLeft:"14px"},children:(0,I.jsxs)(E.Z,{direction:"vertical",align:"end",children:[(0,I.jsx)(z.Z,{size:"small",checked:this.state.isVisible,onChange:this.handleVisibilityChange,checkedChildren:(0,I.jsx)(Ce.Z,{}),unCheckedChildren:(0,I.jsx)(Ie.Z,{})}),(0,I.jsx)($.Z,{placement:"left",content:a,overlayStyle:{width:"350px"},title:"Display Settings",children:(0,I.jsx)(N.Z,{type:"primary",shape:"circle",icon:(0,I.jsx)(ee.Z,{})})}),u]})}),o]})}),this.props.opticalPath.identifier)}}]),n}(l.Component);var De=k.Z.Option;const xe=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).state={selectedOpticalPathIdentifier:void 0},a.handleItemAddition=a.handleItemAddition.bind((0,o.Z)(a)),a.handleItemRemoval=a.handleItemRemoval.bind((0,o.Z)(a)),a.handleItemSelectionChange=a.handleItemSelectionChange.bind((0,o.Z)(a)),a}return(0,a.Z)(n,[{key:"handleItemRemoval",value:function(e){this.props.onOpticalPathActivityChange({opticalPathIdentifier:e,isActive:!1})}},{key:"handleItemSelectionChange",value:function(e){this.setState({selectedOpticalPathIdentifier:e})}},{key:"handleItemAddition",value:function(){var e=this.state.selectedOpticalPathIdentifier;void 0!==e&&(this.props.onOpticalPathActivityChange({opticalPathIdentifier:e,isActive:!0}),this.setState({selectedOpticalPathIdentifier:void 0}))}},{key:"render",value:function(){var e=this;if(void 0===this.props.metadata)return null;var t,n=this.props.opticalPaths.length>1,i=[],a=[];return this.props.opticalPaths.forEach((function(t){var o=t.identifier,r=e.props.metadata[o],s=r[0].SeriesInstanceUID;r[0].OpticalPathSequence.forEach((function(o){var l,c=o.OpticalPathIdentifier,d=o.OpticalPathDescription;t.identifier===c&&(e.props.activeOpticalPathIdentifiers.has(c)?i.push((0,I.jsx)(we,{opticalPath:t,metadata:r,isVisible:e.props.visibleOpticalPathIdentifiers.has(c),defaultStyle:e.props.defaultOpticalPathStyles[c],onVisibilityChange:e.props.onOpticalPathVisibilityChange,onStyleChange:e.props.onOpticalPathStyleChange,onRemoval:e.handleItemRemoval,isRemovable:n},"".concat(s,"-").concat(c))):(l=""!==d?"".concat(c," - ").concat(d):"".concat(c),a.push((0,I.jsx)(De,{value:c,children:l},c))))}))})),n&&(t=(0,I.jsxs)(E.Z,{align:"center",size:20,style:{padding:"14px"},children:[(0,I.jsx)(k.Z,{defaultValue:"",style:{width:200},onChange:this.handleItemSelectionChange,value:this.state.selectedOpticalPathIdentifier,allowClear:!0,children:a}),(0,I.jsx)(L.Z,{title:"Add",children:(0,I.jsx)(N.Z,{icon:(0,I.jsx)(ge.Z,{}),type:"primary",onClick:this.handleItemAddition})})]})),(0,I.jsxs)(f.Z,{selectable:!1,children:[i,t]})}}]),n}(l.Component);var Ze=["defaultStyle","isVisible","mapping","metadata","onVisibilityChange","onStyleChange"];const Ve=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).handleVisibilityChange=a.handleVisibilityChange.bind((0,o.Z)(a)),a.handleOpacityChange=a.handleOpacityChange.bind((0,o.Z)(a)),a.state={isVisible:a.props.isVisible,currentStyle:{opacity:a.props.defaultStyle.opacity}},a}return(0,a.Z)(n,[{key:"handleVisibilityChange",value:function(e,t){this.props.onVisibilityChange({mappingUID:this.props.mapping.uid,isVisible:e}),this.setState({isVisible:e})}},{key:"handleOpacityChange",value:function(e){this.props.onStyleChange({mappingUID:this.props.mapping.uid,styleOptions:{opacity:e}}),this.setState((function(t){return{currentStyle:{opacity:e}}}))}},{key:"render",value:function(){var e="Mapping ".concat(this.props.mapping.number),t=[{name:"Label",value:this.props.mapping.label}],n=(0,I.jsx)("div",{children:(0,I.jsxs)(q.Z,{justify:"center",align:"middle",children:[(0,I.jsx)(K.Z,{span:6,children:"Opacity"}),(0,I.jsx)(K.Z,{span:12,children:(0,I.jsx)(X.Z,{range:!1,min:0,max:1,step:.01,value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})}),(0,I.jsx)(K.Z,{span:6,children:(0,I.jsx)(Q.Z,{min:0,max:1,size:"small",step:.1,style:{width:"65px"},value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})})]})}),i=this.props,a=(i.defaultStyle,i.isVisible,i.mapping,i.metadata,i.onVisibilityChange,i.onStyleChange,(0,B.Z)(i,Ze));return(0,I.jsx)(f.Z.Item,(0,j.Z)((0,j.Z)({style:{height:"100%",paddingLeft:"3px"}},a),{},{children:(0,I.jsxs)(E.Z,{align:"start",children:[(0,I.jsx)("div",{style:{paddingLeft:"14px"},children:(0,I.jsx)(E.Z,{direction:"vertical",align:"end",size:100,children:(0,I.jsxs)(E.Z,{direction:"vertical",align:"end",children:[(0,I.jsx)(z.Z,{size:"small",onChange:this.handleVisibilityChange,checked:this.props.isVisible,checkedChildren:(0,I.jsx)(p.dSq,{}),unCheckedChildren:(0,I.jsx)(p.tgn,{})}),(0,I.jsx)($.Z,{placement:"left",content:n,overlayStyle:{width:"350px"},title:"Display Settings",children:(0,I.jsx)(N.Z,{type:"primary",shape:"circle",icon:(0,I.jsx)(ee.Z,{})})})]})})}),(0,I.jsx)(w,{header:e,attributes:t,selectable:!0,hasLongValues:!0})]})}),this.props.mapping.uid)}}]),n}(l.Component);const Pe=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e=this,t=this.props.mappings.map((function(t,n){var i=t.uid;return(0,I.jsx)(Ve,{mapping:t,metadata:e.props.metadata[i],isVisible:e.props.visibleMappingUIDs.has(i),defaultStyle:e.props.defaultMappingStyles[i],onVisibilityChange:e.props.onMappingVisibilityChange,onStyleChange:e.props.onMappingStyleChange},t.uid)}));return(0,I.jsx)(f.Z,{selectable:!1,children:t})}}]),n}(l.Component);var Re=["defaultStyle","isVisible","segment","metadata","onVisibilityChange","onStyleChange"];const Oe=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).handleVisibilityChange=a.handleVisibilityChange.bind((0,o.Z)(a)),a.handleOpacityChange=a.handleOpacityChange.bind((0,o.Z)(a)),a.state={isVisible:a.props.isVisible,currentStyle:{opacity:a.props.defaultStyle.opacity}},a}return(0,a.Z)(n,[{key:"handleVisibilityChange",value:function(e,t){this.props.onVisibilityChange({segmentUID:this.props.segment.uid,isVisible:e}),this.setState({isVisible:e})}},{key:"handleOpacityChange",value:function(e){this.props.onStyleChange({segmentUID:this.props.segment.uid,styleOptions:{opacity:e}}),this.setState({currentStyle:{opacity:e}})}},{key:"render",value:function(){var e=[{name:"Property Category",value:this.props.segment.propertyCategory.CodeMeaning},{name:"Property Type",value:this.props.segment.propertyType.CodeMeaning},{name:"Algorithm Name",value:this.props.segment.algorithmName}],t=(0,I.jsx)("div",{children:(0,I.jsxs)(q.Z,{justify:"center",align:"middle",children:[(0,I.jsx)(K.Z,{span:6,children:"Opacity"}),(0,I.jsx)(K.Z,{span:12,children:(0,I.jsx)(X.Z,{range:!1,min:0,max:1,step:.01,value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})}),(0,I.jsx)(K.Z,{span:6,children:(0,I.jsx)(Q.Z,{min:0,max:1,size:"small",step:.1,style:{width:"65px"},value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})})]})}),n=this.props,i=(n.defaultStyle,n.isVisible,n.segment,n.metadata,n.onVisibilityChange,n.onStyleChange,(0,B.Z)(n,Re));return(0,I.jsx)(f.Z.Item,(0,j.Z)((0,j.Z)({style:{height:"100%",paddingLeft:"3px"}},i),{},{children:(0,I.jsxs)(E.Z,{align:"start",children:[(0,I.jsx)("div",{style:{paddingLeft:"14px"},children:(0,I.jsxs)(E.Z,{direction:"vertical",align:"end",children:[(0,I.jsx)(z.Z,{size:"small",onChange:this.handleVisibilityChange,checked:this.props.isVisible,checkedChildren:(0,I.jsx)(p.dSq,{}),unCheckedChildren:(0,I.jsx)(p.tgn,{})}),(0,I.jsx)($.Z,{placement:"left",content:t,overlayStyle:{width:"350px"},title:"Display Settings",children:(0,I.jsx)(N.Z,{type:"primary",shape:"circle",icon:(0,I.jsx)(ee.Z,{})})})]})}),(0,I.jsx)(w,{header:this.props.segment.label,attributes:e,selectable:!0,hasLongValues:!0})]})}),this.props.segment.uid)}}]),n}(l.Component);const je=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e=this,t=this.props.segments.map((function(t,n){var i=t.uid;return(0,I.jsx)(Oe,{segment:t,metadata:e.props.metadata[i],isVisible:e.props.visibleSegmentUIDs.has(i),defaultStyle:e.props.defaultSegmentStyles[i],onVisibilityChange:e.props.onSegmentVisibilityChange,onStyleChange:e.props.onSegmentStyleChange},t.uid)}));return(0,I.jsx)(f.Z,{selectable:!1,children:t})}}]),n}(l.Component);var Me;function Ue(e){return function(t){var n=(0,d.TH)(),i=(0,d.s0)(),a=(0,d.UO)();return(0,I.jsx)(e,(0,j.Z)((0,j.Z)({},t),{},{location:n,navigate:i,params:a}))}}!function(e){e.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE="1.2.840.10008.5.1.4.1.1.77.1.6",e.COMPREHENSIVE_SR="1.2.840.10008.5.1.4.1.1.88.33",e.COMPREHENSIVE_3D_SR="1.2.840.10008.5.1.4.1.1.88.34",e.SEGMENTATION="1.2.840.10008.5.1.4.1.1.66.4",e.MICROSCOPY_BULK_SIMPLE_ANNOTATION="1.2.840.10008.5.1.4.1.1.91.1",e.PARAMETRIC_MAP="1.2.840.10008.5.1.4.1.1.30",e.ADVANCED_BLENDING_PRESENTATION_STATE="1.2.840.10008.5.1.4.1.1.11.8",e.COLOR_SOFTCOPY_PRESENTATION_STATE="1.2.840.10008.5.1.4.1.1.11.2",e.GRAYSCALE_SOFTCOPY_PRESENTATION_STATE="1.2.840.10008.5.1.4.1.1.11.1",e.PSEUDOCOLOR_SOFTCOPY_PRESENTATION_STATE="1.2.840.10008.5.1.4.1.1.11.3"}(Me||(Me={}));var Te=function(e){var t=e.CodingSchemeDesignator,n=e.CodeValue;return"".concat(t,"-").concat(n)},ke=function(e){var t=re({content:e.evaluations,name:new F.sr.coding.CodedConcept({value:"121071",meaning:"Finding",schemeDesignator:"DCM"})});if(0===t.length)throw new Error("No finding found for ROI ".concat(e.uid));var n=t[0].ConceptCodeSequence[0];return Te(n)},Ae=function(e){var t,n=e.client,i=e.slide,a=e.preload,o=new g.viewer.VolumeImageViewer({client:n,metadata:i.volumeImages,controls:["overview"],preload:a});return o.activateSelectInteraction({}),i.labelImages.length>0&&(t=new g.viewer.LabelImageViewer({client:n,metadata:i.labelImages[0],resizeFactor:1,orientation:"vertical"})),{volumeViewer:o,labelViewer:t}};const Ee=Ue(function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;(0,i.Z)(this,n),(a=t.call(this,e)).findingOptions=[],a.evaluationOptions={},a.measurements=[],a.geometryTypeOptions={},a.volumeViewportRef=void 0,a.labelViewportRef=void 0,a.volumeViewer=void 0,a.labelViewer=void 0,a.defaultRoiStyle={stroke:{color:[0,126,163],width:2},fill:{color:[0,126,163,.1]}},a.roiStyles={},a.selectionColor=[140,184,198],a.selectedRoiStyle={stroke:{color:[].concat((0,T.Z)(a.selectionColor),[1]),width:3},fill:{color:[].concat((0,T.Z)(a.selectionColor),[.2])}},a.loadPresentationStates=function(){console.info("search for Presentation State instances"),a.props.client.searchForInstances({studyInstanceUID:a.props.studyInstanceUID,queryParams:{Modality:"PR"}}).then((function(e){null==e&&(e=[]),e.forEach((function(e){var t=g.metadata.formatMetadata(e).dataset;console.info('retrieve PR instance "'.concat(t.SOPInstanceUID,'"')),a.props.client.retrieveInstance({studyInstanceUID:a.props.studyInstanceUID,seriesInstanceUID:t.SeriesInstanceUID,sopInstanceUID:t.SOPInstanceUID}).then((function(e){var n=F.aT.DicomMessage.readFile(e),i=g.metadata.formatMetadata(n.dict).dataset;if(a.props.slide.areVolumeImagesMonochrome){var o=i,r=!1;o.AdvancedBlendingSequence.forEach((function(e){r=a.props.slide.seriesInstanceUIDs.includes(e.SeriesInstanceUID)})),r&&(console.info("include Advanced Blending Presentation State instance "+'"'.concat(o.SOPInstanceUID,'"')),o.SOPInstanceUID===a.props.selectedPresentationStateUID&&a.setPresentationState(o),a.setState((function(e){var t={};return e.presentationStates.forEach((function(e){t[e.SOPInstanceUID]=e})),t[o.SOPInstanceUID]=o,{presentationStates:Object.values(t)}})))}else console.info('ignore presentation state "'.concat(t.SOPInstanceUID,'", ')+"application of presentation states for color images has not (yet) been implemented")})).catch((function(e){u.ZP.error("Presentation State could not be loaded"),console.error("failed to load presentation state "+'of SOP instance "'.concat(t.SOPInstanceUID,'" ')+'of series "'.concat(t.SeriesInstanceUID,'" ')+'of study "'.concat(a.props.studyInstanceUID,'": '),e)}))}))})).catch((function(e){u.ZP.error("Presentation State could not be loaded"),console.error(e)}))},a.setPresentationState=function(e){var t=a.volumeViewer.getAllOpticalPaths();console.info('apply Presentation State instance "'.concat(e.SOPInstanceUID,'"'));var n={};t.forEach((function(t){var i=t.identifier;a.volumeViewer.hideOpticalPath(i),a.volumeViewer.deactivateOpticalPath(i),e.AdvancedBlendingSequence.forEach((function(e){var a=e.ReferencedInstanceSequence;void 0===a&&(a=e.ReferencedImageSequence),void 0!==a&&a.forEach((function(a){if(t.sopInstanceUIDs.indexOf(a.ReferencedSOPInstanceUID)>=0){var o,r;if(null!=e.PaletteColorLookupTableSequence){var s=e.PaletteColorLookupTableSequence[0];o=new g.color.PaletteColorLookupTable({uid:null!=s.PaletteColorLookupTableUID?s.PaletteColorLookupTableUID:"",redDescriptor:s.RedPaletteColorLookupTableDescriptor,greenDescriptor:s.GreenPaletteColorLookupTableDescriptor,blueDescriptor:s.BluePaletteColorLookupTableDescriptor,redData:null!=s.RedPaletteColorLookupTableData?new Uint16Array(s.RedPaletteColorLookupTableData):void 0,greenData:null!=s.GreenPaletteColorLookupTableData?new Uint16Array(s.GreenPaletteColorLookupTableData):void 0,blueData:null!=s.BluePaletteColorLookupTableData?new Uint16Array(s.BluePaletteColorLookupTableData):void 0,redSegmentedData:null!=s.SegmentedRedPaletteColorLookupTableData?new Uint16Array(s.SegmentedRedPaletteColorLookupTableData):void 0,greenSegmentedData:null!=s.SegmentedGreenPaletteColorLookupTableData?new Uint16Array(s.SegmentedGreenPaletteColorLookupTableData):void 0,blueSegmentedData:null!=s.SegmentedBluePaletteColorLookupTableData?new Uint16Array(s.SegmentedBluePaletteColorLookupTableData):void 0})}if(null!=e.SoftcopyVOILUTSequence){var l=e.SoftcopyVOILUTSequence[0],c=l.WindowCenter,d=l.WindowWidth;r=[c-.5*d,c+.5*d]}n[i]={opacity:1,paletteColorLookupTable:o,limitValues:r}}}))}))}));var i=new Set;Object.keys(n).forEach((function(e){var t=n[e];null!=t?(a.volumeViewer.setOpticalPathStyle(e,t),a.volumeViewer.activateOpticalPath(e),a.volumeViewer.showOpticalPath(e),i.add(e)):(a.volumeViewer.hideOpticalPath(e),a.volumeViewer.deactivateOpticalPath(e))})),a.setState((function(t){return{activeOpticalPathIdentifiers:i,visibleOpticalPathIdentifiers:i,selectedPresentationStateUID:e.SOPInstanceUID}}))},a.getRoiStyle=function(e){return void 0!==a.roiStyles[e]?a.roiStyles[e]:a.defaultRoiStyle},a.addAnnotations=function(){console.info("search for Comprehensive 3D SR instances"),a.props.client.searchForInstances({studyInstanceUID:a.props.studyInstanceUID,queryParams:{Modality:"SR"}}).then((function(e){null==e&&(e=[]),e.forEach((function(e){var t=g.metadata.formatMetadata(e).dataset;t.SOPClassUID===Me.COMPREHENSIVE_3D_SR&&(console.info('retrieve SR instance "'.concat(t.SOPInstanceUID,'"')),a.props.client.retrieveInstance({studyInstanceUID:a.props.studyInstanceUID,seriesInstanceUID:t.SeriesInstanceUID,sopInstanceUID:t.SOPInstanceUID}).then((function(e){var t=F.aT.DicomMessage.readFile(e),n=g.metadata.formatMetadata(t.dict).dataset;(function(e){var t=e.ContentTemplateSequence;return t.length>0&&"1500"===t[0].TemplateIdentifier})(n)?!function(e){var t=re({content:e.ContentSequence,name:new F.sr.coding.CodedConcept({value:"121024",schemeDesignator:"DCM",meaning:"Subject Class"})});if(0===t.length)return!1;var n=t[0].ConceptCodeSequence[0],i=new F.sr.coding.CodedConcept({value:n.CodeValue,meaning:n.CodeMeaning,schemeDesignator:n.CodingSchemeDesignator}),a=new F.sr.coding.CodedConcept({value:"121027",meaning:"Specimen",schemeDesignator:"DCM"});return!!i.equals(a)}(n)?console.debug('ignore SR document "'.concat(n.SOPInstanceUID,'" ')+"because it does not describe a specimen subject"):!function(e){var t=re({content:e.ContentSequence,name:new F.sr.coding.CodedConcept({value:"126010",schemeDesignator:"DCM",meaning:"Imaging Measurements"})});if(0===t.length)return!1;var n=t[0],i=re({content:n.ContentSequence,name:new F.sr.coding.CodedConcept({value:"125007",schemeDesignator:"DCM",meaning:"Measurement Group"})}),a=!1;return i.forEach((function(e){var t=re({content:e.ContentSequence,name:new F.sr.coding.CodedConcept({value:"111030",schemeDesignator:"DCM",meaning:"Image Region"})});t.length>0&&t[0].ValueType===F.sr.valueTypes.ValueTypes.SCOORD3D&&(a=!0)})),a}(n)?console.debug('ignore SR document "'.concat(n.SOPInstanceUID,'" ')+"because it does not contain any suitable ROI annotations"):new ce(n).ROIs.forEach((function(e){console.info('add ROI "'.concat(e.uid,'"'));var t=e.scoord3d,i=a.props.slide.volumeImages[0];if(t.frameOfReferenceUID===i.FrameOfReferenceUID){var o=a.volumeViewer.getAllROIs().some((function(t){return function(e,t){if(e.scoord3d.graphicType!==t.scoord3d.graphicType)return!1;if(e.scoord3d.frameOfReferenceUID!==t.scoord3d.frameOfReferenceUID)return!1;if(e.scoord3d.graphicData.length!==t.scoord3d.graphicData.length)return!1;for(var n=0;n<e.scoord3d.graphicData.length;++n)if("POINT"===e.scoord3d.graphicType){var i=e.scoord3d,a=t.scoord3d;if(i.graphicData[n].toPrecision(6)!==a.graphicData[n].toPrecision(6))return!1}else for(var o=e.scoord3d,r=t.scoord3d,s=0;s<o.graphicData[n].length;++s)if(o.graphicData[n][s].toPrecision(6)!==r.graphicData[n][s].toPrecision(6))return!1;return!0}(t,e)}));if(o)console.debug('skip already existing ROI "'.concat(e.uid,'"'));else try{a.volumeViewer.addROI(e,{})}catch(r){console.error('could not add ROI "'.concat(e.uid,'"'))}}else console.debug('skip ROI "'.concat(e.uid,'" ')+'of SR document "'.concat(n.SOPInstanceUID,'"')+"because it is defined in another frame of reference")})):console.debug('ignore SR document "'.concat(n.SOPInstanceUID,'" ')+'because it is not structured according to template TID 1500 "MeasurementReport"')})).catch((function(e){u.ZP.error("Annotations could not be loaded"),console.error("failed to load ROIs "+'of SOP instance "'.concat(t.SOPInstanceUID,'" ')+'of series "'.concat(t.SeriesInstanceUID,'" ')+'of study "'.concat(a.props.studyInstanceUID,'": '),e)})),a.forceUpdate())}))})).catch((function(e){u.ZP.error("Annotations could not be loaded"),console.error(e)}))},a.addAnnotationGroups=function(){console.info("search for Microscopy Bulk Simple Annotations instances"),a.props.client.searchForSeries({studyInstanceUID:a.props.studyInstanceUID,queryParams:{Modality:"ANN"}}).then((function(e){null==e&&(e=[]),e.forEach((function(e){var t=g.metadata.formatMetadata(e).dataset;a.props.client.retrieveSeriesMetadata({studyInstanceUID:a.props.studyInstanceUID,seriesInstanceUID:t.SeriesInstanceUID}).then((function(e){e.map((function(e){return new g.metadata.MicroscopyBulkSimpleAnnotations({metadata:e})})).filter((function(e){var t=a.props.slide.volumeImages[0];return e.FrameOfReferenceUID===t.FrameOfReferenceUID&&e.ContainerIdentifier===t.ContainerIdentifier})).forEach((function(e){try{a.volumeViewer.addAnnotationGroups(e)}catch(t){u.ZP.error("Microscopy Bulk Simple Annotations cannot be displayed."),console.error("failed to add annotation groups: ",t)}})),a.forceUpdate()})).catch((function(e){u.ZP.error("Retrieval of metadata of Microscopy Bulk Simple Annotations instances failed."),console.error("failed to retrieve metadata of Microscopy Bulk Simple Annotations instances: ",e)}))}))})).catch((function(e){u.ZP.error("Search for Microscopy Bulk Simple Annotations instances failed."),console.error("failed to search for Microscopy Bulk Simple Annotations instances: ",e)}))},a.addSegmentations=function(){console.info("search for Segmentation instances"),a.props.client.searchForSeries({studyInstanceUID:a.props.studyInstanceUID,queryParams:{Modality:"SEG"}}).then((function(e){null==e&&(e=[]),e.forEach((function(e,t){var n=g.metadata.formatMetadata(e).dataset;a.props.client.retrieveSeriesMetadata({studyInstanceUID:a.props.studyInstanceUID,seriesInstanceUID:n.SeriesInstanceUID}).then((function(e){var t=[];if(e.forEach((function(e){var n=new g.metadata.Segmentation({metadata:e}),i=a.props.slide.volumeImages[0];n.FrameOfReferenceUID===i.FrameOfReferenceUID&&n.ContainerIdentifier===i.ContainerIdentifier&&t.push(n)})),t.length>0){try{a.volumeViewer.addSegments(t)}catch(n){u.ZP.error("Segmentations cannot be displayed"),console.error("failed to add segments: ",n)}a.forceUpdate()}})).catch((function(e){u.ZP.error("Retrieval of metadata of Segmentation instances failed."),console.error("failed to retrieve metadata of Segmentation instances: ",e)}))}))})).catch((function(e){u.ZP.error("Search for Segmentation instances failed."),console.error("failed to search for Segmentation instances: ",e)}))},a.addParametricMaps=function(){console.info("search for Parametric Map instances"),a.props.client.searchForSeries({studyInstanceUID:a.props.studyInstanceUID,queryParams:{Modality:"OT"}}).then((function(e){null==e&&(e=[]),e.forEach((function(e){var t=g.metadata.formatMetadata(e).dataset;a.props.client.retrieveSeriesMetadata({studyInstanceUID:a.props.studyInstanceUID,seriesInstanceUID:t.SeriesInstanceUID}).then((function(e){var t=[];if(e.forEach((function(e){var n=new g.metadata.ParametricMap({metadata:e}),i=a.props.slide.volumeImages[0];n.FrameOfReferenceUID===i.FrameOfReferenceUID&&n.ContainerIdentifier===i.ContainerIdentifier&&t.push(n)})),t.length>0){try{a.volumeViewer.addParameterMappings(t)}catch(n){u.ZP.error("Parametric Map cannot be displayed"),console.error("failed to add mappings: ",n)}a.forceUpdate()}})).catch((function(e){u.ZP.error("Retrieval of metadata of Parametric Map instances failed."),console.error("failed to retrieve metadata of Parametric Map instances: ",e)}))}))})).catch((function(e){u.ZP.error("Search for Parametric Map instances failed."),console.error("failed to search for Parametric Map instances: ",e)}))},a.populateViewports=function(){console.info("populate viewports..."),a.setState({isLoading:!0,presentationStates:[]}),null!=a.volumeViewportRef.current&&(a.volumeViewportRef.current.innerHTML="",a.volumeViewer.render({container:a.volumeViewportRef.current})),null!=a.labelViewportRef.current&&null!=a.labelViewer&&(a.labelViewportRef.current.innerHTML="",a.labelViewer.render({container:a.labelViewportRef.current})),a.setState({isLoading:!1}),a.setDefaultPresentationState(),a.loadPresentationStates(),a.addAnnotations(),a.addAnnotationGroups(),a.addSegmentations(),a.addParametricMaps()},a.onRoiModified=function(e){a.setState((function(e){return{visibleRoiUIDs:new Set(e.visibleRoiUIDs)}}))},a.onRoiDrawn=function(e){var t=e.detail.payload,n=a.state.selectedFinding,i=a.state.selectedEvaluations;if(void 0!==t&&void 0!==n){console.debug('add ROI "'.concat(t.uid,'"'));var o=new F.sr.valueTypes.CodeContentItem({name:new F.sr.coding.CodedConcept({value:"121071",meaning:"Finding",schemeDesignator:"DCM"}),value:n,relationshipType:"CONTAINS"});t.addEvaluation(o),i.forEach((function(e){var n=new F.sr.valueTypes.CodeContentItem({name:e.name,value:e.value,relationshipType:"CONTAINS"});t.addEvaluation(n)}));var r=Te(n),s=a.getRoiStyle(r);a.volumeViewer.addROI(t,s),a.setState((function(e){var n=e.visibleRoiUIDs;return n.add(t.uid),{visibleRoiUIDs:n}}))}else console.debug('could not add ROI "'.concat(t.uid,'"'))},a.onRoiSelected=function(e){var t=e.detail.payload;if(null!==t){console.debug('selected ROI "'.concat(t.uid,'"')),a.volumeViewer.setROIStyle(t.uid,a.selectedRoiStyle);var n=ke(t);a.volumeViewer.getAllROIs().forEach((function(e){e.uid!==t.uid&&a.volumeViewer.setROIStyle(e.uid,a.getRoiStyle(n))})),a.setState({selectedRoiUIDs:new Set([t.uid])})}else a.setState({selectedRoiUIDs:new Set})},a.onLoadingStarted=function(e){a.setState({isLoading:!0})},a.onLoadingEnded=function(e){a.setState({isLoading:!1})},a.onFrameLoadingEnded=function(e){var t=e.detail.payload;if(t.sopClassUID===Me.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE&&a.props.slide.areVolumeImagesMonochrome){var n=t.channelIdentifier;if(!(n in a.state.pixelDataStatistics)){for(var i=Math.pow(2,16),o=Math.ceil(t.pixelArray.length/i),r=0,s=[],l=[],c=0;c<o;c++){r=c*i;var d=t.pixelArray.slice(r,r+i);s.push(Math.min.apply(Math,(0,T.Z)(d))),l.push(Math.max.apply(Math,(0,T.Z)(d)))}var u=Math.min.apply(Math,s),h=Math.max.apply(Math,l);a.setState((function(e){var t=e.pixelDataStatistics;return null!=t[n]?t[n]={min:Math.min(t[n].min,u),max:Math.max(t[n].max,h),numFramesSampled:t[n].numFramesSampled+1}:t[n]={min:u,max:h,numFramesSampled:1},e}))}}},a.onRoiRemoved=function(e){var t=e.detail.payload;console.debug('removed ROI "'.concat(t.uid,'"'))},console.info('view slide "'.concat(a.props.slide.containerIdentifier,'": '),a.props.slide);var r=["point","circle","box","polygon","line","freehandpolygon","freehandline"];e.annotations.forEach((function(e){var t=new F.sr.coding.CodedConcept(e.finding);a.findingOptions.push(t);var n=Te(t);void 0!==e.geometryTypes?a.geometryTypeOptions[n]=e.geometryTypes:a.geometryTypeOptions[n]=r,a.evaluationOptions[n]=[],void 0!==e.evaluations&&e.evaluations.forEach((function(e){a.evaluationOptions[n].push({name:new F.sr.coding.CodedConcept(e.name),values:e.values.map((function(e){return new F.sr.coding.CodedConcept(e)}))})})),void 0!==e.measurements&&e.measurements.forEach((function(e){a.measurements.push({name:new F.sr.coding.CodedConcept(e.name),value:void 0,unit:new F.sr.coding.CodedConcept(e.unit)})})),null!=e.style?a.roiStyles[n]=e.style:a.roiStyles[n]=a.defaultRoiStyle})),a.componentSetup=a.componentSetup.bind((0,o.Z)(a)),a.componentCleanup=a.componentCleanup.bind((0,o.Z)(a)),a.handleRoiDrawing=a.handleRoiDrawing.bind((0,o.Z)(a)),a.handleRoiTranslation=a.handleRoiTranslation.bind((0,o.Z)(a)),a.handleRoiModification=a.handleRoiModification.bind((0,o.Z)(a)),a.handleRoiVisibilityChange=a.handleRoiVisibilityChange.bind((0,o.Z)(a)),a.handleRoiRemoval=a.handleRoiRemoval.bind((0,o.Z)(a)),a.handleAnnotationConfigurationCancellation=a.handleAnnotationConfigurationCancellation.bind((0,o.Z)(a)),a.handleAnnotationGeometryTypeSelection=a.handleAnnotationGeometryTypeSelection.bind((0,o.Z)(a)),a.handleAnnotationMeasurementActivation=a.handleAnnotationMeasurementActivation.bind((0,o.Z)(a)),a.handleAnnotationFindingSelection=a.handleAnnotationFindingSelection.bind((0,o.Z)(a)),a.handleAnnotationEvaluationSelection=a.handleAnnotationEvaluationSelection.bind((0,o.Z)(a)),a.handleAnnotationEvaluationClearance=a.handleAnnotationEvaluationClearance.bind((0,o.Z)(a)),a.handleAnnotationConfigurationCompletion=a.handleAnnotationConfigurationCompletion.bind((0,o.Z)(a)),a.handleAnnotationSelection=a.handleAnnotationSelection.bind((0,o.Z)(a)),a.handleAnnotationVisibilityChange=a.handleAnnotationVisibilityChange.bind((0,o.Z)(a)),a.handleAnnotationGroupVisibilityChange=a.handleAnnotationGroupVisibilityChange.bind((0,o.Z)(a)),a.handleAnnotationGroupStyleChange=a.handleAnnotationGroupStyleChange.bind((0,o.Z)(a)),a.handleReportGeneration=a.handleReportGeneration.bind((0,o.Z)(a)),a.handleReportVerification=a.handleReportVerification.bind((0,o.Z)(a)),a.handleReportCancellation=a.handleReportCancellation.bind((0,o.Z)(a)),a.handleSegmentVisibilityChange=a.handleSegmentVisibilityChange.bind((0,o.Z)(a)),a.handleSegmentStyleChange=a.handleSegmentStyleChange.bind((0,o.Z)(a)),a.handleMappingVisibilityChange=a.handleMappingVisibilityChange.bind((0,o.Z)(a)),a.handleMappingStyleChange=a.handleMappingStyleChange.bind((0,o.Z)(a)),a.handleOpticalPathVisibilityChange=a.handleOpticalPathVisibilityChange.bind((0,o.Z)(a)),a.handleOpticalPathStyleChange=a.handleOpticalPathStyleChange.bind((0,o.Z)(a)),a.handleOpticalPathActivityChange=a.handleOpticalPathActivityChange.bind((0,o.Z)(a)),a.handlePresentationStateSelection=a.handlePresentationStateSelection.bind((0,o.Z)(a)),a.handlePresentationStateReset=a.handlePresentationStateReset.bind((0,o.Z)(a)),console.info("instantiate viewers for slide of series "+a.props.seriesInstanceUID);var s=Ae({client:a.props.client,slide:a.props.slide,preload:a.props.preload}),c=s.volumeViewer,d=s.labelViewer;return a.volumeViewer=c,a.labelViewer=d,a.volumeViewportRef=l.createRef(),a.labelViewportRef=l.createRef(),a.volumeViewer.getAllOpticalPaths().forEach((function(e){a.volumeViewer.deactivateOpticalPath(e.identifier)})),a.state={selectedRoiUIDs:new Set,visibleRoiUIDs:new Set,visibleSegmentUIDs:new Set,visibleMappingUIDs:new Set,visibleAnnotationGroupUIDs:new Set,visibleOpticalPathIdentifiers:new Set,activeOpticalPathIdentifiers:new Set,presentationStates:[],selectedFinding:void 0,selectedEvaluations:[],generatedReport:void 0,isLoading:!1,isAnnotationModalVisible:!1,isReportModalVisible:!1,isRoiDrawingActive:!1,isRoiTranslationActive:!1,isRoiModificationActive:!1,areRoisHidden:!1,pixelDataStatistics:{},defaultOpticalPathStyles:{},selectedPresentationStateUID:a.props.selectedPresentationStateUID},a}return(0,a.Z)(n,[{key:"componentDidUpdate",value:function(e,t){var n=this;if(this.props.location.pathname!==e.location.pathname||this.props.studyInstanceUID!==e.studyInstanceUID||this.props.seriesInstanceUID!==e.seriesInstanceUID||this.props.slide!==e.slide||this.props.client!==e.client){this.volumeViewer.cleanup(),null!=this.labelViewer&&this.labelViewer.cleanup();var i=Ae({client:this.props.client,slide:this.props.slide,preload:this.props.preload}),a=i.volumeViewer,o=i.labelViewer;this.volumeViewer=a,this.labelViewer=o;var r=new Set,s=new Set;this.volumeViewer.getAllOpticalPaths().forEach((function(e){var t=e.identifier;n.volumeViewer.isOpticalPathVisible(t)&&s.add(t),n.volumeViewer.isOpticalPathActive(t)&&r.add(t)})),this.setState({visibleRoiUIDs:new Set,visibleSegmentUIDs:new Set,visibleMappingUIDs:new Set,visibleAnnotationGroupUIDs:new Set,visibleOpticalPathIdentifiers:s,activeOpticalPathIdentifiers:r,presentationStates:[]}),this.populateViewports()}}},{key:"componentCleanup",value:function(){document.body.removeEventListener("dicommicroscopyviewer_roi_drawn",this.onRoiDrawn),document.body.removeEventListener("dicommicroscopyviewer_roi_selected",this.onRoiSelected),document.body.removeEventListener("dicommicroscopyviewer_roi_removed",this.onRoiRemoved),document.body.removeEventListener("dicommicroscopyviewer_roi_modified",this.onRoiModified),document.body.removeEventListener("dicommicroscopyviewer_loading_started",this.onLoadingStarted),document.body.removeEventListener("dicommicroscopyviewer_loading_ended",this.onLoadingEnded),document.body.removeEventListener("dicommicroscopyviewer_frame_loading_ended",this.onFrameLoadingEnded),this.volumeViewer.cleanup(),null!=this.labelViewer&&this.labelViewer.cleanup()}},{key:"componentWillUnmount",value:function(){window.removeEventListener("beforeunload",this.componentCleanup)}},{key:"componentSetup",value:function(){var e=this;document.body.addEventListener("dicommicroscopyviewer_roi_drawn",this.onRoiDrawn),document.body.addEventListener("dicommicroscopyviewer_roi_selected",this.onRoiSelected),document.body.addEventListener("dicommicroscopyviewer_roi_removed",this.onRoiRemoved),document.body.addEventListener("dicommicroscopyviewer_roi_modified",this.onRoiModified),document.body.addEventListener("dicommicroscopyviewer_loading_started",this.onLoadingStarted),document.body.addEventListener("dicommicroscopyviewer_loading_ended",this.onLoadingEnded),document.body.addEventListener("dicommicroscopyviewer_frame_loading_ended",this.onFrameLoadingEnded);document.body.addEventListener("keyup",(function(t){"Escape"===t.key?(e.state.isRoiDrawingActive?(console.info("deactivate drawing of ROIs"),e.volumeViewer.deactivateDrawInteraction(),e.volumeViewer.activateSelectInteraction({})):e.state.isRoiModificationActive?(console.info("deactivate modification of ROIs"),e.volumeViewer.deactivateModifyInteraction(),e.volumeViewer.activateSelectInteraction({})):e.state.isRoiTranslationActive&&(console.info("deactivate modification of ROIs"),e.volumeViewer.deactivateTranslateInteraction(),e.volumeViewer.activateSelectInteraction({})),e.setState({isAnnotationModalVisible:!1,isRoiTranslationActive:!1,isRoiDrawingActive:!1,isRoiModificationActive:!1})):"d"===t.key?e.handleRoiDrawing():"m"===t.key?e.handleRoiModification():"t"===t.key?e.handleRoiTranslation():"r"===t.key?e.handleRoiRemoval():"v"===t.key?e.handleRoiVisibilityChange():"s"===t.key&&e.handleReportGeneration()}))}},{key:"componentDidMount",value:function(){if(window.addEventListener("beforeunload",this.componentCleanup),this.componentSetup(),this.populateViewports(),!this.props.slide.areVolumeImagesMonochrome){var e=!1,t=this.props.slide.volumeImages[0];if(null==t.OpticalPathSequence[0].ICCProfile){if("OpticalPathSequence"in t.bulkdataReferences)"ICCProfile"in t.bulkdataReferences.OpticalPathSequence[0]&&(e=!0)}else e=!0;e||u.ZP.warning("No ICC Profile was found for color images")}}},{key:"handleAnnotationFindingSelection",value:function(e,t){var n=this;this.findingOptions.forEach((function(t){t.CodeValue===e&&(console.info('selected finding "'.concat(t.CodeMeaning,'"')),n.setState({selectedFinding:t,selectedEvaluations:[]}))}))}},{key:"handleAnnotationGeometryTypeSelection",value:function(e,t){this.setState({selectedGeometryType:e})}},{key:"handleAnnotationMeasurementActivation",value:function(e){e.target.checked?this.setState({selectedMarkup:"measurement"}):this.setState({selectedMarkup:void 0})}},{key:"handleAnnotationEvaluationSelection",value:function(e,t){var n=this,i=this.state.selectedFinding;if(void 0!==i){var a=Te(i),o=t.label;this.evaluationOptions[a].forEach((function(t){t.name.CodeValue===o.CodeValue&&t.name.CodingSchemeDesignator===o.CodingSchemeDesignator&&t.values.forEach((function(i){if(i.CodeValue===e){var a=n.state.selectedEvaluations.filter((function(e){return e.name!==t.name}));n.setState({selectedEvaluations:[].concat((0,T.Z)(a),[{name:o,value:i}])})}}))}))}}},{key:"handleAnnotationEvaluationClearance",value:function(){this.setState({selectedEvaluations:[]})}},{key:"handleAnnotationConfigurationCompletion",value:function(){console.debug("complete annotation configuration");var e=this.state.selectedFinding,t=this.state.selectedGeometryType,n=this.state.selectedMarkup;void 0!==t&&void 0!==e?(this.volumeViewer.activateDrawInteraction({geometryType:t,markup:n}),this.setState({isAnnotationModalVisible:!1,isRoiDrawingActive:!0})):console.error("could not complete annotation configuration")}},{key:"handleAnnotationConfigurationCancellation",value:function(){console.debug("cancel annotation configuration"),this.setState({isAnnotationModalVisible:!1,isRoiDrawingActive:!1})}},{key:"handleReportGeneration",value:function(){console.info("save ROIs");var e=this.volumeViewer.getAllROIs(),t=this.volumeViewer.getAllOpticalPaths(),n=this.volumeViewer.getOpticalPathMetadata(t[0].identifier),i=n[n.length-1];i.SpecimenDescriptionSequence.length>1&&console.error("more than one specimen has been described for the slide");var a,o=i.SpecimenDescriptionSequence[0];console.debug("create Observation Context"),void 0!==this.props.user?a=new F.sr.templates.PersonObserverIdentifyingAttributes({name:this.props.user.name,loginName:this.props.user.email}):(console.warn("no user information available"),a=new F.sr.templates.PersonObserverIdentifyingAttributes({name:"ANONYMOUS"}));var r=new F.sr.templates.ObservationContext({observerPersonContext:new F.sr.templates.ObserverContext({observerType:new F.sr.coding.CodedConcept({value:"121006",schemeDesignator:"DCM",meaning:"Person"}),observerIdentifyingAttributes:a}),observerDeviceContext:new F.sr.templates.ObserverContext({observerType:new F.sr.coding.CodedConcept({value:"121007",schemeDesignator:"DCM",meaning:"Device"}),observerIdentifyingAttributes:new F.sr.templates.DeviceObserverIdentifyingAttributes({uid:this.props.app.uid,manufacturerName:"MGH Computational Pathology",modelName:this.props.app.name})}),subjectContext:new F.sr.templates.SubjectContext({subjectClass:new F.sr.coding.CodedConcept({value:"121027",schemeDesignator:"DCM",meaning:"Specimen"}),subjectClassSpecificContext:new F.sr.templates.SubjectContextSpecimen({uid:o.SpecimenUID,identifier:o.SpecimenIdentifier,containerIdentifier:i.ContainerIdentifier})})});console.debug("encode Imaging Measurements");for(var s=[],l=0;l<e.length;l++){var c,d=e[l];if(this.state.visibleRoiUIDs.has(d.uid)){var u=d.evaluations.find((function(e){return"121071"===e.ConceptNameCodeSequence[0].CodeValue}));if(void 0===u)throw new Error('No finding type was specified for ROI "'.concat(d.uid,'"'));var h=new F.sr.templates.PlanarROIMeasurementsAndQualitativeEvaluations({trackingIdentifier:new F.sr.templates.TrackingIdentifier({uid:null!==(c=d.properties.trackingUID)&&void 0!==c?c:d.uid,identifier:"ROI #".concat(l+1)}),referencedRegion:new F.sr.contentItems.ImageRegion3D({graphicType:d.scoord3d.graphicType,graphicData:d.scoord3d.graphicData,frameOfReferenceUID:d.scoord3d.frameOfReferenceUID}),findingType:new F.sr.coding.CodedConcept({value:u.ConceptCodeSequence[0].CodeValue,schemeDesignator:u.ConceptCodeSequence[0].CodingSchemeDesignator,meaning:u.ConceptCodeSequence[0].CodeMeaning}),qualitativeEvaluations:d.evaluations.filter((function(e){return"121071"!==e.ConceptNameCodeSequence[0].CodeValue})),measurements:d.measurements});h[0].ContentTemplateSequence=[{MappingResource:"DCMR",TemplateIdentifier:"1410"}],s.push.apply(s,(0,T.Z)(h))}}console.debug("create Measurement Report document content");var p=new F.sr.templates.MeasurementReport({languageOfContentItemAndDescendants:new F.sr.templates.LanguageOfContentItemAndDescendants({}),observationContext:r,procedureReported:new F.sr.coding.CodedConcept({value:"112703",schemeDesignator:"DCM",meaning:"Whole Slide Imaging"}),imagingMeasurements:s});console.info("create Comprehensive 3D SR document");var v=new F.sr.documents.Comprehensive3DSR({content:p[0],evidence:[i],seriesInstanceUID:F.aT.DicomMetaDictionary.uid(),seriesNumber:1,seriesDescription:"Annotation",sopInstanceUID:F.aT.DicomMetaDictionary.uid(),instanceNumber:1,manufacturer:"MGH Computational Pathology",previousVersions:void 0});this.setState({isReportModalVisible:!0,generatedReport:v})}},{key:"handleReportVerification",value:function(){console.info("verfied report");var e=this.state.generatedReport;if(void 0!==e){var t=e;console.debug("create File Meta Information");var n=new Uint8Array(2);n[1]=1;var i={"00020001":{Value:[n.buffer],vr:"OB"},"00020002":{Value:[t.SOPClassUID],vr:"UI"},"00020003":{Value:[t.SOPInstanceUID],vr:"UI"},"00020010":{Value:["1.2.840.10008.1.2.1"],vr:"UI"},"00020012":{Value:[this.props.app.uid],vr:"UI"}};console.info("store Comprehensive 3D SR document");var a=new F.aT.DicomDict(i);a.dict=F.aT.DicomMetaDictionary.denaturalizeDataset(t);var o=a.write();this.props.client.storeInstances({datasets:[o]}).then((function(e){return u.ZP.info("Annotations were saved.")})).catch((function(e){u.ZP.error("Annotations could not be saved"),console.error(e)}))}this.setState({isReportModalVisible:!1,generatedReport:void 0})}},{key:"handleReportCancellation",value:function(){this.setState({isReportModalVisible:!1,generatedReport:void 0})}},{key:"handleAnnotationSelection",value:function(e){var t=this,n=e.roiUID;console.log("selected ROI ".concat(n)),this.setState({selectedRoiUIDs:new Set([n])}),this.volumeViewer.getAllROIs().forEach((function(e){var i={};if(e.uid===n)i=t.selectedRoiStyle,t.setState((function(t){var n=t.visibleRoiUIDs;return n.add(e.uid),{visibleRoiUIDs:n}}));else if(t.state.visibleRoiUIDs.has(e.uid)){var a=ke(e);i=t.getRoiStyle(a)}t.volumeViewer.setROIStyle(e.uid,i)}))}},{key:"handleAnnotationVisibilityChange",value:function(e){var t=e.roiUID;if(e.isVisible){console.info("show ROI ".concat(t));var n=this.volumeViewer.getROI(t),i=ke(n);this.volumeViewer.setROIStyle(n.uid,this.getRoiStyle(i)),this.setState((function(e){var t=e.visibleRoiUIDs;return t.add(n.uid),{visibleRoiUIDs:t}}))}else console.info("hide ROI ".concat(t)),this.setState((function(e){var n=e.selectedRoiUIDs;n.delete(t);var i=e.visibleRoiUIDs;return i.delete(t),{visibleRoiUIDs:i,selectedRoiUIDs:n}})),this.volumeViewer.setROIStyle(t,{})}},{key:"handleAnnotationGroupVisibilityChange",value:function(e){var t=e.annotationGroupUID,n=e.isVisible;console.log("change visibility of annotation group ".concat(t)),n?(console.info("show annotation group ".concat(t)),this.volumeViewer.showAnnotationGroup(t),this.setState((function(e){var n=new Set(e.visibleAnnotationGroupUIDs);return n.add(t),{visibleAnnotationGroupUIDs:n}}))):(console.info("hide annotation group ".concat(t)),this.volumeViewer.hideAnnotationGroup(t),this.setState((function(e){var n=new Set(e.visibleAnnotationGroupUIDs);return n.delete(t),{visibleAnnotationGroupUIDs:n}})))}},{key:"handleAnnotationGroupStyleChange",value:function(e){var t=e.annotationGroupUID,n=e.styleOptions;console.log("change style of annotation group ".concat(t)),this.volumeViewer.setAnnotationGroupStyle(t,n)}},{key:"handleSegmentVisibilityChange",value:function(e){var t=e.segmentUID,n=e.isVisible;console.log("change visibility of segment ".concat(t)),n?(console.info("show segment ".concat(t)),this.volumeViewer.showSegment(t),this.setState((function(e){var n=new Set(e.visibleSegmentUIDs);return n.add(t),{visibleSegmentUIDs:n}}))):(console.info("hide segment ".concat(t)),this.volumeViewer.hideSegment(t),this.setState((function(e){var n=new Set(e.visibleSegmentUIDs);return n.delete(t),{visibleSegmentUIDs:n}})))}},{key:"handleSegmentStyleChange",value:function(e){var t=e.segmentUID,n=e.styleOptions;console.log("change style of segment ".concat(t)),this.volumeViewer.setSegmentStyle(t,n)}},{key:"handleMappingVisibilityChange",value:function(e){var t=e.mappingUID,n=e.isVisible;console.log("change visibility of mapping ".concat(t)),n?(console.info("show mapping ".concat(t)),this.volumeViewer.showParameterMapping(t),this.setState((function(e){var n=new Set(e.visibleMappingUIDs);return n.add(t),{visibleMappingUIDs:n}}))):(console.info("hide mapping ".concat(t)),this.volumeViewer.hideParameterMapping(t),this.setState((function(e){var n=new Set(e.visibleMappingUIDs);return n.delete(t),{visibleMappingUIDs:n}})))}},{key:"handleMappingStyleChange",value:function(e){var t=e.mappingUID,n=e.styleOptions;console.log("change style of mapping ".concat(t)),this.volumeViewer.setParameterMappingStyle(t,n)}},{key:"handleOpticalPathVisibilityChange",value:function(e){var t=e.opticalPathIdentifier,n=e.isVisible;console.log("change visibility of optical path ".concat(t)),n?(console.info("show optical path ".concat(t)),this.volumeViewer.showOpticalPath(t),this.setState((function(e){var n=new Set(e.visibleOpticalPathIdentifiers);return n.add(t),{visibleOpticalPathIdentifiers:n}}))):(console.info("hide optical path ".concat(t)),this.volumeViewer.hideOpticalPath(t),this.setState((function(e){var n=new Set(e.visibleOpticalPathIdentifiers);return n.delete(t),{visibleOpticalPathIdentifiers:n}})))}},{key:"handleOpticalPathStyleChange",value:function(e){var t=e.opticalPathIdentifier,n=e.styleOptions;console.log("change style of optical path ".concat(t)),this.volumeViewer.setOpticalPathStyle(t,n)}},{key:"handleOpticalPathActivityChange",value:function(e){var t=e.opticalPathIdentifier,n=e.isActive;console.log("change activity of optical path ".concat(t)),n?(console.info("activate optical path ".concat(t)),this.volumeViewer.activateOpticalPath(t),this.setState((function(e){var n=new Set(e.activeOpticalPathIdentifiers);return n.add(t),{activeOpticalPathIdentifiers:n}}))):(console.info("deactivate optical path ".concat(t)),this.volumeViewer.deactivateOpticalPath(t),this.setState((function(e){var n=new Set(e.activeOpticalPathIdentifiers);return n.delete(t),{activeOpticalPathIdentifiers:n}})))}},{key:"setDefaultPresentationState",value:function(){var e=this,t=this.volumeViewer.getAllOpticalPaths();t.sort((function(e,t){return e.identifier-t.identifier}));var n=new Set,i=this.state.defaultOpticalPathStyles;if(t.forEach((function(t){var a=t.identifier;e.volumeViewer.hideOpticalPath(a),e.volumeViewer.deactivateOpticalPath(a);var o,r=e.state.pixelDataStatistics[a];null!=r&&(o=[r.min,r.max]),a in i&&e.volumeViewer.setOpticalPathStyle(a,{color:[255,255,255],limitValues:o,opacity:1}),t.isMonochromatic?null!=t.paletteColorLookupTableUID&&n.add(a):n.add(a)})),0===n.size){var a=[[0,0,255],[0,255,0],[255,0,0]];t.forEach((function(t){var o=t.identifier;if(t.isMonochromatic){var r=n.size;if(r<3){var s=(0,j.Z)({},e.volumeViewer.getOpticalPathStyle(o));o in i||(i[o]=s);var l=r;s.color=a[l];var c=e.state.pixelDataStatistics[t.identifier];null!=c&&(s.limitValues=[c.min,c.max]),e.volumeViewer.setOpticalPathStyle(t.identifier,s),n.add(t.identifier)}}}))}console.info("selected n=".concat(n.size," optical paths ")+"for visualization"),n.forEach((function(t){e.volumeViewer.showOpticalPath(t)})),this.setState((function(e){return{activeOpticalPathIdentifiers:new Set(n),visibleOpticalPathIdentifiers:new Set(n),defaultOpticalPathStyles:i}}))}},{key:"handlePresentationStateReset",value:function(){this.setState({selectedPresentationStateUID:void 0});var e=this.props.location.pathname;this.props.navigate(e),this.setDefaultPresentationState()}},{key:"handlePresentationStateSelection",value:function(e,t){var n;if(null!=e)if(console.info('select Presentation State instance "'.concat(e,'"')),this.state.presentationStates.forEach((function(t){t.SOPInstanceUID===e&&(n=t)})),null!=n){var i=this.props.location.pathname;i+="?state=".concat(e),this.props.navigate(i),this.setPresentationState(n)}else u.ZP.error("Presentation State could not be found"),console.log("failed to handle section of presentation state: "+'could not find instance "'.concat(e,'"'));else this.handlePresentationStateReset();this.setState({selectedPresentationStateUID:e})}},{key:"handleRoiDrawing",value:function(){this.state.isRoiDrawingActive?(console.info("deactivate drawing of ROIs"),this.volumeViewer.deactivateDrawInteraction(),this.volumeViewer.activateSelectInteraction({}),this.setState({isAnnotationModalVisible:!1,isRoiTranslationActive:!1,isRoiDrawingActive:!1,isRoiModificationActive:!1})):(console.info("activate drawing of ROIs"),this.setState({isAnnotationModalVisible:!0,isRoiDrawingActive:!0,isRoiModificationActive:!1,isRoiTranslationActive:!1}),this.volumeViewer.deactivateSelectInteraction(),this.volumeViewer.deactivateSnapInteraction(),this.volumeViewer.deactivateTranslateInteraction(),this.volumeViewer.deactivateModifyInteraction())}},{key:"handleRoiModification",value:function(){console.info("toggle modification of ROIs"),this.volumeViewer.isModifyInteractionActive?(this.volumeViewer.deactivateModifyInteraction(),this.volumeViewer.deactivateSnapInteraction(),this.volumeViewer.activateSelectInteraction({}),this.setState({isRoiTranslationActive:!1,isRoiDrawingActive:!1,isRoiModificationActive:!1})):(this.setState({isRoiModificationActive:!0,isRoiDrawingActive:!1,isRoiTranslationActive:!1}),this.volumeViewer.deactivateDrawInteraction(),this.volumeViewer.deactivateTranslateInteraction(),this.volumeViewer.deactivateSelectInteraction(),this.volumeViewer.activateSnapInteraction({}),this.volumeViewer.activateModifyInteraction({}))}},{key:"handleRoiTranslation",value:function(){console.info("toggle translation of ROIs"),this.volumeViewer.isTranslateInteractionActive?(this.volumeViewer.deactivateTranslateInteraction(),this.setState({isRoiTranslationActive:!1,isRoiDrawingActive:!1,isRoiModificationActive:!1})):(this.setState({isRoiTranslationActive:!0,isRoiDrawingActive:!1,isRoiModificationActive:!1}),this.volumeViewer.deactivateModifyInteraction(),this.volumeViewer.deactivateSnapInteraction(),this.volumeViewer.deactivateDrawInteraction(),this.volumeViewer.deactivateSelectInteraction(),this.volumeViewer.activateTranslateInteraction({}))}},{key:"handleRoiRemoval",value:function(){var e=this;this.volumeViewer.deactivateDrawInteraction(),this.volumeViewer.deactivateSnapInteraction(),this.volumeViewer.deactivateTranslateInteraction(),this.volumeViewer.deactivateModifyInteraction(),this.state.selectedRoiUIDs.size>0?(this.state.selectedRoiUIDs.forEach((function(t){void 0!==t?(console.info('remove ROI "'.concat(t,'"')),e.volumeViewer.removeROI(t),u.ZP.info("Annotation was removed")):u.ZP.warning("No annotation was selected for removal")})),this.setState({selectedRoiUIDs:new Set,isRoiTranslationActive:!1,isRoiDrawingActive:!1,isRoiModificationActive:!1})):(this.state.visibleRoiUIDs.forEach((function(t){console.info('remove ROI "'.concat(t,'"')),e.volumeViewer.removeROI(t)})),this.setState({visibleRoiUIDs:new Set,isRoiTranslationActive:!1,isRoiDrawingActive:!1,isRoiModificationActive:!1})),this.volumeViewer.activateSelectInteraction({})}},{key:"handleRoiVisibilityChange",value:function(){var e=this;console.info("toggle visibility of ROIs"),this.volumeViewer.areROIsVisible?(this.volumeViewer.deactivateDrawInteraction(),this.volumeViewer.deactivateSnapInteraction(),this.volumeViewer.deactivateTranslateInteraction(),this.volumeViewer.deactivateSelectInteraction(),this.volumeViewer.deactivateModifyInteraction(),this.volumeViewer.hideROIs(),this.setState({areRoisHidden:!0,isRoiDrawingActive:!1,isRoiModificationActive:!1,isRoiTranslationActive:!1})):(this.volumeViewer.showROIs(),this.volumeViewer.activateSelectInteraction({}),this.state.selectedRoiUIDs.forEach((function(t){void 0!==t&&e.volumeViewer.setROIStyle(t,e.selectedRoiStyle)})),this.setState({areRoisHidden:!1}))}},{key:"render",value:function(){var e=this,t=[],n=[],i=[],a=[];t.push.apply(t,(0,T.Z)(this.volumeViewer.getAllROIs())),n.push.apply(n,(0,T.Z)(this.volumeViewer.getAllSegments())),i.push.apply(i,(0,T.Z)(this.volumeViewer.getAllParameterMappings())),a.push.apply(a,(0,T.Z)(this.volumeViewer.getAllAnnotationGroups()));var o,r,s=["specimens","optical-paths","annotations","presentation-states"],l=this.state.generatedReport;void 0!==l&&(o=(0,I.jsx)(de,{dataset:l})),t.length>0&&(r=(0,I.jsx)(Y,{rois:t,selectedRoiUIDs:this.state.selectedRoiUIDs,visibleRoiUIDs:this.state.visibleRoiUIDs,onSelection:this.handleAnnotationSelection,onVisibilityChange:this.handleAnnotationVisibilityChange}));var c=this.findingOptions.map((function(e){return(0,I.jsx)(k.Z.Option,{value:e.CodeValue,children:e.CodeMeaning},e.CodeValue)})),d={point:(0,I.jsx)(k.Z.Option,{value:"point",children:"Point"},"point"),circle:(0,I.jsx)(k.Z.Option,{value:"circle",children:"Circle"},"circle"),box:(0,I.jsx)(k.Z.Option,{value:"box",children:"Box"},"box"),polygon:(0,I.jsx)(k.Z.Option,{value:"polygon",children:"Polygon"},"polygon"),line:(0,I.jsx)(k.Z.Option,{value:"line",children:"Line"},"line"),freehandpolygon:(0,I.jsx)(k.Z.Option,{value:"freehandpolygon",children:"Polygon (freehand)"},"freehandpolygon"),freehandline:(0,I.jsx)(k.Z.Option,{value:"freehandline",children:"Line (freehand)"},"freehandline")},u=[(0,I.jsx)(k.Z,{style:{minWidth:130},onSelect:this.handleAnnotationFindingSelection,defaultActiveFirstOption:!0,children:c},"annotation-finding")],v=this.state.selectedFinding;if(void 0!==v){var m=Te(v);this.evaluationOptions[m].forEach((function(t){var n=t.values.map((function(e){return(0,I.jsx)(k.Z.Option,{value:e.CodeValue,label:t.name,children:e.CodeMeaning},e.CodeValue)}));u.push((0,I.jsxs)(I.Fragment,{children:[t.name.CodeMeaning,(0,I.jsx)(k.Z,{style:{minWidth:130},onSelect:e.handleAnnotationEvaluationSelection,allowClear:!0,onClear:e.handleAnnotationEvaluationClearance,defaultActiveFirstOption:!1,children:n})]}))}));var g=this.geometryTypeOptions[m].map((function(e){return d[e]}));u.push((0,I.jsxs)(I.Fragment,{children:["ROI geometry type",(0,I.jsx)(k.Z,{style:{minWidth:130},onSelect:this.handleAnnotationGeometryTypeSelection,children:g},"annotation-geometry-type")]})),u.push((0,I.jsx)(A.Z,{onChange:this.handleAnnotationMeasurementActivation,children:"measure"},"annotation-measurement"))}var S=(0,I.jsx)(f.Z.SubMenu,{title:"Specimens",children:(0,I.jsx)(fe,{metadata:this.props.slide.volumeImages[0],showstain:!1})},"specimens"),y=(0,I.jsx)(f.Z.SubMenu,{title:"Equipment",children:(0,I.jsx)(oe,{metadata:this.props.slide.volumeImages[0]})},"equipment"),C={},b={},w=this.volumeViewer.getAllOpticalPaths();w.sort((function(e,t){return e.identifier<t.identifier?-1:e.identifier>t.identifier?1:0})),w.forEach((function(t){var n=t.identifier,i=e.volumeViewer.getOpticalPathMetadata(n);b[n]=i;var a=e.volumeViewer.getOpticalPathStyle(n);if(null==e.state.selectedPresentationStateUID){var o=e.state.pixelDataStatistics[n];null!=o&&(a.limitValues=[o.min,o.max])}C[n]=a}));var D,x,Z,V,P,R=(0,I.jsx)(f.Z.SubMenu,{title:"Optical Paths",children:(0,I.jsx)(xe,{metadata:b,opticalPaths:w,defaultOpticalPathStyles:C,visibleOpticalPathIdentifiers:this.state.visibleOpticalPathIdentifiers,activeOpticalPathIdentifiers:this.state.activeOpticalPathIdentifiers,onOpticalPathVisibilityChange:this.handleOpticalPathVisibilityChange,onOpticalPathStyleChange:this.handleOpticalPathStyleChange,onOpticalPathActivityChange:this.handleOpticalPathActivityChange,selectedPresentationStateUID:this.state.selectedPresentationStateUID})},"optical-paths");if(this.state.presentationStates.length>0){var O=[];this.state.presentationStates.forEach((function(e){O.push((0,I.jsx)(k.Z.Option,{value:e.SOPInstanceUID,dropdownMatchSelectWidth:!1,size:"small",children:e.ContentDescription},e.SOPInstanceUID))})),O.push((0,I.jsx)(k.Z.Option,{value:null,dropdownMatchSelectWidth:!1,size:"small"},"default-presentation-state")),D=(0,I.jsx)(f.Z.SubMenu,{title:"Presentation States",children:(0,I.jsxs)(E.Z,{align:"center",size:20,style:{padding:"14px"},children:[(0,I.jsx)(k.Z,{style:{minWidth:200,maxWidth:200},onSelect:this.handlePresentationStateSelection,defaultValue:this.props.selectedPresentationStateUID,value:this.state.selectedPresentationStateUID,children:O},"presentation-states"),(0,I.jsx)(L.Z,{title:"Reset",children:(0,I.jsx)(N.Z,{icon:(0,I.jsx)(_.Z,{}),type:"primary",onClick:this.handlePresentationStateReset})})]})},"presentation-states")}if(n.length>0){var j={},M={},U=this.volumeViewer.getAllSegments();U.forEach((function(t){j[t.uid]=e.volumeViewer.getSegmentStyle(t.uid),M[t.uid]=e.volumeViewer.getSegmentMetadata(t.uid)})),x=(0,I.jsx)(f.Z.SubMenu,{title:"Segmentations",children:(0,I.jsx)(je,{segments:U,metadata:M,defaultSegmentStyles:j,visibleSegmentUIDs:this.state.visibleSegmentUIDs,onSegmentVisibilityChange:this.handleSegmentVisibilityChange,onSegmentStyleChange:this.handleSegmentStyleChange})},"segmentations"),s.push("segmentations")}if(i.length>0){var F={},z={};i.forEach((function(t){F[t.uid]=e.volumeViewer.getParameterMappingStyle(t.uid),z[t.uid]=e.volumeViewer.getParameterMappingMetadata(t.uid)})),Z=(0,I.jsx)(f.Z.SubMenu,{title:"Parametric Maps",children:(0,I.jsx)(Pe,{mappings:i,metadata:z,defaultMappingStyles:F,visibleMappingUIDs:this.state.visibleMappingUIDs,onMappingVisibilityChange:this.handleMappingVisibilityChange,onMappingStyleChange:this.handleMappingStyleChange})},"parmetric-maps"),s.push("parametric-maps")}if(a.length>0){var B={},W={},H=this.volumeViewer.getAllAnnotationGroups();H.forEach((function(t){B[t.uid]=e.volumeViewer.getAnnotationGroupStyle(t.uid),W[t.uid]=e.volumeViewer.getAnnotationGroupMetadata(t.uid)})),V=(0,I.jsx)(f.Z.SubMenu,{title:"Annotation Groups",children:(0,I.jsx)(ie,{annotationGroups:H,metadata:W,defaultAnnotationGroupStyles:B,visibleAnnotationGroupUIDs:this.state.visibleAnnotationGroupUIDs,onAnnotationGroupVisibilityChange:this.handleAnnotationGroupVisibilityChange,onAnnotationGroupStyleChange:this.handleAnnotationGroupStyleChange})},"annotation-groups"),s.push("annotationGroups")}var K="0px";this.props.enableAnnotationTools&&(P=(0,I.jsxs)(q.Z,{children:[(0,I.jsx)(ae,{tooltip:"Draw ROI [d]",icon:p.vuA,onClick:this.handleRoiDrawing,isSelected:this.state.isRoiDrawingActive}),(0,I.jsx)(ae,{tooltip:"Modify ROIs [m]",icon:p.eAi,onClick:this.handleRoiModification,isSelected:this.state.isRoiModificationActive}),(0,I.jsx)(ae,{tooltip:"Translate ROIs [t]",icon:p.Jd7,onClick:this.handleRoiTranslation,isSelected:this.state.isRoiTranslationActive}),(0,I.jsx)(ae,{tooltip:"Remove selected ROI [r]",onClick:this.handleRoiRemoval,icon:p.Xm5}),(0,I.jsx)(ae,{tooltip:"Show/Hide ROIs [v]",icon:this.state.areRoisHidden?p.dSq:p.tgn,onClick:this.handleRoiVisibilityChange,isSelected:this.state.areRoisHidden}),(0,I.jsx)(ae,{tooltip:"Save ROIs [s]",icon:p.TvB,onClick:this.handleReportGeneration})]}),K="50px");var X="none";return this.state.isLoading&&(X="block"),(0,I.jsxs)(h.Z,{style:{height:"100%"},hasSider:!0,children:[(0,I.jsxs)(h.Z.Content,{style:{height:"100%"},children:[P,(0,I.jsx)("div",{className:"dimmer",style:{display:X}}),(0,I.jsx)("div",{className:"spinner",style:{display:X}}),(0,I.jsx)("div",{style:{height:"calc(100% - ".concat(K,")"),overflow:"hidden"},ref:this.volumeViewportRef}),(0,I.jsx)(G.Z,{visible:this.state.isAnnotationModalVisible,title:"Configure annotations",onOk:this.handleAnnotationConfigurationCompletion,onCancel:this.handleAnnotationConfigurationCancellation,okText:"Select",children:(0,I.jsx)(E.Z,{align:"start",direction:"vertical",children:u})}),(0,I.jsx)(G.Z,{visible:this.state.isReportModalVisible,title:"Verify and save report",onOk:this.handleReportVerification,onCancel:this.handleReportCancellation,okText:"Save",children:o})]}),(0,I.jsx)(h.Z.Sider,{width:300,reverseArrow:!0,style:{borderLeft:"solid",borderLeftWidth:.25,overflow:"hidden",background:"none"},children:(0,I.jsxs)(f.Z,{mode:"inline",defaultOpenKeys:s,style:{height:"100%"},inlineIndent:14,forceSubMenuRender:!0,children:[(0,I.jsx)(f.Z.SubMenu,{title:"Slide label",children:(0,I.jsx)(f.Z.Item,{style:{height:"100%"},children:(0,I.jsx)("div",{style:{height:"220px"},ref:this.labelViewportRef})})},"label"),S,y,R,D,(0,I.jsx)(f.Z.SubMenu,{title:"Annotations",children:r},"annotations"),V,x,Z]})})]})}}]),n}(l.Component));var Le;!function(e){e.VOLUME="VOLUME",e.LABEL="LABEL",e.OVERVIEW="OVERVIEW",e.THUMBNAIL="THUMBNAIL"}(Le||(Le={}));var Ne=function(e,t){return e.ImageType[2]===t},qe=(0,a.Z)((function e(t){if((0,i.Z)(this,e),this.description=void 0,this.frameOfReferenceUID=void 0,this.containerIdentifier=void 0,this.seriesInstanceUIDs=void 0,this.opticalPathIdentifiers=void 0,this.areVolumeImagesMonochrome=void 0,this.volumeImages=void 0,this.labelImages=void 0,this.overviewImages=void 0,0===t.images.length)throw new Error('Value of option "images" have been non-zero length.');var n=new Set([]),a=new Set([]),o=new Set([]),r=new Set([]),s=[],l=[],c=[];if(t.images.forEach((function(e){r.add(e.FrameOfReferenceUID),o.add(e.ContainerIdentifier),n.add(e.SeriesInstanceUID),e.OpticalPathSequence.forEach((function(e){a.add(e.OpticalPathIdentifier)})),Ne(e,Le.VOLUME)||Ne(e,Le.THUMBNAIL)?s.push(e):Ne(e,Le.LABEL)?l.push(e):Ne(e,Le.OVERVIEW)&&c.push(e)})),0===s.length)throw new Error("At least one volume image must be provided for a slide.");var d=new Set([]);if(s.forEach((function(e){d.add(e.SamplesPerPixel)})),d.size>1)throw new Error("All volume images of a slide must have the same number of Samples per Pixel.");if(this.volumeImages=s,this.labelImages=l,this.overviewImages=c,this.seriesInstanceUIDs=(0,T.Z)(n),this.opticalPathIdentifiers=(0,T.Z)(a),1!==o.size)throw new Error("All images of a slide must have the same Container Identifier.");if(this.containerIdentifier=(0,T.Z)(o)[0],1!==r.size)throw new Error("All images of a slide must have the same Frame of Reference UID.");this.frameOfReferenceUID=(0,T.Z)(r)[0],this.areVolumeImagesMonochrome=1===this.volumeImages[0].SamplesPerPixel&&"MONOCHROME2"===this.volumeImages[0].PhotometricInterpretation,this.description=void 0!==t.description?t.description:""})),Ge=function(e){var t=[];e.forEach((function(e){if(e.length>0){var n=e.filter((function(e){return Ne(e,Le.VOLUME)||Ne(e,Le.THUMBNAIL)})),i=e.filter((function(e){return Ne(e,Le.LABEL)})),a=e.filter((function(e){return Ne(e,Le.OVERVIEW)}));if(n.length>0){var o=n[0],r=n.filter((function(e){return o.SamplesPerPixel===e.SamplesPerPixel})),s=a.filter((function(e){return o.SamplesPerPixel===e.SamplesPerPixel})),l=t.findIndex((function(e){return function(e,t){if(e.frameOfReferenceUID===t.FrameOfReferenceUID&&e.containerIdentifier===t.ContainerIdentifier)return!0;return!1}(e,o)}));if(-1===l){var c={frameOfReferenceUID:o.FrameOfReferenceUID,containerIdentifier:o.ContainerIdentifier,volumeImages:r,labelImages:i,overviewImages:s};t.push(c)}else{var d,u,h,p=t[l];(d=p.volumeImages).push.apply(d,(0,T.Z)(r)),(u=p.labelImages).push.apply(u,(0,T.Z)(i)),(h=p.overviewImages).push.apply(h,(0,T.Z)(s))}}}}));var n=t.map((function(e){return new qe({images:[].concat((0,T.Z)(e.volumeImages),(0,T.Z)(e.labelImages),(0,T.Z)(e.overviewImages))})}));return n=n.sort((function(e,t){var n=e.volumeImages[0],i=t.volumeImages[0];return null!=n.ContainerIdentifier&&null!=i.ContainerIdentifier?Number(n.ContainerIdentifier)-Number(i.ContainerIdentifier):0}))};function _e(e){var t=e.client,n=e.slides,i=e.user,a=e.app,o=e.preload,r=e.enableAnnotationTools,s=e.annotations,l=(0,d.UO)(),c=l.studyInstanceUID,u=l.seriesInstanceUID,h=(0,d.TH)(),p=n.find((function(e){return e.seriesInstanceUIDs.find((function(e){return e===u}))})),v=new URLSearchParams(h.search).get("state");null===v&&(v=void 0);var m=null;return null!=p&&(m=(0,I.jsx)(Ee,{client:t,studyInstanceUID:c,seriesInstanceUID:u,selectedPresentationStateUID:v,slide:p,preload:o,annotations:s,enableAnnotationTools:r,app:a,user:i})),m}const Fe=Ue(function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).state={slides:[],isLoading:!1},a.handleSeriesSelection=a.handleSeriesSelection.bind((0,o.Z)(a)),a}return(0,a.Z)(n,[{key:"componentDidMount",value:function(){var e=this;this.setState({isLoading:!0}),this.fetchImageMetadata().then((function(t){e.setState({slides:Ge(t),isLoading:!1})})).catch((function(t){u.ZP.error("An error occured. Image metadata could not be retrieved or decoded."),console.error(t),e.setState({isLoading:!1})}))}},{key:"fetchImageMetadata",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(){var t,n,i,a=this;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],n=this.props.studyInstanceUID,console.info('search for series of study "'.concat(n,'"...')),e.next=5,this.props.client.searchForSeries({queryParams:{Modality:"SM",StudyInstanceUID:n}});case 5:return i=e.sent,e.next=8,Promise.all(i.map(function(){var e=(0,m.Z)((0,v.Z)().mark((function e(n){var i,o,r,s,l;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=g.metadata.formatMetadata(n),o=i.dataset,r=o,console.info('retrieve metadata of series "'.concat(r.SeriesInstanceUID,'"')),e.next=5,a.props.client.retrieveSeriesMetadata({studyInstanceUID:a.props.studyInstanceUID,seriesInstanceUID:r.SeriesInstanceUID});case 5:s=e.sent,l=[],s.forEach((function(e,t){if(void 0!==e["00080016"]&&e["00080016"].Value[0]===Me.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE){var n=new g.metadata.VLWholeSlideMicroscopyImage({metadata:e});l.push(n)}})),l.length>0&&t.push(l);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 8:return e.abrupt("return",t);case 9:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"handleSeriesSelection",value:function(e){var t=e.seriesInstanceUID;console.info('switch to series "'.concat(t,'"'));var n="/studies/".concat(this.props.studyInstanceUID)+"/series/".concat(t);this.props.location.pathname.includes("/series/")&&null!=this.props.location.search&&(n+=this.props.location.search),this.props.navigate(n,{replace:!0})}},{key:"render",value:function(){if(0===this.state.slides.length)return null;var e=this.state.slides[0].volumeImages;if(0===e.length)return null;var t,n,i=e[0];this.props.location.pathname.includes("series/")?t=this.props.location.pathname.split("/")[4]:t=e[0].SeriesInstanceUID;return null!=i.ClinicalTrialSponsorName&&(n=(0,I.jsx)(f.Z.SubMenu,{title:"Clinical Trial",children:(0,I.jsx)(D,{metadata:i})},"clinical-trial")),(0,I.jsxs)(h.Z,{style:{height:"100%"},hasSider:!0,children:[(0,I.jsx)(h.Z.Sider,{width:300,style:{height:"100%",borderRight:"solid",borderRightWidth:.25,overflow:"hidden",background:"none"},children:(0,I.jsxs)(f.Z,{mode:"inline",defaultOpenKeys:["patient","study","clinical-trial","slides"],style:{height:"100%"},inlineIndent:14,children:[(0,I.jsx)(f.Z.SubMenu,{title:"Patient",children:(0,I.jsx)(R,{metadata:i})},"patient"),(0,I.jsx)(f.Z.SubMenu,{title:"Study",children:(0,I.jsx)(O,{metadata:i})},"study"),n,(0,I.jsx)(f.Z.SubMenu,{title:"Slides",children:(0,I.jsx)(U,{client:this.props.client,metadata:this.state.slides,selectedSeriesInstanceUID:t,onSeriesSelection:this.handleSeriesSelection})},"slides")]})}),(0,I.jsx)(d.Z5,{children:(0,I.jsx)(d.AW,{path:"/series/:seriesInstanceUID",element:(0,I.jsx)(_e,{client:this.props.client,slides:this.state.slides,preload:this.props.preload,annotations:this.props.annotations,enableAnnotationTools:this.props.enableAnnotationTools,app:this.props.app,user:this.props.user})})})]})}}]),n}(l.Component));var ze=n(7382),Be=n(1272),We=n(9529),He=n(127),Ye=n(4541),Ke=n(161),Xe=n(1515),Qe=n(7575),Je=n(9761);const $e=Ue(function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).handleInfoButtonClick=function(){var e=(0,Je.qY)(),t={browser:{},os:{}};null!=e&&(t.browser={name:null!=e.name?e.name:void 0,version:null!=e.version?e.version:void 0},t.os={name:null!=e.os?e.os:void 0}),G.Z.info({title:"About",width:600,content:(0,I.jsxs)(I.Fragment,{children:[(0,I.jsxs)(y.Z,{title:"Application",column:1,children:[(0,I.jsx)(y.Z.Item,{label:"Name",children:a.props.app.name}),(0,I.jsx)(y.Z.Item,{label:"Version",children:a.props.app.version}),(0,I.jsx)(y.Z.Item,{label:"Homepage",children:a.props.app.homepage})]}),(0,I.jsxs)(y.Z,{title:"Browser",column:1,children:[(0,I.jsx)(y.Z.Item,{label:"Name",children:t.browser.name}),(0,I.jsx)(y.Z.Item,{label:"Version",children:t.browser.version})]}),(0,I.jsx)(y.Z,{title:"Operating System",column:1,children:(0,I.jsx)(y.Z.Item,{label:"Name",children:t.os.name})})]}),onOk:function(){}})},a.handleServerSelectionButtonClick=function(){a.setState({isServerSelectionModalVisible:!0})},a.state={isServerSelectionModalVisible:!1,isServerSelectionDisabled:!0},a}return(0,a.Z)(n,[{key:"render",value:function(){var e,t=this,n=null;if(void 0!==this.props.user){var i=[];void 0!==this.props.onUserLogout&&i.push({label:"Logout",key:"user-logout",onClick:function(){void 0!==t.props.onUserLogout&&t.props.onUserLogout()}});var a=(0,I.jsx)(f.Z,{items:i});n=(0,I.jsx)(ze.Z,{overlay:a,trigger:["click"],children:(0,I.jsx)(ae,{icon:We.Z,onClick:function(e){return e.preventDefault()},label:"".concat(this.props.user.name," (").concat(this.props.user.email,")")})})}this.props.showWorklistButton&&(e=(0,I.jsx)(c.OL,{to:"/",children:(0,I.jsx)(ae,{icon:He.Z,tooltip:"Go to worklist"})}));var o,r=(0,I.jsx)(ae,{icon:Ye.Z,tooltip:"Get app info",onClick:this.handleInfoButtonClick});this.props.showServerSelectionButton&&(o=(0,I.jsx)(ae,{icon:Ke.Z,tooltip:"Select server",onClick:this.handleServerSelectionButtonClick}));var s=function(e){var n=t.state.selectedServerUrl,i=!1;null!=n&&""!==n&&(n.startsWith("http://")||n.startsWith("https://"))&&(t.props.onServerSelection({url:n}),i=!0),t.setState({selectedServerUrl:void 0,isServerSelectionModalVisible:!i,isServerSelectionDisabled:!0})};return(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(h.Z.Header,{style:{width:"100%",padding:"0 14px"},children:(0,I.jsxs)(q.Z,{children:[(0,I.jsx)(K.Z,{children:(0,I.jsx)(E.Z,{align:"center",direction:"horizontal",children:(0,I.jsx)("img",{src:"https://herrmannlab.github.io/slim/logo.svg",alt:"",style:{height:"64px",margin:"-14px"}})})}),(0,I.jsx)(K.Z,{flex:"auto"}),(0,I.jsx)(K.Z,{children:(0,I.jsxs)(E.Z,{direction:"horizontal",children:[e,r,o,n]})})]})}),(0,I.jsx)(G.Z,{visible:this.state.isServerSelectionModalVisible,title:"Select DICOMweb server",onOk:s,onCancel:function(e){t.setState({selectedServerUrl:void 0,isServerSelectionModalVisible:!1,isServerSelectionDisabled:!0})},children:(0,I.jsx)(Be.Z,{placeholder:"Enter base URL of DICOMweb Study Service",onChange:function(e){var n=e.target.value,i=!0;if(null!=n)try{var a=new URL(n);a.protocol.startsWith("http")&&a.pathname.length>0&&(i=!1)}catch(o){}t.setState({selectedServerUrl:n,isServerSelectionDisabled:i})},onPressEnter:s,addonAfter:this.state.isServerSelectionDisabled?(0,I.jsx)(Xe.Z,{style:{color:"rgba(0,0,0,.45)"}}):(0,I.jsx)(Qe.Z,{style:{color:"rgba(0,0,0,.45)"}})})})]})}}]),n}(l.Component));var et=n(7063);const tt=function(e){var t=e.title,n=e.message;return(0,I.jsx)("div",{style:{height:"100vh",display:"flex",alignItems:"center",justifyContent:"center"},children:(0,I.jsx)(et.ZP,{title:t,subTitle:n})})};var nt=n(6867),it=n(1730);const at=Ue(function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).defaultPageSize=20,a.handleSearch=function(e,t,n){t()},a.handleReset=function(e){e()},a.getColumnSearchProps=function(e){return{filterDropdown:function(t){var n=t.setSelectedKeys,i=t.selectedKeys,o=t.confirm,r=t.clearFilters;return(0,I.jsxs)("div",{style:{padding:8},children:[(0,I.jsx)(Be.Z,{placeholder:"Search",value:i[0],onChange:function(e){return n(void 0!==e.target.value?[e.target.value]:[])},onPressEnter:function(){return a.handleSearch(i,o,e)},style:{width:188,marginBottom:8,display:"block"}}),(0,I.jsxs)(E.Z,{children:[(0,I.jsx)(N.Z,{type:"primary",onClick:function(){return a.handleSearch(i,o,e)},icon:(0,I.jsx)(it.Z,{}),size:"small",style:{width:90},children:"Search"}),(0,I.jsx)(N.Z,{onClick:function(){return a.handleReset(r)},size:"small",style:{width:90},children:"Reset"})]})]})},filterIcon:function(e){return(0,I.jsx)(it.Z,{style:{color:e?"#1890ff":void 0}})}}},a.fetchData=a.fetchData.bind((0,o.Z)(a)),a.handleClick=a.handleClick.bind((0,o.Z)(a)),a.handleChange=a.handleChange.bind((0,o.Z)(a)),a.state={studies:[],isLoading:!1,numStudies:0,pageSize:a.defaultPageSize},a}return(0,a.Z)(n,[{key:"searchForStudies",value:function(){var e=this,t={queryParams:{ModalitiesInStudy:"SM"}};this.props.client.searchForStudies(t).then((function(t){e.setState({numStudies:t.length,studies:t.slice(0,e.state.pageSize).map((function(e){return g.metadata.formatMetadata(e).dataset}))})})).catch((function(e){u.ZP.error("An error occured. Search for studies failed."),console.error(e)}))}},{key:"componentDidMount",value:function(){this.searchForStudies()}},{key:"componentDidUpdate",value:function(e){this.props.client!==e.client&&this.searchForStudies()}},{key:"handleClick",value:function(e,t){this.props.navigate("/studies/".concat(t.StudyInstanceUID))}},{key:"fetchData",value:function(e){var t=this,n=e.offset,i=e.limit,a=e.searchCriteria,o={ModalitiesInStudy:"SM",offset:n,limit:i};if(void 0!==a){for(var r in a){var s=a[r];o[r]="PersonName"===r?"*".concat(s,"*"):s}o.fuzzymatching="true"}var l={queryParams:o};this.props.client.searchForStudies(l).then((function(e){t.setState({studies:e.map((function(e){return g.metadata.formatMetadata(e).dataset}))})})).catch((function(){return u.ZP.error("Request to search for studies failed.")}))}},{key:"handleChange",value:function(e,t){this.setState({isLoading:!0});var n=e.current;void 0===n&&(n=1);var i=e.pageSize;void 0===i&&(i=this.state.pageSize);var a=i*(n-1),o=i;console.debug("search for studies of page #".concat(n,"..."));var r={};for(var s in t)null!==t[s]&&(r[s]=t[s][0].toString());this.fetchData({offset:a,limit:o,searchCriteria:r}),this.setState({isLoading:!1,pageSize:i})}},{key:"render",value:function(){var e=this,t=[(0,j.Z)({title:"Accession Number",dataIndex:"AccessionNumber"},this.getColumnSearchProps("AccessionNumber")),(0,j.Z)({title:"Study ID",dataIndex:"StudyID"},this.getColumnSearchProps("StudyID")),{title:"Study Date",dataIndex:"StudyDate",render:function(e){return Z(e)}},{title:"Study Time",dataIndex:"StudyTime",render:function(e){return V(e)}},(0,j.Z)({title:"Patient ID",dataIndex:"PatientID"},this.getColumnSearchProps("PatientID")),(0,j.Z)({title:"Patient's Name",dataIndex:"PatientName",render:function(e){return x(e)}},this.getColumnSearchProps("PatientName")),{title:"Patient's Sex",dataIndex:"PatientSex",render:function(e){return P(e)}},{title:"Patient's Birthdate",dataIndex:"PatientBirthDate",render:function(e){return Z(e)}},{title:"Referring Physician's Name",dataIndex:"ReferringPhysicianName",render:function(e){return x(e)}},{title:"Modalities in Study",dataIndex:"ModalitiesInStudy",render:function(e){return void 0===e?"":String(e)}}],n={defaultPageSize:this.defaultPageSize,pageSize:this.state.pageSize,hideOnSinglePage:!0,showSizeChanger:!0,showQuickJumper:!0,showTotal:function(e,t){return"".concat(t[0],"-").concat(t[1]," of ").concat(e," studies")},total:this.state.numStudies};return(0,I.jsx)(nt.Z,{style:{cursor:"pointer"},columns:t,rowKey:function(e){return e.StudyInstanceUID},dataSource:this.state.studies,pagination:n,onRow:function(t){return{onClick:function(n){return e.handleClick(n,t)}}},onChange:this.handleChange,size:"small",loading:this.state.isLoading})}}]),n}(l.Component));var ot=function(e,t){var n=t;return n.endsWith("/")||(n+="/"),new URL(e,n).toString()},rt=function(e){var t,n,i,a,o,r=new URLSearchParams(e.search),s=new URLSearchParams(e.hash.replace("#","?"));return Boolean(null!==(t=null!==(n=null!==(i=null!==(a=null!==(o=r.get("code"))&&void 0!==o?o:r.get("id_token"))&&void 0!==a?a:r.get("session_state"))&&void 0!==i?i:s.get("code"))&&void 0!==n?n:s.get("id_token"))&&void 0!==t?t:s.get("session_state"))},st=n(5685),lt=function(e){var t=e.profile;if(void 0!==t){if(void 0===t.name||void 0===t.email)throw Error('Failed to obtain user "name" and "email".');return{name:t.name,email:t.email}}throw Error("Failed to obtain user profile.")},ct=(0,a.Z)((function e(t,n){var a=this;(0,i.Z)(this,e),this._oidc=void 0,this.signIn=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){var n,i,o,r;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.onSignIn,i=function(e){var t=lt(e),i="".concat(e.token_type," ").concat(e.access_token);null!=n?(console.info("handling sign-in using provided callback function"),n({user:t,authorization:i})):console.warn("no callback function was provided to handle sign-in")},!rt(window.location)){e.next=10;break}return console.info("obtaining authorization"),e.next=6,a._oidc.signinCallback();case 6:null!=(o=e.sent)&&(console.info("obtained user data: ",o),i(o)),e.next=21;break;case 10:return e.next=12,a._oidc.getUser();case 12:if(null!==(r=e.sent)&&!r.expired){e.next=19;break}return console.info("authenticating user"),e.next=17,a._oidc.signinRedirect();case 17:e.next=21;break;case 19:console.info("user has already been authenticated"),i(r);case 21:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.signOut=(0,m.Z)((0,v.Z)().mark((function e(){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("signing out user and revoking authorization"),e.next=3,a._oidc.signoutRedirect();case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e)}))),this.getAuthorization=(0,m.Z)((0,v.Z)().mark((function e(){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a._oidc.getUser().then((function(e){if(null!==e)return e.access_token;throw Error("Failed to obtain access token.")}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))),this.getUser=(0,m.Z)((0,v.Z)().mark((function e(){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a._oidc.getUser().then((function(e){if(null===e)throw Error("Failed to obtain user information.");return lt(e)}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));var o="code";void 0!==n.grantType&&"implicit"===n.grantType&&(o="id_token token"),this._oidc=new st.UserManager({authority:n.authority,client_id:n.clientId,redirect_uri:t,scope:n.scope,response_type:o,loadUserInfo:!0,automaticSilentRenew:!0,revokeAccessTokenOnSignout:!0,post_logout_redirect_uri:"".concat(t,"/logout")}),null!=n.endSessionEndpoint&&this._oidc.metadataService.getMetadata().then((function(e){null!=n.endSessionEndpoint&&(e.end_session_endpoint=n.endSessionEndpoint,a._oidc=new st.UserManager({authority:n.authority,client_id:n.clientId,redirect_uri:t,scope:n.scope,response_type:o,loadUserInfo:!0,automaticSilentRenew:!0,revokeAccessTokenOnSignout:!0,post_logout_redirect_uri:"".concat(t,"/logout"),metadata:e}))})).catch((function(e){console.error("failed to get metadata from authorization server: ",e)}))})),dt=n(7659),ut=n(9158);const ht=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{retries:5,factor:3,minTimeout:1e3,maxTimeout:6e4,randomize:!0,retryableStatusCodes:[429,500]},t=e;null!=e.retries&&(t.retries=e.retries),null!=e.factor&&(t.factor=e.factor),null!=e.minTimeout&&(t.minTimeout=e.minTimeout),null!=e.maxTimeout&&(t.maxTimeout=e.maxTimeout),null!=e.randomize&&(t.randomize=e.randomize),null!=e.retryableStatusCodes&&(t.retryableStatusCodes=e.retryableStatusCodes);var n=function(e,n){var i=n.url,a=n.method;var o=e.send;return e.send=function(){var n=ut.operation(t);n.attempt((function(o){var r=e.onreadystatechange;e.onreadystatechange=function(){if(null!=r){for(var a=arguments.length,o=new Array(a),s=0;s<a;s++)o[s]=arguments[s];r.apply(e,o)}if(t.retryableStatusCodes.includes(e.status)){var l="Attempt to request ".concat(i," failed."),c=new Error(l);n.retry(c)}},o>1&&(console.warn("Requesting ".concat(i,"... (attempt: ").concat(o,")")),e.open(a,i,!0))}));for(var r=arguments.length,s=new Array(r),l=0;l<r;l++)s[l]=arguments[l];o.apply(e,s)},e};return n};var pt=function(){function e(t){var n=this,a=t.baseUri,o=t.settings,r=t.onError;if((0,i.Z)(this,e),this.stores=[],this.handleError=void 0,this.updateHeaders=function(e){for(var t in e)n.stores[0].client.headers[t]=e[t]},this.storeInstances=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.stores[0].write){e.next=6;break}return e.next=3,n.stores[0].client.storeInstances(t);case 3:case 8:return e.abrupt("return",e.sent);case 6:return e.next=8,Promise.reject(new Error("Store is not writable."));case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.searchForStudies=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.searchForStudies(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.searchForSeries=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.searchForSeries(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.searchForInstances=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.searchForInstances(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveStudyMetadata=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveStudyMetadata(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveSeriesMetadata=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveSeriesMetadata(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveInstanceMetadata=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveInstanceMetadata(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveInstance=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveInstance(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveInstanceFrames=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveInstanceFrames(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveInstanceRendered=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveInstanceRendered(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveInstanceFramesRendered=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveInstanceFramesRendered(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveBulkData=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveBulkData(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.handleError=null!=r?r:function(e,t){console.error(e,t)},o.forEach((function(e){var t,i,o;if(void 0===e)throw Error("At least one server needs to be configured.");if(void 0!==e.url)o=e.url;else{if(void 0===e.path)throw new Error("Either path or full URL needs to be configured for server.");o=ot(e.path,a)}var r={url:o};void 0!==e.qidoPathPrefix&&(r.qidoURLPrefix=e.qidoPathPrefix),void 0!==e.wadoPathPrefix&&(r.wadoURLPrefix=e.wadoPathPrefix),void 0!==e.stowPathPrefix&&(r.stowURLPrefix=e.stowPathPrefix),void 0!==e.retry&&(r.requestHooks=[ht(e.retry)]),r.errorInterceptor=function(t){n.handleError(t,e)},n.stores.push({id:e.id,write:null!==(t=e.write)&&void 0!==t&&t,read:null===(i=e.read)||void 0===i||i,client:new dt.hi.DICOMwebClient(r)})})),this.stores.length>1)throw new Error("Only one store is supported for now.")}return(0,a.Z)(e,[{key:"baseURL",get:function(){return this.stores[0].client.baseURL}},{key:"headers",get:function(){return this.stores[0].client.headers}}]),e}();function vt(e){var t,n,i=e.client,a=e.user,o=e.app,r=e.config,s=(0,d.UO)().studyInstanceUID,l=!(null!==(t=r.disableAnnotationTools)&&void 0!==t&&t),c=null!==(n=r.preload)&&void 0!==n&&n;return(0,I.jsx)(Fe,{client:i,user:a,annotations:r.annotations,preload:c,app:o,enableAnnotationTools:l,studyInstanceUID:s})}const mt=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;(0,i.Z)(this,n),(a=t.call(this,e)).auth=void 0,a.handleDICOMwebError=function(e,t){401===e.status&&a.signIn(),void 0!==t.errorMessages&&t.errorMessages.forEach((function(t){var n=t.status,i=t.message;e.status===n&&a.setState({error:{status:e.status,message:i}})}))},a.handleSignIn=function(e){var t=e.user,n=e.authorization;console.info('handle sign in of user "'.concat(t.name,'" and ')+'update authorization token "'.concat(n,'"'));var i=a.state.client;i.updateHeaders({Authorization:n});var o=window.location.pathname+window.location.search,r=a.props.config.path,s=o.substring(r.length);"/"!==r&&""!==r||(s=o),a.setState({user:t,client:i,wasAuthSuccessful:!0,isLoading:!1,redirectTo:s})},console.info("instatiate app"),console.info('app is located at "'.concat(e.config.path,'"'));var r=window.location,s=r.protocol,l=r.host,c="".concat(s,"//").concat(l),d=ot(e.config.path,c),h=e.config.oidc;if(void 0!==h&&(console.info("app uses the following OIDC configuration: ",e.config.oidc),a.auth=new ct(d,h)),0===e.config.servers.length)throw Error("One server needs to be configured.");return console.info("app uses the following DICOMweb server configuration: ",e.config.servers),a.handleServerSelection=a.handleServerSelection.bind((0,o.Z)(a)),u.ZP.config({duration:5}),a.state={client:new pt({baseUri:c,settings:e.config.servers,onError:a.handleDICOMwebError}),isLoading:!0,wasAuthSuccessful:!1},a}return(0,a.Z)(n,[{key:"handleServerSelection",value:function(e){var t=e.url;console.info("select DICOMweb server: ",t);var n=new pt({baseUri:"",settings:[{id:"tmp",url:t,read:!0,write:!1}],onError:this.handleDICOMwebError});n.updateHeaders(this.state.client.headers),this.setState({client:n})}},{key:"signIn",value:function(){var e=this;void 0!==this.auth?(console.info("try to sign in user"),this.auth.signIn({onSignIn:this.handleSignIn}).then((function(){console.info("sign-in was successful"),e.setState({isLoading:!1,redirectTo:void 0,wasAuthSuccessful:!0})})).catch((function(t){console.error("sign-in failed ",t),u.ZP.error("Could not sign-in user."),e.setState({isLoading:!1,redirectTo:void 0,wasAuthSuccessful:!1})}))):this.setState({isLoading:!1,redirectTo:void 0,wasAuthSuccessful:!0})}},{key:"componentDidMount",value:function(){this.signIn()}},{key:"render",value:function(){var e,t,n,i=this,a={name:this.props.name,version:this.props.version,homepage:this.props.homepage,uid:"1.2.826.0.1.3680043.9.7433.1.5",organization:this.props.config.organization},o=!(null!==(e=this.props.config.disableWorklist)&&void 0!==e&&e),r=null!==(t=this.props.config.enableServerSelection)&&void 0!==t&&t;n=o?(0,I.jsx)(at,{client:this.state.client}):(0,I.jsx)("div",{children:"Worklist has been disabled."});var s,l=!1;null!=this.props.config.oidc&&null!=this.props.config.oidc.endSessionEndpoint?(s=function(){null!=i.auth&&i.auth.signOut()},l=!0):(s=function(){},l=!1);var u={height:"100vh"},v={height:"100%"};return void 0!==this.state.redirectTo?(0,I.jsx)(c.VK,{basename:this.props.config.path,children:(0,I.jsx)(d.Fg,{to:this.state.redirectTo,replace:!0})}):this.state.isLoading?(0,I.jsx)(c.VK,{basename:this.props.config.path,children:(0,I.jsxs)(h.Z,{style:u,children:[(0,I.jsx)($e,{app:a,user:this.state.user,showWorklistButton:!1,onServerSelection:this.handleServerSelection,showServerSelectionButton:!1}),(0,I.jsx)(h.Z.Content,{style:v,children:(0,I.jsx)(p.fCD,{})})]})}):this.state.wasAuthSuccessful?null!=this.state.error?(0,I.jsx)(tt,{type:"error",message:this.state.error.message}):(0,I.jsx)(c.VK,{basename:this.props.config.path,children:(0,I.jsxs)(d.Z5,{children:[(0,I.jsx)(d.AW,{path:"/studies/:studyInstanceUID/*",element:(0,I.jsxs)(h.Z,{style:u,children:[(0,I.jsx)($e,{app:a,user:this.state.user,showWorklistButton:o,onServerSelection:this.handleServerSelection,onUserLogout:l?s:void 0,showServerSelectionButton:r}),(0,I.jsx)(h.Z.Content,{style:v,children:(0,I.jsx)(vt,{client:this.state.client,user:this.state.user,config:this.props.config,app:a})})]})}),(0,I.jsx)(d.AW,{path:"/logout",element:(0,I.jsxs)(h.Z,{style:u,children:[(0,I.jsx)($e,{app:a,user:this.state.user,showWorklistButton:!1,onServerSelection:this.handleServerSelection,onUserLogout:l?s:void 0,showServerSelectionButton:r}),"Logged out"]})}),(0,I.jsx)(d.AW,{path:"/",element:(0,I.jsxs)(h.Z,{style:u,children:[(0,I.jsx)($e,{app:a,user:this.state.user,showWorklistButton:!1,onServerSelection:this.handleServerSelection,onUserLogout:l?s:void 0,showServerSelectionButton:r}),(0,I.jsx)(h.Z.Content,{style:v,children:n})]})})]})}):(0,I.jsx)(tt,{type:"error",message:"Sign-in failed."})}}]),n}(l.Component)}}]);
//# sourceMappingURL=884.93c35360.chunk.js.map