"use strict";(self.webpackChunkslim=self.webpackChunkslim||[]).push([[499],{6499:(e,t,n)=>{n.d(t,{Z:()=>Un});var i=n(5671),a=n(3144),o=n(7326),r=n(136),s=n(7277),l=n(2791),c=n(7689),d=n(1087),u=n(3695),h=n(586),p=n(9135),v=n(4165),f=n(5861),m=n(9439),g=n(6014),S=n(8954),y=n(4261),C=n(394),I=n(4970),b=n(184),w=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e="horizontal",t="14px";void 0!==this.props.hasLongValues&&this.props.hasLongValues&&(e="vertical",t="20px");var n=this.props.attributes.map((function(e,n){var i=(0,y.Z)();return(0,b.jsx)(C.Z.Item,{label:e.name,labelStyle:{lineHeight:t},contentStyle:{fontWeight:600,whiteSpace:"pre-line",lineHeight:"14px"},span:1,children:e.value},i)})),i=null;return void 0!==this.props.icon&&(i=(0,b.jsx)(this.props.icon,{})),(0,b.jsxs)(I.Z,{title:this.props.header,extra:i,size:"small",hoverable:this.props.selectable,bordered:void 0!==this.props.header,actions:this.props.methods,children:[(0,b.jsx)(C.Z,{column:1,size:"small",layout:e,bordered:!1,children:n}),this.props.children]})}}]),n}(l.Component);const x=w;const D=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e=[];return null!=this.props.metadata.ClinicalTrialSponsorName&&e.push.apply(e,[{name:"Sponsor Name",value:this.props.metadata.ClinicalTrialSponsorName},{name:"Protocol ID",value:this.props.metadata.ClinicalTrialProtocolID},{name:"Protocol Name",value:this.props.metadata.ClinicalTrialProtocolName},{name:"Site Name",value:this.props.metadata.ClinicalTrialSiteName}]),null!=this.props.metadata.ClinicalTrialTimePointID&&e.push({name:"Time Point ID",value:this.props.metadata.ClinicalTrialTimePointID}),(0,b.jsx)(x,{attributes:e})}}]),n}(l.Component);function Z(e){return"object"===typeof e&&null!==e&&void 0!==e&&void 0!==e.Alphabetic?e.Alphabetic.split("^").join(" "):""}function V(e){if(null!==e&&void 0!==e){var t=e.substring(0,4),n=e.substring(4,6),i=e.substring(6,8);return"".concat(t,"-").concat(n,"-").concat(i)}return""}function O(e){if(null!==e&&void 0!==e){var t=e.substring(0,2),n=e.substring(2,4),i=e.substring(4,6);return"".concat(t,":").concat(n,":").concat(i)}return""}function R(e){return null!==e&&void 0!==e?{F:"Female",M:"Male",O:"Other"}[e]:""}const j=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e=[{name:"ID",value:this.props.metadata.PatientID},{name:"Name",value:Z(this.props.metadata.PatientName)},{name:"Sex",value:R(this.props.metadata.PatientSex)},{name:"Birthdate",value:V(this.props.metadata.PatientBirthDate)}];return(0,b.jsx)(x,{attributes:e})}}]),n}(l.Component);const P=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e=[{name:"Accession #",value:this.props.metadata.AccessionNumber},{name:"ID",value:this.props.metadata.StudyID},{name:"Date",value:V(this.props.metadata.StudyDate)},{name:"Time",value:O(this.props.metadata.StudyTime)}];return(0,b.jsx)(x,{attributes:e})}}]),n}(l.Component);var M,E=n(1413),U=n(6658);!function(e){e.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE="1.2.840.10008.5.1.4.1.1.77.1.6",e.COMPREHENSIVE_SR="1.2.840.10008.5.1.4.1.1.88.33",e.COMPREHENSIVE_3D_SR="1.2.840.10008.5.1.4.1.1.88.34",e.SEGMENTATION="1.2.840.10008.5.1.4.1.1.66.4",e.MICROSCOPY_BULK_SIMPLE_ANNOTATION="1.2.840.10008.5.1.4.1.1.91.1",e.PARAMETRIC_MAP="1.2.840.10008.5.1.4.1.1.30",e.ADVANCED_BLENDING_PRESENTATION_STATE="1.2.840.10008.5.1.4.1.1.11.8",e.COLOR_SOFTCOPY_PRESENTATION_STATE="1.2.840.10008.5.1.4.1.1.11.2",e.GRAYSCALE_SOFTCOPY_PRESENTATION_STATE="1.2.840.10008.5.1.4.1.1.11.1",e.PSEUDOCOLOR_SOFTCOPY_PRESENTATION_STATE="1.2.840.10008.5.1.4.1.1.11.3"}(M||(M={}));var A=Symbol("subscriptions"),T=Symbol("lastSubscriptionId"),k=function(){function e(){(0,i.Z)(this,e),this[A]={},this[T]=0}return(0,a.Z)(e,[{key:"subscribe",value:function(e,t){if(void 0===e)throw new Error("Trying to subscribe to an inexistent event");if("function"!==typeof t)throw new Error("The provided callback must be a function");this[A].hasOwnProperty(e)||(this[A][e]={});var n="sub".concat(this[T]++);this[A][e][n]=t}},{key:"unsubscribe",value:function(e,t){var n=this[A][e]||{};for(var i in n)t?n[i]===t&&delete n[i]:delete n[i]}},{key:"publish",value:function(e){if(void 0===e)throw new Error("Trying to publish an inexistent event");for(var t=this[A][e]||{},n=arguments.length,i=new Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];for(var o in t)t[o].apply(t,i)}},{key:"unsubscribeFromAll",value:function(){for(var e in this[A]){var t=this[A][e];for(var n in t)delete t[n]}}}]),e}(),L=n(3085),_=n(8737),N="Authentication",G="Communication",q="EncodingDecoding",F="Visualization",z=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e,a){var o;return(0,i.Z)(this,n),(o=t.call(this)).message=a,o.stack=(new Error).stack,o.type=e,o}return(0,a.Z)(n)}((0,_.Z)(Error)),B="onError",W="onWarning",Y="dicomweb-client",H="dicom-microscopy-viewer",X="dcmjs",K="slim",Q="authentication",J="toast",$="console",ee={sources:[{category:N,notificationType:J},{category:G,notificationType:J},{category:F,notificationType:J},{category:q,notificationType:$},{category:"Warning",notificationType:J}]};const te=new(function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;(0,i.Z)(this,n),e=t.call(this);var a=function(t){e.publish(W,Array.from(t).join(" "))};return function(){var e=console.warn;console.warn=function(){JSON.stringify(arguments).includes("request")||a(arguments),e.apply(this,Array.prototype.slice.call(arguments))}}(),e}return(0,a.Z)(n,[{key:"onError",value:function(e,t){var n,i=t.type,a=ee.sources.find((function(e){return e.category===i})).notificationType;switch(this.publish(B,{source:e,error:t}),n=t instanceof z?t.message:String(t),a){case J:return console.error("A ".concat(i," error occurred: "),t),L.Z.error({message:"".concat(i," error"),description:n,duration:3});case $:console.error("A ".concat(i," error occurred: "),t)}}}]),n}(k));const ne=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).state={isLoading:!1},a.overviewViewportRef=l.createRef(),a.overviewViewer=void 0,a.overviewViewer=void 0,a}return(0,a.Z)(n,[{key:"componentDidMount",value:function(){if(this.setState({isLoading:!0}),this.props.slide.overviewImages.length>0){var e=this.props.slide.overviewImages[0];null!==this.overviewViewportRef.current&&(this.overviewViewportRef.current.innerHTML="",console.info("instantiate viewer for OVERVIEW image of slide "+'"'.concat(e.ContainerIdentifier,'"')),this.overviewViewer=new U.viewer.OverviewImageViewer({client:this.props.clients[M.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE],disableInteractions:!0,metadata:e,resizeFactor:1,errorInterceptor:function(e){te.onError(H,e)}}),this.overviewViewer.render({container:this.overviewViewportRef.current}))}this.setState({isLoading:!1})}},{key:"render",value:function(){void 0!==this.overviewViewer&&this.overviewViewer.resize();var e=[],t=this.props.slide.description;return null!==t&&""!==t&&e.push({name:"Description",value:t}),this.state.isLoading?(0,b.jsx)(p.fCD,{}):(0,b.jsx)(g.Z.Item,(0,E.Z)((0,E.Z)({style:{height:"100%"}},this.props),{},{children:(0,b.jsx)(x,{header:this.props.slide.containerIdentifier,attributes:e,selectable:!0,children:this.props.slide.overviewImages.length>0?(0,b.jsx)("div",{style:{height:"100px"},ref:this.overviewViewportRef}):(0,b.jsx)("div",{style:{height:"100px",textAlign:"center",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"1.5rem",fontWeight:300,color:"#8F9BA8",letterSpacing:"0.1em"},children:"SM"})})}),this.props.slide.seriesInstanceUIDs[0])}}]),n}(l.Component);const ie=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;(0,i.Z)(this,n);for(var a=arguments.length,o=new Array(a),r=0;r<a;r++)o[r]=arguments[r];return(e=t.call.apply(t,[this].concat(o))).state={selectedSeriesInstanceUID:e.props.selectedSeriesInstanceUID},e}return(0,a.Z)(n,[{key:"componentDidMount",value:function(){this.props.onSeriesSelection({seriesInstanceUID:this.state.selectedSeriesInstanceUID})}},{key:"render",value:function(){for(var e=this,t=this.props.metadata,n=[],i=0;i<t.length;++i){var a=t[i],o=(0,b.jsx)(ne,{slide:a,clients:this.props.clients},a.seriesInstanceUIDs[0]);n.push(o)}var r;return void 0!==this.state.selectedSeriesInstanceUID&&null!==this.state.selectedSeriesInstanceUID&&(r=[this.state.selectedSeriesInstanceUID]),(0,b.jsx)(g.Z,{style:{width:"100%"},selectedKeys:r,onSelect:function(t){var n=t.key;t.keyPath,t.domEvent,t.selectedKeys;console.info('select slide "'.concat(n,'"')),e.setState({selectedSeriesInstanceUID:n.toString()}),e.props.onSeriesSelection({seriesInstanceUID:n.toString()})},mode:"inline",inlineIndent:0,children:n})}}]),n}(l.Component);var ae=n(3433),oe=n(3734),re=n(2014),se=n(3099),le=n(5945),ce=n(7309),de=n(6106),ue=n(1333),he=n(6784),pe=n(3344),ve=n(8030),fe=n(7575),me=n(1515),ge=n(5581),Se=n(4925),ye=["isVisible","onVisibilityChange"];const Ce=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).handleVisibilityChange=a.handleVisibilityChange.bind((0,o.Z)(a)),a}return(0,a.Z)(n,[{key:"handleVisibilityChange",value:function(e,t){this.props.onVisibilityChange({roiUID:this.props.roi.uid,isVisible:e})}},{key:"render",value:function(){var e="ROI ".concat(this.props.index+1),t=[],n=this.props,i=(n.isVisible,n.onVisibilityChange,(0,Se.Z)(n,ye));return this.props.roi.evaluations.forEach((function(e){var n=e.ConceptNameCodeSequence[0].CodeValue,i=e.ConceptNameCodeSequence[0].CodeMeaning,a="".concat(i);if(e.ValueType===S.sr.valueTypes.ValueTypes.CODE){var o=e.ConceptCodeSequence[0].CodeMeaning;"276214006"===n?t.push({name:"Property category",value:"".concat(o)}):"121071"===n?t.push({name:"Property type",value:"".concat(o)}):"111001"===n?t.push({name:"Algorithm Name",value:"".concat(o)}):t.push({name:a,value:"".concat(o)})}else if(e.ValueType===S.sr.valueTypes.ValueTypes.TEXT){var r=e;t.push({name:a,value:r.TextValue})}})),this.props.roi.measurements.forEach((function(e){var n=e.ConceptNameCodeSequence[0].CodeMeaning,i="".concat(n),a=e.MeasuredValueSequence[0],o=a.NumericValue.toPrecision(6),r=a.MeasurementUnitsCodeSequence[0].CodeValue;t.push({name:i,value:"".concat(o," ").concat(r)})})),(0,b.jsxs)(se.Z,{align:"start",children:[(0,b.jsx)("div",{style:{paddingLeft:"14px"},children:(0,b.jsx)(ge.Z,{size:"small",onChange:this.handleVisibilityChange,checked:this.props.isVisible,checkedChildren:(0,b.jsx)(p.dSq,{}),unCheckedChildren:(0,b.jsx)(p.tgn,{})})}),(0,b.jsx)(g.Z.Item,(0,E.Z)((0,E.Z)({style:{height:"100%",paddingLeft:"3px"}},i),{},{children:(0,b.jsx)(x,{header:e,attributes:t,selectable:!0,hasLongValues:!0})}),this.props.roi.uid)]})}}]),n}(l.Component);const Ie=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).handleMenuItemSelection=a.handleMenuItemSelection.bind((0,o.Z)(a)),a.handleVisibilityChange=a.handleVisibilityChange.bind((0,o.Z)(a)),a}return(0,a.Z)(n,[{key:"handleVisibilityChange",value:function(e,t){var n=this;e?this.props.rois.forEach((function(t){n.props.onVisibilityChange({roiUID:t.uid,isVisible:e})})):this.props.visibleRoiUIDs.forEach((function(t){n.props.onVisibilityChange({roiUID:t,isVisible:e})}))}},{key:"handleMenuItemSelection",value:function(e){this.props.onSelection({roiUID:e.key})}},{key:"render",value:function(){var e=this,t=this.props.rois.map((function(t,n){return(0,b.jsx)(Ce,{roi:t,index:n,isVisible:e.props.visibleRoiUIDs.has(t.uid),onVisibilityChange:e.props.onVisibilityChange},t.uid)}));return(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("div",{style:{paddingLeft:"14px",paddingTop:"7px",paddingBottom:"7px"},children:(0,b.jsx)(ge.Z,{size:"small",onChange:this.handleVisibilityChange,checked:this.props.visibleRoiUIDs.size>0,checkedChildren:(0,b.jsx)(p.dSq,{}),unCheckedChildren:(0,b.jsx)(p.tgn,{})})}),(0,b.jsx)(g.Z,{selectedKeys:(0,ae.Z)(this.props.selectedRoiUIDs.values()),onSelect:this.handleMenuItemSelection,onClick:this.handleMenuItemSelection,children:t})]})}}]),n}(l.Component);var be=n(914),we=n(6272),xe=n(3020),De=n(5594),Ze=n(2414),Ve=["annotationGroup","defaultStyle","isVisible","metadata","onVisibilityChange","onStyleChange"];const Oe=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).handleVisibilityChange=a.handleVisibilityChange.bind((0,o.Z)(a)),a.handleMeasurementSelection=a.handleMeasurementSelection.bind((0,o.Z)(a)),a.handleOpacityChange=a.handleOpacityChange.bind((0,o.Z)(a)),a.handleColorRChange=a.handleColorRChange.bind((0,o.Z)(a)),a.handleColorGChange=a.handleColorGChange.bind((0,o.Z)(a)),a.handleColorBChange=a.handleColorBChange.bind((0,o.Z)(a)),a.getCurrentColor=a.getCurrentColor.bind((0,o.Z)(a)),a.state={isVisible:a.props.isVisible,currentStyle:{opacity:a.props.defaultStyle.opacity,color:a.props.defaultStyle.color}},a}return(0,a.Z)(n,[{key:"handleVisibilityChange",value:function(e,t){this.props.onVisibilityChange({annotationGroupUID:this.props.annotationGroup.uid,isVisible:e}),this.setState({isVisible:e})}},{key:"handleOpacityChange",value:function(e){null!=e&&(this.props.onStyleChange({uid:this.props.annotationGroup.uid,styleOptions:{opacity:e}}),this.setState({currentStyle:{opacity:e,color:this.state.currentStyle.color,limitValues:this.state.currentStyle.limitValues}}))}},{key:"handleColorRChange",value:function(e){if(null!=e&&void 0!==this.state.currentStyle.color){var t=[Array.isArray(e)?e[0]:e,this.state.currentStyle.color[1],this.state.currentStyle.color[2]];this.setState((function(e){return{currentStyle:{color:t,opacity:e.currentStyle.opacity,limitValues:e.currentStyle.limitValues}}})),this.props.onStyleChange({uid:this.props.annotationGroup.uid,styleOptions:{color:t}})}}},{key:"handleColorGChange",value:function(e){if(null!=e&&void 0!==this.state.currentStyle.color){var t=[this.state.currentStyle.color[0],Array.isArray(e)?e[0]:e,this.state.currentStyle.color[2]];this.setState((function(e){return{currentStyle:{color:t,opacity:e.currentStyle.opacity,limitValues:e.currentStyle.limitValues}}})),this.props.onStyleChange({uid:this.props.annotationGroup.uid,styleOptions:{color:t}})}}},{key:"handleColorBChange",value:function(e){if(null!=e&&void 0!==this.state.currentStyle.color){var t=[this.state.currentStyle.color[0],this.state.currentStyle.color[1],Array.isArray(e)?e[0]:e];this.setState((function(e){return{currentStyle:{color:t,opacity:e.currentStyle.opacity,limitValues:e.currentStyle.limitValues}}})),this.props.onStyleChange({uid:this.props.annotationGroup.uid,styleOptions:{color:t}})}}},{key:"getCurrentColor",value:function(){var e;return null!=this.state.currentStyle.color?"#"+(16777216+((e=this.state.currentStyle.color)[0]<<16)+(e[1]<<8)+e[2]).toString(16).slice(1):"white"}},{key:"handleLowerLimitChange",value:function(e){null!=e&&void 0!==this.state.currentStyle.limitValues&&(this.setState((function(t){return void 0!==t.currentStyle.limitValues?{currentStyle:{color:t.currentStyle.color,opacity:t.currentStyle.opacity,limitValues:[e,t.currentStyle.limitValues[1]]}}:{currentStyle:{color:t.currentStyle.color,opacity:t.currentStyle.opacity,limitValues:t.currentStyle.limitValues}}})),this.props.onStyleChange({uid:this.props.annotationGroup.uid,styleOptions:{limitValues:[e,this.state.currentStyle.limitValues[1]]}}))}},{key:"handleUpperLimitChange",value:function(e){null!=e&&void 0!==this.state.currentStyle.limitValues&&(this.setState((function(t){return void 0!==t.currentStyle.limitValues?{currentStyle:{color:t.currentStyle.color,opacity:t.currentStyle.opacity,limitValues:[t.currentStyle.limitValues[0],e]}}:{currentStyle:{color:t.currentStyle.color,opacity:t.currentStyle.opacity,limitValues:t.currentStyle.limitValues}}})),this.props.onStyleChange({uid:this.props.annotationGroup.uid,styleOptions:{limitValues:[this.state.currentStyle.limitValues[0],e]}}))}},{key:"handleLimitChange",value:function(e){this.setState((function(t){return{currentStyle:{color:t.currentStyle.color,opacity:t.currentStyle.opacity,limitValues:e}}})),this.props.onStyleChange({uid:this.props.annotationGroup.uid,styleOptions:{limitValues:e}})}},{key:"handleMeasurementSelection",value:function(e,t){var n=this;if(null!=e&&null!=t.children){var i=e.split("-"),a=new S.sr.coding.CodedConcept({value:i[1],schemeDesignator:i[0],meaning:t.children});this.props.onStyleChange({uid:this.props.annotationGroup.uid,styleOptions:{measurement:a}}),this.setState((function(e){return{currentStyle:{opacity:e.currentStyle.opacity,measurement:a}}}))}else this.props.onStyleChange({uid:this.props.annotationGroup.uid,styleOptions:{color:this.props.defaultStyle.color}}),this.setState((function(e){return{currentStyle:{opacity:e.currentStyle.opacity,color:n.props.defaultStyle.color,limitValues:void 0}}}))}},{key:"render",value:function(){var e,t,n,i,a=this,o=this.props.metadata.AnnotationGroupSequence.findIndex((function(e){return e.AnnotationGroupUID===a.props.annotationGroup.uid})),r=this.props.metadata.AnnotationGroupSequence[o],s=[{name:"Property type",value:this.props.annotationGroup.propertyType.CodeMeaning},{name:"Property category",value:this.props.annotationGroup.propertyCategory.CodeMeaning},{name:"Graphic type",value:r.GraphicType},{name:"Annotation coordinate type",value:this.props.metadata.AnnotationCoordinateType}],l=null!==(e=r.MeasurementsSequence)&&void 0!==e?e:[],c=l.map((function(e,t){var n=e.ConceptNameCodeSequence[0];return(0,b.jsx)(oe.Z.Option,{value:"".concat(n.CodingSchemeDesignator,"-").concat(n.CodeValue),dropdownMatchSelectWidth:!1,size:"small",disabled:!a.props.isVisible,children:n.CodeMeaning},t)}));if(c.push((0,b.jsx)(oe.Z.Option,{value:void 0,dropdownMatchSelectWidth:!1,size:"small",disabled:!this.props.isVisible,children:(0,b.jsx)(b.Fragment,{})},"-")),null!=this.state.currentStyle.color&&(t=(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(ue.Z,{plain:!0,children:"Color"}),(0,b.jsxs)(de.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,b.jsx)(be.Z,{span:5,children:"Red"}),(0,b.jsx)(be.Z,{span:14,children:(0,b.jsx)(we.Z,{range:!1,min:0,max:255,step:1,value:this.state.currentStyle.color[0],onChange:this.handleColorRChange})}),(0,b.jsx)(be.Z,{span:5,children:(0,b.jsx)(pe.Z,{min:0,max:255,size:"small",style:{width:"65px"},value:this.state.currentStyle.color[0],onChange:this.handleColorRChange})})]}),(0,b.jsxs)(de.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,b.jsx)(be.Z,{span:5,children:"Green"}),(0,b.jsx)(be.Z,{span:14,children:(0,b.jsx)(we.Z,{range:!1,min:0,max:255,step:1,value:this.state.currentStyle.color[1],onChange:this.handleColorGChange})}),(0,b.jsx)(be.Z,{span:5,children:(0,b.jsx)(pe.Z,{min:0,max:255,size:"small",style:{width:"65px"},value:this.state.currentStyle.color[1],onChange:this.handleColorGChange})})]}),(0,b.jsxs)(de.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,b.jsx)(be.Z,{span:5,children:"Blue"}),(0,b.jsx)(be.Z,{span:14,children:(0,b.jsx)(we.Z,{range:!1,min:0,max:255,step:1,value:this.state.currentStyle.color[2],onChange:this.handleColorBChange})}),(0,b.jsx)(be.Z,{span:5,children:(0,b.jsx)(pe.Z,{min:0,max:255,size:"small",style:{width:"65px"},value:this.state.currentStyle.color[2],onChange:this.handleColorBChange})})]}),(0,b.jsx)(ue.Z,{plain:!0})]})),l.length>0){if(null!=this.state.currentStyle.limitValues){n=(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(ue.Z,{plain:!0,children:"Values of interest"}),(0,b.jsxs)(de.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,b.jsx)(be.Z,{span:6,children:(0,b.jsx)(pe.Z,{min:0,max:this.state.currentStyle.limitValues[1],size:"small",style:{width:"75px"},value:this.state.currentStyle.limitValues[0],onChange:this.handleLowerLimitChange})}),(0,b.jsx)(be.Z,{span:12,children:(0,b.jsx)(we.Z,{range:!0,min:0,max:1e3,step:1,value:[this.state.currentStyle.limitValues[0],this.state.currentStyle.limitValues[1]],onChange:this.handleLimitChange})}),(0,b.jsx)(be.Z,{span:6,children:(0,b.jsx)(pe.Z,{min:this.state.currentStyle.limitValues[0],max:1e3,size:"small",style:{width:"75px"},value:this.state.currentStyle.limitValues[1],onChange:this.handleUpperLimitChange})})]})]})}i=(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(ue.Z,{plain:!0,children:"Exploration"}),(0,b.jsxs)(de.Z,{justify:"start",align:"middle",gutter:[8,8],children:[(0,b.jsx)(be.Z,{span:8,children:"Measurement"}),(0,b.jsx)(be.Z,{span:16,children:(0,b.jsx)(oe.Z,{style:{minWidth:"65px",width:"90%"},onSelect:this.handleMeasurementSelection,defaultValue:void 0,children:c},"annotation-group-measurements")})]})]})}var d=(0,b.jsxs)("div",{children:[t,n,(0,b.jsxs)(de.Z,{justify:"start",align:"middle",gutter:[8,8],children:[(0,b.jsx)(be.Z,{span:6,children:"Opacity"}),(0,b.jsx)(be.Z,{span:12,children:(0,b.jsx)(we.Z,{range:!1,min:0,max:1,step:.01,value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})}),(0,b.jsx)(be.Z,{span:6,children:(0,b.jsx)(pe.Z,{min:0,max:1,size:"small",step:.1,style:{width:"65px"},value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})})]}),i]}),u=this.getCurrentColor(),h=this.state.isVisible&&null==this.state.currentStyle.measurement,v=this.props,f=(v.annotationGroup,v.defaultStyle,v.isVisible,v.metadata,v.onVisibilityChange,v.onStyleChange,(0,Se.Z)(v,Ve));return(0,b.jsx)(g.Z.Item,(0,E.Z)((0,E.Z)({style:{height:"100%",paddingLeft:"3px"}},f),{},{children:(0,b.jsxs)(se.Z,{align:"start",children:[(0,b.jsx)("div",{style:{paddingLeft:"14px"},children:(0,b.jsxs)(se.Z,{direction:"vertical",align:"end",children:[(0,b.jsx)(ge.Z,{size:"small",onChange:this.handleVisibilityChange,checked:this.props.isVisible,checkedChildren:(0,b.jsx)(p.dSq,{}),unCheckedChildren:(0,b.jsx)(p.tgn,{})}),(0,b.jsx)(xe.Z,{placement:"left",content:d,overlayStyle:{width:"350px"},title:"Display Settings",children:(0,b.jsx)(ce.Z,{type:"primary",shape:"circle",icon:(0,b.jsx)(Ze.Z,{})})})]})}),(0,b.jsx)(De.Z,{offset:[-20,20],count:" ",style:{borderStyle:"solid",borderWidth:"1px",borderColor:"gray",visibility:h?"visible":"hidden",backgroundImage:"linear-gradient(to bottom, ".concat(u,", ").concat(u)},children:(0,b.jsx)(x,{header:this.props.annotationGroup.label,attributes:s,selectable:!0,hasLongValues:!0})})]})}),this.props.annotationGroup.uid)}}]),n}(l.Component);const Re=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;(0,i.Z)(this,n);for(var a=arguments.length,o=new Array(a),r=0;r<a;r++)o[r]=arguments[r];return(e=t.call.apply(t,[this].concat(o))).handleVisibilityChange=function(t){t?e.props.annotationGroups.forEach((function(n){e.props.onAnnotationGroupVisibilityChange({annotationGroupUID:n.uid,isVisible:t})})):e.props.visibleAnnotationGroupUIDs.forEach((function(n){e.props.onAnnotationGroupVisibilityChange({annotationGroupUID:n,isVisible:t})}))},e}return(0,a.Z)(n,[{key:"render",value:function(){var e=this,t=this.props.annotationGroups.map((function(t,n){var i=t.uid;return(0,b.jsx)(Oe,{annotationGroup:t,metadata:e.props.metadata[i],isVisible:e.props.visibleAnnotationGroupUIDs.has(i),defaultStyle:e.props.defaultAnnotationGroupStyles[i],onVisibilityChange:e.props.onAnnotationGroupVisibilityChange,onStyleChange:e.props.onAnnotationGroupStyleChange},t.uid)}));return(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("div",{style:{paddingLeft:"14px",paddingTop:"7px",paddingBottom:"7px"},children:(0,b.jsx)(ge.Z,{size:"small",onChange:this.handleVisibilityChange,checked:this.props.visibleAnnotationGroupUIDs.size>0,checkedChildren:(0,b.jsx)(p.dSq,{}),unCheckedChildren:(0,b.jsx)(p.tgn,{})})}),(0,b.jsx)(g.Z,{selectable:!1,children:t})]})}}]),n}(l.Component);const je=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).handleClick=a.handleClick.bind((0,o.Z)(a)),a}return(0,a.Z)(n,[{key:"handleClick",value:function(e){void 0!==this.props.onClick&&this.props.onClick(e)}},{key:"render",value:function(){var e,t,n,i=this.props.icon;return void 0===i?null:(null!=this.props.label&&(t=(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(ue.Z,{type:"vertical"}),this.props.label]})),n=null!==(e=this.props.isSelected)&&void 0!==e&&e?(0,b.jsx)(ce.Z,{onClick:this.handleClick,icon:(0,b.jsx)(i,{}),type:"primary",style:{lineHeight:"1.0"},children:t}):(0,b.jsx)(ce.Z,{onClick:this.handleClick,icon:(0,b.jsx)(i,{}),type:"default",style:{lineHeight:"1.0"},children:t}),void 0!==this.props.tooltip?(0,b.jsx)(le.Z,{title:this.props.tooltip,children:n}):n)}}]),n}(l.Component);const Pe=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){if(void 0===this.props.metadata)return null;var e=[{name:"Manufacturer",value:this.props.metadata.Manufacturer},{name:"Model Name",value:this.props.metadata.ManufacturerModelName},{name:"Device Serial Number",value:this.props.metadata.DeviceSerialNumber},{name:"Software Versions",value:this.props.metadata.SoftwareVersions}];return null!=this.props.metadata.InstitutionName&&e.push({name:"Institution Name",value:this.props.metadata.InstitutionName}),(0,b.jsx)(x,{attributes:e,hasLongValues:!0})}}]),n}(l.Component);var Me=function(e){var t=e.content,n=e.name,i=[];return t.forEach((function(e){(function(e,t){var n=e.ConceptNameCodeSequence[0];return n.CodeValue===t.CodeValue&&n.CodingSchemeDesignator===t.CodingSchemeDesignator})(e,n)&&i.push(e)})),i},Ee=function(e,t){return e.ValueType===t},Ue=function(e){var t=Me({content:e.ContentSequence,name:new S.sr.coding.CodedConcept({value:"126010",schemeDesignator:"DCM",meaning:"Imaging Measurements"})});1!==t.length&&te.onError(K,new z(q,'Content item "Imaging Measurements" not found.Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report".'));var n=t[0],i=Me({content:n.ContentSequence,name:new S.sr.coding.CodedConcept({value:"125007",schemeDesignator:"DCM",meaning:"Measurement Group"})}),a=[];return i.forEach((function(e){var t,n=[],i=e,o=Me({content:i.ContentSequence,name:new S.sr.coding.CodedConcept({value:"112040",schemeDesignator:"DCM",meaning:"Tracking Unique Identifier"})});0===o.length&&te.onError(K,new z(q,'Content item "Tracking Unique Identifier" not found. Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1410 "Planar ROI Measurements and Qualitative Evaluations".'));var r=o[0];if(0===(o=Me({content:i.ContentSequence,name:new S.sr.coding.CodedConcept({value:"121071",schemeDesignator:"DCM",meaning:"Finding"})})).length&&te.onError(K,new z(q,'Content item "Finding" not found. Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1410 "Planar ROI Measurements and Qualitative Evaluations".')),0!==(o=Me({content:i.ContentSequence,name:new S.sr.coding.CodedConcept({value:"111001",schemeDesignator:"DCM",meaning:"Algorithm Name"})})).length){var s=o[0];n.push(s),t="Device"}else t="Person";if(0!==(o=Me({content:i.ContentSequence,name:new S.sr.coding.CodedConcept({value:"111003",schemeDesignator:"DCM",meaning:"Algorithm Version"})})).length){var l=o[0];n.push(l)}0===(o=Me({content:i.ContentSequence,name:new S.sr.coding.CodedConcept({value:"111030",schemeDesignator:"DCM",meaning:"Image Region"})})).length&&te.onError(K,new z(q,'Content item "Image Region" not found. Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1410 "Planar ROI Measurements and Qualitative Evaluations".'));var c,d=o[0];if("POINT"===d.GraphicType)c=new U.scoord3d.Point({frameOfReferenceUID:d.ReferencedFrameOfReferenceUID,coordinates:d.GraphicData});else{for(var u=[],h=0;h<d.GraphicData.length;h+=3)u.push(d.GraphicData.slice(h,h+3));"POLYGON"===d.GraphicType?c=new U.scoord3d.Polygon({frameOfReferenceUID:d.ReferencedFrameOfReferenceUID,coordinates:u}):"MULTIPOINT"===d.GraphicType?c=new U.scoord3d.MultiPoint({frameOfReferenceUID:d.ReferencedFrameOfReferenceUID,coordinates:u}):"POLYLINE"===d.GraphicType?c=new U.scoord3d.Polyline({frameOfReferenceUID:d.ReferencedFrameOfReferenceUID,coordinates:u}):"ELLIPSE"===d.GraphicType?c=new U.scoord3d.Ellipse({frameOfReferenceUID:d.ReferencedFrameOfReferenceUID,coordinates:u}):"ELLIPSOID"===d.GraphicType?c=new U.scoord3d.Ellipsoid({frameOfReferenceUID:d.ReferencedFrameOfReferenceUID,coordinates:u}):te.onError(K,new z(q,'Content item "Image Region" has unknown graphic type '+'"'.concat(d.GraphicType,'". ')+'Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1410 "Planar ROI Measurements and Qualitative Evaluations".'))}n.push.apply(n,(0,ae.Z)(function(e){var t=e.content,n=[];return t.forEach((function(e){if(Ee(e,S.sr.valueTypes.ValueTypes.CODE)){var t=e;n.push(t)}})),n}({content:i.ContentSequence})));var p=function(e){var t=e.content,n=[];return t.forEach((function(e){if(Ee(e,S.sr.valueTypes.ValueTypes.NUM)){var t=e;n.push(t)}})),n}({content:i.ContentSequence}),v=new U.roi.ROI({scoord3d:c,uid:(0,y.Z)(),properties:{trackingUID:r.UID,observerType:t,evaluations:n,measurements:p}});a.push(v)})),a},Ae=(0,a.Z)((function e(t){(0,i.Z)(this,e),this.PersonObserverName=void 0,this.PersonObserverLoginName=void 0,this.DeviceObserverUID=void 0,this.DeviceObserverName=void 0,this.SpecimenUID=void 0,this.SpecimenIdentifier=void 0,this.ContainerIdentifier=void 0,this.ROIs=[];var n=Me({content:t.ContentSequence,name:new S.sr.coding.CodedConcept({value:"121039",schemeDesignator:"DCM",meaning:"Specimen UID"})});0===n.length&&te.onError(K,new z(q,'Content item "Specimen UID" not found. Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1001 "Observation Context" -> TID 1006 "Subject Context" -> TID 1009 "Subject Context, Specimen".'));var a=n[0];this.SpecimenUID=a.UID,0===(n=Me({content:t.ContentSequence,name:new S.sr.coding.CodedConcept({value:"121041",schemeDesignator:"DCM",meaning:"Specimen Identifier"})})).length&&te.onError(K,new z(q,'Content item "Specimen Identifier" not found. Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1001 "Observation Context" -> TID 1006 "Subject Context" -> TID 1009 "Subject Context, Specimen".'));var o=n[0];this.SpecimenIdentifier=o.TextValue,0===(n=Me({content:t.ContentSequence,name:new S.sr.coding.CodedConcept({value:"111700",schemeDesignator:"DCM",meaning:"Specimen Container Identifier"})})).length&&te.onError(K,new z(q,'Content item "Specimen Container Identifier" not found. Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1001 "Observation Context" -> TID 1006 "Subject Context" -> TID 1009 "Subject Context, Specimen".'));var r=n[0];if(this.ContainerIdentifier=r.TextValue,0!==(n=Me({content:t.ContentSequence,name:new S.sr.coding.CodedConcept({value:"121008",schemeDesignator:"DCM",meaning:"Person Observer Name"})})).length){var s=n[0];this.PersonObserverName=s.PersonName}if(0!==(n=Me({content:t.ContentSequence,name:new S.sr.coding.CodedConcept({value:"128774",schemeDesignator:"DCM",meaning:"Person Observer's Login Name"})})).length){var l=n[0];this.PersonObserverLoginName=l.TextValue}if((n=Me({content:t.ContentSequence,name:new S.sr.coding.CodedConcept({value:"121012",schemeDesignator:"DCM",meaning:"Device Observer UID"})})).length>0){var c=n[0];this.DeviceObserverUID=c.UID}if(0!==(n=Me({content:t.ContentSequence,name:new S.sr.coding.CodedConcept({value:"121013",schemeDesignator:"DCM",meaning:"Device Observer Name"})})).length){var d=n[0];this.DeviceObserverName=d.TextValue}this.ROIs=Ue(t)}));const Te=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e=new Ae(this.props.dataset),t=[{name:"ID",value:e.ContainerIdentifier}],n=[{name:"ID",value:e.SpecimenIdentifier}],i=[{name:"Name",value:e.PersonObserverName}],a=e.ROIs.map((function(e,t){var n="Region ".concat(t+1),i=[];return e.evaluations.forEach((function(e){e.ValueType===S.sr.valueTypes.ValueTypes.CODE?i.push({name:e.ConceptNameCodeSequence[0].CodeMeaning,value:e.ConceptCodeSequence[0].CodeMeaning}):e.ValueType===S.sr.valueTypes.ValueTypes.TEXT&&i.push({name:e.ConceptNameCodeSequence[0].CodeMeaning,value:e.TextValue})})),(0,b.jsx)(x,{header:n,attributes:i},e.uid)}));return(0,b.jsxs)("div",{children:[(0,b.jsx)(ue.Z,{orientation:"left",children:"Patient"}),(0,b.jsx)(j,{metadata:this.props.dataset}),(0,b.jsx)(ue.Z,{orientation:"left",children:"Case"}),(0,b.jsx)(P,{metadata:this.props.dataset}),(0,b.jsx)(ue.Z,{orientation:"left",children:"Slide"}),(0,b.jsx)(x,{attributes:t}),(0,b.jsx)(ue.Z,{orientation:"left",children:"Specimen"}),(0,b.jsx)(x,{attributes:n}),(0,b.jsx)(ue.Z,{orientation:"left",children:"Observer"}),(0,b.jsx)(x,{attributes:i}),(0,b.jsx)(ue.Z,{orientation:"left",children:"Annotations"}),a]})}}]),n}(l.Component);var ke=n(2126);const Le=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e,t=null;return void 0!==this.props.groups&&(t=this.props.groups.map((function(e,t){return(0,b.jsx)(x,{header:e.name,attributes:e.attributes},t)}))),e=void 0!==this.props.type?"".concat(this.props.type,": ").concat(this.props.identifier):this.props.identifier,(0,b.jsxs)(ke.ZP.Item,{children:[(0,b.jsx)(x,{header:e,attributes:this.props.attributes,hasLongValues:this.props.hasLongValues,children:t}),this.props.children]},this.props.uid)}}]),n}(l.Component);new S.sr.coding.CodedConcept({value:"17636008",schemeDesignator:"SCT",meaning:"Specimen collection"}),new S.sr.coding.CodedConcept({value:"433465004",schemeDesignator:"SCT",meaning:"Sampling of tissue specimen"}),new S.sr.coding.CodedConcept({value:"127790008",schemeDesignator:"SCT",meaning:"Specimen staining"}),new S.sr.coding.CodedConcept({value:"9265001",schemeDesignator:"SCT",meaning:"Specimen processing"});var _e={FIXATIVE:new S.sr.coding.CodedConcept({value:"430864009",schemeDesignator:"SCT",meaning:"Tissue fixative"}),EMBEDDING_MEDIUM:new S.sr.coding.CodedConcept({value:"430863003",schemeDesignator:"SCT",meaning:"Embedding medium"})},Ne=(0,E.Z)({SPECIMEN_IDENTIFIER:new S.sr.coding.CodedConcept({value:"121041",schemeDesignator:"DCM",meaning:"Specimen identifier"}),PARENT_SPECIMEN_IDENTIFIER:new S.sr.coding.CodedConcept({value:"111705",schemeDesignator:"DCM",meaning:"Parent specimen identifier"}),PROCESSING_TYPE:new S.sr.coding.CodedConcept({value:"111701",schemeDesignator:"DCM",meaning:"Processing type"}),DATETIME_OF_PROCESSING:new S.sr.coding.CodedConcept({value:"111702",schemeDesignator:"DCM",meaning:"Datetime of processing"}),PROCESSING_STEP_DESCRIPTION:new S.sr.coding.CodedConcept({value:"111703",schemeDesignator:"DCM",meaning:"Processing step description"}),COLLECTION_METHOD:new S.sr.coding.CodedConcept({value:"17636008",schemeDesignator:"SCT",meaning:"Specimen collection"}),SAMPLING_METHOD:new S.sr.coding.CodedConcept({value:"111704",schemeDesignator:"DCM",meaning:"Sampling method"}),STAIN:new S.sr.coding.CodedConcept({value:"424361007",schemeDesignator:"SCT",meaning:"Using substance"})},_e);const Ge=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e,t=this;if(void 0===this.props.metadata)return null;var n=this.props.metadata.SpecimenDescriptionSequence[this.props.index],i=[];if(void 0!==n.SpecimenShortDescription&&i.push({name:"Description",value:n.SpecimenShortDescription}),void 0!==n.PrimaryAnatomicStructureSequence&&n.PrimaryAnatomicStructureSequence.length>0){var a=n.PrimaryAnatomicStructureSequence;i.push({name:"Anatomical structure",value:a.map((function(e){return e.CodeMeaning})).join(", ")})}(null!==(e=n.SpecimenPreparationSequence)&&void 0!==e?e:[]).forEach((function(e,n){e.SpecimenPreparationStepContentItemSequence.forEach((function(e,n){var a=new S.sr.coding.CodedConcept({value:e.ConceptNameCodeSequence[0].CodeValue,schemeDesignator:e.ConceptNameCodeSequence[0].CodingSchemeDesignator,meaning:e.ConceptNameCodeSequence[0].CodeMeaning});if(e.ValueType===S.sr.valueTypes.ValueTypes.CODE){var o=new S.sr.coding.CodedConcept({value:e.ConceptCodeSequence[0].CodeValue,schemeDesignator:e.ConceptCodeSequence[0].CodingSchemeDesignator,meaning:e.ConceptCodeSequence[0].CodeMeaning});a.equals(Ne.PROCESSING_TYPE)||(a.equals(Ne.COLLECTION_METHOD)?i.push({name:"Collection method",value:o.CodeMeaning}):a.equals(Ne.FIXATIVE)?i.push({name:"Tissue fixative",value:o.CodeMeaning}):a.equals(Ne.EMBEDDING_MEDIUM)?i.push({name:"Tissue embedding medium",value:o.CodeMeaning}):a.equals(Ne.STAIN)&&t.props.showstain&&i.push({name:"Tissue stain",value:o.CodeMeaning}))}else e.ValueType===S.sr.valueTypes.ValueTypes.TEXT&&(a.equals(Ne.STAIN)&&t.props.showstain?i.push({name:"Tissue stain",value:e.TextValue}):a.equals(Ne.PARENT_SPECIMEN_IDENTIFIER)&&i.push({name:"Parent specimen",value:e.TextValue}))}))}));var o=n.SpecimenUID,r=n.SpecimenIdentifier;return(0,b.jsx)(Le,{uid:o,identifier:r,attributes:i,hasLongValues:!0},o)}}]),n}(l.Component);const qe=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e,t=this;if(void 0===this.props.metadata)return null;var n=(null!==(e=this.props.metadata.SpecimenDescriptionSequence)&&void 0!==e?e:[]).map((function(e,n){return(0,b.jsx)(Ge,{index:n,metadata:t.props.metadata,showstain:t.props.showstain},e.SpecimenUID)}));return(0,b.jsx)(ke.ZP,{style:{overflowY:"auto"},children:n})}}]),n}(l.Component);var Fe=n(681),ze=n(2622),Be=n(4215),We=n(8272),Ye=["defaultStyle","isRemovable","isVisible","metadata","onVisibilityChange","onStyleChange","onRemoval","opticalPath"];const He=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).handleVisibilityChange=a.handleVisibilityChange.bind((0,o.Z)(a)),a.handleOpacityChange=a.handleOpacityChange.bind((0,o.Z)(a)),a.handleLimitChange=a.handleLimitChange.bind((0,o.Z)(a)),a.handleLowerLimitChange=a.handleLowerLimitChange.bind((0,o.Z)(a)),a.handleUpperLimitChange=a.handleUpperLimitChange.bind((0,o.Z)(a)),a.handleColorRChange=a.handleColorRChange.bind((0,o.Z)(a)),a.handleColorGChange=a.handleColorGChange.bind((0,o.Z)(a)),a.handleColorBChange=a.handleColorBChange.bind((0,o.Z)(a)),a.handleRemoval=a.handleRemoval.bind((0,o.Z)(a)),a.getCurrentColors=a.getCurrentColors.bind((0,o.Z)(a)),a.state={isVisible:a.props.isVisible,currentStyle:{opacity:a.props.defaultStyle.opacity,color:a.props.defaultStyle.color,paletteColorLookupTable:a.props.defaultStyle.paletteColorLookupTable,limitValues:a.props.defaultStyle.limitValues}},a}return(0,a.Z)(n,[{key:"componentDidUpdate",value:function(e,t){this.props.defaultStyle!==e.defaultStyle&&this.setState({currentStyle:this.props.defaultStyle})}},{key:"handleVisibilityChange",value:function(e,t){var n=this.props.opticalPath.identifier;this.setState({isVisible:e}),this.props.onVisibilityChange({opticalPathIdentifier:n,isVisible:e})}},{key:"handleOpacityChange",value:function(e){if(null!=e){var t=this.props.opticalPath.identifier;this.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{opacity:e}}),this.setState((function(t){return{currentStyle:{color:t.currentStyle.color,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:e,limitValues:t.currentStyle.limitValues}}}))}}},{key:"handleColorRChange",value:function(e){var t=this.props.opticalPath.identifier;if(null!=e&&void 0!==this.state.currentStyle.color){var n=[Array.isArray(e)?e[0]:e,this.state.currentStyle.color[1],this.state.currentStyle.color[2]];this.setState((function(e){return{currentStyle:{color:n,paletteColorLookupTable:e.currentStyle.paletteColorLookupTable,opacity:e.currentStyle.opacity,limitValues:e.currentStyle.limitValues}}})),this.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{color:n}})}}},{key:"handleColorGChange",value:function(e){var t=this.props.opticalPath.identifier;if(null!=e&&void 0!==this.state.currentStyle.color){var n=[this.state.currentStyle.color[0],Array.isArray(e)?e[0]:e,this.state.currentStyle.color[2]];this.setState((function(e){return{currentStyle:{color:n,paletteColorLookupTable:e.currentStyle.paletteColorLookupTable,opacity:e.currentStyle.opacity,limitValues:e.currentStyle.limitValues}}})),this.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{color:n}})}}},{key:"handleColorBChange",value:function(e){var t=this.props.opticalPath.identifier;if(null!=e&&void 0!==this.state.currentStyle.color){var n=[this.state.currentStyle.color[0],this.state.currentStyle.color[1],Array.isArray(e)?e[0]:e];this.setState((function(e){return{currentStyle:{color:n,paletteColorLookupTable:e.currentStyle.paletteColorLookupTable,opacity:e.currentStyle.opacity,limitValues:e.currentStyle.limitValues}}})),this.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{color:n}})}}},{key:"getCurrentColors",value:function(){var e=function(e){return"#"+(16777216+(e[0]<<16)+(e[1]<<8)+e[2]).toString(16).slice(1)};return null!=this.props.defaultStyle.paletteColorLookupTable?this.props.defaultStyle.paletteColorLookupTable.data.map((function(t){return e(t)})):null!=this.state.currentStyle.color?["#000000",e(this.state.currentStyle.color)]:["white","white"]}},{key:"handleLowerLimitChange",value:function(e){var t=this.props.opticalPath.identifier;null!=e&&void 0!==this.state.currentStyle.limitValues&&(this.setState((function(t){return void 0!==t.currentStyle.limitValues?{currentStyle:{color:t.currentStyle.color,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:t.currentStyle.opacity,limitValues:[e,t.currentStyle.limitValues[1]]}}:{currentStyle:{color:t.currentStyle.color,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:t.currentStyle.opacity,limitValues:t.currentStyle.limitValues}}})),this.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{limitValues:[e,this.state.currentStyle.limitValues[1]]}}))}},{key:"handleUpperLimitChange",value:function(e){var t=this.props.opticalPath.identifier;null!=e&&void 0!==this.state.currentStyle.limitValues&&(this.setState((function(t){return void 0!==t.currentStyle.limitValues?{currentStyle:{color:t.currentStyle.color,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:t.currentStyle.opacity,limitValues:[t.currentStyle.limitValues[0],e]}}:{currentStyle:{color:t.currentStyle.color,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:t.currentStyle.opacity,limitValues:t.currentStyle.limitValues}}})),this.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{limitValues:[this.state.currentStyle.limitValues[0],e]}}))}},{key:"handleLimitChange",value:function(e){var t=this.props.opticalPath.identifier;this.setState((function(t){return{currentStyle:{color:t.currentStyle.color,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:t.currentStyle.opacity,limitValues:e}}})),this.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{limitValues:e}})}},{key:"handleRemoval",value:function(){var e=this.props.opticalPath.identifier;this.props.onRemoval(e)}},{key:"render",value:function(){var e,t=this.props.opticalPath.identifier,n=this.props.opticalPath.description,i=[];void 0!==this.props.opticalPath.illuminationWaveLength&&i.push({name:"Illumination wavelength",value:"".concat(this.props.opticalPath.illuminationWaveLength," nm")}),void 0!==this.props.opticalPath.illuminationColor&&i.push({name:"Illumination color",value:this.props.opticalPath.illuminationColor.CodeMeaning});var a=null!==(e=this.props.metadata[0].SpecimenDescriptionSequence)&&void 0!==e?e:[];try{a.forEach((function(e){var t;(null!==(t=e.SpecimenPreparationSequence)&&void 0!==t?t:[]).forEach((function(e,t){e.SpecimenPreparationStepContentItemSequence.forEach((function(e,t){var n=new S.sr.coding.CodedConcept({value:e.ConceptNameCodeSequence[0].CodeValue,schemeDesignator:e.ConceptNameCodeSequence[0].CodingSchemeDesignator,meaning:e.ConceptNameCodeSequence[0].CodeMeaning});if(e.ValueType===S.sr.valueTypes.ValueTypes.CODE){var a=new S.sr.coding.CodedConcept({value:e.ConceptCodeSequence[0].CodeValue,schemeDesignator:e.ConceptCodeSequence[0].CodingSchemeDesignator,meaning:e.ConceptCodeSequence[0].CodeMeaning});n.equals(Ne.PROCESSING_TYPE)||n.equals(Ne.STAIN)&&i.push({name:"Tissue stain",value:a.CodeMeaning})}else e.ValueType===S.sr.valueTypes.ValueTypes.TEXT&&(n.equals(Ne.PROCESSING_TYPE)||n.equals(Ne.STAIN)&&i.push({name:"Tissue stain",value:e.TextValue}))}))}))}))}catch(f){te.onError(X,new z(q,f.message))}var o,r,s=Math.pow(2,this.props.metadata[0].BitsAllocated)-1,l=null!=n?"".concat(t,": ").concat(n):t;if(this.props.opticalPath.isMonochromatic){var c,d;c=null!=this.state.currentStyle.color?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(ue.Z,{plain:!0,children:"Color"}),(0,b.jsxs)(de.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,b.jsx)(be.Z,{span:5,children:"Red"}),(0,b.jsx)(be.Z,{span:14,children:(0,b.jsx)(we.Z,{range:!1,min:0,max:255,step:1,value:this.state.currentStyle.color[0],onChange:this.handleColorRChange})}),(0,b.jsx)(be.Z,{span:5,children:(0,b.jsx)(pe.Z,{min:0,max:255,size:"small",style:{width:"65px"},value:this.state.currentStyle.color[0],onChange:this.handleColorRChange})})]}),(0,b.jsxs)(de.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,b.jsx)(be.Z,{span:5,children:"Green"}),(0,b.jsx)(be.Z,{span:14,children:(0,b.jsx)(we.Z,{range:!1,min:0,max:255,step:1,value:this.state.currentStyle.color[1],onChange:this.handleColorGChange})}),(0,b.jsx)(be.Z,{span:5,children:(0,b.jsx)(pe.Z,{min:0,max:255,size:"small",style:{width:"65px"},value:this.state.currentStyle.color[1],onChange:this.handleColorGChange})})]}),(0,b.jsxs)(de.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,b.jsx)(be.Z,{span:5,children:"Blue"}),(0,b.jsx)(be.Z,{span:14,children:(0,b.jsx)(we.Z,{range:!1,min:0,max:255,step:1,value:this.state.currentStyle.color[2],onChange:this.handleColorBChange})}),(0,b.jsx)(be.Z,{span:5,children:(0,b.jsx)(pe.Z,{min:0,max:255,size:"small",style:{width:"65px"},value:this.state.currentStyle.color[2],onChange:this.handleColorBChange})})]})]}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(ue.Z,{plain:!0,children:"Color"}),"Custom pseudo-coloring is disabled because pixels are colorized via a provided palette color lookup table."]}),null!=this.state.currentStyle.limitValues&&(d=(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(ue.Z,{plain:!0,children:"Values of interest"}),(0,b.jsxs)(de.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,b.jsx)(be.Z,{span:6,children:(0,b.jsx)(pe.Z,{min:0,max:this.state.currentStyle.limitValues[1],size:"small",style:{width:"75px"},value:this.state.currentStyle.limitValues[0],onChange:this.handleLowerLimitChange})}),(0,b.jsx)(be.Z,{span:12,children:(0,b.jsx)(we.Z,{range:!0,min:0,max:s,step:1,value:[this.state.currentStyle.limitValues[0],this.state.currentStyle.limitValues[1]],onChange:this.handleLimitChange})}),(0,b.jsx)(be.Z,{span:6,children:(0,b.jsx)(pe.Z,{min:this.state.currentStyle.limitValues[0],max:s,size:"small",style:{width:"75px"},value:this.state.currentStyle.limitValues[1],onChange:this.handleUpperLimitChange})})]})]})),o=(0,b.jsxs)("div",{children:[d,c,(0,b.jsx)(ue.Z,{plain:!0}),(0,b.jsxs)(de.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,b.jsx)(be.Z,{span:6,children:"Opacity"}),(0,b.jsx)(be.Z,{span:12,children:(0,b.jsx)(we.Z,{range:!1,min:0,max:1,step:.01,value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})}),(0,b.jsx)(be.Z,{span:6,children:(0,b.jsx)(pe.Z,{min:0,max:1,size:"small",step:.1,style:{width:"65px"},value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})})]})]});var u=this.getCurrentColors();r=(0,b.jsx)(De.Z,{offset:[-20,20],count:" ",style:{borderStyle:"solid",borderWidth:"1px",borderColor:"gray",visibility:this.state.isVisible?"visible":"hidden",backgroundImage:"linear-gradient(to right, ".concat(u.toString(),")")},children:(0,b.jsx)(x,{header:l,attributes:i,selectable:!0,hasLongValues:!0})})}else o=(0,b.jsx)("div",{children:(0,b.jsxs)(de.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,b.jsx)(be.Z,{span:6,children:"Opacity"}),(0,b.jsx)(be.Z,{span:12,children:(0,b.jsx)(we.Z,{range:!1,min:0,max:1,step:.01,value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})}),(0,b.jsx)(be.Z,{span:6,children:(0,b.jsx)(pe.Z,{min:0,max:1,size:"small",step:.1,style:{width:"60px"},value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})})]})}),r=(0,b.jsx)(x,{header:l,attributes:i,selectable:!0,hasLongValues:!0});var h=[];this.props.isRemovable&&h.push((0,b.jsx)(le.Z,{title:"Remove Optical Path",children:(0,b.jsx)(ce.Z,{type:"default",shape:"circle",icon:(0,b.jsx)(ze.Z,{}),onClick:this.handleRemoval})}));var p=this.props,v=(p.defaultStyle,p.isRemovable,p.isVisible,p.metadata,p.onVisibilityChange,p.onStyleChange,p.onRemoval,p.opticalPath,(0,Se.Z)(p,Ye));return(0,b.jsx)(g.Z.Item,(0,E.Z)((0,E.Z)({style:{height:"100%",paddingLeft:"3px"}},v),{},{children:(0,b.jsxs)(se.Z,{align:"start",children:[(0,b.jsx)("div",{style:{paddingLeft:"14px"},children:(0,b.jsxs)(se.Z,{direction:"vertical",align:"end",children:[(0,b.jsx)(ge.Z,{size:"small",checked:this.state.isVisible,onChange:this.handleVisibilityChange,checkedChildren:(0,b.jsx)(Be.Z,{}),unCheckedChildren:(0,b.jsx)(We.Z,{})}),(0,b.jsx)(xe.Z,{placement:"left",content:o,overlayStyle:{width:"350px"},title:"Display Settings",children:(0,b.jsx)(ce.Z,{type:"primary",shape:"circle",icon:(0,b.jsx)(Ze.Z,{})})}),h]})}),r]})}),this.props.opticalPath.identifier)}}]),n}(l.Component);var Xe=oe.Z.Option;const Ke=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).state={selectedOpticalPathIdentifier:void 0},a.handleItemAddition=a.handleItemAddition.bind((0,o.Z)(a)),a.handleItemRemoval=a.handleItemRemoval.bind((0,o.Z)(a)),a.handleItemSelectionChange=a.handleItemSelectionChange.bind((0,o.Z)(a)),a}return(0,a.Z)(n,[{key:"handleItemRemoval",value:function(e){this.props.onOpticalPathActivityChange({opticalPathIdentifier:e,isActive:!1})}},{key:"handleItemSelectionChange",value:function(e){this.setState({selectedOpticalPathIdentifier:e})}},{key:"handleItemAddition",value:function(){var e=this.state.selectedOpticalPathIdentifier;void 0!==e&&(this.props.onOpticalPathActivityChange({opticalPathIdentifier:e,isActive:!0}),this.setState({selectedOpticalPathIdentifier:void 0}))}},{key:"render",value:function(){var e=this;if(void 0===this.props.metadata)return null;var t,n=this.props.opticalPaths.length>1,i=[],a=[];return this.props.opticalPaths.forEach((function(t){var o=t.identifier,r=e.props.metadata[o],s=r[0].SeriesInstanceUID;r[0].OpticalPathSequence.forEach((function(o){var l,c=o.OpticalPathIdentifier,d=o.OpticalPathDescription;t.identifier===c&&(e.props.activeOpticalPathIdentifiers.has(c)?i.push((0,b.jsx)(He,{opticalPath:t,metadata:r,isVisible:e.props.visibleOpticalPathIdentifiers.has(c),defaultStyle:e.props.defaultOpticalPathStyles[c],onVisibilityChange:e.props.onOpticalPathVisibilityChange,onStyleChange:e.props.onOpticalPathStyleChange,onRemoval:e.handleItemRemoval,isRemovable:n},"".concat(s,"-").concat(c))):(l=""!==d?"".concat(c," - ").concat(d):"".concat(c),a.push((0,b.jsx)(Xe,{value:c,children:l},c))))}))})),n&&(t=(0,b.jsxs)(se.Z,{align:"center",size:20,style:{padding:"14px"},children:[(0,b.jsx)(oe.Z,{defaultValue:"",style:{width:200},onChange:this.handleItemSelectionChange,value:this.state.selectedOpticalPathIdentifier,allowClear:!0,children:a}),(0,b.jsx)(le.Z,{title:"Add",children:(0,b.jsx)(ce.Z,{icon:(0,b.jsx)(Fe.Z,{}),type:"primary",onClick:this.handleItemAddition})})]})),(0,b.jsxs)(g.Z,{selectable:!1,children:[i,t]})}}]),n}(l.Component);var Qe=["defaultStyle","isVisible","mapping","metadata","onVisibilityChange","onStyleChange"];const Je=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).handleVisibilityChange=a.handleVisibilityChange.bind((0,o.Z)(a)),a.handleOpacityChange=a.handleOpacityChange.bind((0,o.Z)(a)),a.state={isVisible:a.props.isVisible,currentStyle:{opacity:a.props.defaultStyle.opacity}},a}return(0,a.Z)(n,[{key:"handleVisibilityChange",value:function(e,t){this.props.onVisibilityChange({mappingUID:this.props.mapping.uid,isVisible:e}),this.setState({isVisible:e})}},{key:"handleOpacityChange",value:function(e){null!=e&&(this.props.onStyleChange({mappingUID:this.props.mapping.uid,styleOptions:{opacity:e}}),this.setState((function(t){return{currentStyle:{opacity:e}}})))}},{key:"render",value:function(){var e=[{name:"Description",value:this.props.mapping.description}],t=(0,b.jsx)("div",{children:(0,b.jsxs)(de.Z,{justify:"center",align:"middle",children:[(0,b.jsx)(be.Z,{span:6,children:"Opacity"}),(0,b.jsx)(be.Z,{span:12,children:(0,b.jsx)(we.Z,{range:!1,min:0,max:1,step:.01,value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})}),(0,b.jsx)(be.Z,{span:6,children:(0,b.jsx)(pe.Z,{min:0,max:1,size:"small",step:.1,style:{width:"65px"},value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})})]})}),n=this.props,i=(n.defaultStyle,n.isVisible,n.mapping,n.metadata,n.onVisibilityChange,n.onStyleChange,(0,Se.Z)(n,Qe));return(0,b.jsx)(g.Z.Item,(0,E.Z)((0,E.Z)({style:{height:"100%",paddingLeft:"3px"}},i),{},{children:(0,b.jsxs)(se.Z,{align:"start",children:[(0,b.jsx)("div",{style:{paddingLeft:"14px"},children:(0,b.jsx)(se.Z,{direction:"vertical",align:"end",size:100,children:(0,b.jsxs)(se.Z,{direction:"vertical",align:"end",children:[(0,b.jsx)(ge.Z,{size:"small",onChange:this.handleVisibilityChange,checked:this.props.isVisible,checkedChildren:(0,b.jsx)(p.dSq,{}),unCheckedChildren:(0,b.jsx)(p.tgn,{})}),(0,b.jsx)(xe.Z,{placement:"left",content:t,overlayStyle:{width:"350px"},title:"Display Settings",children:(0,b.jsx)(ce.Z,{type:"primary",shape:"circle",icon:(0,b.jsx)(Ze.Z,{})})})]})})}),(0,b.jsx)(x,{header:this.props.mapping.label,attributes:e,selectable:!0,hasLongValues:!0})]})}),this.props.mapping.uid)}}]),n}(l.Component);const $e=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e=this,t=this.props.mappings.map((function(t,n){var i=t.uid;return(0,b.jsx)(Je,{mapping:t,metadata:e.props.metadata[i],isVisible:e.props.visibleMappingUIDs.has(i),defaultStyle:e.props.defaultMappingStyles[i],onVisibilityChange:e.props.onMappingVisibilityChange,onStyleChange:e.props.onMappingStyleChange},t.uid)}));return(0,b.jsx)(g.Z,{selectable:!1,children:t})}}]),n}(l.Component);var et=["defaultStyle","isVisible","segment","metadata","onVisibilityChange","onStyleChange"];const tt=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).handleVisibilityChange=a.handleVisibilityChange.bind((0,o.Z)(a)),a.handleOpacityChange=a.handleOpacityChange.bind((0,o.Z)(a)),a.state={isVisible:a.props.isVisible,currentStyle:{opacity:a.props.defaultStyle.opacity}},a}return(0,a.Z)(n,[{key:"handleVisibilityChange",value:function(e,t){this.props.onVisibilityChange({segmentUID:this.props.segment.uid,isVisible:e}),this.setState({isVisible:e})}},{key:"handleOpacityChange",value:function(e){null!=e&&(this.props.onStyleChange({segmentUID:this.props.segment.uid,styleOptions:{opacity:e}}),this.setState({currentStyle:{opacity:e}}))}},{key:"render",value:function(){var e=[{name:"Property Type",value:this.props.segment.propertyType.CodeMeaning},{name:"Property Category",value:this.props.segment.propertyCategory.CodeMeaning},{name:"Algorithm Name",value:this.props.segment.algorithmName}],t=(0,b.jsx)("div",{children:(0,b.jsxs)(de.Z,{justify:"center",align:"middle",children:[(0,b.jsx)(be.Z,{span:6,children:"Opacity"}),(0,b.jsx)(be.Z,{span:12,children:(0,b.jsx)(we.Z,{range:!1,min:0,max:1,step:.01,value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})}),(0,b.jsx)(be.Z,{span:6,children:(0,b.jsx)(pe.Z,{min:0,max:1,size:"small",step:.1,style:{width:"65px"},value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})})]})}),n=this.props,i=(n.defaultStyle,n.isVisible,n.segment,n.metadata,n.onVisibilityChange,n.onStyleChange,(0,Se.Z)(n,et));return(0,b.jsx)(g.Z.Item,(0,E.Z)((0,E.Z)({style:{height:"100%",paddingLeft:"3px"}},i),{},{children:(0,b.jsxs)(se.Z,{align:"start",children:[(0,b.jsx)("div",{style:{paddingLeft:"14px"},children:(0,b.jsxs)(se.Z,{direction:"vertical",align:"end",children:[(0,b.jsx)(ge.Z,{size:"small",onChange:this.handleVisibilityChange,checked:this.props.isVisible,checkedChildren:(0,b.jsx)(p.dSq,{}),unCheckedChildren:(0,b.jsx)(p.tgn,{})}),(0,b.jsx)(xe.Z,{placement:"left",content:t,overlayStyle:{width:"350px"},title:"Display Settings",children:(0,b.jsx)(ce.Z,{type:"primary",shape:"circle",icon:(0,b.jsx)(Ze.Z,{})})})]})}),(0,b.jsx)(x,{header:this.props.segment.label,attributes:e,selectable:!0,hasLongValues:!0})]})}),this.props.segment.uid)}}]),n}(l.Component);const nt=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"render",value:function(){var e=this,t=this.props.segments.map((function(t,n){var i=t.uid;return(0,b.jsx)(tt,{segment:t,metadata:e.props.metadata[i],isVisible:e.props.visibleSegmentUIDs.has(i),defaultStyle:e.props.defaultSegmentStyles[i],onVisibilityChange:e.props.onSegmentVisibilityChange,onStyleChange:e.props.onSegmentStyleChange},t.uid)}));return(0,b.jsx)(g.Z,{selectable:!1,children:t})}}]),n}(l.Component);function it(e){return function(t){var n=(0,c.TH)(),i=(0,c.s0)(),a=(0,c.UO)();return(0,b.jsx)(e,(0,E.Z)((0,E.Z)({},t),{},{location:n,navigate:i,params:a}))}}var at=n(4942);const ot=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).handleOpacityChange=a.handleOpacityChange.bind((0,o.Z)(a)),a.handleColorRChange=a.handleColorRChange.bind((0,o.Z)(a)),a.handleColorGChange=a.handleColorGChange.bind((0,o.Z)(a)),a.handleColorBChange=a.handleColorBChange.bind((0,o.Z)(a)),a.getCurrentColor=a.getCurrentColor.bind((0,o.Z)(a)),a.state={currentStyle:{opacity:a.props.defaultStyle.opacity,color:a.props.defaultStyle.color,contourOnly:a.props.defaultStyle.contourOnly}},a}return(0,a.Z)(n,[{key:"handleOpacityChange",value:function(e){var t=this;null!=e&&(this.props.annotationGroupsUIDs.forEach((function(n){t.props.onStyleChange({uid:n,styleOptions:{color:t.state.currentStyle.color,opacity:e,contourOnly:t.state.currentStyle.contourOnly}})})),this.updateCurrentStyle({opacity:e}))}},{key:"handleColorRChange",value:function(e){var t=this;if(null!=e&&void 0!==this.state.currentStyle.color){var n=[Array.isArray(e)?e[0]:e,this.state.currentStyle.color[1],this.state.currentStyle.color[2]];this.updateCurrentStyle({color:n}),this.props.annotationGroupsUIDs.forEach((function(e){t.props.onStyleChange({uid:e,styleOptions:{color:n,opacity:t.state.currentStyle.opacity,contourOnly:t.state.currentStyle.contourOnly}})}))}}},{key:"handleColorGChange",value:function(e){var t=this;if(null!=e&&void 0!==this.state.currentStyle.color){var n=[this.state.currentStyle.color[0],Array.isArray(e)?e[0]:e,this.state.currentStyle.color[2]];this.updateCurrentStyle({color:n}),this.props.annotationGroupsUIDs.forEach((function(e){t.props.onStyleChange({uid:e,styleOptions:{color:n,opacity:t.state.currentStyle.opacity,contourOnly:t.state.currentStyle.contourOnly}})}))}}},{key:"handleColorBChange",value:function(e){var t=this;if(null!=e&&void 0!==this.state.currentStyle.color){var n=[this.state.currentStyle.color[0],this.state.currentStyle.color[1],Array.isArray(e)?e[0]:e];this.updateCurrentStyle({color:n}),this.props.annotationGroupsUIDs.forEach((function(e){t.props.onStyleChange({uid:e,styleOptions:{color:n,opacity:t.state.currentStyle.opacity,contourOnly:t.state.currentStyle.contourOnly}})}))}}},{key:"handleShowOutlineOnly",value:function(e){var t=this;this.updateCurrentStyle({contourOnly:e}),this.props.annotationGroupsUIDs.forEach((function(n){t.props.onStyleChange({uid:n,styleOptions:{color:t.state.currentStyle.color,opacity:t.state.currentStyle.opacity,contourOnly:e}})}))}},{key:"getCurrentColor",value:function(){var e;return null!=this.state.currentStyle.color?"#"+(16777216+((e=this.state.currentStyle.color)[0]<<16)+(e[1]<<8)+e[2]).toString(16).slice(1):"white"}},{key:"updateCurrentStyle",value:function(e){var t=e.color,n=e.opacity,i=e.contourOnly;this.setState((function(e){return{currentStyle:{opacity:null!==n&&void 0!==n?n:e.currentStyle.opacity,color:null!==t&&void 0!==t?t:e.currentStyle.color,contourOnly:null!==i&&void 0!==i?i:e.currentStyle.contourOnly}}}))}},{key:"render",value:function(){var e,t=this;return null!=this.state.currentStyle.color&&(e=(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(ue.Z,{plain:!0,children:"Color"}),(0,b.jsxs)(de.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,b.jsx)(be.Z,{span:5,children:"Red"}),(0,b.jsx)(be.Z,{span:14,children:(0,b.jsx)(we.Z,{range:!1,min:0,max:255,step:1,value:this.state.currentStyle.color[0],onChange:this.handleColorRChange})}),(0,b.jsx)(be.Z,{span:5,children:(0,b.jsx)(pe.Z,{min:0,max:255,size:"small",style:{width:"65px"},value:this.state.currentStyle.color[0],onChange:this.handleColorRChange})})]}),(0,b.jsxs)(de.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,b.jsx)(be.Z,{span:5,children:"Green"}),(0,b.jsx)(be.Z,{span:14,children:(0,b.jsx)(we.Z,{range:!1,min:0,max:255,step:1,value:this.state.currentStyle.color[1],onChange:this.handleColorGChange})}),(0,b.jsx)(be.Z,{span:5,children:(0,b.jsx)(pe.Z,{min:0,max:255,size:"small",style:{width:"65px"},value:this.state.currentStyle.color[1],onChange:this.handleColorGChange})})]}),(0,b.jsxs)(de.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,b.jsx)(be.Z,{span:5,children:"Blue"}),(0,b.jsx)(be.Z,{span:14,children:(0,b.jsx)(we.Z,{range:!1,min:0,max:255,step:1,value:this.state.currentStyle.color[2],onChange:this.handleColorBChange})}),(0,b.jsx)(be.Z,{span:5,children:(0,b.jsx)(pe.Z,{min:0,max:255,size:"small",style:{width:"65px"},value:this.state.currentStyle.color[2],onChange:this.handleColorBChange})})]}),(0,b.jsx)(ue.Z,{plain:!0})]})),(0,b.jsxs)("div",{children:[e,(0,b.jsxs)(de.Z,{justify:"start",align:"middle",gutter:[8,8],children:[(0,b.jsx)(be.Z,{span:6,children:"Opacity"}),(0,b.jsx)(be.Z,{span:12,children:(0,b.jsx)(we.Z,{range:!1,min:0,max:1,step:.01,value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})}),(0,b.jsx)(be.Z,{span:6,children:(0,b.jsx)(pe.Z,{min:0,max:1,size:"small",step:.1,style:{width:"65px"},value:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})})]}),(0,b.jsx)(de.Z,{justify:"start",align:"middle",gutter:[8,8],children:(0,b.jsx)(re.Z,{value:this.state.currentStyle.contourOnly,onChange:function(e){return t.handleShowOutlineOnly(e.target.checked)},children:"Show outline only"})})]})}}]),n}(l.Component);var rt=["category","onChange","checkedAnnotationUids","onStyleChange","defaultAnnotationStyles"];const st=function(e){var t=e.category,n=e.onChange,i=e.checkedAnnotationUids,a=e.onStyleChange,o=e.defaultAnnotationStyles,r=(0,Se.Z)(e,rt),s=t.types,l=s.every((function(e){return e.uids.every((function(e){return i.has(e)}))})),c=!l&&s.some((function(e){return e.uids.some((function(e){return i.has(e)}))})),d=function(e){var t=e.type,i=e.isVisible;t.uids.forEach((function(e){n({roiUID:e,isVisible:i})}))};return(0,b.jsx)(g.Z.Item,(0,E.Z)((0,E.Z)({style:{height:"100%",paddingLeft:"3px"}},r),{},{children:(0,b.jsx)(se.Z,{align:"start",children:(0,b.jsxs)("div",{style:{paddingLeft:"14px",color:"black"},children:[(0,b.jsx)(se.Z,{direction:"vertical",align:"end",children:(0,b.jsxs)(re.Z,{indeterminate:c,checked:l,onChange:function(e){var t=e.target.checked;s.forEach((function(e){d({type:e,isVisible:t})}))},children:[(0,b.jsx)(le.Z,{title:"".concat(t.CodeValue,":").concat(t.CodingSchemeDesignator),mouseEnterDelay:1,children:t.CodeMeaning}),(0,b.jsx)(xe.Z,{placement:"topLeft",overlayStyle:{width:"350px"},title:"Display Settings",content:function(){return(0,b.jsx)(ot,{annotationGroupsUIDs:s.reduce((function(e,t){return[].concat((0,ae.Z)(e),(0,ae.Z)(t.uids))}),[]),onStyleChange:a,defaultStyle:o[s[0].uids[0]]})},children:(0,b.jsx)(ce.Z,{type:"primary",shape:"circle",style:{marginLeft:"10px"},icon:(0,b.jsx)(Ze.Z,{})})})]})}),s.map((function(e){var t=e.CodeMeaning,n=e.CodingSchemeDesignator,r=e.CodeValue,s=e.uids,l=t.slice(0,22),c=l===t?t:"".concat(l,"..."),u=s.every((function(e){return i.has(e)})),h=!u&&s.some((function(e){return i.has(e)}));return(0,b.jsxs)("div",{style:{paddingLeft:"25px",width:"100%",display:"flex",flexDirection:"row"},children:[(0,b.jsx)(re.Z,{indeterminate:h,checked:u,onChange:function(t){return d({type:e,isVisible:t.target.checked})}}),(0,b.jsxs)("div",{style:{paddingLeft:"5px"},children:[(0,b.jsx)(le.Z,{title:"".concat(r,":").concat(n),mouseEnterDelay:1,children:c}),(0,b.jsx)(xe.Z,{placement:"topLeft",overlayStyle:{width:"350px"},title:"Display Settings",content:function(){return(0,b.jsx)(ot,{annotationGroupsUIDs:e.uids,onStyleChange:a,defaultStyle:o[e.uids[0]]})},children:(0,b.jsx)(ce.Z,{type:"primary",shape:"circle",style:{marginLeft:"10px"},icon:(0,b.jsx)(Ze.Z,{})})})]})]},"".concat(e.CodingSchemeDesignator,":").concat(e.CodeMeaning))}))]})})}))};const lt=function(e){var t=e.annotations,n=e.onChange,i=e.onStyleChange,a=e.defaultAnnotationStyles,o=e.checkedAnnotationUids,r=function(e){var t=null===e||void 0===e?void 0:e.reduce((function(e,t){var n,i,a=t.category,o=t.type,r=t.uid,s=a.CodeMeaning,l=o.CodeMeaning,c=null!==(n=e[s])&&void 0!==n?n:(0,E.Z)((0,E.Z)({},a),{},{types:{}}),d=null!==(i=c.types[l])&&void 0!==i?i:(0,E.Z)((0,E.Z)({},o),{},{uids:[]});return(0,E.Z)((0,E.Z)({},e),{},(0,at.Z)({},s,(0,E.Z)((0,E.Z)({},c),{},{types:(0,E.Z)((0,E.Z)({},c.types),{},(0,at.Z)({},l,(0,E.Z)((0,E.Z)({},d),{},{uids:[].concat((0,ae.Z)(d.uids),[r])})))})))}),{});return Object.keys(t).forEach((function(e){var n=t[e].types,i=Object.keys(n).map((function(e){return n[e]}));t[e].types=i})),t}(t);if(0===Object.keys(r).length)return(0,b.jsx)(b.Fragment,{});var s=Object.keys(r).map((function(e){var t=r[e];return(0,b.jsx)(st,{category:t,onChange:n,onStyleChange:i,defaultAnnotationStyles:a,checkedAnnotationUids:o},""!==t.CodeMeaning?t.CodeMeaning:"category-".concat(e))}));return(0,b.jsx)(g.Z,{selectable:!1,children:s})};const ct=function(e){var t=e.xPosition,n=e.yPosition,i=e.rois;return(0,b.jsx)("div",{style:{position:"fixed",top:"".concat(n,"px"),left:"".concat(t,"px"),backgroundColor:"rgba(230, 230, 230, 0.65)",minWidth:"150px",minHeight:"60px",padding:"20px",fontWeight:"bold",pointerEvents:"none"},children:i.map((function(e,t){var n=e.attributes;return(0,b.jsxs)("div",{children:[(0,b.jsxs)("span",{children:["ROI ",e.index]}),n.map((function(t){return(0,b.jsxs)("div",{children:[t.name,": ",(0,b.jsx)("span",{style:{fontWeight:500},children:t.value})]},t.name+e.roiUid)}))]},e.roiUid)}))})};var dt=function(e){var t=e.uid,n=e.evaluations,i={category:{CodeValue:"undefined",CodeMeaning:"undefined",CodingSchemeDesignator:"undefined"},type:{CodeValue:"undefined",CodeMeaning:"undefined",CodingSchemeDesignator:"undefined"}};return n.forEach((function(e){var t=e.ConceptNameCodeSequence[0].CodeValue;if(e.ValueType===S.sr.valueTypes.ValueTypes.CODE){var n=e.ConceptCodeSequence[0];"276214006"===t?i.category=(0,E.Z)({},n):"121071"===t&&(i.type=(0,E.Z)({},n))}})),(0,E.Z)((0,E.Z)({},i),{},{uid:t})};const ut=function(e){var t,n,i=e.rois,a=e.metadata,o=e.user,r=e.app,s=e.visibleRoiUIDs,l=a[a.length-1];(null!==(t=null===(n=l.SpecimenDescriptionSequence)||void 0===n?void 0:n.length)&&void 0!==t?t:0)>1&&te.onError(K,new z(F,"More than one specimen has been described for the slide"));var c,d,u,h=l.SpecimenDescriptionSequence[0];(console.debug("create Observation Context"),void 0!==o)?c=new S.sr.templates.PersonObserverIdentifyingAttributes({name:null!==(d=o.name)&&void 0!==d?d:"ANONYMOUS",loginName:null!==(u=o.email)&&void 0!==u?u:""}):(console.warn("no user information available"),c=new S.sr.templates.PersonObserverIdentifyingAttributes({name:"ANONYMOUS"}));var p=new S.sr.templates.ObservationContext({observerPersonContext:new S.sr.templates.ObserverContext({observerType:new S.sr.coding.CodedConcept({value:"121006",schemeDesignator:"DCM",meaning:"Person"}),observerIdentifyingAttributes:c}),observerDeviceContext:new S.sr.templates.ObserverContext({observerType:new S.sr.coding.CodedConcept({value:"121007",schemeDesignator:"DCM",meaning:"Device"}),observerIdentifyingAttributes:new S.sr.templates.DeviceObserverIdentifyingAttributes({uid:r.uid,manufacturerName:"MGH Computational Pathology",modelName:r.name})}),subjectContext:new S.sr.templates.SubjectContext({subjectClass:new S.sr.coding.CodedConcept({value:"121027",schemeDesignator:"DCM",meaning:"Specimen"}),subjectClassSpecificContext:new S.sr.templates.SubjectContextSpecimen({uid:h.SpecimenUID,identifier:h.SpecimenIdentifier,containerIdentifier:l.ContainerIdentifier})})});console.debug("encode Imaging Measurements");for(var v=[],f=0;f<i.length;f++){var m,g=i[f];if(s.has(g.uid)){var y=g.evaluations.find((function(e){return"121071"===e.ConceptNameCodeSequence[0].CodeValue}));void 0===y&&te.onError(K,new z(q,'No finding type was specified for ROI "'.concat(String(g.uid),'"')));var C=new S.sr.templates.TrackingIdentifier({uid:null!==(m=g.properties.trackingUID)&&void 0!==m?m:g.uid,identifier:"ROI #".concat(f+1)}),I=new S.sr.templates.PlanarROIMeasurementsAndQualitativeEvaluations({trackingIdentifier:C,referencedRegion:new S.sr.contentItems.ImageRegion3D({graphicType:g.scoord3d.graphicType,graphicData:g.scoord3d.graphicData,frameOfReferenceUID:g.scoord3d.frameOfReferenceUID}),findingType:new S.sr.coding.CodedConcept({value:y.ConceptCodeSequence[0].CodeValue,schemeDesignator:y.ConceptCodeSequence[0].CodingSchemeDesignator,meaning:y.ConceptCodeSequence[0].CodeMeaning}),qualitativeEvaluations:g.evaluations.filter((function(e){return"121071"!==e.ConceptNameCodeSequence[0].CodeValue})),measurements:g.measurements});I[0].ContentTemplateSequence=[{MappingResource:"DCMR",TemplateIdentifier:"1410"}],v.push.apply(v,(0,ae.Z)(I))}}console.debug("create Measurement Report document content");var b=new S.sr.templates.MeasurementReport({languageOfContentItemAndDescendants:new S.sr.templates.LanguageOfContentItemAndDescendants({}),observationContext:p,procedureReported:new S.sr.coding.CodedConcept({value:"112703",schemeDesignator:"DCM",meaning:"Whole Slide Imaging"}),imagingMeasurements:v});return console.info("create Comprehensive 3D SR document"),{isReportModalVisible:!0,generatedReport:new S.sr.documents.Comprehensive3DSR({content:b[0],evidence:[l],seriesInstanceUID:S.aT.DicomMetaDictionary.uid(),seriesNumber:1,seriesDescription:"Annotation",sopInstanceUID:S.aT.DicomMetaDictionary.uid(),instanceNumber:1,manufacturer:"MGH Computational Pathology",previousVersions:void 0})}};var ht=[255,234,0],pt=[255,234,0,.2],vt=[0,0,0],ft=[[255,0,0],[0,255,0],[0,0,255],[255,255,0],[0,255,255],[0,0,0]],mt=function(e){var t=e.CodingSchemeDesignator,n=e.CodeValue;return"".concat(t,"-").concat(n)},gt=function(e){var t=Me({content:e.evaluations,name:new S.sr.coding.CodedConcept({value:"121071",meaning:"Finding",schemeDesignator:"DCM"})});if(0!==t.length){var n=t[0].ConceptCodeSequence[0];return mt(n)}console.warn("no finding found for ROI ".concat(e.uid))},St=function(e,t){if(e.scoord3d.graphicType!==t.scoord3d.graphicType)return!1;if(e.scoord3d.frameOfReferenceUID!==t.scoord3d.frameOfReferenceUID)return!1;if(e.scoord3d.graphicData.length!==t.scoord3d.graphicData.length)return!1;for(var n=0;n<e.scoord3d.graphicData.length;++n)if("POINT"===e.scoord3d.graphicType){var i=e.scoord3d,a=t.scoord3d;if(i.graphicData[n].toPrecision(6)!==a.graphicData[n].toPrecision(6))return!1}else for(var o=e.scoord3d,r=t.scoord3d,s=0;s<o.graphicData[n].length;++s){if(o.graphicData[n][s].toPrecision(6)!==r.graphicData[n][s].toPrecision(6))return!1}return!0},yt=function(e){var t={color:ht,width:2};null!=e.stroke&&(null!=e.stroke.color&&(t.color=e.stroke.color),null!=e.stroke.width&&(t.width=e.stroke.width));var n={color:pt};return null!=e.fill&&null!=e.fill.color&&(n.color=e.fill.color),{stroke:t,fill:n,image:{circle:{radius:null!=e.radius?e.radius:Math.max(5-t.width,1),stroke:t,fill:n}}}},Ct=function(e){var t=e.clients,n=e.slide,i=e.preload;console.info("instantiate viewer for VOLUME images of slide "+'"'.concat(n.volumeImages[0].ContainerIdentifier,'"'));try{var a,o=new U.viewer.VolumeImageViewer({clientMapping:t,metadata:n.volumeImages,controls:["overview","position"],preload:i,errorInterceptor:function(e){te.onError(H,e)}});return o.activateSelectInteraction({}),n.labelImages.length>0&&(console.info("instantiate viewer for LABEL image of slide "+'"'.concat(n.labelImages[0].ContainerIdentifier,'"')),a=new U.viewer.LabelImageViewer({client:t[M.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE],metadata:n.labelImages[0],resizeFactor:1,orientation:"vertical",errorInterceptor:function(e){te.onError(H,e)}})),{volumeViewer:o,labelViewer:a}}catch(r){throw te.onError(K,new z(F,"Failed to instantiate viewer")),r}},It=function(e){var t=e.ContentTemplateSequence;if(t.length>0&&"1500"===t[0].TemplateIdentifier)return!0;return!1},bt=function(e){var t=Me({content:e.ContentSequence,name:new S.sr.coding.CodedConcept({value:"121024",schemeDesignator:"DCM",meaning:"Subject Class"})});if(0===t.length)return!1;var n=t[0].ConceptCodeSequence[0],i=new S.sr.coding.CodedConcept({value:n.CodeValue,meaning:n.CodeMeaning,schemeDesignator:n.CodingSchemeDesignator}),a=new S.sr.coding.CodedConcept({value:"121027",meaning:"Specimen",schemeDesignator:"DCM"});return!!i.equals(a)},wt=function(e){var t=Me({content:e.ContentSequence,name:new S.sr.coding.CodedConcept({value:"126010",schemeDesignator:"DCM",meaning:"Imaging Measurements"})});if(0===t.length)return!1;var n=t[0],i=Me({content:n.ContentSequence,name:new S.sr.coding.CodedConcept({value:"125007",schemeDesignator:"DCM",meaning:"Measurement Group"})}),a=!1;return i.forEach((function(e){var t=Me({content:e.ContentSequence,name:new S.sr.coding.CodedConcept({value:"111030",schemeDesignator:"DCM",meaning:"Image Region"})});t.length>0&&t[0].ValueType===S.sr.valueTypes.ValueTypes.SCOORD3D&&(a=!0)})),a},xt=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;(0,i.Z)(this,n),(a=t.call(this,e)).findingOptions=[],a.evaluationOptions={},a.measurements=[],a.geometryTypeOptions={},a.volumeViewportRef=void 0,a.labelViewportRef=void 0,a.volumeViewer=void 0,a.labelViewer=void 0,a.hoveredRois=[],a.lastPixel=[0,0],a.defaultRoiStyle={stroke:{color:ht,width:2},fill:{color:pt},image:{circle:{fill:{color:ht},radius:5}}},a.roiStyles={},a.defaultAnnotationStyles={},a.selectionColor=[140,184,198],a.selectedRoiStyle={stroke:{color:[].concat((0,ae.Z)(a.selectionColor),[1]),width:3},fill:{color:[].concat((0,ae.Z)(a.selectionColor),[.2])},image:{circle:{radius:5,fill:{color:[].concat((0,ae.Z)(a.selectionColor),[1])}}}},a.loadPresentationStates=function(){console.info("search for Presentation State instances");var e=a.props.clients[M.ADVANCED_BLENDING_PRESENTATION_STATE];e.searchForInstances({studyInstanceUID:a.props.studyInstanceUID,queryParams:{Modality:"PR"}}).then((function(t){null==t&&(t=[]),t.forEach((function(t,n){var i=U.metadata.formatMetadata(t).dataset;console.info('retrieve PR instance "'.concat(i.SOPInstanceUID,'"')),e.retrieveInstance({studyInstanceUID:a.props.studyInstanceUID,seriesInstanceUID:i.SeriesInstanceUID,sopInstanceUID:i.SOPInstanceUID}).then((function(e){var t=S.aT.DicomMessage.readFile(e),o=U.metadata.formatMetadata(t.dict).dataset;if(a.props.slide.areVolumeImagesMonochrome){var r=o,s=!1;r.AdvancedBlendingSequence.forEach((function(e){s=a.props.slide.seriesInstanceUIDs.includes(e.SeriesInstanceUID)})),s&&(console.info("include Advanced Blending Presentation State instance "+'"'.concat(r.SOPInstanceUID,'"')),(0===n&&null==a.props.selectedPresentationStateUID||r.SOPInstanceUID===a.props.selectedPresentationStateUID)&&a.setPresentationState(r),a.setState((function(e){var t={};return e.presentationStates.forEach((function(e){t[e.SOPInstanceUID]=e})),t[r.SOPInstanceUID]=r,{presentationStates:Object.values(t)}})))}else console.info('ignore presentation state "'.concat(i.SOPInstanceUID,'", ')+"application of presentation states for color images has not (yet) been implemented")})).catch((function(e){te.onError(K,new z(F,"Presentation State could not be loaded")),console.error("failed to load presentation state "+'of SOP instance "'.concat(i.SOPInstanceUID,'" ')+'of series "'.concat(i.SeriesInstanceUID,'" ')+'of study "'.concat(a.props.studyInstanceUID,'": '),e)}))}))})).catch((function(e){console.error(e),te.onError(K,new z(F,"Presentation State could not be loaded"))}))},a.setPresentationState=function(e){var t=a.volumeViewer.getAllOpticalPaths();console.info('apply Presentation State instance "'.concat(e.SOPInstanceUID,'"'));var n={};t.forEach((function(t){var i=t.identifier;a.volumeViewer.hideOpticalPath(i),a.volumeViewer.deactivateOpticalPath(i);var o=a.volumeViewer.getOpticalPathDefaultStyle(i);a.volumeViewer.setOpticalPathStyle(i,o),e.AdvancedBlendingSequence.forEach((function(e){var a=e.ReferencedInstanceSequence;void 0===a&&(a=e.ReferencedImageSequence),void 0!==a&&a.forEach((function(a){if(t.sopInstanceUIDs.includes(a.ReferencedSOPInstanceUID)){var o,r;if(null!=e.PaletteColorLookupTableSequence){var s=e.PaletteColorLookupTableSequence[0];o=new U.color.PaletteColorLookupTable({uid:null!=s.PaletteColorLookupTableUID?s.PaletteColorLookupTableUID:"",redDescriptor:s.RedPaletteColorLookupTableDescriptor,greenDescriptor:s.GreenPaletteColorLookupTableDescriptor,blueDescriptor:s.BluePaletteColorLookupTableDescriptor,redData:null!=s.RedPaletteColorLookupTableData?new Uint16Array(s.RedPaletteColorLookupTableData):void 0,greenData:null!=s.GreenPaletteColorLookupTableData?new Uint16Array(s.GreenPaletteColorLookupTableData):void 0,blueData:null!=s.BluePaletteColorLookupTableData?new Uint16Array(s.BluePaletteColorLookupTableData):void 0,redSegmentedData:null!=s.SegmentedRedPaletteColorLookupTableData?new Uint16Array(s.SegmentedRedPaletteColorLookupTableData):void 0,greenSegmentedData:null!=s.SegmentedGreenPaletteColorLookupTableData?new Uint16Array(s.SegmentedGreenPaletteColorLookupTableData):void 0,blueSegmentedData:null!=s.SegmentedBluePaletteColorLookupTableData?new Uint16Array(s.SegmentedBluePaletteColorLookupTableData):void 0})}if(null!=e.SoftcopyVOILUTSequence){var l=e.SoftcopyVOILUTSequence[0],c=l.WindowCenter,d=l.WindowWidth;r=[c-.5*d,c+.5*d]}n[i]={opacity:1,paletteColorLookupTable:o,limitValues:r}}}))}))}));var i=new Set;Object.keys(n).forEach((function(e){var t=n[e];null!=t?(a.volumeViewer.setOpticalPathStyle(e,t),a.volumeViewer.activateOpticalPath(e),a.volumeViewer.showOpticalPath(e),i.add(e)):(a.volumeViewer.hideOpticalPath(e),a.volumeViewer.deactivateOpticalPath(e))}));var o=new URLSearchParams(a.props.location.search);o.set("state",e.SOPInstanceUID),a.props.navigate({pathname:a.props.location.pathname,search:o.toString()},{replace:!0}),a.setState((function(t){return{activeOpticalPathIdentifiers:i,visibleOpticalPathIdentifiers:i,selectedPresentationStateUID:e.SOPInstanceUID}}))},a.getRoiStyle=function(e){return null==e?a.defaultRoiStyle:void 0!==a.roiStyles[e]?a.roiStyles[e]:a.defaultRoiStyle},a.loadDerivedDataset=function(e){console.debug("Loading derived dataset");if("1.2.840.10008.5.1.4.1.1.88.34"===e.SOPClassUID)a.volumeViewer.getAllROIs().forEach((function(e){a.handleAnnotationVisibilityChange({roiUID:e.uid,isVisible:!0})})),console.debug("Loading Comprehensive 3D SR");else if("1.2.840.10008.5.1.4.1.1.88.24"===e.SOPClassUID){a.volumeViewer.getAllAnnotationGroups().forEach((function(e){a.handleAnnotationGroupVisibilityChange({annotationGroupUID:e.uid,isVisible:!0})})),console.debug("Loading Microscopy Bulk Simple Annotation")}else if("1.2.840.10008.5.1.4.1.1.66.4"===e.SOPClassUID){a.volumeViewer.getAllSegments().forEach((function(e){a.handleSegmentVisibilityChange({segmentUID:e.uid,isVisible:!0})})),console.debug("Loading Segmentation")}else if("1.2.840.10008.5.1.4.1.1.88.22"===e.SOPClassUID){a.volumeViewer.getAllParameterMappings().forEach((function(e){a.handleMappingVisibilityChange({mappingUID:e.uid,isVisible:!0})})),console.debug("Loading Parametric Map")}else if("1.2.840.10008.5.1.4.1.1.88.21"===e.SOPClassUID){a.volumeViewer.getAllOpticalPaths().forEach((function(e){a.handleOpticalPathVisibilityChange({opticalPathIdentifier:e.identifier,isVisible:!0})})),console.debug("Loading Optical Path")}},a.addAnnotationGroups=(0,f.Z)((0,v.Z)().mark((function e(){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e,t){console.info("search for Microscopy Bulk Simple Annotations instances");var n=a.props.clients[M.MICROSCOPY_BULK_SIMPLE_ANNOTATION];n.searchForSeries({studyInstanceUID:a.props.studyInstanceUID,queryParams:{Modality:"ANN"}}).then((function(t){null==t&&(t=[]),t.forEach((function(t){var i=U.metadata.formatMetadata(t).dataset;n.retrieveSeriesMetadata({studyInstanceUID:a.props.studyInstanceUID,seriesInstanceUID:i.SeriesInstanceUID}).then((function(t){t.map((function(e){return new U.metadata.MicroscopyBulkSimpleAnnotations({metadata:e})})).forEach((function(e){try{a.volumeViewer.addAnnotationGroups(e)}catch(t){te.onError(K,new z(F,"Microscopy Bulk Simple Annotations cannot be displayed.")),console.error("failed to add annotation groups:",t)}e.AnnotationGroupSequence.forEach((function(e){var t=e.AnnotationGroupUID,n=e.AnnotationPropertyTypeCodeSequence[0],i=mt(n),o=a.roiStyles[i];null!=o&&null!=o.fill&&a.volumeViewer.setAnnotationGroupStyle(t,{color:o.fill.color})}))})),a.forceUpdate(),e()})).catch((function(e){console.error(e),te.onError(K,new z(F,"Retrieval of metadata of Microscopy Bulk Simple Annotations instances failed."))}))}))})).catch((function(e){console.error(e),te.onError(K,new z(F,"Search for Microscopy Bulk Simple Annotations instances failed.")),t(e instanceof Error?e:new Error(String(e)))}))}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))),a.addSegmentations=(0,f.Z)((0,v.Z)().mark((function e(){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e,t){console.info("search for Segmentation instances");var n=a.props.clients[M.SEGMENTATION];n.searchForSeries({studyInstanceUID:a.props.studyInstanceUID,queryParams:{Modality:"SEG"}}).then((function(t){null==t&&(t=[]),t.forEach((function(t,i){var o=U.metadata.formatMetadata(t).dataset;n.retrieveSeriesMetadata({studyInstanceUID:a.props.studyInstanceUID,seriesInstanceUID:o.SeriesInstanceUID}).then((function(t){var n=[];if(t.forEach((function(e){var t=new U.metadata.Segmentation({metadata:e}),i=a.props.slide.volumeImages[0];t.FrameOfReferenceUID===i.FrameOfReferenceUID&&t.ContainerIdentifier===i.ContainerIdentifier&&n.push(t)})),n.length>0){try{a.volumeViewer.addSegments(n)}catch(i){te.onError(K,new z(F,"Segmentations cannot be displayed")),console.error("failed to add segments: ",i)}a.forceUpdate()}e()})).catch((function(e){console.error(e),te.onError(K,new z(F,"Retrieval of metadata of Segmentation instances failed."))}))}))})).catch((function(e){console.error(e),te.onError(K,new z(F,"Search for Segmentation instances failed.")),t(e instanceof Error?e:new Error(String(e)))}))}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))),a.addParametricMaps=(0,f.Z)((0,v.Z)().mark((function e(){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e,t){console.info("search for Parametric Map instances");var n=a.props.clients[M.PARAMETRIC_MAP];n.searchForSeries({studyInstanceUID:a.props.studyInstanceUID,queryParams:{Modality:"OT"}}).then((function(t){null==t&&(t=[]),t.forEach((function(t){var i=U.metadata.formatMetadata(t).dataset;n.retrieveSeriesMetadata({studyInstanceUID:a.props.studyInstanceUID,seriesInstanceUID:i.SeriesInstanceUID}).then((function(t){var n=[];if(t.forEach((function(e){var t=new U.metadata.ParametricMap({metadata:e}),i=a.props.slide.volumeImages[0];t.FrameOfReferenceUID===i.FrameOfReferenceUID&&t.ContainerIdentifier===i.ContainerIdentifier?n.push(t):console.warn('skip Parametric Map instance "'.concat(t.SOPInstanceUID,'"'))})),n.length>0){try{a.volumeViewer.addParameterMappings(n)}catch(i){te.onError(K,new z(F,"Parametric Map cannot be displayed")),console.error("failed to add mappings: ",i)}a.forceUpdate()}e()})).catch((function(e){console.error(e),te.onError(K,new z(F,"Retrieval of metadata of Parametric Map instances failed."))}))}))})).catch((function(e){console.error(e),te.onError(K,new z(F,"Search for Parametric Map instances failed.")),t(e instanceof Error?e:new Error(String(e)))}))}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))),a.populateViewports=function(){console.info("populate viewports..."),a.setState({isLoading:!0,presentationStates:[]}),null!=a.volumeViewportRef.current&&a.volumeViewer.render({container:a.volumeViewportRef.current}),null!=a.labelViewportRef.current&&null!=a.labelViewer&&a.labelViewer.render({container:a.labelViewportRef.current}),a.setState({isLoading:!1}),a.setDefaultPresentationState(),a.loadPresentationStates(),a.addAnnotations().then((function(){null!=a.props.derivedDataset&&a.loadDerivedDataset(a.props.derivedDataset)})).catch((function(e){console.error("Failed to add annotations:",e)})),a.addAnnotationGroups().then((function(){null!=a.props.derivedDataset&&a.loadDerivedDataset(a.props.derivedDataset)})).catch((function(e){console.error("Failed to add annotation groups:",e)})),a.addSegmentations().then((function(){null!=a.props.derivedDataset&&a.loadDerivedDataset(a.props.derivedDataset)})).catch((function(e){console.error("Failed to add segmentations:",e)})),a.addParametricMaps().then((function(){null!=a.props.derivedDataset&&a.loadDerivedDataset(a.props.derivedDataset)})).catch((function(e){console.error("Failed to add parametric maps:",e)}))},a.onRoiModified=function(e){a.setState((function(e){return{visibleRoiUIDs:new Set(e.visibleRoiUIDs)}}))},a.onWindowResize=function(e){console.info("resize viewports"),a.volumeViewer.resize(),null!=a.labelViewer&&a.labelViewer.resize()},a.onRoiDrawn=function(e){var t=e.detail.payload,n=a.state.selectedFinding,i=a.state.selectedEvaluations;if(void 0!==t&&void 0!==n){console.debug('add ROI "'.concat(t.uid,'"'));var o=new S.sr.valueTypes.CodeContentItem({name:new S.sr.coding.CodedConcept({value:"121071",meaning:"Finding",schemeDesignator:"DCM"}),value:n,relationshipType:"CONTAINS"});t.addEvaluation(o),i.forEach((function(e){var n=new S.sr.valueTypes.CodeContentItem({name:e.name,value:e.value,relationshipType:"CONTAINS"});t.addEvaluation(n)}));var r=mt(n),s=a.getRoiStyle(r);a.volumeViewer.addROI(t,s),a.setState((function(e){var n=e.visibleRoiUIDs;return n.add(t.uid),{visibleRoiUIDs:n}}))}else console.debug('could not add ROI "'.concat(t.uid,'"'))},a.onRoiDoubleClicked=function(e){null!=e.detail.payload?a.setState({isSelectedRoiModalVisible:!0}):a.setState({isSelectedRoiModalVisible:!1})},a.setHoveredRoiAttributes=function(e){var t=a.volumeViewer.getAllROIs();if(0!==t.length){var n=e.map((function(e){var n,i=[];return e.evaluations.forEach((function(e){var t=e.ConceptNameCodeSequence[0].CodeValue,n=e.ConceptNameCodeSequence[0].CodeMeaning,a="".concat(n);if(e.ValueType===S.sr.valueTypes.ValueTypes.CODE){var o=e.ConceptCodeSequence[0].CodeMeaning;"276214006"===t?i.push({name:"Property category",value:"".concat(o)}):"121071"===t?i.push({name:"Property type",value:"".concat(o)}):"111001"===t?i.push({name:"Algorithm Name",value:"".concat(o)}):i.push({name:a,value:"".concat(o)})}else if(e.ValueType===S.sr.valueTypes.ValueTypes.TEXT){var r=e;i.push({name:a,value:r.TextValue})}})),{index:(null!==(n=t.findIndex((function(t){return t.uid===e.uid})))&&void 0!==n?n:0)+1,roiUid:e.uid,attributes:i}}),[]);a.setState({hoveredRoiAttributes:n})}else a.setState({hoveredRoiAttributes:[]})},a.clearHoveredRois=function(){a.hoveredRois=[]},a.getUniqueHoveredRois=function(e){if(null==e)return[];var t=[].concat((0,ae.Z)(a.hoveredRois),[e]);return Array.from(new Set(t.map((function(e){return e.uid})))).map((function(e){return t.find((function(t){return t.uid===e}))})).filter((function(e){return void 0!==e}))},a.isSamePixelAsLast=function(e){return e.clientX===a.lastPixel[0]&&e.clientY===a.lastPixel[1]},a.onPointerMove=function(e){var t=e.detail.payload,n=t.feature,i=t.event.originalEvent;a.isSamePixelAsLast(i)||(a.lastPixel=[i.clientX,i.clientY],a.clearHoveredRois()),a.hoveredRois=a.getUniqueHoveredRois(n),a.hoveredRois.length>0?(a.setHoveredRoiAttributes(a.hoveredRois),a.setState({isHoveredRoiTooltipVisible:!0,hoveredRoiTooltipX:i.clientX,hoveredRoiTooltipY:i.clientY})):a.setState({isHoveredRoiTooltipVisible:!1})},a.onRoiSelected=function(e){var t=e.detail.payload;if(null!=t){console.debug('selected ROI "'.concat(t.uid,'"'));var n=Array.from(a.state.selectedRoiUIDs);a.setState({selectedRoiUIDs:new Set([].concat(n,[t.uid])),selectedRoi:t})}else a.setState({selectedRoiUIDs:new Set,selectedRoi:void 0})},a.onLoadingStarted=function(e){a.setState({isLoading:!0})},a.onLoadingEnded=function(e){a.setState({isLoading:!1})},a.onFrameLoadingStarted=function(e){var t=e.detail.payload,n="".concat(t.sopInstanceUID,"-").concat(t.frameNumber);a.setState((function(e){return e.loadingFrames.add(n),e}))},a.onFrameLoadingError=function(e){console.error("Failed to load frame")},a.onLoadingError=function(e){var t,n,i,a=null!==(t=null===(n=e.detail)||void 0===n||null===(i=n.payload)||void 0===i?void 0:i.message)&&void 0!==t?t:"Failed to load data";console.error(a),te.onError(K,new z(F,a))},a.onFrameLoadingEnded=function(e){var t=e.detail.payload,n="".concat(t.sopInstanceUID,"-").concat(t.frameNumber);if(a.setState((function(e){e.loadingFrames.delete(n);var t=!1;return e.loadingFrames.size>0&&(t=!0),{isLoading:t,loadingFrames:e.loadingFrames}})),t.sopClassUID===M.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE&&a.props.slide.areVolumeImagesMonochrome){var i=t.channelIdentifier;if(!(i in a.state.pixelDataStatistics)&&null!=t.pixelArray){for(var o=Math.pow(2,16),r=Math.ceil(t.pixelArray.length/o),s=0,l=[],c=[],d=0;d<r;d++){s=d*o;var u=t.pixelArray.slice(s,s+o);l.push(Math.min.apply(Math,(0,ae.Z)(u))),c.push(Math.max.apply(Math,(0,ae.Z)(u)))}var h=Math.min.apply(Math,l),p=Math.max.apply(Math,c);a.setState((function(e){var t=e.pixelDataStatistics;if(null!=t[i]?t[i]={min:Math.min(t[i].min,h),max:Math.max(t[i].max,p),numFramesSampled:t[i].numFramesSampled+1}:t[i]={min:h,max:p,numFramesSampled:1},null==e.selectedPresentationStateUID){var n=(0,E.Z)({},a.volumeViewer.getOpticalPathStyle(i));n.limitValues=[t[i].min,t[i].max],a.volumeViewer.setOpticalPathStyle(i,n)}return e}))}}},a.onRoiRemoved=function(e){var t=e.detail.payload;console.debug('removed ROI "'.concat(t.uid,'"'))},a.onKeyUp=function(e){"Escape"===e.key?(a.state.isRoiDrawingActive?(console.info("deactivate drawing of ROIs"),a.volumeViewer.deactivateDrawInteraction(),a.volumeViewer.activateSelectInteraction({})):a.state.isRoiModificationActive?(console.info("deactivate modification of ROIs"),a.volumeViewer.deactivateModifyInteraction(),a.volumeViewer.activateSelectInteraction({})):a.state.isRoiTranslationActive&&(console.info("deactivate modification of ROIs"),a.volumeViewer.deactivateTranslateInteraction(),a.volumeViewer.activateSelectInteraction({})),a.setState({isAnnotationModalVisible:!1,isSelectedRoiModalVisible:!1,isRoiTranslationActive:!1,isRoiDrawingActive:!1,isRoiModificationActive:!1,isGoToModalVisible:!1})):e.altKey&&("KeyD"===e.code?a.handleRoiDrawing():"KeyM"===e.code?a.handleRoiModification():"KeyT"===e.code?a.handleRoiTranslation():"KeyR"===e.code?a.handleRoiRemoval():"KeyV"===e.code?a.handleRoiVisibilityChange():"KeyS"===e.code?a.handleReportGeneration():"KeyG"===e.code&&a.handleGoTo())},a.handleICCProfilesToggle=function(e){var t=e.target.checked;a.setState({isICCProfilesEnabled:t}),a.volumeViewer.toggleICCProfiles()},a.formatAnnotation=function(e){var t,n=a.volumeViewer.getROI(e.uid),i=gt(n),o=void 0!==a.roiStyles[i]?null===(t=a.roiStyles[i].stroke)||void 0===t?void 0:t.color.slice(0,3):ft[Object.keys(a.roiStyles).length%ft.length];a.defaultAnnotationStyles[e.uid]={color:o,opacity:.4,contourOnly:!1},a.roiStyles[i]=a.generateRoiStyle(a.defaultAnnotationStyles[e.uid])},console.info('view slide "'.concat(a.props.slide.containerIdentifier,'": '),a.props.slide);var r=["point","circle","box","polygon","line","freehandpolygon","freehandline"];e.annotations.forEach((function(e){var t=new S.sr.coding.CodedConcept(e.finding);a.findingOptions.push(t);var n=mt(t);void 0!==e.geometryTypes?a.geometryTypeOptions[n]=e.geometryTypes:a.geometryTypeOptions[n]=r,a.evaluationOptions[n]=[],void 0!==e.evaluations&&e.evaluations.forEach((function(e){a.evaluationOptions[n].push({name:new S.sr.coding.CodedConcept(e.name),values:e.values.map((function(e){return new S.sr.coding.CodedConcept(e)}))})})),void 0!==e.measurements&&e.measurements.forEach((function(e){a.measurements.push({name:new S.sr.coding.CodedConcept(e.name),value:void 0,unit:new S.sr.coding.CodedConcept(e.unit)})})),null!=e.style?a.roiStyles[n]=yt(e.style):a.roiStyles[n]=a.defaultRoiStyle})),a.componentSetup=a.componentSetup.bind((0,o.Z)(a)),a.componentCleanup=a.componentCleanup.bind((0,o.Z)(a)),a.onWindowResize=a.onWindowResize.bind((0,o.Z)(a)),a.handleRoiDrawing=a.handleRoiDrawing.bind((0,o.Z)(a)),a.handleRoiTranslation=a.handleRoiTranslation.bind((0,o.Z)(a)),a.handleRoiModification=a.handleRoiModification.bind((0,o.Z)(a)),a.handleRoiVisibilityChange=a.handleRoiVisibilityChange.bind((0,o.Z)(a)),a.handleRoiRemoval=a.handleRoiRemoval.bind((0,o.Z)(a)),a.handleRoiSelectionCancellation=a.handleRoiSelectionCancellation.bind((0,o.Z)(a)),a.handleAnnotationConfigurationCancellation=a.handleAnnotationConfigurationCancellation.bind((0,o.Z)(a)),a.handleAnnotationGeometryTypeSelection=a.handleAnnotationGeometryTypeSelection.bind((0,o.Z)(a)),a.handleAnnotationMeasurementActivation=a.handleAnnotationMeasurementActivation.bind((0,o.Z)(a)),a.handleAnnotationFindingSelection=a.handleAnnotationFindingSelection.bind((0,o.Z)(a)),a.handleAnnotationEvaluationSelection=a.handleAnnotationEvaluationSelection.bind((0,o.Z)(a)),a.handleAnnotationEvaluationClearance=a.handleAnnotationEvaluationClearance.bind((0,o.Z)(a)),a.handleAnnotationConfigurationCompletion=a.handleAnnotationConfigurationCompletion.bind((0,o.Z)(a)),a.handleAnnotationSelection=a.handleAnnotationSelection.bind((0,o.Z)(a)),a.handleAnnotationVisibilityChange=a.handleAnnotationVisibilityChange.bind((0,o.Z)(a)),a.handleAnnotationGroupVisibilityChange=a.handleAnnotationGroupVisibilityChange.bind((0,o.Z)(a)),a.handleAnnotationGroupStyleChange=a.handleAnnotationGroupStyleChange.bind((0,o.Z)(a)),a.handleRoiStyleChange=a.handleRoiStyleChange.bind((0,o.Z)(a)),a.handleGoTo=a.handleGoTo.bind((0,o.Z)(a)),a.handleXCoordinateSelection=a.handleXCoordinateSelection.bind((0,o.Z)(a)),a.handleYCoordinateSelection=a.handleYCoordinateSelection.bind((0,o.Z)(a)),a.handleMagnificationSelection=a.handleMagnificationSelection.bind((0,o.Z)(a)),a.handleSlidePositionSelection=a.handleSlidePositionSelection.bind((0,o.Z)(a)),a.handleSlidePositionSelectionCancellation=a.handleSlidePositionSelectionCancellation.bind((0,o.Z)(a)),a.handleReportGeneration=a.handleReportGeneration.bind((0,o.Z)(a)),a.handleReportVerification=a.handleReportVerification.bind((0,o.Z)(a)),a.handleReportCancellation=a.handleReportCancellation.bind((0,o.Z)(a)),a.handleSegmentVisibilityChange=a.handleSegmentVisibilityChange.bind((0,o.Z)(a)),a.handleSegmentStyleChange=a.handleSegmentStyleChange.bind((0,o.Z)(a)),a.handleMappingVisibilityChange=a.handleMappingVisibilityChange.bind((0,o.Z)(a)),a.handleMappingStyleChange=a.handleMappingStyleChange.bind((0,o.Z)(a)),a.handleOpticalPathVisibilityChange=a.handleOpticalPathVisibilityChange.bind((0,o.Z)(a)),a.handleOpticalPathStyleChange=a.handleOpticalPathStyleChange.bind((0,o.Z)(a)),a.handleOpticalPathActivityChange=a.handleOpticalPathActivityChange.bind((0,o.Z)(a)),a.handlePresentationStateSelection=a.handlePresentationStateSelection.bind((0,o.Z)(a)),a.handlePresentationStateReset=a.handlePresentationStateReset.bind((0,o.Z)(a)),a.handleICCProfilesToggle=a.handleICCProfilesToggle.bind((0,o.Z)(a));var s=Ct({clients:a.props.clients,slide:a.props.slide,preload:a.props.preload}),c=s.volumeViewer,d=s.labelViewer;a.volumeViewer=c,a.labelViewer=d,a.volumeViewportRef=l.createRef(),a.labelViewportRef=l.createRef(),a.volumeViewer.getAllOpticalPaths().forEach((function(e){a.volumeViewer.deactivateOpticalPath(e.identifier)}));var u=(0,m.Z)(a.volumeViewer.boundingBox,2),h=u[0],p=u[1];return a.state={selectedRoiUIDs:new Set,visibleRoiUIDs:new Set,visibleSegmentUIDs:new Set,visibleMappingUIDs:new Set,visibleAnnotationGroupUIDs:new Set,visibleOpticalPathIdentifiers:new Set,activeOpticalPathIdentifiers:new Set,presentationStates:[],selectedFinding:void 0,selectedEvaluations:[],generatedReport:void 0,isLoading:!1,isAnnotationModalVisible:!1,isSelectedRoiModalVisible:!1,isHoveredRoiTooltipVisible:!1,hoveredRoiTooltipX:0,hoveredRoiTooltipY:0,hoveredRoiAttributes:[],isSelectedMagnificationValid:!1,isReportModalVisible:!1,isRoiDrawingActive:!1,isRoiTranslationActive:!1,isRoiModificationActive:!1,isGoToModalVisible:!1,isSelectedXCoordinateValid:!1,isSelectedYCoordinateValid:!1,selectedXCoordinate:void 0,validXCoordinateRange:[h[0],h[0]+p[0]],selectedYCoordinate:void 0,validYCoordinateRange:[h[1],h[1]+p[1]],selectedMagnification:void 0,areRoisHidden:!1,pixelDataStatistics:{},selectedPresentationStateUID:a.props.selectedPresentationStateUID,loadingFrames:new Set,isICCProfilesEnabled:!0},a}return(0,a.Z)(n,[{key:"componentDidUpdate",value:function(e,t){var n=this;if(this.props.location.pathname!==e.location.pathname||this.props.studyInstanceUID!==e.studyInstanceUID||this.props.seriesInstanceUID!==e.seriesInstanceUID||this.props.slide!==e.slide||this.props.clients!==e.clients){null!=this.volumeViewportRef.current&&(this.volumeViewportRef.current.innerHTML=""),this.volumeViewer.cleanup(),null!=this.labelViewer&&(null!=this.labelViewportRef.current&&(this.labelViewportRef.current.innerHTML=""),this.labelViewer.cleanup());var i=Ct({clients:this.props.clients,slide:this.props.slide,preload:this.props.preload}),a=i.volumeViewer,o=i.labelViewer;this.volumeViewer=a,this.labelViewer=o;var r=new Set,s=new Set;this.volumeViewer.getAllOpticalPaths().forEach((function(e){var t=e.identifier;n.volumeViewer.isOpticalPathVisible(t)&&s.add(t),n.volumeViewer.isOpticalPathActive(t)&&r.add(t)}));var l=(0,m.Z)(this.volumeViewer.boundingBox,2),c=l[0],d=l[1];this.setState({visibleRoiUIDs:new Set,visibleSegmentUIDs:new Set,visibleMappingUIDs:new Set,visibleAnnotationGroupUIDs:new Set,visibleOpticalPathIdentifiers:s,activeOpticalPathIdentifiers:r,presentationStates:[],loadingFrames:new Set,validXCoordinateRange:[c[0],c[0]+d[0]],validYCoordinateRange:[c[1],c[1]+d[1]]}),this.populateViewports()}}},{key:"addAnnotations",value:function(){var e=(0,f.Z)((0,v.Z)().mark((function e(){var t=this;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e,n){console.info("search for Comprehensive 3D SR instances");var i=t.props.clients[M.COMPREHENSIVE_3D_SR];i.searchForInstances({studyInstanceUID:t.props.studyInstanceUID,queryParams:{Modality:"SR"}}).then((function(n){null==n&&(n=[]),n.forEach((function(n){var a=U.metadata.formatMetadata(n).dataset;a.SOPClassUID===M.COMPREHENSIVE_3D_SR&&(console.info('retrieve SR instance "'.concat(a.SOPInstanceUID,'"')),i.retrieveInstance({studyInstanceUID:t.props.studyInstanceUID,seriesInstanceUID:a.SeriesInstanceUID,sopInstanceUID:a.SOPInstanceUID}).then((function(n){var i=S.aT.DicomMessage.readFile(n),a=U.metadata.formatMetadata(i.dict).dataset;It(a)?bt(a)?wt(a)?(new Ae(a).ROIs.forEach((function(e){console.info('add ROI "'.concat(e.uid,'"'));var n=e.scoord3d,i=t.props.slide.volumeImages[0];if(n.frameOfReferenceUID===i.FrameOfReferenceUID)if(t.volumeViewer.getAllROIs().some((function(t){return St(t,e)})))console.debug('skip already existing ROI "'.concat(e.uid,'"'));else try{t.volumeViewer.addROI(e,{});var o=dt(e);t.formatAnnotation(o)}catch(r){console.error('could not add ROI "'.concat(e.uid,'"'))}else console.debug('skip ROI "'.concat(e.uid,'" ')+'of SR document "'.concat(a.SOPInstanceUID,'"')+"because it is defined in another frame of reference")})),e()):console.debug('ignore SR document "'.concat(a.SOPInstanceUID,'" ')+"because it does not contain any suitable ROI annotations"):console.debug('ignore SR document "'.concat(a.SOPInstanceUID,'" ')+"because it does not describe a specimen subject"):console.debug('ignore SR document "'.concat(a.SOPInstanceUID,'" ')+'because it is not structured according to template TID 1500 "MeasurementReport"')})).catch((function(e){te.onError(K,new z(F,"Annotations could not be loaded")),console.error("failed to load ROIs "+'of SOP instance "'.concat(a.SOPInstanceUID,'" ')+'of series "'.concat(a.SeriesInstanceUID,'" ')+'of study "'.concat(t.props.studyInstanceUID,'": '),e)})),t.forceUpdate())}))})).catch((function(e){console.error(e),te.onError(K,new z(F,"Annotations could not be loaded")),n(e instanceof Error?e:new Error(String(e)))}))}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},{key:"handleRoiSelectionCancellation",value:function(){this.setState({isSelectedRoiModalVisible:!1})}},{key:"componentCleanup",value:function(){document.body.removeEventListener("dicommicroscopyviewer_roi_drawn",this.onRoiDrawn),document.body.removeEventListener("dicommicroscopyviewer_roi_selected",this.onRoiSelected),document.body.removeEventListener("dicommicroscopyviewer_roi_double_clicked",this.onRoiDoubleClicked),document.body.removeEventListener("dicommicroscopyviewer_pointer_move",this.onPointerMove),document.body.removeEventListener("dicommicroscopyviewer_roi_removed",this.onRoiRemoved),document.body.removeEventListener("dicommicroscopyviewer_roi_modified",this.onRoiModified),document.body.removeEventListener("dicommicroscopyviewer_loading_started",this.onLoadingStarted),document.body.removeEventListener("dicommicroscopyviewer_loading_ended",this.onLoadingEnded),document.body.removeEventListener("dicommicroscopyviewer_frame_loading_started",this.onFrameLoadingStarted),document.body.removeEventListener("dicommicroscopyviewer_frame_loading_ended",this.onFrameLoadingEnded),document.body.removeEventListener("keyup",this.onKeyUp),window.removeEventListener("resize",this.onWindowResize),this.volumeViewer.cleanup(),null!=this.labelViewer&&this.labelViewer.cleanup()}},{key:"componentWillUnmount",value:function(){this.volumeViewer.cleanup(),null!=this.labelViewer&&this.labelViewer.cleanup(),window.removeEventListener("beforeunload",this.componentCleanup)}},{key:"componentSetup",value:function(){document.body.addEventListener("dicommicroscopyviewer_roi_drawn",this.onRoiDrawn),document.body.addEventListener("dicommicroscopyviewer_roi_selected",this.onRoiSelected),document.body.addEventListener("dicommicroscopyviewer_roi_double_clicked",this.onRoiDoubleClicked),document.body.addEventListener("dicommicroscopyviewer_pointer_move",this.onPointerMove),document.body.addEventListener("dicommicroscopyviewer_roi_removed",this.onRoiRemoved),document.body.addEventListener("dicommicroscopyviewer_roi_modified",this.onRoiModified),document.body.addEventListener("dicommicroscopyviewer_loading_started",this.onLoadingStarted),document.body.addEventListener("dicommicroscopyviewer_loading_ended",this.onLoadingEnded),document.body.addEventListener("dicommicroscopyviewer_loading_error",this.onLoadingError),document.body.addEventListener("dicommicroscopyviewer_frame_loading_started",this.onFrameLoadingStarted),document.body.addEventListener("dicommicroscopyviewer_frame_loading_ended",this.onFrameLoadingEnded),document.body.addEventListener("dicommicroscopyviewer_frame_loading_error",this.onFrameLoadingError),document.body.addEventListener("keyup",this.onKeyUp),window.addEventListener("beforeunload",this.componentCleanup),window.addEventListener("resize",this.onWindowResize)}},{key:"componentDidMount",value:function(){if(this.componentSetup(),this.populateViewports(),!this.props.slide.areVolumeImagesMonochrome){var e=!1,t=this.props.slide.volumeImages[0];if(null==t.OpticalPathSequence[0].ICCProfile){if("OpticalPathSequence"in t.bulkdataReferences)"ICCProfile"in t.bulkdataReferences.OpticalPathSequence[0]&&(e=!0)}else e=!0;e||u.ZP.warning("No ICC Profile was found for color images")}}},{key:"handleAnnotationFindingSelection",value:function(e,t){var n=this;this.findingOptions.forEach((function(t){t.CodeValue===e&&(console.info('selected finding "'.concat(t.CodeMeaning,'"')),n.setState({selectedFinding:t,selectedEvaluations:[]}))}))}},{key:"handleAnnotationGeometryTypeSelection",value:function(e,t){this.setState({selectedGeometryType:e})}},{key:"handleAnnotationMeasurementActivation",value:function(e){e.target.checked?this.setState({selectedMarkup:"measurement"}):this.setState({selectedMarkup:void 0})}},{key:"handleAnnotationEvaluationSelection",value:function(e,t){var n=this,i=this.state.selectedFinding;if(void 0!==i){var a=mt(i),o=t.label;this.evaluationOptions[a].forEach((function(t){t.name.CodeValue===o.CodeValue&&t.name.CodingSchemeDesignator===o.CodingSchemeDesignator&&t.values.forEach((function(i){if(i.CodeValue===e){var a=n.state.selectedEvaluations.filter((function(e){return e.name!==t.name}));n.setState({selectedEvaluations:[].concat((0,ae.Z)(a),[{name:o,value:i}])})}}))}))}}},{key:"handleAnnotationEvaluationClearance",value:function(){this.setState({selectedEvaluations:[]})}},{key:"handleXCoordinateSelection",value:function(e){if(null!=e){var t=Number(e),n=this.state.validXCoordinateRange[0],i=this.state.validXCoordinateRange[1];if(t>=n&&t<=i)return void this.setState({selectedXCoordinate:t,isSelectedXCoordinateValid:!0})}this.setState({selectedXCoordinate:void 0,isSelectedXCoordinateValid:!1})}},{key:"handleYCoordinateSelection",value:function(e){if(null!=e){var t=Number(e),n=this.state.validYCoordinateRange[0],i=this.state.validYCoordinateRange[1];if(t>=n&&t<=i)return void this.setState({selectedYCoordinate:t,isSelectedYCoordinateValid:!0})}this.setState({selectedYCoordinate:void 0,isSelectedYCoordinateValid:!1})}},{key:"handleMagnificationSelection",value:function(e){null!=e&&e>0&&e<=40?this.setState({selectedMagnification:Number(e),isSelectedMagnificationValid:!0}):this.setState({selectedMagnification:void 0,isSelectedMagnificationValid:!1})}},{key:"handleSlidePositionSelection",value:function(){if(this.state.isSelectedXCoordinateValid&&this.state.isSelectedYCoordinateValid&&this.state.isSelectedMagnificationValid&&null!=this.state.selectedXCoordinate&&null!=this.state.selectedYCoordinate&&null!=this.state.selectedMagnification){console.info("select slide position "+"(".concat(this.state.selectedXCoordinate,", ")+"".concat(this.state.selectedYCoordinate,") ")+"at ".concat(this.state.selectedMagnification,"x magnification"));for(var e=.01/this.state.selectedMagnification,t=[],n=0;n<this.volumeViewer.numLevels;n++){var i=this.volumeViewer.getPixelSpacing(n)[0];t.push(Math.abs(e-i))}var a=t.indexOf(Math.min.apply(Math,t));this.volumeViewer.navigate({position:[this.state.selectedXCoordinate,this.state.selectedYCoordinate],level:a});var o=new U.scoord3d.Point({coordinates:[this.state.selectedXCoordinate,this.state.selectedYCoordinate,0],frameOfReferenceUID:this.volumeViewer.frameOfReferenceUID}),r=new U.roi.ROI({scoord3d:o});this.volumeViewer.addROI(r,this.defaultRoiStyle),this.setState((function(e){var t=e.visibleRoiUIDs;return t.add(r.uid),{visibleRoiUIDs:t,isGoToModalVisible:!1}}))}}},{key:"handleSlidePositionSelectionCancellation",value:function(){console.log("cancel slide position selection"),this.setState({isGoToModalVisible:!1,isSelectedXCoordinateValid:!1,isSelectedYCoordinateValid:!1,isSelectedMagnificationValid:!1,selectedXCoordinate:void 0,selectedYCoordinate:void 0,selectedMagnification:void 0})}},{key:"handleAnnotationConfigurationCompletion",value:function(){console.debug("complete annotation configuration");var e=this.state.selectedFinding,t=this.state.selectedGeometryType,n=this.state.selectedMarkup;void 0!==t&&void 0!==e?(this.volumeViewer.activateDrawInteraction({geometryType:t,markup:n}),this.setState({isAnnotationModalVisible:!1,isRoiDrawingActive:!0})):te.onError(K,new z(F,"Could not complete annotation configuration"))}},{key:"handleAnnotationConfigurationCancellation",value:function(){console.debug("cancel annotation configuration"),this.setState({isAnnotationModalVisible:!1,isRoiDrawingActive:!1})}},{key:"handleReportGeneration",value:function(){var e=this;console.info("save ROIs");var t=this.volumeViewer.getAllROIs(),n=this.volumeViewer.getAllOpticalPaths(),i=this.volumeViewer.getOpticalPathMetadata(n[0].identifier);this.setState((function(n){var a=ut({rois:t,metadata:i,user:e.props.user,app:e.props.app,visibleRoiUIDs:n.visibleRoiUIDs});return{isReportModalVisible:a.isReportModalVisible,generatedReport:a.generatedReport}}))}},{key:"handleReportVerification",value:function(){console.info("verfied report");var e=this.state.generatedReport;if(void 0!==e){var t=e;console.debug("create File Meta Information");var n=new Uint8Array(2);n[1]=1;var i={"00020001":{Value:[n.buffer],vr:"OB"},"00020002":{Value:[t.SOPClassUID],vr:"UI"},"00020003":{Value:[t.SOPInstanceUID],vr:"UI"},"00020010":{Value:["1.2.840.10008.1.2.1"],vr:"UI"},"00020012":{Value:[this.props.app.uid],vr:"UI"}};console.info("store Comprehensive 3D SR document");var a=new S.aT.DicomDict(i);a.dict=S.aT.DicomMetaDictionary.denaturalizeDataset(t);var o=a.write();this.props.clients[M.COMPREHENSIVE_3D_SR].storeInstances({datasets:[o]}).then((function(e){return u.ZP.info("Annotations were saved.")})).catch((function(e){console.error(e),te.onError(K,new z(q,"Annotations could not be saved"))}))}this.setState({isReportModalVisible:!1,generatedReport:void 0})}},{key:"handleReportCancellation",value:function(){this.setState({isReportModalVisible:!1,generatedReport:void 0})}},{key:"handleAnnotationSelection",value:function(e){var t=this,n=e.roiUID;console.log("selected ROI ".concat(n)),this.setState({selectedRoiUIDs:new Set([n])}),this.volumeViewer.getAllROIs().forEach((function(e){var i={};if(e.uid===n)i=t.selectedRoiStyle,t.setState((function(t){var n=t.visibleRoiUIDs;return n.add(e.uid),{visibleRoiUIDs:n}}));else if(t.state.visibleRoiUIDs.has(e.uid)){var a=gt(e);i=t.getRoiStyle(a)}t.volumeViewer.setROIStyle(e.uid,i)}))}},{key:"handleAnnotationVisibilityChange",value:function(e){var t=e.roiUID;if(e.isVisible){console.info("show ROI ".concat(t));var n=this.volumeViewer.getROI(t),i=gt(n),a=this.getRoiStyle(i);this.volumeViewer.setROIStyle(n.uid,a),this.setState((function(e){var t=e.visibleRoiUIDs;return t.add(n.uid),{visibleRoiUIDs:t}}))}else console.info("hide ROI ".concat(t)),this.setState((function(e){var n=e.selectedRoiUIDs;n.delete(t);var i=e.visibleRoiUIDs;return i.delete(t),{visibleRoiUIDs:i,selectedRoiUIDs:n}})),this.volumeViewer.setROIStyle(t,{})}},{key:"handleAnnotationGroupVisibilityChange",value:function(e){var t=e.annotationGroupUID,n=e.isVisible;if(console.log("change visibility of annotation group ".concat(t)),n){console.info("show annotation group ".concat(t));try{this.volumeViewer.showAnnotationGroup(t)}catch(i){throw te.onError(K,new z(F,"Failed to show annotation group.")),i}this.setState((function(e){var n=new Set(e.visibleAnnotationGroupUIDs);return n.add(t),{visibleAnnotationGroupUIDs:n}}))}else console.info("hide annotation group ".concat(t)),this.volumeViewer.hideAnnotationGroup(t),this.setState((function(e){var n=new Set(e.visibleAnnotationGroupUIDs);return n.delete(t),{visibleAnnotationGroupUIDs:n}}))}},{key:"handleAnnotationGroupStyleChange",value:function(e){var t=e.uid,n=e.styleOptions;console.log("change style of annotation group ".concat(t));try{this.volumeViewer.setAnnotationGroupStyle(t,n)}catch(i){throw te.onError(K,new z(F,"Failed to change style of annotation group.")),i}}},{key:"generateRoiStyle",value:function(e){var t,n,i,a=null!==(t=e.opacity)&&void 0!==t?t:.4,o=null!==(n=e.color)&&void 0!==n?n:vt,r=e.contourOnly?[0,0,0,0]:o.map((function(e){return Math.min(e+25,255)}));return yt({fill:{color:[].concat((0,ae.Z)(r),[a])},stroke:{color:[].concat((0,ae.Z)(o),[a])},radius:null===(i=this.defaultRoiStyle.stroke)||void 0===i?void 0:i.width})}},{key:"handleRoiStyleChange",value:function(e){var t=e.uid,n=e.styleOptions;console.log("change style of ROI ".concat(t));try{this.defaultAnnotationStyles[t]=n;var i=this.generateRoiStyle(n),a=this.volumeViewer.getROI(t),o=gt(a);this.roiStyles[o]=i,this.volumeViewer.setROIStyle(t,i),this.state.visibleRoiUIDs.add(t)}catch(r){throw te.onError(K,new z(F,"Failed to change style of ROI.")),r}}},{key:"handleSegmentVisibilityChange",value:function(e){var t=e.segmentUID,n=e.isVisible;console.log("change visibility of segment ".concat(t)),n?(console.info("show segment ".concat(t)),this.volumeViewer.showSegment(t),this.setState((function(e){var n=new Set(e.visibleSegmentUIDs);return n.add(t),{visibleSegmentUIDs:n}}))):(console.info("hide segment ".concat(t)),this.volumeViewer.hideSegment(t),this.setState((function(e){var n=new Set(e.visibleSegmentUIDs);return n.delete(t),{visibleSegmentUIDs:n}})))}},{key:"handleSegmentStyleChange",value:function(e){var t=e.segmentUID,n=e.styleOptions;console.log("change style of segment ".concat(t)),this.volumeViewer.setSegmentStyle(t,n)}},{key:"handleMappingVisibilityChange",value:function(e){var t=e.mappingUID,n=e.isVisible;console.log("change visibility of mapping ".concat(t)),n?(console.info("show mapping ".concat(t)),this.volumeViewer.showParameterMapping(t),this.setState((function(e){var n=new Set(e.visibleMappingUIDs);return n.add(t),{visibleMappingUIDs:n}}))):(console.info("hide mapping ".concat(t)),this.volumeViewer.hideParameterMapping(t),this.setState((function(e){var n=new Set(e.visibleMappingUIDs);return n.delete(t),{visibleMappingUIDs:n}})))}},{key:"handleMappingStyleChange",value:function(e){var t=e.mappingUID,n=e.styleOptions;console.log("change style of mapping ".concat(t)),this.volumeViewer.setParameterMappingStyle(t,n)}},{key:"handleOpticalPathVisibilityChange",value:function(e){var t=e.opticalPathIdentifier,n=e.isVisible;console.log("change visibility of optical path ".concat(t)),n?(console.info("show optical path ".concat(t)),this.volumeViewer.showOpticalPath(t),this.setState((function(e){var n=new Set(e.visibleOpticalPathIdentifiers);return n.add(t),{visibleOpticalPathIdentifiers:n}}))):(console.info("hide optical path ".concat(t)),this.volumeViewer.hideOpticalPath(t),this.setState((function(e){var n=new Set(e.visibleOpticalPathIdentifiers);return n.delete(t),{visibleOpticalPathIdentifiers:n}})))}},{key:"handleOpticalPathStyleChange",value:function(e){var t=e.opticalPathIdentifier,n=e.styleOptions;console.log("change style of optical path ".concat(t)),this.volumeViewer.setOpticalPathStyle(t,n)}},{key:"handleOpticalPathActivityChange",value:function(e){var t=e.opticalPathIdentifier,n=e.isActive;console.log("change activity of optical path ".concat(t)),n?(console.info("activate optical path ".concat(t)),this.volumeViewer.activateOpticalPath(t),this.setState((function(e){var n=new Set(e.activeOpticalPathIdentifiers);return n.add(t),{activeOpticalPathIdentifiers:n}}))):(console.info("deactivate optical path ".concat(t)),this.volumeViewer.deactivateOpticalPath(t),this.setState((function(e){var n=new Set(e.activeOpticalPathIdentifiers);return n.delete(t),{activeOpticalPathIdentifiers:n}})))}},{key:"setDefaultPresentationState",value:function(){var e=this,t=new Set,n=this.volumeViewer.getAllOpticalPaths();if(n.sort((function(e,t){return 1===e.identifier.localeCompare(t.identifier)?1:1===t.identifier.localeCompare(e.identifier)?-1:0})),n.forEach((function(n){var i=n.identifier,a=e.volumeViewer.getOpticalPathDefaultStyle(i);e.volumeViewer.setOpticalPathStyle(i,a),e.volumeViewer.hideOpticalPath(i),e.volumeViewer.deactivateOpticalPath(i),n.isMonochromatic?null!=n.paletteColorLookupTableUID&&t.add(i):t.add(i)})),0===t.size){var i=[[255,255,255]];n.forEach((function(n){var a=n.identifier;if(n.isMonochromatic){var o=t.size;if(o<i.length){var r=(0,E.Z)({},e.volumeViewer.getOpticalPathStyle(a)),s=o;r.color=i[s];var l=e.state.pixelDataStatistics[n.identifier];null!=l&&(r.limitValues=[l.min,l.max]),e.volumeViewer.setOpticalPathStyle(n.identifier,r),t.add(n.identifier)}}}))}console.info("selected n=".concat(t.size," optical paths ")+"for visualization"),t.forEach((function(t){e.volumeViewer.showOpticalPath(t)})),this.setState((function(e){return{activeOpticalPathIdentifiers:new Set(t),visibleOpticalPathIdentifiers:new Set(t)}}))}},{key:"handlePresentationStateReset",value:function(){this.setState({selectedPresentationStateUID:void 0});var e=this.props.location.pathname;this.props.navigate(e),this.setDefaultPresentationState()}},{key:"handlePresentationStateSelection",value:function(e,t){var n;if(null!=e)if(console.info('select Presentation State instance "'.concat(e,'"')),this.state.presentationStates.forEach((function(t){t.SOPInstanceUID===e&&(n=t)})),null!=n){var i=this.props.location.pathname;i+="?state=".concat(e),this.props.navigate(i),this.setPresentationState(n)}else te.onError(K,new z(F,"Presentation State could not be found")),console.log("failed to handle section of presentation state: "+'could not find instance "'.concat(e,'"'));else this.handlePresentationStateReset();this.setState({selectedPresentationStateUID:e})}},{key:"handleRoiDrawing",value:function(){this.state.isRoiDrawingActive?(console.info("deactivate drawing of ROIs"),this.volumeViewer.deactivateDrawInteraction(),this.volumeViewer.activateSelectInteraction({}),this.setState({isAnnotationModalVisible:!1,isSelectedRoiModalVisible:!1,isRoiTranslationActive:!1,isRoiDrawingActive:!1,isRoiModificationActive:!1,isGoToModalVisible:!1})):(console.info("activate drawing of ROIs"),this.setState({isAnnotationModalVisible:!0,isSelectedRoiModalVisible:!1,isRoiDrawingActive:!0,isRoiModificationActive:!1,isRoiTranslationActive:!1,isGoToModalVisible:!1}),this.volumeViewer.deactivateSelectInteraction(),this.volumeViewer.deactivateSnapInteraction(),this.volumeViewer.deactivateTranslateInteraction(),this.volumeViewer.deactivateModifyInteraction())}},{key:"handleRoiModification",value:function(){console.info("toggle modification of ROIs"),this.volumeViewer.isModifyInteractionActive?(this.volumeViewer.deactivateModifyInteraction(),this.volumeViewer.deactivateSnapInteraction(),this.volumeViewer.activateSelectInteraction({}),this.setState({isRoiTranslationActive:!1,isRoiDrawingActive:!1,isRoiModificationActive:!1})):(this.setState({isRoiModificationActive:!0,isRoiDrawingActive:!1,isRoiTranslationActive:!1}),this.volumeViewer.deactivateDrawInteraction(),this.volumeViewer.deactivateTranslateInteraction(),this.volumeViewer.deactivateSelectInteraction(),this.volumeViewer.activateSnapInteraction({}),this.volumeViewer.activateModifyInteraction({}))}},{key:"handleRoiTranslation",value:function(){console.info("toggle translation of ROIs"),this.volumeViewer.isTranslateInteractionActive?(this.volumeViewer.deactivateTranslateInteraction(),this.setState({isRoiTranslationActive:!1,isRoiDrawingActive:!1,isRoiModificationActive:!1})):(this.setState({isRoiTranslationActive:!0,isRoiDrawingActive:!1,isRoiModificationActive:!1}),this.volumeViewer.deactivateModifyInteraction(),this.volumeViewer.deactivateSnapInteraction(),this.volumeViewer.deactivateDrawInteraction(),this.volumeViewer.deactivateSelectInteraction(),this.volumeViewer.activateTranslateInteraction({}))}},{key:"handleGoTo",value:function(){this.volumeViewer.deactivateDrawInteraction(),this.volumeViewer.deactivateModifyInteraction(),this.volumeViewer.deactivateSnapInteraction(),this.volumeViewer.deactivateTranslateInteraction(),this.volumeViewer.deactivateSelectInteraction(),this.setState({isGoToModalVisible:!0,isAnnotationModalVisible:!1,isSelectedRoiModalVisible:!1,isReportModalVisible:!1,isRoiTranslationActive:!1,isRoiModificationActive:!1,isRoiDrawingActive:!1})}},{key:"handleRoiRemoval",value:function(){var e=this;this.volumeViewer.deactivateDrawInteraction(),this.volumeViewer.deactivateSnapInteraction(),this.volumeViewer.deactivateTranslateInteraction(),this.volumeViewer.deactivateModifyInteraction(),this.state.selectedRoiUIDs.size>0?(this.state.selectedRoiUIDs.forEach((function(t){void 0!==t?(console.info('remove ROI "'.concat(t,'"')),e.volumeViewer.removeROI(t),u.ZP.info("Annotation was removed")):u.ZP.warning("No annotation was selected for removal")})),this.setState({selectedRoiUIDs:new Set,isRoiTranslationActive:!1,isRoiDrawingActive:!1,isRoiModificationActive:!1})):(this.state.visibleRoiUIDs.forEach((function(t){console.info('remove ROI "'.concat(t,'"')),e.volumeViewer.removeROI(t)})),this.setState({visibleRoiUIDs:new Set,isRoiTranslationActive:!1,isRoiDrawingActive:!1,isRoiModificationActive:!1})),this.volumeViewer.activateSelectInteraction({})}},{key:"handleRoiVisibilityChange",value:function(){var e=this;console.info("toggle visibility of ROIs"),this.state.areRoisHidden?(this.volumeViewer.showROIs(),this.volumeViewer.activateSelectInteraction({}),this.state.selectedRoiUIDs.forEach((function(t){void 0!==t&&e.volumeViewer.setROIStyle(t,e.selectedRoiStyle)})),this.setState({areRoisHidden:!1})):(this.volumeViewer.deactivateDrawInteraction(),this.volumeViewer.deactivateSnapInteraction(),this.volumeViewer.deactivateTranslateInteraction(),this.volumeViewer.deactivateSelectInteraction(),this.volumeViewer.deactivateModifyInteraction(),this.volumeViewer.hideROIs(),this.setState({areRoisHidden:!0,isRoiDrawingActive:!1,isRoiModificationActive:!1,isRoiTranslationActive:!1}))}},{key:"render",value:function(){var e,t=this,n=[],i=[],a=[],o=[];n.push.apply(n,(0,ae.Z)(this.volumeViewer.getAllROIs())),i.push.apply(i,(0,ae.Z)(this.volumeViewer.getAllSegments())),a.push.apply(a,(0,ae.Z)(this.volumeViewer.getAllParameterMappings()));var r=this.volumeViewer.getAllAnnotationGroups(),s=null===r||void 0===r?void 0:r.filter((function(e){return e.referencedSeriesInstanceUID===t.props.seriesInstanceUID}));o.push.apply(o,(0,ae.Z)(s));var c,d,u=n.map((function(e){return dt(e)})),v=["specimens","optical-paths","annotations","presentation-states"],f=this.state.generatedReport;void 0!==f&&(c=(0,b.jsx)(Te,{dataset:f})),n.length>0&&(d=(0,b.jsx)(Ie,{rois:n,selectedRoiUIDs:this.state.selectedRoiUIDs,visibleRoiUIDs:this.state.visibleRoiUIDs,onSelection:this.handleAnnotationSelection,onVisibilityChange:this.handleAnnotationVisibilityChange}));var m=this.findingOptions.map((function(e,t){return(0,b.jsx)(oe.Z.Option,{value:e.CodeValue,children:e.CodeMeaning},void 0!==e.CodeValue&&""!==e.CodeValue?e.CodeValue:"finding-".concat(t))})),y={point:(0,b.jsx)(oe.Z.Option,{value:"point",children:"Point"},"point"),circle:(0,b.jsx)(oe.Z.Option,{value:"circle",children:"Circle"},"circle"),box:(0,b.jsx)(oe.Z.Option,{value:"box",children:"Box"},"box"),polygon:(0,b.jsx)(oe.Z.Option,{value:"polygon",children:"Polygon"},"polygon"),line:(0,b.jsx)(oe.Z.Option,{value:"line",children:"Line"},"line"),freehandpolygon:(0,b.jsx)(oe.Z.Option,{value:"freehandpolygon",children:"Polygon (freehand)"},"freehandpolygon"),freehandline:(0,b.jsx)(oe.Z.Option,{value:"freehandline",children:"Line (freehand)"},"freehandline")},I=[(0,b.jsx)(oe.Z,{style:{minWidth:130},onSelect:this.handleAnnotationFindingSelection,defaultActiveFirstOption:!0,placeholder:"Select finding",children:m},"annotation-finding")],w=this.state.selectedFinding;if(void 0!==w){var x=mt(w);this.evaluationOptions[x].forEach((function(e,n){var i=e.values.map((function(t){return(0,b.jsx)(oe.Z.Option,{value:t.CodeValue,label:e.name,children:t.CodeMeaning},void 0!==t.CodeValue&&""!==t.CodeValue?t.CodeValue:"evaluation-".concat(n))}));I.push((0,b.jsxs)(b.Fragment,{children:[e.name.CodeMeaning,(0,b.jsx)(oe.Z,{style:{minWidth:130},onSelect:t.handleAnnotationEvaluationSelection,allowClear:!0,onClear:t.handleAnnotationEvaluationClearance,defaultActiveFirstOption:!1,children:i})]}))}));var D=this.geometryTypeOptions[x].map((function(e){return y[e]}));I.push((0,b.jsxs)(b.Fragment,{children:["ROI geometry type",(0,b.jsx)(oe.Z,{style:{minWidth:130},onSelect:this.handleAnnotationGeometryTypeSelection,placeholder:"Select geometry type",children:D},"annotation-geometry-type")]})),I.push((0,b.jsx)(re.Z,{onChange:this.handleAnnotationMeasurementActivation,children:"measure"},"annotation-measurement"))}var Z=(0,b.jsx)(g.Z.SubMenu,{title:"Specimens",children:(0,b.jsx)(qe,{metadata:this.props.slide.volumeImages[0],showstain:!1})},"specimens"),V=(0,b.jsx)(g.Z.SubMenu,{title:"Equipment",children:(0,b.jsx)(Pe,{metadata:this.props.slide.volumeImages[0]})},"equipment"),O=this.volumeViewer.getAllOpticalPaths();O.sort((function(e,t){return 1===e.identifier.localeCompare(t.identifier)?1:1===t.identifier.localeCompare(e.identifier)?-1:0}));var R={},j={};O.forEach((function(e){var n=e.identifier,i=t.volumeViewer.getOpticalPathMetadata(n);j[n]=i;var a=(0,E.Z)({},t.volumeViewer.getOpticalPathStyle(n));R[n]=a}));var P,M,U,A,T,k=(0,b.jsx)(g.Z.SubMenu,{title:"Optical Paths",children:(0,b.jsx)(Ke,{metadata:j,opticalPaths:O,defaultOpticalPathStyles:R,visibleOpticalPathIdentifiers:this.state.visibleOpticalPathIdentifiers,activeOpticalPathIdentifiers:this.state.activeOpticalPathIdentifiers,onOpticalPathVisibilityChange:this.handleOpticalPathVisibilityChange,onOpticalPathStyleChange:this.handleOpticalPathStyleChange,onOpticalPathActivityChange:this.handleOpticalPathActivityChange,selectedPresentationStateUID:this.state.selectedPresentationStateUID})},"optical-paths");if(this.state.presentationStates.length>0){var L=[];this.state.presentationStates.forEach((function(e,t){L.push((0,b.jsx)(oe.Z.Option,{value:e.SOPInstanceUID,dropdownMatchSelectWidth:!1,size:"small",children:void 0!==e.ContentDescription&&""!==e.ContentDescription?e.ContentDescription:"Untitled"},void 0!==e.SOPInstanceUID&&""!==e.SOPInstanceUID?e.SOPInstanceUID:"presentation-state-".concat(t)))})),L.push((0,b.jsx)(oe.Z.Option,{value:void 0,dropdownMatchSelectWidth:!1,size:"small",children:(0,b.jsx)(b.Fragment,{})},"default-presentation-state")),P=(0,b.jsx)(g.Z.SubMenu,{title:"Presentation States",children:(0,b.jsxs)(se.Z,{align:"center",size:20,style:{padding:"14px"},children:[(0,b.jsx)(oe.Z,{style:{minWidth:200,maxWidth:200},onSelect:this.handlePresentationStateSelection,value:this.state.selectedPresentationStateUID,children:L},"presentation-states"),(0,b.jsx)(le.Z,{title:"Reset",children:(0,b.jsx)(ce.Z,{icon:(0,b.jsx)(ve.Z,{}),type:"primary",onClick:this.handlePresentationStateReset})})]})},"presentation-states")}if(i.length>0){var _={},N={},G=this.volumeViewer.getAllSegments();G.forEach((function(e){_[e.uid]=t.volumeViewer.getSegmentStyle(e.uid),N[e.uid]=t.volumeViewer.getSegmentMetadata(e.uid)})),M=(0,b.jsx)(g.Z.SubMenu,{title:"Segmentations",children:(0,b.jsx)(nt,{segments:G,metadata:N,defaultSegmentStyles:_,visibleSegmentUIDs:this.state.visibleSegmentUIDs,onSegmentVisibilityChange:this.handleSegmentVisibilityChange,onSegmentStyleChange:this.handleSegmentStyleChange})},"segmentations"),v.push("segmentations")}if(a.length>0){var q={},F={};a.forEach((function(e){q[e.uid]=t.volumeViewer.getParameterMappingStyle(e.uid),F[e.uid]=t.volumeViewer.getParameterMappingMetadata(e.uid)})),U=(0,b.jsx)(g.Z.SubMenu,{title:"Parametric Maps",children:(0,b.jsx)($e,{mappings:a,metadata:F,defaultMappingStyles:q,visibleMappingUIDs:this.state.visibleMappingUIDs,onMappingVisibilityChange:this.handleMappingVisibilityChange,onMappingStyleChange:this.handleMappingStyleChange})},"parmetric-maps"),v.push("parametric-maps")}if(null===u||void 0===u||null===(e=u.forEach)||void 0===e||e.call(u,this.formatAnnotation.bind(this)),o.length>0){var z={},B={};o.forEach((function(e){B[e.uid]=t.volumeViewer.getAnnotationGroupStyle(e.uid),z[e.uid]=t.volumeViewer.getAnnotationGroupMetadata(e.uid)})),A=(0,b.jsx)(g.Z.SubMenu,{title:"Annotation Groups",children:(0,b.jsx)(Re,{annotationGroups:o,metadata:z,defaultAnnotationGroupStyles:B,visibleAnnotationGroupUIDs:this.state.visibleAnnotationGroupUIDs,onAnnotationGroupVisibilityChange:this.handleAnnotationGroupVisibilityChange,onAnnotationGroupStyleChange:this.handleAnnotationGroupStyleChange})},"annotation-groups"),v.push("annotationGroups")}var W="0px",Y=[(0,b.jsx)(je,{tooltip:"Draw ROI [Alt+D]",icon:p.vuA,onClick:this.handleRoiDrawing,isSelected:this.state.isRoiDrawingActive},"draw-roi-button"),(0,b.jsx)(je,{tooltip:"Modify ROIs [Alt+M]",icon:p.eAi,onClick:this.handleRoiModification,isSelected:this.state.isRoiModificationActive},"modify-roi-button"),(0,b.jsx)(je,{tooltip:"Translate ROIs [Alt+T]",icon:p.Jd7,onClick:this.handleRoiTranslation,isSelected:this.state.isRoiTranslationActive},"translate-roi-button"),(0,b.jsx)(je,{tooltip:"Remove selected ROI [Alt+R]",onClick:this.handleRoiRemoval,icon:p.Xm5},"remove-roi-button"),(0,b.jsx)(je,{tooltip:"Show/Hide ROIs [Alt+V]",icon:this.state.areRoisHidden?p.dSq:p.tgn,onClick:this.handleRoiVisibilityChange,isSelected:this.state.areRoisHidden},"toggle-roi-visibility-button"),(0,b.jsx)(je,{tooltip:"Save ROIs [Alt+S]",icon:p.TvB,onClick:this.handleReportGeneration},"generate-report-button")],H=[(0,b.jsx)(je,{tooltip:"Go to [Alt+G]",icon:p.Xe,onClick:this.handleGoTo},"go-to-slide-position-button")];this.props.enableAnnotationTools&&(T=(0,b.jsxs)(de.Z,{justify:"start",children:[Y.map((function(e,t){return(0,b.jsx)(l.Fragment,{children:e},t)})),H.map((function(e,t){return(0,b.jsx)(l.Fragment,{children:e},t)}))]}),W="50px");var X,K="default";if(this.state.isLoading&&(K="progress"),null!=this.state.selectedRoi){var Q=[{name:"UID",value:this.state.selectedRoi.uid}],J=[{name:"Graphic type",value:this.state.selectedRoi.scoord3d.graphicType}],$=[];this.state.selectedRoi.evaluations.forEach((function(e){if("CODE"===e.ValueType){var t=e;$.push({name:t.ConceptNameCodeSequence[0].CodeMeaning,value:t.ConceptCodeSequence[0].CodeMeaning})}else{var n=e;$.push({name:n.ConceptNameCodeSequence[0].CodeMeaning,value:n.TextValue})}}));var ee={};this.state.selectedRoi.measurements.forEach((function(e){var t="default";if(null!=e.ContentSequence){var n=Me({content:e.ContentSequence,name:new S.sr.coding.CodedConcept({value:"121112",meaning:"Source of Measurement",schemeDesignator:"DCM"})});n.length>0&&(t=n[0].ReferencedSOPSequence[0].ReferencedOpticalPathIdentifier)}t in ee||(ee[t]=[]);var i=e.MeasuredValueSequence[0];ee[t].push({name:e.ConceptNameCodeSequence[0].CodeMeaning,value:i.NumericValue.toString(),unit:i.MeasurementUnitsCodeSequence[0].CodeMeaning})}));var te=function(e){return e.map((function(e){var t;return t=null!=e.unit?"".concat(e.value," [").concat(e.unit,"]"):e.value,(0,b.jsx)(C.Z.Item,{label:e.name,children:t},e.name)}))},ne=te(Q),ie=te(J),ge=te($),Se=[];for(var ye in ee){var Ce=te(ee[ye]);"default"===ye?Se.push(Ce):Se.push((0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(ue.Z,{orientation:"left",orientationMargin:0,dashed:!0,plain:!0,children:ye}),Ce]}))}X=(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(C.Z,{layout:"horizontal",column:1,children:ne}),(0,b.jsx)(ue.Z,{orientation:"left",orientationMargin:0,children:"Spatial coordinates"}),(0,b.jsx)(C.Z,{layout:"horizontal",column:1,children:ie}),(0,b.jsx)(ue.Z,{orientation:"left",orientationMargin:0,children:"Evaluations"}),(0,b.jsx)(C.Z,{layout:"horizontal",column:1,children:ge}),(0,b.jsx)(ue.Z,{orientation:"left",orientationMargin:0,children:"Measurements"}),(0,b.jsx)(C.Z,{layout:"horizontal",column:1,children:Se})]})}var be=this.volumeViewer.getICCProfiles().length>0&&(0,b.jsx)("div",{style:{margin:"0.9rem"},children:(0,b.jsx)(re.Z,{checked:this.state.isICCProfilesEnabled,onChange:this.handleICCProfilesToggle,children:"ICC Profiles"})});return(0,b.jsxs)(h.Z,{style:{height:"100%"},hasSider:!0,children:[(0,b.jsxs)(h.Z.Content,{style:{height:"100%"},children:[T,(0,b.jsx)("div",{style:{height:"calc(100% - ".concat(W,")"),overflow:"hidden",cursor:K},ref:this.volumeViewportRef}),(0,b.jsx)(he.Z,{open:this.state.isAnnotationModalVisible,title:"Configure annotations",onOk:this.handleAnnotationConfigurationCompletion,okButtonProps:{disabled:!(void 0!==this.state.selectedFinding&&void 0!==this.state.selectedGeometryType)},onCancel:this.handleAnnotationConfigurationCancellation,okText:"Select",children:(0,b.jsx)(se.Z,{align:"start",direction:"vertical",children:I})}),(0,b.jsx)(he.Z,{open:this.state.isSelectedRoiModalVisible,title:"Selected ROI",onCancel:this.handleRoiSelectionCancellation,maskClosable:!0,footer:null,children:(0,b.jsx)(se.Z,{align:"start",direction:"vertical",children:X})}),(0,b.jsx)(he.Z,{open:this.state.isGoToModalVisible,title:"Go to slide position",onOk:this.handleSlidePositionSelection,onCancel:this.handleSlidePositionSelectionCancellation,okText:"Select",children:(0,b.jsxs)(se.Z,{align:"start",direction:"vertical",children:[(0,b.jsx)(pe.Z,{placeholder:"["+"".concat(this.state.validXCoordinateRange[0])+", "+"".concat(this.state.validXCoordinateRange[1])+"]",prefix:"X Coordinate [mm]",onChange:this.handleXCoordinateSelection,onPressEnter:this.handleXCoordinateSelection,controls:!1,addonAfter:this.state.isSelectedXCoordinateValid?(0,b.jsx)(fe.Z,{style:{color:"rgba(0,0,0,.45)"}}):(0,b.jsx)(me.Z,{style:{color:"rgba(0,0,0,.45)"}})}),(0,b.jsx)(pe.Z,{placeholder:"["+"".concat(this.state.validYCoordinateRange[0])+", "+"".concat(this.state.validYCoordinateRange[1])+"]",prefix:"Y Coordinate [mm]",onChange:this.handleYCoordinateSelection,onPressEnter:this.handleYCoordinateSelection,controls:!1,addonAfter:this.state.isSelectedYCoordinateValid?(0,b.jsx)(fe.Z,{style:{color:"rgba(0,0,0,.45)"}}):(0,b.jsx)(me.Z,{style:{color:"rgba(0,0,0,.45)"}})}),(0,b.jsx)(pe.Z,{placeholder:"[0 - 40]",prefix:"Magnification",onChange:this.handleMagnificationSelection,onPressEnter:this.handleMagnificationSelection,controls:!1,addonAfter:this.state.isSelectedMagnificationValid?(0,b.jsx)(fe.Z,{style:{color:"rgba(0,0,0,.45)"}}):(0,b.jsx)(me.Z,{style:{color:"rgba(0,0,0,.45)"}})})]})}),(0,b.jsx)(he.Z,{open:this.state.isReportModalVisible,title:"Verify and save report",onOk:this.handleReportVerification,onCancel:this.handleReportCancellation,okText:"Save",children:c})]}),(0,b.jsx)(h.Z.Sider,{width:300,reverseArrow:!0,style:{borderLeft:"solid",borderLeftWidth:.25,overflow:"hidden",background:"none"},children:(0,b.jsxs)(g.Z,{mode:"inline",defaultOpenKeys:v,style:{height:"100%"},inlineIndent:14,forceSubMenuRender:!0,onOpenChange:function(){setTimeout((function(){null!=t.labelViewer&&t.labelViewer.resize()}),100)},children:[null!=this.labelViewportRef.current&&(0,b.jsx)(g.Z.SubMenu,{title:"Slide label",children:(0,b.jsx)(g.Z.Item,{style:{height:"100%"},children:(0,b.jsx)("div",{style:{height:"220px"},ref:this.labelViewportRef})},"image")},"label"),Z,be,V,k,P,(0,b.jsx)(g.Z.SubMenu,{title:"Annotations",children:d},"annotations"),A,0===u.length?(0,b.jsx)(b.Fragment,{}):(0,b.jsx)(g.Z.SubMenu,{title:"Annotation Categories",children:(0,b.jsx)(lt,{annotations:u,onChange:this.handleAnnotationVisibilityChange,checkedAnnotationUids:this.state.visibleRoiUIDs,onStyleChange:this.handleRoiStyleChange,defaultAnnotationStyles:this.defaultAnnotationStyles})},"annotation-categories"),M,U]})}),this.state.isHoveredRoiTooltipVisible&&this.state.hoveredRoiAttributes.length>0?(0,b.jsx)(ct,{xPosition:this.state.hoveredRoiTooltipX,yPosition:this.state.hoveredRoiTooltipY,rois:this.state.hoveredRoiAttributes}):(0,b.jsx)(b.Fragment,{})]})}}]),n}(l.Component);const Dt=it(xt);var Zt;!function(e){e.VOLUME="VOLUME",e.LABEL="LABEL",e.OVERVIEW="OVERVIEW",e.THUMBNAIL="THUMBNAIL"}(Zt||(Zt={}));var Vt=function(e,t){return e.ImageType[2]===t},Ot=function(e,t){return null!=e.AcquisitionUID&&e.AcquisitionUID===t.AcquisitionUID},Rt=(0,a.Z)((function e(t){var n=this;(0,i.Z)(this,e),this.description=void 0,this.acquisitionUID=void 0,this.frameOfReferenceUID=void 0,this.containerIdentifier=void 0,this.seriesInstanceUIDs=void 0,this.opticalPathIdentifiers=void 0,this.pyramidUIDs=[],this.areVolumeImagesMonochrome=void 0,this.volumeImages=void 0,this.labelImages=void 0,this.overviewImages=void 0,0===t.images.length&&te.onError(K,new z(q,'Value of option "images" have been non-zero length.'));var a=new Set([]),o=new Set([]),r=new Set([]),s=new Set([]),l={VOLUME:new Set([]),LABEL:new Set([]),OVERVIEW:new Set([])},c={VOLUME:{}},d=[],u=[],h=[];if(t.images.forEach((function(e){if(s.add(e.ContainerIdentifier),a.add(e.SeriesInstanceUID),e.OpticalPathSequence.forEach((function(e){r.add(e.OpticalPathIdentifier)})),null!=e.AcquisitionUID&&o.add(e.AcquisitionUID),Vt(e,Zt.VOLUME)){if(l.VOLUME.add(e.FrameOfReferenceUID),null!==e.PyramidUID&&void 0!==e.PyramidUID)for(var n=0,i=Object.keys(r);n<i.length;n++){var p=i[n];c.VOLUME[p].add(e.PyramidUID)}d.push(e)}else if(Vt(e,Zt.THUMBNAIL)){if(!t.images.some((function(t){return Vt(t,Zt.VOLUME)&&t.FrameOfReferenceUID===e.FrameOfReferenceUID&&t.OpticalPathSequence.every((function(t){return t.OpticalPathIdentifier===e.OpticalPathSequence[0].OpticalPathIdentifier}))}))){if(l.VOLUME.add(e.FrameOfReferenceUID),null!==e.PyramidUID&&void 0!==e.PyramidUID)for(var v=0,f=Object.keys(r);v<f.length;v++){var m=f[v];c.VOLUME[m].add(e.PyramidUID)}d.push(e)}}else Vt(e,Zt.LABEL)?(l.LABEL.add(e.FrameOfReferenceUID),u.push(e)):Vt(e,Zt.OVERVIEW)&&(l.OVERVIEW.add(e.FrameOfReferenceUID),h.push(e))})),0===d.length)te.onError(K,new z(q,"At least one VOLUME image must be provided for a slide."));else{o.size>1&&te.onError(K,new z(q,"All VOLUME images of a slide must have the same number of Samples per Pixel."));var p=new Set([]);d.forEach((function(e){p.add(e.SamplesPerPixel)})),p.size>1&&te.onError(K,new z(q,"All VOLUME images of a slide must have the same number of Samples per Pixel.")),d.filter((function(e){return"RESAMPLED"!==e.ImageType[3]})).length>r.size&&console.warn("the set of VOLUME images of a slide must contain only a single image that has not been resampled per optical path")}this.volumeImages=d,this.labelImages=u,this.overviewImages=h,this.seriesInstanceUIDs=(0,ae.Z)(a),this.opticalPathIdentifiers=(0,ae.Z)(r),1!==s.size&&te.onError(K,new z(q,"All images of a slide must have the same Container Identifier.")),this.containerIdentifier=(0,ae.Z)(s)[0],1!==l.VOLUME.size&&te.onError(K,new z(q,"All VOLUME images of a slide must have the same Frame of Reference UID.")),this.frameOfReferenceUID=(0,ae.Z)(l.VOLUME)[0];var v=!1;Object.keys(c.VOLUME).length>0&&(v=!0),this.opticalPathIdentifiers.forEach((function(e){null!=c.VOLUME[e]?c.VOLUME[e].size>1?te.onError(K,new z(q,'All VOLUME images for optical path "'.concat(e,'"')+"must be part of the same multi-resolution pyramid.")):1===c.VOLUME[e].size?n.pyramidUIDs.push((0,ae.Z)(c.VOLUME[e])[0]):te.onError(K,new z(q,'The VOLUME images for optical path "'.concat(e,'" ')+"lack the Pyramid UID, while the images for other optical paths contain it.")):v&&te.onError(K,new z(q,'The VOLUME images for optical path "'.concat(e,'" ')+"lack the Pyramid UID, while the images for other optical paths contain it."))})),o.size>1?te.onError(K,new z(q,"All VOLUME images of a slide must be part of the same  acquisition and have the same Acquisition UID.")):1===o.size?this.acquisitionUID=(0,ae.Z)(o)[0]:this.acquisitionUID=null,this.areVolumeImagesMonochrome=1===this.volumeImages[0].SamplesPerPixel&&"MONOCHROME2"===this.volumeImages[0].PhotometricInterpretation,this.description=void 0!==t.description?t.description:""})),jt=function(e){var t=[];e.forEach((function(e){if(e.length>0){var n=e.filter((function(e){return Vt(e,Zt.VOLUME)||Vt(e,Zt.THUMBNAIL)}));if(n.length>0){var i,a=n[0],o=n.filter((function(e){return a.SamplesPerPixel===e.SamplesPerPixel})),r=t.findIndex((function(e){return function(e,t){if(e.frameOfReferenceUID===t.FrameOfReferenceUID&&e.containerIdentifier===t.ContainerIdentifier&&e.acquisitionUID===t.AcquisitionUID)return!0;return!1}(e,a)})),s=e.filter((function(e){return Vt(e,Zt.LABEL)}));i=s.length>1?s.filter((function(e){return Ot(e,a)})):s;var l,c=e.filter((function(e){return Vt(e,Zt.OVERVIEW)}));if(l=c.length>1?c.filter((function(e){return Ot(e,a)})):c,-1===r){var d={acquisitionUID:a.AcquisitionUID,frameOfReferenceUID:a.FrameOfReferenceUID,containerIdentifier:a.ContainerIdentifier,volumeImages:o,labelImages:i,overviewImages:l};t.push(d)}else{var u,h,p,v=t[r];(u=v.volumeImages).push.apply(u,(0,ae.Z)(o)),(h=v.labelImages).push.apply(h,(0,ae.Z)(i)),(p=v.overviewImages).push.apply(p,(0,ae.Z)(l))}}}}));var n=t.map((function(e){return new Rt({images:[].concat((0,ae.Z)(e.volumeImages),(0,ae.Z)(e.labelImages),(0,ae.Z)(e.overviewImages))})}));return n=n.sort((function(e,t){var n=e.volumeImages[0],i=t.volumeImages[0];return null!=n.ContainerIdentifier&&null!=i.ContainerIdentifier?Number(n.ContainerIdentifier)-Number(i.ContainerIdentifier):0}))};var Pt=function(){var e=(0,f.Z)((0,v.Z)().mark((function e(t){var n,i,a,o,r,s,l,c,d;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.clients,i=t.studyInstanceUID,a=t.onSuccess,o=t.onError,e.prev=1,r=[],console.info('search for series of study "'.concat(i,'"...')),s=n[M.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE],e.next=7,s.searchForSeries({queryParams:{Modality:"SM",StudyInstanceUID:i}});case 7:return l=e.sent,e.next=10,Promise.all(l.map(function(){var e=(0,f.Z)((0,v.Z)().mark((function e(t){var n,a,o,l,c;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=U.metadata.formatMetadata(t),a=n.dataset,o=a,console.info('retrieve metadata of series "'.concat(o.SeriesInstanceUID,'"')),e.next=5,s.retrieveSeriesMetadata({studyInstanceUID:i,seriesInstanceUID:o.SeriesInstanceUID});case 5:l=e.sent,c=[],l.forEach((function(e){var t,n;if((null===(t=e["00080016"])||void 0===t||null===(n=t.Value)||void 0===n?void 0:n[0])===M.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE){var i=new U.metadata.VLWholeSlideMicroscopyImage({metadata:e});c.push(i)}})),c.length>0&&r.push(c);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 10:c=jt(r),a(c),e.next=20;break;case 14:e.prev=14,e.t0=e.catch(1),console.error(e.t0),d=new z(q,"Image metadata could not be retrieved or decoded."),o(d),te.onError(K,d);case 20:case"end":return e.stop()}}),e,null,[[1,14]])})));return function(t){return e.apply(this,arguments)}}(),Mt=new Map,Et=new Map,Ut=function(e){var t=e.clients,n=e.studyInstanceUID,i=(0,l.useState)([]),a=(0,m.Z)(i,2),o=a[0],r=a[1],s=(0,l.useState)(!1),c=(0,m.Z)(s,2),d=c[0],u=c[1],h=(0,l.useState)(null),p=(0,m.Z)(h,2),g=p[0],S=p[1];return(0,l.useEffect)((function(){if(void 0===n)return r([]),void u(!1);var e=Mt.get(n);if(void 0!==e)return r(e),void u(!1);u(!0);var i=function(){var e=(0,f.Z)((0,v.Z)().mark((function e(){var i,a;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===(i=Et.get(n))&&(i=new Promise((function(e,i){Pt({clients:t,studyInstanceUID:n,onSuccess:function(t){Mt.set(n,t),e(t)},onError:function(e){i(e)}}).catch((function(e){i(e)}))})),Et.set(n,i)),e.prev=2,e.next=5,i;case 5:a=e.sent,r(a),S(null),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(2),S(e.t0),r([]);case 14:return e.prev=14,Et.delete(n),u(!1),e.finish(14);case 18:case"end":return e.stop()}}),e,null,[[2,10,14,18]])})));return function(){return e.apply(this,arguments)}}();i()}),[t,n]),{slides:o,isLoading:d,error:g}},At=S.aT.DicomMetaDictionary.naturalizeDataset,Tt=function(e,t){return e.find((function(e){return e.seriesInstanceUIDs.find((function(e){return e===t}))}))};function kt(e){var t=e.clients,n=e.slides,i=e.user,a=e.app,o=e.preload,r=e.enableAnnotationTools,s=e.annotations,d=(0,c.UO)(),u=d.studyInstanceUID,h=void 0===u?"":u,p=d.seriesInstanceUID,g=void 0===p?"":p,S=(0,c.TH)(),y=(0,l.useState)(Tt(n,g)),C=(0,m.Z)(y,2),I=C[0],w=C[1],x=(0,l.useState)(null),D=(0,m.Z)(x,2),Z=D[0],V=D[1];(0,l.useEffect)((function(){var e=Tt(n,g);null!==e&&w(e)}),[g,n]),(0,l.useEffect)((function(){var e=function(){var e=(0,f.Z)((0,v.Z)().mark((function e(t){var i,a,o;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t.clients,a=t.studyInstanceUID,o=t.seriesInstanceUID,e.next=3,new Promise((function(e,t){try{var r=Object.values(M).map((function(e){return i[e]}));Promise.all(r.map(function(){var t=(0,f.Z)((0,v.Z)().mark((function t(i){var r,s,l,c,d,u,h,p,f,g,S,y,C,I,b;return(0,v.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,i.retrieveSeriesMetadata({studyInstanceUID:a,seriesInstanceUID:o});case 2:h=t.sent,p=h.map((function(e){return At(e)})),f=(0,m.Z)(p,1),null!=(g=f[0]).ReferencedSeriesSequence&&(S=g.ReferencedSeriesSequence[0].SeriesInstanceUID,y=n.find((function(e){return e.seriesInstanceUIDs.find((function(e){return e===S}))})),e({slide:y,metadata:g})),"111028",null!=(null===(C=null===(r=g.ContentSequence)||void 0===r?void 0:r.find((function(e){return"111028"===e.ConceptNameCodeSequence[0].CodeValue})))||void 0===C||null===(s=C.ContentSequence)||void 0===s||null===(l=s[0])||void 0===l||null===(c=l.ContentSequence)||void 0===c||null===(d=c[0])||void 0===d||null===(u=d.ReferencedSOPSequence)||void 0===u?void 0:u[0])&&(I=C.ContentSequence[0].ContentSequence[0].ReferencedSOPSequence[0].ReferencedSOPInstanceUID,b=n.find((function(e){return e.volumeImages.find((function(e){return e.SOPInstanceUID===I}))})),e({slide:b,metadata:g}));case 8:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())).catch(t)}catch(s){t(s)}}));case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();null!==I&&void 0!==I||e({clients:t,studyInstanceUID:h,seriesInstanceUID:g}).then((function(e){null!==e&&(w(e.slide),V(e.metadata))})).catch((function(e){console.error("Error finding referenced slide:",e)}))}),[n,t,I,h,g]);var O,R=new URLSearchParams(S.search);R.has("access_token")||null===(O=R.get("state"))&&(O=void 0);var j=null;return null!=I&&(j=(0,b.jsx)(Dt,{clients:t,studyInstanceUID:h,seriesInstanceUID:g,selectedPresentationStateUID:O,slide:I,preload:o,annotations:s,enableAnnotationTools:r,app:a,user:i,derivedDataset:Z})),j}const Lt=it((function(e){var t=e.clients,n=e.studyInstanceUID,i=e.location,a=e.navigate,o=Ut({clients:t,studyInstanceUID:n}),r=o.slides;if(o.isLoading)return null;if(0===r.length)return null;var s=r[0].volumeImages;if(0===s.length)return null;var l,d,u=s[0];if(i.pathname.includes("series/")){var p=i.pathname.split("series/")[1];l=p.includes("/")?p.split("/")[0]:p}else l=s[0].SeriesInstanceUID;return null!=u.ClinicalTrialSponsorName&&(d=(0,b.jsx)(g.Z.SubMenu,{title:"Clinical Trial",children:(0,b.jsx)(D,{metadata:u})},"clinical-trial")),(0,b.jsxs)(h.Z,{style:{height:"100%"},hasSider:!0,children:[(0,b.jsx)(h.Z.Sider,{width:300,style:{height:"100%",borderRight:"solid",borderRightWidth:.25,overflow:"hidden",background:"none"},children:(0,b.jsxs)(g.Z,{mode:"inline",defaultOpenKeys:["patient","study","clinical-trial","slides"],style:{height:"100%"},inlineIndent:14,children:[(0,b.jsx)(g.Z.SubMenu,{title:"Patient",children:(0,b.jsx)(j,{metadata:u})},"patient"),(0,b.jsx)(g.Z.SubMenu,{title:"Study",children:(0,b.jsx)(P,{metadata:u})},"study"),d,(0,b.jsx)(g.Z.SubMenu,{title:"Slides",children:(0,b.jsx)(ie,{clients:e.clients,metadata:r,selectedSeriesInstanceUID:l,onSeriesSelection:function(e){var t=e.seriesInstanceUID;console.info('switch to series "'.concat(t,'"'));var o="/studies/".concat(n)+"/series/".concat(t);i.pathname.includes("/projects/")&&(o=i.pathname,i.pathname.includes("/series/")?o=o.replace(/\/series\/[^/]+/,"/series/".concat(t)):o+="/series/".concat(t)),i.pathname.includes("/series/")&&null!=i.search&&(o+=i.search),a(o,{replace:!0})}})},"slides")]})}),(0,b.jsx)(c.Z5,{children:(0,b.jsx)(c.AW,{path:"/series/:seriesInstanceUID",element:(0,b.jsx)(kt,{clients:e.clients,slides:r,preload:e.preload,annotations:e.annotations,enableAnnotationTools:e.enableAnnotationTools,app:e.app,user:e.user})})})]})}));var _t=n(63),Nt=n(7382),Gt=n(3231),qt=n(6005),Ft=n(9529),zt=n(127),Bt=n(4541),Wt=n(8527),Yt=n(161),Ht=n(9761),Xt=n(5485),Kt=n(5208),Qt=n(1730),Jt=S.ZP.data.DicomMetaDictionary,$t=function(e){return"object"===typeof e&&null!==e?JSON.stringify(e):String(e)};function en(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(void 0===e||null===e)return[];var n=Object.keys(e).filter((function(e){return"_vrMap"!==e}));return n.flatMap((function(n){var i,a,o=Jt.nameMap[n],r=e[n];if(void 0===o){var s,l;return null==n.match(/[0-9A-Fa-f]{6}/g)?[]:[{tag:"(".concat(n.substring(0,4),",").concat(n.substring(4,8),")"),vr:"",keyword:"Private Tag",value:null!==(s=null===(l=r)||void 0===l?void 0:l.toString())&&void 0!==s?s:"",level:t}]}if("SQ"===o.vr&&void 0!==r){var c=Array.isArray(r)?r:[r],d={tag:o.tag,vr:o.vr,keyword:n,value:"Sequence with ".concat(c.length," item(s)"),level:t,children:[]};return d.children=c.map((function(e,n){return{tag:"".concat(o.tag,".").concat(n+1),vr:"Item",keyword:"Item ".concat(n+1),value:"Sequence Item ".concat(n+1),level:t+1,children:en(e,t+2)}})),[d]}return Array.isArray(r)?r=r.map($t).join("\\"):"object"===typeof r&&null!==r&&(r=$t(r)),[{tag:o.tag,vr:o.vr,keyword:n.replace("RETIRED_",""),value:null!==(i=null===(a=r)||void 0===a?void 0:a.toString())&&void 0!==i?i:"",level:t}]}))}function tn(e){return en(e).sort((function(e,t){return e.tag.localeCompare(t.tag)}))}var nn=n(7762);const an={subscribe:on,_broadcastEvent:ln,_unsubscribe:rn,_isValidEvent:sn};function on(e,t){var n=this;if(this._isValidEvent(e)){var i=(0,y.Z)(),a={id:i,callback:t};return Array.isArray(this.listeners[e])?this.listeners[e].push(a):this.listeners[e]=[a],{unsubscribe:function(){return n._unsubscribe(e,i)}}}throw new Error("Event ".concat(e," not supported."))}function rn(e,t){if(void 0!==this.listeners[e]){var n=this.listeners[e];Array.isArray(n)?this.listeners[e]=n.filter((function(e){return e.id!==t})):this.listeners[e]=[]}}function sn(e){return Object.values(this.EVENTS).includes(e)}function ln(e,t){var n=Object.keys(this.listeners).length>0,i=Array.isArray(this.listeners[e]);n&&i&&this.listeners[e].forEach((function(e){e.callback(t)}))}const cn=function(e,t){var n=[],i=new Map;return(0,E.Z)((0,E.Z)({SeriesInstanceUID:e,Modality:"",SeriesNumber:0,SeriesDescription:"",SeriesDate:"",SeriesTime:""},null===t||void 0===t?void 0:t[0]),{},{instances:n,addInstance:function(e){this.addInstances([e])},addInstances:function(e){for(var t=0,a=e.length;t<a;t++){var o=e[t];i.has(o.SOPInstanceUID)||(i.set(o.SOPInstanceUID,o),n.push(o))}},getInstance:function(e){return i.get(e)}})};const dn=function(e){return{StudyInstanceUID:e,StudyDescription:"",PatientID:"",PatientName:"",StudyDate:"",AccessionNumber:"",NumInstances:0,ModalitiesInStudy:[],isLoaded:!1,series:[],addInstanceToSeries:function(e){this.addInstancesToSeries([e])},addInstancesToSeries:function(e){var t=e[0].SeriesInstanceUID;""!==this.StudyDescription&&void 0!==this.StudyDescription&&(this.StudyDescription=e[0].StudyDescription);var n=this.series.find((function(e){return e.SeriesInstanceUID===t}));null==n&&(n=cn(t,e),this.series.push(n)),n.addInstances(e)},setSeriesMetadata:function(e,t){var n=this.series.find((function(t){return t.SeriesInstanceUID===e}));if(null!=n)n=Object.assign(n,t);else{var i=cn(e);this.series.push(Object.assign(i,t))}}}};var un={STUDY_ADDED:"event::dicomMetadataStore:studyAdded",INSTANCES_ADDED:"event::dicomMetadataStore:instancesAdded",SERIES_ADDED:"event::dicomMetadataStore:seriesAdded",SERIES_UPDATED:"event::dicomMetadataStore:seriesUpdated"},hn={studies:[]};function pn(e){return hn.studies.find((function(t){return t.StudyInstanceUID===e}))}function vn(e,t){var n=pn(e);if(null!=n)return n.series.find((function(e){return e.SeriesInstanceUID===t}))}var fn={EVENTS:un,listeners:{},addInstance:function(e){var t,n;e instanceof ArrayBuffer?t=S.ZP.data.DicomMessage.readFile(e).dict:t=e;var i=(n="SeriesInstanceUID"in t?t:S.ZP.data.DicomMetaDictionary.naturalizeDataset(t)).StudyInstanceUID,a=hn.studies.find((function(e){return e.StudyInstanceUID===i}));null==a&&(hn.studies.push(dn(i)),a=hn.studies[hn.studies.length-1]),a.addInstanceToSeries(n)},addInstances:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=e[0],i=n.StudyInstanceUID,a=n.SeriesInstanceUID,o=hn.studies.find((function(e){return e.StudyInstanceUID===i}));null==o&&(hn.studies.push(dn(i)),o=hn.studies[hn.studies.length-1]),o.addInstancesToSeries(e),this._broadcastEvent(un.INSTANCES_ADDED,{StudyInstanceUID:i,SeriesInstanceUID:a,madeInClient:t})},updateSeriesMetadata:function(e){var t=e.StudyInstanceUID,n=e.SeriesInstanceUID;if(null!=vn(t,n)){var i=pn(t);null!=i&&i.setSeriesMetadata(n,e)}},addSeriesMetadata:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(void 0!==e&&0!==e.length&&void 0!==e[0]){var n=e[0].StudyInstanceUID,i=pn(n);null==i&&((i=dn(n)).StudyDescription=e[0].StudyDescription,null===e||void 0===e||e.forEach((function(e){var t,n;void 0===i||null!==(t=i.ModalitiesInStudy)&&void 0!==t&&t.includes(e.Modality)||(null===(n=i.ModalitiesInStudy)||void 0===n||n.push(e.Modality))})),i.NumberOfStudyRelatedSeries=e.length,hn.studies.push(i)),e.forEach((function(e){var t,n=e.SeriesInstanceUID;null===(t=i)||void 0===t||t.setSeriesMetadata(n,e)})),this._broadcastEvent(un.SERIES_ADDED,{StudyInstanceUID:n,seriesSummaryMetadata:e,madeInClient:t})}},addStudy:function(e){var t=e.StudyInstanceUID,n=hn.studies.find((function(e){return e.StudyInstanceUID===t}));if(null==n){var i=dn(t);i.PatientID=e.PatientID,i.PatientName=e.PatientName,i.StudyDate=e.StudyDate,i.ModalitiesInStudy=e.ModalitiesInStudy,i.StudyDescription=e.StudyDescription,i.AccessionNumber=e.AccessionNumber,i.NumInstances=e.NumInstances,hn.studies.push(i)}},getStudyInstanceUIDs:function(){return hn.studies.map((function(e){return e.StudyInstanceUID}))},getStudy:pn,getSeries:vn,getInstance:function(e,t,n){var i=vn(e,t);if(null!=i)return i.getInstance(n)},getInstanceByImageId:function(e){var t,n=(0,nn.Z)(hn.studies);try{for(n.s();!(t=n.n()).done;){var i,a=t.value,o=(0,nn.Z)(a.series);try{for(o.s();!(i=o.n()).done;){var r,s=i.value,l=(0,nn.Z)(s.instances);try{for(l.s();!(r=l.n()).done;){var c=r.value;if(c.imageId===e)return c}}catch(d){l.e(d)}finally{l.f()}}}catch(d){o.e(d)}finally{o.f()}}}catch(d){n.e(d)}finally{n.f()}},updateMetadataForSeries:function(e,t,n){var i=pn(e);if(null!=i){var a=i.series.find((function(e){return e.SeriesInstanceUID===t}));if(null!=a)a.instances.forEach((function(e){Object.keys(n).forEach((function(t){"object"===typeof n[t]?e[t]=(0,E.Z)((0,E.Z)({},e[t]),n[t]):e[t]=n[t]}))}))}},_broadcastEvent:function(e,t){}};const mn=Object.assign({},fn,an);var gn=oe.Z.Option;const Sn=function(e){var t,n,i=e.clients,a=e.studyInstanceUID,o=Ut({clients:i,studyInstanceUID:a}),r=o.slides,s=o.isLoading,c=(0,l.useState)(void 0),d=(0,m.Z)(c,2),u=d[0],h=d[1],p=(0,l.useState)([]),v=(0,m.Z)(p,2),f=v[0],g=v[1],S=(0,l.useState)(0),y=(0,m.Z)(S,2),C=y[0],I=y[1],w=(0,l.useState)(1),x=(0,m.Z)(w,2),D=x[0],Z=x[1],V=(0,l.useState)(""),O=(0,m.Z)(V,2),R=O[0],j=O[1],P=(0,l.useState)([]),M=(0,m.Z)(P,2),U=M[0],A=M[1],T=(0,l.useState)(""),k=(0,m.Z)(T,2),L=k[0],_=k[1],N=function(e,t){var n=(0,l.useState)(e),i=(0,m.Z)(n,2),a=i[0],o=i[1];return(0,l.useEffect)((function(){var n=setTimeout((function(){o(e)}),t);return function(){clearTimeout(n)}}),[e,t]),a}(L,300);(0,l.useEffect)((function(){""===N?(j(""),A([])):j(N)}),[N]),(0,l.useEffect)((function(){var e=function(e){var t=Object.assign({},mn.getStudy(a));h(t)},t=mn.subscribe(mn.EVENTS.SERIES_ADDED,e),n=mn.subscribe(mn.EVENTS.INSTANCES_ADDED,e),i=Object.assign({},mn.getStudy(a));return h(i),function(){t.unsubscribe(),n.unsubscribe()}}),[a]),(0,l.useEffect)((function(){var e,t=[],n=[],i=[],a=0;r.length>0&&(t=r.map((function(e){var t=e.volumeImages;if(void 0===(null===t||void 0===t?void 0:t[0]))return null;var n=t[0],o=n.SeriesDate,r=n.SeriesTime,s=n.SeriesNumber,l=n.SeriesInstanceUID,c=n.SeriesDescription,d=n.Modality;i.push(l);var u={displaySetInstanceUID:a,SeriesDate:o,SeriesTime:r,SeriesInstanceUID:l,SeriesNumber:s,SeriesDescription:c,Modality:d,images:t};return a++,u})).filter((function(e){return null!==e}))),void 0!==u&&(null===(e=u.series)||void 0===e?void 0:e.length)>0&&(n=u.series.filter((function(e){return!i.includes(e.SeriesInstanceUID)})).map((function(e){var t,n={displaySetInstanceUID:a,SeriesDate:e.SeriesDate,SeriesTime:e.SeriesTime,SeriesNumber:e.SeriesNumber,SeriesDescription:e.SeriesDescription,SeriesInstanceUID:e.SeriesInstanceUID,Modality:e.Modality,images:(null===e||void 0===e||null===(t=e.instances)||void 0===t?void 0:t.length)>0?e.instances:[e]};return a++,n}))),g([].concat((0,ae.Z)(t),(0,ae.Z)(n)))}),[r,u]);var G=(0,l.useMemo)((function(){return f.sort((function(e,t){return Number(e.SeriesNumber)-Number(t.SeriesNumber)})),f.map((function(e,t){var n=e.SeriesDate,i=void 0===n?"":n,a=e.SeriesTime,o=void 0===a?"":a,r=e.SeriesNumber,s=void 0===r?"":r,l=e.SeriesDescription,c=void 0===l?"":l,d=e.Modality,u=void 0===d?"":d,h=function(e){var t=e.match(/^(\d{4})(\d{2})(\d{2}):(\d{2})(\d{2})(\d{2})/);if(null==t)return e;var n=(0,m.Z)(t,7),i=n[1],a=n[2],o=n[3],r=n[4],s=n[5],l=n[6],c=parseInt(a),d=parseInt(o);if(c<1||c>12||d<1||d>31)return e;var u=new Date(parseInt(i),c-1,d,parseInt(r),parseInt(s),parseInt(l));if(u.getMonth()!==c-1||u.getDate()!==d)return e;var h=u.toLocaleDateString("en-US",{weekday:"short"}),p=u.toLocaleDateString("en-US",{month:"short"}),v=u.getDate(),f=u.getFullYear();return"".concat(h,", ").concat(p," ").concat(v," ").concat(f)}("".concat(i,":").concat(o).split(".")[0]);return{value:t,label:"".concat(s," (").concat(u,"): ").concat(c),description:h}}))}),[f]),q=(null===(t=f[C])||void 0===t?void 0:t.images.length)>1;console.debug("displaySets:",f);var F=(0,l.useMemo)((function(){var e;if(void 0===f[C])return{};var t=f[C].images.length;return e={1:"1"},(0,at.Z)(e,Math.ceil(t/2),String(Math.ceil(t/2))),(0,at.Z)(e,t,String(t)),e}),[C,f]),z=(0,l.useMemo)((function(){var e;return void 0===f[C]?[]:function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return t.map((function(t,i){var a=""!==t.tag?t.tag.replace(/[(),]/g,""):i.toString(),o=""!==n?"".concat(n,"-").concat(a):a,r={key:o,tag:t.tag,vr:t.vr,keyword:t.keyword,value:t.value};return void 0!==t.children&&t.children.length>0&&(r.children=e(t.children,o)),r}))}(tn(null===(e=f[C])||void 0===e?void 0:e.images[D-1]))}),[D,C,f]),B=(0,l.useMemo)((function(){if(void 0===R||""===R)return z;var e=R.toLowerCase(),t=new Set,n=function(t){var n,i,a,o,r,s,l,c;return(null!==(n=null===(i=t.tag)||void 0===i?void 0:i.toLowerCase())&&void 0!==n?n:"").includes(e)||(null!==(a=null===(o=t.vr)||void 0===o?void 0:o.toLowerCase())&&void 0!==a?a:"").includes(e)||(null!==(r=null===(s=t.keyword)||void 0===s?void 0:s.toLowerCase())&&void 0!==r?r:"").includes(e)||(null!==(l=null===(c=t.value)||void 0===c?void 0:c.toString().toLowerCase())&&void 0!==l?l:"").includes(e)},i=function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],a=[].concat((0,ae.Z)(i),[t]),o=[];return n(t)&&o.push(a),null!=t.children&&t.children.forEach((function(t){var n=e(t,a);o=[].concat((0,ae.Z)(o),(0,ae.Z)(n))})),o},a=function e(n){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(0===n.length||i>=n[0].length)return[];var a=new Map;return n.forEach((function(e){if(i<e.length){var t,n=e[i];if(a.has(n.key)||a.set(n.key,{node:(0,E.Z)({},n),childPaths:[]}),i+1<e.length)null===(t=a.get(n.key))||void 0===t||t.childPaths.push(e)}})),Array.from(a.values()).map((function(n){var a=n.node,o=n.childPaths;t.add(a.key);var r=e(o,i+1);return r.length>0?(0,E.Z)((0,E.Z)({},a),{},{children:r}):a}))}(z.flatMap((function(e){return i(e)})));return A(Array.from(t)),a}),[z,R]);return s?(0,b.jsx)("div",{children:"Loading..."}):(0,b.jsx)("div",{className:"dicom-tag-browser",children:(0,b.jsxs)("div",{style:{width:"100%",padding:"16px 20px 20px"},children:[(0,b.jsxs)("div",{style:{display:"flex",gap:"24px",marginBottom:"32px"},children:[(0,b.jsxs)("div",{style:{flex:1},children:[(0,b.jsx)(Xt.Z.Text,{strong:!0,style:{display:"block",marginBottom:"8px"},children:"Slides"}),(0,b.jsx)(oe.Z,{style:{width:"100%"},value:C,onChange:function(e){I(e),Z(1)},optionLabelProp:"label",optionFilterProp:"label",children:G.map((function(e){return(0,b.jsx)(gn,{value:e.value,label:e.label,children:(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{children:e.label}),(0,b.jsx)("div",{style:{fontSize:"12px",color:"rgba(0, 0, 0, 0.45)"},children:e.description})]})},e.value)}))})]}),q&&(0,b.jsxs)("div",{style:{flex:1},children:[(0,b.jsxs)(Xt.Z.Text,{strong:!0,style:{display:"block",marginBottom:"8px"},children:["Instance Number: ",D]}),(0,b.jsx)(we.Z,{min:1,max:null===(n=f[C])||void 0===n?void 0:n.images.length,value:D,onChange:function(e){return Z(e)},marks:F,tooltip:{formatter:function(e){return void 0!==e?"Instance ".concat(e):""}}})]})]}),(0,b.jsx)(qt.Z,{style:{marginBottom:"20px"},placeholder:"Search DICOM tags...",prefix:(0,b.jsx)(Qt.Z,{}),onChange:function(e){return _(e.target.value)},value:L}),(0,b.jsx)(Kt.Z,{columns:[{title:"Tag",dataIndex:"tag",key:"tag",width:"30%"},{title:"VR",dataIndex:"vr",key:"vr",width:"5%"},{title:"Keyword",dataIndex:"keyword",key:"keyword",width:"30%"},{title:"Value",dataIndex:"value",key:"value",width:"40%"}],dataSource:B,pagination:!1,expandable:{expandedRowKeys:U,onExpandedRowsChange:function(e){return A(e)}},size:"small",scroll:{y:500}})]})})};const yn=it(function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;(0,i.Z)(this,n),(a=t.call(this,e)).isValidServerUrl=function(e){if(null==e||""===e)return!1;try{var t=new URL(e);return t.protocol.startsWith("http")&&t.pathname.length>0}catch(n){return!1}},a.handleInfoButtonClick=function(){var e=(0,Ht.qY)(),t={browser:{},os:{}};null!=e&&(t.browser={name:null!=e.name?e.name:void 0,version:null!=e.version?e.version:void 0},t.os={name:null!=e.os?e.os:void 0}),he.Z.info({title:"About",width:600,content:(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)(C.Z,{title:"Application",column:1,children:[(0,b.jsx)(C.Z.Item,{label:"Name",children:a.props.app.name}),(0,b.jsx)(C.Z.Item,{label:"Version",children:a.props.app.version}),(0,b.jsx)(C.Z.Item,{label:"Homepage",children:a.props.app.homepage})]}),(0,b.jsxs)(C.Z,{title:"Browser",column:1,children:[(0,b.jsx)(C.Z.Item,{label:"Name",children:t.browser.name}),(0,b.jsx)(C.Z.Item,{label:"Version",children:t.browser.version})]}),(0,b.jsx)(C.Z,{title:"Operating System",column:1,children:(0,b.jsx)(C.Z.Item,{label:"Name",children:t.os.name})})]}),onOk:function(){}})},a.handleDicomTagBrowserButtonClick=function(){var e,t,n=window.innerWidth-200;he.Z.info({title:"DICOM Tag Browser",width:n,content:(0,b.jsx)(Sn,{clients:null!==(e=a.props.clients)&&void 0!==e?e:{},studyInstanceUID:null!==(t=a.props.params.studyInstanceUID)&&void 0!==t?t:""}),onOk:function(){}})},a.handleDebugButtonClick=function(){var e={Authentication:[],Communication:[],EncodingDecoding:[],Visualization:[]},t=a.state.errorObj.length;if(t>0)for(var n=0;n<t;n++){e[a.state.errorCategory[n]].push("".concat(a.state.errorObj[n].message," (Source: ").concat(a.state.errorObj[n].source,")"))}var i,o=_t.Z.Panel,r=function(e){return(0,b.jsx)(De.Z,{count:e})};he.Z.info({title:"Debug Information\n (Check console for more information)",width:800,content:(0,b.jsxs)(_t.Z,{children:[(0,b.jsx)(o,{header:"Communication Error",extra:r(e.Communication.length),children:(0,b.jsx)("ol",{children:e.Communication.map((function(e){return(0,b.jsx)("li",{children:e},(0,y.Z)())}))})},"communicationerror"),(0,b.jsx)(o,{header:"Data Encoding/Decoding error",extra:r(e.EncodingDecoding.length),children:(0,b.jsx)("ol",{children:e.EncodingDecoding.map((function(e){return(0,b.jsx)("li",{children:e},(0,y.Z)())}))})},"encodedecodeerror"),(0,b.jsx)(o,{header:"Visualization error",extra:r(e.Visualization.length),children:(0,b.jsx)("ol",{children:e.Visualization.map((function(e){return(0,b.jsx)("li",{children:e},(0,y.Z)())}))})},"visualizationerror"),(0,b.jsx)(o,{header:"Authentication error",extra:r(e.Authentication.length),children:(0,b.jsx)("ol",{children:e.Authentication.map((function(e){return(0,b.jsx)("li",{children:e},(0,y.Z)())}))})},"autherror"),(0,b.jsx)(o,{header:"Warning",extra:(i=a.state.warnings.length,(0,b.jsx)(De.Z,{color:"green",count:i})),children:(0,b.jsx)("ol",{children:a.state.warnings.map((function(e){return(0,b.jsx)("li",{children:e},(0,y.Z)())}))})},"warning")]}),onOk:function(){}})},a.handleServerSelectionButtonClick=function(){a.setState({isServerSelectionModalVisible:!0})},a.handleServerSelectionInput=function(e){var t=e.currentTarget.value;a.setState({selectedServerUrl:t,isServerSelectionDisabled:!a.isValidServerUrl(t)})},a.handleServerSelectionCancellation=function(){var e=window.localStorage.getItem("slim_selected_server");a.setState({serverSelectionMode:null!==e&&""!==e?"custom":"default",selectedServerUrl:null!==e&&void 0!==e?e:void 0,isServerSelectionModalVisible:!1,isServerSelectionDisabled:!a.isValidServerUrl(e)})},a.handleServerSelectionModeChange=function(e){var t=e.target.value;a.setState({serverSelectionMode:t})},a.handleServerSelection=function(){if(window.localStorage.setItem("slim_server_selection_mode",a.state.serverSelectionMode),"default"===a.state.serverSelectionMode)return a.props.onServerSelection({url:""}),void a.setState({isServerSelectionModalVisible:!1,isServerSelectionDisabled:!1});var e=a.state.selectedServerUrl,t=!1;null!=e&&""!==e&&(e.startsWith("http://")||e.startsWith("https://"))&&(a.props.onServerSelection({url:e}),t=!0),a.setState({isServerSelectionModalVisible:!t,isServerSelectionDisabled:!t})};var o=window.localStorage.getItem("slim_selected_server"),r=window.localStorage.getItem("slim_server_selection_mode");a.state={errorObj:[],errorCategory:[],warnings:[],selectedServerUrl:null!==o&&void 0!==o?o:"",isServerSelectionModalVisible:!1,isServerSelectionDisabled:!a.isValidServerUrl(o),serverSelectionMode:"custom"===r&&null!==o&&""!==o?"custom":"default"};return te.subscribe(B,(function(e){var t=e.source,n=e.error;a.setState((function(e){return(0,E.Z)((0,E.Z)({},e),{},{errorObj:[].concat((0,ae.Z)(e.errorObj),[(0,E.Z)((0,E.Z)({},n),{},{source:t})]),errorCategory:[].concat((0,ae.Z)(e.errorCategory),[n.type])})}))})),te.subscribe(W,(function(e){a.setState((function(t){return(0,E.Z)((0,E.Z)({},t),{},{warnings:[].concat((0,ae.Z)(t.warnings),[e])})}))})),a}return(0,a.Z)(n,[{key:"componentDidUpdate",value:function(e,t){(t.warnings.length>0||t.errorObj.length>0)&&this.props.location.pathname!==e.location.pathname&&this.setState({isServerSelectionModalVisible:!1,isServerSelectionDisabled:!0,errorObj:[],errorCategory:[],warnings:[]})}},{key:"render",value:function(){var e,t,n,i,a,o,r=this,s=null;if(void 0!==this.props.user){var l=[];void 0!==this.props.onUserLogout&&l.push({label:"Logout",key:"user-logout",onClick:function(){void 0!==r.props.onUserLogout&&r.props.onUserLogout()}});var c={items:l};s=(0,b.jsx)(Nt.Z,{menu:c,trigger:["click"],children:(0,b.jsx)(je,{icon:Ft.Z,onClick:function(e){return e.preventDefault()},label:"".concat(this.props.user.name," (").concat(this.props.user.email,")")})})}this.props.showWorklistButton&&(o=(0,b.jsx)(d.OL,{to:"/",children:(0,b.jsx)(je,{icon:zt.Z,tooltip:"Go to worklist"})}));var u,p=(0,b.jsx)(je,{icon:Bt.Z,tooltip:"Get app info",onClick:this.handleInfoButtonClick}),v=(0,b.jsx)(De.Z,{count:this.state.errorObj.length,style:{zIndex:1e3},children:(0,b.jsx)(De.Z,{color:"green",count:this.state.warnings.length,style:{zIndex:1001},children:(0,b.jsx)(je,{icon:Ze.Z,tooltip:"Debug info",onClick:this.handleDebugButtonClick})})}),f=this.props.location.pathname.includes("/studies/")?(0,b.jsx)(je,{icon:Wt.Z,tooltip:"Dicom Tag Browser",onClick:this.handleDicomTagBrowserButtonClick}):null;this.props.showServerSelectionButton&&(u=(0,b.jsx)(je,{icon:Yt.Z,tooltip:"Select server",onClick:this.handleServerSelectionButtonClick}));var m="custom"===this.state.serverSelectionMode?this.state.selectedServerUrl:null!==(e=null===(t=this.props.clients)||void 0===t||null===(n=t.default)||void 0===n?void 0:n.baseURL)&&void 0!==e?e:null===(i=this.props.defaultClients)||void 0===i||null===(a=i.default)||void 0===a?void 0:a.baseURL,g=null!=m&&""!==m?(0,b.jsx)(le.Z,{title:m,children:(0,b.jsx)("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",paddingRight:"20px",paddingLeft:"20px"},title:m,children:m})}):null;return(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(h.Z.Header,{style:{width:"100%",padding:"0 14px"},children:(0,b.jsxs)(de.Z,{style:{flexWrap:"nowrap"},children:[(0,b.jsx)(be.Z,{style:{flexShrink:0},children:(0,b.jsx)(se.Z,{align:"center",direction:"horizontal",children:(0,b.jsx)("img",{src:"https://imagingdatacommons.github.io/slim/logo.svg",alt:"",style:{height:"64px",margin:"-14px"}})})}),(0,b.jsx)(be.Z,{flex:"auto",style:{minWidth:0,overflow:"hidden"},children:(0,b.jsx)("div",{style:{width:"100%",overflow:"hidden"},children:this.props.showServerSelectionButton?g:""})}),(0,b.jsx)(be.Z,{style:{flexShrink:0},children:(0,b.jsxs)(se.Z,{direction:"horizontal",children:[o,p,v,f,u,s]})})]})}),(0,b.jsxs)(he.Z,{open:this.state.isServerSelectionModalVisible,title:"Select DICOMweb server",onOk:this.handleServerSelection,onCancel:this.handleServerSelectionCancellation,children:[(0,b.jsxs)(Gt.ZP.Group,{value:this.state.serverSelectionMode,onChange:this.handleServerSelectionModeChange,style:{marginBottom:"16px"},children:[(0,b.jsx)(Gt.ZP,{value:"default",children:"Use default server"}),(0,b.jsx)(Gt.ZP,{value:"custom",children:"Use custom server"})]}),"custom"===this.state.serverSelectionMode&&(0,b.jsx)(le.Z,{title:this.state.selectedServerUrl,children:(0,b.jsx)(qt.Z,{placeholder:"Enter base URL of DICOMweb Study Service",value:this.state.selectedServerUrl,onChange:this.handleServerSelectionInput,onPressEnter:this.handleServerSelection,addonAfter:this.state.isServerSelectionDisabled?(0,b.jsx)(me.Z,{style:{color:"rgba(0,0,0,.45)"}}):(0,b.jsx)(fe.Z,{style:{color:"rgba(0,0,0,.45)"}})})})]})]})}}]),n}(l.Component));var Cn=n(7063);const In=function(e){var t=e.title,n=e.message;return(0,b.jsx)("div",{style:{height:"100vh",display:"flex",alignItems:"center",justifyContent:"center"},children:(0,b.jsx)(Cn.ZP,{title:t,subTitle:n})})};const bn=it(function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a;return(0,i.Z)(this,n),(a=t.call(this,e)).defaultPageSize=20,a.handleSearch=function(e,t,n){t()},a.handleReset=function(e){e()},a.getColumnSearchProps=function(e){return{filterDropdown:function(t){var n=t.setSelectedKeys,i=t.selectedKeys,o=t.confirm,r=t.clearFilters;return(0,b.jsxs)("div",{style:{padding:8},children:[(0,b.jsx)(qt.Z,{placeholder:"Search",value:i[0],onChange:function(e){return n(void 0!==e.target.value?[e.target.value]:[])},onPressEnter:function(){return a.handleSearch(i,o,e)},style:{width:188,marginBottom:8,display:"block"}}),(0,b.jsxs)(se.Z,{children:[(0,b.jsx)(ce.Z,{type:"primary",onClick:function(){return a.handleSearch(i,o,e)},icon:(0,b.jsx)(Qt.Z,{}),size:"small",style:{width:90},children:"Search"}),(0,b.jsx)(ce.Z,{onClick:function(){return a.handleReset(r)},size:"small",style:{width:90},children:"Reset"})]})]})},filterIcon:function(e){return(0,b.jsx)(Qt.Z,{style:{color:e?"#1890ff":void 0}})}}},a.fetchData=a.fetchData.bind((0,o.Z)(a)),a.handleClick=a.handleClick.bind((0,o.Z)(a)),a.handleChange=a.handleChange.bind((0,o.Z)(a)),a.state={studies:[],isLoading:!1,numStudies:0,pageSize:a.defaultPageSize},a}return(0,a.Z)(n,[{key:"searchForStudies",value:function(){var e=this,t={queryParams:{ModalitiesInStudy:"SM"}};this.props.clients[M.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE].searchForStudies(t).then((function(t){e.setState({numStudies:t.length,studies:t.slice(0,e.state.pageSize).map((function(e){return U.metadata.formatMetadata(e).dataset}))})})).catch((function(e){console.error(e),te.onError(Y,new z(G,"An error occured. Search for studies failed."))}))}},{key:"componentDidMount",value:function(){this.searchForStudies()}},{key:"componentDidUpdate",value:function(e){this.props.clients!==e.clients&&this.searchForStudies()}},{key:"handleClick",value:function(e,t){this.props.navigate("/studies/".concat(t.StudyInstanceUID))}},{key:"fetchData",value:function(e){var t=this,n=e.offset,i=e.limit,a=e.searchCriteria,o={ModalitiesInStudy:"SM",offset:n,limit:i};if(void 0!==a){for(var r in a){var s=a[r];o[r]="PersonName"===r?"*".concat(s,"*"):s}o.fuzzymatching="true"}var l={queryParams:o};this.props.clients[M.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE].searchForStudies(l).then((function(e){t.setState({studies:e.map((function(e){return U.metadata.formatMetadata(e).dataset}))})})).catch((function(e){console.error(e),te.onError(Y,new z(G,"Request to search for studies failed."))}))}},{key:"handleChange",value:function(e,t){this.setState({isLoading:!0});var n=e.current;void 0===n&&(n=1);var i=e.pageSize;void 0===i&&(i=this.state.pageSize);var a=i*(n-1),o=i;console.debug("search for studies of page #".concat(n,"..."));var r={};for(var s in t)null!==t[s]&&(r[s]=t[s][0].toString());this.fetchData({offset:a,limit:o,searchCriteria:r}),this.setState({isLoading:!1,pageSize:i})}},{key:"render",value:function(){var e=this,t=[(0,E.Z)({title:"Accession Number",dataIndex:"AccessionNumber"},this.getColumnSearchProps("AccessionNumber")),(0,E.Z)({title:"Study ID",dataIndex:"StudyID"},this.getColumnSearchProps("StudyID")),{title:"Study Date",dataIndex:"StudyDate",render:function(e){return V(e)}},{title:"Study Time",dataIndex:"StudyTime",render:function(e){return O(e)}},(0,E.Z)({title:"Patient ID",dataIndex:"PatientID"},this.getColumnSearchProps("PatientID")),(0,E.Z)({title:"Patient's Name",dataIndex:"PatientName",render:function(e){return Z(e)}},this.getColumnSearchProps("PatientName")),{title:"Patient's Sex",dataIndex:"PatientSex",render:function(e){return R(e)}},{title:"Patient's Birthdate",dataIndex:"PatientBirthDate",render:function(e){return V(e)}},{title:"Referring Physician's Name",dataIndex:"ReferringPhysicianName",render:function(e){return Z(e)}},{title:"Modalities in Study",dataIndex:"ModalitiesInStudy",render:function(e){return void 0===e?"":String(e)}}],n={defaultPageSize:this.defaultPageSize,pageSize:this.state.pageSize,hideOnSinglePage:!0,showSizeChanger:!0,showQuickJumper:!0,showTotal:function(e,t){return"".concat(t[0],"-").concat(t[1]," of ").concat(e," studies")},total:this.state.numStudies};return(0,b.jsx)(Kt.Z,{style:{cursor:"pointer"},columns:t,rowKey:function(e){return e.StudyInstanceUID},dataSource:this.state.studies,pagination:n,onRow:function(t){return{onClick:function(n){return e.handleClick(n,t)}}},onChange:this.handleChange,size:"small",loading:this.state.isLoading})}}]),n}(l.Component));var wn=n(5685),xn=function(e,t){var n=t;return n.endsWith("/")||(n+="/"),new URL(e,n).toString()},Dn=function(e){var t,n,i,a,o,r=new URLSearchParams(e.search),s=new URLSearchParams(e.hash.replace("#","?"));return Boolean(null!==(t=null!==(n=null!==(i=null!==(a=null!==(o=r.get("code"))&&void 0!==o?o:r.get("id_token"))&&void 0!==a?a:r.get("session_state"))&&void 0!==i?i:s.get("code"))&&void 0!==n?n:s.get("id_token"))&&void 0!==t?t:s.get("session_state"))},Zn=function(e){var t;if(null!==e&&(t=e.profile),void 0!==t){if(void 0!==t.name&&void 0!==t.email)return{name:t.name,email:t.email};te.onError(Q,new z(N,'Failed to obtain user "name" and "email".'))}else te.onError(Q,new z(N,"Failed to obtain user profile."));return{name:void 0,email:void 0}},Vn=(0,a.Z)((function e(t,n){var a=this;(0,i.Z)(this,e),this._oidc=void 0,this.signIn=function(){var e=(0,f.Z)((0,v.Z)().mark((function e(t){var n,i,o,r;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.onSignIn,i=function(e){var t=Zn(e),i="".concat(e.token_type," ").concat(e.access_token);null!=n?(console.info("handling sign-in using provided callback function"),n({user:t,authorization:i})):console.warn("no callback function was provided to handle sign-in")},!Dn(window.location)){e.next=10;break}return console.info("obtaining authorization"),e.next=6,a._oidc.signinCallback();case 6:null!=(o=e.sent)&&(console.info("obtained user data: ",o),i(o)),e.next=21;break;case 10:return e.next=12,a._oidc.getUser();case 12:if(null!==(r=e.sent)&&!r.expired){e.next=19;break}return console.info("authenticating user"),e.next=17,a._oidc.signinRedirect();case 17:e.next=21;break;case 19:console.info("user has already been authenticated"),i(r);case 21:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.signOut=(0,f.Z)((0,v.Z)().mark((function e(){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("signing out user and revoking authorization"),e.next=3,a._oidc.signoutRedirect();case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e)}))),this.getAuthorization=(0,f.Z)((0,v.Z)().mark((function e(){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a._oidc.getUser().then((function(e){if(null!==e)return e.access_token;te.onError(Q,new z(N,"Failed to obtain user profile."))}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))),this.getUser=(0,f.Z)((0,v.Z)().mark((function e(){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a._oidc.getUser().then((function(e){return null===e&&te.onError(Q,new z(N,"Failed to obtain user information.")),Zn(e)}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));var o="code";void 0!==n.grantType&&"implicit"===n.grantType&&(o="id_token token"),this._oidc=new wn.UserManager({authority:n.authority,client_id:n.clientId,redirect_uri:t,scope:n.scope,response_type:o,loadUserInfo:!0,automaticSilentRenew:!0,revokeAccessTokenOnSignout:!0,post_logout_redirect_uri:"".concat(t,"/logout")}),null!=n.endSessionEndpoint&&this._oidc.metadataService.getMetadata().then((function(e){null!=n.endSessionEndpoint&&(e.end_session_endpoint=n.endSessionEndpoint,a._oidc=new wn.UserManager({authority:n.authority,client_id:n.clientId,redirect_uri:t,scope:n.scope,response_type:o,loadUserInfo:!0,automaticSilentRenew:!0,revokeAccessTokenOnSignout:!0,post_logout_redirect_uri:"".concat(t,"/logout"),metadata:e}))})).catch((function(e){console.error("failed to get metadata from authorization server: ",e)}))})),On=n(7659),Rn=n(9158);const jn=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{retries:5,factor:3,minTimeout:1e3,maxTimeout:6e4,randomize:!0,retryableStatusCodes:[429,500]},t=e;null!=e.retries&&(t.retries=e.retries),null!=e.factor&&(t.factor=e.factor),null!=e.minTimeout&&(t.minTimeout=e.minTimeout),null!=e.maxTimeout&&(t.maxTimeout=e.maxTimeout),null!=e.randomize&&(t.randomize=e.randomize),null!=e.retryableStatusCodes&&(t.retryableStatusCodes=e.retryableStatusCodes);var n=function(e,n){var i=n.url,a=n.method;var o=e.send;return e.send=function(){var n=Rn.operation(t);n.attempt((function(o){var r=e.onreadystatechange;e.onreadystatechange=function(){if(null!=r){for(var a=arguments.length,o=new Array(a),s=0;s<a;s++)o[s]=arguments[s];r.apply(e,o)}if(t.retryableStatusCodes.includes(e.status)){var l="Attempt to request ".concat(i," failed."),c=new Error(l);n.retry(c)}},o>1&&(console.warn("Requesting ".concat(i,"... (attempt: ").concat(o,")")),e.open(a,i,!0))}));for(var r=arguments.length,s=new Array(r),l=0;l<r;l++)s[l]=arguments[l];o.apply(e,s)},e};return n};var Pn=S.aT.DicomMetaDictionary.naturalizeDataset,Mn=function(){function e(t){var n=this,a=t.baseUri,o=t.settings,r=t.onError;(0,i.Z)(this,e),this.stores=[],this.handleError=void 0,this.updateHeaders=function(e){for(var t in e)n.stores[0].client.headers[t]=e[t]},this.storeInstances=function(){var e=(0,f.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.stores[0].write){e.next=6;break}return e.next=3,n.stores[0].client.storeInstances(t);case 3:case 8:return e.abrupt("return",e.sent);case 6:return e.next=8,Promise.reject(new Error("Store is not writable."));case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.searchForStudies=function(){var e=(0,f.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.searchForStudies(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.searchForSeries=function(){var e=(0,f.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.searchForSeries(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.searchForInstances=function(){var e=(0,f.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.searchForInstances(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveStudyMetadata=function(){var e=(0,f.Z)((0,v.Z)().mark((function e(t){var i,a;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveStudyMetadata(t);case 2:return i=e.sent,a=Pn(i),mn.addStudy(a),e.abrupt("return",i);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveSeriesMetadata=function(){var e=(0,f.Z)((0,v.Z)().mark((function e(t){var i,a;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveSeriesMetadata(t);case 2:return i=e.sent,a=i.map(Pn),mn.addSeriesMetadata(a,!0),e.abrupt("return",i);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveInstanceMetadata=function(){var e=(0,f.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveInstanceMetadata(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveInstance=function(){var e=(0,f.Z)((0,v.Z)().mark((function e(t){var i,a,o,r;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveInstance(t);case 2:return i=e.sent,a=S.aT.DicomMessage.readFile(i),o=U.metadata.formatMetadata(a.dict),r=o.dataset,mn.addInstances([r]),e.abrupt("return",i);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveInstanceFrames=function(){var e=(0,f.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveInstanceFrames(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveInstanceRendered=function(){var e=(0,f.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveInstanceRendered(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveInstanceFramesRendered=function(){var e=(0,f.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveInstanceFramesRendered(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveBulkData=function(){var e=(0,f.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveBulkData(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.handleError=null!=r?r:function(e,t){console.error(e,t)},o.forEach((function(e){var t,i,o;void 0===e&&te.onError(K,new z(G,"At least one server needs to be configured.")),void 0!==e.url?o=e.url:void 0!==e.path?o=xn(e.path,a):te.onError(K,new z(G,"Either path or full URL needs to be configured for server."));var r={url:o},s=!0===e.upgradeInsecureRequests&&[o,e.qidoPathPrefix,e.wadoPathPrefix,e.stowPathPrefix].some((function(e){var t;return null!==(t=null===e||void 0===e?void 0:e.startsWith("https"))&&void 0!==t&&t}));void 0!==e.qidoPathPrefix&&(r.qidoURLPrefix=e.qidoPathPrefix),void 0!==e.wadoPathPrefix&&(r.wadoURLPrefix=e.wadoPathPrefix),void 0!==e.stowPathPrefix&&(r.stowURLPrefix=e.stowPathPrefix),s&&(r.headers=(0,E.Z)((0,E.Z)({},r.headers),{},{"Content-Security-Policy":"upgrade-insecure-requests"})),void 0!==e.retry&&(r.requestHooks=[jn(e.retry)]),r.errorInterceptor=function(t){n.handleError(t,e)},n.stores.push({id:e.id,write:null!==(t=e.write)&&void 0!==t&&t,read:null===(i=e.read)||void 0===i||i,client:new On.hi.DICOMwebClient(r)})})),this.stores.length>1&&te.onError(K,new z(G,"Only one store is supported for now."))}return(0,a.Z)(e,[{key:"baseURL",get:function(){return this.stores[0].client.baseURL}},{key:"headers",get:function(){return this.stores[0].client.headers}}]),e}();function En(e){var t,n,i=e.clients,a=e.user,o=e.app,r=e.config,s=(0,c.UO)().studyInstanceUID,l=!(null!==(t=r.disableAnnotationTools)&&void 0!==t&&t),d=null!==(n=r.preload)&&void 0!==n&&n;return(0,b.jsx)(Lt,{clients:i,user:a,annotations:r.annotations,preload:d,app:o,enableAnnotationTools:l,studyInstanceUID:s})}const Un=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var a,r;(0,i.Z)(this,n),(r=t.call(this,e)).auth=void 0,r.handleDICOMwebError=function(e,t){401===e.status?r.signIn():403===e.status&&te.onError(Y,new z(G,"User is not authorized to access DICOMweb resources."));var n=function(){te.onError(Y,new z(G,"An unexpected server error occured."))};void 0!==t.errorMessages?t.errorMessages.forEach((function(t){e.status===t.status?r.setState({error:{status:e.status,message:t.message}}):500===e.status&&n()})):500===e.status&&n()},r.handleSignIn=function(e){var t=e.user,n=e.authorization;for(var i in r.state.clients){r.state.clients[i].updateHeaders({Authorization:n})}var a=window.localStorage.getItem("slim_path"),o=window.localStorage.getItem("slim_search");if(null!==a&&""!==a&&a!==window.location.pathname){var s=a;null!==o&&""!==o&&(s+=o),window.location.href=s}window.localStorage.removeItem("slim_path"),window.localStorage.removeItem("slim_search"),r.setState({user:t})},console.info("instatiate app"),console.info('app is located at "'.concat(e.config.path,'"'));var s=window.location,l=s.protocol,c=s.host,d="".concat(l,"//").concat(c),h=xn(e.config.path,d),p=e.config.oidc;void 0!==p&&(console.info("app uses the following OIDC configuration: ",e.config.oidc),r.auth=new Vn(h,p)),0===e.config.servers.length&&te.onError(K,new z(G,"One server needs to be configured.")),console.info("app uses the following DICOMweb server configuration: ",e.config.servers),r.handleServerSelection=r.handleServerSelection.bind((0,o.Z)(r)),u.ZP.config({duration:5}),r.addGcpSecondaryAnnotationServer(e.config);var v=function(e){var t=e.baseUri,n=e.gcpBaseUrl,i=e.settings,a=e.onError,o={default:0},r={};for(var s in i.forEach((function(e){if(null!=e.storageClasses)e.storageClasses.forEach((function(t){Object.values(M).includes(t)?t in o?o[t]+=1:o[t]=1:console.warn('unknown storage class "'.concat(t,'" specified ')+'for configured server "'.concat(e.id,'"'))}));else{if(window.location.pathname.includes("/projects/")){var i=window.location.pathname.split("/study/")[0],s="".concat(n).concat(i,"/dicomWeb");e.url=s}o.default+=1,r.default=new Mn({baseUri:t,settings:[e],onError:a})}})),o.default>1&&te.onError(K,new z(G,"Only one default server can be configured without specification of storage classes.")),o)"default"!==s&&o[s]>1&&te.onError(K,new z(G,"Only one configured server can specify a given storage class. "+'Storage class "'.concat(s,'" is specified by more than one ')+"of the configured servers."));return Object.keys(o).length>1&&i.forEach((function(e){var n=new Mn({baseUri:t,settings:[e],onError:a});null!=e.storageClasses&&e.storageClasses.forEach((function(e){r[e]=n}))})),Object.values(M).forEach((function(e){e in r||(r[e]=r.default)})),r}({baseUri:d,gcpBaseUrl:null!==(a=e.config.gcpBaseUrl)&&void 0!==a?a:"https://healthcare.googleapis.com/v1",settings:e.config.servers,onError:r.handleDICOMwebError});return r.state={clients:v,defaultClients:v,isLoading:!0,wasAuthSuccessful:!1},r}return(0,a.Z)(n,[{key:"addGcpSecondaryAnnotationServer",value:function(e){var t="gcp_secondary_annotation_server",n=new URLSearchParams(window.location.search).get("gcp");void 0===e.servers.find((function(e){return e.id===t}))&&"string"===typeof n&&e.servers.push({id:t,write:!0,url:n,storageClasses:[M.COMPREHENSIVE_SR,M.COMPREHENSIVE_3D_SR,M.SEGMENTATION,M.MICROSCOPY_BULK_SIMPLE_ANNOTATION,M.PARAMETRIC_MAP,M.ADVANCED_BLENDING_PRESENTATION_STATE,M.COLOR_SOFTCOPY_PRESENTATION_STATE,M.GRAYSCALE_SOFTCOPY_PRESENTATION_STATE,M.PSEUDOCOLOR_SOFTCOPY_PRESENTATION_STATE]})}},{key:"handleServerSelection",value:function(e){var t=e.url;if(console.info("select DICOMweb server: ",t),""!==t&&"default"!==window.localStorage.getItem("slim_server_selection_mode")){window.localStorage.setItem("slim_selected_server",t);var n=new Mn({baseUri:"",settings:[{id:"tmp",url:t,read:!0,write:!1}],onError:this.handleDICOMwebError});n.updateHeaders(this.state.clients.default.headers),this.setState((function(e){var t={};for(var i in e.clients)t[i]=n;return{clients:t}}))}else this.setState({clients:this.state.defaultClients})}},{key:"signIn",value:function(){var e=this;void 0!==this.auth?(console.info("try to sign in user"),this.auth.signIn({onSignIn:this.handleSignIn}).then((function(){console.info("sign-in was successful"),e.setState({isLoading:!1,wasAuthSuccessful:!0})})).catch((function(t){console.error(t),te.onError(Q,new z(N,"Could not sign-in user.")),e.setState({isLoading:!1,redirectTo:void 0,wasAuthSuccessful:!1})}))):this.setState({isLoading:!1,redirectTo:void 0,wasAuthSuccessful:!0})}},{key:"componentDidMount",value:function(){var e=window.localStorage.getItem("slim_path");null!==e&&""!==e||(window.localStorage.setItem("slim_path",window.location.pathname),window.localStorage.setItem("slim_search",window.location.search));var t=window.localStorage.getItem("slim_selected_server");null!==t&&""!==t&&this.handleServerSelection({url:t}),this.signIn()}},{key:"render",value:function(){var e,t,n,i=this,a={name:this.props.name,version:this.props.version,homepage:this.props.homepage,uid:"1.2.826.0.1.3680043.9.7433.1.5",organization:this.props.config.organization},o=!(null!==(e=this.props.config.disableWorklist)&&void 0!==e&&e),r=null!==(t=this.props.config.enableServerSelection)&&void 0!==t&&t;n=o?(0,b.jsx)(bn,{clients:this.state.clients}):(0,b.jsx)("div",{children:"Worklist has been disabled."});var s,l=!1;null!=this.props.config.oidc&&null!=this.props.config.oidc.endSessionEndpoint?(s=function(){null!=i.auth&&i.auth.signOut()},l=!0):(s=function(){},l=!1);var u={height:"100vh"},v={height:"100%"};return void 0!==this.state.redirectTo?(0,b.jsx)(d.VK,{basename:this.props.config.path,children:(0,b.jsx)(c.Fg,{to:this.state.redirectTo,replace:!0})}):this.state.isLoading?(0,b.jsx)(d.VK,{basename:this.props.config.path,children:(0,b.jsxs)(h.Z,{style:u,children:[(0,b.jsx)(yn,{app:a,user:this.state.user,showWorklistButton:!1,onServerSelection:this.handleServerSelection,showServerSelectionButton:!1,clients:this.state.clients,defaultClients:this.state.defaultClients}),(0,b.jsx)(h.Z.Content,{style:v,children:(0,b.jsx)(p.fCD,{})})]})}):this.state.wasAuthSuccessful?null!=this.state.error?(0,b.jsx)(In,{type:"error",message:this.state.error.message}):(0,b.jsx)(d.VK,{basename:this.props.config.path,children:(0,b.jsxs)(c.Z5,{children:[(0,b.jsx)(c.AW,{path:"/",element:(0,b.jsxs)(h.Z,{style:u,children:[(0,b.jsx)(yn,{app:a,user:this.state.user,showWorklistButton:!1,onServerSelection:this.handleServerSelection,onUserLogout:l?s:void 0,showServerSelectionButton:r,clients:this.state.clients,defaultClients:this.state.defaultClients}),(0,b.jsx)(h.Z.Content,{style:v,children:n})]})}),(0,b.jsx)(c.AW,{path:"/studies/:studyInstanceUID/*",element:(0,b.jsxs)(h.Z,{style:u,children:[(0,b.jsx)(yn,{app:a,user:this.state.user,showWorklistButton:o,onServerSelection:this.handleServerSelection,onUserLogout:l?s:void 0,showServerSelectionButton:r,clients:this.state.clients,defaultClients:this.state.defaultClients}),(0,b.jsx)(h.Z.Content,{style:v,children:(0,b.jsx)(En,{clients:this.state.clients,user:this.state.user,config:this.props.config,app:a})})]})}),(0,b.jsx)(c.AW,{path:"/projects/:project/locations/:location/datasets/:dataset/dicomStores/:dicomStore/study/:studyInstanceUID/*",element:(0,b.jsxs)(h.Z,{style:u,children:[(0,b.jsx)(yn,{app:a,user:this.state.user,showWorklistButton:o,onServerSelection:this.handleServerSelection,onUserLogout:l?s:void 0,showServerSelectionButton:r,clients:this.state.clients,defaultClients:this.state.defaultClients}),(0,b.jsx)(h.Z.Content,{style:v,children:(0,b.jsx)(En,{clients:this.state.clients,user:this.state.user,config:this.props.config,app:a})})]})}),(0,b.jsx)(c.AW,{path:"/logout",element:(0,b.jsxs)(h.Z,{style:u,children:[(0,b.jsx)(yn,{app:a,user:this.state.user,showWorklistButton:!1,onServerSelection:this.handleServerSelection,onUserLogout:l?s:void 0,showServerSelectionButton:r,clients:this.state.clients,defaultClients:this.state.defaultClients}),"Logged out"]})})]})}):(0,b.jsx)(In,{type:"error",message:"Sign-in failed."})}}]),n}(l.Component)}}]);
//# sourceMappingURL=499.38480dca.chunk.js.map