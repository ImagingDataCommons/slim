{"version":3,"file":"static/js/499.0ffb17fe.chunk.js","mappings":"qTA4BMA,EAAW,qGAqDd,OArDc,8BACf,WACE,IAAIC,EAAoC,aACpCC,EAAkB,YAEWC,IAA7BC,KAAKC,MAAMC,eAA+BF,KAAKC,MAAMC,gBACvDL,EAAS,WACTC,EAAkB,QAEpB,IAAMK,EAAQH,KAAKC,MAAMG,WAAWC,KAAI,SAACC,EAAiBC,GACxD,IAAMC,GAAMC,EAAAA,EAAAA,KACZ,OACE,SAAC,SAAiB,CAEhBC,MAAOJ,EAAKK,KACZC,WAAY,CACVC,WAAYf,GAEdgB,aAAc,CACZC,WAAY,IACZC,WAAY,WACZH,WAjBkB,QAmBpBI,KAAM,EAAE,SAEPX,EAAKY,OAZDV,EAeX,IACIW,EAAO,KAIX,YAHwBpB,IAApBC,KAAKC,MAAMkB,OACbA,GAAO,cAAMlB,MAAMkB,KAAI,MAGvB,UAAC,IAAI,CACHC,MAAOpB,KAAKC,MAAMoB,OAClBC,MAAOH,EACPI,KAAK,QACLC,UAAWxB,KAAKC,MAAMwB,WACtBC,cAAgC3B,IAAtBC,KAAKC,MAAMoB,OACrBM,QAAS3B,KAAKC,MAAM2B,QAAQ,WAE5B,SAAC,IAAY,CACXC,OAAQ,EACRN,KAAK,QACL1B,OAAQA,EACR6B,UAAU,EAAM,SAEfvB,IAEFH,KAAKC,MAAM6B,WAGlB,KAAC,EArDc,CAASC,EAAAA,WAwD1B,UC/BA,QAxCmB,qGAqChB,OArCgB,8BACjB,WACE,IAAM3B,EAAa,GAkCnB,OAjCoD,MAAhDJ,KAAKC,MAAM+B,SAASC,0BAEtB7B,EAAW8B,KAAI,MAAf9B,EACK,CACD,CACEO,KAAM,eACNO,MAAOlB,KAAKC,MAAM+B,SAASC,0BAE7B,CACEtB,KAAM,cACNO,MAAOlB,KAAKC,MAAM+B,SAASG,yBAE7B,CACExB,KAAM,gBACNO,MAAOlB,KAAKC,MAAM+B,SAASI,2BAE7B,CACEzB,KAAM,YACNO,MAAOlB,KAAKC,MAAM+B,SAASK,yBAKiB,MAAhDrC,KAAKC,MAAM+B,SAASM,0BAEtBlC,EAAW8B,KACT,CACEvB,KAAM,gBACNO,MAAOlB,KAAKC,MAAM+B,SAASM,4BAK1B,SAAC,EAAW,CAAClC,WAAYA,GAClC,KAAC,EArCgB,CAAS2B,EAAAA,WCX5B,SAASQ,EAAWrB,GAClB,MAAqB,kBAAVA,GAAgC,OAAVA,QAA4BnB,IAAVmB,QACxBnB,IAArBmB,EAAMsB,WACDtB,EAAMsB,WAAWC,MAAM,KAAKC,KAAK,KAIrC,EACT,CAEA,SAASC,EAAWzB,GAClB,GAAc,OAAVA,QAA4BnB,IAAVmB,EAAqB,CACzC,IAAM0B,EAAO1B,EAAM2B,UAAU,EAAG,GAC1BC,EAAQ5B,EAAM2B,UAAU,EAAG,GAC3BE,EAAM7B,EAAM2B,UAAU,EAAG,GAC/B,MAAM,GAAN,OAAUD,EAAI,YAAIE,EAAK,YAAIC,EAC7B,CACA,MAAO,EACT,CAEA,SAASC,EAAW9B,GAClB,GAAc,OAAVA,QAA4BnB,IAAVmB,EAAqB,CACzC,IAAM+B,EAAQ/B,EAAM2B,UAAU,EAAG,GAC3BK,EAAUhC,EAAM2B,UAAU,EAAG,GAC7BM,EAAUjC,EAAM2B,UAAU,EAAG,GACnC,MAAM,GAAN,OAAUI,EAAK,YAAIC,EAAO,YAAIC,EAChC,CACA,MAAO,EACT,CAeA,SAASC,EAAUlC,GAMjB,OAAc,OAAVA,QAA4BnB,IAAVmB,EALiB,CACrCmC,EAAG,SACHC,EAAG,OACHC,EAAG,SAGQrC,GAEN,EACT,CCdA,QA1Ba,qGAuBV,OAvBU,8BACX,WACE,IAAMd,EAAa,CACjB,CACEO,KAAM,KACNO,MAAOlB,KAAKC,MAAM+B,SAASwB,WAE7B,CACE7C,KAAM,OACNO,MAAOqB,EAAUvC,KAAKC,MAAM+B,SAASyB,cAEvC,CACE9C,KAAM,MACNO,MAAOkC,EAASpD,KAAKC,MAAM+B,SAAS0B,aAEtC,CACE/C,KAAM,YACNO,MAAOyB,EAAU3C,KAAKC,MAAM+B,SAAS2B,oBAGzC,OACE,SAAC,EAAW,CAACvD,WAAYA,GAE7B,KAAC,EAvBU,CAAS2B,EAAAA,WCuBtB,QAxBW,qGAqBR,OArBQ,8BACT,WACE,IAAM3B,EAAa,CACjB,CACEO,KAAM,cACNO,MAAOlB,KAAKC,MAAM+B,SAAS4B,iBAE7B,CACEjD,KAAM,KACNO,MAAOlB,KAAKC,MAAM+B,SAAS6B,SAE7B,CACElD,KAAM,OACNO,MAAOyB,EAAU3C,KAAKC,MAAM+B,SAAS8B,YAEvC,CACEnD,KAAM,OACNO,MAAO8B,EAAUhD,KAAKC,MAAM+B,SAAS+B,aAGzC,OAAO,SAAC,EAAW,CAAC3D,WAAYA,GAClC,KAAC,EArBQ,CAAS2B,EAAAA,W,ICdRiC,E,qBAWX,SAXWA,GAAAA,EAAc,iEAAdA,EAAc,iDAAdA,EAAc,oDAAdA,EAAc,4CAAdA,EAAc,iEAAdA,EAAc,4CAAdA,EAAc,oEAAdA,EAAc,iEAAdA,EAAc,qEAAdA,EAAc,uEAWzB,CAXWA,IAAAA,EAAc,KCC1B,IAAMC,EAAiBC,OAAO,iBACxBC,EAAsBD,OAAO,sBAOdE,EAAM,WACzB,cAAgB,eACdpE,KAAKiE,GAAkB,CAAC,EACxBjE,KAAKmE,GAAuB,CAC9B,CAsEC,OApED,iCAMA,SAAWE,EAAWC,GACpB,QAAkBvE,IAAdsE,EACF,MAAM,IAAIE,MAAM,8CAGlB,GAAwB,oBAAbD,EACT,MAAM,IAAIC,MAAM,4CAGbvE,KAAKiE,GAAgBO,eAAeH,KACvCrE,KAAKiE,GAAgBI,GAAa,CAAC,GAGrC,IAAMI,EAAc,aAASzE,KAAKmE,MAClCnE,KAAKiE,GAAgBI,GAAWI,GAAkBH,CACpD,GAEA,yBAMA,SAAaD,EAAWC,GACtB,IAAMI,EAAY1E,KAAKiE,GAAgBI,IAAc,CAAC,EACtD,IAAK,IAAMI,KAAkBC,EACtBJ,EAEMI,EAAUD,KAAoBH,UAChCI,EAAUD,UAFVC,EAAUD,EAKvB,GAEA,qBAMA,SAASJ,GACP,QAAkBtE,IAAdsE,EACF,MAAM,IAAIE,MAAM,yCAGqC,IAAvD,IAAMG,EAAY1E,KAAKiE,GAAgBI,IAAc,CAAC,EAAC,mBALlCM,EAAO,iCAAPA,EAAO,kBAM5B,IAAK,IAAMF,KAAkBC,EAC3BA,EAAUD,GAAe,MAAzBC,EAA6BC,EAEjC,GAEA,gCAIA,WACE,IAAK,IAAMN,KAAarE,KAAKiE,GAAiB,CAC5C,IAAMS,EAAY1E,KAAKiE,GAAgBI,GACvC,IAAK,IAAMI,KAAkBC,SACpBA,EAAUD,EAErB,CACF,KAAC,EA1EwB,G,oBCTrBG,EACY,iBADZA,EAEW,gBAFXA,EAGiB,mBAHjBA,EAIW,gBAGXC,EAAW,0CACf,WAAaC,EAAMC,GAAU,IAAD,EAIV,OAJU,gBAC1B,gBACKA,QAAUA,EACf,EAAKC,OAAQ,IAAIT,OAAQS,MACzB,EAAKF,KAAOA,EAAI,CAClB,CAAC,iBANc,EAMd,OANuBP,QCHbU,EACF,UADEA,EAEA,YAGAC,EACD,kBADCA,EAEN,0BAFMA,EAGJ,QAHIA,EAIL,OAJKA,EAKL,iBAGFC,EACG,QADHA,EAEK,UAWLC,GAA+B,CACnCC,QAAS,CACP,CACEC,SAAUV,EACVW,iBAAkBJ,GAEpB,CACEG,SAAUV,EACVW,iBAAkBJ,GAEpB,CACEG,SAAUV,EACVW,iBAAkBJ,GAEpB,CACEG,SAAUV,EACVW,iBAAkBJ,GAEpB,CACEG,SAAU,UACVC,iBAAkBJ,KAoExB,aA/D4B,0CAC1B,aAAgB,IAAD,kBACb,eAEA,IAAMK,EAAe,SAACC,GACpB,EAAKC,QAAQT,EAAwCU,MAAMC,KAAKH,GAAM/C,KAAK,KAC7E,EAUI,OARH,WACC,IAAMmD,EAAOC,QAAQD,KACrBC,QAAQD,KAAO,WACRE,KAAKC,UAAUC,WAAWC,SAAS,YACtCV,EAAaS,WAEfJ,EAAKM,MAAMnG,KAAM2F,MAAMS,UAAUC,MAAMC,KAAKL,WAC9C,CACD,CARA,GAQG,CACN,CA2CC,OAzCD,+BAMA,SAASM,EAAQC,GACf,IAYIC,EAZEC,EAAgBF,EAAM1B,KAKpBS,EAJaH,GAA6BC,QAAQsB,MACxD,SAAAC,GAAC,OAAIA,EAAEtB,WAAaoB,CAAa,IAG3BnB,iBAcR,OAZAvF,KAAK0F,QAAQT,EAAsC,CACjDsB,OAAAA,EACAC,MAAAA,IAKAC,EADED,aAAiB3B,EACD2B,EAAMzB,QAEN8B,OAAOL,GAGnBjB,GACN,KAAKJ,EAEH,OADAW,QAAQU,MAAM,KAAD,OAAME,EAAa,qBAAqBF,GAC9CM,EAAAA,EAAAA,MAAmB,CACxB/B,QAAQ,GAAD,OAAK2B,EAAa,UACzBK,YAAaN,EACbO,SAAU,IAGd,KAAK7B,EACHW,QAAQU,MAAM,KAAD,OAAME,EAAa,qBAAqBF,GAK3D,KAAC,EA5DyB,CAASpC,IC8ErC,SAvGe,0CAOb,WAAanE,GAAwB,IAAD,EAEH,OAFG,gBAClC,cAAMA,IAPRgH,MAAQ,CAAEC,WAAW,GAAO,EAEXC,oBAAsBpF,EAAAA,YAAiC,EAEhEqF,oBAAc,EAIpB,EAAKA,oBAAiBrH,EAAS,CACjC,CA0FC,OA1FA,yCAED,WAEE,GADAC,KAAKqH,SAAS,CAAEH,WAAW,IACvBlH,KAAKC,MAAMqH,MAAMC,eAAeC,OAAS,EAAG,CAC9C,IAAMxF,EAAWhC,KAAKC,MAAMqH,MAAMC,eAAe,GACR,OAArCvH,KAAKmH,oBAAoBM,UAC3BzH,KAAKmH,oBAAoBM,QAAQC,UAAY,GAC7C5B,QAAQ6B,KACN,kDAAiD,WAC7C3F,EAAS4F,oBAAmB,MAElC5H,KAAKoH,eAAiB,IAAIS,EAAAA,OAAAA,oBAA+B,CACvDC,OAAQ9H,KAAKC,MAAM8H,QACjB/D,EAAegE,iCAEjBC,qBAAqB,EACrBjG,SAAAA,EACAkG,aAAc,EACdC,iBAAkB,SAAC3B,GACjB4B,GAAAA,QACElD,EACAsB,EAEJ,IAEFxG,KAAKoH,eAAeiB,OAAO,CACzBC,UAAWtI,KAAKmH,oBAAoBM,UAG1C,CAEAzH,KAAKqH,SAAS,CAAEH,WAAW,GAC7B,GAAC,oBAED,gBAC8BnH,IAAxBC,KAAKoH,gBACPpH,KAAKoH,eAAemB,SAGtB,IAAMnI,EAAa,GACb2G,EAAc/G,KAAKC,MAAMqH,MAAMP,YAQrC,OAPoB,OAAhBA,GAAwC,KAAhBA,GAC1B3G,EAAW8B,KAAK,CACdvB,KAAM,cACNO,MAAO6F,IAIP/G,KAAKiH,MAAMC,WACL,SAAC,MAAS,KAOlB,SAAC,UAAS,gBACRsB,MAAO,CAAEC,OAAQ,SAEbzI,KAAKC,OAAK,cAEd,SAAC,EAAW,CACVoB,OAAQrB,KAAKC,MAAMqH,MAAMoB,oBACzBtI,WAAYA,EACZqB,YAAU,WAETzB,KAAKC,MAAMqH,MAAMC,eAAeC,OAAS,GAEtC,gBAAKgB,MAAO,CAAEC,OAAQ,SAAWE,IAAK3I,KAAKmH,uBAG3C,gBAAKqB,MAAO,CACVC,OAAQ,QACRG,UAAW,SACXC,QAAS,OACTC,WAAY,SACZC,eAAgB,SAChBC,SAAU,SACVjI,WAAY,IACZkI,MAAO,UACPC,cAAe,SACf,oBAvBHlJ,KAAKC,MAAMqH,MAAM6B,mBAAmB,GA+B/C,KAAC,EApGY,CAASpH,EAAAA,WCmDxB,SA1De,qJAGZ,OAHY,oCACbkF,MAAQ,CACNmC,0BAA2B,EAAKnJ,MAAMmJ,2BACvC,EAoDA,OApDA,yCAED,WACEpJ,KAAKC,MAAMoJ,kBAAkB,CAC3BC,kBAAmBtJ,KAAKiH,MAAMmC,2BAElC,GAAC,oBAED,WAGE,IAH0B,IAAD,OACnBG,EAAYvJ,KAAKC,MAAM+B,SACvBwH,EAAgB,GACbC,EAAI,EAAGA,EAAIF,EAAU/B,SAAUiC,EAAG,CACzC,IAAMnC,EAAQiC,EAAUE,GAClBC,GACJ,SAAC,GAAS,CAERpC,MAAOA,EACPS,QAAS/H,KAAKC,MAAM8H,SAFfT,EAAM6B,mBAAmB,IAMlCK,EAActH,KAAKwH,EACrB,CAEA,IAWIC,EAMJ,YAL6C5J,IAAzCC,KAAKiH,MAAMmC,2BAC4B,OAAzCpJ,KAAKiH,MAAMmC,4BACXO,EAAe,CAAC3J,KAAKiH,MAAMmC,6BAI3B,SAAC,IAAI,CACHZ,MAAO,CAAEoB,MAAO,QAChBD,aAAcA,EACdE,SArB4B,SAAH,GAKhB,IALsBC,EAAG,EAAHA,IAAY,EAAPC,QAAiB,EAARC,SAAsB,EAAZL,aAMzD7D,QAAQ6B,KAAK,iBAAD,OAAkBmC,EAAG,MACjC,EAAKzC,SAAS,CAAE+B,0BAA2BU,EAAIG,aAC/C,EAAKhK,MAAMoJ,kBAAkB,CAAEC,kBAAmBQ,EAAIG,YACxD,EAaIC,KAAK,SACLC,aAAc,EAAE,SAEfX,GAGP,KAAC,EAvDY,CAASzH,EAAAA,W,+MCuGxB,SAzGoB,0CAClB,WAAa9B,GAA6B,IAAD,EAE6B,OAF7B,gBACvC,cAAMA,IACDmK,uBAAyB,EAAKA,uBAAuBC,MAAK,WAAK,CACtE,CAkGC,OAlGA,8CAED,SACEC,EACAC,GAEAvK,KAAKC,MAAMuK,mBAAmB,CAC5BC,OAAQzK,KAAKC,MAAMyK,IAAIlK,IACvBmK,UAAWL,GAEf,GAAC,oBAED,WACE,IAAMM,EAAU,cAAU5K,KAAKC,MAAMM,MAAQ,GACvCH,EAAqD,GAK3D,EAAyDJ,KAAKC,MAApB4K,GAAzB,EAATF,UAA6B,EAAlBH,oBAAiC,eAsDpD,OArDAxK,KAAKC,MAAMyK,IAAII,YAAYC,SAAQ,SACjCzK,GAKA,IAAM0K,EAAY1K,EAAK2K,wBAAwB,GAAGC,UAC5CC,EAAc7K,EAAK2K,wBAAwB,GAAGG,YAC9CzK,EAAI,UAAMwK,GAChB,GAAI7K,EAAK+K,YAAcC,EAAAA,GAAAA,WAAAA,WAAAA,KAAqC,CAC1D,IACMC,EADkBjL,EACakL,oBAAoB,GAAGJ,YAE1C,cAAdJ,EACF5K,EAAW8B,KAAK,CACdvB,KAAM,oBACNO,MAAM,GAAD,OAAKqK,KAEW,WAAdP,EACT5K,EAAW8B,KAAK,CACdvB,KAAM,gBACNO,MAAM,GAAD,OAAKqK,KAEW,WAAdP,EACT5K,EAAW8B,KAAK,CACdvB,KAAM,iBACNO,MAAM,GAAD,OAAKqK,KAGZnL,EAAW8B,KAAK,CACdvB,KAAMA,EACNO,MAAM,GAAD,OAAKqK,IAGhB,MAAO,GAAIjL,EAAK+K,YAAcC,EAAAA,GAAAA,WAAAA,WAAAA,KAAqC,CACjE,IAAMG,EAAkBnL,EACxBF,EAAW8B,KAAK,CACdvB,KAAMA,EACNO,MAAOuK,EAAgBC,WAE3B,CACF,IACA1L,KAAKC,MAAMyK,IAAIiB,aAAaZ,SAAQ,SAAAzK,GAClC,IAAM6K,EAAc7K,EAAK2K,wBAAwB,GAAGG,YAC9CzK,EAAI,UAAMwK,GACVS,EAAMtL,EAAKuL,sBAAsB,GACjC3K,EAAQ0K,EAAIE,aAAaC,YAAY,GACrCC,EAAOJ,EAAIK,6BAA6B,GAAGf,UACjD9K,EAAW8B,KAAK,CACdvB,KAAMA,EACNO,MAAM,GAAD,OAAKA,EAAK,YAAI8K,IAEvB,KAEE,UAAC,KAAK,CAACE,MAAM,QAAO,WAClB,gBAAK1D,MAAO,CAAE2D,YAAa,QAAS,UAClC,SAAC,KAAM,CACL5K,KAAK,QACL6K,SAAUpM,KAAKoK,uBACfE,QAAStK,KAAKC,MAAM0K,UACpB0B,iBAAiB,SAAC,MAAK,IACvBC,mBAAmB,SAAC,MAAU,SAGlC,SAAC,UAAS,gBACR9D,MAAO,CAAEC,OAAQ,OAAQ0D,YAAa,QAElCtB,GAAU,cAEd,SAAC,EAAW,CACVxJ,OAAQuJ,EACRxK,WAAYA,EACZqB,YAAU,EACVvB,eAAa,MAPVF,KAAKC,MAAMyK,IAAIlK,OAY5B,KAAC,EAtGiB,CAASuB,EAAAA,WC6D7B,SA5DoB,0CAClB,WAAa9B,GAA6B,IAAD,EAG6B,OAH7B,gBACvC,cAAMA,IACDsM,wBAA0B,EAAKA,wBAAwBlC,MAAK,WACjE,EAAKD,uBAAyB,EAAKA,uBAAuBC,MAAK,WAAK,CACtE,CAoDC,OApDA,8CAED,SACEC,EACAC,GACO,IAAD,OACFD,EACFtK,KAAKC,MAAMuM,KAAKzB,SAAQ,SAAAL,GACtB,EAAKzK,MAAMuK,mBAAmB,CAAEC,OAAQC,EAAIlK,IAAKmK,UAAWL,GAC9D,IAEAtK,KAAKC,MAAMwM,eAAe1B,SAAQ,SAAAN,GAChC,EAAKxK,MAAMuK,mBAAmB,CAAEC,OAAAA,EAAQE,UAAWL,GACrD,GAEJ,GAAC,qCAED,SAAyBoC,GACvB1M,KAAKC,MAAM0M,YAAYD,EAAO5C,IAChC,GAAC,oBAED,WAA4B,IAAD,OACnB3J,EAAQH,KAAKC,MAAMuM,KAAKnM,KAAI,SAACqK,EAAKnK,GAAK,OAC3C,SAAC,GAAc,CAEbmK,IAAKA,EACLnK,MAAOA,EACPoK,UAAW,EAAK1K,MAAMwM,eAAeG,IAAIlC,EAAIlK,KAC7CgK,mBAAoB,EAAKvK,MAAMuK,oBAJ1BE,EAAIlK,IAKT,IAGJ,OACE,iCACE,gBAAKgI,MAAO,CAAE2D,YAAa,OAAQU,WAAY,MAAOC,cAAe,OAAQ,UAC3E,SAAC,KAAM,CACLvL,KAAK,QACL6K,SAAUpM,KAAKoK,uBACfE,QAAStK,KAAKC,MAAMwM,eAAelL,KAAO,EAC1C8K,iBAAiB,SAAC,MAAK,IACvBC,mBAAmB,SAAC,MAAU,SAGlC,SAAC,IAAI,CACH3C,cAAY,QAAM3J,KAAKC,MAAM8M,gBAAgBC,UAC7CnD,SAAU7J,KAAKuM,wBACfU,QAASjN,KAAKuM,wBAAwB,SAErCpM,MAIT,KAAC,EAzDiB,CAAS4B,EAAAA,W,4JCumB7B,SAlkByB,0CACvB,WAAa9B,GAAkC,IAAD,EAgB3C,OAhB2C,gBAC5C,cAAMA,IACDmK,uBAAyB,EAAKA,uBAAuBC,MAAK,WAC/D,EAAK6C,2BAA6B,EAAKA,2BAA2B7C,MAAK,WACvE,EAAK8C,oBAAsB,EAAKA,oBAAoB9C,MAAK,WACzD,EAAK+C,mBAAqB,EAAKA,mBAAmB/C,MAAK,WACvD,EAAKgD,mBAAqB,EAAKA,mBAAmBhD,MAAK,WACvD,EAAKiD,mBAAqB,EAAKA,mBAAmBjD,MAAK,WACvD,EAAKkD,gBAAkB,EAAKA,gBAAgBlD,MAAK,WACjD,EAAKmD,2BAA6B,EAAKA,2BAA2BnD,MAAK,WACvE,EAAKpD,MAAQ,CACX0D,UAAW,EAAK1K,MAAM0K,UACtB8C,aAAc,CACZC,QAAS,EAAKzN,MAAM0N,aAAaD,QACjCzE,MAAO,EAAKhJ,MAAM0N,aAAa1E,QAElC,CACH,CA6iBC,OA7iBA,8CAED,SACEqB,EACAC,GAEAvK,KAAKC,MAAMuK,mBAAmB,CAC5BoD,mBAAoB5N,KAAKC,MAAM4N,gBAAgBrN,IAC/CmK,UAAWL,IAEbtK,KAAKqH,SAAS,CAAEsD,UAAWL,GAC7B,GAAC,iCAED,SAAqBpJ,GACN,MAATA,IACFlB,KAAKC,MAAM6N,cAAc,CACvBtN,IAAKR,KAAKC,MAAM4N,gBAAgBrN,IAChCuN,aAAc,CACZL,QAASxM,KAGblB,KAAKqH,SAAS,CACZoG,aAAc,CACZC,QAASxM,EACT+H,MAAOjJ,KAAKiH,MAAMwG,aAAaxE,MAC/B+E,YAAahO,KAAKiH,MAAMwG,aAAaO,eAI7C,GAAC,gCAED,SACE9M,GAEA,GAAa,MAATA,QAAmDnB,IAAlCC,KAAKiH,MAAMwG,aAAaxE,MAAqB,CAChE,IAAMA,EAAQ,CACZtD,MAAMsI,QAAQ/M,GAASA,EAAM,GAAKA,EAClClB,KAAKiH,MAAMwG,aAAaxE,MAAM,GAC9BjJ,KAAKiH,MAAMwG,aAAaxE,MAAM,IAEhCjJ,KAAKqH,UAAS,SAAAJ,GAAK,MAAK,CACtBwG,aAAc,CACZxE,MAAOA,EACPyE,QAASzG,EAAMwG,aAAaC,QAC5BM,YAAa/G,EAAMwG,aAAaO,aAEnC,IACDhO,KAAKC,MAAM6N,cAAc,CACvBtN,IAAKR,KAAKC,MAAM4N,gBAAgBrN,IAChCuN,aAAc,CAAE9E,MAAOA,IAE3B,CACF,GAAC,gCAED,SACE/H,GAEA,GAAa,MAATA,QAAmDnB,IAAlCC,KAAKiH,MAAMwG,aAAaxE,MAAqB,CAChE,IAAMA,EAAQ,CACZjJ,KAAKiH,MAAMwG,aAAaxE,MAAM,GAC9BtD,MAAMsI,QAAQ/M,GAASA,EAAM,GAAKA,EAClClB,KAAKiH,MAAMwG,aAAaxE,MAAM,IAEhCjJ,KAAKqH,UAAS,SAAAJ,GAAK,MAAK,CACtBwG,aAAc,CACZxE,MAAOA,EACPyE,QAASzG,EAAMwG,aAAaC,QAC5BM,YAAa/G,EAAMwG,aAAaO,aAEnC,IACDhO,KAAKC,MAAM6N,cAAc,CACvBtN,IAAKR,KAAKC,MAAM4N,gBAAgBrN,IAChCuN,aAAc,CAAE9E,MAAOA,IAE3B,CACF,GAAC,gCAED,SACE/H,GAEA,GAAa,MAATA,QAAmDnB,IAAlCC,KAAKiH,MAAMwG,aAAaxE,MAAqB,CAChE,IAAMA,EAAQ,CACZjJ,KAAKiH,MAAMwG,aAAaxE,MAAM,GAC9BjJ,KAAKiH,MAAMwG,aAAaxE,MAAM,GAC9BtD,MAAMsI,QAAQ/M,GAASA,EAAM,GAAKA,GAEpClB,KAAKqH,UAAS,SAAAJ,GAAK,MAAK,CACtBwG,aAAc,CACZxE,MAAOA,EACPyE,QAASzG,EAAMwG,aAAaC,QAC5BM,YAAa/G,EAAMwG,aAAaO,aAEnC,IACDhO,KAAKC,MAAM6N,cAAc,CACvBtN,IAAKR,KAAKC,MAAM4N,gBAAgBrN,IAChCuN,aAAc,CAAE9E,MAAOA,IAE3B,CACF,GAAC,6BAED,WACE,IAAiB+D,EAOjB,OAAqC,MAAjChN,KAAKiH,MAAMwG,aAAaxE,MAHnB,KAAO,WAJC+D,EAQAhN,KAAKiH,MAAMwG,aAAaxE,OAPtB,IAGe,KAFtB+D,EAAO,IAE2B,GADlCA,EAAO,IACmC/C,SAAS,IAAI5D,MAAM,GAMhE,OAEX,GAAC,oCAED,SACEnF,GAEa,MAATA,QAAyDnB,IAAxCC,KAAKiH,MAAMwG,aAAaO,cAC3ChO,KAAKqH,UAAS,SAAAJ,GACZ,YAAuClH,IAAnCkH,EAAMwG,aAAaO,YACd,CACLP,aAAc,CACZxE,MAAOhC,EAAMwG,aAAaxE,MAC1ByE,QAASzG,EAAMwG,aAAaC,QAC5BM,YAAa,CAAC9M,EAAO+F,EAAMwG,aAAaO,YAAY,MAIjD,CACLP,aAAc,CACZxE,MAAOhC,EAAMwG,aAAaxE,MAC1ByE,QAASzG,EAAMwG,aAAaC,QAC5BM,YAAa/G,EAAMwG,aAAaO,aAIxC,IACAhO,KAAKC,MAAM6N,cAAc,CACvBtN,IAAKR,KAAKC,MAAM4N,gBAAgBrN,IAChCuN,aAAc,CACZC,YAAa,CACX9M,EACAlB,KAAKiH,MAAMwG,aAAaO,YAAY,OAK9C,GAAC,oCAED,SACE9M,GAEa,MAATA,QAAyDnB,IAAxCC,KAAKiH,MAAMwG,aAAaO,cAC3ChO,KAAKqH,UAAS,SAAAJ,GACZ,YAAuClH,IAAnCkH,EAAMwG,aAAaO,YACd,CACLP,aAAc,CACZxE,MAAOhC,EAAMwG,aAAaxE,MAC1ByE,QAASzG,EAAMwG,aAAaC,QAC5BM,YAAa,CAAC/G,EAAMwG,aAAaO,YAAY,GAAI9M,KAI9C,CACLuM,aAAc,CACZxE,MAAOhC,EAAMwG,aAAaxE,MAC1ByE,QAASzG,EAAMwG,aAAaC,QAC5BM,YAAa/G,EAAMwG,aAAaO,aAIxC,IACAhO,KAAKC,MAAM6N,cAAc,CACvBtN,IAAKR,KAAKC,MAAM4N,gBAAgBrN,IAChCuN,aAAc,CACZC,YAAa,CACXhO,KAAKiH,MAAMwG,aAAaO,YAAY,GACpC9M,MAKV,GAAC,+BAED,SACE8L,GAEAhN,KAAKqH,UAAS,SAAAJ,GAAK,MAAK,CACtBwG,aAAc,CACZxE,MAAOhC,EAAMwG,aAAaxE,MAC1ByE,QAASzG,EAAMwG,aAAaC,QAC5BM,YAAahB,GAEhB,IACDhN,KAAKC,MAAM6N,cAAc,CACvBtN,IAAKR,KAAKC,MAAM4N,gBAAgBrN,IAChCuN,aAAc,CAAEC,YAAahB,IAEjC,GAAC,wCAED,WACEhN,KAAKC,MAAMiO,uBAAuBlO,KAAKC,MAAM4N,gBAAgBrN,IAC/D,GAAC,wCAED,SAA4BU,EAAgBiN,GAAqB,IAAD,OAC9D,GAAa,MAATjN,GAAoC,MAAnBiN,EAAOrM,SAAkB,CAC5C,IAAMsM,EAAiBlN,EAAMuB,MAAM,KAC7B4L,EAAc,IAAI/C,EAAAA,GAAAA,OAAAA,aAA6B,CACnDpK,MAAOkN,EAAe,GACtBE,iBAAkBF,EAAe,GACjCG,QAASJ,EAAOrM,WAElB9B,KAAKC,MAAM6N,cAAc,CACvBtN,IAAKR,KAAKC,MAAM4N,gBAAgBrN,IAChCuN,aAAc,CAAEM,YAAAA,KAElBrO,KAAKqH,UAAS,SAAAJ,GAAK,MAAK,CACtBwG,aAAc,CACZC,QAASzG,EAAMwG,aAAaC,QAC5BW,YAAAA,GAEH,GACH,MACErO,KAAKC,MAAM6N,cAAc,CACvBtN,IAAKR,KAAKC,MAAM4N,gBAAgBrN,IAChCuN,aAAc,CACZ9E,MAAOjJ,KAAKC,MAAM0N,aAAa1E,SAGnCjJ,KAAKqH,UAAS,SAAAJ,GAAK,MAAK,CACtBwG,aAAc,CACZC,QAASzG,EAAMwG,aAAaC,QAC5BzE,MAAO,EAAKhJ,MAAM0N,aAAa1E,MAC/B+E,iBAAajO,GAEhB,GAEL,GAAC,oBAED,WAA4B,IAAD,EAuDrByO,EAyFAC,EACAC,EAjJqB,OACnBnO,EAAQP,KAAKC,MAAM+B,SAAS2M,wBAAwBC,WACxD,SAAAtO,GAAI,OAAKA,EAAKuO,qBAAuB,EAAK5O,MAAM4N,gBAAgBrN,GAAG,IAE/DF,EAAON,KAAKC,MAAM+B,SAAS2M,wBAAwBpO,GACnDH,EAAqD,CACzD,CACEO,KAAM,gBACNO,MAAOlB,KAAKC,MAAM4N,gBAAgBiB,aAAa1D,aAEjD,CACEzK,KAAM,oBACNO,MAAOlB,KAAKC,MAAM4N,gBAAgBkB,iBAAiB3D,aAMrD,CACEzK,KAAM,eACNO,MAAOZ,EAAK0O,aAEd,CACErO,KAAM,6BACNO,MAAOlB,KAAKC,MAAM+B,SAASiN,2BAIzBC,EAAgD,QAA5B,EAAG5O,EAAK6O,4BAAoB,QAAI,GACpDC,EAAqBF,EAAqB7O,KAAI,SAACgP,EAAiB5F,GACpE,IAAM9I,EAAO0O,EAAgBpE,wBAAwB,GACrD,OACE,SAAC,YAAa,CAEZ/J,MAAK,UAAKP,EAAK2O,uBAAsB,YAAI3O,EAAKuK,WAC9CqE,0BAA0B,EAC1BhO,KAAK,QACLiO,UAAW,EAAKvP,MAAM0K,UAAU,SAE/BhK,EAAKyK,aAND3B,EASX,IAwGA,GAvGA2F,EAAmBlN,MACjB,SAAC,YAAa,CAEZhB,WAAOnB,EACPwP,0BAA0B,EAC1BhO,KAAK,QACLiO,UAAWxP,KAAKC,MAAM0K,UAAU,UAEhC,yBANI,MAW6B,MAAjC3K,KAAKiH,MAAMwG,aAAaxE,QAC1BuF,GACE,iCACE,SAAC,KAAO,CAACiB,OAAK,sBAGd,UAAC,KAAG,CAACC,QAAQ,SAASxD,MAAM,SAASyD,OAAQ,CAAC,EAAG,GAAG,WAClD,SAAC,KAAG,CAAC1O,KAAM,EAAE,kBAGb,SAAC,KAAG,CAACA,KAAM,GAAG,UACZ,SAAC,KAAM,CACL2O,OAAO,EACPC,IAAK,EACLC,IAAK,IACLC,KAAM,EACN7O,MAAOlB,KAAKiH,MAAMwG,aAAaxE,MAAM,GACrCmD,SAAUpM,KAAKoN,wBAGnB,SAAC,KAAG,CAACnM,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK,EACLC,IAAK,IACLvO,KAAK,QACLiH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaxE,MAAM,GACrCmD,SAAUpM,KAAKoN,2BAKrB,UAAC,KAAG,CAACsC,QAAQ,SAASxD,MAAM,SAASyD,OAAQ,CAAC,EAAG,GAAG,WAClD,SAAC,KAAG,CAAC1O,KAAM,EAAE,oBAGb,SAAC,KAAG,CAACA,KAAM,GAAG,UACZ,SAAC,KAAM,CACL2O,OAAO,EACPC,IAAK,EACLC,IAAK,IACLC,KAAM,EACN7O,MAAOlB,KAAKiH,MAAMwG,aAAaxE,MAAM,GACrCmD,SAAUpM,KAAKqN,wBAGnB,SAAC,KAAG,CAACpM,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK,EACLC,IAAK,IACLvO,KAAK,QACLiH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaxE,MAAM,GACrCmD,SAAUpM,KAAKqN,2BAKrB,UAAC,KAAG,CAACqC,QAAQ,SAASxD,MAAM,SAASyD,OAAQ,CAAC,EAAG,GAAG,WAClD,SAAC,KAAG,CAAC1O,KAAM,EAAE,mBAGb,SAAC,KAAG,CAACA,KAAM,GAAG,UACZ,SAAC,KAAM,CACL2O,OAAO,EACPC,IAAK,EACLC,IAAK,IACLC,KAAM,EACN7O,MAAOlB,KAAKiH,MAAMwG,aAAaxE,MAAM,GACrCmD,SAAUpM,KAAKsN,wBAGnB,SAAC,KAAG,CAACrM,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK,EACLC,IAAK,IACLvO,KAAK,QACLiH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaxE,MAAM,GACrCmD,SAAUpM,KAAKsN,2BAIrB,SAAC,KAAO,CAACmC,OAAK,QAOhBP,EAAqB1H,OAAS,EAAG,CACnC,GAA2C,MAAvCxH,KAAKiH,MAAMwG,aAAaO,YAAqB,CAI/CS,GACE,iCACE,SAAC,KAAO,CAACgB,OAAK,mCAGd,UAAC,KAAG,CAACC,QAAQ,SAASxD,MAAM,SAASyD,OAAQ,CAAC,EAAG,GAAG,WAClD,SAAC,KAAG,CAAC1O,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK,EACLC,IAAK9P,KAAKiH,MAAMwG,aAAaO,YAAY,GACzCzM,KAAK,QACLiH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaO,YAAY,GAC3C5B,SAAUpM,KAAKgQ,4BAGnB,SAAC,KAAG,CAAC/O,KAAM,GAAG,UACZ,SAAC,KAAM,CACL2O,OAAK,EACLC,IArBO,EAsBPC,IArBO,IAsBPC,KAAM,EACN7O,MAAO,CACLlB,KAAKiH,MAAMwG,aAAaO,YAAY,GACpChO,KAAKiH,MAAMwG,aAAaO,YAAY,IAEtC5B,SAAUpM,KAAKiQ,uBAGnB,SAAC,KAAG,CAAChP,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK7P,KAAKiH,MAAMwG,aAAaO,YAAY,GACzC8B,IAjCO,IAkCPvO,KAAK,QACLiH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaO,YAAY,GAC3C5B,SAAUpM,KAAKkQ,gCAM3B,CACAxB,GACE,iCACE,SAAC,KAAO,CAACe,OAAK,4BAGd,UAAC,KAAG,CAACC,QAAQ,QAAQxD,MAAM,SAASyD,OAAQ,CAAC,EAAG,GAAG,WACjD,SAAC,KAAG,CAAC1O,KAAM,EAAE,0BAGb,SAAC,KAAG,CAACA,KAAM,GAAG,UACZ,SAAC,KAAM,CACLuH,MAAO,CAAE2H,SAAU,OAAQvG,MAAO,OAClCC,SAAU7J,KAAKkN,2BAEfkD,kBAAcrQ,EAAU,SAEvBqP,GAHG,wCAShB,CAEA,IAAMiB,GACJ,2BACG7B,EACAC,GACD,UAAC,KAAG,CAACiB,QAAQ,QAAQxD,MAAM,SAASyD,OAAQ,CAAC,EAAG,GAAG,WACjD,SAAC,KAAG,CAAC1O,KAAM,EAAE,sBAGb,SAAC,KAAG,CAACA,KAAM,GAAG,UACZ,SAAC,KAAM,CACL2O,OAAO,EACPC,IAAK,EACLC,IAAK,EACLC,KAAM,IACN7O,MAAOlB,KAAKiH,MAAMwG,aAAaC,QAC/BtB,SAAUpM,KAAKmN,yBAGnB,SAAC,KAAG,CAAClM,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK,EACLC,IAAK,EACLvO,KAAK,QACLwO,KAAM,GACNvH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaC,QAC/BtB,SAAUpM,KAAKmN,2BAIpBuB,KAICzF,EAAQjJ,KAAKuN,kBACb+C,EACJtQ,KAAKiH,MAAM0D,WAAoD,MAAvC3K,KAAKiH,MAAMwG,aAAaY,YAElD,EAQIrO,KAAKC,MADJ4K,GANY,EAAfgD,gBACY,EAAZF,aACS,EAAThD,UACQ,EAAR3I,SACkB,EAAlBwI,mBACa,EAAbsD,eACa,eAEf,OACE,SAAC,UAAS,gBACRtF,MAAO,CAAEC,OAAQ,OAAQ0D,YAAa,OAEtCc,QAASjN,KAAKwN,4BACV3C,GAAU,cAEd,UAAC,KAAK,CAACqB,MAAM,QAAO,WAClB,gBAAK1D,MAAO,CAAE2D,YAAa,QAAS,UAClC,UAAC,KAAK,CAACoE,UAAU,WAAWrE,MAAM,MAAK,WACrC,SAAC,KAAM,CACL3K,KAAK,QACL6K,SAAUpM,KAAKoK,uBACfE,QAAStK,KAAKC,MAAM0K,UACpB0B,iBAAiB,SAAC,MAAK,IACvBC,mBAAmB,SAAC,MAAU,OAEhC,SAAC,KAAO,CACNkE,UAAU,OACVC,QAASJ,EACTK,aAAc,CAAE9G,MAAO,SACvBxI,MAAM,mBAAkB,UAExB,SAAC,KAAM,CACL0D,KAAK,UACL6L,MAAM,SACNxP,MAAM,SAACyP,GAAA,EAAe,cAK9B,SAAC,KAAK,CACJC,OAAQ,EAAE,GAAI,IACdC,MAAO,IACPtI,MAAO,CACLuI,YAAa,QACbC,YAAa,MACbC,YAAa,OACbC,WAAYZ,EAAiB,UAAY,SACzCa,gBAAgB,8BAAD,OAAgClI,EAAK,aAAKA,IACzD,UAEF,SAAC,EAAW,CACV5H,OAAQrB,KAAKC,MAAM4N,gBAAgBnN,MACnCN,WAAYA,EACZqB,YAAU,EACVvB,eAAa,WA3CdF,KAAKC,MAAM4N,gBAAgBrN,IAiDtC,KAAC,EA/jBsB,CAASuB,EAAAA,WCgDlC,SA/DyB,qJAqBtB,OArBsB,oCAIvBqI,uBAAyB,SAACE,GACpBA,EACF,EAAKrK,MAAMmR,iBAAiBrG,SAAQ,SAAC8C,GACnC,EAAK5N,MAAMoR,kCAAkC,CAC3CzD,mBAAoBC,EAAgBrN,IACpCmK,UAAWL,GAEf,IAIF,EAAKrK,MAAMqR,2BAA2BvG,SAAQ,SAAC6C,GAC7C,EAAK3N,MAAMoR,kCAAkC,CAC3CzD,mBAAAA,EACAjD,UAAWL,GAEf,GACF,EAAC,EAuCA,OAvCA,8BAED,WAA4B,IAAD,OACnBnK,EAAQH,KAAKC,MAAMmR,iBAAiB/Q,KAAI,SAACwN,EAAiBtN,GAC9D,IAAMC,EAAMqN,EAAgBrN,IAC5B,OACE,SAAC,GAAmB,CAElBqN,gBAAiBA,EACjBK,uBAAwB,EAAKjO,MAAMiO,uBACnClM,SAAU,EAAK/B,MAAM+B,SAASxB,GAC9BmK,UAAW,EAAK1K,MAAMqR,2BAA2B1E,IAAIpM,GACrDmN,aAAc,EAAK1N,MAAMsR,6BAA6B/Q,GACtDgK,mBAAoB,EAAKvK,MAAMoR,kCAC/BvD,cAAe,EAAK7N,MAAMuR,8BAPrB3D,EAAgBrN,IAU3B,IAEA,OACE,iCACE,gBACEgI,MAAO,CACL2D,YAAa,OACbU,WAAY,MACZC,cAAe,OACf,UAEF,SAAC,KAAM,CACLvL,KAAK,QACL6K,SAAUpM,KAAKoK,uBACfE,QAAStK,KAAKC,MAAMqR,2BAA2B/P,KAAO,EACtD8K,iBAAiB,SAAC,MAAK,IACvBC,mBAAmB,SAAC,MAAU,SAGlC,SAAC,IAAI,CAAC7K,YAAY,EAAM,SAAEtB,MAGhC,KAAC,EA5DsB,CAAS4B,EAAAA,WCmClC,SAjEY,0CACV,WAAa9B,GAAqB,IAAD,EAEe,OAFf,gBAC/B,cAAMA,IACDwR,YAAc,EAAKA,YAAYpH,MAAK,WAAK,CAChD,CA0DC,OA1DA,mCAED,SAAaE,QACgBxK,IAAvBC,KAAKC,MAAMgN,SACbjN,KAAKC,MAAMgN,QAAQ1C,EAEvB,GAAC,oBAED,WAA4B,IAAD,EAMrBmH,EAUAC,EAfEC,EAAO5R,KAAKC,MAAMkB,KACxB,YAAapB,IAAT6R,EACK,MAIe,MAApB5R,KAAKC,MAAMS,QACbgR,GACE,iCACE,SAAC,KAAO,CAAC5M,KAAK,aACb9E,KAAKC,MAAMS,UAOhBiR,EADuB,QAAzB,EAAI3R,KAAKC,MAAM4R,kBAAU,UAErB,SAAC,KAAG,CACF5E,QAASjN,KAAKyR,YACdtQ,MAAM,SAACyQ,EAAI,IACX9M,KAAK,UACL0D,MAAO,CAAE3H,WAAY,OAAQ,SAE5B6Q,KAKH,SAAC,KAAG,CACFzE,QAASjN,KAAKyR,YACdtQ,MAAM,SAACyQ,EAAI,IACX9M,KAAK,UACL0D,MAAO,CAAE3H,WAAY,OAAQ,SAE5B6Q,SAKoB3R,IAAvBC,KAAKC,MAAM6R,SAEX,SAAC,KAAO,CAAC1Q,MAAOpB,KAAKC,MAAM6R,QAAQ,SAChCH,IAIEA,EAEX,KAAC,EA9DS,CAAS5P,EAAAA,WC+BrB,SAjCe,qGA8BZ,OA9BY,8BACb,WACE,QAA4BhC,IAAxBC,KAAKC,MAAM+B,SACb,OAAO,KAET,IAAM5B,EAAa,CACjB,CACEO,KAAM,eACNO,MAAOlB,KAAKC,MAAM+B,SAAS+P,cAE7B,CACEpR,KAAM,aACNO,MAAOlB,KAAKC,MAAM+B,SAASgQ,uBAE7B,CACErR,KAAM,uBACNO,MAAOlB,KAAKC,MAAM+B,SAASiQ,oBAE7B,CACEtR,KAAM,oBACNO,MAAOlB,KAAKC,MAAM+B,SAASkQ,mBAS/B,OAN2C,MAAvClS,KAAKC,MAAM+B,SAASmQ,iBACtB/R,EAAW8B,KAAK,CACdvB,KAAM,mBACNO,MAAOlB,KAAKC,MAAM+B,SAASmQ,mBAGxB,SAAC,EAAW,CAAC/R,WAAYA,EAAYF,eAAa,GAC3D,KAAC,EA9BY,CAAS6B,EAAAA,WCHxB,IAmCaqQ,GAAyB,SAAH,GAKM,IAJrC3B,EAAO,EAAPA,QAAS9P,EAAI,EAAJA,KAKLR,EAA2C,GAMjD,OALAsQ,EAAQ1F,SAAQ,SAAAtB,IA1CF,SACdnJ,EACAK,GAEA,IAAM0R,EAAU/R,EAAK2K,wBAAwB,GAC7C,OACEoH,EAAQnH,YAAcvK,EAAKuK,WAC3BmH,EAAQ/C,yBAA2B3O,EAAK2O,sBAE5C,EAkCQgD,CAAQ7I,EAAG9I,IACbR,EAAM+B,KAAKuH,EAEf,IACOtJ,CACT,EC1CaoS,GAAe,SAC1BjS,EACAkS,GAEA,OAAOlS,EAAK+K,YAAcmH,CAC5B,EA4BMC,GAAU,SAACC,GAEf,IAAMC,EAAUP,GAAuB,CACrC3B,QAASiC,EAAOE,gBAChBjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,2BAGU,IAAnBoE,EAAQnL,QACVY,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,oJAMN,IAAMiO,EAAmBF,EAAQ,GAE3BG,EAAwBV,GAAuB,CACnD3B,QAASoC,EAAiBD,gBAC1BjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,wBAIP/B,EAAsB,GAwK5B,OAvKAsG,EAAsB/H,SAAQ,SAACzK,GAC7B,IACIyS,EADEjI,EAAc,GAEdkI,EAAQ1S,EACVH,EAAQiS,GAAuB,CACjC3B,QAASuC,EAAMJ,gBACfjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,iCAGQ,IAAjBpO,EAAMqH,QACRY,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,6NAON,IAAMqO,EAAkB9S,EAAM,GA+B9B,GArBqB,KARrBA,EAAQiS,GAAuB,CAC7B3B,QAASuC,EAAMJ,gBACfjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,eAGH/G,QACRY,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,0MAgBe,KARrBzE,EAAQiS,GAAuB,CAC7B3B,QAASuC,EAAMJ,gBACfjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,sBAGH/G,OAAc,CACtB,IAAM0L,EAAoB/S,EAAM,GAChC2K,EAAY5I,KAAKgR,GACjBH,EAAe,QACjB,MACEA,EAAe,SAWjB,GAAqB,KARrB5S,EAAQiS,GAAuB,CAC7B3B,QAASuC,EAAMJ,gBACfjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,yBAGH/G,OAAc,CACtB,IAAM2L,EAAuBhT,EAAM,GACnC2K,EAAY5I,KAAKiR,EACnB,CAUqB,KARrBhT,EAAQiS,GAAuB,CAC7B3B,QAASuC,EAAMJ,gBACfjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,oBAGH/G,QACRY,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,+MAON,IACIwO,EADEC,EAAalT,EAAM,GAEzB,GAA+B,UAA3BkT,EAAWrE,YACboE,EAAW,IAAIvL,EAAAA,SAAAA,MAAmB,CAChCyL,oBAAqBD,EAAWE,8BAChCC,YAAaH,EAAWI,kBAErB,CAEL,IADA,IAAMD,EAA0B,GACvB/J,EAAI,EAAGA,EAAI4J,EAAWI,YAAYjM,OAAQiC,GAAK,EACtD+J,EAAYtR,KAAKmR,EAAWI,YAAYpN,MAAMoD,EAAGA,EAAI,IAExB,YAA3B4J,EAAWrE,YACboE,EAAW,IAAIvL,EAAAA,SAAAA,QAAqB,CAClCyL,oBAAqBD,EAAWE,8BAChCC,YAAaA,IAEqB,eAA3BH,EAAWrE,YACpBoE,EAAW,IAAIvL,EAAAA,SAAAA,WAAwB,CACrCyL,oBAAqBD,EAAWE,8BAChCC,YAAaA,IAEqB,aAA3BH,EAAWrE,YACpBoE,EAAW,IAAIvL,EAAAA,SAAAA,SAAsB,CACnCyL,oBAAqBD,EAAWE,8BAChCC,YAAaA,IAEqB,YAA3BH,EAAWrE,YACpBoE,EAAW,IAAIvL,EAAAA,SAAAA,QAAqB,CAClCyL,oBAAqBD,EAAWE,8BAChCC,YAAaA,IAEqB,cAA3BH,EAAWrE,YACpBoE,EAAW,IAAIvL,EAAAA,SAAAA,UAAuB,CACpCyL,oBAAqBD,EAAWE,8BAChCC,YAAaA,IAGfpL,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,wDAAuD,WACnDyO,EAAWrE,YAAW,OAD1B,uKAQR,CAEAlE,EAAY5I,KAAI,MAAhB4I,GAAW,QAlMa,SAAH,GAEoB,IADzC2F,EAAO,EAAPA,QAEItQ,EAA+C,GAOrD,OANAsQ,EAAQ1F,SAAQ,SAAAtB,GACd,GAAI8I,GAAa9I,EAAG6B,EAAAA,GAAAA,WAAAA,WAAAA,MAAsC,CACxD,IAAMoI,EAAajK,EACnBtJ,EAAM+B,KAAKwR,EACb,CACF,IACOvT,CACT,CAwLSwT,CAAoB,CAAElD,QAASuC,EAAMJ,oBAE1C,IAAMjH,EAlNmB,SAAH,GAEkB,IADxC8E,EAAO,EAAPA,QAEItQ,EAA8C,GAOpD,OANAsQ,EAAQ1F,SAAQ,SAAAtB,GACd,GAAI8I,GAAa9I,EAAG6B,EAAAA,GAAAA,WAAAA,WAAAA,KAAqC,CACvD,IAAM+C,EAAc5E,EACpBtJ,EAAM+B,KAAKmM,EACb,CACF,IACOlO,CACT,CAuMyByT,CAAqB,CACxCnD,QAASuC,EAAMJ,kBAGXlI,EAAM,IAAI7C,EAAAA,IAAAA,IAAY,CAC1BuL,SAAUA,EACV5S,KAAKC,EAAAA,EAAAA,KACLoT,WAAY,CACVC,YAAab,EAAgBc,IAC7BhB,aAAcA,EACdjI,YAAaA,EACba,aAAcA,KAGlBa,EAAKtK,KAAKwI,EACZ,IACO8B,CACT,EAEMwH,IAAiB,QAiBrB,WAAatB,IAAyC,oBAhB/CuB,wBAAkB,OAElBC,6BAAuB,OAEvBC,uBAAiB,OAEjBC,wBAAkB,OAElBC,iBAAW,OAEXC,wBAAkB,OAElB1M,yBAAmB,OAEnB2M,KAAsB,GAG3B,IAAIpU,EAAQiS,GAAuB,CACjC3B,QAASiC,EAAOE,gBAChBjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,mBAGQ,IAAjBpO,EAAMqH,QACRY,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,qPAON,IAAM4P,EACJrU,EAAM,GAERH,KAAKqU,YAAcG,EAAgBT,IAUd,KARrB5T,EAAQiS,GAAuB,CAC7B3B,QAASiC,EAAOE,gBAChBjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,2BAGH/G,QACRY,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,4PAON,IAAM6P,EACJtU,EAAM,GAERH,KAAKsU,mBAAqBG,EAAe/I,UAUpB,KARrBvL,EAAQiS,GAAuB,CAC7B3B,QAASiC,EAAOE,gBAChBjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,qCAGH/G,QACRY,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,sQAON,IAAM8P,EACJvU,EAAM,GAYR,GAVAH,KAAK4H,oBAAsB8M,EAAgBhJ,UAUtB,KARrBvL,EAAQiS,GAAuB,CAC7B3B,QAASiC,EAAOE,gBAChBjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,4BAGH/G,OAAc,CACtB,IAAMmN,EACJxU,EAAM,GAERH,KAAKiU,mBAAqBU,EAAeC,UAC3C,CAUA,GAAqB,KARrBzU,EAAQiS,GAAuB,CAC7B3B,QAASiC,EAAOE,gBAChBjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,oCAGH/G,OAAc,CACtB,IAAMqN,EACJ1U,EAAM,GAERH,KAAKkU,wBAA0BW,EAAoBnJ,SACrD,CAUA,IARAvL,EAAQiS,GAAuB,CAC7B3B,QAASiC,EAAOE,gBAChBjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,2BAGH/G,OAAS,EAAG,CACpB,IAAMsN,EACJ3U,EAAM,GAERH,KAAKmU,kBAAoBW,EAAcf,GACzC,CAUA,GAAqB,KARrB5T,EAAQiS,GAAuB,CAC7B3B,QAASiC,EAAOE,gBAChBjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,4BAGH/G,OAAc,CACtB,IAAMuN,EACJ5U,EAAM,GAERH,KAAKoU,mBAAqBW,EAAerJ,SAC3C,CAEA1L,KAAKuU,KAAO9B,GAAQC,EACtB,IA+EF,SApEY,qGAiET,OAjES,8BACV,WACE,IAAMA,EAAS,IAAIsB,GAAkBhU,KAAKC,MAAM+U,SAC1CC,EAAiB,CACrB,CACEtU,KAAM,KACNO,MAAOwR,EAAO9K,sBAGZsN,EAAgB,CACpB,CACEvU,KAAM,KACNO,MAAOwR,EAAO4B,qBAGZa,EAAgB,CACpB,CACExU,KAAM,OACNO,MAAOwR,EAAOuB,qBAGZmB,EAAc1C,EAAO6B,KAAKlU,KAC9B,SAACqK,EAAKnK,GACJ,IAAM8U,EAAE,iBAAa9U,EAAQ,GACvB+U,EAAgD,GAqBtD,OApBA5K,EAAII,YAAYC,SAAQ,SACtBzK,GAKIA,EAAK+K,YAAcC,EAAAA,GAAAA,WAAAA,WAAAA,KAErBgK,EAAMpT,KAAK,CACTvB,KAAML,EAAK2K,wBAAwB,GAAGG,YACtClK,MAAOZ,EAAKkL,oBAAoB,GAAGJ,cAE5B9K,EAAK+K,YAAcC,EAAAA,GAAAA,WAAAA,WAAAA,MAE5BgK,EAAMpT,KAAK,CACTvB,KAAML,EAAK2K,wBAAwB,GAAGG,YACtClK,MAAOZ,EAAKoL,WAGlB,KACO,SAAC,EAAW,CAAerK,OAAQgU,EAAIjV,WAAYkV,GAAjC5K,EAAIlK,IAC/B,IAGF,OACE,4BACE,SAAC,KAAO,CAAC+U,YAAY,OAAM,sBAC3B,SAAC,EAAO,CAACvT,SAAUhC,KAAKC,MAAM+U,WAC9B,SAAC,KAAO,CAACO,YAAY,OAAM,mBAC3B,SAAC,EAAK,CAACvT,SAAUhC,KAAKC,MAAM+U,WAC5B,SAAC,KAAO,CAACO,YAAY,OAAM,oBAC3B,SAAC,EAAW,CAACnV,WAAY6U,KACzB,SAAC,KAAO,CAACM,YAAY,OAAM,uBAC3B,SAAC,EAAW,CAACnV,WAAY8U,KACzB,SAAC,KAAO,CAACK,YAAY,OAAM,uBAC3B,SAAC,EAAW,CAACnV,WAAY+U,KACzB,SAAC,KAAO,CAACI,YAAY,OAAM,yBAC1BH,IAGP,KAAC,EAjES,CAASrT,EAAAA,W,eC3WrB,SAjCU,qGA8BP,OA9BO,8BACR,WACE,IAUIX,EAVAoU,EAAS,KAgBb,YAf0BzV,IAAtBC,KAAKC,MAAMuV,SACbA,EAASxV,KAAKC,MAAMuV,OAAOnV,KAAI,SAACC,EAAMC,GAAa,OACjD,SAAC,EAAW,CAEVc,OAAQf,EAAKK,KACbP,WAAYE,EAAKF,YAFZG,EAGL,KAKJa,OADsBrB,IAApBC,KAAKC,MAAM6E,KACR,UAAM9E,KAAKC,MAAM6E,KAAI,aAAK9E,KAAKC,MAAM2K,YAElC5K,KAAKC,MAAM2K,YAGnB,UAAC,WAAS,YACR,SAAC,EAAW,CACVvJ,OAAQD,EACRhB,WAAYJ,KAAKC,MAAMG,WACvBF,cAAeF,KAAKC,MAAMC,cAAc,SAEvCsV,IAEFxV,KAAKC,MAAM6B,WARE9B,KAAKC,MAAMO,IAW/B,KAAC,EA9BO,CAASuB,EAAAA,WCfL,IAAIuJ,EAAAA,GAAAA,OAAAA,aAA6B,CAC3CpK,MAAO,WACPoN,iBAAkB,MAClBC,QAAS,wBAED,IAAIjD,EAAAA,GAAAA,OAAAA,aAA6B,CACzCpK,MAAO,YACPoN,iBAAkB,MAClBC,QAAS,gCAED,IAAIjD,EAAAA,GAAAA,OAAAA,aAA6B,CACzCpK,MAAO,YACPoN,iBAAkB,MAClBC,QAAS,sBAEC,IAAIjD,EAAAA,GAAAA,OAAAA,aAA6B,CAC3CpK,MAAO,UACPoN,iBAAkB,MAClBC,QAAS,wBArBN,IAyBMkH,GAET,CACFC,SAAU,IAAIpK,EAAAA,GAAAA,OAAAA,aAA6B,CACzCpK,MAAO,YACPoN,iBAAkB,MAClBC,QAAS,oBAEXoH,iBAAkB,IAAIrK,EAAAA,GAAAA,OAAAA,aAA6B,CACjDpK,MAAO,YACPoN,iBAAkB,MAClBC,QAAS,sBAIAqH,IAEZ,QACCC,oBAAqB,IAAIvK,EAAAA,GAAAA,OAAAA,aAA6B,CACpDpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,wBAEXuH,2BAA4B,IAAIxK,EAAAA,GAAAA,OAAAA,aAA6B,CAC3DpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,+BAEXwH,gBAAiB,IAAIzK,EAAAA,GAAAA,OAAAA,aAA6B,CAChDpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,oBAEXyH,uBAAwB,IAAI1K,EAAAA,GAAAA,OAAAA,aAA6B,CACvDpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,2BAEX0H,4BAA6B,IAAI3K,EAAAA,GAAAA,OAAAA,aAA6B,CAC5DpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,gCAEX2H,kBAAmB,IAAI5K,EAAAA,GAAAA,OAAAA,aAA6B,CAClDpK,MAAO,WACPoN,iBAAkB,MAClBC,QAAS,wBAEX4H,gBAAiB,IAAI7K,EAAAA,GAAAA,OAAAA,aAA6B,CAChDpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,oBAEX6H,MAAO,IAAI9K,EAAAA,GAAAA,OAAAA,aAA6B,CACtCpK,MAAO,YACPoN,iBAAkB,MAClBC,QAAS,qBAERkH,ICwDL,SA3HkB,qGAwHf,OAxHe,8BAChB,WAA4B,IAAD,SACzB,QAA4B1V,IAAxBC,KAAKC,MAAM+B,SACb,OAAO,KAET,IAAMqU,EAAsBrW,KAAKC,MAAM+B,SAASsU,4BAC9CtW,KAAKC,MAAMM,OAEPH,EAA0B,GAOhC,QANqDL,IAAjDsW,EAAoBE,0BACtBnW,EAAW8B,KAAK,CACdvB,KAAM,cACNO,MAAOmV,EAAoBE,gCAG8BxW,IAAzDsW,EAAoBG,kCAClBH,EAAoBG,iCAAiChP,OAAS,EAAG,CACnE,IAAMiP,EAAaJ,EAAoBG,iCACvCpW,EAAW8B,KAAK,CACdvB,KAAM,uBACNO,MAAOuV,EAAWpW,KAAI,SAAAC,GAAI,OAAIA,EAAK8K,WAAW,IAAE1I,KAAK,OAEzD,EAK+C,QADS,EACxD2T,EAAoBK,mCAA2B,QAAI,IAEpC3L,SACf,SAACgF,EAAwCxP,GACvCwP,EAAK4G,2CAA2C5L,SAAQ,SACtDzK,EAOAC,GAEA,IAAMI,EAAO,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CAC5CpK,MAAOZ,EAAK2K,wBAAwB,GAAGC,UACvCoD,iBACEhO,EAAK2K,wBAAwB,GAAGqE,uBAClCf,QAASjO,EAAK2K,wBAAwB,GAAGG,cAE3C,GAAI9K,EAAK+K,YAAcC,EAAAA,GAAAA,WAAAA,WAAAA,KAAqC,CAE1D,IAAMpK,EAAQ,IAAIoK,EAAAA,GAAAA,OAAAA,aAA6B,CAC7CpK,MAAOZ,EAAKkL,oBAAoB,GAAGN,UACnCoD,iBACEhO,EAAKkL,oBAAoB,GAAG8D,uBAC9Bf,QAASjO,EAAKkL,oBAAoB,GAAGJ,cAElCzK,EAAKiW,OAAOhB,GAA6BG,mBAE1CpV,EAAKiW,OAAOhB,GAA6BM,mBAEzC9V,EAAW8B,KAAK,CACdvB,KAAM,oBACNO,MAAOA,EAAMkK,cAGfzK,EAAKiW,OAAOhB,GAA6BF,UAEzCtV,EAAW8B,KAAK,CACdvB,KAAM,kBACNO,MAAOA,EAAMkK,cAGfzK,EAAKiW,OAAOhB,GAA6BD,kBAEzCvV,EAAW8B,KAAK,CACdvB,KAAM,0BACNO,MAAOA,EAAMkK,cAGfzK,EAAKiW,OAAOhB,GAA6BQ,QACzC,EAAKnW,MAAM4W,WAEXzW,EAAW8B,KAAK,CACdvB,KAAM,eACNO,MAAOA,EAAMkK,cAIrB,MAAW9K,EAAK+K,YAAcC,EAAAA,GAAAA,WAAAA,WAAAA,OAG1B3K,EAAKiW,OAAOhB,GAA6BQ,QACzC,EAAKnW,MAAM4W,UAEXzW,EAAW8B,KAAK,CACdvB,KAAM,eACNO,MAAOZ,EAAKoL,YAGd/K,EAAKiW,OAAOhB,GAA6BE,6BAEzC1V,EAAW8B,KAAK,CACdvB,KAAM,kBACNO,MAAOZ,EAAKoL,YAIpB,GACF,IAEF,IAAMlL,EAAM6V,EAAoBhC,YAC1BzJ,EAAayL,EAAoB/B,mBACvC,OACE,SAAC,GAAI,CACH9T,IAAKA,EAELoK,WAAYA,EACZxK,WAAYA,EACZF,eAAa,GAHRM,EAMX,KAAC,EAxHe,CAASuB,EAAAA,WC2B3B,SA/BkB,qGA4Bf,OA5Be,8BAChB,WAA4B,IAAD,SACzB,QAA4BhC,IAAxBC,KAAKC,MAAM+B,SACb,OAAO,KAOT,IACM7B,GAD8D,QAAlD,EAAGH,KAAKC,MAAM+B,SAASsU,mCAA2B,QAAI,IAC7CjW,KACzB,SAACC,EAAwCC,GACvC,OACE,SAAC,GAAY,CACXA,MAAOA,EAEPyB,SAAU,EAAK/B,MAAM+B,SACrB6U,UAAW,EAAK5W,MAAM4W,WAFjBvW,EAAK+T,YAKhB,IAEF,OACE,SAAC,MAAI,CAAC7L,MAAO,CAAEsO,UAAW,QAAS,SAChC3W,GAGP,KAAC,EA5Be,CAAS4B,EAAAA,W,uKCitB3B,SAvpBqB,0CACnB,WAAa9B,GAA8B,IAAD,EAoBvC,OApBuC,gBACxC,cAAMA,IACDmK,uBAAyB,EAAKA,uBAAuBC,MAAK,WAC/D,EAAK8C,oBAAsB,EAAKA,oBAAoB9C,MAAK,WACzD,EAAK4F,kBAAoB,EAAKA,kBAAkB5F,MAAK,WACrD,EAAK2F,uBAAyB,EAAKA,uBAAuB3F,MAAK,WAC/D,EAAK6F,uBAAyB,EAAKA,uBAAuB7F,MAAK,WAC/D,EAAK+C,mBAAqB,EAAKA,mBAAmB/C,MAAK,WACvD,EAAKgD,mBAAqB,EAAKA,mBAAmBhD,MAAK,WACvD,EAAKiD,mBAAqB,EAAKA,mBAAmBjD,MAAK,WACvD,EAAK0M,cAAgB,EAAKA,cAAc1M,MAAK,WAC7C,EAAK2M,iBAAmB,EAAKA,iBAAiB3M,MAAK,WACnD,EAAKpD,MAAQ,CACX0D,UAAW,EAAK1K,MAAM0K,UACtB8C,aAAc,CACZC,QAAS,EAAKzN,MAAM0N,aAAaD,QACjCzE,MAAO,EAAKhJ,MAAM0N,aAAa1E,MAC/BgO,wBAAyB,EAAKhX,MAAM0N,aAAasJ,wBACjDjJ,YAAa,EAAK/N,MAAM0N,aAAaK,cAExC,CACH,CA8nBC,OA9nBA,0CAED,SACEkJ,EACAC,GAEInX,KAAKC,MAAM0N,eAAiBuJ,EAAcvJ,cAC5C3N,KAAKqH,SAAS,CACZoG,aAAczN,KAAKC,MAAM0N,cAG/B,GAAC,oCAED,SACErD,EACAC,GAEA,IAAMK,EAAa5K,KAAKC,MAAMmX,YAAYxM,WAC1C5K,KAAKqH,SAAS,CACZsD,UAAWL,IAEbtK,KAAKC,MAAMuK,mBAAmB,CAC5B6M,sBAAuBzM,EACvBD,UAAWL,GAEf,GAAC,iCAED,SACEpJ,GAEA,GAAa,MAATA,EAAe,CACjB,IAAM0J,EAAa5K,KAAKC,MAAMmX,YAAYxM,WAC1C5K,KAAKC,MAAM6N,cAAc,CACvBuJ,sBAAuBzM,EACvBmD,aAAc,CAAEL,QAASxM,KAE3BlB,KAAKqH,UAAS,SAAAJ,GAAK,MAAK,CACtBwG,aAAc,CACZxE,MAAOhC,EAAMwG,aAAaxE,MAC1BgO,wBAAyBhQ,EAAMwG,aAAawJ,wBAC5CvJ,QAASxM,EACT8M,YAAa/G,EAAMwG,aAAaO,aAEnC,GACH,CACF,GAAC,gCAED,SACE9M,GAEA,IAAM0J,EAAa5K,KAAKC,MAAMmX,YAAYxM,WAC1C,GAAa,MAAT1J,QAAmDnB,IAAlCC,KAAKiH,MAAMwG,aAAaxE,MAAqB,CAChE,IAAMA,EAAQ,CACZtD,MAAMsI,QAAQ/M,GAASA,EAAM,GAAKA,EAClClB,KAAKiH,MAAMwG,aAAaxE,MAAM,GAC9BjJ,KAAKiH,MAAMwG,aAAaxE,MAAM,IAEhCjJ,KAAKqH,UAAS,SAAAJ,GAAK,MAAK,CACtBwG,aAAc,CACZxE,MAAOA,EACPgO,wBAAyBhQ,EAAMwG,aAAawJ,wBAC5CvJ,QAASzG,EAAMwG,aAAaC,QAC5BM,YAAa/G,EAAMwG,aAAaO,aAEnC,IACDhO,KAAKC,MAAM6N,cAAc,CACvBuJ,sBAAuBzM,EACvBmD,aAAc,CAAE9E,MAAOA,IAE3B,CACF,GAAC,gCAED,SACE/H,GAEA,IAAM0J,EAAa5K,KAAKC,MAAMmX,YAAYxM,WAC1C,GAAa,MAAT1J,QAAmDnB,IAAlCC,KAAKiH,MAAMwG,aAAaxE,MAAqB,CAChE,IAAMA,EAAQ,CACZjJ,KAAKiH,MAAMwG,aAAaxE,MAAM,GAC9BtD,MAAMsI,QAAQ/M,GAASA,EAAM,GAAKA,EAClClB,KAAKiH,MAAMwG,aAAaxE,MAAM,IAEhCjJ,KAAKqH,UAAS,SAAAJ,GAAK,MAAK,CACtBwG,aAAc,CACZxE,MAAOA,EACPgO,wBAAyBhQ,EAAMwG,aAAawJ,wBAC5CvJ,QAASzG,EAAMwG,aAAaC,QAC5BM,YAAa/G,EAAMwG,aAAaO,aAEnC,IACDhO,KAAKC,MAAM6N,cAAc,CACvBuJ,sBAAuBzM,EACvBmD,aAAc,CAAE9E,MAAOA,IAE3B,CACF,GAAC,gCAED,SACE/H,GAEA,IAAM0J,EAAa5K,KAAKC,MAAMmX,YAAYxM,WAC1C,GAAa,MAAT1J,QAAmDnB,IAAlCC,KAAKiH,MAAMwG,aAAaxE,MAAqB,CAChE,IAAMA,EAAQ,CACZjJ,KAAKiH,MAAMwG,aAAaxE,MAAM,GAC9BjJ,KAAKiH,MAAMwG,aAAaxE,MAAM,GAC9BtD,MAAMsI,QAAQ/M,GAASA,EAAM,GAAKA,GAEpClB,KAAKqH,UAAS,SAAAJ,GAAK,MAAK,CACtBwG,aAAc,CACZxE,MAAOA,EACPgO,wBAAyBhQ,EAAMwG,aAAawJ,wBAC5CvJ,QAASzG,EAAMwG,aAAaC,QAC5BM,YAAa/G,EAAMwG,aAAaO,aAEnC,IACDhO,KAAKC,MAAM6N,cAAc,CACvBuJ,sBAAuBzM,EACvBmD,aAAc,CAAE9E,MAAOA,IAE3B,CACF,GAAC,8BAED,WACE,IAAMqO,EAAU,SAACtK,GAIf,MAAO,KAAO,UAHJA,EAAO,IAGe,KAFtBA,EAAO,IAE2B,GADlCA,EAAO,IACmC/C,SAAS,IAAI5D,MAAM,EACzE,EAEA,OAAuD,MAAnDrG,KAAKC,MAAM0N,aAAasJ,wBACTjX,KAAKC,MAAM0N,aAAasJ,wBAAwBM,KACjDlX,KAAI,SAAA2M,GAAM,OAAIsK,EAAQtK,EAAO,IACH,MAAjChN,KAAKiH,MAAMwG,aAAaxE,MAC1B,CACL,UACAqO,EAAQtX,KAAKiH,MAAMwG,aAAaxE,QAG3B,CAAC,QAAS,QAErB,GAAC,oCAED,SACE/H,GAEA,IAAM0J,EAAa5K,KAAKC,MAAMmX,YAAYxM,WAC7B,MAAT1J,QAAyDnB,IAAxCC,KAAKiH,MAAMwG,aAAaO,cAC3ChO,KAAKqH,UAAS,SAAAJ,GACZ,YAAuClH,IAAnCkH,EAAMwG,aAAaO,YACd,CACLP,aAAc,CACZxE,MAAOhC,EAAMwG,aAAaxE,MAC1BgO,wBAAyBhQ,EAAMwG,aAAawJ,wBAC5CvJ,QAASzG,EAAMwG,aAAaC,QAC5BM,YAAa,CAAC9M,EAAO+F,EAAMwG,aAAaO,YAAY,MAIjD,CACLP,aAAc,CACZxE,MAAOhC,EAAMwG,aAAaxE,MAC1BgO,wBAAyBhQ,EAAMwG,aAAawJ,wBAC5CvJ,QAASzG,EAAMwG,aAAaC,QAC5BM,YAAa/G,EAAMwG,aAAaO,aAIxC,IACAhO,KAAKC,MAAM6N,cAAc,CACvBuJ,sBAAuBzM,EACvBmD,aAAc,CACZC,YAAa,CACX9M,EACAlB,KAAKiH,MAAMwG,aAAaO,YAAY,OAK9C,GAAC,oCAED,SACE9M,GAEA,IAAM0J,EAAa5K,KAAKC,MAAMmX,YAAYxM,WAC7B,MAAT1J,QAAyDnB,IAAxCC,KAAKiH,MAAMwG,aAAaO,cAC3ChO,KAAKqH,UAAS,SAAAJ,GACZ,YAAuClH,IAAnCkH,EAAMwG,aAAaO,YACd,CACLP,aAAc,CACZxE,MAAOhC,EAAMwG,aAAaxE,MAC1BgO,wBAAyBhQ,EAAMwG,aAAawJ,wBAC5CvJ,QAASzG,EAAMwG,aAAaC,QAC5BM,YAAa,CAAC/G,EAAMwG,aAAaO,YAAY,GAAI9M,KAI9C,CACLuM,aAAc,CACZxE,MAAOhC,EAAMwG,aAAaxE,MAC1BgO,wBAAyBhQ,EAAMwG,aAAawJ,wBAC5CvJ,QAASzG,EAAMwG,aAAaC,QAC5BM,YAAa/G,EAAMwG,aAAaO,aAIxC,IACAhO,KAAKC,MAAM6N,cAAc,CACvBuJ,sBAAuBzM,EACvBmD,aAAc,CACZC,YAAa,CACXhO,KAAKiH,MAAMwG,aAAaO,YAAY,GACpC9M,MAKV,GAAC,+BAED,SACE8L,GAEA,IAAMpC,EAAa5K,KAAKC,MAAMmX,YAAYxM,WAC1C5K,KAAKqH,UAAS,SAAAJ,GAAK,MAAK,CACtBwG,aAAc,CACZxE,MAAOhC,EAAMwG,aAAaxE,MAC1BgO,wBAAyBhQ,EAAMwG,aAAawJ,wBAC5CvJ,QAASzG,EAAMwG,aAAaC,QAC5BM,YAAahB,GAEhB,IACDhN,KAAKC,MAAM6N,cAAc,CACvBuJ,sBAAuBzM,EACvBmD,aAAc,CAAEC,YAAahB,IAEjC,GAAC,2BAED,WACE,IAAMpC,EAAa5K,KAAKC,MAAMmX,YAAYxM,WAC1C5K,KAAKC,MAAMuX,UAAU5M,EACvB,GAAC,oBAED,WAA4B,IAAD,EACnBA,EAAa5K,KAAKC,MAAMmX,YAAYxM,WACpC7D,EAAc/G,KAAKC,MAAMmX,YAAYrQ,YACrC3G,EAAqD,QACLL,IAAlDC,KAAKC,MAAMmX,YAAYK,wBACzBrX,EAAW8B,KACT,CACEvB,KAAM,0BACNO,MAAM,GAAD,OAAKlB,KAAKC,MAAMmX,YAAYK,uBAAsB,cAIZ1X,IAA7CC,KAAKC,MAAMmX,YAAYM,mBACzBtX,EAAW8B,KACT,CACEvB,KAAM,qBACNO,MAAOlB,KAAKC,MAAMmX,YAAYM,kBAAkBtM,cAMtD,IAAMuM,EAC8C,QADU,EAC5D3X,KAAKC,MAAM+B,SAAS,GAAGsU,mCAA2B,QAAI,GAExD,IACEqB,EAAqB5M,SAAQ,SAAAhE,GAAgB,IAAD,GAED,QADyB,EAChEA,EAAY2P,mCAA2B,QAAI,IACpB3L,SACvB,SAACgF,EAAwCxP,GACvCwP,EAAK4G,2CAA2C5L,SAAQ,SACtDzK,EAOAC,GAEA,IAAMI,EAAO,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CAC5CpK,MAAOZ,EAAK2K,wBAAwB,GAAGC,UACvCoD,iBACIhO,EAAK2K,wBAAwB,GAAGqE,uBACpCf,QAASjO,EAAK2K,wBAAwB,GAAGG,cAE3C,GAAI9K,EAAK+K,YAAcC,EAAAA,GAAAA,WAAAA,WAAAA,KAAqC,CAE1D,IAAMpK,EAAQ,IAAIoK,EAAAA,GAAAA,OAAAA,aAA6B,CAC7CpK,MAAOZ,EAAKkL,oBAAoB,GAAGN,UACnCoD,iBACIhO,EAAKkL,oBAAoB,GAAG8D,uBAChCf,QAASjO,EAAKkL,oBAAoB,GAAGJ,cAElCzK,EAAKiW,OAAOhB,GAA6BG,kBACxCpV,EAAKiW,OAAOhB,GAA6BQ,QAC3ChW,EAAW8B,KAAK,CACdvB,KAAM,eACNO,MAAOA,EAAMkK,aAIrB,MAAW9K,EAAK+K,YAAcC,EAAAA,GAAAA,WAAAA,WAAAA,OAEvB3K,EAAKiW,OAAOhB,GAA6BG,kBACxCpV,EAAKiW,OAAOhB,GAA6BQ,QAC3ChW,EAAW8B,KAAK,CACdvB,KAAM,eACNO,MAAOZ,EAAKoL,YAKtB,GACF,GAEJ,GASF,CARE,MAAOlF,GACP4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA4B,EAAMzB,SAGZ,CAEA,IAKIsL,EACA/P,EANEsX,EAAWC,KAAKC,IAAI,EAAG9X,KAAKC,MAAM+B,SAAS,GAAG+V,eAAiB,EAE/D3W,EACW,MAAf2F,EAAmB,UAAM6D,EAAU,aAAK7D,GAAgB6D,EAI1D,GAAI5K,KAAKC,MAAMmX,YAAYY,gBAAiB,CAE1C,IAAIxJ,EAkGAC,EAhGFD,EADmC,MAAjCxO,KAAKiH,MAAMwG,aAAaxE,OAExB,iCACE,SAAC,KAAO,CAACwG,OAAK,sBAGd,UAAC,KAAG,CAACC,QAAQ,SAASxD,MAAM,SAASyD,OAAQ,CAAC,EAAG,GAAG,WAClD,SAAC,KAAG,CAAC1O,KAAM,EAAE,kBAGb,SAAC,KAAG,CAACA,KAAM,GAAG,UACZ,SAAC,KAAM,CACL2O,OAAO,EACPC,IAAK,EACLC,IAAK,IACLC,KAAM,EACN7O,MAAOlB,KAAKiH,MAAMwG,aAAaxE,MAAM,GACrCmD,SAAUpM,KAAKoN,wBAGnB,SAAC,KAAG,CAACnM,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK,EACLC,IAAK,IACLvO,KAAK,QACLiH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaxE,MAAM,GACrCmD,SAAUpM,KAAKoN,2BAKrB,UAAC,KAAG,CAACsC,QAAQ,SAASxD,MAAM,SAASyD,OAAQ,CAAC,EAAG,GAAG,WAClD,SAAC,KAAG,CAAC1O,KAAM,EAAE,oBAGb,SAAC,KAAG,CAACA,KAAM,GAAG,UACZ,SAAC,KAAM,CACL2O,OAAO,EACPC,IAAK,EACLC,IAAK,IACLC,KAAM,EACN7O,MAAOlB,KAAKiH,MAAMwG,aAAaxE,MAAM,GACrCmD,SAAUpM,KAAKqN,wBAGnB,SAAC,KAAG,CAACpM,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK,EACLC,IAAK,IACLvO,KAAK,QACLiH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaxE,MAAM,GACrCmD,SAAUpM,KAAKqN,2BAKrB,UAAC,KAAG,CAACqC,QAAQ,SAASxD,MAAM,SAASyD,OAAQ,CAAC,EAAG,GAAG,WAClD,SAAC,KAAG,CAAC1O,KAAM,EAAE,mBAGb,SAAC,KAAG,CAACA,KAAM,GAAG,UACZ,SAAC,KAAM,CACL2O,OAAO,EACPC,IAAK,EACLC,IAAK,IACLC,KAAM,EACN7O,MAAOlB,KAAKiH,MAAMwG,aAAaxE,MAAM,GACrCmD,SAAUpM,KAAKsN,wBAGnB,SAAC,KAAG,CAACrM,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK,EACLC,IAAK,IACLvO,KAAK,QACLiH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaxE,MAAM,GACrCmD,SAAUpM,KAAKsN,8BAQvB,iCACE,SAAC,KAAO,CAACmC,OAAK,qBAEJ,gHAQ2B,MAAvCzP,KAAKiH,MAAMwG,aAAaO,cAC1BS,GACE,iCACE,SAAC,KAAO,CAACgB,OAAK,mCAGd,UAAC,KAAG,CAACC,QAAQ,SAASxD,MAAM,SAASyD,OAAQ,CAAC,EAAG,GAAG,WAClD,SAAC,KAAG,CAAC1O,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK,EACLC,IAAK9P,KAAKiH,MAAMwG,aAAaO,YAAY,GACzCzM,KAAK,QACLiH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaO,YAAY,GAC3C5B,SAAUpM,KAAKgQ,4BAGnB,SAAC,KAAG,CAAC/O,KAAM,GAAG,UACZ,SAAC,KAAM,CACL2O,OAAK,EACLC,IAAK,EACLC,IAAK8H,EACL7H,KAAM,EACN7O,MAAO,CACLlB,KAAKiH,MAAMwG,aAAaO,YAAY,GACpChO,KAAKiH,MAAMwG,aAAaO,YAAY,IAEtC5B,SAAUpM,KAAKiQ,uBAGnB,SAAC,KAAG,CAAChP,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK7P,KAAKiH,MAAMwG,aAAaO,YAAY,GACzC8B,IAAK8H,EACLrW,KAAK,QACLiH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaO,YAAY,GAC3C5B,SAAUpM,KAAKkQ,kCAO3BG,GACE,2BACG5B,EACAD,GACD,SAAC,KAAO,CAACiB,OAAK,KACd,UAAC,KAAG,CAACC,QAAQ,SAASxD,MAAM,SAASyD,OAAQ,CAAC,EAAG,GAAG,WAClD,SAAC,KAAG,CAAC1O,KAAM,EAAE,sBAGb,SAAC,KAAG,CAACA,KAAM,GAAG,UACZ,SAAC,KAAM,CACL2O,OAAO,EACPC,IAAK,EACLC,IAAK,EACLC,KAAM,IACN7O,MAAOlB,KAAKiH,MAAMwG,aAAaC,QAC/BtB,SAAUpM,KAAKmN,yBAGnB,SAAC,KAAG,CAAClM,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK,EACLC,IAAK,EACLvO,KAAK,QACLwO,KAAM,GACNvH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaC,QAC/BtB,SAAUpM,KAAKmN,8BAMzB,IAAM8K,EAASjY,KAAKgX,mBACpB1W,GACE,SAAC,KAAK,CACJuQ,OAAQ,EAAE,GAAI,IACdC,MAAO,IACPtI,MAAO,CACLuI,YAAa,QACbC,YAAa,MACbC,YAAa,OACbC,WAAYlR,KAAKiH,MAAM0D,UAAY,UAAY,SAC/CwG,gBAAgB,6BAAD,OAA+B8G,EAAOhO,WAAU,MAC/D,UAEF,SAAC,EAAW,CACV5I,OAAQD,EACRhB,WAAYA,EACZqB,YAAU,EACVvB,eAAa,KAIrB,MAEEmQ,GACE,0BACE,UAAC,KAAG,CAACX,QAAQ,SAASxD,MAAM,SAASyD,OAAQ,CAAC,EAAG,GAAG,WAClD,SAAC,KAAG,CAAC1O,KAAM,EAAE,sBAGb,SAAC,KAAG,CAACA,KAAM,GAAG,UACZ,SAAC,KAAM,CACL2O,OAAO,EACPC,IAAK,EACLC,IAAK,EACLC,KAAM,IACN7O,MAAOlB,KAAKiH,MAAMwG,aAAaC,QAC/BtB,SAAUpM,KAAKmN,yBAGnB,SAAC,KAAG,CAAClM,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK,EACLC,IAAK,EACLvO,KAAK,QACLwO,KAAM,GACNvH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaC,QAC/BtB,SAAUpM,KAAKmN,6BAMzB7M,GACE,SAAC,EAAW,CACVe,OAAQD,EACRhB,WAAYA,EACZqB,YAAU,EACVvB,eAAa,IAKnB,IAAMgY,EAAU,GACZlY,KAAKC,MAAMkY,aACbD,EAAQhW,MACN,SAAC,KAAO,CAACd,MAAM,sBAAqB,UAClC,SAAC,KAAM,CACL0D,KAAK,UACL6L,MAAM,SACNxP,MAAM,SAACiX,GAAA,EAAc,IACrBnL,QAASjN,KAAK+W,mBAMtB,MAUI/W,KAAKC,MADJ4K,GARS,EAAZ8C,aACW,EAAXwK,YACS,EAATxN,UACQ,EAAR3I,SACkB,EAAlBwI,mBACa,EAAbsD,cACS,EAAT0J,UACW,EAAXJ,aACa,eAEf,OACE,SAAC,UAAS,gBACR5O,MAAO,CAAEC,OAAQ,OAAQ0D,YAAa,QAElCtB,GAAU,cAEd,UAAC,KAAK,CAACqB,MAAM,QAAO,WAClB,gBAAK1D,MAAO,CAAE2D,YAAa,QAAS,UAClC,UAAC,KAAK,CAACoE,UAAU,WAAWrE,MAAM,MAAK,WACrC,SAAC,KAAM,CACL3K,KAAK,QACL+I,QAAStK,KAAKiH,MAAM0D,UACpByB,SAAUpM,KAAKoK,uBACfiC,iBAAiB,SAACgM,GAAA,EAAW,IAC7B/L,mBAAmB,SAACgM,GAAA,EAAoB,OAE1C,SAAC,KAAO,CACN9H,UAAU,OACVC,QAASJ,EACTK,aAAc,CAAE9G,MAAO,SACvBxI,MAAM,mBAAkB,UAExB,SAAC,KAAM,CACL0D,KAAK,UACL6L,MAAM,SACNxP,MAAM,SAACyP,GAAA,EAAe,QAGzBsH,OAGJ5X,OA5BEN,KAAKC,MAAMmX,YAAYxM,WAgClC,KAAC,EAppBkB,CAAS7I,EAAAA,WCjE9B,IAAQwW,GAAWC,GAAAA,EAAAA,OAsKnB,SA3HqB,0CAKnB,WAAavY,GAA8B,IAAD,EAIkC,OAJlC,gBACxC,cAAMA,IALRgH,MAAQ,CACNwR,mCAA+B1Y,GAK/B,EAAK2Y,mBAAqB,EAAKA,mBAAmBrO,MAAK,WACvD,EAAKsO,kBAAoB,EAAKA,kBAAkBtO,MAAK,WACrD,EAAKuO,0BAA4B,EAAKA,0BAA0BvO,MAAK,WAAK,CAC5E,CA8GC,OA5GD,yCAGA,SAAmBgN,GACjBrX,KAAKC,MAAM4Y,4BAA4B,CACrCxB,sBAAAA,EACAyB,UAAU,GAEd,GAEA,uCAGA,SACE5X,GAEAlB,KAAKqH,SAAS,CAAEoR,8BAA+BvX,GACjD,GAEA,gCAGA,WACE,IAAM0J,EAAa5K,KAAKiH,MAAMwR,mCACX1Y,IAAf6K,IACF5K,KAAKC,MAAM4Y,4BAA4B,CACrCxB,sBAAuBzM,EACvBkO,UAAU,IAEZ9Y,KAAKqH,SAAS,CAAEoR,mCAA+B1Y,IAEnD,GAAC,oBAED,WAA4B,IAAD,OACzB,QAA4BA,IAAxBC,KAAKC,MAAM+B,SACb,OAAO,KAGT,IAwCI+W,EAxCEC,EAAehZ,KAAKC,MAAMgZ,aAAazR,OAAS,EAChD0R,EAAsC,GACtCC,EAAiC,GA8DvC,OA7DAnZ,KAAKC,MAAMgZ,aAAalO,SAAQ,SAAAqM,GAC9B,IAAMC,EAAwBD,EAAYxM,WACpCwO,EAAS,EAAKnZ,MAAM+B,SAASqV,GAC7B/N,EAAoB8P,EAAO,GAAGC,kBACpCD,EAAO,GAAGE,oBAAoBvO,SAAQ,SAAAwO,GACpC,IAkBQnY,EAlBFiU,EAAKkE,EAAgBC,sBACrBzS,EAAcwS,EAAgBE,uBAChCrC,EAAYxM,aAAeyK,IACzB,EAAKpV,MAAMyZ,6BAA6B9M,IAAIyI,GAC9C6D,EAAiBhX,MACf,SAAC,GAAe,CAEdkV,YAAaA,EACbpV,SAAUoX,EACVzO,UAAW,EAAK1K,MAAM0Z,8BAA8B/M,IAAIyI,GACxD1H,aAAc,EAAK1N,MAAM2Z,yBAAyBvE,GAClD7K,mBAAoB,EAAKvK,MAAM4Z,8BAC/B/L,cAAe,EAAK7N,MAAM6Z,yBAC1BtC,UAAW,EAAKmB,kBAChBR,YAAaa,GAAa,UARlB1P,EAAiB,YAAI+L,MAc/BjU,EADkB,KAAhB2F,EACG,UAAMsO,EAAE,cAAMtO,GAEd,UAAMsO,GAEb8D,EAAYjX,MACV,SAACqW,GAAM,CAAUrX,MAAOmU,EAAG,SAAEjU,GAAhBiU,KAIrB,GACF,IAGI2D,IACFD,GACE,UAAC,KAAK,CAAC7M,MAAM,SAAS3K,KAAM,GAAIiH,MAAO,CAAEuR,QAAS,QAAS,WACzD,SAAC,KAAM,CACL3J,aAAa,GACb5H,MAAO,CAAEoB,MAAO,KAChBwC,SAAUpM,KAAK4Y,0BACf1X,MAAOlB,KAAKiH,MAAMwR,8BAClBuB,YAAU,WAETb,KAEH,SAAC,KAAO,CAAC/X,MAAM,MAAK,UAClB,SAAC,KAAG,CACFD,MAAM,SAAC8Y,GAAA,EAAmB,IAC1BnV,KAAK,UACLmI,QAASjN,KAAK0Y,4BAQtB,UAAC,IAAI,CAACjX,YAAY,EAAM,UACrByX,EACAH,IAGP,KAAC,EAxHkB,CAAShX,EAAAA,W,8FCqI9B,SAxIiB,0CACf,WAAa9B,GAA0B,IAAD,EASnC,OATmC,gBACpC,cAAMA,IACDmK,uBAAyB,EAAKA,uBAAuBC,MAAK,WAC/D,EAAK8C,oBAAsB,EAAKA,oBAAoB9C,MAAK,WACzD,EAAKpD,MAAQ,CACX0D,UAAW,EAAK1K,MAAM0K,UACtB8C,aAAc,CACZC,QAAS,EAAKzN,MAAM0N,aAAaD,UAEpC,CACH,CA0HC,OA1HA,8CAED,SACEpD,EACAC,GAEAvK,KAAKC,MAAMuK,mBAAmB,CAC5B0P,WAAYla,KAAKC,MAAMka,QAAQ3Z,IAC/BmK,UAAWL,IAEbtK,KAAKqH,SAAS,CAAEsD,UAAWL,GAC7B,GAAC,iCAED,SAAqBpJ,GACN,MAATA,IACFlB,KAAKC,MAAM6N,cAAc,CACvBoM,WAAYla,KAAKC,MAAMka,QAAQ3Z,IAC/BuN,aAAc,CACZL,QAASxM,KAGblB,KAAKqH,UAAS,SAAAJ,GAAK,MAAK,CACtBwG,aAAc,CACZC,QAASxM,GAEZ,IAEL,GAAC,oBAED,WACE,IAAMd,EAAqD,CACzD,CACEO,KAAM,cACNO,MAAOlB,KAAKC,MAAMka,QAAQpT,cAIxBsJ,GACJ,0BACE,UAAC,KAAG,CAACX,QAAQ,SAASxD,MAAM,SAAQ,WAClC,SAAC,KAAG,CAACjL,KAAM,EAAE,sBAGb,SAAC,KAAG,CAACA,KAAM,GAAG,UACZ,SAAC,KAAM,CACL2O,OAAO,EACPC,IAAK,EACLC,IAAK,EACLC,KAAM,IACN7O,MAAOlB,KAAKiH,MAAMwG,aAAaC,QAC/BtB,SAAUpM,KAAKmN,yBAGnB,SAAC,KAAG,CAAClM,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK,EACLC,IAAK,EACLvO,KAAK,QACLwO,KAAM,GACNvH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaC,QAC/BtB,SAAUpM,KAAKmN,6BAWzB,EAQInN,KAAKC,MADJ4K,GANS,EAAZ8C,aACS,EAAThD,UACO,EAAPwP,QACQ,EAARnY,SACkB,EAAlBwI,mBACa,EAAbsD,eACa,eAEf,OACE,SAAC,UAAS,gBACRtF,MAAO,CAAEC,OAAQ,OAAQ0D,YAAa,QAElCtB,GAAU,cAEd,UAAC,KAAK,CAACqB,MAAM,QAAO,WAClB,gBAAK1D,MAAO,CAAE2D,YAAa,QAAS,UAClC,SAAC,KAAK,CAACoE,UAAU,WAAWrE,MAAM,MAAM3K,KAAM,IAAI,UAChD,UAAC,KAAK,CAACgP,UAAU,WAAWrE,MAAM,MAAK,WACrC,SAAC,KAAM,CACL3K,KAAK,QACL6K,SAAUpM,KAAKoK,uBACfE,QAAStK,KAAKC,MAAM0K,UACpB0B,iBAAiB,SAAC,MAAK,IACvBC,mBAAmB,SAAC,MAAU,OAEhC,SAAC,KAAO,CACNkE,UAAU,OACVC,QAASJ,EACTK,aAAc,CAAE9G,MAAO,SACvBxI,MAAM,mBAAkB,UAExB,SAAC,KAAM,CACL0D,KAAK,UACL6L,MAAM,SACNxP,MAAM,SAACyP,GAAA,EAAe,gBAMhC,SAAC,EAAW,CACVvP,OAAQrB,KAAKC,MAAMka,QAAQzZ,MAC3BN,WAAYA,EACZqB,YAAU,EACVvB,eAAa,SAjCZF,KAAKC,MAAMka,QAAQ3Z,IAsC9B,KAAC,EArIc,CAASuB,EAAAA,WCQ1B,SAzBiB,qGAsBd,OAtBc,8BACf,WAA4B,IAAD,OACnB5B,EAAQH,KAAKC,MAAMma,SAAS/Z,KAAI,SAAC8Z,EAAS5Z,GAC9C,IAAMC,EAAM2Z,EAAQ3Z,IACpB,OACE,SAAC,GAAW,CAEV2Z,QAASA,EACTnY,SAAU,EAAK/B,MAAM+B,SAASxB,GAC9BmK,UAAW,EAAK1K,MAAMoa,mBAAmBzN,IAAIpM,GAC7CmN,aAAc,EAAK1N,MAAMqa,qBAAqB9Z,GAC9CgK,mBAAoB,EAAKvK,MAAMsa,0BAC/BzM,cAAe,EAAK7N,MAAMua,sBANrBL,EAAQ3Z,IASnB,IAEA,OACE,SAAC,IAAI,CAACiB,YAAY,EAAM,SACrBtB,GAGP,KAAC,EAtBc,CAAS4B,EAAAA,W,8FCyJ1B,SAxIiB,0CACf,WAAa9B,GAA0B,IAAD,EAOnC,OAPmC,gBACpC,cAAMA,IACDmK,uBAAyB,EAAKA,uBAAuBC,MAAK,WAC/D,EAAK8C,oBAAsB,EAAKA,oBAAoB9C,MAAK,WACzD,EAAKpD,MAAQ,CACX0D,UAAW,EAAK1K,MAAM0K,UACtB8C,aAAc,CAAEC,QAAS,EAAKzN,MAAM0N,aAAaD,UAClD,CACH,CA4HC,OA5HA,8CAED,SACEpD,EACAC,GAEAvK,KAAKC,MAAMuK,mBAAmB,CAC5BiQ,WAAYza,KAAKC,MAAMya,QAAQla,IAC/BmK,UAAWL,IAEbtK,KAAKqH,SAAS,CAAEsD,UAAWL,GAC7B,GAAC,iCAED,SAAqBpJ,GACN,MAATA,IACFlB,KAAKC,MAAM6N,cAAc,CACvB2M,WAAYza,KAAKC,MAAMya,QAAQla,IAC/BuN,aAAc,CACZL,QAASxM,KAGblB,KAAKqH,SAAS,CAAEoG,aAAc,CAAEC,QAASxM,KAE7C,GAAC,oBAED,WACE,IAAMd,EAAqD,CACzD,CACEO,KAAM,gBACNO,MAAOlB,KAAKC,MAAMya,QAAQ5L,aAAa1D,aAEzC,CACEzK,KAAM,oBACNO,MAAOlB,KAAKC,MAAMya,QAAQ3L,iBAAiB3D,aAE7C,CACEzK,KAAM,iBACNO,MAAOlB,KAAKC,MAAMya,QAAQC,gBAIxBtK,GACJ,0BACE,UAAC,KAAG,CAACX,QAAQ,SAASxD,MAAM,SAAQ,WAClC,SAAC,KAAG,CAACjL,KAAM,EAAE,sBAGb,SAAC,KAAG,CAACA,KAAM,GAAG,UACZ,SAAC,KAAM,CACL2O,OAAO,EACPC,IAAK,EACLC,IAAK,EACLC,KAAM,IACN7O,MAAOlB,KAAKiH,MAAMwG,aAAaC,QAC/BtB,SAAUpM,KAAKmN,yBAGnB,SAAC,KAAG,CAAClM,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK,EACLC,IAAK,EACLvO,KAAK,QACLwO,KAAM,GACNvH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaC,QAC/BtB,SAAUpM,KAAKmN,6BAWzB,EAQInN,KAAKC,MADJ4K,GANS,EAAZ8C,aACS,EAAThD,UACO,EAAP+P,QACQ,EAAR1Y,SACkB,EAAlBwI,mBACa,EAAbsD,eACa,eAEf,OACE,SAAC,UAAS,gBACRtF,MAAO,CAAEC,OAAQ,OAAQ0D,YAAa,QAElCtB,GAAU,cAEd,UAAC,KAAK,CAACqB,MAAM,QAAO,WAClB,gBAAK1D,MAAO,CAAE2D,YAAa,QAAS,UAClC,UAAC,KAAK,CAACoE,UAAU,WAAWrE,MAAM,MAAK,WACrC,SAAC,KAAM,CACL3K,KAAK,QACL6K,SAAUpM,KAAKoK,uBACfE,QAAStK,KAAKC,MAAM0K,UACpB0B,iBAAiB,SAAC,MAAK,IACvBC,mBAAmB,SAAC,MAAU,OAEhC,SAAC,KAAO,CACNkE,UAAU,OACVC,QAASJ,EACTK,aAAc,CAAE9G,MAAO,SACvBxI,MAAM,mBAAkB,UAExB,SAAC,KAAM,CACL0D,KAAK,UACL6L,MAAM,SACNxP,MAAM,SAACyP,GAAA,EAAe,cAK9B,SAAC,EAAW,CACVvP,OAAQrB,KAAKC,MAAMya,QAAQha,MAC3BN,WAAYA,EACZqB,YAAU,EACVvB,eAAa,SA/BZF,KAAKC,MAAMya,QAAQla,IAoC9B,KAAC,EArIc,CAASuB,EAAAA,WCU1B,SAzBiB,qGAsBd,OAtBc,8BACf,WAA4B,IAAD,OACnB5B,EAAQH,KAAKC,MAAM2a,SAASva,KAAI,SAACqa,EAASna,GAC9C,IAAMC,EAAMka,EAAQla,IACpB,OACE,SAAC,GAAW,CAEVka,QAASA,EACT1Y,SAAU,EAAK/B,MAAM+B,SAASxB,GAC9BmK,UAAW,EAAK1K,MAAM4a,mBAAmBjO,IAAIpM,GAC7CmN,aAAc,EAAK1N,MAAM6a,qBAAqBta,GAC9CgK,mBAAoB,EAAKvK,MAAM8a,0BAC/BjN,cAAe,EAAK7N,MAAM+a,sBANrBN,EAAQla,IASnB,IAEA,OACE,SAAC,IAAI,CAACiB,YAAY,EAAM,SACrBtB,GAGP,KAAC,EAtBc,CAAS4B,EAAAA,WChBnB,SAASkZ,GAAeC,GAc7B,OAbA,SAAkCjb,GAChC,IAAMkb,GAAWC,EAAAA,EAAAA,MACXC,GAAWC,EAAAA,EAAAA,MACXC,GAASC,EAAAA,EAAAA,MACf,OACE,SAACN,GAAS,kBACJjb,GAAK,IACTkb,SAAUA,EACVE,SAAUA,EACVE,OAAQA,IAGd,CAEF,C,eCuQA,SA9QuB,0CAIrB,WAAatb,GAAgC,IAAD,EAazC,OAbyC,gBAC1C,cAAMA,IACDkN,oBAAsB,EAAKA,oBAAoB9C,MAAK,WACzD,EAAK+C,mBAAqB,EAAKA,mBAAmB/C,MAAK,WACvD,EAAKgD,mBAAqB,EAAKA,mBAAmBhD,MAAK,WACvD,EAAKiD,mBAAqB,EAAKA,mBAAmBjD,MAAK,WACvD,EAAKkD,gBAAkB,EAAKA,gBAAgBlD,MAAK,WACjD,EAAKpD,MAAQ,CACXwG,aAAc,CACZC,QAAS,EAAKzN,MAAM0N,aAAaD,QACjCzE,MAAO,EAAKhJ,MAAM0N,aAAa1E,MAC/BwS,YAAa,EAAKxb,MAAM0N,aAAa8N,cAExC,CACH,CAyPC,OAzPA,2CAED,SAAqBva,GAA6B,IAAD,OAClC,MAATA,IACFlB,KAAKC,MAAMyb,qBAAqB3Q,SAAQ,SAACvK,GACvC,EAAKP,MAAM6N,cAAc,CACvBtN,IAAAA,EACAuN,aAAc,CACZ9E,MAAO,EAAKhC,MAAMwG,aAAaxE,MAC/ByE,QAASxM,EACTua,YAAa,EAAKxU,MAAMwG,aAAagO,cAG3C,IACAzb,KAAK2b,mBAAmB,CAAEjO,QAASxM,IAEvC,GAAC,gCAED,SAAoBA,GAAwC,IAAD,OACzD,GAAa,MAATA,QAAmDnB,IAAlCC,KAAKiH,MAAMwG,aAAaxE,MAAqB,CAChE,IAAMA,EAAQ,CACZtD,MAAMsI,QAAQ/M,GAASA,EAAM,GAAKA,EAClClB,KAAKiH,MAAMwG,aAAaxE,MAAM,GAC9BjJ,KAAKiH,MAAMwG,aAAaxE,MAAM,IAEhCjJ,KAAK2b,mBAAmB,CAAE1S,MAAAA,IAC1BjJ,KAAKC,MAAMyb,qBAAqB3Q,SAAQ,SAACvK,GACvC,EAAKP,MAAM6N,cAAc,CACvBtN,IAAAA,EACAuN,aAAc,CACZ9E,MAAOA,EACPyE,QAAS,EAAKzG,MAAMwG,aAAaC,QACjC+N,YAAa,EAAKxU,MAAMwG,aAAagO,cAG3C,GACF,CACF,GAAC,gCAED,SAAoBva,GAAwC,IAAD,OACzD,GAAa,MAATA,QAAmDnB,IAAlCC,KAAKiH,MAAMwG,aAAaxE,MAAqB,CAChE,IAAMA,EAAQ,CACZjJ,KAAKiH,MAAMwG,aAAaxE,MAAM,GAC9BtD,MAAMsI,QAAQ/M,GAASA,EAAM,GAAKA,EAClClB,KAAKiH,MAAMwG,aAAaxE,MAAM,IAEhCjJ,KAAK2b,mBAAmB,CAAE1S,MAAAA,IAC1BjJ,KAAKC,MAAMyb,qBAAqB3Q,SAAQ,SAACvK,GACvC,EAAKP,MAAM6N,cAAc,CACvBtN,IAAAA,EACAuN,aAAc,CACZ9E,MAAOA,EACPyE,QAAS,EAAKzG,MAAMwG,aAAaC,QACjC+N,YAAa,EAAKxU,MAAMwG,aAAagO,cAG3C,GACF,CACF,GAAC,gCAED,SAAoBva,GAAwC,IAAD,OACzD,GAAa,MAATA,QAAmDnB,IAAlCC,KAAKiH,MAAMwG,aAAaxE,MAAqB,CAChE,IAAMA,EAAQ,CACZjJ,KAAKiH,MAAMwG,aAAaxE,MAAM,GAC9BjJ,KAAKiH,MAAMwG,aAAaxE,MAAM,GAC9BtD,MAAMsI,QAAQ/M,GAASA,EAAM,GAAKA,GAEpClB,KAAK2b,mBAAmB,CAAE1S,MAAAA,IAC1BjJ,KAAKC,MAAMyb,qBAAqB3Q,SAAQ,SAACvK,GACvC,EAAKP,MAAM6N,cAAc,CACvBtN,IAAAA,EACAuN,aAAc,CACZ9E,MAAOA,EACPyE,QAAS,EAAKzG,MAAMwG,aAAaC,QACjC+N,YAAa,EAAKxU,MAAMwG,aAAagO,cAG3C,GACF,CACF,GAAC,mCAED,SAAuBva,GAAuB,IAAD,OAC3ClB,KAAK2b,mBAAmB,CAAEF,YAAava,IAEvClB,KAAKC,MAAMyb,qBAAqB3Q,SAAQ,SAACvK,GACvC,EAAKP,MAAM6N,cAAc,CACvBtN,IAAAA,EACAuN,aAAc,CACZ9E,MAAO,EAAKhC,MAAMwG,aAAaxE,MAC/ByE,QAAS,EAAKzG,MAAMwG,aAAaC,QACjC+N,YAAava,IAGnB,GACF,GAAC,6BAED,WACE,IAAiB8L,EAOjB,OAAqC,MAAjChN,KAAKiH,MAAMwG,aAAaxE,MAHnB,KAAO,WAJC+D,EAQAhN,KAAKiH,MAAMwG,aAAaxE,OAPtB,IAGe,KAFtB+D,EAAO,IAE2B,GADlCA,EAAO,IACmC/C,SAAS,IAAI5D,MAAM,GAMhE,OAEX,GAAC,gCAED,YAQU,IAPR4C,EAAK,EAALA,MACAyE,EAAO,EAAPA,QACA+N,EAAW,EAAXA,YAMAzb,KAAKqH,UAAS,SAACJ,GAAK,MAAM,CACxBwG,aAAc,CACZC,QAAgB,OAAPA,QAAO,IAAPA,EAAAA,EAAWzG,EAAMwG,aAAaC,QACvCzE,MAAY,OAALA,QAAK,IAALA,EAAAA,EAAShC,EAAMwG,aAAaxE,MACnCwS,YAAwB,OAAXA,QAAW,IAAXA,EAAAA,EAAexU,EAAMwG,aAAagO,aAElD,GACH,GAAC,oBAED,WAA4B,IACtBjN,EADqB,OAkFzB,OAhFqC,MAAjCxO,KAAKiH,MAAMwG,aAAaxE,QAC1BuF,GACE,iCACE,SAAC,KAAO,CAACiB,OAAK,sBACd,UAAC,KAAG,CAACC,QAAQ,SAASxD,MAAM,SAASyD,OAAQ,CAAC,EAAG,GAAG,WAClD,SAAC,KAAG,CAAC1O,KAAM,EAAE,kBACb,SAAC,KAAG,CAACA,KAAM,GAAG,UACZ,SAAC,KAAM,CACL2O,OAAO,EACPC,IAAK,EACLC,IAAK,IACLC,KAAM,EACN7O,MAAOlB,KAAKiH,MAAMwG,aAAaxE,MAAM,GACrCmD,SAAUpM,KAAKoN,wBAGnB,SAAC,KAAG,CAACnM,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK,EACLC,IAAK,IACLvO,KAAK,QACLiH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaxE,MAAM,GACrCmD,SAAUpM,KAAKoN,2BAKrB,UAAC,KAAG,CAACsC,QAAQ,SAASxD,MAAM,SAASyD,OAAQ,CAAC,EAAG,GAAG,WAClD,SAAC,KAAG,CAAC1O,KAAM,EAAE,oBACb,SAAC,KAAG,CAACA,KAAM,GAAG,UACZ,SAAC,KAAM,CACL2O,OAAO,EACPC,IAAK,EACLC,IAAK,IACLC,KAAM,EACN7O,MAAOlB,KAAKiH,MAAMwG,aAAaxE,MAAM,GACrCmD,SAAUpM,KAAKqN,wBAGnB,SAAC,KAAG,CAACpM,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK,EACLC,IAAK,IACLvO,KAAK,QACLiH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaxE,MAAM,GACrCmD,SAAUpM,KAAKqN,2BAKrB,UAAC,KAAG,CAACqC,QAAQ,SAASxD,MAAM,SAASyD,OAAQ,CAAC,EAAG,GAAG,WAClD,SAAC,KAAG,CAAC1O,KAAM,EAAE,mBACb,SAAC,KAAG,CAACA,KAAM,GAAG,UACZ,SAAC,KAAM,CACL2O,OAAO,EACPC,IAAK,EACLC,IAAK,IACLC,KAAM,EACN7O,MAAOlB,KAAKiH,MAAMwG,aAAaxE,MAAM,GACrCmD,SAAUpM,KAAKsN,wBAGnB,SAAC,KAAG,CAACrM,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK,EACLC,IAAK,IACLvO,KAAK,QACLiH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaxE,MAAM,GACrCmD,SAAUpM,KAAKsN,2BAIrB,SAAC,KAAO,CAACmC,OAAK,SAMlB,2BACGjB,GACD,UAAC,KAAG,CAACkB,QAAQ,QAAQxD,MAAM,SAASyD,OAAQ,CAAC,EAAG,GAAG,WACjD,SAAC,KAAG,CAAC1O,KAAM,EAAE,sBACb,SAAC,KAAG,CAACA,KAAM,GAAG,UACZ,SAAC,KAAM,CACL2O,OAAO,EACPC,IAAK,EACLC,IAAK,EACLC,KAAM,IACN7O,MAAOlB,KAAKiH,MAAMwG,aAAaC,QAC/BtB,SAAUpM,KAAKmN,yBAGnB,SAAC,KAAG,CAAClM,KAAM,EAAE,UACX,SAAC,KAAW,CACV4O,IAAK,EACLC,IAAK,EACLvO,KAAK,QACLwO,KAAM,GACNvH,MAAO,CAAEoB,MAAO,QAChB1I,MAAOlB,KAAKiH,MAAMwG,aAAaC,QAC/BtB,SAAUpM,KAAKmN,4BAIrB,SAAC,KAAG,CAACuC,QAAQ,QAAQxD,MAAM,SAASyD,OAAQ,CAAC,EAAG,GAAG,UACjD,SAAC,KAAQ,CACPzO,MAAOlB,KAAKiH,MAAMwG,aAAagO,YAC/BrP,SAAU,SAAC7B,GAAK,OACd,EAAKqR,sBAAsBrR,EAAMsR,OAAOvR,QAAQ,EAAC,mCAO7D,KAAC,EA3QoB,CAASvI,EAAAA,W,iGCiJhC,SAnK+B,SAAH,GAmBR,IAlBlBuD,EAAQ,EAARA,SACA8G,EAAQ,EAARA,SACA0P,EAAqB,EAArBA,sBACAhO,EAAa,EAAbA,cACAiO,EAAuB,EAAvBA,wBACG9b,GAAK,cAcA+b,EAAU1W,EAAV0W,MASFC,EAAWD,EAAME,OAAM,SAACpX,GAAU,OACtCA,EAAKqX,KAAKD,OAAM,SAAC1b,GAAW,OAAKsb,EAAsBlP,IAAIpM,EAAI,GAAC,IAE5D4b,GACHH,GACDD,EAAMK,MAAK,SAACvX,GAAU,OACpBA,EAAKqX,KAAKE,MAAK,SAAC7b,GAAW,OAAKsb,EAAsBlP,IAAIpM,EAAI,GAAC,IAG7D8b,EAA0B,SAAH,GAMhB,IALXxX,EAAI,EAAJA,KACA6F,EAAS,EAATA,UAKA7F,EAAKqX,KAAKpR,SAAQ,SAACvK,GACjB4L,EAAS,CAAE3B,OAAQjK,EAAKmK,UAAAA,GAC1B,GACF,EAEA,OACE,SAAC,UAAS,gBACRnC,MAAO,CAAEC,OAAQ,OAAQ0D,YAAa,QAClClM,GAAK,cAET,SAAC,KAAK,CAACiM,MAAM,QAAO,UAClB,iBAAK1D,MAAO,CAAE2D,YAAa,OAAQlD,MAAO,SAAU,WAClD,SAAC,KAAK,CAACsH,UAAU,WAAWrE,MAAM,MAAK,UACrC,UAAC,KAAQ,CACPkQ,cAAeA,EACf9R,QAAS2R,EACT7P,SAvCkB,SAACmQ,GAC7B,IAAM5R,EAAY4R,EAAEV,OAAOvR,QAC3B0R,EAAMjR,SAAQ,SAACjG,GACbwX,EAAwB,CAAExX,KAAAA,EAAM6F,UAAAA,GAClC,GACF,EAkC4C,WAEhC,SAAC,KAAO,CACNvJ,MAAK,UAAKkE,EAAS4F,UAAS,YAAI5F,EAASgK,wBACzCkN,gBAAiB,EAAE,SAElBlX,EAAS8F,eAEZ,SAAC,KAAO,CACNoF,UAAU,UACVE,aAAc,CAAE9G,MAAO,SACvBxI,MAAM,mBACNqP,QAAS,kBACP,SAAC,GAAiB,CAChBiL,qBAAsBM,EAAMS,QAC1B,SAACC,EAAe5X,GACd,MAAM,GAAN,gBAAW4X,IAAG,QAAK5X,EAAKqX,MAC1B,GACA,IAEFrO,cAAeA,EACfH,aACEoO,EAAwBC,EAAM,GAAGG,KAAK,KAExC,EACF,UAEF,SAAC,KAAM,CACLrX,KAAK,UACL6L,MAAM,SACNnI,MAAO,CAAEmU,WAAY,QACrBxb,MAAM,SAACyP,GAAA,EAAe,aAK7BoL,EAAM3b,KAAI,SAACyE,GACV,IAAQsG,EACNtG,EADMsG,YAAakE,EACnBxK,EADmBwK,uBAAwBpE,EAC3CpG,EAD2CoG,UAAWiR,EACtDrX,EADsDqX,KAElDS,EAAuBxR,EAAY/E,MAAM,EAAG,IAC5CwW,EAAqBD,IAAyBxR,EAAcA,EAAW,UAAMwR,EAAoB,OACjGE,EAAYX,EAAKD,OAAM,SAAC1b,GAAW,OACvCsb,EAAsBlP,IAAIpM,EAAI,IAE1Buc,GACHD,GACDX,EAAKE,MAAK,SAAC7b,GAAW,OAAKsb,EAAsBlP,IAAIpM,EAAI,IAC3D,OACE,iBAEEgI,MAAO,CACL2D,YAAa,OACbvC,MAAO,OACPf,QAAS,OACTmU,cAAe,OACf,WAEF,SAAC,KAAQ,CACPZ,cAAeW,EACfzS,QAASwS,EACT1Q,SAAU,SAACmQ,GAAM,OACfD,EAAwB,CACtBxX,KAAAA,EACA6F,UAAW4R,EAAEV,OAAOvR,SACpB,KAEN,iBAAK9B,MAAO,CAAE2D,YAAa,OAAQ,WACjC,SAAC,KAAO,CACN/K,MAAK,UAAK8J,EAAS,YAAIoE,GACvBkN,gBAAiB,EAAE,SAElBK,KAEH,SAAC,KAAO,CACNrM,UAAU,UACVE,aAAc,CAAE9G,MAAO,SACvBxI,MAAM,mBACNqP,QAAS,kBACP,SAAC,GAAiB,CAChBiL,qBAAsB5W,EAAKqX,KAC3BrO,cAAeA,EACfH,aAAcoO,EAAwBjX,EAAKqX,KAAK,KAChD,EACF,UAEF,SAAC,KAAM,CACLrX,KAAK,UACL6L,MAAM,SACNnI,MAAO,CAAEmU,WAAY,QACrBxb,MAAM,SAACyP,GAAA,EAAe,aAGtB,UA3CE9L,EAAKwK,uBAAsB,YAAIxK,EAAKsG,aA8ClD,WAKV,EC1DA,SAzC+B,SAAH,GAkBR,IAjBlBgK,EAAW,EAAXA,YACAhJ,EAAQ,EAARA,SACA0B,EAAa,EAAbA,cACAiO,EAAuB,EAAvBA,wBACAD,EAAqB,EAArBA,sBAcMmB,EAjEc,SAAC7H,GACrB,IAAM6H,EAAwB,OAAX7H,QAAW,IAAXA,OAAW,EAAXA,EAAaqH,QAC9B,SACES,EACAC,GACI,IAAD,IACK7X,EAAwB6X,EAAxB7X,SAAUR,EAAcqY,EAAdrY,KAAMtE,EAAQ2c,EAAR3c,IAClB4c,EAAc9X,EAAS8F,YACvBiS,EAAUvY,EAAKsG,YAEfkS,EAAwC,QAA7B,EAAGJ,EAAcE,UAAY,2BACzC9X,GAAQ,IACX0W,MAAO,CAAC,IAEJuB,EAAoC,QAA7B,EAAGD,EAAYtB,MAAMqB,UAAQ,2BACrCvY,GAAI,IACPqX,KAAM,KAGR,OAAO,kBACFe,GAAa,eACfE,GAAW,kBACPE,GAAW,IACdtB,OAAM,kBACDsB,EAAYtB,OAAK,eACnBqB,GAAO,kBAAQE,GAAO,IAAEpB,KAAK,GAAD,gBAAMoB,EAAQpB,MAAI,CAAE3b,WAIzD,GACA,CAAC,GAaH,OATAgd,OAAOC,KAAKR,GAAYlS,SAAQ,SAACqS,GAC/B,IACQpB,EADSiB,EAAWG,GACpBpB,MACF0B,EAAWF,OAAOC,KAAKzB,GAAO3b,KAClC,SAACgd,GAAe,OAAKrB,EAAMqB,EAAQ,IAErCJ,EAAWG,GAAapB,MAAQ0B,CAClC,IAEOT,CACT,CAqB+CU,CAAcvI,GAE3D,GAAuC,IAAnCoI,OAAOC,KAAKR,GAAYzV,OAC1B,OAAO,wBAGT,IAAMrH,EAAQqd,OAAOC,KAAKR,GAAY5c,KAAI,SAAC+c,GACzC,IAAM9X,EAAW2X,EAAWG,GAC5B,OACE,SAAC,GAAsB,CAErB9X,SAAUA,EACV8G,SAAUA,EACV0B,cAAeA,EACfiO,wBAAyBA,EACzBD,sBAAuBA,GALO,KAAzBxW,EAAS8F,YAAqB9F,EAAS8F,YAAW,mBAAegS,GAQ5E,IAEA,OAAO,SAAC,IAAI,CAAC3b,YAAY,EAAM,SAAEtB,GACnC,ECjEA,SA3C0B,SAAH,GAQH,IAPlByd,EAAS,EAATA,UACAC,EAAS,EAATA,UACArR,EAAI,EAAJA,KAMA,OACE,gBACEhE,MAAO,CACLsV,SAAU,QACVC,IAAI,GAAD,OAAKF,EAAS,MACjBG,KAAK,GAAD,OAAKJ,EAAS,MAClBK,gBAAiB,4BACjB9N,SAAU,QACV+N,UAAW,OACXnE,QAAS,OACThZ,WAAY,OACZod,cAAe,QACf,SAED3R,EAAKnM,KAAI,SAACqK,EAAKjB,GACd,IAAMrJ,EAAasK,EAAItK,WACvB,OACE,4BACE,mCAAWsK,EAAInK,SACdH,EAAWC,KAAI,SAAC+d,GACf,OACE,2BACGA,EAAKzd,KAAI,MAAG,iBAAM6H,MAAO,CAAEzH,WAAY,KAAM,SAAEqd,EAAKld,UAD7Ckd,EAAKzd,KAAO+J,EAAI2T,OAI9B,MARQ3T,EAAI2T,OAYlB,KAGN,ECrCO,IAAMC,GAAuB,SAAC5T,GACnC,IAAQlK,EAAqBkK,EAArBlK,IAAKsK,EAAgBJ,EAAhBI,YAEPyT,EAAS,CACbjZ,SAAU,CACR4F,UAAW,YACXE,YAAa,YACbkE,uBAAwB,aAE1BxK,KAAM,CACJoG,UAAW,YACXE,YAAa,YACbkE,uBAAwB,cAuB5B,OAnBAxE,EAAYC,SAAQ,SAClBzK,GAKA,IAAM0K,EAAY1K,EAAK2K,wBAAwB,GAAGC,UAClD,GAAI5K,EAAK+K,YAAcC,EAAAA,GAAAA,WAAAA,WAAAA,KAAqC,CAC1D,IACMpK,EADkBZ,EACMkL,oBAAoB,GAEhC,cAAdR,EACFuT,EAAOjZ,UAAQ,UAAQpE,GACA,WAAd8J,IACTuT,EAAOzZ,MAAI,UAAQ5D,GAEvB,CACF,KAEO,kBACFqd,GAAM,IACT/d,IAAAA,GAEJ,ECgJA,SA3KuB,SAAH,GAYuE,IAAD,IAXxFgM,EAAI,EAAJA,KACAxK,EAAQ,EAARA,SACAwc,EAAI,EAAJA,KACAC,EAAG,EAAHA,IACAhS,EAAc,EAAdA,eAUMiS,EAAW1c,EAASA,EAASwF,OAAS,IAKK,QAA7C,EAAqC,QAArC,EAACkX,EAASpI,mCAA2B,aAApC,EAAsC9O,cAAM,QAAI,GAAK,GACxDY,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,4DAIN,IAGI+Z,EAEoB,IALlBC,EAAcF,EAASpI,4BAA4B,IAEzDxQ,QAAQ+Y,MAAM,mCAGD9e,IAATye,GACFG,EAAW,IAAIrT,EAAAA,GAAAA,UAAAA,oCAAuD,CACpE3K,KAAe,QAAX,EAAE6d,EAAK7d,YAAI,QAAI,YACnBme,UAAqB,QAAZ,EAAEN,EAAKO,aAAK,QAAI,MAG3BjZ,QAAQD,KAAK,iCACb8Y,EAAW,IAAIrT,EAAAA,GAAAA,UAAAA,oCAAuD,CACpE3K,KAAM,eAIV,IAAMqe,EAAqB,IAAI1T,EAAAA,GAAAA,UAAAA,mBAAsC,CACnE2T,sBAAuB,IAAI3T,EAAAA,GAAAA,UAAAA,gBAAmC,CAC5DyH,aAAc,IAAIzH,EAAAA,GAAAA,OAAAA,aAA6B,CAC7CpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,WAEX2Q,8BAA+BP,IAEjCQ,sBAAuB,IAAI7T,EAAAA,GAAAA,UAAAA,gBAAmC,CAC5DyH,aAAc,IAAIzH,EAAAA,GAAAA,OAAAA,aAA6B,CAC7CpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,WAEX2Q,8BAA+B,IAAI5T,EAAAA,GAAAA,UAAAA,oCAAuD,CACxF9K,IAAKie,EAAIje,IACT4e,iBAAkB,8BAClBC,UAAWZ,EAAI9d,SAGnB2e,eAAgB,IAAIhU,EAAAA,GAAAA,UAAAA,eAAkC,CACpDiU,aAAc,IAAIjU,EAAAA,GAAAA,OAAAA,aAA6B,CAC7CpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,aAEXiR,4BAA6B,IAAIlU,EAAAA,GAAAA,UAAAA,uBAA0C,CACzE9K,IAAKoe,EAAYvK,YACjBzJ,WAAYgU,EAAYtK,mBACxB5L,oBAAqBgW,EAAS9W,0BAKpC9B,QAAQ+Y,MAAM,+BAEd,IADA,IAAMY,EAAkE,GAC/DhW,EAAI,EAAGA,EAAI+C,EAAKhF,OAAQiC,IAAK,CAAC,IAAD,EAC9BiB,EAAM8B,EAAK/C,GACjB,GAAKgD,EAAeG,IAAIlC,EAAIlK,KAA5B,CAIA,IAAIkf,EAAchV,EAAII,YAAYnE,MAAK,SAACrG,GACtC,MAAqD,WAA9CA,EAAK2K,wBAAwB,GAAGC,SACzC,SAEoBnL,IAAhB2f,GACFtX,GAAAA,QACElD,EACA,IAAIL,EACFD,EAA+B,0CAAD,OACYiC,OAAO6D,EAAIlK,KAAI,OAO/D,IAAMmf,EAAqB,IAAIrU,EAAAA,GAAAA,UAAAA,mBAAsC,CACnE9K,IAA+B,QAA5B,EAAEkK,EAAImJ,WAAWC,mBAAW,QAAIpJ,EAAIlK,IACvCoK,WAAW,QAAD,OAAUnB,EAAI,KAqBpBkC,EAlBQ,IAAIL,EAAAA,GAAAA,UAAAA,+CAAkE,CAClFqU,mBAAAA,EACAC,iBAAkB,IAAItU,EAAAA,GAAAA,aAAAA,cAAoC,CACxDuU,YAAanV,EAAI0I,SAASyM,YAC1BC,YAAapV,EAAI0I,SAAS0M,YAC1BxM,oBAAqB5I,EAAI0I,SAASE,sBAEpCoM,YAAa,IAAIpU,EAAAA,GAAAA,OAAAA,aAA6B,CAC5CpK,MAAOwe,EAAYlU,oBAAoB,GAAGN,UAC1CoD,iBAAkBoR,EAAYlU,oBAAoB,GAAG8D,uBACrDf,QAASmR,EAAYlU,oBAAoB,GAAGJ,cAE9C2U,uBAAwBrV,EAAII,YAAYkV,QAAO,SAAC1f,GAC9C,MAAqD,WAA9CA,EAAK2K,wBAAwB,GAAGC,SACzC,IACAS,aAAcjB,EAAIiB,eAIpBA,EAAa,GAAGsU,wBAA0B,CACxC,CACEC,gBAAiB,OACjBC,mBAAoB,SAGxBV,EAAoBvd,KAAI,MAAxBud,GAAmB,QAAS9T,GAhD5B,CAiDF,CAEA7F,QAAQ+Y,MAAM,8CACd,IAAMuB,EAAoB,IAAI9U,EAAAA,GAAAA,UAAAA,kBAAqC,CACjE+U,oCAAqC,IAAI/U,EAAAA,GAAAA,UAAAA,oCACvC,CAAC,GAEH0T,mBAAAA,EACAsB,kBAAmB,IAAIhV,EAAAA,GAAAA,OAAAA,aAA6B,CAClDpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,wBAEXkR,oBAAAA,IAgBF,OAbA3Z,QAAQ6B,KAAK,uCAaN,CACL4Y,sBAAsB,EACtBC,gBAdc,IAAIlV,EAAAA,GAAAA,UAAAA,kBAAqC,CACvDmF,QAAS2P,EAAkB,GAC3BK,SAAU,CAAC/B,GACXpV,kBAAmBgC,EAAAA,GAAAA,oBAAAA,MACnBoV,aAAc,EACdC,kBAAmB,aACnBC,eAAgBtV,EAAAA,GAAAA,oBAAAA,MAChBuV,eAAgB,EAChBC,aAAc,8BACdC,sBAAkBhhB,IAOtB,ECjIA,IAAMihB,GAAqC,CAAC,IAAK,IAAK,GAChDC,GAAmC,CAAC,IAAK,IAAK,EAAG,IAKjDC,GAAkC,CAAC,EAAG,EAAG,GACzCC,GAAmC,CACvC,CAAC,IAAK,EAAG,GACT,CAAC,EAAG,IAAK,GACT,CAAC,EAAG,EAAG,KACP,CAAC,IAAK,IAAK,GACX,CAAC,EAAG,IAAK,KACT,CAAC,EAAG,EAAG,IASHC,GAAY,SAAC/O,GAMjB,IAAMgP,EAAehP,EAAQ/C,uBACvBgS,EAAYjP,EAAQnH,UAC1B,MAAM,GAAN,OAAUmW,EAAY,YAAIC,EAC5B,EAEMC,GAAa,SAAC7W,GAClB,IAAMiI,EAAUP,GAAuB,CACrC3B,QAAS/F,EAAII,YACbnK,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPqN,QAAS,UACTD,iBAAkB,UAGtB,GAAuB,IAAnBqE,EAAQnL,OAAZ,CAIA,IACMga,EADU7O,EAAQ,GACInH,oBAAoB,GAChD,OAAO4V,GAAUI,EAHjB,CAFE1b,QAAQD,KAAK,4BAAD,OAA6B6E,EAAIlK,KAMjD,EAEMihB,GAAgB,SAACC,EAAgBC,GACrC,GAAID,EAAEtO,SAASyM,cAAgB8B,EAAEvO,SAASyM,YACxC,OAAO,EAET,GAAI6B,EAAEtO,SAASE,sBAAwBqO,EAAEvO,SAASE,oBAChD,OAAO,EAET,GAAIoO,EAAEtO,SAAS0M,YAAYtY,SAAWma,EAAEvO,SAAS0M,YAAYtY,OAC3D,OAAO,EAIT,IADA,IACSiC,EAAI,EAAGA,EAAIiY,EAAEtO,SAAS0M,YAAYtY,SAAUiC,EACnD,GAA+B,UAA3BiY,EAAEtO,SAASyM,YAAyB,CACtC,IAAM+B,EAAKF,EAAEtO,SACPyO,EAAKF,EAAEvO,SAGb,GAFWwO,EAAG9B,YAAYrW,GAAGsC,YALhB,KAMF8V,EAAG/B,YAAYrW,GAAGsC,YANhB,GAQX,OAAO,CAEX,MAGE,IAFA,IAAM6V,EAAKF,EAAEtO,SACPyO,EAAKF,EAAEvO,SACJ0O,EAAI,EAAGA,EAAIF,EAAG9B,YAAYrW,GAAGjC,SAAUsa,EAAG,CAGjD,GAFWF,EAAG9B,YAAYrW,GAAGqY,GAAG/V,YAdrB,KAeA8V,EAAG/B,YAAYrW,GAAGqY,GAAG/V,YAfrB,GAiBT,OAAO,CAEX,CAGJ,OAAO,CACT,EAEMgW,GAAkB,SAACvZ,GAUvB,IAAMwZ,EAAS,CACb/Y,MAAO+X,GACPpX,MAjGqC,GAmGnB,MAAhBpB,EAAMwZ,SACkB,MAAtBxZ,EAAMwZ,OAAO/Y,QACf+Y,EAAO/Y,MAAQT,EAAMwZ,OAAO/Y,OAEJ,MAAtBT,EAAMwZ,OAAOpY,QACfoY,EAAOpY,MAAQpB,EAAMwZ,OAAOpY,QAGhC,IAAMqY,EAAO,CACXhZ,MAAOgY,IAOT,OALkB,MAAdzY,EAAMyZ,MACgB,MAApBzZ,EAAMyZ,KAAKhZ,QACbgZ,EAAKhZ,MAAQT,EAAMyZ,KAAKhZ,OAGrB,CACL+Y,OAAAA,EACAC,KAAAA,EACAC,MAAO,CACLC,OAAQ,CACNC,OAAwB,MAAhB5Z,EAAM4Z,OACV5Z,EAAM4Z,OACNvK,KAAK/H,IAAI,EAAIkS,EAAOpY,MAAO,GAC/BoY,OAAAA,EACAC,KAAAA,IAIR,EAEMI,GAAoB,SAAH,GAOjB,IAPuBta,EAAO,EAAPA,QAAST,EAAK,EAALA,MAAOgb,EAAO,EAAPA,QAQ3Cxc,QAAQ6B,KACN,iDAAgD,WAC5CL,EAAMib,aAAa,GAAG3a,oBAAmB,MAE/C,IACE,IAaI4a,EAbEC,EAAe,IAAI5a,EAAAA,OAAAA,kBAA6B,CACpD6a,cAAe3a,EACf/F,SAAUsF,EAAMib,aAChBI,SAAU,CAAC,WAAY,YACvBL,QAASA,EACTna,iBAAkB,SAAC3B,GACjB4B,GAAAA,QACElD,EAAmCsB,EAEvC,IAwBF,OAtBAic,EAAaG,0BAA0B,CAAC,GAGpCtb,EAAMub,YAAYrb,OAAS,IAC7B1B,QAAQ6B,KACN,+CAA8C,WAC1CL,EAAMub,YAAY,GAAGjb,oBAAmB,MAE9C4a,EAAc,IAAI3a,EAAAA,OAAAA,iBAA4B,CAC5CC,OAAQC,EAAQ/D,EAAegE,iCAC/BhG,SAAUsF,EAAMub,YAAY,GAC5B3a,aAAc,EACdqN,YAAa,WACbpN,iBAAkB,SAAC3B,GACjB4B,GAAAA,QACElD,EACAsB,EAEJ,KAIG,CAAEic,aAAAA,EAAcD,YAAAA,EAWzB,CAVE,MAAOhc,GASP,MAPA4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,iCAGE4B,CACR,CACF,EAMMsc,GAAqB,SACzBpQ,GAEA,IAAMqQ,EAAcrQ,EAAOuN,wBAC3B,GAAI8C,EAAYvb,OAAS,GAEX,SADAub,EAAY,GAAG5C,mBAEzB,OAAO,EAGX,OAAO,CACT,EAMM6C,GAA4B,SAChCtQ,GAEA,IAAMvS,EAAQiS,GAAuB,CACnC3B,QAASiC,EAAOE,gBAChBjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,oBAGb,GAAqB,IAAjBpO,EAAMqH,OACR,OAAO,EAET,IACMyb,EADmB9iB,EAAM,GACYqL,oBAAoB,GACzD0X,EAAmB,IAAI5X,EAAAA,GAAAA,OAAAA,aAA6B,CACxDpK,MAAO+hB,EAAkB/X,UACzBqD,QAAS0U,EAAkB7X,YAC3BkD,iBAAkB2U,EAAkB3T,yBAEhC6T,EAAkB,IAAI7X,EAAAA,GAAAA,OAAAA,aAA6B,CACvDpK,MAAO,SACPqN,QAAS,WACTD,iBAAkB,QAEpB,QAAI4U,EAAiBtM,OAAOuM,EAI9B,EAKMC,GAA0B,SAC9B1Q,GAEA,IAAM/G,EAAeyG,GAAuB,CAC1C3B,QAASiC,EAAOE,gBAChBjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,2BAGb,GAA4B,IAAxB5C,EAAanE,OACf,OAAO,EAET,IAAMc,EAAYqD,EAAa,GACzB0X,EAAoBjR,GAAuB,CAC/C3B,QAASnI,EAAUsK,gBACnBjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,wBAIT+U,GAAc,EAkBlB,OAjBAD,EAAkBtY,SAAQ,SAACiI,GACzB,IACMuQ,EAAUnR,GAAuB,CACrC3B,QAFgBuC,EAEGJ,gBACnBjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPoN,iBAAkB,MAClBC,QAAS,mBAGTgV,EAAQ/b,OAAS,GACf+b,EAAQ,GAAGlY,YAAcC,EAAAA,GAAAA,WAAAA,WAAAA,WAC3BgY,GAAc,EAGpB,IAEOA,CACT,EA6FME,GAAW,0CA6Df,WAAavjB,GAA0B,IAAD,mBACpC,cAAMA,IA7DSwjB,eAAiD,GAAE,EAEnDC,kBAA4D,CAAC,EAAC,EAE9D/X,aAA8B,GAAE,EAEhCgY,oBAAmD,CAAC,EAAC,EAErDC,uBAAiB,IAEjBC,sBAAgB,IAEzBpB,kBAAY,IAEZD,iBAAW,IAEXsB,YAAc,GAAE,EAEhBC,UAAY,CAAC,EAAG,GAAE,EAETC,SAAW,IAAIC,IAAa,EAE5BC,gBAA8C,CAC7DlC,OAAQ,CACN/Y,MAAO+X,GACPpX,MAxZmC,GA0ZrCqY,KAAM,CACJhZ,MAAOgY,IAETiB,MAAO,CACLC,OAAQ,CACNF,KAAM,CACJhZ,MAAO+X,IAEToB,OAja2B,KAoahC,EAEO+B,UAAyD,CAAC,EAAC,EAE3DpI,wBAEJ,CAAC,EAAC,EAEWqI,qBAAiC,CAAC,EAAG,IAAK,KAAI,EAC9CC,mBAA+B,CAAC,IAAK,IAAK,KAAI,EAE9CC,iBAA+C,CAC9DtC,OAAQ,CAAE/Y,MAAM,GAAD,gBAAM,EAAKmb,sBAAoB,CAAE,IAAIxa,MAAO,GAC3DqY,KAAM,CAAEhZ,MAAM,GAAD,gBAAM,EAAKob,oBAAkB,CAAE,MAC5CnC,MAAO,CACLC,OAAQ,CACNC,OAAQ,EACRH,KAAM,CAAEhZ,MAAM,GAAD,gBAAM,EAAKmb,sBAAoB,CAAE,QAGnD,EA4NDG,uBAAyB,WACvBze,QAAQ6B,KAAK,2CACb,IAAMG,EAAS,EAAK7H,MAAM8H,QACxB/D,EAAewgB,sCAEjB1c,EAAO2c,mBAAmB,CACxBC,iBAAkB,EAAKzkB,MAAMykB,iBAC7BC,YAAa,CACXC,SAAU,QAEXC,MAAK,SAACC,GACiB,MAApBA,IACFA,EAAmB,IAErBA,EAAiB/Z,SAAQ,SAACga,EAAaxkB,GACrC,IACMykB,EADcnd,EAAAA,SAAAA,eAA4Bkd,GAAxC/P,QAERlP,QAAQ6B,KAAK,yBAAD,OAA0Bqd,EAASC,eAAc,MAC7Dnd,EAAOod,iBAAiB,CACtBR,iBAAkB,EAAKzkB,MAAMykB,iBAC7Bpb,kBAAmB0b,EAAS3L,kBAC5BuH,eAAgBoE,EAASC,iBACxBJ,MAAK,SAACM,GACP,IAAM5N,EAAOjM,EAAAA,GAAAA,aAAAA,SAAiC6Z,GACtCnQ,EAAYnN,EAAAA,SAAAA,eAA4B0P,EAAK6N,MAA7CpQ,QACR,GAAI,EAAK/U,MAAMqH,MAAM+d,0BAA2B,CAC9C,IAAMC,EACJtQ,EAIEuQ,GAAY,EAChBD,EAAkBE,yBAAyBza,SAAQ,SAAA0a,GACjDF,EAAY,EAAKtlB,MAAMqH,MAAM6B,mBAAmBjD,SAC9Cuf,EAAapM,kBAEjB,IAEIkM,IACFzf,QAAQ6B,KACN,yDAAwD,WACpD2d,EAAkBL,eAAc,OAG1B,IAAV1kB,GAC2C,MAA3C,EAAKN,MAAMylB,8BAKTJ,EAAkBL,iBAClB,EAAKhlB,MAAMylB,+BAJb,EAAKC,qBAAqBL,GAS5B,EAAKje,UAAS,SAAAJ,GACZ,IAAMkT,EAGF,CAAC,EAKL,OAJAlT,EAAM2e,mBAAmB7a,SAAQ,SAAAia,GAC/B7K,EAAQ6K,EAASC,gBAAkBD,CACrC,IACA7K,EAAQmL,EAAkBL,gBAAkBK,EACrC,CAAEM,mBAAoBpI,OAAOxQ,OAAOmN,GAC7C,IAEJ,MACErU,QAAQ6B,KACN,qCAA8Bqd,EAASC,eAAc,OAArD,qFAKN,IAAGY,OAAM,SAACrf,GAER4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,2CAGJkB,QAAQU,MACN,qCAAoC,2BAChBwe,EAASC,eAAc,MAAI,qBACjCD,EAAS3L,kBAAiB,MAAI,oBAC/B,EAAKpZ,MAAMykB,iBAAgB,OACxCle,EAEJ,GACF,GACF,IAAGqf,OAAM,SAACrf,GACRV,QAAQU,MAAMA,GAEd4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,0CAGN,GACF,EAAC,EAKD+gB,qBAAuB,SACrBL,GAEA,IAAMrM,EAAe,EAAKwJ,aAAaqD,qBACvChgB,QAAQ6B,KAAK,sCAAD,OAC4B2d,EAAkBL,eAAc,MAExE,IAAMc,EAMF,CAAC,EACL9M,EAAalO,SAAQ,SAAAqM,GAEnB,IAAMxM,EAAawM,EAAYxM,WAC/B,EAAK6X,aAAauD,gBAAgBpb,GAClC,EAAK6X,aAAawD,sBAAsBrb,GACxC,IAAMpC,EAAQ,EAAKia,aAAayD,2BAA2Btb,GAC3D,EAAK6X,aAAa0D,oBAAoBvb,EAAYpC,GAElD8c,EAAkBE,yBAAyBza,SAAQ,SAAA0a,GAMjD,IAAIW,EAAmBX,EAAaY,gCACXtmB,IAArBqmB,IACFA,EAAmBX,EAAaa,8BAETvmB,IAArBqmB,GAGJA,EAAiBrb,SAAQ,SAAAwb,GAIvB,GAHqBnP,EAAYoP,gBAAgBtgB,SAC/CqgB,EAAUE,0BAEM,CAChB,IAAIC,EA4DA1Y,EA3DJ,GAAoD,MAAhDyX,EAAakB,gCAAyC,CACxD,IAAMC,EAAYnB,EAAakB,gCAAgC,GAC/DD,EAAkB,IAAI7e,EAAAA,MAAAA,wBAAkC,CACtDrH,IAC0C,MAAxComB,EAAUC,2BACND,EAAUC,2BACV,GAENC,cACEF,EAAUG,qCACZC,gBACEJ,EAAUK,uCACZC,eACEN,EAAUO,sCACZC,QAC+C,MAA5CR,EAAUS,+BACP,IAAIC,YACJV,EAAUS,qCAEVtnB,EAENwnB,UACiD,MAA9CX,EAAUY,iCACP,IAAIF,YACJV,EAAUY,uCAEVznB,EAEN0nB,SACgD,MAA7Cb,EAAUc,gCACP,IAAIJ,YACJV,EAAUc,sCAEV3nB,EAEN4nB,iBACwD,MAArDf,EAAUgB,wCACP,IAAIN,YACJV,EAAUgB,8CAEV7nB,EAEN8nB,mBAC0D,MAAvDjB,EAAUkB,0CACP,IAAIR,YACJV,EAAUkB,gDAEV/nB,EAENgoB,kBACyD,MAAtDnB,EAAUoB,yCACP,IAAIV,YACJV,EAAUoB,+CAEVjoB,GAGV,CAGA,GAA2C,MAAvC0lB,EAAawC,uBAAgC,CAC/C,IAAMC,EAAazC,EAAawC,uBAAuB,GACjDE,EAAeD,EAAWE,aAC1BC,EAAcH,EAAWI,YAC/Bta,EAAc,CACZma,EAA6B,GAAdE,EACfF,EAA6B,GAAdE,EAEnB,CAEAtC,EAAkBnb,GAAc,CAC9B8C,QAAS,EACTuJ,wBAAyByP,EACzB1Y,YAAaA,EAEjB,CACF,GACF,GACF,IAEA,IAAMua,EAA8C,IAAItE,IACxDzG,OAAOC,KAAKsI,GAAmBhb,SAAQ,SAAAH,GACrC,IAAMmD,EAAegY,EAAkBnb,GACnB,MAAhBmD,GACF,EAAK0U,aAAa0D,oBAAoBvb,EAAYmD,GAClD,EAAK0U,aAAa+F,oBAAoB5d,GACtC,EAAK6X,aAAagG,gBAAgB7d,GAClC2d,EAA+BG,IAAI9d,KAEnC,EAAK6X,aAAauD,gBAAgBpb,GAClC,EAAK6X,aAAawD,sBAAsBrb,GAE5C,IACA,IAAM+d,EAAe,IAAIC,gBAAgB,EAAK3oB,MAAMkb,SAAS0N,QAC7DF,EAAaG,IAAI,QAASxD,EAAkBL,gBAC5C,EAAKhlB,MAAMob,SACT,CACE0N,SAAU,EAAK9oB,MAAMkb,SAAS4N,SAC9BF,OAAQF,EAAa1e,YAEvB,CAAE+e,SAAS,IAEb,EAAK3hB,UAAS,SAAAJ,GAAK,MAAK,CACtByS,6BAA8B6O,EAC9B5O,8BAA+B4O,EAC/B7C,6BAA8BJ,EAAkBL,eACjD,GACH,EAAC,EAEDgE,YAAc,SAACnf,GACb,OAAW,MAAPA,EACK,EAAKoa,qBAEcnkB,IAAxB,EAAKokB,UAAUra,GACV,EAAKqa,UAAUra,GAEjB,EAAKoa,eACd,EAAC,EAEDgF,mBAAqB,SAACC,GACpBrjB,QAAQ+Y,MAAM,2BAMd,GAL0B,kCAKrBsK,EAA2CC,YAC9B,EAAK3G,aAAa4G,aAC1Bte,SAAQ,SAACL,GACf,EAAK4e,iCAAiC,CAAE7e,OAAQC,EAAIlK,IAAKmK,WAAW,GACtE,IACA7E,QAAQ+Y,MAAM,oCACT,GAVgC,kCAU3BsK,EAA2CC,YAAgD,CACzE,EAAK3G,aAAa8G,yBAC1Bxe,SAAQ,SAAC8C,GAC3B,EAAK2b,sCAAsC,CAAE5b,mBAAoBC,EAAgBrN,IAAKmK,WAAW,GACnG,IACA7E,QAAQ+Y,MAAM,4CAChB,MAAO,GAfc,iCAeTsK,EAA2CC,YAA8B,CAC/D,EAAK3G,aAAagH,iBAC1B1e,SAAQ,SAAC2P,GACnB,EAAKgP,8BAA8B,CAAEjP,WAAYC,EAAQla,IAAKmK,WAAW,GAC3E,IACA7E,QAAQ+Y,MAAM,uBAChB,MAAO,GApBe,kCAoBVsK,EAA2CC,YAA+B,CACvD,EAAK3G,aAAakH,0BAC1B5e,SAAQ,SAAC6e,GAC5B,EAAKC,8BAA8B,CAAE3P,WAAY0P,EAAiBppB,IAAKmK,WAAW,GACpF,IACA7E,QAAQ+Y,MAAM,yBAChB,MAAO,GAzBa,kCAyBRsK,EAA2CC,YAA6B,CAC1D,EAAK3G,aAAaqD,qBAC1B/a,SAAQ,SAACqM,GACvB,EAAK0S,kCAAkC,CAAEzS,sBAAuBD,EAAYxM,WAAYD,WAAW,GACrG,IACA7E,QAAQ+Y,MAAM,uBAChB,CACF,EAAC,EAmJDkL,qBAAmB,uBAAG,mGACP,IAAIC,SAAc,SAACC,EAASC,GACvCpkB,QAAQ6B,KAAK,2DACb,IAAMG,EAAS,EAAK7H,MAAM8H,QACxB/D,EAAemmB,mCAEjBriB,EAAOsiB,gBAAgB,CACrB1F,iBAAkB,EAAKzkB,MAAMykB,iBAC7BC,YAAa,CACXC,SAAU,SAEXC,MAAK,SAACwF,GACc,MAAjBA,IACFA,EAAgB,IAElBA,EAActf,SAAQ,SAAAnE,GACpB,IACM0jB,EADcziB,EAAAA,SAAAA,eAA4BjB,GAAxCoO,QAERlN,EAAOyiB,uBAAuB,CAC5B7F,iBAAkB,EAAKzkB,MAAMykB,iBAC7Bpb,kBAAmBghB,EAAOjR,oBACzBwL,MAAK,SAAC2F,GAC6DA,EAAkBnqB,KAAI,SAAA2B,GACxF,OAAO,IAAI6F,EAAAA,SAAAA,gCAA6C,CACtD7F,SAAAA,GAEJ,IAQY+I,SAAQ,SAAA0f,GAClB,IACE,EAAKhI,aAAasH,oBAAoBU,EAYxC,CAXE,MAAOjkB,GAEP4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,4DAIJkB,QAAQU,MAAM,mCAAoCA,EACpD,CACAikB,EAAI9b,wBAAwB5D,SAAQ,SAAAzK,GAClC,IAAMsN,EAAqBtN,EAAKuO,mBAC1B6b,EAAUpqB,EAAKqqB,mCAAmC,GAClD7gB,EAAMsX,GAAUsJ,GAChBliB,EAAQ,EAAK2b,UAAUra,GAEhB,MAATtB,GAA+B,MAAdA,EAAMyZ,MACzB,EAAKQ,aAAamI,wBAChBhd,EACA,CAAE3E,MAAOT,EAAMyZ,KAAKhZ,OAG1B,GACF,IAOA,EAAK4hB,cACLZ,GACF,IAAGpE,OAAM,SAACrf,GACRV,QAAQU,MAAMA,GAEd4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,iFAIN,GACF,GACF,IAAGihB,OAAM,SAACrf,GACRV,QAAQU,MAAMA,GAEd4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,oEAGJslB,EAAO1jB,aAAiBjC,MAAQiC,EAAQ,IAAIjC,MAAMsC,OAAOL,IAC3D,GACF,IAAE,mFACH,EAODskB,kBAAgB,uBAAG,mGACJ,IAAId,SAAc,SAACC,EAASC,GACvCpkB,QAAQ6B,KAAK,qCACb,IAAMG,EAAS,EAAK7H,MAAM8H,QAAQ/D,EAAe+mB,cACjDjjB,EAAOsiB,gBAAgB,CACrB1F,iBAAkB,EAAKzkB,MAAMykB,iBAC7BC,YAAa,CACXC,SAAU,SAEXC,MAAK,SAACwF,GACc,MAAjBA,IACFA,EAAgB,IAElBA,EAActf,SAAQ,SAACnE,EAAG6C,GACxB,IACM6gB,EADcziB,EAAAA,SAAAA,eAA4BjB,GAAxCoO,QAERlN,EAAOyiB,uBAAuB,CAC5B7F,iBAAkB,EAAKzkB,MAAMykB,iBAC7Bpb,kBAAmBghB,EAAOjR,oBACzBwL,MAAK,SAAC2F,GACP,IAAMQ,EAA6C,GAWnD,GAVAR,EAAkBzf,SAAQ,SAAA/I,GACxB,IAAMipB,EAAM,IAAIpjB,EAAAA,SAAAA,aAA0B,CAAE7F,SAAAA,IACtC0c,EAAW,EAAKze,MAAMqH,MAAMib,aAAa,GAE7C0I,EAAIC,sBAAwBxM,EAASwM,qBACrCD,EAAIrjB,sBAAwB8W,EAAS9W,qBAErCojB,EAAc9oB,KAAK+oB,EAEvB,IACID,EAAcxjB,OAAS,EAAG,CAC5B,IACE,EAAKib,aAAa0I,YAAYH,EAWhC,CAVE,MAAOxkB,GAEP4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,sCAGJkB,QAAQU,MAAM,2BAA4BA,EAC5C,CAOA,EAAKqkB,aACP,CAEAZ,GACF,IAAGpE,OAAM,SAACrf,GACRV,QAAQU,MAAMA,GAEd4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,2DAGN,GACF,GACF,IAAGihB,OAAM,SAACrf,GACRV,QAAQU,MAAMA,GAEd4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,8CAGJslB,EAAO1jB,aAAiBjC,MAAQiC,EAAQ,IAAIjC,MAAMsC,OAAOL,IAC3D,GACF,IAAE,mFACH,EAOD4kB,mBAAiB,uBAAG,mGACL,IAAIpB,SAAc,SAACC,EAASC,GACvCpkB,QAAQ6B,KAAK,uCACb,IAAMG,EAAS,EAAK7H,MAAM8H,QAAQ/D,EAAeqnB,gBACjDvjB,EAAOsiB,gBAAgB,CACrB1F,iBAAkB,EAAKzkB,MAAMykB,iBAC7BC,YAAa,CACXC,SAAU,QAEXC,MAAK,SAACwF,GACc,MAAjBA,IACFA,EAAgB,IAElBA,EAActf,SAAQ,SAAAnE,GACpB,IACM0jB,EADcziB,EAAAA,SAAAA,eAA4BjB,GAAxCoO,QAERlN,EAAOyiB,uBAAuB,CAC5B7F,iBAAkB,EAAKzkB,MAAMykB,iBAC7Bpb,kBAAmBghB,EAAOjR,oBACzBwL,MAAK,SAAC2F,GACP,IAAMc,EAA+C,GAerD,GAdAd,EAAkBzf,SAAQ,SAAA/I,GACxB,IAAMupB,EAAK,IAAI1jB,EAAAA,SAAAA,cAA2B,CAAE7F,SAAAA,IACtC0c,EAAW,EAAKze,MAAMqH,MAAMib,aAAa,GAE7CgJ,EAAGL,sBAAwBxM,EAASwM,qBACpCK,EAAG3jB,sBAAwB8W,EAAS9W,oBAEpC0jB,EAAeppB,KAAKqpB,GAEpBzlB,QAAQD,KAAK,iCAAD,OACuB0lB,EAAGtG,eAAc,KAGxD,IACIqG,EAAe9jB,OAAS,EAAG,CAC7B,IACE,EAAKib,aAAa+I,qBAAqBF,EAWzC,CAVE,MAAO9kB,GAEP4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,uCAGJkB,QAAQU,MAAM,2BAA4BA,EAC5C,CAOA,EAAKqkB,aACP,CACAZ,GACF,IAAGpE,OAAM,SAACrf,GACRV,QAAQU,MAAMA,GAEd4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,6DAGN,GACF,GACF,IAAGihB,OAAM,SAACrf,GACRV,QAAQU,MAAMA,GAEd4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,gDAGJslB,EAAO1jB,aAAiBjC,MAAQiC,EAAQ,IAAIjC,MAAMsC,OAAOL,IAC3D,GACF,IAAE,mFACH,EAKDilB,kBAAoB,WAClB3lB,QAAQ6B,KAAK,yBACb,EAAKN,SAAS,CACZH,WAAW,EACX0e,mBAAoB,KAGgB,MAAlC,EAAKhC,kBAAkBnc,SACzB,EAAKgb,aAAapa,OAAO,CAAEC,UAAW,EAAKsb,kBAAkBnc,UAG5B,MAAjC,EAAKoc,iBAAiBpc,SACF,MAApB,EAAK+a,aAEL,EAAKA,YAAYna,OAAO,CAAEC,UAAW,EAAKub,iBAAiBpc,UAI7D,EAAKJ,SAAS,CAAEH,WAAW,IAE3B,EAAKwkB,8BACL,EAAKnH,yBAGA,EAAKoH,iBACP9G,MAAK,WAC6B,MAA7B,EAAK5kB,MAAMkpB,gBACb,EAAKD,mBAAmB,EAAKjpB,MAAMkpB,eAEvC,IACCtD,OAAM,SAAArf,GACLV,QAAQU,MAAM,6BAA8BA,EAC9C,IAEG,EAAKujB,sBACPlF,MAAK,WAC6B,MAA7B,EAAK5kB,MAAMkpB,gBACb,EAAKD,mBAAmB,EAAKjpB,MAAMkpB,eAEvC,IACCtD,OAAM,SAAArf,GACLV,QAAQU,MAAM,mCAAoCA,EACpD,IAEG,EAAKskB,mBACPjG,MAAK,WAC6B,MAA7B,EAAK5kB,MAAMkpB,gBACb,EAAKD,mBAAmB,EAAKjpB,MAAMkpB,eAEvC,IACCtD,OAAM,SAAArf,GACLV,QAAQU,MAAM,+BAAgCA,EAChD,IAEG,EAAK4kB,oBACPvG,MAAK,WAC6B,MAA7B,EAAK5kB,MAAMkpB,gBACb,EAAKD,mBAAmB,EAAKjpB,MAAMkpB,eAEvC,IACCtD,OAAM,SAAArf,GACLV,QAAQU,MAAM,iCAAkCA,EAClD,GACJ,EAAC,EAEDolB,cAAgB,SAACrhB,GAEf,EAAKlD,UAAS,SAAAJ,GAAK,MAAK,CACtBwF,eAAgB,IAAIwX,IAAIhd,EAAMwF,gBAC/B,GACH,EAAC,EAEDof,eAAiB,SAACthB,GAChBzE,QAAQ6B,KAAK,oBACb,EAAK8a,aAAala,SACM,MAApB,EAAKia,aACP,EAAKA,YAAYja,QAErB,EAAC,EAEDujB,WAAa,SAACvhB,GACZ,IAAMG,EAAMH,EAAMwhB,OAAOpnB,QACnBqnB,EAAkB,EAAK/kB,MAAM+kB,gBAC7BC,EAAsB,EAAKhlB,MAAMglB,oBACvC,QAAYlsB,IAAR2K,QAAyC3K,IAApBisB,EAA+B,CACtDlmB,QAAQ+Y,MAAM,YAAD,OAAanU,EAAIlK,IAAG,MACjC,IAAM0rB,EAAc,IAAI5gB,EAAAA,GAAAA,WAAAA,gBAAoC,CAC1D3K,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPqN,QAAS,UACTD,iBAAkB,QAEpBpN,MAAO8qB,EACPG,iBAAkB,aAEpBzhB,EAAI0hB,cAAcF,GAClBD,EAAoBlhB,SAAQ,SAAC2I,GAC3B,IAAMpT,EAAO,IAAIgL,EAAAA,GAAAA,WAAAA,gBAAoC,CACnD3K,KAAM+S,EAAW/S,KACjBO,MAAOwS,EAAWxS,MAClBirB,iBAAkB,aAEpBzhB,EAAI0hB,cAAc9rB,EACpB,IACA,IAAMwJ,EAAMsX,GAAU4K,GAChBxjB,EAAQ,EAAKygB,YAAYnf,GAC/B,EAAK2Y,aAAa4J,OAAO3hB,EAAKlC,GAC9B,EAAKnB,UAAS,SAAAJ,GACZ,IAAMwF,EAAiBxF,EAAMwF,eAE7B,OADAA,EAAeic,IAAIhe,EAAIlK,KAChB,CAAEiM,eAAAA,EACX,GACF,MACE3G,QAAQ+Y,MAAM,sBAAD,OAAuBnU,EAAIlK,IAAG,KAE/C,EAAC,EAED8rB,mBAAqB,SAAC/hB,GAED,MADCA,EAAMwhB,OAAOpnB,QAE/B,EAAK0C,SAAS,CACZklB,2BAA2B,IAG7B,EAAKllB,SAAS,CACZklB,2BAA2B,GAGjC,EAAC,EAEDC,wBAA0B,SAAC1I,GACzB,IAAMtX,EAAO,EAAKiW,aAAa4G,aAC/B,GAAoB,IAAhB7c,EAAKhF,OAAT,CAKA,IAAM+W,EAASuF,EAAYzjB,KAAI,SAACqK,GAAS,IAAD,EAChCtK,EAAqD,GA8C3D,OA7CoBsK,EAAII,YACZC,SAAQ,SAClBzK,GAKA,IAAM0K,EAAY1K,EAAK2K,wBAAwB,GAAGC,UAC5CC,EAAc7K,EAAK2K,wBAAwB,GAAGG,YAC9CzK,EAAI,UAAMwK,GAChB,GAAI7K,EAAK+K,YAAcC,EAAAA,GAAAA,WAAAA,WAAAA,KAAqC,CAC1D,IACMC,EADkBjL,EACakL,oBAAoB,GAAGJ,YAE1C,cAAdJ,EACF5K,EAAW8B,KAAK,CACdvB,KAAM,oBACNO,MAAM,GAAD,OAAKqK,KAEW,WAAdP,EACT5K,EAAW8B,KAAK,CACdvB,KAAM,gBACNO,MAAM,GAAD,OAAKqK,KAEW,WAAdP,EACT5K,EAAW8B,KAAK,CACdvB,KAAM,iBACNO,MAAM,GAAD,OAAKqK,KAGZnL,EAAW8B,KAAK,CACdvB,KAAMA,EACNO,MAAM,GAAD,OAAKqK,IAGhB,MAAO,GAAIjL,EAAK+K,YAAcC,EAAAA,GAAAA,WAAAA,WAAAA,KAAqC,CACjE,IAAMG,EAAkBnL,EACxBF,EAAW8B,KAAK,CACdvB,KAAMA,EACNO,MAAOuK,EAAgBC,WAE3B,CACF,IAGO,CAAEnL,OAD8C,QAAzC,EAACiM,EAAKoC,WAAU,SAAC6d,GAAC,OAAKA,EAAEjsB,MAAQkK,EAAIlK,GAAG,WAAC,QAAI,GAAK,EAChD6d,OAAQ3T,EAAIlK,IAAKJ,WAAAA,EACnC,GAAG,IAEH,EAAKiH,SAAS,CAAEqlB,qBAAsBnO,GApDtC,MAFE,EAAKlX,SAAS,CAAEqlB,qBAAsB,IAuD1C,EAAC,EAEDC,iBAAmB,WACjB,EAAK7I,YAAc,EACrB,EAAC,EAED8I,qBAAuB,SAACC,GACtB,GAAc,MAAVA,EACF,MAAO,GAET,IAAMC,EAAO,mBAAO,EAAKhJ,aAAW,CAAE+I,IAEtC,OADkBlnB,MAAMC,KAAK,IAAIqe,IAAI6I,EAAQzsB,KAAI,SAAAqK,GAAG,OAAIA,EAAIlK,GAAG,MAC9CH,KAAI,SAAAgV,GAAE,OAAIyX,EAAQnmB,MAAK,SAAA+D,GAAG,OAAIA,EAAIlK,MAAQ6U,CAAE,GAAC,IAC3D2K,QAAO,SAACtV,GAAG,YAAiC3K,IAAR2K,CAAiB,GAC1D,EAAC,EAEDqiB,kBAAoB,SAACxiB,GACnB,OAAOA,EAAMyiB,UAAY,EAAKjJ,UAAU,IAAMxZ,EAAM0iB,UAAY,EAAKlJ,UAAU,EACjF,EAAC,EAEDmJ,cAAgB,SAAC3iB,GACf,MAA4CA,EAAMwhB,OAAOpnB,QAAxCwoB,EAAU,EAAnBC,QACFC,EADiC,EAAV9iB,MACH8iB,cAErB,EAAKN,kBAAkBM,KAC1B,EAAKtJ,UAAY,CAACsJ,EAAcL,QAASK,EAAcJ,SACvD,EAAKN,oBAGP,EAAK7I,YAAc,EAAK8I,qBAAqBO,GAEzC,EAAKrJ,YAAYtc,OAAS,GAC5B,EAAKglB,wBAAwB,EAAK1I,aAClC,EAAKzc,SAAS,CACZimB,4BAA4B,EAC5BC,mBAAoBF,EAAcL,QAClCQ,mBAAoBH,EAAcJ,WAGpC,EAAK5lB,SAAS,CACZimB,4BAA4B,GAGlC,EAAC,EAEDG,uBAAyB,SAACC,GACxB,IAAMC,EAAiBD,EACjBE,EAAiB,CACrB7gB,gBAAiB,IAAIkX,IACrB4J,iBAAa9tB,GAGf,QAAuBA,IAAnB4tB,EACF,OAAOC,EAGT,IAAMC,EAAc,EAAKpL,aAAaqL,OAAOH,GAC7C,QAAoB5tB,IAAhB8tB,EACF,OAAOD,EAKT,GAFA9nB,QAAQ+Y,MAAM,iBAAD,OAAkBgP,EAAYrtB,IAAG,OAEzC,EAAKwjB,SAASpX,IAAI,SACrB,MAAO,CACLG,gBAAiB,IAAIkX,IAAI,CAAC4J,EAAYrtB,MACtCqtB,YAAAA,GAIJ,IAAME,EAAkBpoB,MAAMC,KAAK,EAAKqB,MAAM8F,iBAC9C,MAAO,CACLA,gBAAiB,IAAIkX,IAAI,GAAD,OAAK8J,EAAgB,CAACF,EAAYrtB,OAC1DqtB,YAAAA,EAEJ,EAAC,EAEDG,yBAA2B,SAACC,GAC1B,EAAKxL,aAAa4G,aAAate,SAAQ,SAAAL,GACrC,IAAMlK,EAAMkK,EAAIlK,IAEhB,IAAIytB,EAAelhB,gBAAgBH,IAAIpM,IAAS,EAAKyG,MAAMwF,eAAeG,IAAIpM,GAA9E,CAIA,IAAMsJ,EAAMyX,GAAW7W,GACjBlC,EAAQ,EAAKygB,YAAYnf,GAC/B,EAAK2Y,aAAayL,YAAY1tB,EAAKgI,EAJnC,CAKF,GACF,EAAC,EAED2lB,aAAe,SAAC5jB,GAAkC,IAAD,MAG/C,GAA2B,KAFqB,QAA/B,EAAgB,QAAhB,EAAIA,EAAMwhB,cAAM,OAAS,QAAT,EAAZ,EAAcpnB,eAAO,WAAT,EAAZ,EAAuB6H,YAAI,QAAI,IAEpChF,OAAhB,CAIA,IAAM4mB,EAAsB,EAAKX,yBACjC,EAAKpmB,SAAS+mB,GAGd,EAAK3L,aAAa4L,kBAElB,EAAKL,yBAAyBI,EAR9B,CASF,EAAC,EAEDE,cAAgB,SAAC/jB,GAAkC,IAAD,IAC1CojB,EAA6B,QAAf,EAAGpjB,EAAMwhB,cAAM,OAAS,QAAT,EAAZ,EAAcpnB,eAAO,WAAT,EAAZ,EAAuBnE,IACxC4tB,EAAsB,EAAKX,uBAAuBE,GACxD,EAAKtmB,SAAS+mB,GAEd,EAAKJ,yBAAyBI,EAChC,EAAC,EAiCDG,iBAAmB,SAAChkB,GAClB,EAAKlD,SAAS,CAAEH,WAAW,GAC7B,EAAC,EAEDsnB,eAAiB,SAACjkB,GAChB,EAAKlD,SAAS,CAAEH,WAAW,GAC7B,EAAC,EAEDunB,sBAAwB,SAAClkB,GACvB,IAAMmkB,EAOFnkB,EAAMwhB,OAAOpnB,QACXmF,EAAW,UAAM4kB,EAAU9N,eAAc,YAAI8N,EAAUC,aAC7D,EAAKtnB,UAAS,SAAAJ,GAEZ,OADAA,EAAM2nB,cAAclG,IAAI5e,GACjB7C,CACT,GACF,EAAC,EAED4nB,oBAAsB,SAACtkB,GACrBzE,QAAQU,MAAM,uBAChB,EAAC,EAEDsoB,eAAiB,SAACvkB,GAAkC,IAAD,MAC3CxF,EAAyC,QAAlC,EAAgB,QAAhB,EAAIwF,EAAMwhB,cAAM,OAAS,QAAT,EAAZ,EAAcpnB,eAAO,WAAT,EAAZ,EAAuBI,eAAO,QAAI,sBACnDe,QAAQU,MAAMzB,GACdqD,GAAAA,QACElD,EACA,IAAIL,EACFD,EACAG,GAGN,EAAC,EAEDgqB,oBAAsB,SAACxkB,GACrB,IAAMmkB,EAQFnkB,EAAMwhB,OAAOpnB,QACXmF,EAAG,UAAM4kB,EAAU9N,eAAc,YAAI8N,EAAUC,aAYrD,GAXA,EAAKtnB,UAAS,SAAAJ,GACZA,EAAM2nB,cAAcI,OAAOllB,GAC3B,IAAI5C,GAAqB,EAIzB,OAHID,EAAM2nB,cAAcrtB,KAAO,IAC7B2F,GAAY,GAEP,CACLA,UAAAA,EACA0nB,cAAe3nB,EAAM2nB,cAEzB,IAEEF,EAAUO,cAAgBjrB,EAAegE,iCACzC,EAAK/H,MAAMqH,MAAM+d,0BACjB,CACA,IAAMhO,EAAwBqX,EAAUQ,kBACxC,KACI7X,KAAyB,EAAKpQ,MAAMkoB,sBACd,MAAxBT,EAAUU,WACV,CAUA,IALA,IAAM7tB,EAAI,SAAG,EAAK,IACZ8tB,EAASxX,KAAKyX,KAAKZ,EAAUU,WAAW5nB,OAASjG,GACnDsP,EAAS,EACP0e,EAAsB,GACtBC,EAAsB,GACnB/lB,EAAI,EAAGA,EAAI4lB,EAAQ5lB,IAAK,CAC/BoH,EAASpH,EAAIlI,EACb,IAAMkuB,EAASf,EAAUU,WAAW/oB,MAAMwK,EAAQA,EAAStP,GAC3DguB,EAAUrtB,KAAK2V,KAAKhI,IAAG,MAARgI,MAAI,QAAQ4X,KAC3BD,EAAUttB,KAAK2V,KAAK/H,IAAG,MAAR+H,MAAI,QAAQ4X,IAC7B,CACA,IAAM5f,EAAMgI,KAAKhI,IAAG,MAARgI,KAAY0X,GAClBzf,EAAM+H,KAAK/H,IAAG,MAAR+H,KAAY2X,GACxB,EAAKnoB,UAAS,SAAAJ,GACZ,IAAMyoB,EAAQzoB,EAAMkoB,oBAcpB,GAboC,MAAhCO,EAAMrY,GACRqY,EAAMrY,GAAyB,CAC7BxH,IAAKgI,KAAKhI,IAAI6f,EAAMrY,GAAuBxH,IAAKA,GAChDC,IAAK+H,KAAK/H,IAAI4f,EAAMrY,GAAuBvH,IAAKA,GAChD6f,iBAAkBD,EAAMrY,GAAuBsY,iBAAmB,GAGpED,EAAMrY,GAAyB,CAC7BxH,IAAKA,EACLC,IAAKA,EACL6f,iBAAkB,GAGoB,MAAtC1oB,EAAMye,6BAAsC,CAC9C,IAAMld,GAAK,UACN,EAAKia,aAAamN,oBAAoBvY,IAE3C7O,EAAMwF,YAAc,CAClB0hB,EAAMrY,GAAuBxH,IAC7B6f,EAAMrY,GAAuBvH,KAE/B,EAAK2S,aAAa0D,oBAAoB9O,EAAuB7O,EAC/D,CACA,OAAOvB,CACT,GACF,CACF,CACF,EAAC,EAED4oB,aAAe,SAACtlB,GACd,IAAMG,EAAMH,EAAMwhB,OAAOpnB,QACzBmB,QAAQ+Y,MAAM,gBAAD,OAAiBnU,EAAIlK,IAAG,KACvC,EAAC,EAuEDsvB,UAAY,SAACvlB,GACX,EAAKyZ,SAAS0E,IAAIne,EAAMT,IAC1B,EAAC,EAEDimB,QAAU,SAACxlB,GACT,EAAKyZ,SAASgL,OAAOzkB,EAAMT,KACT,WAAdS,EAAMT,KACJ,EAAK7C,MAAM+oB,oBACblqB,QAAQ6B,KAAK,8BACb,EAAK8a,aAAawN,4BAClB,EAAKxN,aAAaG,0BAA0B,CAAC,IACpC,EAAK3b,MAAMipB,yBACpBpqB,QAAQ6B,KAAK,mCACb,EAAK8a,aAAa0N,8BAClB,EAAK1N,aAAaG,0BAA0B,CAAC,IACpC,EAAK3b,MAAMmpB,yBACpBtqB,QAAQ6B,KAAK,mCACb,EAAK8a,aAAa4N,iCAClB,EAAK5N,aAAaG,0BAA0B,CAAC,IAE/C,EAAKvb,SAAS,CACZipB,0BAA0B,EAC1B/D,2BAA2B,EAC3B6D,wBAAwB,EACxBJ,oBAAoB,EACpBE,yBAAyB,EACzBK,oBAAoB,KAEbhmB,EAAMimB,SACI,SAAfjmB,EAAMkmB,KACR,EAAKC,mBACmB,SAAfnmB,EAAMkmB,KACf,EAAKE,wBACmB,SAAfpmB,EAAMkmB,KACf,EAAKG,uBACmB,SAAfrmB,EAAMkmB,KACf,EAAKI,mBACmB,SAAftmB,EAAMkmB,KACf,EAAKK,4BACmB,SAAfvmB,EAAMkmB,KACf,EAAKM,yBACmB,SAAfxmB,EAAMkmB,MACf,EAAKO,aAGX,EAAC,EA0jCDxjB,2BAA6B,SAACI,GAC5B,EAAK6U,aAAawO,UAAUrjB,EAC9B,EAAC,EAMDsjB,wBAA0B,SAAC3mB,GACzB,IAAMD,EAAUC,EAAMsR,OAAOvR,QAC7B,EAAKjD,SAAS,CAAE8pB,qBAAsB7mB,IACtC,EAAKmY,aAAa2O,mBACpB,EAAC,EAEDC,iBAAmB,SAAClU,GAA+D,IAAD,EAC1EzS,EAAM,EAAK+X,aAAaqL,OAAO3Q,EAAW3c,KAC1CsJ,EAAMyX,GAAW7W,GACjBzB,OAAgClJ,IAAxB,EAAKokB,UAAUra,GACC,QADiB,EAC3C,EAAKqa,UAAUra,GAAKkY,cAAM,aAA1B,EAA4B/Y,MAAM5C,MAAM,EAAG,GAC3C8a,GACA3D,OAAOC,KAAK,EAAK0G,WAAW3c,OAAS2Z,GAAiC3Z,QAE1E,EAAKuU,wBAAwBoB,EAAW3c,KAAO,CAC7CyI,MAAOA,EACPyE,QA7/F6B,GA8/F7B+N,aAAa,GAGf,EAAK0I,UAAUra,GAAO,EAAKwnB,iBACzB,EAAKvV,wBAAwBoB,EAAW3c,KAE5C,EA1kFEsF,QAAQ6B,KAAK,eAAD,OACK,EAAK1H,MAAMqH,MAAMoB,oBAAmB,OACnD,EAAKzI,MAAMqH,OAEb,IAAMqc,EAAsB,CAC1B,QACA,SACA,MACA,UACA,OACA,kBACA,gBAEF1jB,EAAMmV,YAAYrK,SAAQ,SAACoS,GACzB,IAAMuN,EAAU,IAAIpf,EAAAA,GAAAA,OAAAA,aAA6B6R,EAAWuN,SAC5D,EAAKjH,eAAevhB,KAAKwoB,GACzB,IAAM5gB,EAAMsX,GAAUsJ,QACW3qB,IAA7Bod,EAAWoU,cACb,EAAK5N,oBAAoB7Z,GAAOqT,EAAWoU,cAE3C,EAAK5N,oBAAoB7Z,GAAO6Z,EAElC,EAAKD,kBAAkB5Z,GAAO,QACC/J,IAA3Bod,EAAWrS,aACbqS,EAAWrS,YAAYC,SAAQ,SAAA2I,GAC7B,EAAKgQ,kBAAkB5Z,GAAK5H,KAAK,CAC/BvB,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6BoI,EAAW/S,MAClDqM,OAAQ0G,EAAW1G,OAAO3M,KAAI,SAAAa,GAC5B,OAAO,IAAIoK,EAAAA,GAAAA,OAAAA,aAA6BpK,EAC1C,KAEJ,SAE8BnB,IAA5Bod,EAAWxR,cACbwR,EAAWxR,aAAaZ,SAAQ,SAAAsD,GAC9B,EAAK1C,aAAazJ,KAAK,CACrBvB,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B+C,EAAY1N,MACnDO,WAAOnB,EACPiM,KAAM,IAAIV,EAAAA,GAAAA,OAAAA,aAA6B+C,EAAYrC,OAEvD,IAEsB,MAApBmR,EAAW3U,MACb,EAAK2b,UAAUra,GAAOiY,GAAgB5E,EAAW3U,OAEjD,EAAK2b,UAAUra,GAAO,EAAKoa,eAE/B,IAEA,EAAKsN,eAAiB,EAAKA,eAAennB,MAAK,WAC/C,EAAKonB,iBAAmB,EAAKA,iBAAiBpnB,MAAK,WACnD,EAAKwhB,eAAiB,EAAKA,eAAexhB,MAAK,WAC/C,EAAKqmB,iBAAmB,EAAKA,iBAAiBrmB,MAAK,WACnD,EAAKumB,qBAAuB,EAAKA,qBAAqBvmB,MAAK,WAC3D,EAAKsmB,sBAAwB,EAAKA,sBAAsBtmB,MAAK,WAC7D,EAAKymB,0BAA4B,EAAKA,0BAA0BzmB,MAAK,WACrE,EAAKwmB,iBAAmB,EAAKA,iBAAiBxmB,MAAK,WACnD,EAAKqnB,+BAAiC,EAAKA,+BAA+BrnB,MAAK,WAC/E,EAAKsnB,0CAA4C,EAAKA,0CAA0CtnB,MAAK,WACrG,EAAKunB,sCAAwC,EAAKA,sCAAsCvnB,MAAK,WAC7F,EAAKwnB,sCAAwC,EAAKA,sCAAsCxnB,MAAK,WAC7F,EAAKynB,iCAAmC,EAAKA,iCAAiCznB,MAAK,WACnF,EAAK0nB,oCAAsC,EAAKA,oCAAoC1nB,MAAK,WACzF,EAAK2nB,oCAAsC,EAAKA,oCAAoC3nB,MAAK,WACzF,EAAK4nB,wCAA0C,EAAKA,wCAAwC5nB,MAAK,WACjG,EAAKif,iCAAmC,EAAKA,iCAAiCjf,MAAK,WACnF,EAAKmf,sCAAwC,EAAKA,sCAAsCnf,MAAK,WAC7F,EAAK6nB,iCAAmC,EAAKA,iCAAiC7nB,MAAK,WACnF,EAAK8nB,qBAAuB,EAAKA,qBAAqB9nB,MAAK,WAC3D,EAAK2mB,WAAa,EAAKA,WAAW3mB,MAAK,WACvC,EAAK+nB,2BAA6B,EAAKA,2BAA2B/nB,MAAK,WACvE,EAAKgoB,2BAA6B,EAAKA,2BAA2BhoB,MAAK,WACvE,EAAKioB,6BAA+B,EAAKA,6BAA6BjoB,MAAK,WAC3E,EAAKkoB,6BAA+B,EAAKA,6BAA6BloB,MAAK,WAC3E,EAAKmoB,yCAA2C,EAAKA,yCAAyCnoB,MAAK,WACnG,EAAK0mB,uBAAyB,EAAKA,uBAAuB1mB,MAAK,WAC/D,EAAKooB,yBAA2B,EAAKA,yBAAyBpoB,MAAK,WACnE,EAAKqoB,yBAA2B,EAAKA,yBAAyBroB,MAAK,WACnE,EAAKqf,8BAAgC,EAAKA,8BAA8Brf,MAAK,WAC7E,EAAKsoB,yBAA2B,EAAKA,yBAAyBtoB,MAAK,WACnE,EAAKwf,8BAAgC,EAAKA,8BAA8Bxf,MAAK,WAC7E,EAAKuoB,yBAA2B,EAAKA,yBAAyBvoB,MAAK,WACnE,EAAKyf,kCAAoC,EAAKA,kCAAkCzf,MAAK,WACrF,EAAKwoB,6BAA+B,EAAKA,6BAA6BxoB,MAAK,WAC3E,EAAKyoB,gCAAkC,EAAKA,gCAAgCzoB,MAAK,WACjF,EAAK0oB,iCAAmC,EAAKA,iCAAiC1oB,MAAK,WACnF,EAAK2oB,6BAA+B,EAAKA,6BAA6B3oB,MAAK,WAC3E,EAAK6mB,wBAA0B,EAAKA,wBAAwB7mB,MAAK,WACjE,EAAK4oB,0BAA4B,EAAKA,0BAA0B5oB,MAAK,WAErE,MAAsCgY,GAAkB,CACtDta,QAAS,EAAK9H,MAAM8H,QACpBT,MAAO,EAAKrH,MAAMqH,MAClBgb,QAAS,EAAKriB,MAAMqiB,UAHdG,EAAY,EAAZA,aAAcD,EAAW,EAAXA,YAKtB,EAAKC,aAAeA,EACpB,EAAKD,YAAcA,EACnB,EAAKoB,kBAAoB7hB,EAAAA,YACzB,EAAK8hB,iBAAmB9hB,EAAAA,YAMxB,EAAK0gB,aAAaqD,qBAAqB/a,SAAQ,SAAAqM,GAC7C,EAAKqL,aAAawD,sBAAsB7O,EAAYxM,WACtD,IAEA,cAAuB,EAAK6X,aAAayQ,YAAW,GAA7CriB,EAAM,KAAEtP,EAAI,KAuClB,OArCD,EAAK0F,MAAQ,CACX8F,gBAAiB,IAAIkX,IACrBxX,eAAgB,IAAIwX,IACpBpJ,mBAAoB,IAAIoJ,IACxB5J,mBAAoB,IAAI4J,IACxB3S,2BAA4B,IAAI2S,IAChCtK,8BAA+B,IAAIsK,IACnCvK,6BAA8B,IAAIuK,IAClC2B,mBAAoB,GACpBoG,qBAAiBjsB,EACjBksB,oBAAqB,GACrBzL,qBAAiBzgB,EACjBmH,WAAW,EACXopB,0BAA0B,EAC1B/D,2BAA2B,EAC3Be,4BAA4B,EAC5BC,mBAAoB,EACpBC,mBAAoB,EACpBd,qBAAsB,GACtByG,8BAA8B,EAC9B5S,sBAAsB,EACtByP,oBAAoB,EACpBI,wBAAwB,EACxBF,yBAAyB,EACzBK,oBAAoB,EACpB6C,4BAA4B,EAC5BC,4BAA4B,EAC5BC,yBAAqBvzB,EACrBwzB,sBAAuB,CAAC1iB,EAAO,GAAIA,EAAO,GAAKtP,EAAK,IACpDiyB,yBAAqBzzB,EACrB0zB,sBAAuB,CAAC5iB,EAAO,GAAIA,EAAO,GAAKtP,EAAK,IACpDmyB,2BAAuB3zB,EACvB4zB,eAAe,EACfxE,oBAAqB,CAAC,EACtBzJ,6BAA8B,EAAKzlB,MAAMylB,6BACzCkJ,cAAe,IAAI3K,IACnBkN,sBAAsB,GACvB,CACH,CAwsGC,OAxsGA,0CAED,SACEja,EACAC,GACO,IAAD,OAIN,GACEnX,KAAKC,MAAMkb,SAAS4N,WAAa7R,EAAciE,SAAS4N,UACxD/oB,KAAKC,MAAMykB,mBAAqBxN,EAAcwN,kBAC9C1kB,KAAKC,MAAMqJ,oBAAsB4N,EAAc5N,mBAC/CtJ,KAAKC,MAAMqH,QAAU4P,EAAc5P,OACnCtH,KAAKC,MAAM8H,UAAYmP,EAAcnP,QACrC,CACsC,MAAlC/H,KAAK4jB,kBAAkBnc,UACzBzH,KAAK4jB,kBAAkBnc,QAAQC,UAAY,IAE7C1H,KAAKyiB,aAAamR,UACM,MAApB5zB,KAAKwiB,cAC8B,MAAjCxiB,KAAK6jB,iBAAiBpc,UACxBzH,KAAK6jB,iBAAiBpc,QAAQC,UAAY,IAE5C1H,KAAKwiB,YAAYoR,WAEnB,MAAsCvR,GAAkB,CACtDta,QAAS/H,KAAKC,MAAM8H,QACpBT,MAAOtH,KAAKC,MAAMqH,MAClBgb,QAAStiB,KAAKC,MAAMqiB,UAHdG,EAAY,EAAZA,aAAcD,EAAW,EAAXA,YAKtBxiB,KAAKyiB,aAAeA,EACpBziB,KAAKwiB,YAAcA,EAEnB,IAAM9I,EAA4C,IAAIuK,IAChDtK,EAA6C,IAAIsK,IACvDjkB,KAAKyiB,aAAaqD,qBAAqB/a,SAAQ,SAAAqM,GAC7C,IAAMxM,EAAawM,EAAYxM,WAC3B,EAAK6X,aAAaoR,qBAAqBjpB,IACzC+O,EAA8B+O,IAAI9d,GAEhC,EAAK6X,aAAaqR,oBAAoBlpB,IACxC8O,EAA6BgP,IAAI9d,EAErC,IAEA,cAAuB5K,KAAKyiB,aAAayQ,YAAW,GAA7CriB,EAAM,KAAEtP,EAAI,KAEnBvB,KAAKqH,SAAS,CACZoF,eAAgB,IAAIwX,IACpBpJ,mBAAoB,IAAIoJ,IACxB5J,mBAAoB,IAAI4J,IACxB3S,2BAA4B,IAAI2S,IAChCtK,8BAAAA,EACAD,6BAAAA,EACAkM,mBAAoB,GACpBgJ,cAAe,IAAI3K,IACnBsP,sBAAuB,CAAC1iB,EAAO,GAAIA,EAAO,GAAKtP,EAAK,IACpDkyB,sBAAuB,CAAC5iB,EAAO,GAAIA,EAAO,GAAKtP,EAAK,MAEtDvB,KAAKyrB,mBACP,CACF,GAgHA,4BA2MA,yCAKA,8GACe,IAAIzB,SAAc,SAACC,EAASC,GACvCpkB,QAAQ6B,KAAK,4CACb,IAAMG,EAAS,EAAK7H,MAAM8H,QAAQ/D,EAAe+vB,qBACjDjsB,EAAO2c,mBAAmB,CACxBC,iBAAkB,EAAKzkB,MAAMykB,iBAC7BC,YAAa,CACXC,SAAU,QAEXC,MAAK,SAACC,GACiB,MAApBA,IACFA,EAAmB,IAErBA,EAAiB/Z,SAAQ,SAAAtB,GACvB,IACMub,EADcnd,EAAAA,SAAAA,eAA4B4B,GAAxCuL,QAEJgQ,EAASoE,cAAgBplB,EAAe+vB,sBAC1CjuB,QAAQ6B,KAAK,yBAAD,OAA0Bqd,EAASC,eAAc,MAC7Dnd,EAAOod,iBAAiB,CACtBR,iBAAkB,EAAKzkB,MAAMykB,iBAC7Bpb,kBAAmB0b,EAAS3L,kBAC5BuH,eAAgBoE,EAASC,iBACxBJ,MAAK,SAACM,GACP,IAAM5N,EAAOjM,EAAAA,GAAAA,aAAAA,SAAiC6Z,GAExCzS,EADc7K,EAAAA,SAAAA,eAA4B0P,EAAK6N,MAA7CpQ,QAMH8N,GAAmBpQ,GAQnBsQ,GAA0BtQ,GAO1B0Q,GAAwB1Q,IAQb,IAAIsB,GAAkBtB,GAC9B6B,KAAKxJ,SAAQ,SAAAL,GACnB5E,QAAQ6B,KAAK,YAAD,OAAa+C,EAAIlK,IAAG,MAChC,IAAM4S,EAAW1I,EAAI0I,SACf8O,EAAQ,EAAKjiB,MAAMqH,MAAMib,aAAa,GAC5C,GAAInP,EAASE,sBAAwB4O,EAAMgJ,oBAezC,GALqB,EAAKzI,aAAa4G,aAAahN,MAClD,SAAC2X,GACC,OAAOvS,GAAcuS,EAAUtpB,EACjC,IAYA5E,QAAQ+Y,MAAM,8BAAD,OAA+BnU,EAAIlK,IAAG,WATnD,IAEE,EAAKiiB,aAAa4J,OAAO3hB,EAAK,CAAC,GAC/B,IAAMupB,EAAkB3V,GAAqB5T,GAC7C,EAAK2mB,iBAAiB4C,EAGxB,CAFE,SACAnuB,QAAQU,MAAM,sBAAD,OAAuBkE,EAAIlK,IAAG,KAC7C,MAKFsF,QAAQ+Y,MACN,oBAAanU,EAAIlK,IAAG,gCACDkS,EAAOuS,eAAc,KACxC,sDAGN,IAEAgF,KAhDEnkB,QAAQ+Y,MACN,8BAAuBnM,EAAOuS,eAAc,MAC5C,4DATFnf,QAAQ+Y,MACN,8BAAuBnM,EAAOuS,eAAc,MAC5C,mDAVFnf,QAAQ+Y,MACN,8BAAuBnM,EAAOuS,eAAc,MAA5C,kFA+DN,IAAGY,OAAM,SAACrf,GAER4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,oCAGJkB,QAAQU,MACN,uBAAsB,2BACFwe,EAASC,eAAc,MAAI,qBACjCD,EAAS3L,kBAAiB,MAAI,oBAC/B,EAAKpZ,MAAMykB,iBAAgB,OACxCle,EAEJ,IAMA,EAAKqkB,cAET,GACF,IAAGhF,OAAM,SAACrf,GACRV,QAAQU,MAAMA,GAEd4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,oCAGJslB,EAAO1jB,aAAiBjC,MAAQiC,EAAQ,IAAIjC,MAAMsC,OAAOL,IAC3D,GACF,IAAE,mFACH,kDA1ID,IAqaA,uCAkTA,SAA2BhG,GAAoB,IAAD,OAE5CR,KAAKyiB,aAAa4L,kBAElB,IAAMD,EAAsBpuB,KAAKytB,uBAAuBjtB,GACxDR,KAAKqH,SAAS+mB,GACdpuB,KAAKyiB,aAAa4G,aAAate,SAAQ,SAACL,GACtC,IAAIlC,EAAQ,CAAC,EACb,GAAI4lB,EAAoBrhB,gBAAgBH,IAAIlC,EAAIlK,KAC9CgI,EAAQ,EAAK8b,iBACb,EAAKjd,UAAS,SAAAJ,GACZ,IAAMwF,EAAiBxF,EAAMwF,eAE7B,OADAA,EAAeic,IAAIhe,EAAIlK,KAChB,CAAEiM,eAAAA,EACX,SAEA,GAAI,EAAKxF,MAAMwF,eAAeG,IAAIlC,EAAIlK,KAAM,CAC1C,IAAMsJ,EAAMyX,GAAW7W,GACvBlC,EAAQ,EAAKygB,YAAYnf,EAC3B,CAEF,EAAK2Y,aAAayL,YAAYxjB,EAAIlK,IAAKgI,EACzC,GACF,GAAC,4CAED,WACExI,KAAKqH,SAAS,CACZklB,2BAA2B,GAE/B,GAAC,8BA8HD,WACE2H,SAASC,KAAKC,oBACZ,kCACAp0B,KAAK8rB,YAEPoI,SAASC,KAAKC,oBACZ,yCACAp0B,KAAKmuB,cAEP+F,SAASC,KAAKC,oBACZ,qCACAp0B,KAAKsuB,eAEP4F,SAASC,KAAKC,oBACZ,2CACAp0B,KAAKssB,oBAEP4H,SAASC,KAAKC,oBACZ,qCACAp0B,KAAKktB,eAEPgH,SAASC,KAAKC,oBACZ,oCACAp0B,KAAK6vB,cAEPqE,SAASC,KAAKC,oBACZ,qCACAp0B,KAAK4rB,eAEPsI,SAASC,KAAKC,oBACZ,wCACAp0B,KAAKuuB,kBAEP2F,SAASC,KAAKC,oBACZ,sCACAp0B,KAAKwuB,gBAEP0F,SAASC,KAAKC,oBACZ,8CACAp0B,KAAKyuB,uBAEPyF,SAASC,KAAKC,oBACZ,4CACAp0B,KAAK+uB,qBAEPmF,SAASC,KAAKC,oBACZ,QACAp0B,KAAK+vB,SAEPmE,SAASC,KAAKC,oBACZ,QACAp0B,KAAK8vB,WAEPuE,OAAOD,oBAAoB,SAAUp0B,KAAK6rB,gBAE1C7rB,KAAKyiB,aAAamR,UACM,MAApB5zB,KAAKwiB,aACPxiB,KAAKwiB,YAAYoR,SAUrB,GAAC,kCAiDD,WACE5zB,KAAKyiB,aAAamR,UACM,MAApB5zB,KAAKwiB,aACPxiB,KAAKwiB,YAAYoR,UAEnBS,OAAOD,oBAAoB,eAAgBp0B,KAAKyxB,iBAClD,GAAC,4BAED,WACEyC,SAASC,KAAKG,iBACZ,kCACAt0B,KAAK8rB,YAEPoI,SAASC,KAAKG,iBACZ,qCACAt0B,KAAKsuB,eAEP4F,SAASC,KAAKG,iBACZ,yCACAt0B,KAAKmuB,cAEP+F,SAASC,KAAKG,iBACZ,2CACAt0B,KAAKssB,oBAEP4H,SAASC,KAAKG,iBACZ,qCACAt0B,KAAKktB,eAEPgH,SAASC,KAAKG,iBACZ,oCACAt0B,KAAK6vB,cAEPqE,SAASC,KAAKG,iBACZ,qCACAt0B,KAAK4rB,eAEPsI,SAASC,KAAKG,iBACZ,wCACAt0B,KAAKuuB,kBAEP2F,SAASC,KAAKG,iBACZ,sCACAt0B,KAAKwuB,gBAEP0F,SAASC,KAAKG,iBACZ,sCACAt0B,KAAK8uB,gBAEPoF,SAASC,KAAKG,iBACZ,8CACAt0B,KAAKyuB,uBAEPyF,SAASC,KAAKG,iBACZ,4CACAt0B,KAAK+uB,qBAEPmF,SAASC,KAAKG,iBACZ,4CACAt0B,KAAK6uB,qBAEPqF,SAASC,KAAKG,iBACZ,QACAt0B,KAAK+vB,SAEPmE,SAASC,KAAKG,iBACZ,UACAt0B,KAAK8vB,WAEPuE,OAAOC,iBAAiB,eAAgBt0B,KAAKyxB,kBAC7C4C,OAAOC,iBAAiB,SAAUt0B,KAAK6rB,eACzC,GAAC,+BAED,WAIE,GAHA7rB,KAAKwxB,iBACLxxB,KAAKyrB,qBAEAzrB,KAAKC,MAAMqH,MAAM+d,0BAA2B,CAC/C,IAAIkP,GAAgB,EACdrS,EAAQliB,KAAKC,MAAMqH,MAAMib,aAAa,GAE5C,GAA+B,MADVL,EAAM5I,oBAAoB,GAC9Bkb,YACf,GAAI,wBAAyBtS,EAAMuS,mBAG7B,eADiBvS,EAAMuS,mBAAmBnb,oBAAoB,KAEhEib,GAAgB,QAIpBA,GAAgB,EAEbA,GAEHxvB,EAAAA,GAAAA,QAAgB,4CAEpB,CACF,GAEA,8CAMA,SACE7D,EACAiN,GACO,IAAD,OACNnO,KAAKyjB,eAAe1Y,SAAQ,SAAA2f,GACtBA,EAAQxf,YAAchK,IACxB4E,QAAQ6B,KAAK,qBAAD,OAAsB+iB,EAAQtf,YAAW,MACrD,EAAK/D,SAAS,CACZ2kB,gBAAiBtB,EACjBuB,oBAAqB,KAG3B,GACF,GAEA,mDAOA,SAAuC/qB,EAAeiN,GACpDnO,KAAKqH,SAAS,CAAEqtB,qBAAsBxzB,GACxC,GAEA,mDAIA,SAAuCqJ,GACbA,EAAMsR,OAAOvR,QAEnCtK,KAAKqH,SAAS,CAAEstB,eAAgB,gBAEhC30B,KAAKqH,SAAS,CAAEstB,oBAAgB50B,GAEpC,GAEA,iDAOA,SACEmB,EACAiN,GACO,IAAD,OACA6d,EAAkBhsB,KAAKiH,MAAM+kB,gBACnC,QAAwBjsB,IAApBisB,EAA+B,CACjC,IAAMliB,EAAMsX,GAAU4K,GAChBrrB,EAAOwN,EAAOzN,MACpBV,KAAK0jB,kBAAkB5Z,GAAKiB,SAAQ,SAAA2I,GAEhCA,EAAW/S,KAAKuK,YAAcvK,EAAKuK,WACnCwI,EAAW/S,KAAK2O,yBAA2B3O,EAAK2O,wBAEhDoE,EAAW1G,OAAOjC,SAAQ,SAAA0lB,GACxB,GAAIA,EAAKvlB,YAAchK,EAAO,CAC5B,IAAM0zB,EAAsB,EAAK3tB,MAAMglB,oBAAoBjM,QACzD,SAAC1f,GAAgB,OAAKA,EAAKK,OAAS+S,EAAW/S,IAAI,IAErD,EAAK0G,SAAS,CACZ4kB,oBAAoB,GAAD,gBACd2I,GAAmB,CACtB,CAAEj0B,KAAMA,EAAMO,MAAOuvB,MAG3B,CACF,GAEJ,GACF,CACF,GAEA,iDAIA,WACEzwB,KAAKqH,SAAS,CACZ4kB,oBAAqB,IAEzB,GAAC,wCAED,SAA4B/qB,GAC1B,GAAa,MAATA,EAAe,CACjB,IAAM2zB,EAAIC,OAAO5zB,GACX6zB,EAAQ/0B,KAAKiH,MAAMssB,sBAAsB,GACzCyB,EAAMh1B,KAAKiH,MAAMssB,sBAAsB,GAC7C,GAAIsB,GAAKE,GAASF,GAAKG,EAKrB,YAJAh1B,KAAKqH,SAAS,CACZisB,oBAAqBuB,EACrBzB,4BAA4B,GAIlC,CACApzB,KAAKqH,SAAS,CACZisB,yBAAqBvzB,EACrBqzB,4BAA4B,GAEhC,GAAC,wCAED,SAA4BlyB,GAC1B,GAAa,MAATA,EAAe,CACjB,IAAM+zB,EAAIH,OAAO5zB,GACX6zB,EAAQ/0B,KAAKiH,MAAMwsB,sBAAsB,GACzCuB,EAAMh1B,KAAKiH,MAAMwsB,sBAAsB,GAC7C,GAAIwB,GAAKF,GAASE,GAAKD,EAKrB,YAJAh1B,KAAKqH,SAAS,CACZmsB,oBAAqByB,EACrB5B,4BAA4B,GAIlC,CACArzB,KAAKqH,SAAS,CACZmsB,yBAAqBzzB,EACrBszB,4BAA4B,GAEhC,GAAC,0CAED,SAA8BnyB,GACf,MAATA,GACEA,EAAQ,GAAKA,GAAS,GACxBlB,KAAKqH,SAAS,CACZqsB,sBAAuBoB,OAAO5zB,GAC9BiyB,8BAA8B,IAKpCnzB,KAAKqH,SAAS,CACZqsB,2BAAuB3zB,EACvBozB,8BAA8B,GAElC,GAEA,0CAIA,WACE,GACEnzB,KAAKiH,MAAMmsB,4BACXpzB,KAAKiH,MAAMosB,4BACXrzB,KAAKiH,MAAMksB,8BACuB,MAAlCnzB,KAAKiH,MAAMqsB,qBACuB,MAAlCtzB,KAAKiH,MAAMusB,qBACyB,MAApCxzB,KAAKiH,MAAMysB,sBACX,CACA5tB,QAAQ6B,KACN,yBAAwB,WACpB3H,KAAKiH,MAAMqsB,oBAAmB,MAAI,UACnCtzB,KAAKiH,MAAMusB,oBAAmB,MAAI,aAC/BxzB,KAAKiH,MAAMysB,sBAAqB,oBAWxC,IARA,IAMMwB,EAAqB,IANZl1B,KAAKiH,MAAMysB,sBAOpByB,EAAQ,GACL1rB,EAAI,EAAGA,EAAIzJ,KAAKyiB,aAAa2S,UAAW3rB,IAAK,CACpD,IAAM4rB,EAAqBr1B,KAAKyiB,aAAa6S,gBAAgB7rB,GAAG,GAChE0rB,EAAMjzB,KAAK2V,KAAK0d,IAAIL,EAAqBG,GAC3C,CACA,IAAMG,EAAQL,EAAMM,QAAQ5d,KAAKhI,IAAG,MAARgI,KAAYsd,IACxCn1B,KAAKyiB,aAAapH,SAAS,CACzByC,SAAU,CACR9d,KAAKiH,MAAMqsB,oBACXtzB,KAAKiH,MAAMusB,qBAEbgC,MAAOA,IAET,IAAME,EAAQ,IAAI7tB,EAAAA,SAAAA,MAAmB,CACnC2L,YAAa,CACXxT,KAAKiH,MAAMqsB,oBACXtzB,KAAKiH,MAAMusB,oBACX,GAEFlgB,oBAAqBtT,KAAKyiB,aAAanP,sBAEnC5I,EAAM,IAAI7C,EAAAA,IAAAA,IAAY,CAAEuL,SAAUsiB,IACxC11B,KAAKyiB,aAAa4J,OAAO3hB,EAAK1K,KAAKkkB,iBACnClkB,KAAKqH,UAAS,SAAAJ,GACZ,IAAMwF,EAAiBxF,EAAMwF,eAE7B,OADAA,EAAeic,IAAIhe,EAAIlK,KAChB,CACLiM,eAAAA,EACA8jB,oBAAoB,EAExB,GACF,CACF,GAEA,sDAIA,WACEzqB,QAAQ6vB,IAAI,mCACZ31B,KAAKqH,SAAS,CACZkpB,oBAAoB,EACpB6C,4BAA4B,EAC5BC,4BAA4B,EAC5BF,8BAA8B,EAC9BG,yBAAqBvzB,EACrByzB,yBAAqBzzB,EACrB2zB,2BAAuB3zB,GAE3B,GAEA,qDAGA,WACE+F,QAAQ+Y,MAAM,qCACd,IAAM6L,EAAU1qB,KAAKiH,MAAM+kB,gBACrB4J,EAAe51B,KAAKiH,MAAMytB,qBAC1BmB,EAAS71B,KAAKiH,MAAM0tB,oBACL50B,IAAjB61B,QAA0C71B,IAAZ2qB,GAChC1qB,KAAKyiB,aAAaqT,wBAAwB,CAAEF,aAAAA,EAAcC,OAAAA,IAC1D71B,KAAKqH,SAAS,CACZipB,0BAA0B,EAC1BN,oBAAoB,KAGtB5nB,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,+CAIR,GAEA,uDAGA,WACEkB,QAAQ+Y,MAAM,mCACd7e,KAAKqH,SAAS,CACZipB,0BAA0B,EAC1BN,oBAAoB,GAExB,GAEA,oCAIA,WAAiC,IAAD,OAC9BlqB,QAAQ6B,KAAK,aACb,IAAM6E,EAAOxM,KAAKyiB,aAAa4G,aACzBpQ,EAAejZ,KAAKyiB,aAAaqD,qBACjC9jB,EAAWhC,KAAKyiB,aAAasT,uBACjC9c,EAAa,GAAGrO,YAElB5K,KAAKqH,UAAS,SAAC2uB,GACb,IAAMtjB,EAASujB,GAAe,CAC5BzpB,KAAAA,EACAxK,SAAAA,EACAwc,KAAM,EAAKve,MAAMue,KACjBC,IAAK,EAAKxe,MAAMwe,IAChBhS,eAAgBupB,EAAUvpB,iBAE5B,MAAO,CACL8T,qBAAsB7N,EAAO6N,qBAC7BC,gBAAiB9N,EAAO8N,gBAE5B,GACF,GAEA,sCAKA,WACE1a,QAAQ6B,KAAK,kBAEb,IAAM+K,EAAS1S,KAAKiH,MAAMuZ,gBAC1B,QAAezgB,IAAX2S,EAAsB,CACxB,IAAMsC,EAAUtC,EAChB5M,QAAQ+Y,MAAM,gCACd,IAAMqX,EAAkC,IAAIC,WAAW,GACvDD,EAAgC,GAAK,EACrC,IAAME,EAAW,CAEf,WAAY,CACVC,MAAO,CAACH,EAAgCI,QACxCC,GAAI,MAGN,WAAY,CACVF,MAAO,CAACrhB,EAAQoU,aAChBmN,GAAI,MAGN,WAAY,CACVF,MAAO,CAACrhB,EAAQiQ,gBAChBsR,GAAI,MAGN,WAAY,CACVF,MAAO,CAAC,uBACRE,GAAI,MAGN,WAAY,CACVF,MAAO,CAACr2B,KAAKC,MAAMwe,IAAIje,KACvB+1B,GAAI,OAIRzwB,QAAQ6B,KAAK,sCACb,IAAM6uB,EAAS,IAAIlrB,EAAAA,GAAAA,UAAqB8qB,GACxCI,EAAOpR,KAAO9Z,EAAAA,GAAAA,oBAAAA,oBAAmD0J,GACjE,IAAMshB,EAASE,EAAOC,QACPz2B,KAAKC,MAAM8H,QAAQ/D,EAAe+vB,qBAC1C2C,eAAe,CAAEC,SAAU,CAACL,KAAWzR,MAC5C,SAAC+R,GAAa,OAAK7xB,EAAAA,GAAAA,KAAa,0BAA0B,IAC1D8gB,OAAM,SAACrf,GACPV,QAAQU,MAAMA,GAEd4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,kCAGN,GACF,CACA5E,KAAKqH,SAAS,CACZkZ,sBAAsB,EACtBC,qBAAiBzgB,GAErB,GAEA,sCAGA,WACEC,KAAKqH,SAAS,CACZkZ,sBAAsB,EACtBC,qBAAiBzgB,GAErB,GAEA,8CAIA,YAGU,IAH0B0K,EAAM,EAANA,OAIlC,GAJmD,EAATE,UAI3B,CACb7E,QAAQ6B,KAAK,YAAD,OAAa8C,IACzB,IAAMC,EAAM1K,KAAKyiB,aAAaqL,OAAOrjB,GAC/BX,EAAMyX,GAAW7W,GACjBlC,EAAQxI,KAAKipB,YAAYnf,GAC/B9J,KAAKyiB,aAAayL,YAAYxjB,EAAIlK,IAAKgI,GACvCxI,KAAKqH,UAAS,SAAAJ,GACZ,IAAMwF,EAAiBxF,EAAMwF,eAE7B,OADAA,EAAeic,IAAIhe,EAAIlK,KAChB,CAAEiM,eAAAA,EACX,GACF,MACE3G,QAAQ6B,KAAK,YAAD,OAAa8C,IACzBzK,KAAKqH,UAAS,SAAAJ,GACZ,IAAM8F,EAAkB9F,EAAM8F,gBAC9BA,EAAgBiiB,OAAOvkB,GACvB,IAAMgC,EAAiBxF,EAAMwF,eAE7B,OADAA,EAAeuiB,OAAOvkB,GACf,CAAEgC,eAAAA,EAAgBM,gBAAAA,EAC3B,IACA/M,KAAKyiB,aAAayL,YAAYzjB,EAAQ,CAAC,EAE3C,GAEA,mDAIA,YAGU,IAH+BmD,EAAkB,EAAlBA,mBAAoBjD,EAAS,EAATA,UAK3D,GADA7E,QAAQ6vB,IAAI,yCAAD,OAA0C/nB,IACjDjD,EAAW,CACb7E,QAAQ6B,KAAK,yBAAD,OAA0BiG,IACtC,IACE5N,KAAKyiB,aAAaoU,oBAAoBjpB,EAWxC,CAVE,MAAOpH,GASP,MAPA4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,qCAGE4B,CACR,CACAxG,KAAKqH,UAAS,SAAAJ,GACZ,IAAMqK,EAA6B,IAAI2S,IACrChd,EAAMqK,4BAGR,OADAA,EAA2BoX,IAAI9a,GACxB,CAAE0D,2BAAAA,EACX,GACF,MACExL,QAAQ6B,KAAK,yBAAD,OAA0BiG,IACtC5N,KAAKyiB,aAAaqU,oBAAoBlpB,GACtC5N,KAAKqH,UAAS,SAAAJ,GACZ,IAAMqK,EAA6B,IAAI2S,IACrChd,EAAMqK,4BAGR,OADAA,EAA2B0d,OAAOphB,GAC3B,CAAE0D,2BAAAA,EACX,GAEJ,GAEA,8CAGA,YAOU,IAP0B9Q,EAAG,EAAHA,IAAKuN,EAAY,EAAZA,aAQvCjI,QAAQ6vB,IAAI,oCAAD,OAAqCn1B,IAChD,IACER,KAAKyiB,aAAamI,wBAChBpqB,EACAuN,EAYJ,CAVE,MAAOvH,GASP,MAPA4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,gDAGE4B,CACR,CACF,GAAC,8BAED,SACEuH,GAAyD,IAAD,MAClDL,EAA8B,QAAvB,EAAGK,EAAaL,eAAO,QAx+EL,GAy+EzBqpB,EAAgC,QAArB,EAAGhpB,EAAa9E,aAAK,QAAIiY,GACpC8V,EAAYjpB,EAAa0N,YAAc,CAAC,EAAG,EAAG,EAAG,GAAKsb,EAAY12B,KAAI,SAAC42B,GAAC,OAAKpf,KAAKhI,IAAIonB,EAAI,GAAI,IAAI,IAMxG,OALclV,GAAgB,CAC5BE,KAAM,CAAEhZ,MAAM,GAAD,gBAAM+tB,GAAS,CAAEtpB,KAC9BsU,OAAQ,CAAE/Y,MAAM,GAAD,gBAAM8tB,GAAW,CAAErpB,KAClC0U,OAAmC,QAA7B,EAAEpiB,KAAKkkB,gBAAgBlC,cAAM,aAA3B,EAA6BpY,OAGzC,GAAC,kCAED,YAGU,IAHcpJ,EAAG,EAAHA,IAAKuN,EAAY,EAAZA,aAI3BjI,QAAQ6vB,IAAI,uBAAD,OAAwBn1B,IACnC,IACER,KAAK+b,wBAAwBvb,GAAOuN,EACpC,IAAMvF,EAAQxI,KAAKsxB,iBAAiBvjB,GAE9BrD,EAAM1K,KAAKyiB,aAAaqL,OAAOttB,GAC/BsJ,EAAMyX,GAAW7W,GACvB1K,KAAKmkB,UAAUra,GAAOtB,EACtBxI,KAAKyiB,aAAayL,YAAY1tB,EAAKgI,GACnCxI,KAAKiH,MAAMwF,eAAeic,IAAIloB,EAWhC,CAVE,MAAOgG,GASP,MAPA4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,mCAGE4B,CACR,CACF,GAEA,2CAIA,YAGU,IAHuBiU,EAAU,EAAVA,WAAY9P,EAAS,EAATA,UAI3C7E,QAAQ6vB,IAAI,gCAAD,OAAiClb,IACxC9P,GACF7E,QAAQ6B,KAAK,gBAAD,OAAiB8S,IAC7Bza,KAAKyiB,aAAayU,YAAYzc,GAC9Bza,KAAKqH,UAAS,SAAAJ,GACZ,IAAM4T,EAAqB,IAAIoJ,IAAIhd,EAAM4T,oBAEzC,OADAA,EAAmB6N,IAAIjO,GAChB,CAAEI,mBAAAA,EACX,MAEA/U,QAAQ6B,KAAK,gBAAD,OAAiB8S,IAC7Bza,KAAKyiB,aAAa0U,YAAY1c,GAC9Bza,KAAKqH,UAAS,SAAAJ,GACZ,IAAM4T,EAAqB,IAAIoJ,IAAIhd,EAAM4T,oBAEzC,OADAA,EAAmBmU,OAAOvU,GACnB,CAAEI,mBAAAA,EACX,IAEJ,GAEA,sCAGA,YAKU,IALkBJ,EAAU,EAAVA,WAAY1M,EAAY,EAAZA,aAMtCjI,QAAQ6vB,IAAI,2BAAD,OAA4Blb,IACvCza,KAAKyiB,aAAa2U,gBAAgB3c,EAAY1M,EAChD,GAEA,2CAIA,YAGU,IAHuBmM,EAAU,EAAVA,WAAYvP,EAAS,EAATA,UAI3C7E,QAAQ6vB,IAAI,gCAAD,OAAiCzb,IACxCvP,GACF7E,QAAQ6B,KAAK,gBAAD,OAAiBuS,IAC7Bla,KAAKyiB,aAAa4U,qBAAqBnd,GACvCla,KAAKqH,UAAS,SAAAJ,GACZ,IAAMoT,EAAqB,IAAI4J,IAAIhd,EAAMoT,oBAEzC,OADAA,EAAmBqO,IAAIxO,GAChB,CAAEG,mBAAAA,EACX,MAEAvU,QAAQ6B,KAAK,gBAAD,OAAiBuS,IAC7Bla,KAAKyiB,aAAa6U,qBAAqBpd,GACvCla,KAAKqH,UAAS,SAAAJ,GACZ,IAAMoT,EAAqB,IAAI4J,IAAIhd,EAAMoT,oBAEzC,OADAA,EAAmB2U,OAAO9U,GACnB,CAAEG,mBAAAA,EACX,IAEJ,GAEA,sCAGA,YAKU,IALkBH,EAAU,EAAVA,WAAYnM,EAAY,EAAZA,aAMtCjI,QAAQ6vB,IAAI,2BAAD,OAA4Bzb,IACvCla,KAAKyiB,aAAa8U,yBAAyBrd,EAAYnM,EACzD,GAEA,+CAIA,YAGU,IAH2BsJ,EAAqB,EAArBA,sBAAuB1M,EAAS,EAATA,UAI1D7E,QAAQ6vB,IAAI,qCAAD,OAAsCte,IAC7C1M,GACF7E,QAAQ6B,KAAK,qBAAD,OAAsB0P,IAClCrX,KAAKyiB,aAAagG,gBAAgBpR,GAClCrX,KAAKqH,UAAS,SAAAJ,GACZ,IAAM0S,EAAgC,IAAIsK,IACxChd,EAAM0S,+BAGR,OADAA,EAA8B+O,IAAIrR,GAC3B,CAAEsC,8BAAAA,EACX,MAEA7T,QAAQ6B,KAAK,qBAAD,OAAsB0P,IAClCrX,KAAKyiB,aAAauD,gBAAgB3O,GAClCrX,KAAKqH,UAAS,SAAAJ,GACZ,IAAM0S,EAAgC,IAAIsK,IACxChd,EAAM0S,+BAGR,OADAA,EAA8BqV,OAAO3X,GAC9B,CAAEsC,8BAAAA,EACX,IAEJ,GAEA,0CAGA,YAOU,IAPsBtC,EAAqB,EAArBA,sBAAuBtJ,EAAY,EAAZA,aAQrDjI,QAAQ6vB,IAAI,gCAAD,OAAiCte,IAC5CrX,KAAKyiB,aAAa0D,oBAAoB9O,EAAuBtJ,EAC/D,GAEA,6CAIA,YAGU,IAHyBsJ,EAAqB,EAArBA,sBAAuByB,EAAQ,EAARA,SAIxDhT,QAAQ6vB,IAAI,mCAAD,OAAoCte,IAC3CyB,GACFhT,QAAQ6B,KAAK,yBAAD,OAA0B0P,IACtCrX,KAAKyiB,aAAa+F,oBAAoBnR,GACtCrX,KAAKqH,UAAS,SAAAJ,GACZ,IAAMyS,EAA+B,IAAIuK,IACvChd,EAAMyS,8BAGR,OADAA,EAA6BgP,IAAIrR,GAC1B,CAAEqC,6BAAAA,EACX,MAEA5T,QAAQ6B,KAAK,2BAAD,OAA4B0P,IACxCrX,KAAKyiB,aAAawD,sBAAsB5O,GACxCrX,KAAKqH,UAAS,SAAAJ,GACZ,IAAMyS,EAA+B,IAAIuK,IACvChd,EAAMyS,8BAGR,OADAA,EAA6BsV,OAAO3X,GAC7B,CAAEqC,6BAAAA,EACX,IAEJ,GAEA,yCAIA,WAAsC,IAAD,OAC7BC,EAA6C,IAAIsK,IACjDhL,EAAejZ,KAAKyiB,aAAaqD,qBAkCvC,GAjCA7M,EAAaue,MAAK,SAAC9V,EAAGC,GACpB,OAAiD,IAA7CD,EAAE9W,WAAW6sB,cAAc9V,EAAE/W,YACxB,EAC+C,IAA7C+W,EAAE/W,WAAW6sB,cAAc/V,EAAE9W,aAC9B,EAEH,CACT,IACAqO,EAAalO,SAAQ,SAACzK,GACpB,IAAMsK,EAAatK,EAAKsK,WAClBpC,EAAQ,EAAKia,aAAayD,2BAA2Btb,GAC3D,EAAK6X,aAAa0D,oBAAoBvb,EAAYpC,GAClD,EAAKia,aAAauD,gBAAgBpb,GAClC,EAAK6X,aAAawD,sBAAsBrb,GACpCtK,EAAK0X,gBAKgC,MAAnC1X,EAAKo3B,4BACP/d,EAA8B+O,IAAI9d,GAIpC+O,EAA8B+O,IAAI9d,EAEtC,IAO2C,IAAvC+O,EAA8BpY,KAAY,CAC5C,IAAMo2B,EAAgB,CACpB,CAAC,IAAK,IAAK,MAEb1e,EAAalO,SAAQ,SAACzK,GACpB,IAAMsK,EAAatK,EAAKsK,WACxB,GAAItK,EAAK0X,gBAAiB,CACxB,IAAM4f,EAAaje,EAA8BpY,KACjD,GAAIq2B,EAAaD,EAAcnwB,OAAQ,CACrC,IAAMgB,GAAK,UACN,EAAKia,aAAamN,oBAAoBhlB,IAErCrK,EAAQq3B,EACdpvB,EAAMS,MAAQ0uB,EAAcp3B,GAC5B,IAAMmvB,EAAQ,EAAKzoB,MAAMkoB,oBAAoB7uB,EAAKsK,YACrC,MAAT8kB,IACFlnB,EAAMwF,YAAc,CAAC0hB,EAAM7f,IAAK6f,EAAM5f,MAExC,EAAK2S,aAAa0D,oBAAoB7lB,EAAKsK,WAAYpC,GACvDmR,EAA8B+O,IAAIpoB,EAAKsK,WACzC,CACF,CACF,GACF,CAEA9E,QAAQ6B,KACN,qBAAcgS,EAA8BpY,KAAI,mBAChD,qBAEFoY,EAA8B5O,SAAQ,SAAAH,GACpC,EAAK6X,aAAagG,gBAAgB7d,EACpC,IACA5K,KAAKqH,UAAS,SAAAJ,GAAK,MAAK,CACtByS,6BAA8B,IAAIuK,IAAItK,GACtCA,8BAA+B,IAAIsK,IAAItK,GACxC,GACH,GAEA,0CAIA,WACE3Z,KAAKqH,SAAS,CAAEqe,kCAA8B3lB,IAC9C,IAAM83B,EAAU73B,KAAKC,MAAMkb,SAAS4N,SACpC/oB,KAAKC,MAAMob,SAASwc,GACpB73B,KAAK0rB,6BACP,GAEA,8CAIA,SACExqB,EACAiN,GAIE,IAAImX,EAFN,GAAa,MAATpkB,EAQF,GAPA4E,QAAQ6B,KAAK,uCAAD,OAAwCzG,EAAK,MAEzDlB,KAAKiH,MAAM2e,mBAAmB7a,SAAQ,SAAAia,GAChCA,EAASC,iBAAmB/jB,IAC9BokB,EAAoBN,EAExB,IACyB,MAArBM,EAA2B,CAC7B,IAAIuS,EAAU73B,KAAKC,MAAMkb,SAAS4N,SAClC8O,GAAO,iBAAc32B,GACrBlB,KAAKC,MAAMob,SAASwc,GACpB73B,KAAK2lB,qBAAqBL,EAC5B,MAEEld,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,0CAGJkB,QAAQ6vB,IACN,mDAAkD,mCACtBz0B,EAAK,WAIrClB,KAAKgzB,+BAEPhzB,KAAKqH,SAAS,CAAEqe,6BAA8BxkB,GAChD,GAEA,8BAIA,WACMlB,KAAKiH,MAAM+oB,oBACblqB,QAAQ6B,KAAK,8BACb3H,KAAKyiB,aAAawN,4BAClBjwB,KAAKyiB,aAAaG,0BAA0B,CAAC,GAC7C5iB,KAAKqH,SAAS,CACZipB,0BAA0B,EAC1B/D,2BAA2B,EAC3B6D,wBAAwB,EACxBJ,oBAAoB,EACpBE,yBAAyB,EACzBK,oBAAoB,MAGtBzqB,QAAQ6B,KAAK,4BACb3H,KAAKqH,SAAS,CACZipB,0BAA0B,EAC1B/D,2BAA2B,EAC3ByD,oBAAoB,EACpBE,yBAAyB,EACzBE,wBAAwB,EACxBG,oBAAoB,IAEtBvwB,KAAKyiB,aAAaqV,8BAClB93B,KAAKyiB,aAAasV,4BAClB/3B,KAAKyiB,aAAa4N,iCAClBrwB,KAAKyiB,aAAa0N,8BAEtB,GAEA,mCAIA,WACErqB,QAAQ6B,KAAK,+BACT3H,KAAKyiB,aAAauV,2BACpBh4B,KAAKyiB,aAAa0N,8BAClBnwB,KAAKyiB,aAAasV,4BAClB/3B,KAAKyiB,aAAaG,0BAA0B,CAAC,GAC7C5iB,KAAKqH,SAAS,CACZ+oB,wBAAwB,EACxBJ,oBAAoB,EACpBE,yBAAyB,MAG3BlwB,KAAKqH,SAAS,CACZ6oB,yBAAyB,EACzBF,oBAAoB,EACpBI,wBAAwB,IAE1BpwB,KAAKyiB,aAAawN,4BAClBjwB,KAAKyiB,aAAa4N,iCAClBrwB,KAAKyiB,aAAaqV,8BAClB93B,KAAKyiB,aAAawV,wBAAwB,CAAC,GAC3Cj4B,KAAKyiB,aAAayV,0BAA0B,CAAC,GAEjD,GAEA,kCAIA,WACEpyB,QAAQ6B,KAAK,8BACT3H,KAAKyiB,aAAa0V,8BACpBn4B,KAAKyiB,aAAa4N,iCAClBrwB,KAAKqH,SAAS,CACZ+oB,wBAAwB,EACxBJ,oBAAoB,EACpBE,yBAAyB,MAG3BlwB,KAAKqH,SAAS,CACZ+oB,wBAAwB,EACxBJ,oBAAoB,EACpBE,yBAAyB,IAE3BlwB,KAAKyiB,aAAa0N,8BAClBnwB,KAAKyiB,aAAasV,4BAClB/3B,KAAKyiB,aAAawN,4BAClBjwB,KAAKyiB,aAAaqV,8BAClB93B,KAAKyiB,aAAa2V,6BAA6B,CAAC,GAEpD,GAAC,wBAED,WACEp4B,KAAKyiB,aAAawN,4BAClBjwB,KAAKyiB,aAAa0N,8BAClBnwB,KAAKyiB,aAAasV,4BAClB/3B,KAAKyiB,aAAa4N,iCAClBrwB,KAAKyiB,aAAaqV,8BAClB93B,KAAKqH,SAAS,CACZkpB,oBAAoB,EACpBD,0BAA0B,EAC1B/D,2BAA2B,EAC3BhM,sBAAsB,EACtB6P,wBAAwB,EACxBF,yBAAyB,EACzBF,oBAAoB,GAExB,GAEA,8BAIA,WAA2B,IAAD,OACxBhwB,KAAKyiB,aAAawN,4BAClBjwB,KAAKyiB,aAAasV,4BAClB/3B,KAAKyiB,aAAa4N,iCAClBrwB,KAAKyiB,aAAa0N,8BACdnwB,KAAKiH,MAAM8F,gBAAgBxL,KAAO,GACpCvB,KAAKiH,MAAM8F,gBAAgBhC,SAAQ,SAAAvK,QACrBT,IAARS,GAKJsF,QAAQ6B,KAAK,eAAD,OAAgBnH,EAAG,MAC/B,EAAKiiB,aAAa4V,UAAU73B,GAE5BuE,EAAAA,GAAAA,KAAa,2BANXA,EAAAA,GAAAA,QAAgB,yCAOpB,IACA/E,KAAKqH,SAAS,CACZ0F,gBAAiB,IAAIkX,IACrBmM,wBAAwB,EACxBJ,oBAAoB,EACpBE,yBAAyB,MAG3BlwB,KAAKiH,MAAMwF,eAAe1B,SAAQ,SAAAvK,GAChCsF,QAAQ6B,KAAK,eAAD,OAAgBnH,EAAG,MAC/B,EAAKiiB,aAAa4V,UAAU73B,EAC9B,IACAR,KAAKqH,SAAS,CACZoF,eAAgB,IAAIwX,IACpBmM,wBAAwB,EACxBJ,oBAAoB,EACpBE,yBAAyB,KAG7BlwB,KAAKyiB,aAAaG,0BAA0B,CAAC,EAC/C,GAEA,uCAIA,WAAoC,IAAD,OACjC9c,QAAQ6B,KAAK,6BACR3H,KAAKiH,MAAM0sB,eAcd3zB,KAAKyiB,aAAa6V,WAClBt4B,KAAKyiB,aAAaG,0BAA0B,CAAC,GAC7C5iB,KAAKiH,MAAM8F,gBAAgBhC,SAAQ,SAAAvK,QACrBT,IAARS,GACF,EAAKiiB,aAAayL,YAAY1tB,EAAK,EAAK8jB,iBAE5C,IACAtkB,KAAKqH,SAAS,CAAEssB,eAAe,MApB/B3zB,KAAKyiB,aAAawN,4BAClBjwB,KAAKyiB,aAAasV,4BAClB/3B,KAAKyiB,aAAa4N,iCAClBrwB,KAAKyiB,aAAaqV,8BAClB93B,KAAKyiB,aAAa0N,8BAClBnwB,KAAKyiB,aAAa8V,WAClBv4B,KAAKqH,SAAS,CACZssB,eAAe,EACf3D,oBAAoB,EACpBE,yBAAyB,EACzBE,wBAAwB,IAY9B,GAMA,oBA6BA,WAA4B,IAAD,SACnB5jB,EAAsB,GACtBoO,EAAkC,GAClCR,EAA2C,GAC3ChJ,EAAqD,GAC3D5E,EAAKtK,KAAI,MAATsK,GAAI,QAASxM,KAAKyiB,aAAa4G,eAC/BzO,EAAS1Y,KAAI,MAAb0Y,GAAQ,QAAS5a,KAAKyiB,aAAagH,mBACnCrP,EAASlY,KAAI,MAAbkY,GAAQ,QAASpa,KAAKyiB,aAAakH,4BACnC,IAAM6O,EAAsBx4B,KAAKyiB,aAAa8G,yBACxCkP,EAA8C,OAAnBD,QAAmB,IAAnBA,OAAmB,EAAnBA,EAAqBxY,QAAO,SAACnS,GAAe,OAC3EA,EAAgB6qB,8BAAgC,EAAKz4B,MAAMqJ,iBAAiB,IAE9E8H,EAAiBlP,KAAI,MAArBkP,GAAgB,QAASqnB,IAEzB,IAMI/lB,EAMAimB,EAZEvjB,EAAc5I,EAAKnM,KAAI,SAAAqK,GAAG,OAAI4T,GAAqB5T,EAAI,IAEvDkuB,EAAmB,CACvB,YAAa,gBAAiB,cAAe,uBAIzC5jB,EAAUhV,KAAKiH,MAAMuZ,qBACXzgB,IAAZiV,IACFtC,GAAS,SAAC,GAAM,CAACsC,QAASA,KAIxBxI,EAAKhF,OAAS,IAChBmxB,GACE,SAAC,GAAc,CACbnsB,KAAMA,EACNO,gBAAiB/M,KAAKiH,MAAM8F,gBAC5BN,eAAgBzM,KAAKiH,MAAMwF,eAC3BE,YAAa3M,KAAKizB,0BAClBzoB,mBAAoBxK,KAAKspB,oCAK/B,IAAM7F,EAAiBzjB,KAAKyjB,eAAepjB,KAAI,SAACqqB,EAASnqB,GACvD,OACE,SAAC,YAAa,CAEZW,MAAOwpB,EAAQxf,UAAU,SAExBwf,EAAQtf,kBAHmBrL,IAAtB2qB,EAAQxf,WAAiD,KAAtBwf,EAAQxf,UAAoBwf,EAAQxf,UAAS,kBAAc3K,GAM1G,IAEMs4B,EAAiE,CACrEnD,OAAO,SAAC,YAAa,CAAax0B,MAAM,QAAO,kBAArB,SAC1BihB,QAAQ,SAAC,YAAa,CAAcjhB,MAAM,SAAQ,mBAAvB,UAC3B43B,KAAK,SAAC,YAAa,CAAW53B,MAAM,MAAK,gBAAjB,OACxB63B,SAAS,SAAC,YAAa,CAAe73B,MAAM,UAAS,oBAAzB,WAC5B83B,MAAM,SAAC,YAAa,CAAY93B,MAAM,OAAM,iBAAnB,QACzB+3B,iBACE,SAAC,YAAa,CAAuB/3B,MAAM,kBAAiB,+BAAzC,mBAIrBg4B,cACE,SAAC,YAAa,CAAoBh4B,MAAM,eAAc,4BAAnC,iBAMjBi4B,EAA8C,EAEhD,SAAC,KAAM,CACL3wB,MAAO,CAAE2H,SAAU,KACnBtG,SAAU7J,KAAK8xB,iCAEfsH,0BAAwB,EACxBC,YAAY,iBAAgB,SAE3B5V,GAJG,uBAQJuI,EAAkBhsB,KAAKiH,MAAM+kB,gBACnC,QAAwBjsB,IAApBisB,EAA+B,CACjC,IAAMliB,EAAMsX,GAAU4K,GACtBhsB,KAAK0jB,kBAAkB5Z,GAAKiB,SAAQ,SAAC2I,EAAYnT,GAC/C,IAAMmjB,EAAoBhQ,EAAW1G,OAAO3M,KAAI,SAAAowB,GAC9C,OACE,SAAC,YAAa,CAEZvvB,MAAOuvB,EAAKvlB,UACZxK,MAAOgT,EAAW/S,KAAK,SAEtB8vB,EAAKrlB,kBAJmBrL,IAAnB0wB,EAAKvlB,WAA8C,KAAnBulB,EAAKvlB,UAAoBulB,EAAKvlB,UAAS,qBAAiB3K,GAOpG,IACA44B,EAAyBj3B,MACvB,gCACGwR,EAAW/S,KAAKyK,aACjB,SAAC,KAAM,CACL5C,MAAO,CAAE2H,SAAU,KACnBtG,SAAU,EAAKkoB,oCACf/X,YAAU,EACVsf,QAAS,EAAKtH,oCACdoH,0BAA0B,EAAM,SAE/B1V,OAIT,IACA,IAAMC,EAAsB3jB,KAAK2jB,oBAAoB7Z,GAAKzJ,KAAI,SAAAM,GAC5D,OAAOk4B,EAA2Bl4B,EACpC,IACAw4B,EAAyBj3B,MACvB,qDAEE,SAAC,KAAM,CACLsG,MAAO,CAAE2H,SAAU,KACnBtG,SAAU7J,KAAK4xB,sCAEfyH,YAAY,uBAAsB,SAEjC1V,GAHG,gCAOVwV,EAAyBj3B,MACvB,SAAC,KAAQ,CACPkK,SAAUpM,KAAK6xB,sCAAsC,oBACjD,0BAKV,CAEA,IAAM0H,GACJ,SAAC,YAAY,CAAiBn4B,MAAM,YAAW,UAC7C,SAAC,GAAY,CACXY,SAAUhC,KAAKC,MAAMqH,MAAMib,aAAa,GACxC1L,WAAW,KAHG,aAQd2iB,GACJ,SAAC,YAAY,CAAiBp4B,MAAM,YAAW,UAC7C,SAAC,GAAS,CAACY,SAAUhC,KAAKC,MAAMqH,MAAMib,aAAa,MADnC,aAKdtJ,EAAejZ,KAAKyiB,aAAaqD,qBACvC7M,EAAaue,MAAK,SAAC9V,EAAGC,GACpB,OAAiD,IAA7CD,EAAE9W,WAAW6sB,cAAc9V,EAAE/W,YACxB,EAC+C,IAA7C+W,EAAE/W,WAAW6sB,cAAc/V,EAAE9W,aAC9B,EAEH,CACT,IACA,IAAMmb,EAOF,CAAC,EACC0T,EAEF,CAAC,EACLxgB,EAAalO,SAAQ,SAAAqM,GACnB,IAAMxM,EAAawM,EAAYxM,WACzB5I,EAAW,EAAKygB,aAAasT,uBAAuBnrB,GAC1D6uB,EAAoB7uB,GAAc5I,EAClC,IAAMwG,GAAK,UACN,EAAKia,aAAamN,oBAAoBhlB,IAE3Cmb,EAAkBnb,GAAcpC,CAClC,IACA,IAgBIkxB,EAgDAC,EAkCAC,EAiCAC,EAwCAC,EA3KEC,GACJ,SAAC,YAAY,CAAqB34B,MAAM,gBAAe,UACrD,SAAC,GAAe,CACdY,SAAUy3B,EACVxgB,aAAcA,EACdW,yBAA0BmM,EAC1BpM,8BAA+B3Z,KAAKiH,MAAM0S,8BAC1CD,6BAA8B1Z,KAAKiH,MAAMyS,6BACzCG,8BAA+B7Z,KAAK8pB,kCACpChQ,yBAA0B9Z,KAAK6yB,6BAC/Bha,4BAA6B7Y,KAAK8yB,gCAClCpN,6BAA8B1lB,KAAKiH,MAAMye,gCAV3B,iBAgBpB,GAAI1lB,KAAKiH,MAAM2e,mBAAmBpe,OAAS,EAAG,CAC5C,IAAMwyB,EAA2B,GACjCh6B,KAAKiH,MAAM2e,mBAAmB7a,SAAQ,SAACia,EAAUzkB,GAC/Cy5B,EAAyB93B,MACvB,SAAC,YAAa,CAEZhB,MAAO8jB,EAASC,eAChB1V,0BAA0B,EAC1BhO,KAAK,QAAO,cAEqBxB,IAAhCilB,EAASiV,oBAAoE,KAAhCjV,EAASiV,mBAA4BjV,EAASiV,mBAAqB,iBAL/El6B,IAA5BilB,EAASC,gBAA4D,KAA5BD,EAASC,eAAyBD,EAASC,eAAc,6BAAyB1kB,IAQvI,IACAy5B,EAAyB93B,MACvB,SAAC,YAAa,CAEZhB,WAAOnB,EACPwP,0BAA0B,EAC1BhO,KAAK,QAAO,UAEZ,yBALI,+BAQRm4B,GACE,SAAC,YAAY,CAA2Bt4B,MAAM,sBAAqB,UACjE,UAAC,KAAK,CAAC8K,MAAM,SAAS3K,KAAM,GAAIiH,MAAO,CAAEuR,QAAS,QAAS,WACzD,SAAC,KAAM,CACLvR,MAAO,CAAE2H,SAAU,IAAK+pB,SAAU,KAClCrwB,SAAU7J,KAAK+yB,iCAEf7xB,MAAOlB,KAAKiH,MAAMye,6BAA6B,SAE9CsU,GAHG,wBAKN,SAAC,KAAO,CAAC54B,MAAM,QAAO,UACpB,SAAC,KAAG,CACFD,MAAM,SAACg5B,GAAA,EAAY,IACnBr1B,KAAK,UACLmI,QAASjN,KAAKgzB,qCAdJ,sBAoBtB,CAGA,GAAIpY,EAASpT,OAAS,EAAG,CACvB,IAAMsT,EAIF,CAAC,EACCsf,EAEF,CAAC,EACCxf,EAAW5a,KAAKyiB,aAAagH,iBACnC7O,EAAS7P,SAAQ,SAAA2P,GACfI,EAAqBJ,EAAQla,KAAO,EAAKiiB,aAAa4X,gBACpD3f,EAAQla,KAEV45B,EAAgB1f,EAAQla,KAAO,EAAKiiB,aAAa6X,mBAC/C5f,EAAQla,IAEZ,IACAm5B,GACE,SAAC,YAAY,CAAqBv4B,MAAM,gBAAe,UACrD,SAAC,GAAW,CACVwZ,SAAUA,EACV5Y,SAAUo4B,EACVtf,qBAAsBA,EACtBD,mBAAoB7a,KAAKiH,MAAM4T,mBAC/BE,0BAA2B/a,KAAK0pB,8BAChC1O,qBAAsBhb,KAAK2yB,4BAPb,iBAWpBiG,EAAiB12B,KAAK,gBACxB,CAGA,GAAIkY,EAAS5S,OAAS,EAAG,CACvB,IAAM8S,EAIF,CAAC,EACCigB,EAEF,CAAC,EACLngB,EAASrP,SAAQ,SAAAoP,GACfG,EAAqBH,EAAQ3Z,KAAO,EAAKiiB,aAAa+X,yBACpDrgB,EAAQ3Z,KAEV+5B,EAAgBpgB,EAAQ3Z,KAAO,EAAKiiB,aAAagY,4BAC/CtgB,EAAQ3Z,IAEZ,IACAo5B,GACE,SAAC,YAAY,CAAsBx4B,MAAM,kBAAiB,UACxD,SAAC,GAAW,CACVgZ,SAAUA,EACVpY,SAAUu4B,EACVjgB,qBAAsBA,EACtBD,mBAAoBra,KAAKiH,MAAMoT,mBAC/BE,0BAA2Bva,KAAK6pB,8BAChCrP,qBAAsBxa,KAAK4yB,4BAPb,kBAWpBgG,EAAiB12B,KAAK,kBACxB,CAMA,GAFW,OAAXkT,QAAW,IAAXA,GAAoB,QAAT,EAAXA,EAAarK,eAAO,OAApB,OAAAqK,EAAuBpV,KAAKqxB,iBAAiBhnB,KAAKrK,OAE9CoR,EAAiB5J,OAAS,EAAG,CAC/B,IAAMkzB,EAEF,CAAC,EACCnpB,EAKF,CAAC,EACLH,EAAiBrG,SAAQ,SAAA8C,GACvB0D,EAA6B1D,EAAgBrN,KAAO,EAAKiiB,aAAakY,wBACpE9sB,EAAgBrN,KAElBk6B,EAAwB7sB,EAAgBrN,KAAO,EAAKiiB,aAAamY,2BAC/D/sB,EAAgBrN,IAEpB,IACAq5B,GACE,SAAC,YAAY,CAAyBz4B,MAAM,oBAAmB,UAC7D,SAAC,GAAmB,CAClBgQ,iBAAkBA,EAClBpP,SAAU04B,EACVxsB,uBAAwBlO,KAAKwN,2BAG7B+D,6BAA8BA,EAC9BD,2BAA4BtR,KAAKiH,MAAMqK,2BACvCD,kCAAmCrR,KAAKwpB,sCACxChY,6BAA8BxR,KAAKkyB,oCAVrB,qBAcpB0G,EAAiB12B,KAAK,mBACxB,CAGA,IAAI24B,EAAgB,MACdC,EAAkB,EACtB,SAAC,GAAM,CACLhpB,QAAQ,mBACR3Q,KAAM45B,EAAAA,IACN9tB,QAASjN,KAAK0wB,iBACd7e,WAAY7R,KAAKiH,MAAM+oB,oBACnB,oBAEN,SAAC,GAAM,CACLle,QAAQ,sBACR3Q,KAAM65B,EAAAA,IACN/tB,QAASjN,KAAK2wB,sBACd9e,WAAY7R,KAAKiH,MAAMipB,yBACnB,sBAEN,SAAC,GAAM,CACLpe,QAAQ,yBACR3Q,KAAM85B,EAAAA,IACNhuB,QAASjN,KAAK4wB,qBACd/e,WAAY7R,KAAKiH,MAAMmpB,wBACnB,yBAEN,SAAC,GAAM,CACLte,QAAQ,8BACR7E,QAASjN,KAAK6wB,iBACd1vB,KAAM+5B,EAAAA,KACF,sBAEN,SAAC,GAAM,CACLppB,QAAQ,yBACR3Q,KAAMnB,KAAKiH,MAAM0sB,cAAgBwH,EAAAA,IAAQC,EAAAA,IACzCnuB,QAASjN,KAAK8wB,0BACdjf,WAAY7R,KAAKiH,MAAM0sB,eACnB,iCAEN,SAAC,GAAM,CACL7hB,QAAQ,oBACR3Q,KAAMk6B,EAAAA,IACNpuB,QAASjN,KAAK+wB,wBACV,2BAGFuK,EAAe,EACnB,SAAC,GAAM,CACLxpB,QAAQ,gBACR3Q,KAAMo6B,EAAAA,GACNtuB,QAASjN,KAAKgxB,YACV,gCAGJhxB,KAAKC,MAAMu7B,wBACb1B,GACE,UAAC,KAAG,CAACpqB,QAAQ,QAAO,UACjBorB,EAAgBz6B,KAAI,SAACC,EAAMmJ,GAC1B,OAAO,SAAC,WAAc,UAAUnJ,GAAJmJ,EAC9B,IACC6xB,EAAaj7B,KAAI,SAACC,EAAMmJ,GACvB,OAAO,SAAC,WAAc,UAAUnJ,GAAJmJ,EAC9B,OAGJoxB,EAAgB,QAGlB,IAKIY,EALAC,EAAS,UAMb,GALI17B,KAAKiH,MAAMC,YACbw0B,EAAS,YAImB,MAA1B17B,KAAKiH,MAAM4mB,YAAqB,CAClC,IAAM8N,EAID,CACH,CACEh7B,KAAM,MACNO,MAAOlB,KAAKiH,MAAM4mB,YAAYrtB,MAG5Bo7B,EAGD,CACH,CACEj7B,KAAM,eACNO,MAAOlB,KAAKiH,MAAM4mB,YAAYza,SAASyM,cAGrCgc,EAGD,GACL77B,KAAKiH,MAAM4mB,YAAY/iB,YAAYC,SAAQ,SAAAzK,GACzC,GAAuB,SAAnBA,EAAK+K,UAAsB,CAC7B,IAAMywB,EAAWx7B,EACjBu7B,EAAwB35B,KAAK,CAC3BvB,KAAMm7B,EAAS7wB,wBAAwB,GAAGG,YAC1ClK,MAAO46B,EAAStwB,oBAAoB,GAAGJ,aAE3C,KAAO,CACL,IAAM2wB,EAAWz7B,EACjBu7B,EAAwB35B,KAAK,CAC3BvB,KAAMo7B,EAAS9wB,wBAAwB,GAAGG,YAC1ClK,MAAO66B,EAASrwB,WAEpB,CACF,IACA,IAAMswB,GAMF,CAAC,EACLh8B,KAAKiH,MAAM4mB,YAAYliB,aAAaZ,SAAQ,SAAAzK,GAC1C,IAAIsK,EAAa,UACjB,GAA4B,MAAxBtK,EAAKsS,gBAAyB,CAChC,IAAMqpB,EAAW7pB,GAAuB,CACtC3B,QAASnQ,EAAKsS,gBACdjS,KAAM,IAAI2K,EAAAA,GAAAA,OAAAA,aAA6B,CACrCpK,MAAO,SACPqN,QAAS,wBACTD,iBAAkB,UAGlB2tB,EAASz0B,OAAS,IACpBoD,EACEqxB,EAAS,GAENC,sBAAsB,GACtBC,gCAGT,CACMvxB,KAAcoxB,KAClBA,GAAsCpxB,GAAc,IAEtD,IAAMwxB,EAAoB97B,EAAKuL,sBAAsB,GACrDmwB,GAAsCpxB,GAAY1I,KAAK,CACrDvB,KAAML,EAAK2K,wBAAwB,GAAGG,YACtClK,MAAOk7B,EAAkBtwB,aAAa7B,WACtC+B,KAAMowB,EAAkBnwB,6BAA6B,GAAGb,aAE5D,IACA,IAAMixB,GAAuB,SAC3Bj8B,GAEA,OAAOA,EAAWC,KAAI,SAAAC,GACpB,IAAIY,EAMJ,OAJEA,EADe,MAAbZ,EAAK0L,KACF,UAAM1L,EAAKY,MAAK,aAAKZ,EAAK0L,KAAI,KAE3B1L,EAAKY,OAGb,SAAC,SAAiB,CAEhBR,MAAOJ,EAAKK,KAAK,SAEhBO,GAHIZ,EAAKK,KAMhB,GACF,EACM27B,GAAkBD,GAAqBV,GACvCY,GAAwBF,GAC5BT,GAEIY,GAA4BH,GAChCR,GAEIY,GAA6B,GACnC,IAAK,IAAM7xB,MAAcoxB,GAAuC,CAC9D,IAAMU,GAAeL,GACnBL,GAAsCpxB,KAErB,YAAfA,GACF6xB,GAA2Bv6B,KAAKw6B,IAEhCD,GAA2Bv6B,MACzB,iCACE,SAAC,KAAO,CAACqT,YAAY,OAAOonB,kBAAmB,EAAGC,QAAM,EAACntB,OAAK,WAC3D7E,KAEF8xB,MAIT,CACAjB,GACE,iCACE,SAAC,IAAY,CAAC57B,OAAO,aAAagC,OAAQ,EAAE,SACzCy6B,MAEH,SAAC,KAAO,CAAC/mB,YAAY,OAAOonB,kBAAmB,EAAE,kCAGjD,SAAC,IAAY,CAAC98B,OAAO,aAAagC,OAAQ,EAAE,SACzC06B,MAEH,SAAC,KAAO,CAAChnB,YAAY,OAAOonB,kBAAmB,EAAE,0BAGjD,SAAC,IAAY,CAAC98B,OAAO,aAAagC,OAAQ,EAAE,SACzC26B,MAEH,SAAC,KAAO,CAACjnB,YAAY,OAAOonB,kBAAmB,EAAE,2BAGjD,SAAC,IAAY,CAAC98B,OAAO,aAAagC,OAAQ,EAAE,SACzC46B,OAIT,CAEA,IAAMI,GAAkB78B,KAAKyiB,aAAaqa,iBAAiBt1B,OAAS,IAClE,gBAAKgB,MAAO,CAAEu0B,OAAQ,UAAW,UAC/B,SAAC,KAAQ,CACPzyB,QAAStK,KAAKiH,MAAMkqB,qBACpB/kB,SAAUpM,KAAKkxB,wBAAwB,4BAO7C,OACE,UAAC,IAAM,CAAC1oB,MAAO,CAAEC,OAAQ,QAAUu0B,UAAQ,aACzC,UAAC,YAAc,CAACx0B,MAAO,CAAEC,OAAQ,QAAS,UACvCqxB,GAED,gBACEtxB,MAAO,CACLC,OAAO,eAAD,OAAiBoyB,EAAa,KACpCoC,SAAU,SACVvB,OAAQA,GAEV/yB,IAAK3I,KAAK4jB,qBAGZ,SAAC,KAAK,CACJsZ,KAAMl9B,KAAKiH,MAAMqpB,yBACjBlvB,MAAM,wBACN+7B,KAAMn9B,KAAKiyB,wCACXmL,cAAe,CAAE5tB,gBAA2CzP,IAA/BC,KAAKiH,MAAM+kB,sBAAqEjsB,IAApCC,KAAKiH,MAAMytB,uBACpF2I,SAAUr9B,KAAK2xB,0CACf2L,OAAO,SAAQ,UAEf,SAAC,KAAK,CAACpxB,MAAM,QAAQqE,UAAU,WAAU,SACtC4oB,OAIL,SAAC,KAAK,CACJ+D,KAAMl9B,KAAKiH,MAAMslB,0BACjBnrB,MAAM,eACNi8B,SAAUr9B,KAAK0xB,+BACf6L,cAAY,EACZC,OAAQ,KAAK,UAEb,SAAC,KAAK,CAACtxB,MAAM,QAAQqE,UAAU,WAAU,SACtCkrB,OAIL,SAAC,KAAK,CACJyB,KAAMl9B,KAAKiH,MAAMspB,mBACjBnvB,MAAM,uBACN+7B,KAAMn9B,KAAKuyB,6BACX8K,SAAUr9B,KAAKwyB,yCACf8K,OAAO,SAAQ,UAEf,UAAC,KAAK,CAACpxB,MAAM,QAAQqE,UAAU,WAAU,WACvC,SAAC,KAAW,CACV8oB,YACE,IAAG,UACAr5B,KAAKiH,MAAMssB,sBAAsB,IACpC,KAAI,UACDvzB,KAAKiH,MAAMssB,sBAAsB,IACpC,IAEFkK,OAAO,oBACPrxB,SAAUpM,KAAKoyB,2BACfsL,aAAc19B,KAAKoyB,2BACnBzP,UAAU,EACVgb,WACE39B,KAAKiH,MAAMmsB,4BAEP,SAACwK,GAAA,EAAa,CAACp1B,MAAO,CAAES,MAAO,sBAG/B,SAAC40B,GAAA,EAAY,CAACr1B,MAAO,CAAES,MAAO,wBAItC,SAAC,KAAW,CACVowB,YACE,IAAG,UACAr5B,KAAKiH,MAAMwsB,sBAAsB,IACpC,KAAI,UACDzzB,KAAKiH,MAAMwsB,sBAAsB,IACpC,IAEFgK,OAAO,oBACPrxB,SAAUpM,KAAKqyB,2BACfqL,aAAc19B,KAAKqyB,2BACnB1P,UAAU,EACVgb,WACE39B,KAAKiH,MAAMosB,4BAEP,SAACuK,GAAA,EAAa,CAACp1B,MAAO,CAAES,MAAO,sBAG/B,SAAC40B,GAAA,EAAY,CAACr1B,MAAO,CAAES,MAAO,wBAItC,SAAC,KAAW,CACVowB,YAAY,WACZoE,OAAO,gBACPrxB,SAAUpM,KAAKsyB,6BACfoL,aAAc19B,KAAKsyB,6BACnB3P,UAAU,EACVgb,WACE39B,KAAKiH,MAAMksB,8BAEP,SAACyK,GAAA,EAAa,CAACp1B,MAAO,CAAES,MAAO,sBAG/B,SAAC40B,GAAA,EAAY,CAACr1B,MAAO,CAAES,MAAO,6BAO1C,SAAC,KAAK,CACJi0B,KAAMl9B,KAAKiH,MAAMsZ,qBACjBnf,MAAM,yBACN+7B,KAAMn9B,KAAKyyB,yBACX4K,SAAUr9B,KAAK0yB,yBACf4K,OAAO,OAAM,SAEZ5qB,QAIL,SAAC,UAAY,CACX9I,MAAO,IACPk0B,cAAY,EACZt1B,MAAO,CACLu1B,WAAY,QACZC,gBAAiB,IACjBf,SAAU,SACVgB,WAAY,QACZ,UAEF,UAAC,IAAI,CACH/zB,KAAK,SACLg0B,gBAAiBtF,EACjBpwB,MAAO,CAAEC,OAAQ,QACjB0B,aAAc,GACdg0B,oBAAkB,EAClBC,aAAc,WAEZC,YAAW,WACe,MAApB,EAAK7b,aACP,EAAKA,YAAYja,QAErB,GAAG,IACL,EAAE,UAEgC,MAAjCvI,KAAK6jB,iBAAiBpc,UACrB,SAAC,YAAY,CAAarG,MAAM,cAAa,UAC3C,SAAC,SAAS,CAACoH,MAAO,CAAEC,OAAQ,QAAS,UACnC,gBACED,MAAO,CAAEC,OAAQ,SACjBE,IAAK3I,KAAK6jB,oBAH4B,UAD1B,SASnB0V,EACAsD,GACArD,EACAO,EACAL,GACD,SAAC,YAAY,CAAmBt4B,MAAM,cAAa,SAChDu3B,GADe,eAGjBkB,EACuB,IAAvBzkB,EAAY5N,QAET,yBAGA,SAAC,YAAY,CAEXpG,MAAM,wBAAuB,UAE7B,SAAC,GAAsB,CACrBgU,YAAaA,EACbhJ,SAAUpM,KAAKspB,iCACfxN,sBAAuB9b,KAAKiH,MAAMwF,eAClCqB,cAAe9N,KAAKmyB,qBACpBpW,wBAAyB/b,KAAK+b,2BAR5B,yBAYT4d,EACAC,OAGJ55B,KAAKiH,MAAMqmB,4BACZttB,KAAKiH,MAAMylB,qBAAqBllB,OAAS,GAErC,SAAC,GAAiB,CAChBoW,UAAW5d,KAAKiH,MAAMsmB,mBACtB1P,UAAW7d,KAAKiH,MAAMumB,mBACtBhhB,KAAMxM,KAAKiH,MAAMylB,wBAInB,0BAIV,KAAC,EA35Gc,CAAS3qB,EAAAA,WA85G1B,SAAekZ,GAAWuI,ICl1HiB,IAEtC8a,IAAY,SAAZA,GAAAA,EAAY,gBAAZA,EAAY,cAAZA,EAAY,oBAAZA,EAAY,uBAAZA,KAAAA,GAAY,KAOjB,IAAMC,GAAiB,SACrBrc,EACAsc,GAEA,OAAOtc,EAAMuc,UAAU,KAAOD,CAChC,EAEME,GAAqB,SACzBxc,EACAxD,GAEA,OAA4B,MAAxBwD,EAAMyc,gBACDzc,EAAMyc,iBAAmBjgB,EAASigB,cAG7C,EAoBMC,IAAK,QAkBT,WACEC,GACC,IAAD,4BAnBO93B,iBAAW,OACX+3B,oBAAc,OACdxrB,yBAAmB,OACnB5K,yBAAmB,OACnBS,wBAAkB,OAClB41B,4BAAsB,OACtBC,YAAwB,GAAE,KAC1B3Z,+BAAyB,OACzB9C,kBAAY,OACZM,iBAAW,OACXtb,oBAAc,EAUS,IAA1Bs3B,EAAQzlB,OAAO5R,QACjBY,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,wDAKN,IAAMuE,EAAqB,IAAI8a,IAAI,IAC7Bgb,EAAkB,IAAIhb,IAAI,IAC1B8a,EAAyB,IAAI9a,IAAI,IACjCib,EAAuB,IAAIjb,IAAI,IAC/Bkb,EAAuB,CAC3BC,OAAQ,IAAInb,IAAI,IAChBob,MAAO,IAAIpb,IAAI,IACfqb,SAAU,IAAIrb,IAAI,KAEd+a,EAEF,CACFI,OAAQ,CAAC,GAEL7c,EAA2D,GAC3DM,EAA0D,GAC1Dtb,EAA6D,GA0CnE,GAzCAs3B,EAAQzlB,OAAOrO,SAAQ,SAACmX,GAStB,GARAgd,EAAqBxW,IAAIxG,EAAMta,qBAC/BuB,EAAmBuf,IAAIxG,EAAM7I,mBAC7B6I,EAAM5I,oBAAoBvO,SAAQ,SAAAzK,GAChCy+B,EAAuBrW,IAAIpoB,EAAKkZ,sBAClC,IAC4B,MAAxB0I,EAAMyc,gBACRM,EAAgBvW,IAAIxG,EAAMyc,gBAExBJ,GAAerc,EAAOoc,GAAac,QAAS,CAE9C,GADAD,EAAqBC,OAAO1W,IAAIxG,EAAMgJ,qBACb,OAArBhJ,EAAMqd,iBAA4Cx/B,IAArBmiB,EAAMqd,WACrC,cAAyB/hB,OAAOC,KAAKshB,GAAuB,eAAE,CAAzD,IAAMn0B,EAAU,KACnBo0B,EAAYI,OAAOx0B,GAAY8d,IAAIxG,EAAMqd,WAC3C,CAEFhd,EAAargB,KAAKggB,EACpB,MAAO,GAAIqc,GAAerc,EAAOoc,GAAakB,WAAY,CAMxD,IAL4BX,EAAQzlB,OAAOiD,MAAK,SAAAojB,GAAG,OACjDlB,GAAekB,EAAKnB,GAAac,SACjCK,EAAIvU,sBAAwBhJ,EAAMgJ,qBAClCuU,EAAInmB,oBAAoB4C,OAAM,SAAAwjB,GAAG,OAAIA,EAAIlmB,wBAA0B0I,EAAM5I,oBAAoB,GAAGE,qBAAqB,GAAC,IAE9F,CAExB,GADA2lB,EAAqBC,OAAO1W,IAAIxG,EAAMgJ,qBACb,OAArBhJ,EAAMqd,iBAA4Cx/B,IAArBmiB,EAAMqd,WACrC,cAAyB/hB,OAAOC,KAAKshB,GAAuB,eAAE,CAAzD,IAAMn0B,EAAU,KACnBo0B,EAAYI,OAAOx0B,GAAY8d,IAAIxG,EAAMqd,WAC3C,CAEFhd,EAAargB,KAAKggB,EACpB,CACF,MAAWqc,GAAerc,EAAOoc,GAAae,QAC5CF,EAAqBE,MAAM3W,IAAIxG,EAAMgJ,qBACrCrI,EAAY3gB,KAAKggB,IACRqc,GAAerc,EAAOoc,GAAagB,YAC5CH,EAAqBG,SAAS5W,IAAIxG,EAAMgJ,qBACxC3jB,EAAerF,KAAKggB,GAExB,IAE4B,IAAxBK,EAAa/a,OACfY,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,gEAGC,CACDq6B,EAAgB19B,KAAO,GACzB6G,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,iFAMN,IAAM+6B,EAAkB,IAAI1b,IAAI,IAChC1B,EAAaxX,SAAQ,SAACmX,GACpByd,EAAgBjX,IAAIxG,EAAM0d,gBAC5B,IACID,EAAgBp+B,KAAO,GACzB6G,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,iFAMiB2d,EAAavC,QAAO,SAAAkC,GACzC,MAA8B,cAAvBA,EAAMuc,UAAU,EACzB,IACmBj3B,OAASu3B,EAAuBx9B,MACjDuE,QAAQD,KACN,oHAIN,CAEA7F,KAAKuiB,aAAeA,EACpBviB,KAAK6iB,YAAcA,EACnB7iB,KAAKuH,eAAiBA,EAEtBvH,KAAKmJ,oBAAkB,QAAOA,GAC9BnJ,KAAK++B,wBAAsB,QAAOA,GAEA,IAA9BG,EAAqB39B,MACvB6G,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,mEAIN5E,KAAK0I,qBAAsB,QAAIw2B,GAAsB,GAEZ,IAArCC,EAAqBC,OAAO79B,MAC9B6G,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,4EAKN5E,KAAKsT,qBAAsB,QAAI6rB,EAAqBC,QAAQ,GAE5D,IAAIS,GAAoB,EACpBriB,OAAOC,KAAKuhB,EAAYI,QAAQ53B,OAAS,IAC3Cq4B,GAAoB,GAEtB7/B,KAAK++B,uBAAuBh0B,SAAQ,SAAAH,GACI,MAAlCo0B,EAAYI,OAAOx0B,GACjBo0B,EAAYI,OAAOx0B,GAAYrJ,KAAO,EACxC6G,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,8CAAuCgG,EAAU,KACjD,uDAG6C,IAAxCo0B,EAAYI,OAAOx0B,GAAYrJ,KACxC,EAAKy9B,YAAY98B,MAAK,QAAI88B,EAAYI,OAAOx0B,IAAa,IAE1DxC,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,8CAAuCgG,EAAU,MAAjD,+EAOFi1B,GACFz3B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,8CAAuCgG,EAAU,MAAjD,8EAOV,IAEIq0B,EAAgB19B,KAAO,EACzB6G,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,0GAI8B,IAAzBq6B,EAAgB19B,KACzBvB,KAAK8+B,gBAAiB,QAAIG,GAAiB,GAE3Cj/B,KAAK8+B,eAAiB,KAGxB9+B,KAAKqlB,0BACsC,IAAzCrlB,KAAKuiB,aAAa,GAAGqd,iBAC8B,gBAAnD5/B,KAAKuiB,aAAa,GAAGud,0BAGvB9/B,KAAK+G,iBACqBhH,IAAxB8+B,EAAQ93B,YAA4B83B,EAAQ93B,YAAc,EAE9D,IAUIg5B,GAAe,SACnB3mB,GAEA,IAAM4mB,EAAwC,GAC9C5mB,EAAOrO,SAAQ,SAACuf,GACd,GAAIA,EAAO9iB,OAAS,EAAG,CACrB,IAAM+a,EAAe+H,EAAOtK,QAAO,SAACkC,GAClC,OACEqc,GAAerc,EAAOoc,GAAac,SACnCb,GAAerc,EAAOoc,GAAakB,UAEvC,IACA,GAAIjd,EAAa/a,OAAS,EAAG,CAC3B,IAWIy4B,EAXEvhB,EAAW6D,EAAa,GACxB2d,EAAuB3d,EAAavC,QAAO,SAACkC,GAChD,OAAOxD,EAASkhB,kBAAoB1d,EAAM0d,eAC5C,IACMO,EAAqBH,EAAcpxB,WAAU,SAACtH,GAClD,OA4EV,SACEA,EACA4a,GAEA,GACE5a,EAAMgM,sBAAwB4O,EAAMgJ,qBACpC5jB,EAAMoB,sBAAwBwZ,EAAMta,qBACpCN,EAAMw3B,iBAAmB5c,EAAMyc,eAE/B,OAAO,EAET,OAAO,CACT,CAxFiByB,CAAwB94B,EAAOoX,EACxC,IAEMmE,EAAcyH,EAAOtK,QAAO,SAACkC,GACjC,OAAOqc,GAAerc,EAAOoc,GAAae,MAC5C,IAGEY,EADEpd,EAAYrb,OAAS,EACDqb,EAAY7C,QAAO,SAACkC,GACxC,OAAOwc,GAAmBxc,EAAOxD,EACnC,IAEsBmE,EAExB,IAGIwd,EAHE94B,EAAiB+iB,EAAOtK,QAAO,SAACkC,GACpC,OAAOqc,GAAerc,EAAOoc,GAAagB,SAC5C,IAUA,GAPEe,EADE94B,EAAeC,OAAS,EACDD,EAAeyY,QAAO,SAACkC,GAC9C,OAAOwc,GAAmBxc,EAAOxD,EACnC,IAEyBnX,GAGC,IAAxB44B,EAA2B,CAC7B,IAAMG,EAA0C,CAC9CxB,eAAgBpgB,EAASigB,eACzBrrB,oBAAqBoL,EAASwM,oBAC9BxiB,oBAAqBgW,EAAS9W,oBAC9B2a,aAAc2d,EACdrd,YAAaod,EACb14B,eAAgB84B,GAElBL,EAAc99B,KAAKo+B,EACrB,KAAO,CAAC,IAAD,MACCA,EAAoBN,EAAcG,IACxC,EAAAG,EAAkB/d,cAAargB,KAAI,iBAAIg+B,KACvC,EAAAI,EAAkBzd,aAAY3gB,KAAI,iBAAI+9B,KACtC,EAAAK,EAAkB/4B,gBAAerF,KAAI,iBAAIm+B,GAC3C,CACF,CACF,CACF,IAEA,IAAIE,EAAkBP,EAAc3/B,KAAI,SAACC,GACvC,OAAO,IAAIs+B,GAAM,CACfxlB,OAAO,GAAD,gBACD9Y,EAAKiiB,eAAY,QACjBjiB,EAAKuiB,cAAW,QAChBviB,EAAKiH,kBAGd,IAWA,OAVAg5B,EAASA,EAAO/I,MAAK,SAAC9V,EAAGC,GACvB,IAAM6e,EAAO9e,EAAEa,aAAa,GACtBke,EAAO9e,EAAEY,aAAa,GAC5B,OAAgC,MAA5Bie,EAAK54B,qBAA2D,MAA5B64B,EAAK74B,oBACpCktB,OAAO0L,EAAK54B,qBAAuBktB,OAAO2L,EAAK74B,qBAE/C,CAEX,GAGF,ECpWO,IAAM84B,GAAkB,yCAAG,0GAUwC,OATxE34B,EAAO,EAAPA,QACA2c,EAAgB,EAAhBA,iBACAic,EAAS,EAATA,UACAC,EAAO,EAAPA,QAAO,SAGCxnB,EAAuD,GAC7DtT,QAAQ6B,KAAK,+BAAD,OAAgC+c,EAAgB,SAEtD5c,EAASC,EAAQ/D,EAAegE,iCAAgC,SAC1CF,EAAOsiB,gBAAgB,CACjDzF,YAAa,CACXC,SAAU,KACVic,iBAAkBnc,KAEpB,OALiB,OAAb2F,EAAa,iBAObL,QAAQ8W,IACZzW,EAAchqB,IAAG,yCAAC,WAAOuG,GAAC,oFAKvB,OALuB,EACJiB,EAAAA,SAAAA,eAA4BjB,GAAxCoO,EAAO,EAAPA,QACF+rB,EAAgB/rB,EACtBlP,QAAQ6B,KAAK,gCAAD,OACsBo5B,EAAc1nB,kBAAiB,MAChE,SAC+BvR,EAAOyiB,uBAAuB,CAC5D7F,iBAAkBA,EAClBpb,kBAAmBy3B,EAAc1nB,oBACjC,OAHImR,EAAiB,OAKjBwW,EAA2D,GACjExW,EAAkBzf,SAAQ,SAACzK,GAAU,IAAD,IAClC,IACkB,QAAhB,EAAAA,EAAK,mBAAW,OAAO,QAAP,EAAhB,EAAkB+1B,aAAK,WAAP,EAAhB,EAA0B,MAC1BryB,EAAegE,gCACf,CACA,IAAMka,EAAQ,IAAIra,EAAAA,SAAAA,4BAAyC,CACzD7F,SAAU1B,IAEZ0gC,EAAa9+B,KAAKggB,EACpB,CACF,IAEI8e,EAAax5B,OAAS,GACxB4R,EAAOlX,KAAK8+B,GACb,2CACF,mDA3BgB,KA4BlB,QACKC,EAAYlB,GAAa3mB,GAC/BunB,EAAUM,GAAU,kDAEpBn7B,QAAQU,MAAM,EAAD,IACP06B,EAAc,IAAIr8B,EACtBD,EACA,qDAEFg8B,EAAQM,GACR94B,GAAAA,QACElD,EACAg8B,GACD,0DAEJ,gBA9D8B,sCCAzBC,GAAc,IAAIC,IAClBC,GAAkB,IAAID,IASfE,GAAY,SAAH,GAAwE,IAAlEv5B,EAAO,EAAPA,QAAS2c,EAAgB,EAAhBA,iBACnC,GAA4B6c,EAAAA,EAAAA,UAAkB,IAAG,eAA1ChB,EAAM,KAAEiB,EAAS,KACxB,GAAkCD,EAAAA,EAAAA,WAAkB,GAAM,eAAnDr6B,EAAS,KAAEu6B,EAAY,KAC9B,GAA0BF,EAAAA,EAAAA,UAAuB,MAAK,eAA/C/6B,EAAK,KAAEk7B,EAAQ,KA0DtB,OAxDAC,EAAAA,EAAAA,YAAU,WACR,QAAyB5hC,IAArB2kB,EAGF,OAFA8c,EAAU,SACVC,GAAa,GAIf,IAAMG,EAAaT,GAAYU,IAAInd,GACnC,QAAmB3kB,IAAf6hC,EAGF,OAFAJ,EAAUI,QACVH,GAAa,GAIfA,GAAa,GAEb,IAAMK,EAAW,yCAAG,2FAsBjB,YAlBsB/hC,KAFnBgiC,EAAiBV,GAAgBQ,IAAInd,MAIvCqd,EAAiB,IAAI/X,SAAQ,SAACC,EAASC,GACrCwW,GAAmB,CACjB34B,QAAAA,EACA2c,iBAAAA,EACAic,UAAW,SAACM,GACVE,GAAYrY,IAAIpE,EAAkBuc,GAClChX,EAAQgX,EACV,EACAL,QAAS,SAACoB,GACR9X,EAAO8X,EACT,IACCnc,OAAM,SAACmc,GACR9X,EAAO8X,EACT,GACF,IACAX,GAAgBvY,IAAIpE,EAAkBqd,IACvC,kBAGyBA,EAAc,OAAhCd,EAAS,OACfO,EAAUP,GACVS,EAAS,MAAK,kDAEdA,EAAS,EAAD,IACRF,EAAU,IAAG,QAGM,OAHN,UAEbH,GAAgBrS,OAAOtK,GACvB+c,GAAa,GAAM,6EAEtB,kBAnCgB,mCAqCZK,GACP,GAAG,CAAC/5B,EAAS2c,IAEN,CAAE6b,OAAAA,EAAQr5B,UAAAA,EAAWV,MAAAA,EAC9B,ECtEQy7B,GAAsB32B,EAAAA,GAAAA,oBAAAA,kBA2BxB42B,GAAkB,SAAC3B,EAAiBj3B,GACxC,OAAOi3B,EAAO55B,MAAK,SAACW,GAClB,OAAOA,EAAM6B,mBAAmBxC,MAAK,SAACnG,GACpC,OAAOA,IAAQ8I,CACjB,GACF,GACF,EAEA,SAAS64B,GAAuB,GAqBR,IApBtBp6B,EAAO,EAAPA,QACAw4B,EAAM,EAANA,OACA/hB,EAAI,EAAJA,KACAC,EAAG,EAAHA,IACA6D,EAAO,EAAPA,QACAkZ,EAAqB,EAArBA,sBACApmB,EAAW,EAAXA,YAeA,GAA0DoG,EAAAA,EAAAA,MAAoE,IAAtHkJ,iBAAAA,OAAgB,MAAG,GAAE,MAAEpb,kBAAAA,OAAiB,MAAG,GAAE,EAC/C6R,GAAWC,EAAAA,EAAAA,MAEjB,GAA0CmmB,EAAAA,EAAAA,UAASW,GAAgB3B,EAAQj3B,IAAmB,eAAvF84B,EAAa,KAAEC,EAAgB,KACtC,GAA4Cd,EAAAA,EAAAA,UAAqC,MAAK,eAA/EpY,EAAc,KAAEmZ,EAAiB,MAExCX,EAAAA,EAAAA,YAAU,WACR,IAAMY,EAAcL,GAAgB3B,EAAQj3B,GACxB,OAAhBi5B,GACFF,EAAiBE,EAErB,GAAG,CAACj5B,EAAmBi3B,KAEvBoB,EAAAA,EAAAA,YAAU,WACR,IAAMa,EAAmB,yCAAG,8FAAqD,OAA5Cz6B,EAAO,EAAPA,QAAS2c,EAAgB,EAAhBA,iBAAkBpb,EAAiB,EAAjBA,kBAAiB,SAI9B,IAAI0gB,SAAsC,SAACC,EAASC,GACrG,IACE,IAAMuY,EAAajlB,OAAOxQ,OAAOhJ,GAAgB3D,KAAI,SAACqiC,GAAY,OAAK36B,EAAQ26B,EAAa,IAC5F1Y,QAAQ8W,IAAI2B,EAAWpiC,IAAG,yCAAC,WAAOyH,GAAM,wHACTA,EAAOyiB,uBAAuB,CACzD7F,iBAAkBA,EAClBpb,kBAAmBA,IACnB,OAHIq5B,EAAc,SAIgBA,EAAetiC,KAAI,SAAC2B,GAAQ,OAAKigC,GAAkBjgC,EAAS,IAAC,eAEvC,OAFnD4gC,EAAyB,MAEFC,2BACtBnK,EAA8BkK,EAA0BC,yBAAyB,GAAGxpB,kBACpFypB,EAAkBvC,EAAO55B,MAAK,SAACW,GACnC,OAAOA,EAAM6B,mBAAmBxC,MAAK,SAACnG,GACpC,OAAOA,IAAQk4B,CACjB,GACF,IACAzO,EAAQ,CAAE3iB,MAAOw7B,EAAiB9gC,SAAU4gC,KAGN,SAIsD,OAA7E,QAHXG,EAAwD,QAA5C,EAAGH,EAA0BhwB,uBAAe,aAAzC,EAA2CjM,MAC9D,SAAAq8B,GAAW,MAF2B,WAEvBA,EAAY/3B,wBAAwB,GAAGC,SAA6C,WAEpF,IAAZ63B,GAA6B,QAAjB,EAAZA,EAAcnwB,uBAAe,OAAK,QAAL,EAA7B,EAAgC,UAAE,OAAiB,QAAjB,EAAlC,EAAoCA,uBAAe,OAAK,QAAL,EAAnD,EAAsD,UAAE,OAAuB,QAAvB,EAAxD,EAA0DspB,6BAAqB,WAAnE,EAAZ,EAAkF,MAC/E+G,EAA2BF,EAAanwB,gBAAgB,GAAGA,gBAAgB,GAAGspB,sBAAsB,GAAGzV,yBACvGqc,EAAkBvC,EAAO55B,MAAK,SAACW,GACnC,OAAOA,EAAMib,aAAa5b,MAAK,SAACub,GAC9B,OAAOA,EAAM+C,iBAAmBge,CAClC,GACF,IACAhZ,EAAQ,CAAE3iB,MAAOw7B,EAAiB9gC,SAAU4gC,KAC7C,2CACF,mDA9ByB,KA8BtB/c,MAAMqE,EAGZ,CAFE,MAAO1jB,GACP0jB,EAAO1jB,EACT,CACF,IAAE,mGAzCuB,sCA2CH,OAAlB47B,QAA4CriC,IAAlBqiC,GACvBI,EAAoB,CAAEz6B,QAAAA,EAAS2c,iBAAAA,EAAkBpb,kBAAAA,IAAqBub,MAAK,SAACtG,GAChE,OAAXA,IACF8jB,EAAiB9jB,EAAOjX,OACxBg7B,EAAkB/jB,EAAOvc,UAE7B,IAAG6jB,OAAM,SAAArf,GACPV,QAAQU,MAAM,kCAAmCA,EACnD,GAEJ,GAAG,CAAC+5B,EAAQx4B,EAASq6B,EAAe1d,EAAkBpb,IAEtD,IACI45B,EADEva,EAAe,IAAIC,gBAAgBzN,EAAS0N,QAE7CF,EAAa/b,IAAI,iBAES,QAD7Bs2B,EAAuBva,EAAakZ,IAAI,YAEtCqB,OAAuBnjC,GAI3B,IAAIojC,EAAS,KAkBb,OAjBqB,MAAjBf,IACFe,GACE,SAAC,GAAW,CACVp7B,QAASA,EACT2c,iBAAkBA,EAClBpb,kBAAmBA,EACnBoc,6BAA8Bwd,EAC9B57B,MAAO86B,EACP9f,QAASA,EACTlN,YAAaA,EACbomB,sBAAuBA,EACvB/c,IAAKA,EACLD,KAAMA,EACN2K,eAAgBA,KAIfga,CACT,CA8IA,SAAeloB,IA1Hf,SAAiBhb,GACf,IAAQ8H,EAAkD9H,EAAlD8H,QAAS2c,EAAyCzkB,EAAzCykB,iBAAkBvJ,EAAuBlb,EAAvBkb,SAAUE,EAAapb,EAAbob,SAC7C,EAA8BimB,GAAU,CAAEv5B,QAAAA,EAAS2c,iBAAAA,IAA3C6b,EAAM,EAANA,OA4BR,GA5ByB,EAATr5B,UA6Bd,OAAO,KAGT,GAAsB,IAAlBq5B,EAAO/4B,OACT,OAAO,KAGT,IACM47B,EADa7C,EAAO,GACShe,aACnC,GAA+B,IAA3B6gB,EAAgB57B,OAClB,OAAO,KAET,IAMI4B,EAQAi6B,EAdE3kB,EAAW0kB,EAAgB,GAOjC,GAAIjoB,EAAS4N,SAAS7iB,SAAS,WAAY,CACzC,IAAMo9B,EAAiBnoB,EAAS4N,SAAStmB,MAAM,WAAW,GAC1D2G,EAA4Bk6B,EAAep9B,SAAS,KAAOo9B,EAAe7gC,MAAM,KAAK,GAAK6gC,CAC5F,MACEl6B,EAA4Bg6B,EAAgB,GAAG/pB,kBAYjD,OARyC,MAArCqF,EAASzc,2BACXohC,GACE,SAAC,YAAY,CAAsBjiC,MAAM,iBAAgB,UACvD,SAAC,EAAa,CAACY,SAAU0c,KADT,oBAOpB,UAAC,IAAM,CAAClW,MAAO,CAAEC,OAAQ,QAAUu0B,UAAQ,aACzC,SAAC,UAAY,CACXpzB,MAAO,IACPpB,MAAO,CACLC,OAAQ,OACR86B,YAAa,QACbC,iBAAkB,IAClBvG,SAAU,SACVgB,WAAY,QACZ,UAEF,UAAC,IAAI,CACH/zB,KAAK,SACLg0B,gBAAiB,CAAC,UAAW,QAAS,iBAAkB,UACxD11B,MAAO,CAAEC,OAAQ,QACjB0B,aAAc,GAAG,WAEjB,SAAC,YAAY,CAAe/I,MAAM,UAAS,UACzC,SAAC,EAAO,CAACY,SAAU0c,KADH,YAGlB,SAAC,YAAY,CAAatd,MAAM,QAAO,UACrC,SAAC,EAAK,CAACY,SAAU0c,KADD,SAGjB2kB,GACD,SAAC,YAAY,CAAcjiC,MAAM,SAAQ,UACvC,SAAC,GAAS,CACR2G,QAAS9H,EAAM8H,QACf/F,SAAUu+B,EACVn3B,0BAA2BA,EAC3BC,kBA5FkB,SAAH,GAAoE,IAA9DC,EAAiB,EAAjBA,kBAC/BxD,QAAQ6B,KAAK,qBAAD,OAAsB2B,EAAiB,MACnD,IAAIuuB,EACF,mBAAYnT,GAAgB,kBACjBpb,GAGT6R,EAAS4N,SAAS7iB,SAAS,gBAC7B2xB,EAAU1c,EAAS4N,SACd5N,EAAS4N,SAAS7iB,SAAS,YAG9B2xB,EAAUA,EAAQ7O,QAAQ,kBAAkB,WAAD,OAAa1f,IAFxDuuB,GAAO,kBAAevuB,IAOxB6R,EAAS4N,SAAS7iB,SAAS,aACR,MAAnBiV,EAAS0N,SAETgP,GAAW1c,EAAS0N,QAGtBxN,EAASwc,EAAS,CAAE7O,SAAS,GAC/B,KA+D0B,gBAWtB,SAAC,KAAM,WACL,SAAC,KAAK,CACJya,KAAK,6BACLC,SACE,SAACvB,GAAuB,CACtBp6B,QAAS9H,EAAM8H,QACfw4B,OAAQA,EACRje,QAASriB,EAAMqiB,QACflN,YAAanV,EAAMmV,YACnBomB,sBAAuBv7B,EAAMu7B,sBAC7B/c,IAAKxe,EAAMwe,IACXD,KAAMve,EAAMue,aAO1B,I,+ICvTQmlB,GAAwBr4B,EAAAA,GAAAA,KAAAA,oBAkB1Bs4B,GAAc,SAACC,GACnB,MAAmB,kBAARA,GAA4B,OAARA,EACtB99B,KAAKC,UAAU69B,GAEjBh9B,OAAOg9B,EAChB,EAkBO,SAASC,GAAS9hC,GAAsD,IAAvB+hC,EAAK,uDAAG,EAC9D,QAAiBhkC,IAAbiC,GAAuC,OAAbA,EAAmB,MAAO,GACxD,IAAMgiC,EAAWxmB,OAAOC,KAAKzb,GAAUge,QAAO,SAAAlW,GAAG,MAAY,WAARA,CAAgB,IAErE,OAAOk6B,EAASC,SAAQ,SAAAC,GAAY,IAAD,IAE3BC,EAAUR,GAAoBS,QAAQF,GACxChjC,EAAQc,EAASkiC,GAGrB,QAAgBnkC,IAAZokC,EAAuB,CAAC,IAAD,IAEzB,OAA4B,MAAxBD,EAAQG,MADE,mBAC2B,GAElC,CAAC,CACNC,IAAI,IAAD,OAAMJ,EAAQrhC,UAAU,EAAG,GAAE,YAAIqhC,EAAQrhC,UAAU,EAAG,GAAE,KAC3D0zB,GAAI,GACJ2N,QAAS,cACThjC,MAAwB,QAAnB,EAAO,QAAP,EAAEA,SAAK,aAAL,EAAO+I,kBAAU,QAAI,GAC5BurB,MAAOuO,GAEX,CAGA,GAAmB,OAAfI,EAAQ5N,SAAyBx2B,IAAVmB,EAAqB,CAC9C,IAAMqjC,EAAgB5+B,MAAMsI,QAAQ/M,GAASA,EAAQ,CAACA,GAGhDsjC,EAAwB,CAC5BF,IAAKH,EAAQG,IACb/N,GAAI4N,EAAQ5N,GACZ2N,QAAAA,EACAhjC,MAAM,iBAAD,OAAmBqjC,EAAc/8B,OAAM,YAC5CguB,MAAOuO,EACPjiC,SAAU,IAgBZ,OAZA0iC,EAAa1iC,SAAWyiC,EAAclkC,KAAI,SAACC,EAAMC,GAS/C,MAR0B,CACxB+jC,IAAI,GAAD,OAAKH,EAAQG,IAAG,YAAI/jC,EAAQ,GAC/Bg2B,GAAI,OACJ2N,QAAQ,QAAD,OAAU3jC,EAAQ,GACzBW,MAAM,iBAAD,OAAmBX,EAAQ,GAChCi1B,MAAOuO,EAAQ,EACfjiC,SAAUgiC,GAAQxjC,EAAMyjC,EAAQ,GAGpC,IAEO,CAACS,EACV,CASA,OANI7+B,MAAMsI,QAAQ/M,GAChBA,EAAQA,EAAMb,IAAIujC,IAAalhC,KAAK,MACV,kBAAVxB,GAAgC,OAAVA,IACtCA,EAAQ0iC,GAAY1iC,IAGf,CAAC,CACNojC,IAAKH,EAAQG,IACb/N,GAAI4N,EAAQ5N,GACZ2N,QAASA,EAAQlb,QAAQ,WAAY,IACrC9nB,MAAwB,QAAnB,EAAO,QAAP,EAAEA,SAAK,aAAL,EAAO+I,kBAAU,QAAI,GAC5BurB,MAAOuO,GAEX,GACF,CAOO,SAASU,GAAeziC,GAE7B,OADgB8hC,GAAQ9hC,GACTw1B,MAAK,SAAC9V,EAAGC,GAAC,OAAKD,EAAE4iB,IAAI7M,cAAc9V,EAAE2iB,IAAI,GAC1D,CChHO,I,WCKP,SAPwB,CACtBI,UAAAA,GACAC,gBAAAA,GACAC,aAAAA,GACAC,cAAAA,IAYF,SAASH,GAAgCrgC,EAAmBC,GAAiD,IAAD,OAC1G,GAAItE,KAAK6kC,cAAcxgC,GAAY,CACjC,IAAMygC,GAAarkC,EAAAA,EAAAA,KACbskC,EAAe,CAAE1vB,GAAIyvB,EAAYxgC,SAAAA,GASvC,OANIqB,MAAMsI,QAAQjO,KAAKglC,UAAU3gC,IAC/BrE,KAAKglC,UAAU3gC,GAAWnC,KAAK6iC,GAE/B/kC,KAAKglC,UAAU3gC,GAAa,CAAC0gC,GAGxB,CACLE,YAAa,kBAAM,EAAKL,aAAavgC,EAAWygC,EAAW,EAE/D,CACE,MAAM,IAAIvgC,MAAM,SAAD,OAAUF,EAAS,mBAEtC,CASA,SAASugC,GAAmCvgC,EAAmBygC,GAC7D,QAAkC/kC,IAA9BC,KAAKglC,UAAU3gC,GAAnB,CAIA,IAAM2gC,EAAYhlC,KAAKglC,UAAU3gC,GAC7BsB,MAAMsI,QAAQ+2B,GAChBhlC,KAAKglC,UAAU3gC,GAAa2gC,EAAUhlB,QAAO,YAAK,SAAF3K,KAAgByvB,CAAU,IAE1E9kC,KAAKglC,UAAU3gC,GAAa,EAN9B,CAQF,CAQA,SAASwgC,GAAoCxgC,GAC3C,OAAOmZ,OAAOxQ,OAAOhN,KAAKklC,QAAQh/B,SAAS7B,EAC7C,CASA,SAASsgC,GAAsCtgC,EAAmB8gC,GAChE,IAAMC,EAAe5nB,OAAOC,KAAKzd,KAAKglC,WAAWx9B,OAAS,EACpD69B,EAAe1/B,MAAMsI,QAAQjO,KAAKglC,UAAU3gC,IAE9C+gC,GAAgBC,GAClBrlC,KAAKglC,UAAU3gC,GAAW0G,SAAQ,SAACu6B,GACjCA,EAAShhC,SAAS6gC,EACpB,GAEJ,CCvDA,SAhCA,SAA+B9rB,EAA2BksB,GACxD,IAAMC,EAAwB,GACxBC,EAAe,IAAIrE,IAEzB,OAAO,gBACL/nB,kBAAAA,EACAuL,SAAU,GACV8gB,aAAc,EACdC,kBAAmB,GACnBC,WAAY,GACZC,WAAY,IACO,OAAhBN,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAmB,IAAE,IACxBC,UAAAA,EACAM,YAAa,SAAUC,GACrB/lC,KAAKgmC,aAAa,CAACD,GACrB,EACAC,aAAc,SAAUC,GACtB,IAAK,IAAIx8B,EAAI,EAAGy8B,EAAMD,EAAaz+B,OAAQiC,EAAIy8B,EAAKz8B,IAAK,CACvD,IAAMub,EAAWihB,EAAax8B,GAEzBg8B,EAAa74B,IAAIoY,EAASC,kBAC7BwgB,EAAa3c,IAAI9D,EAASC,eAAgBD,GAC1CwgB,EAAUtjC,KAAK8iB,GAEnB,CACF,EACAmhB,YAAa,SAAUlhB,GACrB,OAAOwgB,EAAa5D,IAAI5c,EAC1B,GAEJ,ECgCA,SA5DA,SAA8B4b,GAC5B,MAAO,CACLA,iBAAAA,EACAuF,iBAAkB,GAClB5iC,UAAW,GACXC,YAAa,GACbK,UAAW,GACXF,gBAAiB,GACjByiC,aAAc,EACdC,kBAAmB,GACnBC,UAAU,EACVjc,OAAQ,GAIRkc,oBAAqB,SAAUxhB,GAC7BhlB,KAAKymC,qBAAqB,CAACzhB,GAC7B,EAMAyhB,qBAAsB,SAAUjB,GAC9B,IAAQnsB,EAAsBmsB,EAAU,GAAhCnsB,kBAEsB,KAA1BrZ,KAAKomC,uBAAqDrmC,IAA1BC,KAAKomC,mBACvCpmC,KAAKomC,iBAAmBZ,EAAU,GAAGY,kBAGvC,IAAI9b,EAAStqB,KAAKsqB,OAAO3jB,MACvB,SAACC,GAAC,OAAKA,EAAEyS,oBAAsBA,CAAiB,IAGpC,MAAViR,IACFA,EAASoc,GAAqBrtB,EAAmBmsB,GACjDxlC,KAAKsqB,OAAOpoB,KAAKooB,IAGnBA,EAAO0b,aAAaR,EACtB,EAEAmB,kBAAmB,SACjBttB,EACAspB,GAEA,IAAIiE,EAAiB5mC,KAAKsqB,OAAO3jB,MAC/B,SAACC,GAAC,OAAKA,EAAEyS,oBAAsBA,CAAiB,IAGlD,GAAsB,MAAlButB,EACFA,EAAiBppB,OAAOqpB,OAAOD,EAAgBjE,OAC1C,CACL,IAAMrY,EAASoc,GAAqBrtB,GACpCrZ,KAAKsqB,OAAOpoB,KAAKsb,OAAOqpB,OAAOvc,EAAQqY,GACzC,CACF,EAEJ,ECzDO,IAAMuC,GAAS,CACpB4B,YAAa,uCACbC,gBAAiB,2CACjBC,aAAc,wCACdC,eAAgB,2CAiDZC,GAAgB,CACpBC,QAAS,IAOX,SAASC,GAAWvG,GAClB,OAAOqG,GAAOC,QAAQxgC,MACpB,SAAC0gC,GAAM,OAAKA,EAAOxG,mBAAqBA,CAAgB,GAE5D,CAEA,SAASyG,GAAYzG,EAA0BxnB,GAC7C,IAAMkuB,EAAQH,GAAUvG,GAExB,GAAa,MAAT0G,EAIJ,OAAOA,EAAMjd,OAAO3jB,MAClB,SAAC6gC,GAAO,OAAKA,EAAQnuB,oBAAsBA,CAAiB,GAEhE,CAmFA,IAAMouB,GAA6C,CACjDvC,OAAAA,GACAF,UAAW,CAAC,EACZc,YAAW,SAAE4B,GACX,IAAIC,EAaAC,EAVAF,aAA4CG,YAK9CF,EAJkBr8B,EAAAA,GAAAA,KAAAA,aAAAA,SAChBo8B,GAG2BtiB,KAE7BuiB,EAAmBD,EAYrB,IAAQ7G,GAHN+G,EAJI,sBAAuBD,EAINA,EAFnBr8B,EAAAA,GAAAA,KAAAA,oBAAAA,kBAAiDq8B,IAK7C9G,iBAEJ0G,EAAQL,GAAOC,QAAQxgC,MACzB,SAAC4gC,GAAK,OAAKA,EAAM1G,mBAAqBA,CAAgB,IAG3C,MAAT0G,IACFL,GAAOC,QAAQjlC,KAAK4lC,GAAoBjH,IACxC0G,EAAQL,GAAOC,QAAQD,GAAOC,QAAQ3/B,OAAS,IAGjD+/B,EAAMf,oBAAoBoB,EAC5B,EACA5B,aAAY,SAAER,GAAkC,IAAvBuC,EAAY,wDACnC,EAAgDvC,EAAU,GAAlD3E,EAAgB,EAAhBA,iBAAkBxnB,EAAiB,EAAjBA,kBAEtBkuB,EAAQL,GAAOC,QAAQxgC,MACzB,SAAC4gC,GAAK,OAAKA,EAAM1G,mBAAqBA,CAAgB,IAG3C,MAAT0G,IACFL,GAAOC,QAAQjlC,KAAK4lC,GAAoBjH,IACxC0G,EAAQL,GAAOC,QAAQD,GAAOC,QAAQ3/B,OAAS,IAGjD+/B,EAAMd,qBAAqBjB,GAM3BxlC,KAAK2kC,gBAAgBO,GAAO6B,gBAAiB,CAC3ClG,iBAAAA,EACAxnB,kBAAAA,EACA0uB,aAAAA,GAEJ,EACAC,qBAAoB,SAAErF,GACpB,IAAQ9B,EAAwC8B,EAAxC9B,iBAAkBxnB,EAAsBspB,EAAtBtpB,kBAE1B,GAAc,MADCiuB,GAAWzG,EAAkBxnB,GAC5C,CAIA,IAAMkuB,EAAQH,GAAUvG,GACX,MAAT0G,GACFA,EAAMZ,kBAAkBttB,EAAmBspB,EAJ7C,CAMF,EACAsF,kBAAiB,SAAEC,GAA8C,IAAvBH,EAAY,wDACpD,QAC4BhoC,IAA1BmoC,GACiC,IAAjCA,EAAsB1gC,aACOzH,IAA7BmoC,EAAsB,GAHxB,CAQA,IAAQrH,EAAqBqH,EAAsB,GAA3CrH,iBACJ0G,EAAQH,GAAUvG,GACT,MAAT0G,KACFA,EAAQO,GAAoBjH,IAEtBuF,iBAAmB8B,EAAsB,GAAG9B,iBAC7B,OAArB8B,QAAqB,IAArBA,GAAAA,EAAuBn9B,SAAQ,SAACzK,GAAU,IAAD,EACuC,OAAhEP,IAAVwnC,GAA+C,QAAxB,EAACA,EAAMjB,yBAAiB,OAAvB,EAAyBpgC,SAAS5F,EAAKskB,YAC1C,QAAvB,EAAA2iB,EAAMjB,yBAAiB,OAAvB,EAAyBpkC,KAAK5B,EAAKskB,UAEvC,IACA2iB,EAAMY,2BAA6BD,EAAsB1gC,OACzD0/B,GAAOC,QAAQjlC,KAAKqlC,IAGtBW,EAAsBn9B,SAAQ,SAACuf,GAAY,IAAD,EAChCjR,EAAsBiR,EAAtBjR,kBACH,QAAL,EAAAkuB,SAAK,OAAL,EAAOZ,kBAAkBttB,EAAmBiR,EAC9C,IAEAtqB,KAAK2kC,gBAAgBO,GAAO8B,aAAc,CACxCnG,iBAAAA,EACAqH,sBAAAA,EACAH,aAAAA,GAzBF,CA2BF,EACAK,SAAQ,SAAEb,GACR,IAAQ1G,EAAqB0G,EAArB1G,iBAEFwH,EAAgBnB,GAAOC,QAAQxgC,MACnC,SAAC4gC,GAAK,OAAKA,EAAM1G,mBAAqBA,CAAgB,IAGxD,GAAqB,MAAjBwH,EAAuB,CACzB,IAAMC,EAAWR,GAAoBjH,GAErCyH,EAAS9kC,UAAY+jC,EAAM/jC,UAC3B8kC,EAAS7kC,YAAc8jC,EAAM9jC,YAC7B6kC,EAASxkC,UAAYyjC,EAAMzjC,UAC3BwkC,EAAShC,kBAAoBiB,EAAMjB,kBACnCgC,EAASlC,iBAAmBmB,EAAMnB,iBAClCkC,EAAS1kC,gBAAkB2jC,EAAM3jC,gBACjC0kC,EAASjC,aAAekB,EAAMlB,aAE9Ba,GAAOC,QAAQjlC,KAAKomC,EACtB,CACF,EACAC,qBA1OF,WACE,OAAOrB,GAAOC,QAAQ9mC,KAAI,SAACgnC,GAAM,OAAKA,EAAOxG,gBAAgB,GAC/D,EAyOE2H,SAAUpB,GACVqB,UAAWnB,GACXnB,YAvNF,SACEtF,EACAxnB,EACA4L,GAEA,IAAMqF,EAASgd,GAAWzG,EAAkBxnB,GAE5C,GAAc,MAAViR,EAIJ,OAAOA,EAAO6b,YAAYlhB,EAC5B,EA4MEyjB,qBA1MF,SAAgCC,GAAwC,IACpC,EADmC,WACjDzB,GAAOC,SAAO,IAAlC,2BAAoC,CAAC,IACF,EADxBI,EAAK,mBACOA,EAAMjd,QAAM,IAAjC,2BAAmC,CAAC,IACK,EAD9BA,EAAM,mBACQA,EAAOkb,WAAS,IAAvC,2BAAyC,CAAC,IAA/BxgB,EAAQ,QACjB,GAAIA,EAAS2jB,UAAYA,EACvB,OAAO3jB,CAEX,CAAC,+BACH,CAAC,+BACH,CAAC,+BACH,EAiME4jB,wBAxLF,SACE/H,EACAxnB,EACArX,GAEA,IAAMulC,EAAQH,GAAUvG,GAExB,GAAa,MAAT0G,EAAJ,CAIA,IAAMjd,EAASid,EAAMjd,OAAO3jB,MAC1B,SAAC6gC,GAAO,OAAKA,EAAQnuB,oBAAsBA,CAAiB,IAG9D,GAAc,MAAViR,EAIkBA,EAAdkb,UACEz6B,SAAQ,SAACia,GACjBxH,OAAOC,KAAKzb,GAAU+I,SAAQ,SAACjB,GACA,kBAAlB9H,EAAS8H,GAClBkb,EAASlb,IAAI,kBAAQkb,EAASlb,IAAS9H,EAAS8H,IAEhDkb,EAASlb,GAAO9H,EAAS8H,EAE7B,GACF,GAnBA,CAoBF,EA4JE66B,gBAAe,SAAEtgC,EAAmBkT,GACpC,GAeF,SAP2BiG,OAAOqpB,OAChC,CAAC,EACDY,GACAoB,IChTK,ICECtwB,GAAWC,GAAAA,EAAAA,OAmYnB,SAzWwB,SAAH,GAA0E,IAAD,IAAnEzQ,EAAO,EAAPA,QAAS2c,EAAgB,EAAhBA,iBAClC,EAA8B4c,GAAU,CAAEv5B,QAAAA,EAAS2c,iBAAAA,IAA3C6b,EAAM,EAANA,OAAQr5B,EAAS,EAATA,UAChB,GAA0Bq6B,EAAAA,EAAAA,eAA4BxhC,GAAU,eAAzDwnC,EAAK,KAAEuB,EAAQ,KAEtB,GAAsCvH,EAAAA,EAAAA,UAAuB,IAAG,eAAzDwH,EAAW,KAAEC,EAAc,KAClC,GAA0EzH,EAAAA,EAAAA,UAAS,GAAE,eAA9E0H,EAA6B,KAAEC,EAAgC,KACtE,GAA4C3H,EAAAA,EAAAA,UAAS,GAAE,eAAhD1gB,EAAc,KAAEsoB,EAAiB,KACxC,GAAsC5H,EAAAA,EAAAA,UAAS,IAAG,eAA3C6H,EAAW,KAAEC,EAAc,KAClC,GAAwC9H,EAAAA,EAAAA,UAAmB,IAAG,eAAvD+H,EAAY,KAAEC,EAAe,KACpC,GAAsChI,EAAAA,EAAAA,UAAS,IAAG,eAA3CiI,EAAW,KAAEC,EAAc,KAE5BC,EDvCmB,SAAKxoC,EAAUyoC,GACxC,OAA4CpI,EAAAA,EAAAA,UAAYrgC,GAAM,eAAvD0oC,EAAc,KAAEC,EAAiB,KAYxC,OAVAlI,EAAAA,EAAAA,YAAU,WACR,IAAMmI,EAAQzL,YAAW,WACvBwL,EAAkB3oC,EACpB,GAAGyoC,GAEH,OAAO,WACLI,aAAaD,EACf,CACF,GAAG,CAAC5oC,EAAOyoC,IAEJC,CACT,CCyB+BI,CAAYR,EAAa,MAEtD7H,EAAAA,EAAAA,YAAU,WACqB,KAAzB+H,GACFL,EAAe,IACfE,EAAgB,KAEhBF,EAAeK,EAEnB,GAAG,CAACA,KAEJ/H,EAAAA,EAAAA,YAAU,WACR,IAAMsI,EAAU,SAAC1/B,GACf,IAAMg9B,EAA2B/pB,OAAOqpB,OAAO,CAAC,EAAGqD,GAAAA,SAA4BxlB,IAC/EokB,EAASvB,EACX,EACM4C,EAA0BD,GAAAA,UAA6BA,GAAAA,OAAAA,aAAwCD,GAC/FG,EAA6BF,GAAAA,UAA6BA,GAAAA,OAAAA,gBAA2CD,GAErG1C,EAAQ/pB,OAAOqpB,OAAO,CAAC,EAAGqD,GAAAA,SAA4BxlB,IAG5D,OAFAokB,EAASvB,GAEF,WACL4C,EAAwBlF,cACxBmF,EAA2BnF,aAC7B,CACF,GAAG,CAACvgB,KAEJid,EAAAA,EAAAA,YAAU,WAAO,IAAD,EACVoH,EAA4B,GAC5BsB,EAAmC,GACjCC,EAA4B,GAC9B/pC,EAAQ,EAERggC,EAAO/4B,OAAS,IAClBuhC,EAAcxI,EACXlgC,KAAI,SAACiH,GACJ,IAAQib,EAAiBjb,EAAjBib,aACR,QAA0BxiB,KAAV,OAAZwiB,QAAY,IAAZA,OAAY,EAAZA,EAAe,IAAkB,OAAO,KAE5C,MAOIA,EAAa,GANfqjB,EAAU,EAAVA,WACAC,EAAU,EAAVA,WACAH,EAAY,EAAZA,aACArsB,EAAiB,EAAjBA,kBACAssB,EAAiB,EAAjBA,kBACA/gB,EAAQ,EAARA,SAGF0lB,EAAgBpoC,KAAKmX,GAErB,IAAMkxB,EAAiB,CACrBC,sBAAuBjqC,EACvBqlC,WAAAA,EACAC,WAAAA,EACAxsB,kBAAAA,EAEAqsB,aAAAA,EACAC,kBAAAA,EACA/gB,SAAAA,EACAxL,OAAQmJ,GAGV,OADAhiB,IACOgqC,CACT,IACCvqB,QAAO,SAAC8I,GAAG,OAAgC,OAARA,CAAY,UAGtC/oB,IAAVwnC,IAAmC,QAAZ,EAAAA,EAAMjd,cAAM,aAAZ,EAAc9iB,QAAS,IAChD6iC,EAAqB9C,EAAMjd,OAAOtK,QAAO,SAAApZ,GAAC,OAAK0jC,EAAgBpkC,SAASU,EAAEyS,kBAAkB,IACzFhZ,KAAI,SAACiqB,GAAgC,IAAD,EAC7BigB,EAAiB,CACrBC,sBAAuBjqC,EACvBqlC,WAAYtb,EAAOsb,WACnBC,WAAYvb,EAAOub,WAEnBH,aAAcpb,EAAOob,aACrBC,kBAAmBrb,EAAOqb,kBAC1BtsB,kBAAmBiR,EAAOjR,kBAC1BuL,SAAU0F,EAAO1F,SACjBxL,QAAc,OAANkR,QAAM,IAANA,GAAiB,QAAX,EAANA,EAAQkb,iBAAS,WAAX,EAAN,EAAmBh+B,QAAS,EAAI8iB,EAAOkb,UAAY,CAAClb,IAG9D,OADA/pB,IACOgqC,CACT,KAGJvB,EAAe,GAAD,gBAAKD,IAAW,QAAKsB,IACrC,GAAG,CAAC9J,EAAQgH,IAEZ,IAAMkD,GAAiBC,EAAAA,EAAAA,UAAQ,WAE7B,OADA3B,EAAYvR,MAAK,SAAC9V,EAAGC,GAAC,OAAKmT,OAAOpT,EAAEgkB,cAAgB5Q,OAAOnT,EAAE+jB,aAAa,IACnEqD,EAAY1oC,KAAI,SAACsqC,EAAYpqC,GAClC,MAMIoqC,EALF/E,WAAAA,OAAU,MAAG,GAAE,IAKb+E,EAJF9E,WAAAA,OAAU,MAAG,GAAE,IAIb8E,EAHFjF,aAAAA,OAAY,MAAG,GAAE,IAGfiF,EAFFhF,kBAAAA,OAAiB,MAAG,GAAE,IAEpBgF,EADF/lB,SAAAA,OAAQ,MAAG,GAAE,EAITgmB,EN9ImB,SAACC,GAE9B,IAAMxG,EAAQwG,EAAQxG,MAAM,gDAC5B,GAAa,MAATA,EAAe,OAAOwG,EAE1B,cAAmDxG,EAAK,GAA/CzhC,EAAI,KAAEE,EAAK,KAAEC,EAAG,KAAE+nC,EAAI,KAAEC,EAAM,KAAEC,EAAM,KAGzCC,EAAWC,SAASpoC,GACpBqoC,EAASD,SAASnoC,GACxB,GAAIkoC,EAAW,GAAKA,EAAW,IAAME,EAAS,GAAKA,EAAS,GAC1D,OAAON,EAGT,IAAMO,EAAO,IAAIC,KACfH,SAAStoC,GACTqoC,EAAW,EACXE,EACAD,SAASJ,GACTI,SAASH,GACTG,SAASF,IAKX,GACEI,EAAKE,aAAeL,EAAW,GAC/BG,EAAKG,YAAcJ,EAEnB,OAAON,EAIT,IAAMW,EAAUJ,EAAKK,mBAAmB,QAAS,CAAED,QAAS,UACtDE,EAAYN,EAAKK,mBAAmB,QAAS,CAAE3oC,MAAO,UACtD6oC,EAAeP,EAAKG,UACpBK,EAAUR,EAAKS,cAErB,MAAM,GAAN,OAAUL,EAAO,aAAKE,EAAS,YAAIC,EAAY,YAAIC,EACrD,CMuG0BE,CADJ,UAAGlG,EAAU,YAAIC,GAAapjC,MAAM,KAAK,IAGzD,MAAO,CACLvB,MAAOX,EACPG,MAAM,GAAD,OAAKglC,EAAY,aAAK9gB,EAAQ,cAAM+gB,GACzC5+B,YAAa6jC,EAEjB,GACF,GAAG,CAAC7B,IAEEgD,GACsC,QAA1C,EAAAhD,EAAYE,UAA8B,aAA1C,EAA4C7vB,OAAO5R,QAAS,EAE9D1B,QAAQ+Y,MAAM,eAAgBkqB,GAE9B,IAAMiD,GAAsBtB,EAAAA,EAAAA,UAAQ,WAAO,IAAD,EACxC,QAAmD3qC,IAA/CgpC,EAAYE,GAA8C,MAAO,CAAC,EACtE,IAAMgD,EAAiBlD,EAAYE,GAA+B7vB,OAAO5R,OASzE,OANmC,GACjC,EAAG,MAAG,UACLqQ,KAAKyX,KAAK2c,EAAiB,GAAKplC,OAAOgR,KAAKyX,KAAK2c,EAAiB,MAAG,UACrEA,EAAiBplC,OAAOolC,IAAe,CAI5C,GAAG,CAAChD,EAA+BF,IA6B7BmD,GAAYxB,EAAAA,EAAAA,UAAQ,WAAO,IAAD,EAuB9B,YAAmD3qC,IAA/CgpC,EAAYE,GAAqD,GAtBpC,SAA3BkD,EAA4BC,GAAkD,IAArCC,EAAS,uDAAG,GACzD,OAAOD,EAAK/rC,KAAI,SAACikC,EAAK/jC,GAEpB,IAAM+rC,EAA8B,KAAZhI,EAAIA,IAAaA,EAAIA,IAAItb,QAAQ,SAAU,IAAMzoB,EAAM0J,WACzEsiC,EAAmC,KAAdF,EAAgB,UAAMA,EAAS,YAAIC,GAAYA,EAEpEhsC,EAAsB,CAC1BwJ,IAAKyiC,EACLjI,IAAKA,EAAIA,IACT/N,GAAI+N,EAAI/N,GACR2N,QAASI,EAAIJ,QACbhjC,MAAOojC,EAAIpjC,OAOb,YAJqBnB,IAAjBukC,EAAIxiC,UAA0BwiC,EAAIxiC,SAAS0F,OAAS,IACtDlH,EAAKwB,SAAWqqC,EAAyB7H,EAAIxiC,SAAUyqC,IAGlDjsC,CACT,GACF,CAKO6rC,CADM1H,GAD8C,QAA7C,EAAGsE,EAAYE,UAA8B,aAA1C,EAA4C7vB,OAAOyH,EAAiB,IAGvF,GAAG,CAACA,EAAgBooB,EAA+BF,IAE7CyD,GAAe9B,EAAAA,EAAAA,UAAQ,WAC3B,QAAoB3qC,IAAhBqpC,GAA6C,KAAhBA,EAAoB,OAAO8C,EAE5D,IAAMO,EAAcrD,EAAYsD,cAC1BC,EAAc,IAAI1oB,IAElB2oB,EAAc,SAACC,GAAkC,IAAD,gBACpD,OAC0B,QAAxB,EAAS,QAAT,EAACA,EAAKvI,WAAG,aAAR,EAAUoI,qBAAa,QAAI,IAAIxmC,SAASumC,KAClB,QAAvB,EAAQ,QAAR,EAACI,EAAKtW,UAAE,aAAP,EAASmW,qBAAa,QAAI,IAAIxmC,SAASumC,KACZ,QAA5B,EAAa,QAAb,EAACI,EAAK3I,eAAO,aAAZ,EAAcwI,qBAAa,QAAI,IAAIxmC,SAASumC,KACR,QAArC,EAAW,QAAX,EAACI,EAAK3rC,aAAK,aAAV,EAAY+I,WAAWyiC,qBAAa,QAAI,IAAIxmC,SAASumC,EAE1D,EAGMK,EAAoB,SAApBA,EACJD,GAEuB,IADvBE,EAA2B,uDAAG,GAExBC,EAAW,mBAAOD,GAAU,CAAEF,IAChCI,EAAmC,GAavC,OAXIL,EAAYC,IACdI,EAAc/qC,KAAK8qC,GAGA,MAAjBH,EAAK/qC,UACP+qC,EAAK/qC,SAASiJ,SAAQ,SAAAmiC,GACpB,IAAMC,EAAaL,EAAkBI,EAAOF,GAC5CC,EAAa,mBAAOA,IAAa,QAAKE,GACxC,IAGKF,CACT,EAuCMG,EAjCkB,SAAlBC,EACJC,GAEqB,IADrB9X,EAAK,uDAAG,EAER,GAAqB,IAAjB8X,EAAM9lC,QAAgBguB,GAAS8X,EAAM,GAAG9lC,OAAQ,MAAO,GAE3D,IAAM+lC,EAAe,IAAInM,IAoBzB,OAfAkM,EAAMviC,SAAQ,SAAA04B,GACZ,GAAIjO,EAAQiO,EAAKj8B,OAAQ,CACvB,IAO6B,EAPvBqlC,EAAOpJ,EAAKjO,GAOlB,GANK+X,EAAa3gC,IAAIigC,EAAK/iC,MACzByjC,EAAazkB,IAAI+jB,EAAK/iC,IAAK,CACzB+iC,MAAK,UAAMA,GACXM,WAAY,KAGZ3X,EAAQ,EAAIiO,EAAKj8B,OACO,QAA1B,EAAA+lC,EAAa1L,IAAIgL,EAAK/iC,YAAI,OAA1B,EAA4BqjC,WAAWjrC,KAAKuhC,EAEhD,CACF,IAEO99B,MAAMC,KAAK2nC,EAAavgC,UAAU3M,KAAI,YAA2B,IAAxBwsC,EAAI,EAAJA,KAAMM,EAAU,EAAVA,WACpDR,EAAYjkB,IAAImkB,EAAK/iC,KACrB,IAAMhI,EAAWurC,EAAgBF,EAAY3X,EAAQ,GACrD,OAAO1zB,EAAS0F,OAAS,GAAC,kBAAQqlC,GAAI,IAAE/qC,SAAAA,IAAa+qC,CACvD,GACF,CAEiBQ,CApCKnB,EAAUjI,SAAQ,SAAA4I,GAAI,OAAIC,EAAkBD,EAAK,KAuCvE,OAFAtD,EAAgB5jC,MAAMC,KAAK+mC,IAEpBS,CACT,GAAG,CAAClB,EAAW9C,IAEf,OAAIliC,GACK,yCAIP,gBAAKsmC,UAAU,oBAAmB,UAChC,iBACEhlC,MAAO,CACLoB,MAAO,OACPmQ,QAAS,kBACT,WAEF,iBAAKvR,MAAO,CAAEK,QAAS,OAAQ4kC,IAAK,OAAQC,aAAc,QAAS,WACjE,iBAAKllC,MAAO,CAAEmlC,KAAM,GAAI,WACtB,SAAC,UAAe,CAACC,QAAM,EAACplC,MAAO,CAAEK,QAAS,QAAS6kC,aAAc,OAAQ,qBACzE,SAAC,KAAM,CACLllC,MAAO,CAAEoB,MAAO,QAChB1I,MAAO+nC,EACP78B,SAAU,SAAClL,GACTgoC,EAAiChoC,GACjCioC,EAAkB,EACpB,EACA0E,gBAAgB,QAChBC,iBAAiB,QAAO,SAEvBrD,EAAepqC,KAAI,SAACC,GAAI,OACvB,SAAC,GAAM,CAAkBY,MAAOZ,EAAKY,MAAOR,MAAOJ,EAAKI,MAAM,UAC5D,4BACE,yBAAMJ,EAAKI,SACX,gBACE8H,MAAO,CAAEQ,SAAU,OAAQC,MAAO,uBAAwB,SAEzD3I,EAAKyG,kBANCzG,EAAKY,MAST,SAKd6qC,IACC,iBAAKvjC,MAAO,CAAEmlC,KAAM,GAAI,WACtB,UAAC,UAAe,CAACC,QAAM,EAACplC,MAAO,CAAEK,QAAS,QAAS6kC,aAAc,OAAQ,8BACrD7sB,MAEpB,SAAC,KAAM,CACLhR,IAAK,EACLC,IAA+C,QAA5C,EAAEi5B,EAAYE,UAA8B,aAA1C,EAA4C7vB,OAAO5R,OACxDtG,MAAO2f,EACPzU,SAAU,SAAClL,GAAK,OAAKioC,EAAkBjoC,EAAM,EAC7C6sC,MAAO/B,EACPl6B,QAAS,CACPk8B,UAAW,SAAC9sC,GAAyB,YAAenB,IAAVmB,EAAmB,mBAAeA,GAAU,EAAE,YAOlG,SAAC,KAAK,CACJsH,MAAO,CAAEklC,aAAc,QACvBrU,YAAY,uBACZoE,QAAQ,SAACwQ,GAAA,EAAc,IACvB7hC,SAAU,SAACmQ,GAAC,OAAKktB,EAAeltB,EAAEV,OAAO3a,MAAM,EAC/CA,MAAOsoC,KAGT,SAAC,KAAK,CACJ0E,QA5MQ,CACd,CACE9sC,MAAO,MACP+sC,UAAW,MACXrkC,IAAK,MACLF,MAAO,OAET,CACExI,MAAO,KACP+sC,UAAW,KACXrkC,IAAK,KACLF,MAAO,MAET,CACExI,MAAO,UACP+sC,UAAW,UACXrkC,IAAK,UACLF,MAAO,OAET,CACExI,MAAO,QACP+sC,UAAW,QACXrkC,IAAK,QACLF,MAAO,QAsLHwkC,WAAY5B,EACZ6B,YAAY,EACZC,WAAY,CACVC,gBAAiBjF,EACjBkF,qBAAsB,SAAC/wB,GAAI,OAAK8rB,EAAgB9rB,EAAiB,GAEnElc,KAAK,QACLktC,OAAQ,CAAExZ,EAAG,WAKvB,ECgJA,SAAeha,GApdH,0CACV,WAAahb,GAAqB,IAAD,mBAC/B,cAAMA,IAuDRyuC,iBAAmB,SAACC,GAClB,GAAW,MAAPA,GAAuB,KAARA,EACjB,OAAO,EAET,IACE,IAAMC,EAAS,IAAIC,IAAIF,GACvB,OAAOC,EAAOE,SAASC,WAAW,SAAWH,EAAO7lB,SAASvhB,OAAS,CAGxE,CAFE,MAAOwnC,GACP,OAAO,CACT,CACF,EAAC,EAEDC,sBAAwB,WACtB,IAAMC,GAAUC,EAAAA,GAAAA,MACVC,EAQF,CACFF,QAAS,CAAC,EACVG,GAAI,CAAC,GAEQ,MAAXH,IACFE,EAAYF,QAAU,CACpBvuC,KAAsB,MAAhBuuC,EAAQvuC,KAAeuuC,EAAQvuC,UAAOZ,EAC5CuvC,QAA4B,MAAnBJ,EAAQI,QAAkBJ,EAAQI,aAAUvvC,GAEvDqvC,EAAYC,GAAK,CACf1uC,KAAoB,MAAduuC,EAAQG,GAAaH,EAAQG,QAAKtvC,IAI5CwvC,GAAAA,EAAAA,KAAW,CACTnuC,MAAO,QACPwI,MAAO,IACP6G,SACE,iCACE,UAAC,IAAY,CAACrP,MAAM,cAAcS,OAAQ,EAAE,WAC1C,SAAC,SAAiB,CAACnB,MAAM,OAAM,SAC5B,EAAKT,MAAMwe,IAAI9d,QAElB,SAAC,SAAiB,CAACD,MAAM,UAAS,SAC/B,EAAKT,MAAMwe,IAAI6wB,WAElB,SAAC,SAAiB,CAAC5uC,MAAM,WAAU,SAChC,EAAKT,MAAMwe,IAAI+wB,eAGpB,UAAC,IAAY,CAACpuC,MAAM,UAAUS,OAAQ,EAAE,WACtC,SAAC,SAAiB,CAACnB,MAAM,OAAM,SAC5B0uC,EAAYF,QAAQvuC,QAEvB,SAAC,SAAiB,CAACD,MAAM,UAAS,SAC/B0uC,EAAYF,QAAQI,cAGzB,SAAC,IAAY,CAACluC,MAAM,mBAAmBS,OAAQ,EAAE,UAC/C,SAAC,SAAiB,CAACnB,MAAM,OAAM,SAC5B0uC,EAAYC,GAAG1uC,YAKxBw8B,KAAI,WAAW,GAEnB,EAAC,EAEDsS,iCAAmC,WAAa,IAAD,IACvC7lC,EAAQyqB,OAAOqb,WAAa,IAClCH,GAAAA,EAAAA,KAAW,CACTnuC,MAAO,oBACPwI,MAAAA,EACA6G,SAAS,SAAC,GAAe,CACvB1I,QAA2B,QAApB,EAAE,EAAK9H,MAAM8H,eAAO,QAAI,CAAC,EAChC2c,iBAAoD,QAApC,EAAE,EAAKzkB,MAAMsb,OAAOmJ,wBAAgB,QAAI,KAE1DyY,KAAI,WAAW,GAEnB,EAAC,EAEDwS,uBAAyB,WACvB,IAAMC,EAKF,CACFC,eAAgB,GAChBC,cAAe,GACfC,iBAAkB,GAClBC,cAAe,IAIXC,EAAW,EAAKhpC,MAAMipC,SAAS1oC,OAErC,GAAIyoC,EAAW,EACb,IAAK,IAAIxmC,EAAI,EAAGA,EAAIwmC,EAAUxmC,IAAK,CAEjCmmC,EADiB,EAAK3oC,MAAMP,cAAc+C,IACtBvH,KAAK,GAAD,OAAI,EAAK+E,MAAMipC,SAASzmC,GAAG1E,QAAO,qBAAuB,EAAKkC,MAAMipC,SAASzmC,GAAGlD,OAAM,KAChH,CAGF,IAM0B4pC,EANlBC,EAAUC,GAAAA,EAAAA,MAEZC,EAAiB,SAACC,GAAgB,OACtC,SAAC,KAAK,CAACz/B,MAAOy/B,GAAY,EAO5BhB,GAAAA,EAAAA,KAAW,CACTnuC,MAAO,2DACPwI,MAAO,IACP6G,SACE,UAAC,KAAQ,YACP,SAAC2/B,EAAK,CACJ/uC,OAAO,sBAEPC,MAAOgvC,EAAeV,EAAUE,cAActoC,QAAQ,UAEtD,wBACGooC,EAAUE,cAAczvC,KAAI,SAAAkc,GAAC,OAC5B,wBAAoBA,IAAXi0B,EAAAA,EAAAA,KAAkB,OAL3B,uBASN,SAACJ,EAAK,CACJ/uC,OAAO,+BAEPC,MAAOgvC,EAAeV,EAAUG,iBAAiBvoC,QAAQ,UAEzD,wBACGooC,EAAUG,iBAAiB1vC,KAAI,SAAAkc,GAAC,OAC/B,wBAAoBA,IAAXi0B,EAAAA,EAAAA,KAAkB,OAL3B,sBASN,SAACJ,EAAK,CACJ/uC,OAAO,sBAEPC,MAAOgvC,EAAeV,EAAUI,cAAcxoC,QAAQ,UAEtD,wBACGooC,EAAUI,cAAc3vC,KAAI,SAAAkc,GAAC,OAC5B,wBAAoBA,IAAXi0B,EAAAA,EAAAA,KAAkB,OAL3B,uBASN,SAACJ,EAAK,CACJ/uC,OAAO,uBAEPC,MAAOgvC,EAAeV,EAAUC,eAAeroC,QAAQ,UAEvD,wBACGooC,EAAUC,eAAexvC,KAAI,SAAAkc,GAAC,OAC7B,wBAAoBA,IAAXi0B,EAAAA,EAAAA,KAAkB,OAL3B,cASN,SAACJ,EAAK,CACJ/uC,OAAO,UAEPC,OAxDkB6uC,EAwDM,EAAKlpC,MAAMwpC,SAASjpC,QAvDlD,SAAC,KAAK,CAACyB,MAAM,QAAQ6H,MAAOq/B,KAuD8B,UAEpD,wBACG,EAAKlpC,MAAMwpC,SAASpwC,KAAI,SAAAqwC,GAAO,OAC9B,wBAAoBA,IAAXF,EAAAA,EAAAA,KAAwB,OALjC,cAWVrT,KAAI,WAAW,GAEnB,EAAC,EAEDwT,iCAAmC,WACjC,EAAKtpC,SAAS,CAAEupC,+BAA+B,GACjD,EAAC,EAEDC,2BAA6B,SAC3BtmC,GAEA,IAAMrJ,EAAQqJ,EAAMumC,cAAc5vC,MAClC,EAAKmG,SAAS,CACZ0pC,kBAAmB7vC,EACnB8vC,2BAA4B,EAAKtC,iBAAiBxtC,IAEtD,EAAC,EAED+vC,kCAAoC,WAClC,IAAMC,EAAkB7c,OAAO8c,aAAaC,QAAQ,wBACpD,EAAK/pC,SAAS,CACZgqC,oBAAyC,OAApBH,GAAgD,KAApBA,EAAyB,SAAW,UACrFH,kBAAkC,OAAfG,QAAe,IAAfA,EAAAA,OAAmBnxC,EACtC6wC,+BAA+B,EAC/BI,2BAA4B,EAAKtC,iBAAiBwC,IAEtD,EAAC,EAEDI,gCAAkC,SAAC/0B,GACjC,IAAMrS,EAAOqS,EAAEV,OAAO3a,MACtB,EAAKmG,SAAS,CAAEgqC,oBAAqBnnC,GACvC,EAAC,EAEDqnC,sBAAwB,WAGtB,GAFAld,OAAO8c,aAAaK,QAAQ,6BAA8B,EAAKvqC,MAAMoqC,qBAE9B,YAAnC,EAAKpqC,MAAMoqC,oBAMb,OALA,EAAKpxC,MAAMwxC,kBAAkB,CAAE9C,IAAK,UACpC,EAAKtnC,SAAS,CACZupC,+BAA+B,EAC/BI,2BAA2B,IAK/B,IAAMrC,EAAM,EAAK1nC,MAAM8pC,kBACnBW,GAAa,EACN,MAAP/C,GAAuB,KAARA,IACbA,EAAII,WAAW,YAAcJ,EAAII,WAAW,eAC9C,EAAK9uC,MAAMwxC,kBAAkB,CAAE9C,IAAAA,IAC/B+C,GAAa,GAGjB,EAAKrqC,SAAS,CACZupC,+BAAgCc,EAChCV,2BAA4BU,GAEhC,EAlSE,IAAMR,EAAkB7c,OAAO8c,aAAaC,QAAQ,wBAC9CO,EAAatd,OAAO8c,aAAaC,QAAQ,8BAE/C,EAAKnqC,MAAQ,CACXipC,SAAU,GACVxpC,cAAe,GACf+pC,SAAU,GACVM,kBAAkC,OAAfG,QAAe,IAAfA,EAAAA,EAAmB,GACtCN,+BAA+B,EAC/BI,2BAA4B,EAAKtC,iBAAiBwC,GAClDG,oBAAoC,WAAfM,GAA+C,OAApBT,GAAgD,KAApBA,EAAyB,SAAW,WA6BjH,OARD9oC,GAAAA,UACEnD,GAnBqB,SAAH,GAGP,IAHasB,EAAM,EAANA,OAAQC,EAAK,EAALA,MAIhC,EAAKa,UAAS,SAAAJ,GAAK,yBACdA,GAAK,IACRipC,SAAS,GAAD,gBAAMjpC,EAAMipC,UAAQ,oBAAO1pC,GAAK,IAAED,OAAAA,MAC1CG,cAAc,GAAD,gBAAMO,EAAMP,eAAa,CAAEF,EAAM1B,QAAK,GAEvD,IAcAsD,GAAAA,UACEnD,GAbuB,SAACyrC,GACxB,EAAKrpC,UAAS,SAAAJ,GAAK,yBACdA,GAAK,IACRwpC,SAAS,GAAD,gBAAMxpC,EAAMwpC,UAAQ,CAAEC,KAAQ,GAE1C,IAUC,CACH,CAsaC,OAtaA,0CAED,SAAoBkB,EAAkC5b,IAC9CA,EAAUya,SAASjpC,OAAS,GAAOwuB,EAAUka,SAAS1oC,OAAS,IAAOxH,KAAKC,MAAMkb,SAAS4N,WAAa6oB,EAAUz2B,SAAS4N,UAC9H/oB,KAAKqH,SAAS,CACZupC,+BAA+B,EAC/BI,2BAA2B,EAC3Bd,SAAU,GACVxpC,cAAe,GACf+pC,SAAU,IAGhB,GAAC,oBAgPD,WAA4B,IAAD,UA6BrBoB,EA7BqB,OACrBrzB,EAAO,KACX,QAAwBze,IAApBC,KAAKC,MAAMue,KAAoB,CACjC,IAAMszB,EAAgB,QACU/xC,IAA5BC,KAAKC,MAAM8xC,cACbD,EAAc5vC,KACZ,CACExB,MAAO,SACPoJ,IAAK,cACLmD,QAAS,gBACyBlN,IAA5B,EAAKE,MAAM8xC,cACb,EAAK9xC,MAAM8xC,cAEf,IAIN,IAAMC,EAAW,CAAE7xC,MAAO2xC,GAC1BtzB,GACE,SAAC,KAAQ,CAACyzB,KAAMD,EAAUE,QAAS,CAAC,SAAS,UAC3C,SAAC,GAAM,CACL/wC,KAAMgxC,GAAAA,EACNllC,QAAS,SAAAsP,GAAC,OAAIA,EAAE61B,gBAAgB,EAChC1xC,MAAK,UAAKV,KAAKC,MAAMue,KAAK7d,KAAI,aAAKX,KAAKC,MAAMue,KAAKO,MAAK,QAIhE,CAGI/e,KAAKC,MAAMoyC,qBACbR,GACE,SAAC,KAAO,CAACS,GAAG,IAAG,UACb,SAAC,GAAM,CAACnxC,KAAMoxC,GAAAA,EAAuBzgC,QAAQ,sBAKnD,IAgCI0gC,EAhCEC,GACJ,SAAC,GAAM,CACLtxC,KAAMuxC,GAAAA,EACN5gC,QAAQ,eACR7E,QAASjN,KAAKivC,wBAIZ0D,GACJ,SAAC,KAAK,CAAC7hC,MAAO9Q,KAAKiH,MAAMipC,SAAS1oC,OAAQgB,MAAO,CAAEoqC,OAAQ,KAAO,UAChE,SAAC,KAAK,CAAC3pC,MAAM,QAAQ6H,MAAO9Q,KAAKiH,MAAMwpC,SAASjpC,OAAQgB,MAAO,CAAEoqC,OAAQ,MAAO,UAC9E,SAAC,GAAM,CACLzxC,KAAMyP,GAAAA,EACNkB,QAAQ,aACR7E,QAASjN,KAAK2vC,6BAQhBkD,EAFsB7yC,KAAKC,MAAMkb,SAAS4N,SAAS7iB,SAAS,cAI9D,SAAC,GAAM,CACL/E,KAAM2xC,GAAAA,EACNhhC,QAAQ,oBACR7E,QAASjN,KAAKyvC,mCAGhB,KAGAzvC,KAAKC,MAAM8yC,4BACbP,GACE,SAAC,GAAM,CACLrxC,KAAM6xC,GAAAA,EACNlhC,QAAQ,gBACR7E,QAASjN,KAAK2wC,oCAKpB,IAEMI,EAAuD,WAAnC/wC,KAAKiH,MAAMoqC,oBACjCrxC,KAAKiH,MAAM8pC,kBACyB,QADR,EACV,QADU,EAC5B/wC,KAAKC,MAAM8H,eAAO,OAAS,QAAT,EAAlB,EAAoBkrC,eAAO,WAAT,EAAlB,EAA6BC,eAAO,QAA6B,QAA7B,EAAIlzC,KAAKC,MAAMkzC,sBAAc,OAAS,QAAT,EAAzB,EAA2BF,eAAO,WAAT,EAAzB,EAAoCC,QAE1EE,EAA+B,MAArBrC,GAAmD,KAAtBA,GAEzC,SAAC,KAAO,CAAC3vC,MAAO2vC,EAAkB,UAChC,gBACEvoC,MAAO,CACLy0B,SAAU,SACVoW,aAAc,WACdryC,WAAY,SACZsyC,aAAc,OACdnnC,YAAa,QAEf/K,MAAO2vC,EAAkB,SAExBA,MAIL,KAEJ,OACE,iCACE,SAAC,WAAa,CAACvoC,MAAO,CAAEoB,MAAO,OAAQmQ,QAAS,UAAW,UACzD,UAAC,KAAG,CAACvR,MAAO,CAAE+qC,SAAU,UAAW,WACjC,SAAC,KAAG,CAAC/qC,MAAO,CAAEgrC,WAAY,GAAI,UAC5B,SAAC,KAAK,CAACtnC,MAAM,SAASqE,UAAU,aAAY,UAC1C,gBACEkjC,IAhCEC,qDAiCFC,IAAI,GACJnrC,MAAO,CAAEC,OAAQ,OAAQs0B,OAAQ,gBAIvC,SAAC,KAAG,CAAC4Q,KAAK,OAAOnlC,MAAO,CAAE2H,SAAU,EAAG8sB,SAAU,UAAW,UAC1D,gBAAKz0B,MAAO,CAAEoB,MAAO,OAAQqzB,SAAU,UAAW,SAC/Cj9B,KAAKC,MAAM8yC,0BAA4BK,EAAU,QAGtD,SAAC,KAAG,CAAC5qC,MAAO,CAAEgrC,WAAY,GAAI,UAC5B,UAAC,KAAK,CAACjjC,UAAU,aAAY,UAC1BshC,EACAY,EACAE,EACAE,EACAL,EACAh0B,aAMT,UAAC,KAAK,CACJ0e,KAAMl9B,KAAKiH,MAAM2pC,8BACjBxvC,MAAM,yBACN+7B,KAAMn9B,KAAKuxC,sBACXlU,SAAUr9B,KAAKixC,kCAAkC,WAEjD,UAAC,YAAW,CACV/vC,MAAOlB,KAAKiH,MAAMoqC,oBAClBjlC,SAAUpM,KAAKsxC,gCACf9oC,MAAO,CAAEklC,aAAc,QAAS,WAEhC,SAAC,MAAK,CAACxsC,MAAM,UAAS,iCACtB,SAAC,MAAK,CAACA,MAAM,SAAQ,kCAGa,WAAnClB,KAAKiH,MAAMoqC,sBACV,SAAC,KAAO,CAACjwC,MAAOpB,KAAKiH,MAAM8pC,kBAAkB,UAC3C,SAAC,KAAK,CACJ1X,YAAY,2CACZn4B,MAAOlB,KAAKiH,MAAM8pC,kBAClB3kC,SAAUpM,KAAK6wC,2BACfnT,aAAc19B,KAAKuxC,sBACnB5T,WACA39B,KAAKiH,MAAM+pC,2BACP,SAACnT,GAAA,EAAY,CAACr1B,MAAO,CAAES,MAAO,sBAC9B,SAAC20B,GAAA,EAAa,CAACp1B,MAAO,CAAES,MAAO,8BAQjD,KAAC,EAjdS,CAASlH,EAAAA,Y,eC/CrB,SAjBiB,SAAH,GAAwD,IAAlDX,EAAK,EAALA,MAAO2D,EAAO,EAAPA,QACzB,OACE,gBAAKyD,MAAO,CACVC,OAAQ,QACRI,QAAS,OACTC,WAAY,SACZC,eAAgB,UAChB,UAEA,SAAC,MAAM,CACL3H,MAAOA,EACPwyC,SAAU7uC,KAIlB,ECiSA,SAAekW,GA7RD,0CAGZ,WAAahb,GAAuB,IAAD,EAUhC,OAVgC,gBACjC,cAAMA,IAHS4zC,gBAAkB,GAAE,EAiIrCC,aAAe,SACbnqC,EACAoqC,EACA5F,GAEA4F,GACF,EAAC,EAEDC,YAAc,SAACC,GACbA,GACF,EAAC,EAoGDC,qBAAuB,SAAC/F,GAAiB,MAAc,CACrDgG,eAAgB,gBAAGC,EAAe,EAAfA,gBAAiBzqC,EAAY,EAAZA,aAAcoqC,EAAO,EAAPA,QAASE,EAAY,EAAZA,aAAY,OAMrE,iBAAKzrC,MAAO,CAAEuR,QAAS,GAAI,WACzB,SAAC,KAAK,CACJsf,YAAY,SACZn4B,MAAOyI,EAAa,GACpByC,SAAU,SAAAmQ,GAAC,OAAI63B,OACMr0C,IAAnBwc,EAAEV,OAAO3a,MAAsB,CAACqb,EAAEV,OAAO3a,OAAS,GACnD,EACDw8B,aAAc,kBAAM,EAAKoW,aAAanqC,EAAcoqC,EAAS5F,EAAU,EACvE3lC,MAAO,CAAEoB,MAAO,IAAK8jC,aAAc,EAAG7kC,QAAS,YAEjD,UAAC,KAAK,YACJ,SAAC,KAAM,CACL/D,KAAK,UACLmI,QAAS,kBAAM,EAAK6mC,aAAanqC,EAAcoqC,EAAS5F,EAAU,EAClEhtC,MAAM,SAAC8sC,GAAA,EAAc,IACrB1sC,KAAK,QACLiH,MAAO,CAAEoB,MAAO,IAAK,qBAIvB,SAAC,KAAM,CACLqD,QAAS,kBAAM,EAAK+mC,YAAYC,EAAa,EAC7C1yC,KAAK,QACLiH,MAAO,CAAEoB,MAAO,IAAK,wBAKrB,EAERyqC,WAAY,SAACjH,GAAiB,OAC5B,SAACa,GAAA,EAAc,CACbzlC,MAAO,CAAES,MAAOmkC,EAAW,eAAYrtC,IACvC,EAEL,EArRC,EAAKu0C,UAAY,EAAKA,UAAUjqC,MAAK,WACrC,EAAKoH,YAAc,EAAKA,YAAYpH,MAAK,WACzC,EAAKkqC,aAAe,EAAKA,aAAalqC,MAAK,WAC3C,EAAKpD,MAAQ,CACXkgC,QAAS,GACTjgC,WAAW,EACXstC,WAAY,EACZC,SAAU,EAAKZ,iBAChB,CACH,CAgOC,OAhOA,wCAED,WAA2B,IAAD,OAElBa,EAAgB,CAAE/vB,YADoB,CAAE2hB,kBAAmB,OAGlDtmC,KAAKC,MAAM8H,QACxB/D,EAAegE,iCAEV2sC,iBAAiBD,GAAe7vB,MAAK,SAACsiB,GAC3C,EAAK9/B,SAAS,CACZmtC,WAAYrN,EAAQ3/B,OACpB2/B,QAASA,EAAQ9gC,MAAM,EAAG,EAAKY,MAAMwtC,UAAUp0C,KAAI,SAAAknC,GAEjD,OADoB1/B,EAAAA,SAAAA,eAA4B0/B,GAAxCvyB,OAEV,KAEJ,IACG6Q,OAAM,SAACrf,GACNV,QAAQU,MAAMA,GAEd4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,gDAGN,GACJ,GAAC,+BAED,WACE5E,KAAK20C,kBACP,GAAC,gCAED,SAAoBz9B,GACdlX,KAAKC,MAAM8H,UAAYmP,EAAcnP,SACvC/H,KAAK20C,kBAET,GAAC,yBAED,SAAapqC,EAA6Bg9B,GACxCvnC,KAAKC,MAAMob,SAAS,YAAD,OAAaksB,EAAM1G,kBACxC,GAAC,uBAED,YAIU,IAAD,OAJIhwB,EAAM,EAANA,OAAQ+jC,EAAK,EAALA,MAAOC,EAAc,EAAdA,eAKpBlwB,EAAsC,CAC1C2hB,kBAAmB,KACnBz1B,OAAQA,EACR+jC,MAAOA,GAET,QAAuB70C,IAAnB80C,EAA8B,CAChC,IAAK,IAAM/qC,KAAO+qC,EAAgB,CAChC,IAAM3zC,EAAQ2zC,EAAe/qC,GAE3B6a,EAAY7a,GADF,eAARA,EACc,WAAO5I,EAAK,KAETA,CAEvB,CACAyjB,EAAYmwB,cAAgB,MAC9B,CACA,IAAMJ,EAAgB,CAAE/vB,YAAAA,GACT3kB,KAAKC,MAAM8H,QACxB/D,EAAegE,iCAEV2sC,iBAAiBD,GAAe7vB,MAAK,SAACsiB,GAC3C,EAAK9/B,SAAS,CACZ8/B,QAASA,EAAQ9mC,KAAI,SAAAknC,GAEnB,OADoB1/B,EAAAA,SAAAA,eAA4B0/B,GAAxCvyB,OAEV,KAEJ,IACG6Q,OAAM,SAACrf,GACNV,QAAQU,MAAMA,GACd4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,yCAGN,GACJ,GAAC,0BAED,SACEypC,EACA0G,GAEA/0C,KAAKqH,SAAS,CAAEH,WAAW,IAC3B,IAAI3G,EAAQ8tC,EAAW5mC,aACT1H,IAAVQ,IACFA,EAAQ,GAEV,IAAIk0C,EAAWpG,EAAWoG,cACT10C,IAAb00C,IACFA,EAAWz0C,KAAKiH,MAAMwtC,UAExB,IAAM5jC,EAAS4jC,GAAYl0C,EAAQ,GAC7Bq0C,EAAQH,EACd3uC,QAAQ+Y,MAAM,+BAAD,OAAgCte,EAAK,QAClD,IAAMs0C,EAAkD,CAAC,EACzD,IAAK,IAAM1G,KAAa4G,EACK,OAAvBA,EAAQ5G,KACV0G,EAAe1G,GAAa4G,EAAQ5G,GAAW,GAAGlkC,YAGtDjK,KAAKs0C,UAAU,CAAEzjC,OAAAA,EAAQ+jC,MAAAA,EAAOC,eAAAA,IAChC70C,KAAKqH,SAAS,CAAEH,WAAW,EAAOutC,SAAUA,GAC9C,GAAC,oBAcD,WAA4B,IAAD,OACnBvG,EAA2C,EAAC,QAE9C9sC,MAAO,mBACP+sC,UAAW,mBACRnuC,KAAKk0C,qBAAqB,qBAAkB,QAG/C9yC,MAAO,WACP+sC,UAAW,WACRnuC,KAAKk0C,qBAAqB,YAE/B,CACE9yC,MAAO,aACP+sC,UAAW,YACX9lC,OAAQ,SAACnH,GAAa,OAAayB,EAAUzB,EAAM,GAErD,CACEE,MAAO,aACP+sC,UAAW,YACX9lC,OAAQ,SAACnH,GAAa,OAAa8B,EAAU9B,EAAM,IACnD,QAEAE,MAAO,aACP+sC,UAAW,aACRnuC,KAAKk0C,qBAAqB,eAAY,QAGzC9yC,MAAO,iBACP+sC,UAAW,cACX9lC,OAAQ,SAACnH,GAA8B,OAAaqB,EAAUrB,EAAM,GACjElB,KAAKk0C,qBAAqB,gBAE/B,CACE9yC,MAAO,gBACP+sC,UAAW,aACX9lC,OAAQ,SAACnH,GAAa,OAAakC,EAASlC,EAAM,GAEpD,CACEE,MAAO,sBACP+sC,UAAW,mBACX9lC,OAAQ,SAACnH,GAAa,OAAayB,EAAUzB,EAAM,GAErD,CACEE,MAAO,6BACP+sC,UAAW,yBACX9lC,OAAQ,SAACnH,GAA8B,OAAaqB,EAAUrB,EAAM,GAEtE,CACEE,MAAO,sBACP+sC,UAAW,oBACX9lC,OAAQ,SAACnH,GACP,YAAcnB,IAAVmB,EAKK,GAEA2F,OAAO3F,EAElB,IAIEmtC,EAAa,CACjBwF,gBAAiB7zC,KAAK6zC,gBACtBY,SAAUz0C,KAAKiH,MAAMwtC,SACrBO,kBAAkB,EAClBC,iBAAiB,EACjBC,iBAAiB,EACjBC,UAAW,SAACC,EAAexlC,GACzB,MAAM,GAAN,OAAUA,EAAM,GAAE,YAAIA,EAAM,GAAE,eAAOwlC,EAAK,WAC5C,EACAA,MAAOp1C,KAAKiH,MAAMutC,YAGpB,OACE,SAAC,KAAK,CACJhsC,MAAO,CAAEkzB,OAAQ,WACjBwS,QAASA,EACTmH,OAAQ,SAAAC,GAAM,OAAIA,EAAOzU,gBAAgB,EACzCuN,WAAYpuC,KAAKiH,MAAMkgC,QACvBkH,WAAYA,EACZkH,MAAO,SAACD,GACN,MAAO,CACLroC,QAAS,SAAC1C,GACR,OAAO,EAAKkH,YAAYlH,EAAO+qC,EACjC,EAEJ,EACAlpC,SAAUpM,KAAKu0C,aACfhzC,KAAK,QACLi0C,QAASx1C,KAAKiH,MAAMC,WAG1B,KAAC,EA9OW,CAASnF,EAAAA,Y,eCtBV0zC,GAAU,SAAChS,EAAciS,GACpC,IAAIC,EAAUD,EAKd,OAJKC,EAAQC,SAAS,OACpBD,GAAW,KAED,IAAI9G,IAAIpL,EAAMkS,GACf1rC,UACb,EAQa4rC,GAA2B,SAAC16B,GAGzB,IAAD,UACPwN,EAAe,IAAIC,gBAAgBzN,EAAS0N,QAC5CitB,EAAa,IAAIltB,gBAAgBzN,EAAS46B,KAAK/sB,QAAQ,IAAK,MAElE,OAAOgtB,QAKqB,QALd,EAIU,QAJV,EAGqB,QAHrB,EAEgB,QAFhB,EACY,QADZ,EACZrtB,EAAakZ,IAAI,eAAO,QACxBlZ,EAAakZ,IAAI,mBAAW,QAC5BlZ,EAAakZ,IAAI,wBAAgB,QACjCiU,EAAWjU,IAAI,eAAO,QACtBiU,EAAWjU,IAAI,mBAAW,QAC1BiU,EAAWjU,IAAI,iBAEnB,EC3BMoU,GAAa,SAACC,GAClB,IAAIC,EAKJ,GAJiB,OAAbD,IACFC,EAAUD,EAASC,cAGLp2C,IAAZo2C,EAAuB,CACzB,QAAqBp2C,IAAjBo2C,EAAQx1C,WAAwCZ,IAAlBo2C,EAAQp3B,MASxC,MAAO,CACLpe,KAAMw1C,EAAQx1C,KACdoe,MAAOo3B,EAAQp3B,OAVjB3W,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,6CASR,MACEwD,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,mCAIN,MAAO,CACLjE,UAAMZ,EACNgf,WAAOhf,EAEX,EAEqBq2C,IAAW,QAG9B,WAAaT,EAAiBtlC,GAAyB,IAAD,4BAF9CgmC,WAAK,OA0DbC,OAAM,yCAAG,gGAYN,GAZeC,EAAQ,EAARA,SAGVC,EAAe,SAACN,GACpB,IAAM13B,EAAOy3B,GAAWC,GAClBO,EAAa,UAAMP,EAASQ,WAAU,YAAIR,EAASS,cACzC,MAAZJ,GACFzwC,QAAQ6B,KAAK,qDACb4uC,EAAS,CAAE/3B,KAAMA,EAAMi4B,cAAeA,KAEtC3wC,QAAQD,KAAK,sDAEjB,GAEIgwC,GAAyBxhB,OAAOlZ,UAAU,CAAD,gBAKJ,OAAvCrV,QAAQ6B,KAAK,2BAA0B,SAChB,EAAK0uC,MAAMO,iBAAgB,OAClC,OADVV,EAAQ,UAEZpwC,QAAQ6B,KAAK,uBAAwBuuC,GACrCM,EAAaN,IACd,yCAMsB,EAAKG,MAAMQ,UAAS,QAA7B,GACG,QADXX,EAAQ,UACWA,EAASY,QAAO,iBACJ,OAAnChxC,QAAQ6B,KAAK,uBAAsB,UAC7B,EAAK0uC,MAAMU,iBAAgB,gCAEjCjxC,QAAQ6B,KAAK,uCACb6uC,EAAaN,GAAS,4CAG3B,mDAvCK,GAuCL,KAKDc,SAAO,uBAAG,mFACkD,OAA1DlxC,QAAQ6vB,IAAI,+CAA8C,SAC7C,EAAK0gB,MAAMY,kBAAiB,mFAC1C,KAKDC,kBAAgB,uBAAG,mGACJ,EAAKb,MAAMQ,UAAUhyB,MAAK,SAACqxB,GACtC,GAAiB,OAAbA,EACF,OAAOA,EAASS,aAEhBvuC,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,kCAIR,IAAE,mFACH,KAKDiyC,SAAO,uBAAG,mGACK,EAAKR,MAAMQ,UAAUhyB,MAAK,SAACqxB,GAUtC,OATiB,OAAbA,GACF9tC,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,uCAICqxC,GAAWC,EACpB,IAAE,mFA1IF,IAAIiB,EAAe,YACQp3C,IAAvBsQ,EAAS+mC,WACgB,aAAvB/mC,EAAS+mC,YACXD,EAAe,kBAGnBn3C,KAAKq2C,MAAQ,IAAIgB,GAAAA,YAAY,CAC3BC,UAAWjnC,EAASinC,UACpBC,UAAWlnC,EAASmnC,SACpBC,aAAc9B,EACd+B,MAAOrnC,EAASqnC,MAChBC,cAAeR,EACfS,cAAc,EACdC,sBAAsB,EACtBC,4BAA4B,EAC5BC,yBAAyB,GAAD,OAAKpC,EAAO,aAEH,MAA/BtlC,EAAS2nC,oBAUXh4C,KAAKq2C,MAAM4B,gBAAgBC,cAAcrzB,MAAK,SAAA7iB,GACT,MAA/BqO,EAAS2nC,qBACXh2C,EAASm2C,qBAAuB9nC,EAAS2nC,mBACzC,EAAK3B,MAAQ,IAAIgB,GAAAA,YAAY,CAC3BC,UAAWjnC,EAASinC,UACpBC,UAAWlnC,EAASmnC,SACpBC,aAAc9B,EACd+B,MAAOrnC,EAASqnC,MAChBC,cAAeR,EACfS,cAAc,EACdC,sBAAsB,EACtBC,4BAA4B,EAC5BC,yBAAyB,GAAD,OAAKpC,EAAO,WACpC3zC,SAAAA,IAGN,IAAG6jB,OAAM,SAACrf,GACRV,QAAQU,MACN,qDACAA,EAEJ,GAEJ,I,sBCqBF,SAxF+B,WAOX,IAPYq4B,EAA6B,uDAAG,CAC9DuZ,QAAS,EACTC,OAAQ,EACRC,WAAY,IACZC,WAAY,IACZC,WAAW,EACXC,qBAAsB,CAAC,IAAK,MAEtBC,EAAe7Z,EAEE,MAAnBA,EAAQuZ,UACVM,EAAaN,QAAUvZ,EAAQuZ,SAGX,MAAlBvZ,EAAQwZ,SACVK,EAAaL,OAASxZ,EAAQwZ,QAGN,MAAtBxZ,EAAQyZ,aACVI,EAAaJ,WAAazZ,EAAQyZ,YAGV,MAAtBzZ,EAAQ0Z,aACVG,EAAaH,WAAa1Z,EAAQ0Z,YAGX,MAArB1Z,EAAQ2Z,YACVE,EAAaF,UAAY3Z,EAAQ2Z,WAGC,MAAhC3Z,EAAQ4Z,uBACVC,EAAaD,qBAAuB5Z,EAAQ4Z,sBAY9C,IAAME,EAAe,SACnBC,EACA52C,GAEA,IAAQ2sC,EAAgB3sC,EAAhB2sC,IAAKkK,EAAW72C,EAAX62C,OAgCb,IAAMC,EAAsBF,EAAQG,KAGpC,OAFAH,EAAQG,KA/BR,WACE,IAAMC,EAAYC,GAAMD,UAAUN,GAElCM,EAAUE,SAAQ,SAA2BC,GAC3C,IAAMC,EAA6BR,EAAQS,mBAG3CT,EAAQS,mBAAqB,WAC3B,GAAkC,MAA9BD,EAAoC,CAAC,IAAD,uBADmB3zC,EAAI,yBAAJA,EAAI,gBAE7D2zC,EAA2BjzC,MAAMyyC,EAASnzC,EAC5C,CAEA,GAAIizC,EAAaD,qBAAqBvyC,SAAS0yC,EAAQU,QAAS,CAC9D,IAAMC,EAAY,6BAAyB5K,EAAG,YACxC6K,EAAqB,IAAIj1C,MAAMg1C,GACrCP,EAAUC,MAAMO,EAClB,CACF,EAGIL,EAAiB,IACnBrzC,QAAQD,KAAK,cAAD,OAAe8oC,EAAG,yBAAiBwK,EAAc,MAC7DP,EAAQ1b,KAAK2b,EAAQlK,GAAK,GAE9B,IAAE,2BAxBkClpC,EAAI,yBAAJA,EAAI,gBA0BxCqzC,EAAoB3yC,MAAMyyC,EAASnzC,EACrC,EAMOmzC,CACT,EAEA,OAAOD,CACT,ECzGA,IAAQ1W,GAAsB32B,EAAAA,GAAAA,oBAAAA,kBASTmuC,GAAe,WAKlC,cAII,IAAD,OAJY9D,EAAO,EAAPA,QAAStlC,EAAQ,EAARA,SAAUuwB,EAAO,EAAPA,SAAO,oBAJxB8Y,OAAkB,GAAE,KAEpBC,iBAAW,OAsG5BC,cAAgB,SAACC,GACf,IAAK,IAAMC,KAAKD,EACd,EAAKH,OAAO,GAAG5xC,OAAOiyC,QAAQD,GAAKD,EAAOC,EAE9C,EAAC,KAMDpjB,eAAc,yCAAG,WACfmI,GAAsC,0EAElC,EAAK6a,OAAO,GAAGjjB,MAAM,CAAD,+BACT,EAAKijB,OAAO,GAAG5xC,OAAO4uB,eAAemI,GAAQ,OAIzD,wCAJyD,uBAE7C7U,QAAQE,OACnB,IAAI3lB,MAAM,2BACX,2CAEJ,mDAVa,GAUb,KAEDowC,iBAAgB,yCAAG,WACjB9V,GAAwC,sFAE3B,EAAK6a,OAAO,GAAG5xC,OAAO6sC,iBAAiB9V,GAAQ,mFAC7D,mDAJe,GAIf,KAEDzU,gBAAe,yCAAG,WAChByU,GAAuC,sFAE1B,EAAK6a,OAAO,GAAG5xC,OAAOsiB,gBAAgByU,GAAQ,mFAC5D,mDAJc,GAId,KAEDpa,mBAAkB,yCAAG,WACnBoa,GAA0C,sFAE7B,EAAK6a,OAAO,GAAG5xC,OAAO2c,mBAAmBoa,GAAQ,mFAC/D,mDAJiB,GAIjB,KAEDmb,sBAAqB,yCAAG,WACtBnb,GAA6C,8FAEV,EAAK6a,OAAO,GAAG5xC,OAAOkyC,sBAAsBnb,GAAQ,OAE/C,OAFlCob,EAAoB,OACpBC,EAAcjY,GAAkBgY,GACtC/P,GAAAA,SAA4BgQ,GAAY,kBACjCD,GAAoB,2CAC5B,mDAPoB,GAOpB,KAED1vB,uBAAsB,yCAAG,WACvBsU,GAA8C,8FAEV,EAAK6a,OAAO,GAAG5xC,OAAOyiB,uBAAuBsU,GAAQ,OAElC,OAFjDqJ,EAAqB,OACrBgS,EAAchS,EAAsB7nC,IAAI4hC,IAC9CiI,GAAAA,kBAAqCgQ,GAAa,GAAK,kBAChDhS,GAAqB,2CAC7B,mDAPqB,GAOrB,KAEDiS,yBAAwB,yCAAG,WACzBtb,GAAgD,sFAEnC,EAAK6a,OAAO,GAAG5xC,OAAOqyC,yBAAyBtb,GAAQ,mFACrE,mDAJuB,GAIvB,KAED3Z,iBAAgB,yCAAG,WACjB2Z,GAAwC,kGAEjB,EAAK6a,OAAO,GAAG5xC,OAAOod,iBAAiB2Z,GAAQ,OAGhB,OAHhD7Z,EAAQ,OACRzN,EAAOjM,EAAAA,GAAAA,aAAAA,SAAiC0Z,GAAS,EACnCnd,EAAAA,SAAAA,eAA4B0P,EAAK6N,MAA7CpQ,EAAO,EAAPA,QACRk1B,GAAAA,aAAgC,CAACl1B,IAAqB,kBAC/CgQ,GAAQ,2CAChB,mDARe,GAQf,KAEDo1B,uBAAsB,yCAAG,WACvBvb,GAA8C,sFAEjC,EAAK6a,OAAO,GAAG5xC,OAAOsyC,uBAAuBvb,GAAQ,mFACnE,mDAJqB,GAIrB,KAEDwb,yBAAwB,yCAAG,WACzBxb,GAAgD,sFAEnC,EAAK6a,OAAO,GAAG5xC,OAAOuyC,yBAAyBxb,GAAQ,mFACrE,mDAJuB,GAIvB,KAEDyb,+BAA8B,yCAAG,WAC/Bzb,GAAsD,sFAEzC,EAAK6a,OAAO,GAAG5xC,OAAOwyC,+BAA+Bzb,GAAQ,mFAC3E,mDAJ6B,GAI7B,KAED0b,iBAAgB,yCAAG,WACjB1b,GAAwC,sFAE3B,EAAK6a,OAAO,GAAG5xC,OAAOyyC,iBAAiB1b,GAAQ,mFAC7D,mDAJe,GA1LZ7+B,KAAK25C,YADQ,MAAX/Y,EACiBA,EAEA,SAACp6B,EAAOg0C,GACzB10C,QAAQU,MAAMA,EAAOg0C,EACvB,EAGFnqC,EAAStF,SAAQ,SAAAyvC,GAAmB,IAAD,IAW7BC,OAVmB16C,IAAnBy6C,GACFpyC,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,qDAMqB7E,IAAvBy6C,EAAe7L,IACjB8L,EAAaD,EAAe7L,SACK5uC,IAAxBy6C,EAAe/W,KACxBgX,EAAahF,GAAQ+E,EAAe/W,KAAMkS,GAE1CvtC,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,+DAKN,IAEM81C,EAAgD,CACpD/L,IAAK8L,GAGDE,GAAmE,IAA3CH,EAAeI,yBAAoC,CAC/EH,EACAD,EAAeK,eACfL,EAAeM,eACfN,EAAeO,gBACf1+B,MAXkB,SAACsyB,GAAY,aAAsC,QAAtC,EAAiB,OAAHA,QAAG,IAAHA,OAAG,EAAHA,EAAKI,WAAW,gBAAQ,QAAS,SAa1ChvC,IAAlCy6C,EAAeK,iBACjBH,EAAeM,cAAgBR,EAAeK,qBAEV96C,IAAlCy6C,EAAeM,iBACjBJ,EAAeO,cAAgBT,EAAeM,qBAEV/6C,IAAlCy6C,EAAeO,iBACjBL,EAAeQ,cAAgBV,EAAeO,gBAG5CJ,IACFD,EAAeX,SAAO,kBACjBW,EAAeX,SAAO,IACzB,0BAA2B,oCAIFh6C,IAAzBy6C,EAAevB,QACjByB,EAAeS,aAAe,CAACC,GAAgBZ,EAAevB,SAGhEyB,EAAevyC,iBAAmB,SAAC3B,GACjC,EAAKmzC,YAAYnzC,EAAOg0C,EAC1B,EAEA,EAAKd,OAAOx3C,KAAK,CACfmT,GAAImlC,EAAenlC,GACnBohB,MAA2B,QAAtB,EAAE+jB,EAAe/jB,aAAK,SAC3B4kB,KAAyB,QAArB,EAAEb,EAAea,YAAI,SACzBvzC,OAAQ,IAAIwzC,GAAAA,GAAAA,eAAuBZ,IAEvC,IAEI16C,KAAK05C,OAAOlyC,OAAS,GACvBY,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,wCAIR,CAcC,OAdA,6BAED,WACE,OAAO5E,KAAK05C,OAAO,GAAG5xC,OAAOorC,OAC/B,GAAC,mBAQD,WACE,OAAOlzC,KAAK05C,OAAO,GAAG5xC,OAAOiyC,OAC/B,KAAC,EAjHiC,GCMpC,SAASwB,GAAsB,GAUd,IAAD,IAVmBxzC,EAAO,EAAPA,QAASyW,EAAI,EAAJA,KAAMC,EAAG,EAAHA,IAAK+8B,EAAM,EAANA,OAW7C92B,GAAqBlJ,EAAAA,EAAAA,MAArBkJ,iBAEF8W,IAAuD,QAA/B,EAAEggB,EAAOC,8BAAsB,UACvDn5B,EAAwB,QAAjB,EAAGk5B,EAAOl5B,eAAO,SAC9B,OACE,SAACo5B,GAAU,CACT3zC,QAASA,EACTyW,KAAMA,EACNpJ,YAAaomC,EAAOpmC,YACpBkN,QAASA,EACT7D,IAAKA,EACL+c,sBAAuBA,EACvB9W,iBAAkBA,GAGxB,CAohBA,SAlaS,0CAgDP,WAAazkB,GAAkB,IAAD,qBAC5B,cAAMA,IAhDS07C,UAAI,IAEJC,oBAAsB,SACrCp1C,EACAg0C,GAEqB,MAAjBh0C,EAAM8yC,OACR,EAAKhD,SACqB,MAAjB9vC,EAAM8yC,QAEflxC,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,yDAIN,IAAMi3C,EAAiB,WAErBzzC,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,uCAGN,OAEqC7E,IAAjCy6C,EAAesB,cACjBtB,EAAesB,cAAc/wC,SAAQ,SAACgxC,GAChCv1C,EAAM8yC,SAAWyC,EAAQzC,OAC3B,EAAKjyC,SAAS,CACZb,MAAO,CACL8yC,OAAQ9yC,EAAM8yC,OACdv0C,QAASg3C,EAAQh3C,WAGK,MAAjByB,EAAM8yC,QACfuC,GAEJ,IAC0B,MAAjBr1C,EAAM8yC,QACfuC,GAEJ,EAAC,EAyHDrF,aAAe,YAGF,IAHKh4B,EAAI,EAAJA,KAAMi4B,EAAa,EAAbA,cAItB,IAAK,IAAM3sC,KAAO,EAAK7C,MAAMc,QAAS,CACrB,EAAKd,MAAMc,QAAQ+B,GAC3B8vC,cAAc,CAAEoC,cAAevF,GACxC,CACA,IAAMwF,EAAa5nB,OAAO8c,aAAaC,QAAQ,aACzC8K,EAAe7nB,OAAO8c,aAAaC,QAAQ,eACjD,GAAmB,OAAf6K,GAAsC,KAAfA,GAErBA,IADgB5nB,OAAOlZ,SAAS4N,SACJ,CAC9B,IAAI0a,EAAOwY,EACU,OAAjBC,GAA0C,KAAjBA,IAC3BzY,GAAQyY,GAEV7nB,OAAOlZ,SAASghC,KAAO1Y,CACzB,CAEFpP,OAAO8c,aAAaiL,WAAW,aAC/B/nB,OAAO8c,aAAaiL,WAAW,eAC/B,EAAK/0C,SAAS,CAAEmX,KAAMA,GACxB,EA3IE1Y,QAAQ6B,KAAK,kBACb7B,QAAQ6B,KAAK,sBAAD,OAAuB1H,EAAMu7C,OAAO/X,KAAI,MACpD,MAA2BpP,OAAOlZ,SAA1B2zB,EAAQ,EAARA,SAAUuN,EAAI,EAAJA,KACZ1G,EAAO,UAAM7G,EAAQ,aAAKuN,GAC1BC,EAAS7G,GAAQx1C,EAAMu7C,OAAO/X,KAAMkS,GAEpC4G,EAAet8C,EAAMu7C,OAAOgB,UACbz8C,IAAjBw8C,IACFz2C,QAAQ6B,KACN,8CACA1H,EAAMu7C,OAAOgB,MAEf,EAAKb,KAAO,IAAIvF,GAAYkG,EAAQC,IAGF,IAAhCt8C,EAAMu7C,OAAOiB,QAAQj1C,QACvBY,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,uCAGNkB,QAAQ6B,KACN,yDACA1H,EAAMu7C,OAAOiB,SAGf,EAAKlL,sBAAwB,EAAKA,sBAAsBlnC,MAAK,WAE7DtF,EAAAA,GAAAA,OAAe,CAAEiC,SAAU,IAC3B,EAAK01C,gCAAgCz8C,EAAMu7C,QAE3C,IAAMrI,EApMV,SAA6B,GAQmB,IARfwC,EAAO,EAAPA,QAASgH,EAAU,EAAVA,WAAYtsC,EAAQ,EAARA,SAAUuwB,EAAO,EAAPA,QASxDgc,EAAiD,CAAE3J,QAAS,GAC5DvwB,EAA4D,CAAC,EA6CnE,IAAK,IAAM5Y,KA3CXuG,EAAStF,SAAQ,SAAAyvC,GACf,GAAqC,MAAjCA,EAAeqC,eACjBrC,EAAeqC,eAAe9xC,SAAQ,SAAAkkB,GAChCzR,OAAOxQ,OAAehJ,GAAgBkC,SAAS+oB,GAC7CA,KAAe2tB,EACjBA,EAAoB3tB,IAAgB,EAEpC2tB,EAAoB3tB,GAAe,EAGrCnpB,QAAQD,KACN,iCAA0BopB,EAAW,iDACXurB,EAAenlC,GAAE,KAGjD,QACK,CACL,GAAIgf,OAAOlZ,SAAS4N,SAAS7iB,SAAS,cAAe,CACnD,IAAM6iB,EAAWsL,OAAOlZ,SAAS4N,SAAStmB,MAAM,WAAW,GACrDq6C,EAAO,UAAMH,GAAU,OAAG5zB,EAAQ,aACxCyxB,EAAe7L,IAAMmO,CACvB,CAEAF,EAAoB3J,SAAW,EAC/BvwB,EAAcuwB,QAAU,IAAIwG,GAAgB,CAC1C9D,QAAAA,EACAtlC,SAAU,CAACmqC,GACX5Z,QAAAA,GAEJ,CACF,IAEIgc,EAAoB3J,QAAU,GAChC7qC,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,wFAMYg4C,EACJ,YAAR9yC,GAGA8yC,EAAoB9yC,GAAO,GAC7B1B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,iEAAgE,yBAC9CkF,EAAG,oCACrB,+BA0BR,OApBI0T,OAAOC,KAAKm/B,GAAqBp1C,OAAS,GAC5C6I,EAAStF,SAAQ,SAAAgyC,GACf,IAAMj1C,EAAS,IAAI2xC,GAAgB,CACjC9D,QAAAA,EACAtlC,SAAU,CAAC0sC,GACXnc,QAAAA,IAE2B,MAAzBmc,EAAOF,gBACTE,EAAOF,eAAe9xC,SAAQ,SAAAkkB,GAC5BvM,EAAcuM,GAAennB,CAC/B,GAEJ,IAGF0V,OAAOxQ,OAAOhJ,GAAgB+G,SAAQ,SAAAkkB,GAC9BA,KAAevM,IACnBA,EAAcuM,GAAevM,EAAcuwB,QAE/C,IACOvwB,CACT,CAuG2Bs6B,CAAqB,CAC1CrH,QAAAA,EACAgH,WAAmC,QAAzB,EAAE18C,EAAMu7C,OAAOmB,kBAAU,QAAI,uCACvCtsC,SAAUpQ,EAAMu7C,OAAOiB,QACvB7b,QAAS,EAAKgb,sBAQf,OALD,EAAK30C,MAAQ,CACXc,QAASorC,EACTA,eAAAA,EACAjsC,WAAW,EACX+1C,mBAAmB,GACpB,CACH,CA8TC,OA9TA,uDAED,SAAiCzB,GAC/B,IAAM0B,EAAW,kCAEXvO,EADY,IAAI/lB,gBAAgByL,OAAOlZ,SAAS0N,QAChCgZ,IAAI,YAIW9hC,IAHAy7C,EAAOiB,QAAQ91C,MAClD,SAACo2C,GAAM,OAAKA,EAAO1nC,KAAO6nC,CAAQ,KAE6B,kBAARvO,GACvD6M,EAAOiB,QAAQv6C,KAAK,CAClBmT,GAAI6nC,EACJzmB,OAAO,EACPkY,IAAAA,EACAkO,eAAgB,CACd74C,EAAem5C,iBACfn5C,EAAe+vB,oBACf/vB,EAAe+mB,aACf/mB,EAAemmB,kCACfnmB,EAAeqnB,eACfrnB,EAAewgB,qCACfxgB,EAAeo5C,kCACfp5C,EAAeq5C,sCACfr5C,EAAes5C,0CAIvB,GAAC,mCAED,YAAwD,IAA/B3O,EAAG,EAAHA,IAEvB,GADA7oC,QAAQ6B,KAAK,2BAA4BgnC,GAC7B,KAARA,GAA4E,YAA9Dta,OAAO8c,aAAaC,QAAQ,8BAA9C,CAIA/c,OAAO8c,aAAaK,QAAQ,uBAAwB7C,GACpD,IAAM4O,EAAY,IAAI9D,GAAgB,CACpC9D,QAAS,GACTtlC,SAAU,CAAC,CACTgF,GAAI,MACJs5B,IAAAA,EACA0M,MAAM,EACN5kB,OAAO,IAETmK,QAAS5gC,KAAK47C,sBAEhB2B,EAAU3D,cAAc55C,KAAKiH,MAAMc,QAAQkrC,QAAQ8G,SAMnD/5C,KAAKqH,UAAS,SAAAJ,GACZ,IAAMc,EAA8C,CAAC,EACrD,IAAK,IAAM+B,KAAO7C,EAAMc,QACtBA,EAAQ+B,GAAOyzC,EAEjB,MAAO,CAAEx1C,QAAAA,EACX,GAxBA,MAFE/H,KAAKqH,SAAS,CAAEU,QAAS/H,KAAKiH,MAAMksC,gBA2BxC,GAEA,oBAkCA,WAAiB,IAAD,YACIpzC,IAAdC,KAAK27C,MACP71C,QAAQ6B,KAAK,uBACb3H,KAAK27C,KAAKrF,OAAO,CAAEC,SAAUv2C,KAAKw2C,eAAgB3xB,MAAK,WACrD/e,QAAQ6B,KAAK,0BACb,EAAKN,SAAS,CACZH,WAAW,EACX+1C,mBAAmB,GAEvB,IAAGp3B,OAAM,SAACrf,GACRV,QAAQU,MAAMA,GAEd4B,GAAAA,QACElD,EACA,IAAIL,EACFD,EACA,4BAEJ,EAAKyC,SAAS,CACZH,WAAW,EACXs2C,gBAAYz9C,EACZk9C,mBAAmB,GAEvB,KAEAj9C,KAAKqH,SAAS,CACZH,WAAW,EACXs2C,gBAAYz9C,EACZk9C,mBAAmB,GAGzB,GAAC,+BAED,WACE,IAAMxZ,EAAOpP,OAAO8c,aAAaC,QAAQ,aAC5B,OAAT3N,GAA0B,KAATA,IACnBpP,OAAO8c,aAAaK,QAAQ,YAAand,OAAOlZ,SAAS4N,UACzDsL,OAAO8c,aAAaK,QAAQ,cAAend,OAAOlZ,SAAS0N,SAI7D,IAAMqoB,EAAkB7c,OAAO8c,aAAaC,QAAQ,wBAC5B,OAApBF,GAAgD,KAApBA,GAC9BlxC,KAAKuxC,sBAAsB,CAAE5C,IAAKuC,IAGpClxC,KAAKs2C,QACP,GAAC,oBAED,WAA4B,IAAD,IAgBrBmH,EAhBqB,OACnBC,EAAU,CACd/8C,KAAMX,KAAKC,MAAMU,KACjB2uC,QAAStvC,KAAKC,MAAMqvC,QACpBE,SAAUxvC,KAAKC,MAAMuvC,SACrBhvC,IAAK,iCACLm9C,aAAc39C,KAAKC,MAAMu7C,OAAOmC,cAG5BC,IAC6B,QADZ,EACrB59C,KAAKC,MAAMu7C,OAAOqC,uBAAe,UAE7BC,EACmC,QADd,EACzB99C,KAAKC,MAAMu7C,OAAOsC,6BAAqB,SAKvCL,EADEG,GACS,SAAC,GAAQ,CAAC71C,QAAS/H,KAAKiH,MAAMc,WAE9B,yDAGb,IACIg2C,EADAC,GAAmB,EAIK,MAA1Bh+C,KAAKC,MAAMu7C,OAAOgB,MAC2B,MAA7Cx8C,KAAKC,MAAMu7C,OAAOgB,KAAKxE,oBAEvB+F,EAAW,WACQ,MAAb,EAAKpC,MAEP,EAAKA,KAAK3E,SAEd,EACAgH,GAAmB,IAEnBD,EAAW,WAAO,EAClBC,GAAmB,GAGrB,IAAMC,EAAc,CAAEx1C,OAAQ,SACxBy1C,EAAqB,CAAEz1C,OAAQ,QAErC,YAA8B1I,IAA1BC,KAAKiH,MAAMu2C,YAEX,SAAC,KAAa,CAACW,SAAUn+C,KAAKC,MAAMu7C,OAAO/X,KAAK,UAC9C,SAAC,KAAQ,CAAC6O,GAAItyC,KAAKiH,MAAMu2C,WAAYx0B,SAAO,MAGvChpB,KAAKiH,MAAMC,WAElB,SAAC,KAAa,CAACi3C,SAAUn+C,KAAKC,MAAMu7C,OAAO/X,KAAK,UAC9C,UAAC,IAAM,CAACj7B,MAAOy1C,EAAY,WACzB,SAAC,GAAM,CACLx/B,IAAKi/B,EACLl/B,KAAMxe,KAAKiH,MAAMuX,KACjB6zB,oBAAoB,EACpBZ,kBAAmBzxC,KAAKuxC,sBACxBwB,2BAA2B,EAC3BhrC,QAAS/H,KAAKiH,MAAMc,QACpBorC,eAAgBnzC,KAAKiH,MAAMksC,kBAE7B,SAAC,YAAc,CAAC3qC,MAAO01C,EAAmB,UACxC,SAAC,MAAS,WAKRl+C,KAAKiH,MAAMg2C,kBAIQ,MAApBj9C,KAAKiH,MAAMT,OAElB,SAAC,GAAQ,CAAC1B,KAAK,QAAQC,QAAS/E,KAAKiH,MAAMT,MAAMzB,WAIjD,SAAC,KAAa,CAACo5C,SAAUn+C,KAAKC,MAAMu7C,OAAO/X,KAAK,UAC9C,UAAC,KAAM,YACL,SAAC,KAAK,CACJA,KAAK,IACLC,SACE,UAAC,IAAM,CAACl7B,MAAOy1C,EAAY,WACzB,SAAC,GAAM,CACLx/B,IAAKi/B,EACLl/B,KAAMxe,KAAKiH,MAAMuX,KACjB6zB,oBAAoB,EACpBZ,kBAAmBzxC,KAAKuxC,sBACxBQ,aAAciM,EAAmBD,OAAWh+C,EAC5CgzC,0BAA2B+K,EAC3B/1C,QAAS/H,KAAKiH,MAAMc,QACpBorC,eAAgBnzC,KAAKiH,MAAMksC,kBAE7B,SAAC,YAAc,CAAC3qC,MAAO01C,EAAmB,SACvCT,UAKT,SAAC,KAAK,CACJha,KAAK,+BACLC,SACE,UAAC,IAAM,CAACl7B,MAAOy1C,EAAY,WACzB,SAAC,GAAM,CACLx/B,IAAKi/B,EACLl/B,KAAMxe,KAAKiH,MAAMuX,KACjB6zB,mBAAoBuL,EACpBnM,kBAAmBzxC,KAAKuxC,sBACxBQ,aAAciM,EAAmBD,OAAWh+C,EAC5CgzC,0BAA2B+K,EAC3B/1C,QAAS/H,KAAKiH,MAAMc,QACpBorC,eAAgBnzC,KAAKiH,MAAMksC,kBAE7B,SAAC,YAAc,CAAC3qC,MAAO01C,EAAmB,UACxC,SAAC3C,GAAsB,CACrBxzC,QAAS/H,KAAKiH,MAAMc,QACpByW,KAAMxe,KAAKiH,MAAMuX,KACjBg9B,OAAQx7C,KAAKC,MAAMu7C,OACnB/8B,IAAKi/B,YAMf,SAAC,KAAK,CACJja,KAAK,6GACLC,SACE,UAAC,IAAM,CAACl7B,MAAOy1C,EAAY,WACzB,SAAC,GAAM,CACLx/B,IAAKi/B,EACLl/B,KAAMxe,KAAKiH,MAAMuX,KACjB6zB,mBAAoBuL,EACpBnM,kBAAmBzxC,KAAKuxC,sBACxBQ,aAAciM,EAAmBD,OAAWh+C,EAC5CgzC,0BAA2B+K,EAC3B/1C,QAAS/H,KAAKiH,MAAMc,QACpBorC,eAAgBnzC,KAAKiH,MAAMksC,kBAE7B,SAAC,YAAc,CAAC3qC,MAAO01C,EAAmB,UACxC,SAAC3C,GAAsB,CACrBxzC,QAAS/H,KAAKiH,MAAMc,QACpByW,KAAMxe,KAAKiH,MAAMuX,KACjBg9B,OAAQx7C,KAAKC,MAAMu7C,OACnB/8B,IAAKi/B,YAMf,SAAC,KAAK,CACJja,KAAK,UACLC,SACE,UAAC,IAAM,CAACl7B,MAAOy1C,EAAY,WACzB,SAAC,GAAM,CACLx/B,IAAKi/B,EACLl/B,KAAMxe,KAAKiH,MAAMuX,KACjB6zB,oBAAoB,EACpBZ,kBAAmBzxC,KAAKuxC,sBACxBQ,aAAciM,EAAmBD,OAAWh+C,EAC5CgzC,0BAA2B+K,EAC3B/1C,QAAS/H,KAAKiH,MAAMc,QACpBorC,eAAgBnzC,KAAKiH,MAAMksC,iBAC3B,wBA7FZ,SAAC,GAAQ,CAACruC,KAAK,QAAQC,QAAQ,mBAsGrC,KAAC,EA/ZM,CAAShD,EAAAA,U","sources":["components/Description.tsx","components/ClinicalTrial.tsx","utils/values.ts","components/Patient.tsx","components/Study.tsx","data/uids.tsx","utils/PubSub.js","utils/CustomError.js","services/NotificationMiddleware.js","components/SlideItem.tsx","components/SlideList.tsx","components/AnnotationItem.tsx","components/AnnotationList.tsx","components/AnnotationGroupItem.tsx","components/AnnotationGroupList.tsx","components/Button.tsx","components/Equipment.tsx","utils/sr.tsx","components/Report.tsx","components/Item.tsx","data/specimens.tsx","components/SpecimenItem.tsx","components/SpecimenList.tsx","components/OpticalPathItem.tsx","components/OpticalPathList.tsx","components/MappingItem.tsx","components/MappingList.tsx","components/SegmentItem.tsx","components/SegmentList.tsx","utils/router.tsx","components/ColorSettingsMenu.tsx","components/AnnotationCategoryItem.tsx","components/AnnotationCategoryList.tsx","components/HoveredRoiTooltip.tsx","services/RoiToAnnotationAdapter.ts","utils/generateReport.ts","components/SlideViewer.tsx","data/slides.tsx","services/fetchImageMetadata.ts","hooks/useSlides.ts","components/CaseViewer.tsx","components/DicomTagBrowser/dicomTagUtils.ts","utils/formatDicomDate.ts","utils/pubSubServiceInterface.ts","utils/createSeriesMetadata.ts","utils/createStudyMetadata.ts","services/DICOMMetadataStore.ts","hooks/useDebounce.ts","components/DicomTagBrowser/DicomTagBrowser.tsx","components/Header.tsx","components/InfoPage.tsx","components/Worklist.tsx","utils/url.tsx","auth/OidcManager.tsx","utils/xhrRetryHook.ts","DicomWebManager.ts","App.tsx"],"sourcesContent":["import React from 'react'\nimport { v4 as generateUUID } from 'uuid'\nimport { Card, Descriptions } from 'antd'\n\nexport interface Attribute {\n  name: string\n  value: any\n}\n\nexport interface AttributeGroup {\n  name: string\n  attributes: Attribute[]\n}\n\ninterface DescriptionProps {\n  header?: string\n  icon?: any\n  attributes: Attribute[]\n  selectable?: boolean\n  hasLongValues?: boolean\n  methods?: React.ReactNode[]\n  children?: React.ReactNode\n}\n\n/**\n * React component for a description consisting of a header containing a\n * header and a body containing a list of name-value pairs.\n */\nclass Description extends React.Component<DescriptionProps, {}> {\n  render (): React.ReactNode {\n    let layout: 'horizontal' | 'vertical' = 'horizontal'\n    let labelLineHeight = '14px'\n    const contentLineHeight = '14px'\n    if (this.props.hasLongValues !== undefined && this.props.hasLongValues) {\n      layout = 'vertical'\n      labelLineHeight = '20px'\n    }\n    const items = this.props.attributes.map((item: Attribute, index: number) => {\n      const uid = generateUUID()\n      return (\n        <Descriptions.Item\n          key={uid}\n          label={item.name}\n          labelStyle={{\n            lineHeight: labelLineHeight\n          }}\n          contentStyle={{\n            fontWeight: 600,\n            whiteSpace: 'pre-line',\n            lineHeight: contentLineHeight\n          }}\n          span={1}\n        >\n          {item.value}\n        </Descriptions.Item>\n      )\n    })\n    let icon = null\n    if (this.props.icon !== undefined) {\n      icon = <this.props.icon />\n    }\n    return (\n      <Card\n        title={this.props.header}\n        extra={icon}\n        size='small'\n        hoverable={this.props.selectable}\n        bordered={this.props.header !== undefined}\n        actions={this.props.methods}\n      >\n        <Descriptions\n          column={1}\n          size='small'\n          layout={layout}\n          bordered={false}\n        >\n          {items}\n        </Descriptions>\n        {this.props.children}\n      </Card>\n    )\n  }\n}\n\nexport default Description\n","import React from 'react'\nimport * as dmv from 'dicom-microscopy-viewer'\n\nimport Description from './Description'\n\ninterface ClinicalTrialProps {\n  metadata: dmv.metadata.SOPClass\n}\n\n/**\n * React component representing a DICOM ClinicalTrial Information Entity that displays\n * common study-level attributes of contained DICOM Slide Microscopy images.\n */\nclass ClinicalTrial extends React.Component<ClinicalTrialProps> {\n  render (): React.ReactNode {\n    const attributes = []\n    if (this.props.metadata.ClinicalTrialSponsorName != null) {\n      // Attributes of Clinical Trial Subject module\n      attributes.push(\n        ...[\n          {\n            name: 'Sponsor Name',\n            value: this.props.metadata.ClinicalTrialSponsorName\n          },\n          {\n            name: 'Protocol ID',\n            value: this.props.metadata.ClinicalTrialProtocolID\n          },\n          {\n            name: 'Protocol Name',\n            value: this.props.metadata.ClinicalTrialProtocolName\n          },\n          {\n            name: 'Site Name',\n            value: this.props.metadata.ClinicalTrialSiteName\n          }\n        ]\n      )\n    }\n    if (this.props.metadata.ClinicalTrialTimePointID != null) {\n      // Attributes of Clinical Trial Study module\n      attributes.push(\n        {\n          name: 'Time Point ID',\n          value: this.props.metadata.ClinicalTrialTimePointID\n        }\n      )\n    }\n    // Attributes of Clinical Trial Subject module\n    return <Description attributes={attributes} />\n  }\n}\n\nexport default ClinicalTrial\n","import * as dmv from 'dicom-microscopy-viewer'\n\nfunction parseName (value: dmv.metadata.PersonName|null|undefined): string {\n  if (typeof value === 'object' && value !== null && value !== undefined) {\n    if (value.Alphabetic !== undefined) {\n      return value.Alphabetic.split('^').join(' ')\n    }\n    return ''\n  }\n  return ''\n}\n\nfunction parseDate (value: string|null|undefined): string {\n  if (value !== null && value !== undefined) {\n    const year = value.substring(0, 4)\n    const month = value.substring(4, 6)\n    const day = value.substring(6, 8)\n    return `${year}-${month}-${day}`\n  }\n  return ''\n}\n\nfunction parseTime (value: string|null|undefined): string {\n  if (value !== null && value !== undefined) {\n    const hours = value.substring(0, 2)\n    const minutes = value.substring(2, 4)\n    const seconds = value.substring(4, 6)\n    return `${hours}:${minutes}:${seconds}`\n  }\n  return ''\n}\n\nfunction parseDateTime (value: string|null|undefined): string {\n  if (value !== null && value !== undefined) {\n    const year = value.substring(0, 4)\n    const month = value.substring(4, 6)\n    const day = value.substring(6, 8)\n    const hours = value.substring(8, 10)\n    const minutes = value.substring(10, 12)\n    const seconds = value.substring(12, 14)\n    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`\n  }\n  return ''\n}\n\nfunction parseSex (value: string|null|undefined): string {\n  const lut: { [key: string]: string } = {\n    F: 'Female',\n    M: 'Male',\n    O: 'Other'\n  }\n  if (value !== null && value !== undefined) {\n    return lut[value]\n  }\n  return ''\n}\n\nexport { parseDate, parseDateTime, parseName, parseSex, parseTime }\n","import React from 'react'\nimport * as dmv from 'dicom-microscopy-viewer'\n\nimport Description from './Description'\nimport { parseName, parseSex, parseDate } from '../utils/values'\n\ninterface PatientProps {\n  metadata: dmv.metadata.Study|dmv.metadata.SOPClass\n}\n\n/**\n * React component representing a DICOM Patient Information Entity that\n * displays common study-level, patient-related attributes of contained\n * DICOM Slide Microscopy images.\n */\nclass Patient extends React.Component<PatientProps, {}> {\n  render (): React.ReactNode {\n    const attributes = [\n      {\n        name: 'ID',\n        value: this.props.metadata.PatientID\n      },\n      {\n        name: 'Name',\n        value: parseName(this.props.metadata.PatientName)\n      },\n      {\n        name: 'Sex',\n        value: parseSex(this.props.metadata.PatientSex)\n      },\n      {\n        name: 'Birthdate',\n        value: parseDate(this.props.metadata.PatientBirthDate)\n      }\n    ]\n    return (\n      <Description attributes={attributes} />\n    )\n  }\n}\n\nexport default Patient\n","import React from 'react'\nimport * as dmv from 'dicom-microscopy-viewer'\n\nimport Description from './Description'\nimport { parseDate, parseTime } from '../utils/values'\n\ninterface StudyProps {\n  metadata: dmv.metadata.Study|dmv.metadata.SOPClass\n}\n\n/**\n * React component representing a DICOM Study Information Entity that displays\n * common study-level attributes of contained DICOM Slide Microscopy images.\n */\nclass Study extends React.Component<StudyProps> {\n  render (): React.ReactNode {\n    const attributes = [\n      {\n        name: 'Accession #',\n        value: this.props.metadata.AccessionNumber\n      },\n      {\n        name: 'ID',\n        value: this.props.metadata.StudyID\n      },\n      {\n        name: 'Date',\n        value: parseDate(this.props.metadata.StudyDate)\n      },\n      {\n        name: 'Time',\n        value: parseTime(this.props.metadata.StudyTime)\n      }\n    ]\n    return <Description attributes={attributes} />\n  }\n}\n\nexport default Study\n","export enum StorageClasses {\n  VL_WHOLE_SLIDE_MICROSCOPY_IMAGE = '1.2.840.10008.5.1.4.1.1.77.1.6',\n  COMPREHENSIVE_SR = '1.2.840.10008.5.1.4.1.1.88.33',\n  COMPREHENSIVE_3D_SR = '1.2.840.10008.5.1.4.1.1.88.34',\n  SEGMENTATION = '1.2.840.10008.5.1.4.1.1.66.4',\n  MICROSCOPY_BULK_SIMPLE_ANNOTATION = '1.2.840.10008.5.1.4.1.1.91.1',\n  PARAMETRIC_MAP = '1.2.840.10008.5.1.4.1.1.30',\n  ADVANCED_BLENDING_PRESENTATION_STATE = '1.2.840.10008.5.1.4.1.1.11.8',\n  COLOR_SOFTCOPY_PRESENTATION_STATE = '1.2.840.10008.5.1.4.1.1.11.2',\n  GRAYSCALE_SOFTCOPY_PRESENTATION_STATE = '1.2.840.10008.5.1.4.1.1.11.1',\n  PSEUDOCOLOR_SOFTCOPY_PRESENTATION_STATE = '1.2.840.10008.5.1.4.1.1.11.3'\n}\n","// Use symbols to prevent exposing private attributes\nconst _subscriptions = Symbol('subscriptions')\nconst _lastSubscriptionId = Symbol('lastSubscriptionId')\n\n/**\n * Class to enable implementation of publish/subscribe pattern\n * @class\n * @classdesc Enables publishing/subscribing\n */\nexport default class PubSub {\n  constructor () {\n    this[_subscriptions] = {}\n    this[_lastSubscriptionId] = 0\n  }\n\n  /**\n   * Adds a subscription callback to the provided event name\n   * @param {string} eventName Event name that will trigger the callback\n   * @param {Function} callback Function to be executed when event is published\n   * @returns {void}\n   */\n  subscribe (eventName, callback) {\n    if (eventName === undefined) {\n      throw new Error('Trying to subscribe to an inexistent event')\n    }\n\n    if (typeof callback !== 'function') {\n      throw new Error('The provided callback must be a function')\n    }\n\n    if (!this[_subscriptions].hasOwnProperty(eventName)) {\n      this[_subscriptions][eventName] = {}\n    }\n\n    const subscriptionId = `sub${this[_lastSubscriptionId]++}`\n    this[_subscriptions][eventName][subscriptionId] = callback\n  }\n\n  /**\n   * Removes a subscription callback for the provided event name\n   * @param {string} eventName Event name for the registerd callback\n   * @param {Function} [callback] Function to have its subscription removed\n   * @returns {void}\n   */\n  unsubscribe (eventName, callback) {\n    const callbacks = this[_subscriptions][eventName] || {}\n    for (const subscriptionId in callbacks) {\n      if (!callback) {\n        delete callbacks[subscriptionId]\n      } else if (callbacks[subscriptionId] === callback) {\n        delete callbacks[subscriptionId]\n      }\n    }\n  }\n\n  /**\n   * Trigger all registered subscription callbacks for a specific event name\n   * @param {String} eventName Event name to trigger subscriptions from\n   * @param {any} [payload] Payload that will be passed to the callback fuction\n   * @returns {void}\n   */\n  publish (eventName, ...payload) {\n    if (eventName === undefined) {\n      throw new Error('Trying to publish an inexistent event')\n    }\n\n    const callbacks = this[_subscriptions][eventName] || {}\n    for (const subscriptionId in callbacks) {\n      callbacks[subscriptionId](...payload)\n    }\n  }\n\n  /**\n   * Cleares all subscriptions for current instance\n   * @returns {void}\n   */\n  unsubscribeFromAll () {\n    for (const eventName in this[_subscriptions]) {\n      const callbacks = this[_subscriptions][eventName]\n      for (const subscriptionId in callbacks) {\n        delete callbacks[subscriptionId]\n      }\n    }\n  }\n}\n","const errorTypes = {\n  AUTHENTICATION: 'Authentication',\n  COMMUNICATION: 'Communication',\n  ENCODINGANDDECODING: 'EncodingDecoding',\n  VISUALIZATION: 'Visualization'\n}\n\nclass CustomError extends Error {\n  constructor (type, message) {\n    super()\n    this.message = message\n    this.stack = new Error().stack\n    this.type = type\n  }\n}\n\nexport { errorTypes, CustomError }\n","import PubSub from '../utils/PubSub'\nimport { notification } from 'antd'\nimport { CustomError, errorTypes } from '../utils/CustomError'\n\nexport const NotificationMiddlewareEvents = {\n  OnError: 'onError',\n  OnWarning: 'onWarning'\n}\n\nexport const NotificationMiddlewareContext = {\n  DICOMWEB: 'dicomweb-client',\n  DMV: 'dicom-microscopy-viewer',\n  DCMJS: 'dcmjs',\n  SLIM: 'slim',\n  AUTH: 'authentication'\n}\n\nconst NotificationType = {\n  TOAST: 'toast',\n  CONSOLE: 'console'\n}\n\n/* Sources of Error:\n  1. 'dicomweb-client': Error while requesting/fetching data, tagged as 'Communication'\n  2. 'slim' and 'dicom-microscopy-viewer' library: Error related to dicom data encoding/decoding,\n  could directly/indirectly impact image-related visualization, tagged as 'Visualization' or\n  'Encoding/Decoding' accordingly\n  3. 'dcmjs' library: Data parsing error, tagged as 'DICOMError'\n  4. 'authentication': Error during user authentication, tagged as 'Authentication'\n  */\nconst NotificationSourceDefinition = {\n  sources: [\n    {\n      category: errorTypes.AUTHENTICATION,\n      notificationType: NotificationType.TOAST\n    },\n    {\n      category: errorTypes.COMMUNICATION,\n      notificationType: NotificationType.TOAST\n    },\n    {\n      category: errorTypes.VISUALIZATION,\n      notificationType: NotificationType.TOAST\n    },\n    {\n      category: errorTypes.ENCODINGANDDECODING,\n      notificationType: NotificationType.CONSOLE\n    },\n    {\n      category: 'Warning',\n      notificationType: NotificationType.TOAST\n    }\n  ]\n}\n\nclass NotificationMiddleware extends PubSub {\n  constructor () {\n    super()\n\n    const outerContext = (args) => {\n      this.publish(NotificationMiddlewareEvents.OnWarning, Array.from(args).join(' '))\n    }\n\n    (function () {\n      const warn = console.warn\n      console.warn = function () {\n        if (!JSON.stringify(arguments).includes('request')) {\n          outerContext(arguments)\n        }\n        warn.apply(this, Array.prototype.slice.call(arguments))\n      }\n    }())\n  }\n\n  /**\n   * Error handling middleware function\n   *\n   * @param source - source of error - dicomweb-client, dmv, dcmjs or slim itself\n   * @param error - error object\n   */\n  onError (source, error) {\n    const errorCategory = error.type\n    const sourceConfig = NotificationSourceDefinition.sources.find(\n      s => s.category === errorCategory\n    )\n\n    const { notificationType } = sourceConfig\n\n    this.publish(NotificationMiddlewareEvents.OnError, {\n      source,\n      error\n    })\n\n    let notificationMsg\n    if (error instanceof CustomError) {\n      notificationMsg = error.message\n    } else {\n      notificationMsg = String(error)\n    }\n\n    switch (notificationType) {\n      case NotificationType.TOAST:\n        console.error(`A ${errorCategory} error occurred: `, error)\n        return notification.error({\n          message: `${errorCategory} error`,\n          description: notificationMsg,\n          duration: 3\n        })\n\n      case NotificationType.CONSOLE:\n        console.error(`A ${errorCategory} error occurred: `, error)\n        break\n\n      default:\n    }\n  }\n}\n\nexport default new NotificationMiddleware()\n","import React from 'react'\nimport { FaSpinner } from 'react-icons/fa'\nimport * as dmv from 'dicom-microscopy-viewer'\nimport { Menu } from 'antd'\n\nimport DicomWebManager from '../DicomWebManager'\nimport Description from './Description'\nimport { Slide } from '../data/slides'\nimport { StorageClasses } from '../data/uids'\nimport NotificationMiddleware, {\n  NotificationMiddlewareContext\n} from '../services/NotificationMiddleware'\nimport { CustomError } from '../utils/CustomError'\n\ninterface SlideItemProps {\n  clients: { [key: string]: DicomWebManager }\n  slide: Slide\n}\n\ninterface SlideItemState {\n  isLoading: boolean\n}\n\n/**\n * React component representing a DICOM Series Information Entity that displays\n * common series-level attributes of contained DICOM Slide Microscopy images\n * as well as the OVERVIEW image (if available).\n * When selected a Slide Viewer instance is created for the display of the\n * contained images.\n */\nclass SlideItem extends React.Component<SlideItemProps, SlideItemState> {\n  state = { isLoading: false }\n\n  private readonly overviewViewportRef = React.createRef<HTMLDivElement>()\n\n  private overviewViewer?: dmv.viewer.OverviewImageViewer\n\n  constructor (props: SlideItemProps) {\n    super(props)\n    this.overviewViewer = undefined\n  }\n\n  componentDidMount (): void {\n    this.setState({ isLoading: true })\n    if (this.props.slide.overviewImages.length > 0) {\n      const metadata = this.props.slide.overviewImages[0]\n      if (this.overviewViewportRef.current !== null) {\n        this.overviewViewportRef.current.innerHTML = ''\n        console.info(\n          'instantiate viewer for OVERVIEW image of slide ' +\n          `\"${metadata.ContainerIdentifier}\"`\n        )\n        this.overviewViewer = new dmv.viewer.OverviewImageViewer({\n          client: this.props.clients[\n            StorageClasses.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE\n          ],\n          disableInteractions: true,\n          metadata,\n          resizeFactor: 1,\n          errorInterceptor: (error: CustomError) => {\n            NotificationMiddleware.onError(\n              NotificationMiddlewareContext.DMV,\n              error\n            )\n          }\n        })\n        this.overviewViewer.render({\n          container: this.overviewViewportRef.current\n        })\n      }\n    }\n\n    this.setState({ isLoading: false })\n  }\n\n  render (): React.ReactNode {\n    if (this.overviewViewer !== undefined) {\n      this.overviewViewer.resize()\n    }\n\n    const attributes = []\n    const description = this.props.slide.description\n    if (description !== null && description !== '') {\n      attributes.push({\n        name: 'Description',\n        value: description\n      })\n    }\n\n    if (this.state.isLoading) {\n      return (<FaSpinner />)\n    }\n\n    /* Properties need to be propagated down to Menu.Item:\n     * https://github.com/react-component/menu/issues/142\n     */\n    return (\n      <Menu.Item\n        style={{ height: '100%' }}\n        key={this.props.slide.seriesInstanceUIDs[0]}\n        {...this.props}\n      >\n        <Description\n          header={this.props.slide.containerIdentifier}\n          attributes={attributes}\n          selectable\n        >\n          {this.props.slide.overviewImages.length > 0\n            ? (\n              <div style={{ height: '100px' }} ref={this.overviewViewportRef} />\n              )\n            : (\n              <div style={{\n                height: '100px',\n                textAlign: 'center',\n                display: 'flex',\n                alignItems: 'center',\n                justifyContent: 'center',\n                fontSize: '1.5rem',\n                fontWeight: 300,\n                color: '#8F9BA8',\n                letterSpacing: '0.1em'\n              }}\n              >\n                SM\n              </div>\n              )}\n        </Description>\n      </Menu.Item>\n    )\n  }\n}\n\nexport default SlideItem\n","import React from 'react'\nimport { Menu } from 'antd'\n\nimport DicomWebManager from '../DicomWebManager'\nimport SlideItem from './SlideItem'\nimport { Slide } from '../data/slides'\n\ninterface SlideListProps {\n  metadata: Slide[]\n  clients: { [key: string]: DicomWebManager }\n  selectedSeriesInstanceUID: string\n  onSeriesSelection: (\n    { seriesInstanceUID }: { seriesInstanceUID: string }\n  ) => void\n}\n\ninterface SlideListState {\n  selectedSeriesInstanceUID: string\n}\n\n/**\n * React component representing a list of DICOM Series Information Entities.\n */\nclass SlideList extends React.Component<SlideListProps, SlideListState> {\n  state = {\n    selectedSeriesInstanceUID: this.props.selectedSeriesInstanceUID\n  }\n\n  componentDidMount (): void {\n    this.props.onSeriesSelection({\n      seriesInstanceUID: this.state.selectedSeriesInstanceUID\n    })\n  }\n\n  render (): React.ReactNode {\n    const slideList = this.props.metadata\n    const slideItemList = []\n    for (let i = 0; i < slideList.length; ++i) {\n      const slide = slideList[i]\n      const slideItem = (\n        <SlideItem\n          key={slide.seriesInstanceUIDs[0]}\n          slide={slide}\n          clients={this.props.clients}\n        />\n      )\n\n      slideItemList.push(slideItem)\n    }\n\n    const handleMenuItemSelection = ({ key, keyPath, domEvent, selectedKeys }: {\n      key: React.ReactText\n      keyPath: React.ReactText[]\n      domEvent: React.MouseEvent<HTMLElement> | React.KeyboardEvent<HTMLElement>\n      selectedKeys?: React.ReactText[]\n    }): void => {\n      console.info(`select slide \"${key}\"`)\n      this.setState({ selectedSeriesInstanceUID: key.toString() })\n      this.props.onSeriesSelection({ seriesInstanceUID: key.toString() })\n    }\n\n    let selectedKeys\n    if (this.state.selectedSeriesInstanceUID !== undefined &&\n      this.state.selectedSeriesInstanceUID !== null) {\n      selectedKeys = [this.state.selectedSeriesInstanceUID]\n    }\n\n    return (\n      <Menu\n        style={{ width: '100%' }}\n        selectedKeys={selectedKeys}\n        onSelect={handleMenuItemSelection}\n        mode='inline'\n        inlineIndent={0}\n      >\n        {slideItemList}\n      </Menu>\n    )\n  }\n}\n\nexport default SlideList\n","import React from 'react'\nimport * as dmv from 'dicom-microscopy-viewer'\nimport * as dcmjs from 'dcmjs'\nimport { Menu, Space, Switch } from 'antd'\nimport { FaEye, FaEyeSlash } from 'react-icons/fa'\n\nimport Description from './Description'\n\ninterface AnnotationItemProps {\n  roi: dmv.roi.ROI\n  index: number\n  isVisible: boolean\n  onVisibilityChange: ({ roiUID, isVisible }: {\n    roiUID: string\n    isVisible: boolean\n  }) => void\n}\n\n/**\n * React component representing a Region of Interest (ROI) annotation.\n */\nclass AnnotationItem extends React.Component<AnnotationItemProps, {}> {\n  constructor (props: AnnotationItemProps) {\n    super(props)\n    this.handleVisibilityChange = this.handleVisibilityChange.bind(this)\n  }\n\n  handleVisibilityChange (\n    checked: boolean,\n    event: React.MouseEvent<HTMLButtonElement>\n  ): void {\n    this.props.onVisibilityChange({\n      roiUID: this.props.roi.uid,\n      isVisible: checked\n    })\n  }\n\n  render (): React.ReactNode {\n    const identifier = `ROI ${this.props.index + 1}`\n    const attributes: Array<{ name: string, value: string }> = []\n    /**\n     * This hack is required for Menu.Item to work properly:\n     * https://github.com/react-component/menu/issues/142\n     */\n    const { isVisible, onVisibilityChange, ...otherProps } = this.props\n    this.props.roi.evaluations.forEach((\n      item: (\n        dcmjs.sr.valueTypes.TextContentItem |\n        dcmjs.sr.valueTypes.CodeContentItem\n      )\n    ) => {\n      const nameValue = item.ConceptNameCodeSequence[0].CodeValue\n      const nameMeaning = item.ConceptNameCodeSequence[0].CodeMeaning\n      const name = `${nameMeaning}`\n      if (item.ValueType === dcmjs.sr.valueTypes.ValueTypes.CODE) {\n        const codeContentItem = item as dcmjs.sr.valueTypes.CodeContentItem\n        const valueMeaning = codeContentItem.ConceptCodeSequence[0].CodeMeaning\n        // For consistency with Segment and Annotation Group\n        if (nameValue === '276214006') {\n          attributes.push({\n            name: 'Property category',\n            value: `${valueMeaning}`\n          })\n        } else if (nameValue === '121071') {\n          attributes.push({\n            name: 'Property type',\n            value: `${valueMeaning}`\n          })\n        } else if (nameValue === '111001') {\n          attributes.push({\n            name: 'Algorithm Name',\n            value: `${valueMeaning}`\n          })\n        } else {\n          attributes.push({\n            name: name,\n            value: `${valueMeaning}`\n          })\n        }\n      } else if (item.ValueType === dcmjs.sr.valueTypes.ValueTypes.TEXT) {\n        const textContentItem = item as dcmjs.sr.valueTypes.TextContentItem\n        attributes.push({\n          name: name,\n          value: textContentItem.TextValue\n        })\n      }\n    })\n    this.props.roi.measurements.forEach(item => {\n      const nameMeaning = item.ConceptNameCodeSequence[0].CodeMeaning\n      const name = `${nameMeaning}`\n      const seq = item.MeasuredValueSequence[0]\n      const value = seq.NumericValue.toPrecision(6)\n      const unit = seq.MeasurementUnitsCodeSequence[0].CodeValue\n      attributes.push({\n        name: name,\n        value: `${value} ${unit}`\n      })\n    })\n    return (\n      <Space align='start'>\n        <div style={{ paddingLeft: '14px' }}>\n          <Switch\n            size='small'\n            onChange={this.handleVisibilityChange}\n            checked={this.props.isVisible}\n            checkedChildren={<FaEye />}\n            unCheckedChildren={<FaEyeSlash />}\n          />\n        </div>\n        <Menu.Item\n          style={{ height: '100%', paddingLeft: '3px' }}\n          key={this.props.roi.uid}\n          {...otherProps}\n        >\n          <Description\n            header={identifier}\n            attributes={attributes}\n            selectable\n            hasLongValues\n          />\n        </Menu.Item>\n      </Space>\n    )\n  }\n}\n\nexport default AnnotationItem\n","import React from 'react'\nimport * as dmv from 'dicom-microscopy-viewer'\nimport { Menu, Switch } from 'antd'\nimport { FaEye, FaEyeSlash } from 'react-icons/fa'\n\nimport AnnotationItem from './AnnotationItem'\n\ninterface AnnotationListProps {\n  rois: dmv.roi.ROI[]\n  selectedRoiUIDs: Set<string>\n  visibleRoiUIDs: Set<string>\n  onVisibilityChange: ({ roiUID, isVisible }: {\n    roiUID: string\n    isVisible: boolean\n  }) => void\n  onSelection: (uid: string) => void\n}\n\n/**\n * React component representing a list of Region of Interest (ROI)\n * annotations.\n */\nclass AnnotationList extends React.Component<AnnotationListProps, {}> {\n  constructor (props: AnnotationListProps) {\n    super(props)\n    this.handleMenuItemSelection = this.handleMenuItemSelection.bind(this)\n    this.handleVisibilityChange = this.handleVisibilityChange.bind(this)\n  }\n\n  handleVisibilityChange (\n    checked: boolean,\n    event: React.MouseEvent<HTMLButtonElement>\n  ): void {\n    if (checked) {\n      this.props.rois.forEach(roi => {\n        this.props.onVisibilityChange({ roiUID: roi.uid, isVisible: checked })\n      })\n    } else {\n      this.props.visibleRoiUIDs.forEach(roiUID => {\n        this.props.onVisibilityChange({ roiUID, isVisible: checked })\n      })\n    }\n  }\n\n  handleMenuItemSelection (object: any): void {\n    this.props.onSelection(object.key)\n  }\n\n  render (): React.ReactNode {\n    const items = this.props.rois.map((roi, index) => (\n      <AnnotationItem\n        key={roi.uid}\n        roi={roi}\n        index={index}\n        isVisible={this.props.visibleRoiUIDs.has(roi.uid)}\n        onVisibilityChange={this.props.onVisibilityChange}\n      />\n    ))\n\n    return (\n      <>\n        <div style={{ paddingLeft: '14px', paddingTop: '7px', paddingBottom: '7px' }}>\n          <Switch\n            size='small'\n            onChange={this.handleVisibilityChange}\n            checked={this.props.visibleRoiUIDs.size > 0}\n            checkedChildren={<FaEye />}\n            unCheckedChildren={<FaEyeSlash />}\n          />\n        </div>\n        <Menu\n          selectedKeys={[...this.props.selectedRoiUIDs.values()]}\n          onSelect={this.handleMenuItemSelection}\n          onClick={this.handleMenuItemSelection}\n        >\n          {items}\n        </Menu>\n      </>\n    )\n  }\n}\n\nexport default AnnotationList\n","import React from 'react'\nimport {\n  Badge,\n  Button,\n  Col,\n  Divider,\n  InputNumber,\n  Menu,\n  Popover,\n  Row,\n  Select,\n  Slider,\n  Space,\n  Switch\n} from 'antd'\nimport { SettingOutlined } from '@ant-design/icons'\nimport { FaEye, FaEyeSlash } from 'react-icons/fa'\nimport * as dmv from 'dicom-microscopy-viewer'\nimport * as dcmjs from 'dcmjs'\n\nimport Description from './Description'\n\ninterface AnnotationGroupItemProps {\n  annotationGroup: dmv.annotation.AnnotationGroup\n  isVisible: boolean\n  metadata: dmv.metadata.MicroscopyBulkSimpleAnnotations\n  defaultStyle: {\n    opacity: number\n    color: number[]\n  }\n  onAnnotationGroupClick: (annotationGroupUID: string) => void\n  onVisibilityChange: ({ annotationGroupUID, isVisible }: {\n    annotationGroupUID: string\n    isVisible: boolean\n  }) => void\n  onStyleChange: ({ uid, styleOptions }: {\n    uid: string\n    styleOptions: {\n      opacity?: number\n      color?: number[]\n      limitValues?: number[]\n      measurement?: dcmjs.sr.coding.CodedConcept\n    }\n  }) => void\n}\n\ninterface AnnotationGroupItemState {\n  isVisible: boolean\n  currentStyle: {\n    opacity: number\n    color?: number[]\n    limitValues?: number[]\n    measurement?: dcmjs.sr.coding.CodedConcept\n  }\n}\n\n/**\n * React component representing an Annotation Group.\n */\nclass AnnotationGroupItem extends React.Component<AnnotationGroupItemProps, AnnotationGroupItemState> {\n  constructor (props: AnnotationGroupItemProps) {\n    super(props)\n    this.handleVisibilityChange = this.handleVisibilityChange.bind(this)\n    this.handleMeasurementSelection = this.handleMeasurementSelection.bind(this)\n    this.handleOpacityChange = this.handleOpacityChange.bind(this)\n    this.handleColorRChange = this.handleColorRChange.bind(this)\n    this.handleColorGChange = this.handleColorGChange.bind(this)\n    this.handleColorBChange = this.handleColorBChange.bind(this)\n    this.getCurrentColor = this.getCurrentColor.bind(this)\n    this.handleAnnotationGroupClick = this.handleAnnotationGroupClick.bind(this)\n    this.state = {\n      isVisible: this.props.isVisible,\n      currentStyle: {\n        opacity: this.props.defaultStyle.opacity,\n        color: this.props.defaultStyle.color\n      }\n    }\n  }\n\n  handleVisibilityChange (\n    checked: boolean,\n    event: React.MouseEvent<HTMLButtonElement>\n  ): void {\n    this.props.onVisibilityChange({\n      annotationGroupUID: this.props.annotationGroup.uid,\n      isVisible: checked\n    })\n    this.setState({ isVisible: checked })\n  }\n\n  handleOpacityChange (value: number | null): void {\n    if (value != null) {\n      this.props.onStyleChange({\n        uid: this.props.annotationGroup.uid,\n        styleOptions: {\n          opacity: value\n        }\n      })\n      this.setState({\n        currentStyle: {\n          opacity: value,\n          color: this.state.currentStyle.color,\n          limitValues: this.state.currentStyle.limitValues\n        }\n      })\n    }\n  }\n\n  handleColorRChange (\n    value: number | number[] | null\n  ): void {\n    if (value != null && this.state.currentStyle.color !== undefined) {\n      const color = [\n        Array.isArray(value) ? value[0] : value,\n        this.state.currentStyle.color[1],\n        this.state.currentStyle.color[2]\n      ]\n      this.setState(state => ({\n        currentStyle: {\n          color: color,\n          opacity: state.currentStyle.opacity,\n          limitValues: state.currentStyle.limitValues\n        }\n      }))\n      this.props.onStyleChange({\n        uid: this.props.annotationGroup.uid,\n        styleOptions: { color: color }\n      })\n    }\n  }\n\n  handleColorGChange (\n    value: number | number[] | null\n  ): void {\n    if (value != null && this.state.currentStyle.color !== undefined) {\n      const color = [\n        this.state.currentStyle.color[0],\n        Array.isArray(value) ? value[0] : value,\n        this.state.currentStyle.color[2]\n      ]\n      this.setState(state => ({\n        currentStyle: {\n          color: color,\n          opacity: state.currentStyle.opacity,\n          limitValues: state.currentStyle.limitValues\n        }\n      }))\n      this.props.onStyleChange({\n        uid: this.props.annotationGroup.uid,\n        styleOptions: { color: color }\n      })\n    }\n  }\n\n  handleColorBChange (\n    value: number | number[] | null\n  ): void {\n    if (value != null && this.state.currentStyle.color !== undefined) {\n      const color = [\n        this.state.currentStyle.color[0],\n        this.state.currentStyle.color[1],\n        Array.isArray(value) ? value[0] : value\n      ]\n      this.setState(state => ({\n        currentStyle: {\n          color: color,\n          opacity: state.currentStyle.opacity,\n          limitValues: state.currentStyle.limitValues\n        }\n      }))\n      this.props.onStyleChange({\n        uid: this.props.annotationGroup.uid,\n        styleOptions: { color: color }\n      })\n    }\n  }\n\n  getCurrentColor (): string {\n    const rgb2hex = (values: number[]): string => {\n      const r = values[0]\n      const g = values[1]\n      const b = values[2]\n      return '#' + (0x1000000 + (r << 16) + (g << 8) + b).toString(16).slice(1)\n    }\n\n    if (this.state.currentStyle.color != null) {\n      return rgb2hex(this.state.currentStyle.color)\n    } else {\n      return 'white'\n    }\n  }\n\n  handleLowerLimitChange (\n    value: number | null\n  ): void {\n    if (value != null && this.state.currentStyle.limitValues !== undefined) {\n      this.setState(state => {\n        if (state.currentStyle.limitValues !== undefined) {\n          return {\n            currentStyle: {\n              color: state.currentStyle.color,\n              opacity: state.currentStyle.opacity,\n              limitValues: [value, state.currentStyle.limitValues[1]]\n            }\n          }\n        } else {\n          return {\n            currentStyle: {\n              color: state.currentStyle.color,\n              opacity: state.currentStyle.opacity,\n              limitValues: state.currentStyle.limitValues\n            }\n          }\n        }\n      })\n      this.props.onStyleChange({\n        uid: this.props.annotationGroup.uid,\n        styleOptions: {\n          limitValues: [\n            value,\n            this.state.currentStyle.limitValues[1]\n          ]\n        }\n      })\n    }\n  }\n\n  handleUpperLimitChange (\n    value: number | null\n  ): void {\n    if (value != null && this.state.currentStyle.limitValues !== undefined) {\n      this.setState(state => {\n        if (state.currentStyle.limitValues !== undefined) {\n          return {\n            currentStyle: {\n              color: state.currentStyle.color,\n              opacity: state.currentStyle.opacity,\n              limitValues: [state.currentStyle.limitValues[0], value]\n            }\n          }\n        } else {\n          return {\n            currentStyle: {\n              color: state.currentStyle.color,\n              opacity: state.currentStyle.opacity,\n              limitValues: state.currentStyle.limitValues\n            }\n          }\n        }\n      })\n      this.props.onStyleChange({\n        uid: this.props.annotationGroup.uid,\n        styleOptions: {\n          limitValues: [\n            this.state.currentStyle.limitValues[0],\n            value\n          ]\n        }\n      })\n    }\n  }\n\n  handleLimitChange (\n    values: number[]\n  ): void {\n    this.setState(state => ({\n      currentStyle: {\n        color: state.currentStyle.color,\n        opacity: state.currentStyle.opacity,\n        limitValues: values\n      }\n    }))\n    this.props.onStyleChange({\n      uid: this.props.annotationGroup.uid,\n      styleOptions: { limitValues: values }\n    })\n  }\n\n  handleAnnotationGroupClick (): void {\n    this.props.onAnnotationGroupClick(this.props.annotationGroup.uid)\n  }\n\n  handleMeasurementSelection (value?: string, option?: any): void {\n    if (value != null && option.children != null) {\n      const codeComponents = value.split('-')\n      const measurement = new dcmjs.sr.coding.CodedConcept({\n        value: codeComponents[1],\n        schemeDesignator: codeComponents[0],\n        meaning: option.children\n      })\n      this.props.onStyleChange({\n        uid: this.props.annotationGroup.uid,\n        styleOptions: { measurement }\n      })\n      this.setState(state => ({\n        currentStyle: {\n          opacity: state.currentStyle.opacity,\n          measurement\n        }\n      }))\n    } else {\n      this.props.onStyleChange({\n        uid: this.props.annotationGroup.uid,\n        styleOptions: {\n          color: this.props.defaultStyle.color\n        }\n      })\n      this.setState(state => ({\n        currentStyle: {\n          opacity: state.currentStyle.opacity,\n          color: this.props.defaultStyle.color,\n          limitValues: undefined\n        }\n      }))\n    }\n  }\n\n  render (): React.ReactNode {\n    const index = this.props.metadata.AnnotationGroupSequence.findIndex(\n      item => (item.AnnotationGroupUID === this.props.annotationGroup.uid)\n    )\n    const item = this.props.metadata.AnnotationGroupSequence[index]\n    const attributes: Array<{ name: string, value: string }> = [\n      {\n        name: 'Property type',\n        value: this.props.annotationGroup.propertyType.CodeMeaning\n      },\n      {\n        name: 'Property category',\n        value: this.props.annotationGroup.propertyCategory.CodeMeaning\n      },\n      // {\n      //   name: 'Algorithm Name',\n      //   value: this.props.annotationGroup.algorithmName\n      // },\n      {\n        name: 'Graphic type',\n        value: item.GraphicType\n      },\n      {\n        name: 'Annotation coordinate type',\n        value: this.props.metadata.AnnotationCoordinateType\n      }\n    ]\n\n    const measurementsSequence = item.MeasurementsSequence ?? []\n    const measurementOptions = measurementsSequence.map((measurementItem, i) => {\n      const name = measurementItem.ConceptNameCodeSequence[0]\n      return (\n        <Select.Option\n          key={i}\n          value={`${name.CodingSchemeDesignator}-${name.CodeValue}`}\n          dropdownMatchSelectWidth={false}\n          size='small'\n          disabled={!this.props.isVisible}\n        >\n          {name.CodeMeaning}\n        </Select.Option>\n      )\n    })\n    measurementOptions.push(\n      <Select.Option\n        key='-'\n        value={undefined}\n        dropdownMatchSelectWidth={false}\n        size='small'\n        disabled={!this.props.isVisible}\n      >\n        <></>\n      </Select.Option>\n    )\n\n    let colorSettings\n    if (this.state.currentStyle.color != null) {\n      colorSettings = (\n        <>\n          <Divider plain>\n            Color\n          </Divider>\n          <Row justify='center' align='middle' gutter={[8, 8]}>\n            <Col span={5}>\n              Red\n            </Col>\n            <Col span={14}>\n              <Slider\n                range={false}\n                min={0}\n                max={255}\n                step={1}\n                value={this.state.currentStyle.color[0]}\n                onChange={this.handleColorRChange}\n              />\n            </Col>\n            <Col span={5}>\n              <InputNumber\n                min={0}\n                max={255}\n                size='small'\n                style={{ width: '65px' }}\n                value={this.state.currentStyle.color[0]}\n                onChange={this.handleColorRChange}\n              />\n            </Col>\n          </Row>\n\n          <Row justify='center' align='middle' gutter={[8, 8]}>\n            <Col span={5}>\n              Green\n            </Col>\n            <Col span={14}>\n              <Slider\n                range={false}\n                min={0}\n                max={255}\n                step={1}\n                value={this.state.currentStyle.color[1]}\n                onChange={this.handleColorGChange}\n              />\n            </Col>\n            <Col span={5}>\n              <InputNumber\n                min={0}\n                max={255}\n                size='small'\n                style={{ width: '65px' }}\n                value={this.state.currentStyle.color[1]}\n                onChange={this.handleColorGChange}\n              />\n            </Col>\n          </Row>\n\n          <Row justify='center' align='middle' gutter={[8, 8]}>\n            <Col span={5}>\n              Blue\n            </Col>\n            <Col span={14}>\n              <Slider\n                range={false}\n                min={0}\n                max={255}\n                step={1}\n                value={this.state.currentStyle.color[2]}\n                onChange={this.handleColorBChange}\n              />\n            </Col>\n            <Col span={5}>\n              <InputNumber\n                min={0}\n                max={255}\n                size='small'\n                style={{ width: '65px' }}\n                value={this.state.currentStyle.color[2]}\n                onChange={this.handleColorBChange}\n              />\n            </Col>\n          </Row>\n          <Divider plain />\n        </>\n      )\n    }\n\n    let windowSettings\n    let explorationSettings\n    if (measurementsSequence.length > 0) {\n      if (this.state.currentStyle.limitValues != null) {\n        // TODO: need to get default min/max values from viewer first\n        const minValue = 0\n        const maxValue = 1000\n        windowSettings = (\n          <>\n            <Divider plain>\n              Values of interest\n            </Divider>\n            <Row justify='center' align='middle' gutter={[8, 8]}>\n              <Col span={6}>\n                <InputNumber\n                  min={0}\n                  max={this.state.currentStyle.limitValues[1]}\n                  size='small'\n                  style={{ width: '75px' }}\n                  value={this.state.currentStyle.limitValues[0]}\n                  onChange={this.handleLowerLimitChange}\n                />\n              </Col>\n              <Col span={12}>\n                <Slider\n                  range\n                  min={minValue}\n                  max={maxValue}\n                  step={1}\n                  value={[\n                    this.state.currentStyle.limitValues[0],\n                    this.state.currentStyle.limitValues[1]\n                  ]}\n                  onChange={this.handleLimitChange}\n                />\n              </Col>\n              <Col span={6}>\n                <InputNumber\n                  min={this.state.currentStyle.limitValues[0]}\n                  max={maxValue}\n                  size='small'\n                  style={{ width: '75px' }}\n                  value={this.state.currentStyle.limitValues[1]}\n                  onChange={this.handleUpperLimitChange}\n                />\n              </Col>\n            </Row>\n          </>\n        )\n      }\n      explorationSettings = (\n        <>\n          <Divider plain>\n            Exploration\n          </Divider>\n          <Row justify='start' align='middle' gutter={[8, 8]}>\n            <Col span={8}>\n              Measurement\n            </Col>\n            <Col span={16}>\n              <Select\n                style={{ minWidth: '65px', width: '90%' }}\n                onSelect={this.handleMeasurementSelection}\n                key='annotation-group-measurements'\n                defaultValue={undefined}\n              >\n                {measurementOptions}\n              </Select>\n            </Col>\n          </Row>\n        </>\n      )\n    }\n\n    const settings = (\n      <div>\n        {colorSettings}\n        {windowSettings}\n        <Row justify='start' align='middle' gutter={[8, 8]}>\n          <Col span={6}>\n            Opacity\n          </Col>\n          <Col span={12}>\n            <Slider\n              range={false}\n              min={0}\n              max={1}\n              step={0.01}\n              value={this.state.currentStyle.opacity}\n              onChange={this.handleOpacityChange}\n            />\n          </Col>\n          <Col span={6}>\n            <InputNumber\n              min={0}\n              max={1}\n              size='small'\n              step={0.1}\n              style={{ width: '65px' }}\n              value={this.state.currentStyle.opacity}\n              onChange={this.handleOpacityChange}\n            />\n          </Col>\n        </Row>\n        {explorationSettings}\n      </div>\n    )\n\n    const color = this.getCurrentColor()\n    const isBadgeVisible = (\n      this.state.isVisible && this.state.currentStyle.measurement == null\n    )\n    const {\n      annotationGroup,\n      defaultStyle,\n      isVisible,\n      metadata,\n      onVisibilityChange,\n      onStyleChange,\n      ...otherProps\n    } = this.props\n    return (\n      <Menu.Item\n        style={{ height: '100%', paddingLeft: '3px' }}\n        key={this.props.annotationGroup.uid}\n        onClick={this.handleAnnotationGroupClick}\n        {...otherProps}\n      >\n        <Space align='start'>\n          <div style={{ paddingLeft: '14px' }}>\n            <Space direction='vertical' align='end'>\n              <Switch\n                size='small'\n                onChange={this.handleVisibilityChange}\n                checked={this.props.isVisible}\n                checkedChildren={<FaEye />}\n                unCheckedChildren={<FaEyeSlash />}\n              />\n              <Popover\n                placement='left'\n                content={settings}\n                overlayStyle={{ width: '350px' }}\n                title='Display Settings'\n              >\n                <Button\n                  type='primary'\n                  shape='circle'\n                  icon={<SettingOutlined />}\n                />\n              </Popover>\n            </Space>\n          </div>\n          <Badge\n            offset={[-20, 20]}\n            count={' '}\n            style={{\n              borderStyle: 'solid',\n              borderWidth: '1px',\n              borderColor: 'gray',\n              visibility: isBadgeVisible ? 'visible' : 'hidden',\n              backgroundImage: `linear-gradient(to bottom, ${color}, ${color}`\n            }}\n          >\n            <Description\n              header={this.props.annotationGroup.label}\n              attributes={attributes}\n              selectable\n              hasLongValues\n            />\n          </Badge>\n        </Space>\n      </Menu.Item>\n    )\n  }\n}\n\nexport default AnnotationGroupItem\n","import React from 'react'\nimport { Menu, Switch } from 'antd'\nimport * as dmv from 'dicom-microscopy-viewer'\nimport * as dcmjs from 'dcmjs'\n\nimport AnnotationGroupItem from './AnnotationGroupItem'\nimport { FaEye, FaEyeSlash } from 'react-icons/fa'\n\ninterface AnnotationGroupListProps {\n  annotationGroups: dmv.annotation.AnnotationGroup[]\n  visibleAnnotationGroupUIDs: Set<string>\n  metadata: {\n    [annotationGroupUID: string]: dmv.metadata.MicroscopyBulkSimpleAnnotations\n  }\n  defaultAnnotationGroupStyles: {\n    [annotationGroupUID: string]: {\n      opacity: number\n      color: number[]\n    }\n  }\n  onAnnotationGroupClick: (annotationGroupUID: string) => void\n  onAnnotationGroupVisibilityChange: ({\n    annotationGroupUID,\n    isVisible\n  }: {\n    annotationGroupUID: string\n    isVisible: boolean\n  }) => void\n  onAnnotationGroupStyleChange: ({\n    uid,\n    styleOptions\n  }: {\n    uid: string\n    styleOptions: {\n      opacity?: number\n      color?: number[]\n      measurement?: dcmjs.sr.coding.CodedConcept\n    }\n  }) => void\n}\n\n/**\n * React component representing a list of Annotation Groups.\n */\nclass AnnotationGroupList extends React.Component<\nAnnotationGroupListProps,\nunknown\n> {\n  handleVisibilityChange = (checked: boolean): void => {\n    if (checked) {\n      this.props.annotationGroups.forEach((annotationGroup) => {\n        this.props.onAnnotationGroupVisibilityChange({\n          annotationGroupUID: annotationGroup.uid,\n          isVisible: checked\n        })\n      })\n      return\n    }\n\n    this.props.visibleAnnotationGroupUIDs.forEach((annotationGroupUID) => {\n      this.props.onAnnotationGroupVisibilityChange({\n        annotationGroupUID,\n        isVisible: checked\n      })\n    })\n  }\n\n  render (): React.ReactNode {\n    const items = this.props.annotationGroups.map((annotationGroup, index) => {\n      const uid = annotationGroup.uid\n      return (\n        <AnnotationGroupItem\n          key={annotationGroup.uid}\n          annotationGroup={annotationGroup}\n          onAnnotationGroupClick={this.props.onAnnotationGroupClick}\n          metadata={this.props.metadata[uid]}\n          isVisible={this.props.visibleAnnotationGroupUIDs.has(uid)}\n          defaultStyle={this.props.defaultAnnotationGroupStyles[uid]}\n          onVisibilityChange={this.props.onAnnotationGroupVisibilityChange}\n          onStyleChange={this.props.onAnnotationGroupStyleChange}\n        />\n      )\n    })\n\n    return (\n      <>\n        <div\n          style={{\n            paddingLeft: '14px',\n            paddingTop: '7px',\n            paddingBottom: '7px'\n          }}\n        >\n          <Switch\n            size='small'\n            onChange={this.handleVisibilityChange}\n            checked={this.props.visibleAnnotationGroupUIDs.size > 0}\n            checkedChildren={<FaEye />}\n            unCheckedChildren={<FaEyeSlash />}\n          />\n        </div>\n        <Menu selectable={false}>{items}</Menu>\n      </>\n    )\n  }\n}\n\nexport default AnnotationGroupList\n","import React from 'react'\nimport { Button as Btn, Divider, Tooltip } from 'antd'\n\ninterface ButtonProps {\n  icon: any\n  tooltip?: string\n  label?: string\n  onClick?: (options: any) => void\n  isSelected?: boolean\n}\n\n/**\n * React component for a button.\n */\nclass Button extends React.Component<ButtonProps, {}> {\n  constructor (props: ButtonProps) {\n    super(props)\n    this.handleClick = this.handleClick.bind(this)\n  }\n\n  handleClick (event: React.SyntheticEvent): void {\n    if (this.props.onClick !== undefined) {\n      this.props.onClick(event)\n    }\n  }\n\n  render (): React.ReactNode {\n    const Icon = this.props.icon\n    if (Icon === undefined) {\n      return null\n    }\n\n    let text\n    if (this.props.label != null) {\n      text = (\n        <>\n          <Divider type='vertical' />\n          {this.props.label}\n        </>\n      )\n    }\n\n    let button\n    if (this.props.isSelected ?? false) {\n      button = (\n        <Btn\n          onClick={this.handleClick}\n          icon={<Icon />}\n          type='primary'\n          style={{ lineHeight: '1.0' }}\n        >\n          {text}\n        </Btn>\n      )\n    } else {\n      button = (\n        <Btn\n          onClick={this.handleClick}\n          icon={<Icon />}\n          type='default'\n          style={{ lineHeight: '1.0' }}\n        >\n          {text}\n        </Btn>\n      )\n    }\n\n    if (this.props.tooltip !== undefined) {\n      return (\n        <Tooltip title={this.props.tooltip}>\n          {button}\n        </Tooltip>\n      )\n    } else {\n      return button\n    }\n  }\n}\n\nexport default Button\n","import React from 'react'\nimport * as dmv from 'dicom-microscopy-viewer'\n\nimport Description from './Description'\n\ninterface EquipmentProps {\n  metadata?: dmv.metadata.VLWholeSlideMicroscopyImage\n}\n\n/**\n * React component representing a list of DICOM Equipment Entities.\n */\nclass Equipment extends React.Component<EquipmentProps, {}> {\n  render (): React.ReactNode {\n    if (this.props.metadata === undefined) {\n      return null\n    }\n    const attributes = [\n      {\n        name: 'Manufacturer',\n        value: this.props.metadata.Manufacturer\n      },\n      {\n        name: 'Model Name',\n        value: this.props.metadata.ManufacturerModelName\n      },\n      {\n        name: 'Device Serial Number',\n        value: this.props.metadata.DeviceSerialNumber\n      },\n      {\n        name: 'Software Versions',\n        value: this.props.metadata.SoftwareVersions\n      }\n    ]\n    if (this.props.metadata.InstitutionName != null) {\n      attributes.push({\n        name: 'Institution Name',\n        value: this.props.metadata.InstitutionName\n      })\n    }\n    return <Description attributes={attributes} hasLongValues />\n  }\n}\n\nexport default Equipment\n","import * as dcmjs from 'dcmjs'\n\n/**\n * Check whether a DICOM SR content item has a given name.\n *\n * @param item - Content item\n * @param name - Coded name that should be compared\n * @returns Whether the content item has the given name\n */\nconst hasName = (\n  item: dcmjs.sr.valueTypes.ContentItem,\n  name: dcmjs.sr.coding.CodedConcept\n): boolean => {\n  const concept = item.ConceptNameCodeSequence[0]\n  return (\n    concept.CodeValue === name.CodeValue &&\n    concept.CodingSchemeDesignator === name.CodingSchemeDesignator\n  )\n}\n\n/**\n * Check whether a DICOM SR content item has a given value type.\n *\n * @param item - Content item\n * @param valueType - Value Type\n * @returns Whether the content item has the given value type\n */\nconst hasValueType = (\n  item: dcmjs.sr.valueTypes.ContentItem,\n  valueType: dcmjs.sr.valueTypes.ValueTypes\n): boolean => {\n  console.log(item.ValueType, valueType)\n  return item.ValueType === valueType\n}\n\n/**\n * Find content items in a DICOM SR document given their name.\n *\n * Only finds content items at the root level, but not any nested content items.\n *\n * @param content - Document content, i.e., sequence of content items\n * @param name - Coded name that should be compared\n * @returns Matched content items\n */\nexport const findContentItemsByName = (\n  { content, name }: {\n    content: dcmjs.sr.valueTypes.ContentItem[]\n    name: dcmjs.sr.coding.CodedConcept\n  }\n): dcmjs.sr.valueTypes.ContentItem[] => {\n  const items: dcmjs.sr.valueTypes.ContentItem[] = []\n  content.forEach(i => {\n    if (hasName(i, name)) {\n      items.push(i)\n    }\n  })\n  return items\n}\n\n/**\n * Find content items in a DICOM SR document given their value type.\n *\n * Only finds content items at the root level, but not any nested content items.\n *\n * @param content - Document content, i.e., sequence of content items\n * @param valueType - Value Type\n * @returns Matched content items\n */\nexport const findContentItemsByValueType = (\n  { content, valueType }: {\n    content: dcmjs.sr.valueTypes.ContentItem[]\n    valueType: dcmjs.sr.valueTypes.ValueTypes\n  }\n): dcmjs.sr.valueTypes.ContentItem[] => {\n  const items: dcmjs.sr.valueTypes.ContentItem[] = []\n  content.forEach(i => {\n    if (hasValueType(i, valueType)) {\n      items.push(i)\n    }\n  })\n  return items\n}\n","import React from 'react'\nimport * as dmv from 'dicom-microscopy-viewer'\nimport * as dcmjs from 'dcmjs'\nimport { Divider } from 'antd'\nimport { v4 as generateUUID } from 'uuid'\n\nimport Description from './Description'\nimport Patient from './Patient'\nimport Study from './Study'\nimport { findContentItemsByName } from '../utils/sr'\nimport { CustomError, errorTypes } from '../utils/CustomError'\nimport NotificationMiddleware, {\n  NotificationMiddlewareContext\n} from '../services/NotificationMiddleware'\n\nexport const hasValueType = (\n  item: dcmjs.sr.valueTypes.ContentItem,\n  valueType: string\n): boolean => {\n  return item.ValueType === valueType\n}\n\nconst findMeasurementItems = (\n  { content }: { content: dcmjs.sr.valueTypes.ContentItem[] }\n): dcmjs.sr.valueTypes.NumContentItem[] => {\n  const items: dcmjs.sr.valueTypes.NumContentItem[] = []\n  content.forEach(i => {\n    if (hasValueType(i, dcmjs.sr.valueTypes.ValueTypes.NUM)) {\n      const measurement = i as dcmjs.sr.valueTypes.NumContentItem\n      items.push(measurement)\n    }\n  })\n  return items\n}\n\nconst findEvaluationItems = (\n  { content }: { content: dcmjs.sr.valueTypes.ContentItem[] }\n): dcmjs.sr.valueTypes.CodeContentItem[] => {\n  const items: dcmjs.sr.valueTypes.CodeContentItem[] = []\n  content.forEach(i => {\n    if (hasValueType(i, dcmjs.sr.valueTypes.ValueTypes.CODE)) {\n      const evaluation = i as dcmjs.sr.valueTypes.CodeContentItem\n      items.push(evaluation)\n    }\n  })\n  return items\n}\n\nconst getROIs = (report: dmv.metadata.Comprehensive3DSR): dmv.roi.ROI[] => {\n  // TID 1500 Measurement Report\n  const matches = findContentItemsByName({\n    content: report.ContentSequence,\n    name: new dcmjs.sr.coding.CodedConcept({\n      value: '126010',\n      schemeDesignator: 'DCM',\n      meaning: 'Imaging Measurements'\n    })\n  })\n  if (matches.length !== 1) {\n    NotificationMiddleware.onError(\n      NotificationMiddlewareContext.SLIM,\n      new CustomError(\n        errorTypes.ENCODINGANDDECODING,\n        'Content item \"Imaging Measurements\" not found.' +\n        'Content of Comprehensive 3D SR document is not structured based on ' +\n        'TID 1500 \"Measurement Report\".'\n      )\n    )\n  }\n  const measurementsItem = matches[0] as dcmjs.sr.valueTypes.ContainerContentItem\n  // TID 1410 Planar ROI Measurements and Qualitative Evaluations\n  const measurementGroupItems = findContentItemsByName({\n    content: measurementsItem.ContentSequence,\n    name: new dcmjs.sr.coding.CodedConcept({\n      value: '125007',\n      schemeDesignator: 'DCM',\n      meaning: 'Measurement Group'\n    })\n  })\n\n  const rois: dmv.roi.ROI[] = []\n  measurementGroupItems.forEach((item) => {\n    const evaluations = []\n    let observerType: string\n    const group = item as dcmjs.sr.valueTypes.ContainerContentItem\n    let items = findContentItemsByName({\n      content: group.ContentSequence,\n      name: new dcmjs.sr.coding.CodedConcept({\n        value: '112040',\n        schemeDesignator: 'DCM',\n        meaning: 'Tracking Unique Identifier'\n      })\n    })\n    if (items.length === 0) {\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.ENCODINGANDDECODING,\n          'Content item \"Tracking Unique Identifier\" not found. ' +\n          'Content of Comprehensive 3D SR document is not structured ' +\n          'based on TID 1500 \"Measurement Report\" -> ' +\n          'TID 1410 \"Planar ROI Measurements and Qualitative Evaluations\".'\n        )\n      )\n    }\n    const trackingUIDItem = items[0] as dcmjs.sr.valueTypes.UIDRefContentItem\n\n    items = findContentItemsByName({\n      content: group.ContentSequence,\n      name: new dcmjs.sr.coding.CodedConcept({\n        value: '121071',\n        schemeDesignator: 'DCM',\n        meaning: 'Finding'\n      })\n    })\n    if (items.length === 0) {\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.ENCODINGANDDECODING,\n          'Content item \"Finding\" not found. ' +\n          'Content of Comprehensive 3D SR document is not structured ' +\n          'based on TID 1500 \"Measurement Report\" -> ' +\n          'TID 1410 \"Planar ROI Measurements and Qualitative Evaluations\".'\n        )\n      )\n    }\n\n    items = findContentItemsByName({\n      content: group.ContentSequence,\n      name: new dcmjs.sr.coding.CodedConcept({\n        value: '111001',\n        schemeDesignator: 'DCM',\n        meaning: 'Algorithm Name'\n      })\n    })\n    if (items.length !== 0) {\n      const algorithmNameItem = items[0] as dcmjs.sr.valueTypes.CodeContentItem\n      evaluations.push(algorithmNameItem)\n      observerType = 'Device'\n    } else {\n      observerType = 'Person'\n    }\n\n    items = findContentItemsByName({\n      content: group.ContentSequence,\n      name: new dcmjs.sr.coding.CodedConcept({\n        value: '111003',\n        schemeDesignator: 'DCM',\n        meaning: 'Algorithm Version'\n      })\n    })\n    if (items.length !== 0) {\n      const algorithmVersionItem = items[0] as dcmjs.sr.valueTypes.CodeContentItem\n      evaluations.push(algorithmVersionItem)\n    }\n\n    items = findContentItemsByName({\n      content: group.ContentSequence,\n      name: new dcmjs.sr.coding.CodedConcept({\n        value: '111030',\n        schemeDesignator: 'DCM',\n        meaning: 'Image Region'\n      })\n    })\n    if (items.length === 0) {\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.ENCODINGANDDECODING,\n          'Content item \"Image Region\" not found. ' +\n          'Content of Comprehensive 3D SR document is not structured ' +\n          'based on TID 1500 \"Measurement Report\" -> ' +\n          'TID 1410 \"Planar ROI Measurements and Qualitative Evaluations\".'\n        )\n      )\n    }\n    const regionItem = items[0] as dcmjs.sr.valueTypes.Scoord3DContentItem\n    let scoord3d: any\n    if (regionItem.GraphicType === 'POINT') {\n      scoord3d = new dmv.scoord3d.Point({\n        frameOfReferenceUID: regionItem.ReferencedFrameOfReferenceUID,\n        coordinates: regionItem.GraphicData\n      })\n    } else {\n      const coordinates: number[][] = []\n      for (let i = 0; i < regionItem.GraphicData.length; i += 3) {\n        coordinates.push(regionItem.GraphicData.slice(i, i + 3))\n      }\n      if (regionItem.GraphicType === 'POLYGON') {\n        scoord3d = new dmv.scoord3d.Polygon({\n          frameOfReferenceUID: regionItem.ReferencedFrameOfReferenceUID,\n          coordinates: coordinates\n        })\n      } else if (regionItem.GraphicType === 'MULTIPOINT') {\n        scoord3d = new dmv.scoord3d.MultiPoint({\n          frameOfReferenceUID: regionItem.ReferencedFrameOfReferenceUID,\n          coordinates: coordinates\n        })\n      } else if (regionItem.GraphicType === 'POLYLINE') {\n        scoord3d = new dmv.scoord3d.Polyline({\n          frameOfReferenceUID: regionItem.ReferencedFrameOfReferenceUID,\n          coordinates: coordinates\n        })\n      } else if (regionItem.GraphicType === 'ELLIPSE') {\n        scoord3d = new dmv.scoord3d.Ellipse({\n          frameOfReferenceUID: regionItem.ReferencedFrameOfReferenceUID,\n          coordinates: coordinates\n        })\n      } else if (regionItem.GraphicType === 'ELLIPSOID') {\n        scoord3d = new dmv.scoord3d.Ellipsoid({\n          frameOfReferenceUID: regionItem.ReferencedFrameOfReferenceUID,\n          coordinates: coordinates\n        })\n      } else {\n        NotificationMiddleware.onError(\n          NotificationMiddlewareContext.SLIM,\n          new CustomError(\n            errorTypes.ENCODINGANDDECODING,\n            'Content item \"Image Region\" has unknown graphic type ' +\n            `\"${regionItem.GraphicType}\". ` +\n            'Content of Comprehensive 3D SR document is not structured ' +\n            'based on TID 1500 \"Measurement Report\" -> ' +\n            'TID 1410 \"Planar ROI Measurements and Qualitative Evaluations\".'\n          )\n        )\n      }\n    }\n\n    evaluations.push(\n      ...findEvaluationItems({ content: group.ContentSequence })\n    )\n    const measurements = findMeasurementItems({\n      content: group.ContentSequence\n    })\n\n    const roi = new dmv.roi.ROI({\n      scoord3d: scoord3d,\n      uid: generateUUID(),\n      properties: {\n        trackingUID: trackingUIDItem.UID,\n        observerType: observerType,\n        evaluations: evaluations,\n        measurements: measurements\n      }\n    })\n    rois.push(roi)\n  })\n  return rois\n}\n\nclass MeasurementReport {\n  public PersonObserverName?: string\n\n  public PersonObserverLoginName?: string\n\n  public DeviceObserverUID?: string\n\n  public DeviceObserverName?: string\n\n  public SpecimenUID: string\n\n  public SpecimenIdentifier: string\n\n  public ContainerIdentifier: string\n\n  public ROIs: dmv.roi.ROI[] = []\n\n  constructor (report: dmv.metadata.Comprehensive3DSR) {\n    let items = findContentItemsByName({\n      content: report.ContentSequence,\n      name: new dcmjs.sr.coding.CodedConcept({\n        value: '121039',\n        schemeDesignator: 'DCM',\n        meaning: 'Specimen UID'\n      })\n    })\n    if (items.length === 0) {\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.ENCODINGANDDECODING,\n          'Content item \"Specimen UID\" not found. ' +\n          'Content of Comprehensive 3D SR document is not structured based on ' +\n          'TID 1500 \"Measurement Report\" -> TID 1001 \"Observation Context\" -> ' +\n          'TID 1006 \"Subject Context\" -> TID 1009 \"Subject Context, Specimen\".'\n        )\n      )\n    }\n    const specimenUIDItem = (\n      items[0] as unknown as dcmjs.sr.valueTypes.UIDRefContentItem\n    )\n    this.SpecimenUID = specimenUIDItem.UID\n\n    items = findContentItemsByName({\n      content: report.ContentSequence,\n      name: new dcmjs.sr.coding.CodedConcept({\n        value: '121041',\n        schemeDesignator: 'DCM',\n        meaning: 'Specimen Identifier'\n      })\n    })\n    if (items.length === 0) {\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.ENCODINGANDDECODING,\n          'Content item \"Specimen Identifier\" not found. ' +\n          'Content of Comprehensive 3D SR document is not structured based on ' +\n          'TID 1500 \"Measurement Report\" -> TID 1001 \"Observation Context\" -> ' +\n          'TID 1006 \"Subject Context\" -> TID 1009 \"Subject Context, Specimen\".'\n        )\n      )\n    }\n    const specimenIdItem = (\n      items[0] as unknown as dcmjs.sr.valueTypes.TextContentItem\n    )\n    this.SpecimenIdentifier = specimenIdItem.TextValue\n\n    items = findContentItemsByName({\n      content: report.ContentSequence,\n      name: new dcmjs.sr.coding.CodedConcept({\n        value: '111700',\n        schemeDesignator: 'DCM',\n        meaning: 'Specimen Container Identifier'\n      })\n    })\n    if (items.length === 0) {\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.ENCODINGANDDECODING,\n          'Content item \"Specimen Container Identifier\" not found. ' +\n          'Content of Comprehensive 3D SR document is not structured based on ' +\n          'TID 1500 \"Measurement Report\" -> TID 1001 \"Observation Context\" -> ' +\n          'TID 1006 \"Subject Context\" -> TID 1009 \"Subject Context, Specimen\".'\n        )\n      )\n    }\n    const containerIdItem = (\n      items[0] as unknown as dcmjs.sr.valueTypes.TextContentItem\n    )\n    this.ContainerIdentifier = containerIdItem.TextValue\n\n    items = findContentItemsByName({\n      content: report.ContentSequence,\n      name: new dcmjs.sr.coding.CodedConcept({\n        value: '121008',\n        schemeDesignator: 'DCM',\n        meaning: 'Person Observer Name'\n      })\n    })\n    if (items.length !== 0) {\n      const personNameItem = (\n        items[0] as unknown as dcmjs.sr.valueTypes.PNameContentItem\n      )\n      this.PersonObserverName = personNameItem.PersonName\n    }\n\n    items = findContentItemsByName({\n      content: report.ContentSequence,\n      name: new dcmjs.sr.coding.CodedConcept({\n        value: '128774',\n        schemeDesignator: 'DCM',\n        meaning: \"Person Observer's Login Name\"\n      })\n    })\n    if (items.length !== 0) {\n      const personLoginNameItem = (\n        items[0] as unknown as dcmjs.sr.valueTypes.TextContentItem\n      )\n      this.PersonObserverLoginName = personLoginNameItem.TextValue\n    }\n\n    items = findContentItemsByName({\n      content: report.ContentSequence,\n      name: new dcmjs.sr.coding.CodedConcept({\n        value: '121012',\n        schemeDesignator: 'DCM',\n        meaning: 'Device Observer UID'\n      })\n    })\n    if (items.length > 0) {\n      const deviceUIDItem = (\n        items[0] as unknown as dcmjs.sr.valueTypes.UIDRefContentItem\n      )\n      this.DeviceObserverUID = deviceUIDItem.UID\n    }\n\n    items = findContentItemsByName({\n      content: report.ContentSequence,\n      name: new dcmjs.sr.coding.CodedConcept({\n        value: '121013',\n        schemeDesignator: 'DCM',\n        meaning: 'Device Observer Name'\n      })\n    })\n    if (items.length !== 0) {\n      const deviceNameItem = (\n        items[0] as unknown as dcmjs.sr.valueTypes.TextContentItem\n      )\n      this.DeviceObserverName = deviceNameItem.TextValue\n    }\n\n    this.ROIs = getROIs(report)\n  }\n}\n\ninterface ReportProps {\n  dataset: dmv.metadata.Comprehensive3DSR\n}\n\n/**\n * React component representing a DICOM SR document that displays the\n * document content (a selected subset of content items).\n */\nclass Report extends React.Component<ReportProps, {}> {\n  render (): React.ReactNode {\n    const report = new MeasurementReport(this.props.dataset)\n    const containerAttrs = [\n      {\n        name: 'ID',\n        value: report.ContainerIdentifier\n      }\n    ]\n    const specimenAttrs = [\n      {\n        name: 'ID',\n        value: report.SpecimenIdentifier\n      }\n    ]\n    const observerAttrs = [\n      {\n        name: 'Name',\n        value: report.PersonObserverName\n      }\n    ]\n    const annotations = report.ROIs.map(\n      (roi, index): React.ReactNode => {\n        const id = `Region ${index + 1}`\n        const attrs: Array<{ name: string, value: string }> = []\n        roi.evaluations.forEach((\n          item: (\n            dcmjs.sr.valueTypes.CodeContentItem |\n            dcmjs.sr.valueTypes.TextContentItem\n          )\n        ) => {\n          if (item.ValueType === dcmjs.sr.valueTypes.ValueTypes.CODE) {\n            item = item as dcmjs.sr.valueTypes.CodeContentItem\n            attrs.push({\n              name: item.ConceptNameCodeSequence[0].CodeMeaning,\n              value: item.ConceptCodeSequence[0].CodeMeaning\n            })\n          } else if (item.ValueType === dcmjs.sr.valueTypes.ValueTypes.TEXT) {\n            item = item as dcmjs.sr.valueTypes.TextContentItem\n            attrs.push({\n              name: item.ConceptNameCodeSequence[0].CodeMeaning,\n              value: item.TextValue\n            })\n          }\n        })\n        return <Description key={roi.uid} header={id} attributes={attrs} />\n      }\n    )\n\n    return (\n      <div>\n        <Divider orientation='left'>Patient</Divider>\n        <Patient metadata={this.props.dataset} />\n        <Divider orientation='left'>Case</Divider>\n        <Study metadata={this.props.dataset} />\n        <Divider orientation='left'>Slide</Divider>\n        <Description attributes={containerAttrs} />\n        <Divider orientation='left'>Specimen</Divider>\n        <Description attributes={specimenAttrs} />\n        <Divider orientation='left'>Observer</Divider>\n        <Description attributes={observerAttrs} />\n        <Divider orientation='left'>Annotations</Divider>\n        {annotations}\n      </div>\n    )\n  }\n}\n\nexport default Report\nexport { MeasurementReport }\n","import React from 'react'\nimport { List } from 'antd'\n\nimport Description, { Attribute, AttributeGroup } from './Description'\n\ninterface ItemProps {\n  uid: string\n  identifier: string\n  attributes: Attribute[]\n  groups?: AttributeGroup[]\n  children?: React.ReactElement[]\n  type?: string\n  hasLongValues?: boolean\n}\n\n/**\n * React component for a list item that consists of a header element\n * containing an identifier and a body element containing a description list\n * of attributes rendered as name-value pairs.\n */\nclass Item extends React.Component<ItemProps, {}> {\n  render (): React.ReactNode {\n    let groups = null\n    if (this.props.groups !== undefined) {\n      groups = this.props.groups.map((item, index: number) => (\n        <Description\n          key={index}\n          header={item.name}\n          attributes={item.attributes}\n        />\n      ))\n    }\n    let title\n    if (this.props.type !== undefined) {\n      title = `${this.props.type}: ${this.props.identifier}`\n    } else {\n      title = this.props.identifier\n    }\n    return (\n      <List.Item key={this.props.uid}>\n        <Description\n          header={title}\n          attributes={this.props.attributes}\n          hasLongValues={this.props.hasLongValues}\n        >\n          {groups}\n        </Description>\n        {this.props.children}\n      </List.Item>\n    )\n  }\n}\n\nexport default Item\n","import * as dcmjs from 'dcmjs'\n\nexport const SpecimenPreparationTypes: {\n  [key: string]: dcmjs.sr.coding.CodedConcept\n} = {\n  COLLECTION: new dcmjs.sr.coding.CodedConcept({\n    value: '17636008',\n    schemeDesignator: 'SCT',\n    meaning: 'Specimen collection'\n  }),\n  SAMPLING: new dcmjs.sr.coding.CodedConcept({\n    value: '433465004',\n    schemeDesignator: 'SCT',\n    meaning: 'Sampling of tissue specimen'\n  }),\n  STAINING: new dcmjs.sr.coding.CodedConcept({\n    value: '127790008',\n    schemeDesignator: 'SCT',\n    meaning: 'Specimen staining'\n  }),\n  PROCESSING: new dcmjs.sr.coding.CodedConcept({\n    value: '9265001',\n    schemeDesignator: 'SCT',\n    meaning: 'Specimen processing'\n  })\n}\n\nexport const SpecimenPreparationAdditives: {\n  [key: string]: dcmjs.sr.coding.CodedConcept\n} = {\n  FIXATIVE: new dcmjs.sr.coding.CodedConcept({\n    value: '430864009',\n    schemeDesignator: 'SCT',\n    meaning: 'Tissue fixative'\n  }),\n  EMBEDDING_MEDIUM: new dcmjs.sr.coding.CodedConcept({\n    value: '430863003',\n    schemeDesignator: 'SCT',\n    meaning: 'Embedding medium'\n  })\n}\n\nexport const SpecimenPreparationStepItems: {\n  [key: string]: dcmjs.sr.coding.CodedConcept\n} = {\n  SPECIMEN_IDENTIFIER: new dcmjs.sr.coding.CodedConcept({\n    value: '121041',\n    schemeDesignator: 'DCM',\n    meaning: 'Specimen identifier'\n  }),\n  PARENT_SPECIMEN_IDENTIFIER: new dcmjs.sr.coding.CodedConcept({\n    value: '111705',\n    schemeDesignator: 'DCM',\n    meaning: 'Parent specimen identifier'\n  }),\n  PROCESSING_TYPE: new dcmjs.sr.coding.CodedConcept({\n    value: '111701',\n    schemeDesignator: 'DCM',\n    meaning: 'Processing type'\n  }),\n  DATETIME_OF_PROCESSING: new dcmjs.sr.coding.CodedConcept({\n    value: '111702',\n    schemeDesignator: 'DCM',\n    meaning: 'Datetime of processing'\n  }),\n  PROCESSING_STEP_DESCRIPTION: new dcmjs.sr.coding.CodedConcept({\n    value: '111703',\n    schemeDesignator: 'DCM',\n    meaning: 'Processing step description'\n  }),\n  COLLECTION_METHOD: new dcmjs.sr.coding.CodedConcept({\n    value: '17636008',\n    schemeDesignator: 'SCT',\n    meaning: 'Specimen collection'\n  }),\n  SAMPLING_METHOD: new dcmjs.sr.coding.CodedConcept({\n    value: '111704',\n    schemeDesignator: 'DCM',\n    meaning: 'Sampling method'\n  }),\n  STAIN: new dcmjs.sr.coding.CodedConcept({\n    value: '424361007',\n    schemeDesignator: 'SCT',\n    meaning: 'Using substance'\n  }),\n  ...SpecimenPreparationAdditives\n}\n","import React from 'react'\nimport * as dmv from 'dicom-microscopy-viewer'\nimport * as dcmjs from 'dcmjs'\n\nimport Item from './Item'\nimport { Attribute } from './Description'\nimport { SpecimenPreparationStepItems } from '../data/specimens'\n\ninterface SpecimenItemProps {\n  index: number\n  metadata?: dmv.metadata.VLWholeSlideMicroscopyImage\n  showstain: boolean\n}\n\n/**\n * React component representing a DICOM Specimen Information Entity and\n * displays specimen-related attributes of a DICOM Slide Microscopy image.\n */\nclass SpecimenItem extends React.Component<SpecimenItemProps, {}> {\n  render (): React.ReactNode {\n    if (this.props.metadata === undefined) {\n      return null\n    }\n    const specimenDescription = this.props.metadata.SpecimenDescriptionSequence[\n      this.props.index\n    ]\n    const attributes: Attribute[] = []\n    if (specimenDescription.SpecimenShortDescription !== undefined) {\n      attributes.push({\n        name: 'Description',\n        value: specimenDescription.SpecimenShortDescription\n      })\n    }\n    if (specimenDescription.PrimaryAnatomicStructureSequence !== undefined) {\n      if (specimenDescription.PrimaryAnatomicStructureSequence.length > 0) {\n        const structures = specimenDescription.PrimaryAnatomicStructureSequence\n        attributes.push({\n          name: 'Anatomical structure',\n          value: structures.map(item => item.CodeMeaning).join(', ')\n        })\n      }\n    }\n\n    // TID 8001 \"Specimen Preparation\"\n    const preparationSteps: dmv.metadata.SpecimenPreparation[] = (\n      specimenDescription.SpecimenPreparationSequence ?? []\n    )\n    preparationSteps.forEach(\n      (step: dmv.metadata.SpecimenPreparation, index: number): void => {\n        step.SpecimenPreparationStepContentItemSequence.forEach((\n          item: (\n            dcmjs.sr.valueTypes.CodeContentItem |\n            dcmjs.sr.valueTypes.TextContentItem |\n            dcmjs.sr.valueTypes.UIDRefContentItem |\n            dcmjs.sr.valueTypes.PNameContentItem |\n            dcmjs.sr.valueTypes.DateTimeContentItem\n          ),\n          index: number\n        ) => {\n          const name = new dcmjs.sr.coding.CodedConcept({\n            value: item.ConceptNameCodeSequence[0].CodeValue,\n            schemeDesignator:\n              item.ConceptNameCodeSequence[0].CodingSchemeDesignator,\n            meaning: item.ConceptNameCodeSequence[0].CodeMeaning\n          })\n          if (item.ValueType === dcmjs.sr.valueTypes.ValueTypes.CODE) {\n            item = item as dcmjs.sr.valueTypes.CodeContentItem\n            const value = new dcmjs.sr.coding.CodedConcept({\n              value: item.ConceptCodeSequence[0].CodeValue,\n              schemeDesignator:\n                item.ConceptCodeSequence[0].CodingSchemeDesignator,\n              meaning: item.ConceptCodeSequence[0].CodeMeaning\n            })\n            if (!name.equals(SpecimenPreparationStepItems.PROCESSING_TYPE)) {\n              if (\n                name.equals(SpecimenPreparationStepItems.COLLECTION_METHOD)\n              ) {\n                attributes.push({\n                  name: 'Collection method',\n                  value: value.CodeMeaning\n                })\n              } else if (\n                name.equals(SpecimenPreparationStepItems.FIXATIVE)\n              ) {\n                attributes.push({\n                  name: 'Tissue fixative',\n                  value: value.CodeMeaning\n                })\n              } else if (\n                name.equals(SpecimenPreparationStepItems.EMBEDDING_MEDIUM)\n              ) {\n                attributes.push({\n                  name: 'Tissue embedding medium',\n                  value: value.CodeMeaning\n                })\n              } else if (\n                name.equals(SpecimenPreparationStepItems.STAIN) &&\n                this.props.showstain\n              ) {\n                attributes.push({\n                  name: 'Tissue stain',\n                  value: value.CodeMeaning\n                })\n              }\n            }\n          } else if (item.ValueType === dcmjs.sr.valueTypes.ValueTypes.TEXT) {\n            item = item as dcmjs.sr.valueTypes.TextContentItem\n            if (\n              name.equals(SpecimenPreparationStepItems.STAIN) &&\n              this.props.showstain\n            ) {\n              attributes.push({\n                name: 'Tissue stain',\n                value: item.TextValue\n              })\n            } else if (\n              name.equals(SpecimenPreparationStepItems.PARENT_SPECIMEN_IDENTIFIER)\n            ) {\n              attributes.push({\n                name: 'Parent specimen',\n                value: item.TextValue\n              })\n            }\n          }\n        })\n      }\n    )\n    const uid = specimenDescription.SpecimenUID\n    const identifier = specimenDescription.SpecimenIdentifier\n    return (\n      <Item\n        uid={uid}\n        key={uid}\n        identifier={identifier}\n        attributes={attributes}\n        hasLongValues\n      />\n    )\n  }\n}\n\nexport default SpecimenItem\n","import React from 'react'\nimport * as dmv from 'dicom-microscopy-viewer'\nimport { List } from 'antd'\n\nimport SpecimenItem from './SpecimenItem'\n\ninterface SpecimenListProps {\n  metadata?: dmv.metadata.VLWholeSlideMicroscopyImage\n  showstain: boolean\n}\n\n/**\n * React component representing a list of DICOM Specimen Information Entities.\n */\nclass SpecimenList extends React.Component<SpecimenListProps, {}> {\n  render (): React.ReactNode {\n    if (this.props.metadata === undefined) {\n      return null\n    }\n    /*\n     * Specimen Description Sequence is a type 1 attribute. However, it is\n     * nevertheless missing in some data sets. This is a violation of the\n     * standard, but it may be better to facilitate display of the data.\n     */\n    const descriptions = this.props.metadata.SpecimenDescriptionSequence ?? []\n    const items = descriptions.map(\n      (item: dmv.metadata.SpecimenDescription, index: number) => {\n        return (\n          <SpecimenItem\n            index={index}\n            key={item.SpecimenUID}\n            metadata={this.props.metadata}\n            showstain={this.props.showstain}\n          />\n        )\n      }\n    )\n    return (\n      <List style={{ overflowY: 'auto' }}>\n        {items}\n      </List>\n    )\n  }\n}\n\nexport default SpecimenList\n","import React from 'react'\nimport {\n  Badge,\n  Button,\n  Col,\n  Divider,\n  InputNumber,\n  Menu,\n  Popover,\n  Row,\n  Slider,\n  Space,\n  Switch,\n  Tooltip\n} from 'antd'\nimport {\n  DeleteOutlined,\n  EyeOutlined,\n  EyeInvisibleOutlined,\n  SettingOutlined\n} from '@ant-design/icons'\nimport Description from './Description'\nimport * as dmv from 'dicom-microscopy-viewer'\nimport * as dcmjs from 'dcmjs'\n\nimport { SpecimenPreparationStepItems } from '../data/specimens'\nimport NotificationMiddleware, {\n  NotificationMiddlewareContext\n} from '../services/NotificationMiddleware'\nimport { CustomError, errorTypes } from '../utils/CustomError'\n\ninterface OpticalPathItemProps {\n  opticalPath: dmv.opticalPath.OpticalPath\n  metadata: dmv.metadata.VLWholeSlideMicroscopyImage[]\n  isVisible: boolean\n  isRemovable: boolean\n  defaultStyle: {\n    opacity: number\n    color?: number[]\n    paletteColorLookupTable?: dmv.color.PaletteColorLookupTable\n    limitValues?: number[]\n  }\n  onVisibilityChange: ({ opticalPathIdentifier, isVisible }: {\n    opticalPathIdentifier: string\n    isVisible: boolean\n  }) => void\n  onStyleChange: ({ opticalPathIdentifier, styleOptions }: {\n    opticalPathIdentifier: string\n    styleOptions: {\n      opacity?: number\n      color?: number[]\n      paletteColorLookupTable?: dmv.color.PaletteColorLookupTable\n      limitValues?: number[]\n    }\n  }) => void\n  onRemoval: (opticalPathIdentifier: string) => void\n}\n\ninterface OpticalPathItemState {\n  isVisible: boolean\n  currentStyle: {\n    opacity: number\n    color?: number[]\n    paletteColorLookupTable?: dmv.color.PaletteColorLookupTable\n    limitValues?: number[]\n  }\n}\n\n/**\n * React component representing an optical path of a\n * multi-channel acquistion with control of visualization parameters.\n */\nclass OpticalPathItem extends React.Component<OpticalPathItemProps, OpticalPathItemState> {\n  constructor (props: OpticalPathItemProps) {\n    super(props)\n    this.handleVisibilityChange = this.handleVisibilityChange.bind(this)\n    this.handleOpacityChange = this.handleOpacityChange.bind(this)\n    this.handleLimitChange = this.handleLimitChange.bind(this)\n    this.handleLowerLimitChange = this.handleLowerLimitChange.bind(this)\n    this.handleUpperLimitChange = this.handleUpperLimitChange.bind(this)\n    this.handleColorRChange = this.handleColorRChange.bind(this)\n    this.handleColorGChange = this.handleColorGChange.bind(this)\n    this.handleColorBChange = this.handleColorBChange.bind(this)\n    this.handleRemoval = this.handleRemoval.bind(this)\n    this.getCurrentColors = this.getCurrentColors.bind(this)\n    this.state = {\n      isVisible: this.props.isVisible,\n      currentStyle: {\n        opacity: this.props.defaultStyle.opacity,\n        color: this.props.defaultStyle.color,\n        paletteColorLookupTable: this.props.defaultStyle.paletteColorLookupTable,\n        limitValues: this.props.defaultStyle.limitValues\n      }\n    }\n  }\n\n  componentDidUpdate (\n    previousProps: OpticalPathItemProps,\n    previousState: OpticalPathItemState\n  ): void {\n    if (this.props.defaultStyle !== previousProps.defaultStyle) {\n      this.setState({\n        currentStyle: this.props.defaultStyle\n      })\n    }\n  }\n\n  handleVisibilityChange (\n    checked: boolean,\n    event: React.MouseEvent<HTMLButtonElement>\n  ): void {\n    const identifier = this.props.opticalPath.identifier\n    this.setState({\n      isVisible: checked\n    })\n    this.props.onVisibilityChange({\n      opticalPathIdentifier: identifier,\n      isVisible: checked\n    })\n  }\n\n  handleOpacityChange (\n    value: number | null\n  ): void {\n    if (value != null) {\n      const identifier = this.props.opticalPath.identifier\n      this.props.onStyleChange({\n        opticalPathIdentifier: identifier,\n        styleOptions: { opacity: value }\n      })\n      this.setState(state => ({\n        currentStyle: {\n          color: state.currentStyle.color,\n          paletteColorLookupTable: state.currentStyle.paletteColorLookupTable,\n          opacity: value,\n          limitValues: state.currentStyle.limitValues\n        }\n      }))\n    }\n  }\n\n  handleColorRChange (\n    value: number | number[] | null\n  ): void {\n    const identifier = this.props.opticalPath.identifier\n    if (value != null && this.state.currentStyle.color !== undefined) {\n      const color = [\n        Array.isArray(value) ? value[0] : value,\n        this.state.currentStyle.color[1],\n        this.state.currentStyle.color[2]\n      ]\n      this.setState(state => ({\n        currentStyle: {\n          color: color,\n          paletteColorLookupTable: state.currentStyle.paletteColorLookupTable,\n          opacity: state.currentStyle.opacity,\n          limitValues: state.currentStyle.limitValues\n        }\n      }))\n      this.props.onStyleChange({\n        opticalPathIdentifier: identifier,\n        styleOptions: { color: color }\n      })\n    }\n  }\n\n  handleColorGChange (\n    value: number | number[] | null\n  ): void {\n    const identifier = this.props.opticalPath.identifier\n    if (value != null && this.state.currentStyle.color !== undefined) {\n      const color = [\n        this.state.currentStyle.color[0],\n        Array.isArray(value) ? value[0] : value,\n        this.state.currentStyle.color[2]\n      ]\n      this.setState(state => ({\n        currentStyle: {\n          color: color,\n          paletteColorLookupTable: state.currentStyle.paletteColorLookupTable,\n          opacity: state.currentStyle.opacity,\n          limitValues: state.currentStyle.limitValues\n        }\n      }))\n      this.props.onStyleChange({\n        opticalPathIdentifier: identifier,\n        styleOptions: { color: color }\n      })\n    }\n  }\n\n  handleColorBChange (\n    value: number | number[] | null\n  ): void {\n    const identifier = this.props.opticalPath.identifier\n    if (value != null && this.state.currentStyle.color !== undefined) {\n      const color = [\n        this.state.currentStyle.color[0],\n        this.state.currentStyle.color[1],\n        Array.isArray(value) ? value[0] : value\n      ]\n      this.setState(state => ({\n        currentStyle: {\n          color: color,\n          paletteColorLookupTable: state.currentStyle.paletteColorLookupTable,\n          opacity: state.currentStyle.opacity,\n          limitValues: state.currentStyle.limitValues\n        }\n      }))\n      this.props.onStyleChange({\n        opticalPathIdentifier: identifier,\n        styleOptions: { color: color }\n      })\n    }\n  }\n\n  getCurrentColors (): string[] {\n    const rgb2hex = (values: number[]): string => {\n      const r = values[0]\n      const g = values[1]\n      const b = values[2]\n      return '#' + (0x1000000 + (r << 16) + (g << 8) + b).toString(16).slice(1)\n    }\n\n    if (this.props.defaultStyle.paletteColorLookupTable != null) {\n      const colormap = this.props.defaultStyle.paletteColorLookupTable.data\n      return colormap.map(values => rgb2hex(values))\n    } else if (this.state.currentStyle.color != null) {\n      return [\n        '#000000',\n        rgb2hex(this.state.currentStyle.color)\n      ]\n    } else {\n      return ['white', 'white']\n    }\n  }\n\n  handleLowerLimitChange (\n    value: number | null\n  ): void {\n    const identifier = this.props.opticalPath.identifier\n    if (value != null && this.state.currentStyle.limitValues !== undefined) {\n      this.setState(state => {\n        if (state.currentStyle.limitValues !== undefined) {\n          return {\n            currentStyle: {\n              color: state.currentStyle.color,\n              paletteColorLookupTable: state.currentStyle.paletteColorLookupTable,\n              opacity: state.currentStyle.opacity,\n              limitValues: [value, state.currentStyle.limitValues[1]]\n            }\n          }\n        } else {\n          return {\n            currentStyle: {\n              color: state.currentStyle.color,\n              paletteColorLookupTable: state.currentStyle.paletteColorLookupTable,\n              opacity: state.currentStyle.opacity,\n              limitValues: state.currentStyle.limitValues\n            }\n          }\n        }\n      })\n      this.props.onStyleChange({\n        opticalPathIdentifier: identifier,\n        styleOptions: {\n          limitValues: [\n            value,\n            this.state.currentStyle.limitValues[1]\n          ]\n        }\n      })\n    }\n  }\n\n  handleUpperLimitChange (\n    value: number | null\n  ): void {\n    const identifier = this.props.opticalPath.identifier\n    if (value != null && this.state.currentStyle.limitValues !== undefined) {\n      this.setState(state => {\n        if (state.currentStyle.limitValues !== undefined) {\n          return {\n            currentStyle: {\n              color: state.currentStyle.color,\n              paletteColorLookupTable: state.currentStyle.paletteColorLookupTable,\n              opacity: state.currentStyle.opacity,\n              limitValues: [state.currentStyle.limitValues[0], value]\n            }\n          }\n        } else {\n          return {\n            currentStyle: {\n              color: state.currentStyle.color,\n              paletteColorLookupTable: state.currentStyle.paletteColorLookupTable,\n              opacity: state.currentStyle.opacity,\n              limitValues: state.currentStyle.limitValues\n            }\n          }\n        }\n      })\n      this.props.onStyleChange({\n        opticalPathIdentifier: identifier,\n        styleOptions: {\n          limitValues: [\n            this.state.currentStyle.limitValues[0],\n            value\n          ]\n        }\n      })\n    }\n  }\n\n  handleLimitChange (\n    values: number[]\n  ): void {\n    const identifier = this.props.opticalPath.identifier\n    this.setState(state => ({\n      currentStyle: {\n        color: state.currentStyle.color,\n        paletteColorLookupTable: state.currentStyle.paletteColorLookupTable,\n        opacity: state.currentStyle.opacity,\n        limitValues: values\n      }\n    }))\n    this.props.onStyleChange({\n      opticalPathIdentifier: identifier,\n      styleOptions: { limitValues: values }\n    })\n  }\n\n  handleRemoval (): void {\n    const identifier = this.props.opticalPath.identifier\n    this.props.onRemoval(identifier)\n  }\n\n  render (): React.ReactNode {\n    const identifier = this.props.opticalPath.identifier\n    const description = this.props.opticalPath.description\n    const attributes: Array<{ name: string, value: string }> = []\n    if (this.props.opticalPath.illuminationWaveLength !== undefined) {\n      attributes.push(\n        {\n          name: 'Illumination wavelength',\n          value: `${this.props.opticalPath.illuminationWaveLength} nm`\n        }\n      )\n    }\n    if (this.props.opticalPath.illuminationColor !== undefined) {\n      attributes.push(\n        {\n          name: 'Illumination color',\n          value: this.props.opticalPath.illuminationColor.CodeMeaning\n        }\n      )\n    }\n\n    // TID 8001 \"Specimen Preparation\"\n    const specimenDescriptions: dmv.metadata.SpecimenDescription[] = (\n      this.props.metadata[0].SpecimenDescriptionSequence ?? []\n    )\n    try {\n      specimenDescriptions.forEach(description => {\n        const specimenPreparationSteps: dmv.metadata.SpecimenPreparation[] =\n          description.SpecimenPreparationSequence ?? []\n        specimenPreparationSteps.forEach(\n          (step: dmv.metadata.SpecimenPreparation, index: number): void => {\n            step.SpecimenPreparationStepContentItemSequence.forEach((\n              item: (\n                dcmjs.sr.valueTypes.CodeContentItem |\n                dcmjs.sr.valueTypes.TextContentItem |\n                dcmjs.sr.valueTypes.UIDRefContentItem |\n                dcmjs.sr.valueTypes.PNameContentItem |\n                dcmjs.sr.valueTypes.DateTimeContentItem\n              ),\n              index: number\n            ) => {\n              const name = new dcmjs.sr.coding.CodedConcept({\n                value: item.ConceptNameCodeSequence[0].CodeValue,\n                schemeDesignator:\n                    item.ConceptNameCodeSequence[0].CodingSchemeDesignator,\n                meaning: item.ConceptNameCodeSequence[0].CodeMeaning\n              })\n              if (item.ValueType === dcmjs.sr.valueTypes.ValueTypes.CODE) {\n                item = item as dcmjs.sr.valueTypes.CodeContentItem\n                const value = new dcmjs.sr.coding.CodedConcept({\n                  value: item.ConceptCodeSequence[0].CodeValue,\n                  schemeDesignator:\n                      item.ConceptCodeSequence[0].CodingSchemeDesignator,\n                  meaning: item.ConceptCodeSequence[0].CodeMeaning\n                })\n                if (!name.equals(SpecimenPreparationStepItems.PROCESSING_TYPE)) {\n                  if (name.equals(SpecimenPreparationStepItems.STAIN)) {\n                    attributes.push({\n                      name: 'Tissue stain',\n                      value: value.CodeMeaning\n                    })\n                  }\n                }\n              } else if (item.ValueType === dcmjs.sr.valueTypes.ValueTypes.TEXT) {\n                item = item as dcmjs.sr.valueTypes.TextContentItem\n                if (!name.equals(SpecimenPreparationStepItems.PROCESSING_TYPE)) {\n                  if (name.equals(SpecimenPreparationStepItems.STAIN)) {\n                    attributes.push({\n                      name: 'Tissue stain',\n                      value: item.TextValue\n                    })\n                  }\n                }\n              }\n            })\n          }\n        )\n      })\n    } catch (error: any) {\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.DCMJS,\n        new CustomError(\n          errorTypes.ENCODINGANDDECODING,\n          error.message\n        )\n      )\n    }\n\n    const maxValue = Math.pow(2, this.props.metadata[0].BitsAllocated) - 1\n\n    const title = (\n      description != null ? `${identifier}: ${description}` : identifier\n    )\n    let settings\n    let item\n    if (this.props.opticalPath.isMonochromatic) {\n      // monochrome images that can be pseudo-colored\n      let colorSettings\n      if (this.state.currentStyle.color != null) {\n        colorSettings = (\n          <>\n            <Divider plain>\n              Color\n            </Divider>\n            <Row justify='center' align='middle' gutter={[8, 8]}>\n              <Col span={5}>\n                Red\n              </Col>\n              <Col span={14}>\n                <Slider\n                  range={false}\n                  min={0}\n                  max={255}\n                  step={1}\n                  value={this.state.currentStyle.color[0]}\n                  onChange={this.handleColorRChange}\n                />\n              </Col>\n              <Col span={5}>\n                <InputNumber\n                  min={0}\n                  max={255}\n                  size='small'\n                  style={{ width: '65px' }}\n                  value={this.state.currentStyle.color[0]}\n                  onChange={this.handleColorRChange}\n                />\n              </Col>\n            </Row>\n\n            <Row justify='center' align='middle' gutter={[8, 8]}>\n              <Col span={5}>\n                Green\n              </Col>\n              <Col span={14}>\n                <Slider\n                  range={false}\n                  min={0}\n                  max={255}\n                  step={1}\n                  value={this.state.currentStyle.color[1]}\n                  onChange={this.handleColorGChange}\n                />\n              </Col>\n              <Col span={5}>\n                <InputNumber\n                  min={0}\n                  max={255}\n                  size='small'\n                  style={{ width: '65px' }}\n                  value={this.state.currentStyle.color[1]}\n                  onChange={this.handleColorGChange}\n                />\n              </Col>\n            </Row>\n\n            <Row justify='center' align='middle' gutter={[8, 8]}>\n              <Col span={5}>\n                Blue\n              </Col>\n              <Col span={14}>\n                <Slider\n                  range={false}\n                  min={0}\n                  max={255}\n                  step={1}\n                  value={this.state.currentStyle.color[2]}\n                  onChange={this.handleColorBChange}\n                />\n              </Col>\n              <Col span={5}>\n                <InputNumber\n                  min={0}\n                  max={255}\n                  size='small'\n                  style={{ width: '65px' }}\n                  value={this.state.currentStyle.color[2]}\n                  onChange={this.handleColorBChange}\n                />\n              </Col>\n            </Row>\n          </>\n        )\n      } else {\n        colorSettings = (\n          <>\n            <Divider plain>\n              Color\n            </Divider>\n            Custom pseudo-coloring is disabled because pixels are colorized via\n            a provided palette color lookup table.\n          </>\n        )\n      }\n\n      let windowSettings\n      if (this.state.currentStyle.limitValues != null) {\n        windowSettings = (\n          <>\n            <Divider plain>\n              Values of interest\n            </Divider>\n            <Row justify='center' align='middle' gutter={[8, 8]}>\n              <Col span={6}>\n                <InputNumber\n                  min={0}\n                  max={this.state.currentStyle.limitValues[1]}\n                  size='small'\n                  style={{ width: '75px' }}\n                  value={this.state.currentStyle.limitValues[0]}\n                  onChange={this.handleLowerLimitChange}\n                />\n              </Col>\n              <Col span={12}>\n                <Slider\n                  range\n                  min={0}\n                  max={maxValue}\n                  step={1}\n                  value={[\n                    this.state.currentStyle.limitValues[0],\n                    this.state.currentStyle.limitValues[1]\n                  ]}\n                  onChange={this.handleLimitChange}\n                />\n              </Col>\n              <Col span={6}>\n                <InputNumber\n                  min={this.state.currentStyle.limitValues[0]}\n                  max={maxValue}\n                  size='small'\n                  style={{ width: '75px' }}\n                  value={this.state.currentStyle.limitValues[1]}\n                  onChange={this.handleUpperLimitChange}\n                />\n              </Col>\n            </Row>\n          </>\n        )\n      }\n      settings = (\n        <div>\n          {windowSettings}\n          {colorSettings}\n          <Divider plain />\n          <Row justify='center' align='middle' gutter={[8, 8]}>\n            <Col span={6}>\n              Opacity\n            </Col>\n            <Col span={12}>\n              <Slider\n                range={false}\n                min={0}\n                max={1}\n                step={0.01}\n                value={this.state.currentStyle.opacity}\n                onChange={this.handleOpacityChange}\n              />\n            </Col>\n            <Col span={6}>\n              <InputNumber\n                min={0}\n                max={1}\n                size='small'\n                step={0.1}\n                style={{ width: '65px' }}\n                value={this.state.currentStyle.opacity}\n                onChange={this.handleOpacityChange}\n              />\n            </Col>\n          </Row>\n        </div>\n      )\n      const colors = this.getCurrentColors()\n      item = (\n        <Badge\n          offset={[-20, 20]}\n          count={' '}\n          style={{\n            borderStyle: 'solid',\n            borderWidth: '1px',\n            borderColor: 'gray',\n            visibility: this.state.isVisible ? 'visible' : 'hidden',\n            backgroundImage: `linear-gradient(to right, ${colors.toString()})`\n          }}\n        >\n          <Description\n            header={title}\n            attributes={attributes}\n            selectable\n            hasLongValues\n          />\n        </Badge>\n      )\n    } else {\n      // color images\n      settings = (\n        <div>\n          <Row justify='center' align='middle' gutter={[8, 8]}>\n            <Col span={6}>\n              Opacity\n            </Col>\n            <Col span={12}>\n              <Slider\n                range={false}\n                min={0}\n                max={1}\n                step={0.01}\n                value={this.state.currentStyle.opacity}\n                onChange={this.handleOpacityChange}\n              />\n            </Col>\n            <Col span={6}>\n              <InputNumber\n                min={0}\n                max={1}\n                size='small'\n                step={0.1}\n                style={{ width: '60px' }}\n                value={this.state.currentStyle.opacity}\n                onChange={this.handleOpacityChange}\n              />\n            </Col>\n          </Row>\n        </div>\n      )\n      item = (\n        <Description\n          header={title}\n          attributes={attributes}\n          selectable\n          hasLongValues\n        />\n      )\n    }\n\n    const buttons = []\n    if (this.props.isRemovable) {\n      buttons.push(\n        <Tooltip title='Remove Optical Path'>\n          <Button\n            type='default'\n            shape='circle'\n            icon={<DeleteOutlined />}\n            onClick={this.handleRemoval}\n          />\n        </Tooltip>\n      )\n    }\n\n    const {\n      defaultStyle,\n      isRemovable,\n      isVisible,\n      metadata,\n      onVisibilityChange,\n      onStyleChange,\n      onRemoval,\n      opticalPath,\n      ...otherProps\n    } = this.props\n    return (\n      <Menu.Item\n        style={{ height: '100%', paddingLeft: '3px' }}\n        key={this.props.opticalPath.identifier}\n        {...otherProps}\n      >\n        <Space align='start'>\n          <div style={{ paddingLeft: '14px' }}>\n            <Space direction='vertical' align='end'>\n              <Switch\n                size='small'\n                checked={this.state.isVisible}\n                onChange={this.handleVisibilityChange}\n                checkedChildren={<EyeOutlined />}\n                unCheckedChildren={<EyeInvisibleOutlined />}\n              />\n              <Popover\n                placement='left'\n                content={settings}\n                overlayStyle={{ width: '350px' }}\n                title='Display Settings'\n              >\n                <Button\n                  type='primary'\n                  shape='circle'\n                  icon={<SettingOutlined />}\n                />\n              </Popover>\n              {buttons}\n            </Space>\n          </div>\n          {item}\n        </Space>\n      </Menu.Item>\n    )\n  }\n}\n\nexport default OpticalPathItem\n","import React from 'react'\nimport * as dmv from 'dicom-microscopy-viewer'\nimport { Button as Btn, Menu, Select, Space, Tooltip } from 'antd'\nimport { AppstoreAddOutlined } from '@ant-design/icons'\n\nimport OpticalPathItem from './OpticalPathItem'\n\nconst { Option } = Select\n\ninterface OpticalPathListProps {\n  opticalPaths: dmv.opticalPath.OpticalPath[]\n  metadata: {\n    [opticalPathIdentifier: string]: dmv.metadata.VLWholeSlideMicroscopyImage[]\n  }\n  visibleOpticalPathIdentifiers: Set<string>\n  activeOpticalPathIdentifiers: Set<string>\n  defaultOpticalPathStyles: {\n    [opticalPathIdentifier: string]: {\n      opacity: number\n      color?: number[]\n      limitValues?: number[]\n      paletteColorLookupTable?: dmv.color.PaletteColorLookupTable\n    }\n  }\n  onOpticalPathVisibilityChange: ({ opticalPathIdentifier, isVisible }: {\n    opticalPathIdentifier: string\n    isVisible: boolean\n  }) => void\n  onOpticalPathStyleChange: ({ opticalPathIdentifier, styleOptions }: {\n    opticalPathIdentifier: string\n    styleOptions: {\n      opacity?: number\n      color?: number[]\n      limitValues?: number[]\n    }\n  }) => void\n  onOpticalPathActivityChange: ({ opticalPathIdentifier, isActive }: {\n    opticalPathIdentifier: string\n    isActive: boolean\n  }) => void\n  selectedPresentationStateUID?: string\n}\n\ninterface OpticalPathListState {\n  selectedOpticalPathIdentifier?: string\n}\n\n/**\n * React component representing a list of optical paths.\n */\nclass OpticalPathList extends React.Component<OpticalPathListProps, OpticalPathListState> {\n  state = {\n    selectedOpticalPathIdentifier: undefined\n  }\n\n  constructor (props: OpticalPathListProps) {\n    super(props)\n    this.handleItemAddition = this.handleItemAddition.bind(this)\n    this.handleItemRemoval = this.handleItemRemoval.bind(this)\n    this.handleItemSelectionChange = this.handleItemSelectionChange.bind(this)\n  }\n\n  /**\n   * Handler that gets called when an optical path should be removed.\n   */\n  handleItemRemoval (opticalPathIdentifier: string): void {\n    this.props.onOpticalPathActivityChange({\n      opticalPathIdentifier,\n      isActive: false\n    })\n  }\n\n  /**\n   * Handler that gets called when the selection of an optical path should change.\n   */\n  handleItemSelectionChange (\n    value: string\n  ): void {\n    this.setState({ selectedOpticalPathIdentifier: value })\n  }\n\n  /**\n   * Handler that gets called when an optical path should be added.\n   */\n  handleItemAddition (): void {\n    const identifier = this.state.selectedOpticalPathIdentifier\n    if (identifier !== undefined) {\n      this.props.onOpticalPathActivityChange({\n        opticalPathIdentifier: identifier,\n        isActive: true\n      })\n      this.setState({ selectedOpticalPathIdentifier: undefined })\n    }\n  }\n\n  render (): React.ReactNode {\n    if (this.props.metadata === undefined) {\n      return null\n    }\n\n    const isSelectable = this.props.opticalPaths.length > 1\n    const opticalPathItems: React.ReactNode[] = []\n    const optionItems: React.ReactNode[] = []\n    this.props.opticalPaths.forEach(opticalPath => {\n      const opticalPathIdentifier = opticalPath.identifier\n      const images = this.props.metadata[opticalPathIdentifier]\n      const seriesInstanceUID = images[0].SeriesInstanceUID\n      images[0].OpticalPathSequence.forEach(opticalPathItem => {\n        const id = opticalPathItem.OpticalPathIdentifier\n        const description = opticalPathItem.OpticalPathDescription\n        if (opticalPath.identifier === id) {\n          if (this.props.activeOpticalPathIdentifiers.has(id)) {\n            opticalPathItems.push(\n              <OpticalPathItem\n                key={`${seriesInstanceUID}-${id}`}\n                opticalPath={opticalPath}\n                metadata={images}\n                isVisible={this.props.visibleOpticalPathIdentifiers.has(id)}\n                defaultStyle={this.props.defaultOpticalPathStyles[id]}\n                onVisibilityChange={this.props.onOpticalPathVisibilityChange}\n                onStyleChange={this.props.onOpticalPathStyleChange}\n                onRemoval={this.handleItemRemoval}\n                isRemovable={isSelectable}\n              />\n            )\n          } else {\n            let title\n            if (description !== '') {\n              title = `${id} - ${description}`\n            } else {\n              title = `${id}`\n            }\n            optionItems.push(\n              <Option key={id} value={id}>{title}</Option>\n            )\n          }\n        }\n      })\n    })\n\n    let opticalPathSelector\n    if (isSelectable) {\n      opticalPathSelector = (\n        <Space align='center' size={20} style={{ padding: '14px' }}>\n          <Select\n            defaultValue=''\n            style={{ width: 200 }}\n            onChange={this.handleItemSelectionChange}\n            value={this.state.selectedOpticalPathIdentifier}\n            allowClear\n          >\n            {optionItems}\n          </Select>\n          <Tooltip title='Add'>\n            <Btn\n              icon={<AppstoreAddOutlined />}\n              type='primary'\n              onClick={this.handleItemAddition}\n            />\n          </Tooltip>\n        </Space>\n      )\n    }\n\n    return (\n      <Menu selectable={false}>\n        {opticalPathItems}\n        {opticalPathSelector}\n      </Menu>\n    )\n  }\n}\n\nexport default OpticalPathList\n","import React from 'react'\nimport * as dmv from 'dicom-microscopy-viewer'\nimport {\n  Button,\n  Col,\n  InputNumber,\n  Menu,\n  Popover,\n  Row,\n  Slider,\n  Space,\n  Switch\n} from 'antd'\nimport { SettingOutlined } from '@ant-design/icons'\nimport { FaEye, FaEyeSlash } from 'react-icons/fa'\n\nimport Description from './Description'\n\ninterface MappingItemProps {\n  mapping: dmv.mapping.ParameterMapping\n  metadata: dmv.metadata.ParametricMap[]\n  isVisible: boolean\n  defaultStyle: {\n    opacity: number\n  }\n  onVisibilityChange: ({ mappingUID, isVisible }: {\n    mappingUID: string\n    isVisible: boolean\n  }) => void\n  onStyleChange: ({ mappingUID, styleOptions }: {\n    mappingUID: string\n    styleOptions: {\n      opacity?: number\n    }\n  }) => void\n}\n\ninterface MappingItemState {\n  isVisible: boolean\n  currentStyle: {\n    opacity: number\n  }\n}\n\n/**\n * React component representing a Real World Value Mapping.\n */\nclass MappingItem extends React.Component<MappingItemProps, MappingItemState> {\n  constructor (props: MappingItemProps) {\n    super(props)\n    this.handleVisibilityChange = this.handleVisibilityChange.bind(this)\n    this.handleOpacityChange = this.handleOpacityChange.bind(this)\n    this.state = {\n      isVisible: this.props.isVisible,\n      currentStyle: {\n        opacity: this.props.defaultStyle.opacity\n      }\n    }\n  }\n\n  handleVisibilityChange (\n    checked: boolean,\n    event: React.MouseEvent<HTMLButtonElement>\n  ): void {\n    this.props.onVisibilityChange({\n      mappingUID: this.props.mapping.uid,\n      isVisible: checked\n    })\n    this.setState({ isVisible: checked })\n  }\n\n  handleOpacityChange (value: number | null): void {\n    if (value != null) {\n      this.props.onStyleChange({\n        mappingUID: this.props.mapping.uid,\n        styleOptions: {\n          opacity: value\n        }\n      })\n      this.setState(state => ({\n        currentStyle: {\n          opacity: value\n        }\n      }))\n    }\n  }\n\n  render (): React.ReactNode {\n    const attributes: Array<{ name: string, value: string }> = [\n      {\n        name: 'Description',\n        value: this.props.mapping.description\n      }\n    ]\n\n    const settings = (\n      <div>\n        <Row justify='center' align='middle'>\n          <Col span={6}>\n            Opacity\n          </Col>\n          <Col span={12}>\n            <Slider\n              range={false}\n              min={0}\n              max={1}\n              step={0.01}\n              value={this.state.currentStyle.opacity}\n              onChange={this.handleOpacityChange}\n            />\n          </Col>\n          <Col span={6}>\n            <InputNumber\n              min={0}\n              max={1}\n              size='small'\n              step={0.1}\n              style={{ width: '65px' }}\n              value={this.state.currentStyle.opacity}\n              onChange={this.handleOpacityChange}\n            />\n          </Col>\n        </Row>\n      </div>\n    )\n\n    /**\n     * This hack is required for Menu.Item to work properly:\n     * https://github.com/react-component/menu/issues/142\n     */\n    const {\n      defaultStyle,\n      isVisible,\n      mapping,\n      metadata,\n      onVisibilityChange,\n      onStyleChange,\n      ...otherProps\n    } = this.props\n    return (\n      <Menu.Item\n        style={{ height: '100%', paddingLeft: '3px' }}\n        key={this.props.mapping.uid}\n        {...otherProps}\n      >\n        <Space align='start'>\n          <div style={{ paddingLeft: '14px' }}>\n            <Space direction='vertical' align='end' size={100}>\n              <Space direction='vertical' align='end'>\n                <Switch\n                  size='small'\n                  onChange={this.handleVisibilityChange}\n                  checked={this.props.isVisible}\n                  checkedChildren={<FaEye />}\n                  unCheckedChildren={<FaEyeSlash />}\n                />\n                <Popover\n                  placement='left'\n                  content={settings}\n                  overlayStyle={{ width: '350px' }}\n                  title='Display Settings'\n                >\n                  <Button\n                    type='primary'\n                    shape='circle'\n                    icon={<SettingOutlined />}\n                  />\n                </Popover>\n              </Space>\n            </Space>\n          </div>\n          <Description\n            header={this.props.mapping.label}\n            attributes={attributes}\n            selectable\n            hasLongValues\n          />\n        </Space>\n      </Menu.Item>\n    )\n  }\n}\n\nexport default MappingItem\n","import React from 'react'\nimport * as dmv from 'dicom-microscopy-viewer'\nimport { Menu } from 'antd'\n\nimport MappingItem from './MappingItem'\n\ninterface MappingListProps {\n  mappings: dmv.mapping.ParameterMapping[]\n  metadata: {\n    [mappingUID: string]: dmv.metadata.ParametricMap[]\n  }\n  visibleMappingUIDs: Set<string>\n  defaultMappingStyles: {\n    [mappingUID: string]: { opacity: number }\n  }\n  onMappingVisibilityChange: ({ mappingUID, isVisible }: {\n    mappingUID: string\n    isVisible: boolean\n  }) => void\n  onMappingStyleChange: ({ mappingUID, styleOptions }: {\n    mappingUID: string\n    styleOptions: {\n      opacity?: number\n    }\n  }) => void\n}\n\n/**\n * React component representing a list of Real World Value Mappings.\n */\nclass MappingList extends React.Component<MappingListProps, {}> {\n  render (): React.ReactNode {\n    const items = this.props.mappings.map((mapping, index) => {\n      const uid = mapping.uid\n      return (\n        <MappingItem\n          key={mapping.uid}\n          mapping={mapping}\n          metadata={this.props.metadata[uid]}\n          isVisible={this.props.visibleMappingUIDs.has(uid)}\n          defaultStyle={this.props.defaultMappingStyles[uid]}\n          onVisibilityChange={this.props.onMappingVisibilityChange}\n          onStyleChange={this.props.onMappingStyleChange}\n        />\n      )\n    })\n\n    return (\n      <Menu selectable={false}>\n        {items}\n      </Menu>\n    )\n  }\n}\n\nexport default MappingList\n","import React from 'react'\nimport * as dmv from 'dicom-microscopy-viewer'\nimport {\n  Button,\n  Col,\n  InputNumber,\n  Menu,\n  Popover,\n  Row,\n  Slider,\n  Space,\n  Switch\n} from 'antd'\nimport { SettingOutlined } from '@ant-design/icons'\nimport { FaEye, FaEyeSlash } from 'react-icons/fa'\n\nimport Description from './Description'\n\ninterface SegmentItemProps {\n  segment: dmv.segment.Segment\n  isVisible: boolean\n  metadata: dmv.metadata.Segmentation[]\n  defaultStyle: {\n    opacity: number\n  }\n  onVisibilityChange: ({ segmentUID, isVisible }: {\n    segmentUID: string\n    isVisible: boolean\n  }) => void\n  onStyleChange: ({ segmentUID, styleOptions }: {\n    segmentUID: string\n    styleOptions: {\n      opacity: number\n    }\n  }) => void\n}\n\ninterface SegmentItemState {\n  isVisible: boolean\n  currentStyle: {\n    opacity: number\n  }\n}\n\n/**\n * React component representing a Segment.\n */\nclass SegmentItem extends React.Component<SegmentItemProps, SegmentItemState> {\n  constructor (props: SegmentItemProps) {\n    super(props)\n    this.handleVisibilityChange = this.handleVisibilityChange.bind(this)\n    this.handleOpacityChange = this.handleOpacityChange.bind(this)\n    this.state = {\n      isVisible: this.props.isVisible,\n      currentStyle: { opacity: this.props.defaultStyle.opacity }\n    }\n  }\n\n  handleVisibilityChange (\n    checked: boolean,\n    event: React.MouseEvent<HTMLButtonElement>\n  ): void {\n    this.props.onVisibilityChange({\n      segmentUID: this.props.segment.uid,\n      isVisible: checked\n    })\n    this.setState({ isVisible: checked })\n  }\n\n  handleOpacityChange (value: number | null): void {\n    if (value != null) {\n      this.props.onStyleChange({\n        segmentUID: this.props.segment.uid,\n        styleOptions: {\n          opacity: value\n        }\n      })\n      this.setState({ currentStyle: { opacity: value } })\n    }\n  }\n\n  render (): React.ReactNode {\n    const attributes: Array<{ name: string, value: string }> = [\n      {\n        name: 'Property Type',\n        value: this.props.segment.propertyType.CodeMeaning\n      },\n      {\n        name: 'Property Category',\n        value: this.props.segment.propertyCategory.CodeMeaning\n      },\n      {\n        name: 'Algorithm Name',\n        value: this.props.segment.algorithmName\n      }\n    ]\n\n    const settings = (\n      <div>\n        <Row justify='center' align='middle'>\n          <Col span={6}>\n            Opacity\n          </Col>\n          <Col span={12}>\n            <Slider\n              range={false}\n              min={0}\n              max={1}\n              step={0.01}\n              value={this.state.currentStyle.opacity}\n              onChange={this.handleOpacityChange}\n            />\n          </Col>\n          <Col span={6}>\n            <InputNumber\n              min={0}\n              max={1}\n              size='small'\n              step={0.1}\n              style={{ width: '65px' }}\n              value={this.state.currentStyle.opacity}\n              onChange={this.handleOpacityChange}\n            />\n          </Col>\n        </Row>\n      </div>\n    )\n\n    /**\n     * This hack is required for Menu.Item to work properly:\n     * https://github.com/react-component/menu/issues/142\n     */\n    const {\n      defaultStyle,\n      isVisible,\n      segment,\n      metadata,\n      onVisibilityChange,\n      onStyleChange,\n      ...otherProps\n    } = this.props\n    return (\n      <Menu.Item\n        style={{ height: '100%', paddingLeft: '3px' }}\n        key={this.props.segment.uid}\n        {...otherProps}\n      >\n        <Space align='start'>\n          <div style={{ paddingLeft: '14px' }}>\n            <Space direction='vertical' align='end'>\n              <Switch\n                size='small'\n                onChange={this.handleVisibilityChange}\n                checked={this.props.isVisible}\n                checkedChildren={<FaEye />}\n                unCheckedChildren={<FaEyeSlash />}\n              />\n              <Popover\n                placement='left'\n                content={settings}\n                overlayStyle={{ width: '350px' }}\n                title='Display Settings'\n              >\n                <Button\n                  type='primary'\n                  shape='circle'\n                  icon={<SettingOutlined />}\n                />\n              </Popover>\n            </Space>\n          </div>\n          <Description\n            header={this.props.segment.label}\n            attributes={attributes}\n            selectable\n            hasLongValues\n          />\n        </Space>\n      </Menu.Item>\n    )\n  }\n}\n\nexport default SegmentItem\n","import React from 'react'\nimport * as dmv from 'dicom-microscopy-viewer'\nimport { Menu } from 'antd'\n\nimport SegmentItem from './SegmentItem'\n\ninterface SegmentListProps {\n  segments: dmv.segment.Segment[]\n  visibleSegmentUIDs: Set<string>\n  metadata: {\n    [segmentUID: string]: dmv.metadata.Segmentation[]\n  }\n  defaultSegmentStyles: {\n    [segmentUID: string]: {\n      opacity: number\n    }\n  }\n  onSegmentVisibilityChange: ({ segmentUID, isVisible }: {\n    segmentUID: string\n    isVisible: boolean\n  }) => void\n  onSegmentStyleChange: ({ segmentUID, styleOptions }: {\n    segmentUID: string\n    styleOptions: {\n      opacity: number\n    }\n  }) => void\n}\n\n/**\n * React component representing a list of Segments.\n */\nclass SegmentList extends React.Component<SegmentListProps, {}> {\n  render (): React.ReactNode {\n    const items = this.props.segments.map((segment, index) => {\n      const uid = segment.uid\n      return (\n        <SegmentItem\n          key={segment.uid}\n          segment={segment}\n          metadata={this.props.metadata[uid]}\n          isVisible={this.props.visibleSegmentUIDs.has(uid)}\n          defaultStyle={this.props.defaultSegmentStyles[uid]}\n          onVisibilityChange={this.props.onSegmentVisibilityChange}\n          onStyleChange={this.props.onSegmentStyleChange}\n        />\n      )\n    })\n\n    return (\n      <Menu selectable={false}>\n        {items}\n      </Menu>\n    )\n  }\n}\n\nexport default SegmentList\n","import React from 'react'\nimport {\n  NavigateFunction,\n  Params,\n  useLocation,\n  useNavigate,\n  useParams,\n  Location\n} from 'react-router-dom'\n\nexport interface RouteComponentProps {\n  location: Location\n  navigate: NavigateFunction\n  params: Params<string>\n}\n\nexport function withRouter<T> (Component: React.ComponentType<T>): Function {\n  function ComponentWithRouterProp (props: any): JSX.Element {\n    const location = useLocation()\n    const navigate = useNavigate()\n    const params = useParams()\n    return (\n      <Component\n        {...props}\n        location={location}\n        navigate={navigate}\n        params={params}\n      />\n    )\n  }\n  return ComponentWithRouterProp\n}\n","import React from 'react'\nimport { Checkbox, Col, Divider, InputNumber, Row, Slider } from 'antd'\n\ninterface ColorSettingsMenuProps {\n  annotationGroupsUIDs: string[]\n  defaultStyle: {\n    opacity: number\n    color: number[]\n    contourOnly: boolean\n  }\n  onStyleChange: Function\n}\n\ninterface ColorSettingsMenuState {\n  currentStyle: {\n    opacity: number\n    color?: number[]\n    contourOnly: boolean\n  }\n}\n\n/**\n * React component representing an Annotation Group.\n */\nclass ColorSettingsMenu extends React.Component<\nColorSettingsMenuProps,\nColorSettingsMenuState\n> {\n  constructor (props: ColorSettingsMenuProps) {\n    super(props)\n    this.handleOpacityChange = this.handleOpacityChange.bind(this)\n    this.handleColorRChange = this.handleColorRChange.bind(this)\n    this.handleColorGChange = this.handleColorGChange.bind(this)\n    this.handleColorBChange = this.handleColorBChange.bind(this)\n    this.getCurrentColor = this.getCurrentColor.bind(this)\n    this.state = {\n      currentStyle: {\n        opacity: this.props.defaultStyle.opacity,\n        color: this.props.defaultStyle.color,\n        contourOnly: this.props.defaultStyle.contourOnly\n      }\n    }\n  }\n\n  handleOpacityChange (value: number | null): void {\n    if (value != null) {\n      this.props.annotationGroupsUIDs.forEach((uid) => {\n        this.props.onStyleChange({\n          uid,\n          styleOptions: {\n            color: this.state.currentStyle.color,\n            opacity: value,\n            contourOnly: this.state.currentStyle.contourOnly\n          }\n        })\n      })\n      this.updateCurrentStyle({ opacity: value })\n    }\n  }\n\n  handleColorRChange (value: number | number[] | null): void {\n    if (value != null && this.state.currentStyle.color !== undefined) {\n      const color = [\n        Array.isArray(value) ? value[0] : value,\n        this.state.currentStyle.color[1],\n        this.state.currentStyle.color[2]\n      ]\n      this.updateCurrentStyle({ color })\n      this.props.annotationGroupsUIDs.forEach((uid) => {\n        this.props.onStyleChange({\n          uid,\n          styleOptions: {\n            color: color,\n            opacity: this.state.currentStyle.opacity,\n            contourOnly: this.state.currentStyle.contourOnly\n          }\n        })\n      })\n    }\n  }\n\n  handleColorGChange (value: number | number[] | null): void {\n    if (value != null && this.state.currentStyle.color !== undefined) {\n      const color = [\n        this.state.currentStyle.color[0],\n        Array.isArray(value) ? value[0] : value,\n        this.state.currentStyle.color[2]\n      ]\n      this.updateCurrentStyle({ color })\n      this.props.annotationGroupsUIDs.forEach((uid) => {\n        this.props.onStyleChange({\n          uid,\n          styleOptions: {\n            color: color,\n            opacity: this.state.currentStyle.opacity,\n            contourOnly: this.state.currentStyle.contourOnly\n          }\n        })\n      })\n    }\n  }\n\n  handleColorBChange (value: number | number[] | null): void {\n    if (value != null && this.state.currentStyle.color !== undefined) {\n      const color = [\n        this.state.currentStyle.color[0],\n        this.state.currentStyle.color[1],\n        Array.isArray(value) ? value[0] : value\n      ]\n      this.updateCurrentStyle({ color })\n      this.props.annotationGroupsUIDs.forEach((uid) => {\n        this.props.onStyleChange({\n          uid,\n          styleOptions: {\n            color: color,\n            opacity: this.state.currentStyle.opacity,\n            contourOnly: this.state.currentStyle.contourOnly\n          }\n        })\n      })\n    }\n  }\n\n  handleShowOutlineOnly (value: boolean): void {\n    this.updateCurrentStyle({ contourOnly: value })\n\n    this.props.annotationGroupsUIDs.forEach((uid) => {\n      this.props.onStyleChange({\n        uid,\n        styleOptions: {\n          color: this.state.currentStyle.color,\n          opacity: this.state.currentStyle.opacity,\n          contourOnly: value\n        }\n      })\n    })\n  }\n\n  getCurrentColor (): string {\n    const rgb2hex = (values: number[]): string => {\n      const r = values[0]\n      const g = values[1]\n      const b = values[2]\n      return '#' + (0x1000000 + (r << 16) + (g << 8) + b).toString(16).slice(1)\n    }\n\n    if (this.state.currentStyle.color != null) {\n      return rgb2hex(this.state.currentStyle.color)\n    } else {\n      return 'white'\n    }\n  }\n\n  updateCurrentStyle ({\n    color,\n    opacity,\n    contourOnly\n  }: {\n    color?: number[]\n    opacity?: number\n    contourOnly?: boolean\n  }): void {\n    this.setState((state) => ({\n      currentStyle: {\n        opacity: opacity ?? state.currentStyle.opacity,\n        color: color ?? state.currentStyle.color,\n        contourOnly: contourOnly ?? state.currentStyle.contourOnly\n      }\n    }))\n  }\n\n  render (): React.ReactNode {\n    let colorSettings\n    if (this.state.currentStyle.color != null) {\n      colorSettings = (\n        <>\n          <Divider plain>Color</Divider>\n          <Row justify='center' align='middle' gutter={[8, 8]}>\n            <Col span={5}>Red</Col>\n            <Col span={14}>\n              <Slider\n                range={false}\n                min={0}\n                max={255}\n                step={1}\n                value={this.state.currentStyle.color[0]}\n                onChange={this.handleColorRChange}\n              />\n            </Col>\n            <Col span={5}>\n              <InputNumber\n                min={0}\n                max={255}\n                size='small'\n                style={{ width: '65px' }}\n                value={this.state.currentStyle.color[0]}\n                onChange={this.handleColorRChange}\n              />\n            </Col>\n          </Row>\n\n          <Row justify='center' align='middle' gutter={[8, 8]}>\n            <Col span={5}>Green</Col>\n            <Col span={14}>\n              <Slider\n                range={false}\n                min={0}\n                max={255}\n                step={1}\n                value={this.state.currentStyle.color[1]}\n                onChange={this.handleColorGChange}\n              />\n            </Col>\n            <Col span={5}>\n              <InputNumber\n                min={0}\n                max={255}\n                size='small'\n                style={{ width: '65px' }}\n                value={this.state.currentStyle.color[1]}\n                onChange={this.handleColorGChange}\n              />\n            </Col>\n          </Row>\n\n          <Row justify='center' align='middle' gutter={[8, 8]}>\n            <Col span={5}>Blue</Col>\n            <Col span={14}>\n              <Slider\n                range={false}\n                min={0}\n                max={255}\n                step={1}\n                value={this.state.currentStyle.color[2]}\n                onChange={this.handleColorBChange}\n              />\n            </Col>\n            <Col span={5}>\n              <InputNumber\n                min={0}\n                max={255}\n                size='small'\n                style={{ width: '65px' }}\n                value={this.state.currentStyle.color[2]}\n                onChange={this.handleColorBChange}\n              />\n            </Col>\n          </Row>\n          <Divider plain />\n        </>\n      )\n    }\n\n    return (\n      <div>\n        {colorSettings}\n        <Row justify='start' align='middle' gutter={[8, 8]}>\n          <Col span={6}>Opacity</Col>\n          <Col span={12}>\n            <Slider\n              range={false}\n              min={0}\n              max={1}\n              step={0.01}\n              value={this.state.currentStyle.opacity}\n              onChange={this.handleOpacityChange}\n            />\n          </Col>\n          <Col span={6}>\n            <InputNumber\n              min={0}\n              max={1}\n              size='small'\n              step={0.1}\n              style={{ width: '65px' }}\n              value={this.state.currentStyle.opacity}\n              onChange={this.handleOpacityChange}\n            />\n          </Col>\n        </Row>\n        <Row justify='start' align='middle' gutter={[8, 8]}>\n          <Checkbox\n            value={this.state.currentStyle.contourOnly}\n            onChange={(event) =>\n              this.handleShowOutlineOnly(event.target.checked)}\n          >\n            Show outline only\n          </Checkbox>\n        </Row>\n      </div>\n    )\n  }\n}\n\nexport default ColorSettingsMenu\n","import React from 'react'\nimport { Menu, Space, Checkbox, Tooltip, Popover, Button } from 'antd'\nimport { SettingOutlined } from '@ant-design/icons'\nimport { Category, Type } from './AnnotationCategoryList'\nimport ColorSettingsMenu from './ColorSettingsMenu'\n\nconst AnnotationCategoryItem = ({\n  category,\n  onChange,\n  checkedAnnotationUids,\n  onStyleChange,\n  defaultAnnotationStyles,\n  ...props\n}: {\n  category: Category\n  onChange: Function\n  onStyleChange: Function\n  defaultAnnotationStyles: {\n    [annotationUID: string]: {\n      opacity: number\n      color: number[]\n      contourOnly: boolean\n    }\n  }\n  checkedAnnotationUids: Set<string>\n}): JSX.Element => {\n  const { types } = category\n\n  const onCheckCategoryChange = (e: any): void => {\n    const isVisible = e.target.checked\n    types.forEach((type: Type) => {\n      handleChangeCheckedType({ type, isVisible })\n    })\n  }\n\n  const checkAll = types.every((type: Type) =>\n    type.uids.every((uid: string) => checkedAnnotationUids.has(uid))\n  )\n  const indeterminate =\n    !checkAll &&\n    types.some((type: Type) =>\n      type.uids.some((uid: string) => checkedAnnotationUids.has(uid))\n    )\n\n  const handleChangeCheckedType = ({\n    type,\n    isVisible\n  }: {\n    type: Type\n    isVisible: boolean\n  }): void => {\n    type.uids.forEach((uid: string) => {\n      onChange({ roiUID: uid, isVisible })\n    })\n  }\n\n  return (\n    <Menu.Item\n      style={{ height: '100%', paddingLeft: '3px' }}\n      {...props}\n    >\n      <Space align='start'>\n        <div style={{ paddingLeft: '14px', color: 'black' }}>\n          <Space direction='vertical' align='end'>\n            <Checkbox\n              indeterminate={indeterminate}\n              checked={checkAll}\n              onChange={onCheckCategoryChange}\n            >\n              <Tooltip\n                title={`${category.CodeValue}:${category.CodingSchemeDesignator}`}\n                mouseEnterDelay={1}\n              >\n                {category.CodeMeaning}\n              </Tooltip>\n              <Popover\n                placement='topLeft'\n                overlayStyle={{ width: '350px' }}\n                title='Display Settings'\n                content={() => (\n                  <ColorSettingsMenu\n                    annotationGroupsUIDs={types.reduce(\n                      (acc: string[], type) => {\n                        return [...acc, ...type.uids]\n                      },\n                      []\n                    )}\n                    onStyleChange={onStyleChange}\n                    defaultStyle={\n                      defaultAnnotationStyles[types[0].uids[0]]\n                    }\n                  />\n                )}\n              >\n                <Button\n                  type='primary'\n                  shape='circle'\n                  style={{ marginLeft: '10px' }}\n                  icon={<SettingOutlined />}\n                />\n              </Popover>\n            </Checkbox>\n          </Space>\n          {types.map((type: Type) => {\n            const { CodeMeaning, CodingSchemeDesignator, CodeValue, uids } =\n              type\n            const shortenedCodeMeaning = CodeMeaning.slice(0, 22)\n            const displayCodeMeaning = shortenedCodeMeaning === CodeMeaning ? CodeMeaning : `${shortenedCodeMeaning}...`\n            const isChecked = uids.every((uid: string) =>\n              checkedAnnotationUids.has(uid)\n            )\n            const indeterminateType =\n              !isChecked &&\n              uids.some((uid: string) => checkedAnnotationUids.has(uid))\n            return (\n              <div\n                key={`${type.CodingSchemeDesignator}:${type.CodeMeaning}`}\n                style={{\n                  paddingLeft: '25px',\n                  width: '100%',\n                  display: 'flex',\n                  flexDirection: 'row'\n                }}\n              >\n                <Checkbox\n                  indeterminate={indeterminateType}\n                  checked={isChecked}\n                  onChange={(e: any) =>\n                    handleChangeCheckedType({\n                      type,\n                      isVisible: e.target.checked\n                    })}\n                />\n                <div style={{ paddingLeft: '5px' }}>\n                  <Tooltip\n                    title={`${CodeValue}:${CodingSchemeDesignator}`}\n                    mouseEnterDelay={1}\n                  >\n                    {displayCodeMeaning}\n                  </Tooltip>\n                  <Popover\n                    placement='topLeft'\n                    overlayStyle={{ width: '350px' }}\n                    title='Display Settings'\n                    content={() => (\n                      <ColorSettingsMenu\n                        annotationGroupsUIDs={type.uids}\n                        onStyleChange={onStyleChange}\n                        defaultStyle={defaultAnnotationStyles[type.uids[0]]}\n                      />\n                    )}\n                  >\n                    <Button\n                      type='primary'\n                      shape='circle'\n                      style={{ marginLeft: '10px' }}\n                      icon={<SettingOutlined />}\n                    />\n                  </Popover>\n                </div>\n              </div>\n            )\n          })}\n        </div>\n      </Space>\n    </Menu.Item>\n  )\n}\n\nexport default AnnotationCategoryItem\n","import React from 'react'\nimport { Menu } from 'antd'\nimport AnnotationCategoryItem from './AnnotationCategoryItem'\n\nexport interface AnnotationCategoryAndType {\n  uid: string\n  type: Omit<Type, 'uids'>\n  category: Omit<Category, 'types'>\n}\nexport interface Type {\n  CodeValue: string\n  CodeMeaning: string\n  CodingSchemeDesignator: string\n  uids: string[]\n}\nexport interface Category {\n  CodeValue: string\n  CodeMeaning: string\n  CodingSchemeDesignator: string\n  types: Type[]\n}\n\nconst getCategories = (annotations: any): Record<string, Category> => {\n  const categories = annotations?.reduce(\n    (\n      categoriesAcc: Record<string, Category & { types: Record<string, Type> }>,\n      annotation: AnnotationCategoryAndType\n    ) => {\n      const { category, type, uid } = annotation\n      const categoryKey = category.CodeMeaning\n      const typeKey = type.CodeMeaning\n\n      const oldCategory = categoriesAcc[categoryKey] ?? {\n        ...category,\n        types: {}\n      }\n      const oldType = oldCategory.types[typeKey] ?? {\n        ...type,\n        uids: []\n      }\n\n      return {\n        ...categoriesAcc,\n        [categoryKey]: {\n          ...oldCategory,\n          types: {\n            ...oldCategory.types,\n            [typeKey]: { ...oldType, uids: [...oldType.uids, uid] }\n          }\n        }\n      }\n    },\n    {}\n  )\n\n  // Normalizing types so that it's an array instead of an object:\n  Object.keys(categories).forEach((categoryKey: string) => {\n    const category = categories[categoryKey]\n    const { types } = category\n    const typesArr = Object.keys(types).map(\n      (typeKey: string) => types[typeKey]\n    )\n    categories[categoryKey].types = typesArr\n  })\n\n  return categories\n}\n\nconst AnnotationCategoryList = ({\n  annotations,\n  onChange,\n  onStyleChange,\n  defaultAnnotationStyles,\n  checkedAnnotationUids\n}: {\n  annotations: AnnotationCategoryAndType[]\n  onChange: Function\n  onStyleChange: Function\n  defaultAnnotationStyles: {\n    [annotationUID: string]: {\n      opacity: number\n      color: number[]\n      contourOnly: boolean\n    }\n  }\n  checkedAnnotationUids: Set<string>\n}): JSX.Element => {\n  const categories: Record<string, Category> = getCategories(annotations)\n\n  if (Object.keys(categories).length === 0) {\n    return <></>\n  }\n\n  const items = Object.keys(categories).map((categoryKey: string) => {\n    const category = categories[categoryKey]\n    return (\n      <AnnotationCategoryItem\n        key={category.CodeMeaning !== '' ? category.CodeMeaning : `category-${categoryKey}`}\n        category={category}\n        onChange={onChange}\n        onStyleChange={onStyleChange}\n        defaultAnnotationStyles={defaultAnnotationStyles}\n        checkedAnnotationUids={checkedAnnotationUids}\n      />\n    )\n  })\n\n  return <Menu selectable={false}>{items}</Menu>\n}\nexport default AnnotationCategoryList\n","const HoveredRoiTooltip = ({\n  xPosition,\n  yPosition,\n  rois\n}: {\n  xPosition: number\n  yPosition: number\n  rois: Array<{ index: number, roiUid: string, attributes: Array<{ name: string, value: string }>}>\n}): JSX.Element => {\n  return (\n    <div\n      style={{\n        position: 'fixed',\n        top: `${yPosition}px`,\n        left: `${xPosition}px`,\n        backgroundColor: 'rgba(230, 230, 230, 0.65)',\n        minWidth: '150px',\n        minHeight: '60px',\n        padding: '20px',\n        fontWeight: 'bold',\n        pointerEvents: 'none'\n      }}\n    >\n      {rois.map((roi, i) => {\n        const attributes = roi.attributes\n        return (\n          <div key={roi.roiUid}>\n            <span>ROI {roi.index}</span>\n            {attributes.map((attr) => {\n              return (\n                <div key={attr.name + roi.roiUid}>\n                  {attr.name}: <span style={{ fontWeight: 500 }}>{attr.value}</span>\n                </div>\n              )\n            })}\n          </div>\n\n        )\n      })}\n    </div>\n  )\n}\n\nexport default HoveredRoiTooltip\n","import * as dmv from 'dicom-microscopy-viewer'\nimport * as dcmjs from 'dcmjs'\nimport { AnnotationCategoryAndType } from '../components/AnnotationCategoryList'\n\nexport const adaptRoiToAnnotation = (roi: dmv.roi.ROI): AnnotationCategoryAndType => {\n  const { uid, evaluations } = roi\n\n  const result = {\n    category: {\n      CodeValue: 'undefined',\n      CodeMeaning: 'undefined',\n      CodingSchemeDesignator: 'undefined'\n    },\n    type: {\n      CodeValue: 'undefined',\n      CodeMeaning: 'undefined',\n      CodingSchemeDesignator: 'undefined'\n    }\n  }\n\n  evaluations.forEach((\n    item: (\n      dcmjs.sr.valueTypes.TextContentItem |\n      dcmjs.sr.valueTypes.CodeContentItem\n    )\n  ) => {\n    const nameValue = item.ConceptNameCodeSequence[0].CodeValue\n    if (item.ValueType === dcmjs.sr.valueTypes.ValueTypes.CODE) {\n      const codeContentItem = item as dcmjs.sr.valueTypes.CodeContentItem\n      const value = codeContentItem.ConceptCodeSequence[0]\n      // For consistency with Segment and Annotation Group\n      if (nameValue === '276214006') {\n        result.category = { ...value }\n      } else if (nameValue === '121071') {\n        result.type = { ...value }\n      }\n    }\n  })\n\n  return {\n    ...result,\n    uid\n  }\n}\n","import * as dmv from 'dicom-microscopy-viewer'\nimport * as dcmjs from 'dcmjs'\n\nimport { CustomError, errorTypes } from '../utils/CustomError'\nimport NotificationMiddleware, {\n  NotificationMiddlewareContext\n} from '../services/NotificationMiddleware'\nimport { User } from '../auth'\n\ninterface AppInfo {\n  name: string\n  version: string\n  uid: string\n  organization?: string\n}\n\nconst generateReport = ({\n  rois,\n  metadata,\n  user,\n  app,\n  visibleRoiUIDs\n}: {\n  rois: dmv.roi.ROI[]\n  metadata: dmv.metadata.VLWholeSlideMicroscopyImage[]\n  user: User | undefined\n  app: AppInfo\n  visibleRoiUIDs: Set<string>\n}): { isReportModalVisible: boolean, generatedReport: dmv.metadata.Comprehensive3DSR } => {\n  // Metadata should be sorted such that the image with the highest\n  // resolution is the last item in the array.\n  const refImage = metadata[metadata.length - 1]\n  // We assume that there is only one specimen (tissue section) per\n  // ontainer (slide). Only the tissue section is tracked with a unique\n  // identifier, even if the section may be composed of different biological\n  // samples.\n  if ((refImage.SpecimenDescriptionSequence?.length ?? 0) > 1) {\n    NotificationMiddleware.onError(\n      NotificationMiddlewareContext.SLIM,\n      new CustomError(\n        errorTypes.VISUALIZATION,\n        'More than one specimen has been described for the slide'\n      )\n    )\n  }\n  const refSpecimen = refImage.SpecimenDescriptionSequence[0]\n\n  console.debug('create Observation Context')\n  let observer\n\n  if (user !== undefined) {\n    observer = new dcmjs.sr.templates.PersonObserverIdentifyingAttributes({\n      name: user.name ?? 'ANONYMOUS',\n      loginName: user.email ?? ''\n    })\n  } else {\n    console.warn('no user information available')\n    observer = new dcmjs.sr.templates.PersonObserverIdentifyingAttributes({\n      name: 'ANONYMOUS'\n    })\n  }\n\n  const observationContext = new dcmjs.sr.templates.ObservationContext({\n    observerPersonContext: new dcmjs.sr.templates.ObserverContext({\n      observerType: new dcmjs.sr.coding.CodedConcept({\n        value: '121006',\n        schemeDesignator: 'DCM',\n        meaning: 'Person'\n      }),\n      observerIdentifyingAttributes: observer\n    }),\n    observerDeviceContext: new dcmjs.sr.templates.ObserverContext({\n      observerType: new dcmjs.sr.coding.CodedConcept({\n        value: '121007',\n        schemeDesignator: 'DCM',\n        meaning: 'Device'\n      }),\n      observerIdentifyingAttributes: new dcmjs.sr.templates.DeviceObserverIdentifyingAttributes({\n        uid: app.uid,\n        manufacturerName: 'MGH Computational Pathology',\n        modelName: app.name\n      })\n    }),\n    subjectContext: new dcmjs.sr.templates.SubjectContext({\n      subjectClass: new dcmjs.sr.coding.CodedConcept({\n        value: '121027',\n        schemeDesignator: 'DCM',\n        meaning: 'Specimen'\n      }),\n      subjectClassSpecificContext: new dcmjs.sr.templates.SubjectContextSpecimen({\n        uid: refSpecimen.SpecimenUID,\n        identifier: refSpecimen.SpecimenIdentifier,\n        containerIdentifier: refImage.ContainerIdentifier\n      })\n    })\n  })\n\n  console.debug('encode Imaging Measurements')\n  const imagingMeasurements: dcmjs.sr.valueTypes.ContainerContentItem[] = []\n  for (let i = 0; i < rois.length; i++) {\n    const roi = rois[i]\n    if (!visibleRoiUIDs.has(roi.uid)) {\n      continue\n    }\n\n    let findingType = roi.evaluations.find((item: dcmjs.sr.valueTypes.ContentItem) => {\n      return item.ConceptNameCodeSequence[0].CodeValue === '121071'\n    })\n\n    if (findingType === undefined) {\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.ENCODINGANDDECODING,\n          `No finding type was specified for ROI \"${String(roi.uid)}\"`\n        )\n      )\n    }\n\n    findingType = findingType as dcmjs.sr.valueTypes.CodeContentItem\n\n    const trackingIdentifier = new dcmjs.sr.templates.TrackingIdentifier({\n      uid: roi.properties.trackingUID ?? roi.uid,\n      identifier: `ROI #${i + 1}`\n    })\n\n    const group = new dcmjs.sr.templates.PlanarROIMeasurementsAndQualitativeEvaluations({\n      trackingIdentifier,\n      referencedRegion: new dcmjs.sr.contentItems.ImageRegion3D({\n        graphicType: roi.scoord3d.graphicType,\n        graphicData: roi.scoord3d.graphicData,\n        frameOfReferenceUID: roi.scoord3d.frameOfReferenceUID\n      }),\n      findingType: new dcmjs.sr.coding.CodedConcept({\n        value: findingType.ConceptCodeSequence[0].CodeValue,\n        schemeDesignator: findingType.ConceptCodeSequence[0].CodingSchemeDesignator,\n        meaning: findingType.ConceptCodeSequence[0].CodeMeaning\n      }),\n      qualitativeEvaluations: roi.evaluations.filter((item: dcmjs.sr.valueTypes.ContentItem) => {\n        return item.ConceptNameCodeSequence[0].CodeValue !== '121071'\n      }),\n      measurements: roi.measurements\n    })\n\n    const measurements = group as dcmjs.sr.valueTypes.ContainerContentItem[]\n    measurements[0].ContentTemplateSequence = [\n      {\n        MappingResource: 'DCMR',\n        TemplateIdentifier: '1410'\n      }\n    ]\n    imagingMeasurements.push(...measurements)\n  }\n\n  console.debug('create Measurement Report document content')\n  const measurementReport = new dcmjs.sr.templates.MeasurementReport({\n    languageOfContentItemAndDescendants: new dcmjs.sr.templates.LanguageOfContentItemAndDescendants(\n      {}\n    ),\n    observationContext,\n    procedureReported: new dcmjs.sr.coding.CodedConcept({\n      value: '112703',\n      schemeDesignator: 'DCM',\n      meaning: 'Whole Slide Imaging'\n    }),\n    imagingMeasurements\n  })\n\n  console.info('create Comprehensive 3D SR document')\n  const dataset = new dcmjs.sr.documents.Comprehensive3DSR({\n    content: measurementReport[0],\n    evidence: [refImage],\n    seriesInstanceUID: dcmjs.data.DicomMetaDictionary.uid(),\n    seriesNumber: 1,\n    seriesDescription: 'Annotation',\n    sopInstanceUID: dcmjs.data.DicomMetaDictionary.uid(),\n    instanceNumber: 1,\n    manufacturer: 'MGH Computational Pathology',\n    previousVersions: undefined // TODO\n  })\n\n  return {\n    isReportModalVisible: true,\n    generatedReport: dataset as dmv.metadata.Comprehensive3DSR\n  }\n}\n\nexport default generateReport\n","import React from 'react'\nimport {\n  FaCrosshairs,\n  FaDrawPolygon,\n  FaEye,\n  FaEyeSlash,\n  FaHandPaper,\n  FaHandPointer,\n  FaTrash,\n  FaSave\n} from 'react-icons/fa'\nimport {\n  Button as Btn,\n  Checkbox,\n  Descriptions,\n  Divider,\n  InputNumber,\n  message,\n  Menu,\n  Modal,\n  Layout,\n  Row,\n  Select,\n  Space,\n  Tooltip\n} from 'antd'\nimport { UndoOutlined, CheckOutlined, StopOutlined } from '@ant-design/icons'\nimport * as dmv from 'dicom-microscopy-viewer'\nimport * as dcmjs from 'dcmjs'\nimport * as dwc from 'dicomweb-client'\nimport type { CheckboxChangeEvent } from 'antd/es/checkbox'\n\nimport DicomWebManager from '../DicomWebManager'\nimport AnnotationList from './AnnotationList'\nimport AnnotationGroupList from './AnnotationGroupList'\nimport Button from './Button'\nimport Equipment from './Equipment'\nimport Report, { MeasurementReport } from './Report'\nimport SpecimenList from './SpecimenList'\nimport OpticalPathList from './OpticalPathList'\nimport MappingList from './MappingList'\nimport SegmentList from './SegmentList'\nimport { AnnotationSettings } from '../AppConfig'\nimport { Slide } from '../data/slides'\nimport { StorageClasses } from '../data/uids'\nimport { findContentItemsByName } from '../utils/sr'\nimport { RouteComponentProps, withRouter } from '../utils/router'\nimport { CustomError, errorTypes } from '../utils/CustomError'\nimport NotificationMiddleware, {\n  NotificationMiddlewareContext\n} from '../services/NotificationMiddleware'\nimport AnnotationCategoryList, { AnnotationCategoryAndType } from './AnnotationCategoryList'\nimport HoveredRoiTooltip from './HoveredRoiTooltip'\nimport { adaptRoiToAnnotation } from '../services/RoiToAnnotationAdapter'\nimport generateReport from '../utils/generateReport'\n\nconst DEFAULT_ROI_STROKE_COLOR: number[] = [255, 234, 0] // [0, 126, 163]\nconst DEFAULT_ROI_FILL_COLOR: number[] = [255, 234, 0, 0.2] // [0, 126, 163, 0.2]\nconst DEFAULT_ROI_STROKE_WIDTH: number = 2\nconst DEFAULT_ROI_RADIUS: number = 5\n\nconst DEFAULT_ANNOTATION_OPACITY = 0.4\nconst DEFAULT_ANNOTATION_STROKE_COLOR = [0, 0, 0]\nconst DEFAULT_ANNOTATION_COLOR_PALETTE = [\n  [255, 0, 0],\n  [0, 255, 0],\n  [0, 0, 255],\n  [255, 255, 0],\n  [0, 255, 255],\n  [0, 0, 0]\n]\n\ninterface StyleOptions {\n  opacity: number\n  color: number[]\n  contourOnly: boolean\n}\n\nconst _buildKey = (concept: {\n  CodeValue: string\n  CodeMeaning: string\n  CodingSchemeDesignator: string\n  CodingSchemeVersion?: string\n}): string => {\n  const codingScheme = concept.CodingSchemeDesignator\n  const codeValue = concept.CodeValue\n  return `${codingScheme}-${codeValue}`\n}\n\nconst _getRoiKey = (roi: dmv.roi.ROI): string | undefined => {\n  const matches = findContentItemsByName({\n    content: roi.evaluations,\n    name: new dcmjs.sr.coding.CodedConcept({\n      value: '121071',\n      meaning: 'Finding',\n      schemeDesignator: 'DCM'\n    })\n  })\n  if (matches.length === 0) {\n    console.warn(`no finding found for ROI ${roi.uid}`)\n    return\n  }\n  const finding = matches[0] as dcmjs.sr.valueTypes.CodeContentItem\n  const findingName = finding.ConceptCodeSequence[0]\n  return _buildKey(findingName)\n}\n\nconst _areROIsEqual = (a: dmv.roi.ROI, b: dmv.roi.ROI): boolean => {\n  if (a.scoord3d.graphicType !== b.scoord3d.graphicType) {\n    return false\n  }\n  if (a.scoord3d.frameOfReferenceUID !== b.scoord3d.frameOfReferenceUID) {\n    return false\n  }\n  if (a.scoord3d.graphicData.length !== b.scoord3d.graphicData.length) {\n    return false\n  }\n\n  const decimals = 6\n  for (let i = 0; i < a.scoord3d.graphicData.length; ++i) {\n    if (a.scoord3d.graphicType === 'POINT') {\n      const s1 = a.scoord3d as dmv.scoord3d.Point\n      const s2 = b.scoord3d as dmv.scoord3d.Point\n      const c1 = s1.graphicData[i].toPrecision(decimals)\n      const c2 = s2.graphicData[i].toPrecision(decimals)\n      if (c1 !== c2) {\n        return false\n      }\n    } else {\n      const s1 = a.scoord3d as dmv.scoord3d.Polygon\n      const s2 = b.scoord3d as dmv.scoord3d.Polygon\n      for (let j = 0; j < s1.graphicData[i].length; ++j) {\n        const c1 = s1.graphicData[i][j].toPrecision(decimals)\n        const c2 = s2.graphicData[i][j].toPrecision(decimals)\n        if (c1 !== c2) {\n          return false\n        }\n      }\n    }\n  }\n  return true\n}\n\nconst _formatRoiStyle = (style: {\n  stroke?: {\n    color?: number[]\n    width?: number\n  }\n  fill?: {\n    color?: number[]\n  }\n  radius?: number\n}): dmv.viewer.ROIStyleOptions => {\n  const stroke = {\n    color: DEFAULT_ROI_STROKE_COLOR,\n    width: DEFAULT_ROI_STROKE_WIDTH\n  }\n  if (style.stroke != null) {\n    if (style.stroke.color != null) {\n      stroke.color = style.stroke.color\n    }\n    if (style.stroke.width != null) {\n      stroke.width = style.stroke.width\n    }\n  }\n  const fill = {\n    color: DEFAULT_ROI_FILL_COLOR\n  }\n  if (style.fill != null) {\n    if (style.fill.color != null) {\n      fill.color = style.fill.color\n    }\n  }\n  return {\n    stroke,\n    fill,\n    image: {\n      circle: {\n        radius: style.radius != null\n          ? style.radius\n          : Math.max(5 - stroke.width, 1),\n        stroke,\n        fill\n      }\n    }\n  }\n}\n\nconst _constructViewers = ({ clients, slide, preload }: {\n  clients: { [key: string]: dwc.api.DICOMwebClient }\n  slide: Slide\n  preload?: boolean\n}): {\n  volumeViewer: dmv.viewer.VolumeImageViewer\n  labelViewer?: dmv.viewer.LabelImageViewer\n} => {\n  console.info(\n    'instantiate viewer for VOLUME images of slide ' +\n    `\"${slide.volumeImages[0].ContainerIdentifier}\"`\n  )\n  try {\n    const volumeViewer = new dmv.viewer.VolumeImageViewer({\n      clientMapping: clients,\n      metadata: slide.volumeImages,\n      controls: ['overview', 'position'],\n      preload: preload,\n      errorInterceptor: (error: CustomError) => {\n        NotificationMiddleware.onError(\n          NotificationMiddlewareContext.DMV, error\n        )\n      }\n    })\n    volumeViewer.activateSelectInteraction({})\n\n    let labelViewer\n    if (slide.labelImages.length > 0) {\n      console.info(\n        'instantiate viewer for LABEL image of slide ' +\n        `\"${slide.labelImages[0].ContainerIdentifier}\"`\n      )\n      labelViewer = new dmv.viewer.LabelImageViewer({\n        client: clients[StorageClasses.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE],\n        metadata: slide.labelImages[0],\n        resizeFactor: 1,\n        orientation: 'vertical',\n        errorInterceptor: (error: CustomError) => {\n          NotificationMiddleware.onError(\n            NotificationMiddlewareContext.DMV,\n            error\n          )\n        }\n      })\n    }\n\n    return { volumeViewer, labelViewer }\n  } catch (error) {\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises\n    NotificationMiddleware.onError(\n      NotificationMiddlewareContext.SLIM,\n      new CustomError(\n        errorTypes.VISUALIZATION,\n        'Failed to instantiate viewer'\n      )\n    )\n    throw error\n  }\n}\n\n/*\n * Check whether the report is structured according to template\n * TID 1500 \"MeasurementReport\".\n */\nconst _implementsTID1500 = (\n  report: dmv.metadata.Comprehensive3DSR\n): boolean => {\n  const templateSeq = report.ContentTemplateSequence\n  if (templateSeq.length > 0) {\n    const tid = templateSeq[0].TemplateIdentifier\n    if (tid === '1500') {\n      return true\n    }\n  }\n  return false\n}\n\n/*\n * Check whether the subject described in the report is a specimen as compared\n * to a patient, fetus, or device.\n */\nconst _describesSpecimenSubject = (\n  report: dmv.metadata.Comprehensive3DSR\n): boolean => {\n  const items = findContentItemsByName({\n    content: report.ContentSequence,\n    name: new dcmjs.sr.coding.CodedConcept({\n      value: '121024',\n      schemeDesignator: 'DCM',\n      meaning: 'Subject Class'\n    })\n  })\n  if (items.length === 0) {\n    return false\n  }\n  const subjectClassItem = items[0] as dcmjs.sr.valueTypes.CodeContentItem\n  const subjectClassValue = subjectClassItem.ConceptCodeSequence[0]\n  const retrievedConcept = new dcmjs.sr.coding.CodedConcept({\n    value: subjectClassValue.CodeValue,\n    meaning: subjectClassValue.CodeMeaning,\n    schemeDesignator: subjectClassValue.CodingSchemeDesignator\n  })\n  const expectedConcept = new dcmjs.sr.coding.CodedConcept({\n    value: '121027',\n    meaning: 'Specimen',\n    schemeDesignator: 'DCM'\n  })\n  if (retrievedConcept.equals(expectedConcept)) {\n    return true\n  }\n  return false\n}\n\n/*\n * Check whether the report contains appropriate graphic ROI annotations.\n */\nconst _containsROIAnnotations = (\n  report: dmv.metadata.Comprehensive3DSR\n): boolean => {\n  const measurements = findContentItemsByName({\n    content: report.ContentSequence,\n    name: new dcmjs.sr.coding.CodedConcept({\n      value: '126010',\n      schemeDesignator: 'DCM',\n      meaning: 'Imaging Measurements'\n    })\n  })\n  if (measurements.length === 0) {\n    return false\n  }\n  const container = measurements[0] as dcmjs.sr.valueTypes.ContainerContentItem\n  const measurementGroups = findContentItemsByName({\n    content: container.ContentSequence,\n    name: new dcmjs.sr.coding.CodedConcept({\n      value: '125007',\n      schemeDesignator: 'DCM',\n      meaning: 'Measurement Group'\n    })\n  })\n\n  let foundRegion = false\n  measurementGroups.forEach((group) => {\n    const container = group as dcmjs.sr.valueTypes.ContainerContentItem\n    const regions = findContentItemsByName({\n      content: container.ContentSequence,\n      name: new dcmjs.sr.coding.CodedConcept({\n        value: '111030',\n        schemeDesignator: 'DCM',\n        meaning: 'Image Region'\n      })\n    })\n    if (regions.length > 0) {\n      if (regions[0].ValueType === dcmjs.sr.valueTypes.ValueTypes.SCOORD3D) {\n        foundRegion = true\n      }\n    }\n  })\n\n  return foundRegion\n}\n\ninterface EvaluationOptions {\n  name: dcmjs.sr.coding.CodedConcept\n  values: dcmjs.sr.coding.CodedConcept[]\n}\n\ninterface Evaluation {\n  name: dcmjs.sr.coding.CodedConcept\n  value: dcmjs.sr.coding.CodedConcept\n}\n\ninterface Measurement {\n  name: dcmjs.sr.coding.CodedConcept\n  value?: number\n  unit: dcmjs.sr.coding.CodedConcept\n}\n\ninterface SlideViewerProps extends RouteComponentProps {\n  slide: Slide\n  clients: { [key: string]: DicomWebManager }\n  studyInstanceUID: string\n  seriesInstanceUID: string\n  app: {\n    name: string\n    version: string\n    uid: string\n    organization?: string\n  }\n  annotations: AnnotationSettings[]\n  enableAnnotationTools: boolean\n  preload: boolean\n  user?: {\n    name: string\n    email: string\n  }\n  selectedPresentationStateUID?: string\n  derivedDataset?: dmv.metadata.Dataset // Add this line\n}\n\ninterface SlideViewerState {\n  visibleRoiUIDs: Set<string>\n  visibleSegmentUIDs: Set<string>\n  visibleMappingUIDs: Set<string>\n  visibleAnnotationGroupUIDs: Set<string>\n  visibleOpticalPathIdentifiers: Set<string>\n  activeOpticalPathIdentifiers: Set<string>\n  presentationStates: dmv.metadata.AdvancedBlendingPresentationState[]\n  selectedPresentationStateUID?: string\n  selectedFinding?: dcmjs.sr.coding.CodedConcept\n  selectedEvaluations: Evaluation[]\n  selectedGeometryType?: string\n  selectedMarkup?: string\n  selectedRoi?: dmv.roi.ROI\n  selectedRoiUIDs: Set<string>\n  generatedReport?: dmv.metadata.Comprehensive3DSR\n  isLoading: boolean\n  isAnnotationModalVisible: boolean\n  isSelectedRoiModalVisible: boolean\n  isHoveredRoiTooltipVisible: boolean\n  hoveredRoiAttributes: Array<{index: number, roiUid: string, attributes: Array<{ name: string, value: string }>}>\n  hoveredRoiTooltipX: number\n  hoveredRoiTooltipY: number\n  isReportModalVisible: boolean\n  isRoiDrawingActive: boolean\n  isRoiModificationActive: boolean\n  isRoiTranslationActive: boolean\n  isGoToModalVisible: boolean\n  isSelectedMagnificationValid: boolean\n  isSelectedXCoordinateValid: boolean\n  isSelectedYCoordinateValid: boolean\n  selectedXCoordinate?: number\n  validXCoordinateRange: number[]\n  selectedYCoordinate?: number\n  validYCoordinateRange: number[]\n  selectedMagnification?: number\n  areRoisHidden: boolean\n  pixelDataStatistics: {\n    [opticalPathIdentifier: string]: {\n      min: number\n      max: number\n      numFramesSampled: number\n    }\n  }\n  loadingFrames: Set<string>\n  isICCProfilesEnabled: boolean\n}\n\n/**\n * React component for interactive viewing of an individual digital slide,\n * which corresponds to one DICOM Series of DICOM Slide Microscopy images and\n * potentially one or more associated DICOM Series of DICOM SR documents.\n */\nclass SlideViewer extends React.Component<SlideViewerProps, SlideViewerState> {\n  private readonly findingOptions: dcmjs.sr.coding.CodedConcept[] = []\n\n  private readonly evaluationOptions: { [key: string]: EvaluationOptions[] } = {}\n\n  private readonly measurements: Measurement[] = []\n\n  private readonly geometryTypeOptions: { [key: string]: string[] } = {}\n\n  private readonly volumeViewportRef: React.RefObject<HTMLDivElement>\n\n  private readonly labelViewportRef: React.RefObject<HTMLDivElement>\n\n  private volumeViewer: dmv.viewer.VolumeImageViewer\n\n  private labelViewer?: dmv.viewer.LabelImageViewer\n\n  private hoveredRois = [] as dmv.roi.ROI[]\n\n  private lastPixel = [0, 0] as [number, number]\n\n  private readonly keysDown = new Set<string>()\n\n  private readonly defaultRoiStyle: dmv.viewer.ROIStyleOptions = {\n    stroke: {\n      color: DEFAULT_ROI_STROKE_COLOR,\n      width: DEFAULT_ROI_STROKE_WIDTH\n    },\n    fill: {\n      color: DEFAULT_ROI_FILL_COLOR\n    },\n    image: {\n      circle: {\n        fill: {\n          color: DEFAULT_ROI_STROKE_COLOR\n        },\n        radius: DEFAULT_ROI_RADIUS\n      }\n    }\n  }\n\n  private roiStyles: {[key: string]: dmv.viewer.ROIStyleOptions} = {}\n\n  private defaultAnnotationStyles: {\n    [annotationUID: string]: StyleOptions\n  } = {}\n\n  private readonly selectionStrokeColor: number[] = [0, 153, 255]\n  private readonly selectionFillColor: number[] = [255, 255, 255]\n\n  private readonly selectedRoiStyle: dmv.viewer.ROIStyleOptions = {\n    stroke: { color: [...this.selectionStrokeColor, 1], width: 3 },\n    fill: { color: [...this.selectionFillColor, 0.5] },\n    image: {\n      circle: {\n        radius: 5,\n        fill: { color: [...this.selectionStrokeColor, 1] }\n      }\n    }\n  }\n\n  constructor (props: SlideViewerProps) {\n    super(props)\n    console.info(\n      `view slide \"${this.props.slide.containerIdentifier}\": `,\n      this.props.slide\n    )\n    const geometryTypeOptions = [\n      'point',\n      'circle',\n      'box',\n      'polygon',\n      'line',\n      'freehandpolygon',\n      'freehandline'\n    ]\n    props.annotations.forEach((annotation: AnnotationSettings) => {\n      const finding = new dcmjs.sr.coding.CodedConcept(annotation.finding)\n      this.findingOptions.push(finding)\n      const key = _buildKey(finding)\n      if (annotation.geometryTypes !== undefined) {\n        this.geometryTypeOptions[key] = annotation.geometryTypes\n      } else {\n        this.geometryTypeOptions[key] = geometryTypeOptions\n      }\n      this.evaluationOptions[key] = []\n      if (annotation.evaluations !== undefined) {\n        annotation.evaluations.forEach(evaluation => {\n          this.evaluationOptions[key].push({\n            name: new dcmjs.sr.coding.CodedConcept(evaluation.name),\n            values: evaluation.values.map(value => {\n              return new dcmjs.sr.coding.CodedConcept(value)\n            })\n          })\n        })\n      }\n      if (annotation.measurements !== undefined) {\n        annotation.measurements.forEach(measurement => {\n          this.measurements.push({\n            name: new dcmjs.sr.coding.CodedConcept(measurement.name),\n            value: undefined,\n            unit: new dcmjs.sr.coding.CodedConcept(measurement.unit)\n          })\n        })\n      }\n      if (annotation.style != null) {\n        this.roiStyles[key] = _formatRoiStyle(annotation.style)\n      } else {\n        this.roiStyles[key] = this.defaultRoiStyle\n      }\n    })\n\n    this.componentSetup = this.componentSetup.bind(this)\n    this.componentCleanup = this.componentCleanup.bind(this)\n    this.onWindowResize = this.onWindowResize.bind(this)\n    this.handleRoiDrawing = this.handleRoiDrawing.bind(this)\n    this.handleRoiTranslation = this.handleRoiTranslation.bind(this)\n    this.handleRoiModification = this.handleRoiModification.bind(this)\n    this.handleRoiVisibilityChange = this.handleRoiVisibilityChange.bind(this)\n    this.handleRoiRemoval = this.handleRoiRemoval.bind(this)\n    this.handleRoiSelectionCancellation = this.handleRoiSelectionCancellation.bind(this)\n    this.handleAnnotationConfigurationCancellation = this.handleAnnotationConfigurationCancellation.bind(this)\n    this.handleAnnotationGeometryTypeSelection = this.handleAnnotationGeometryTypeSelection.bind(this)\n    this.handleAnnotationMeasurementActivation = this.handleAnnotationMeasurementActivation.bind(this)\n    this.handleAnnotationFindingSelection = this.handleAnnotationFindingSelection.bind(this)\n    this.handleAnnotationEvaluationSelection = this.handleAnnotationEvaluationSelection.bind(this)\n    this.handleAnnotationEvaluationClearance = this.handleAnnotationEvaluationClearance.bind(this)\n    this.handleAnnotationConfigurationCompletion = this.handleAnnotationConfigurationCompletion.bind(this)\n    this.handleAnnotationVisibilityChange = this.handleAnnotationVisibilityChange.bind(this)\n    this.handleAnnotationGroupVisibilityChange = this.handleAnnotationGroupVisibilityChange.bind(this)\n    this.handleAnnotationGroupStyleChange = this.handleAnnotationGroupStyleChange.bind(this)\n    this.handleRoiStyleChange = this.handleRoiStyleChange.bind(this)\n    this.handleGoTo = this.handleGoTo.bind(this)\n    this.handleXCoordinateSelection = this.handleXCoordinateSelection.bind(this)\n    this.handleYCoordinateSelection = this.handleYCoordinateSelection.bind(this)\n    this.handleMagnificationSelection = this.handleMagnificationSelection.bind(this)\n    this.handleSlidePositionSelection = this.handleSlidePositionSelection.bind(this)\n    this.handleSlidePositionSelectionCancellation = this.handleSlidePositionSelectionCancellation.bind(this)\n    this.handleReportGeneration = this.handleReportGeneration.bind(this)\n    this.handleReportVerification = this.handleReportVerification.bind(this)\n    this.handleReportCancellation = this.handleReportCancellation.bind(this)\n    this.handleSegmentVisibilityChange = this.handleSegmentVisibilityChange.bind(this)\n    this.handleSegmentStyleChange = this.handleSegmentStyleChange.bind(this)\n    this.handleMappingVisibilityChange = this.handleMappingVisibilityChange.bind(this)\n    this.handleMappingStyleChange = this.handleMappingStyleChange.bind(this)\n    this.handleOpticalPathVisibilityChange = this.handleOpticalPathVisibilityChange.bind(this)\n    this.handleOpticalPathStyleChange = this.handleOpticalPathStyleChange.bind(this)\n    this.handleOpticalPathActivityChange = this.handleOpticalPathActivityChange.bind(this)\n    this.handlePresentationStateSelection = this.handlePresentationStateSelection.bind(this)\n    this.handlePresentationStateReset = this.handlePresentationStateReset.bind(this)\n    this.handleICCProfilesToggle = this.handleICCProfilesToggle.bind(this)\n    this.handleAnnotationSelection = this.handleAnnotationSelection.bind(this)\n\n    const { volumeViewer, labelViewer } = _constructViewers({\n      clients: this.props.clients,\n      slide: this.props.slide,\n      preload: this.props.preload\n    })\n    this.volumeViewer = volumeViewer\n    this.labelViewer = labelViewer\n    this.volumeViewportRef = React.createRef<HTMLDivElement>()\n    this.labelViewportRef = React.createRef<HTMLDivElement>()\n\n    /**\n     * Deactivate all optical paths. Visibility will be set later, potentially\n     * using based on available presentation state instances.\n     */\n    this.volumeViewer.getAllOpticalPaths().forEach(opticalPath => {\n      this.volumeViewer.deactivateOpticalPath(opticalPath.identifier)\n    })\n\n    const [offset, size] = this.volumeViewer.boundingBox\n\n    this.state = {\n      selectedRoiUIDs: new Set(),\n      visibleRoiUIDs: new Set(),\n      visibleSegmentUIDs: new Set(),\n      visibleMappingUIDs: new Set(),\n      visibleAnnotationGroupUIDs: new Set(),\n      visibleOpticalPathIdentifiers: new Set(),\n      activeOpticalPathIdentifiers: new Set(),\n      presentationStates: [],\n      selectedFinding: undefined,\n      selectedEvaluations: [],\n      generatedReport: undefined,\n      isLoading: false,\n      isAnnotationModalVisible: false,\n      isSelectedRoiModalVisible: false,\n      isHoveredRoiTooltipVisible: false,\n      hoveredRoiTooltipX: 0,\n      hoveredRoiTooltipY: 0,\n      hoveredRoiAttributes: [],\n      isSelectedMagnificationValid: false,\n      isReportModalVisible: false,\n      isRoiDrawingActive: false,\n      isRoiTranslationActive: false,\n      isRoiModificationActive: false,\n      isGoToModalVisible: false,\n      isSelectedXCoordinateValid: false,\n      isSelectedYCoordinateValid: false,\n      selectedXCoordinate: undefined,\n      validXCoordinateRange: [offset[0], offset[0] + size[0]],\n      selectedYCoordinate: undefined,\n      validYCoordinateRange: [offset[1], offset[1] + size[1]],\n      selectedMagnification: undefined,\n      areRoisHidden: false,\n      pixelDataStatistics: {},\n      selectedPresentationStateUID: this.props.selectedPresentationStateUID,\n      loadingFrames: new Set(),\n      isICCProfilesEnabled: true\n    }\n  }\n\n  componentDidUpdate (\n    previousProps: SlideViewerProps,\n    previousState: SlideViewerState\n  ): void {\n    /** Fetch data and update the viewports if the route has changed (\n     * i.e., if another series has been selected) or if the client has changed.\n     */\n    if (\n      this.props.location.pathname !== previousProps.location.pathname ||\n      this.props.studyInstanceUID !== previousProps.studyInstanceUID ||\n      this.props.seriesInstanceUID !== previousProps.seriesInstanceUID ||\n      this.props.slide !== previousProps.slide ||\n      this.props.clients !== previousProps.clients\n    ) {\n      if (this.volumeViewportRef.current != null) {\n        this.volumeViewportRef.current.innerHTML = ''\n      }\n      this.volumeViewer.cleanup()\n      if (this.labelViewer != null) {\n        if (this.labelViewportRef.current != null) {\n          this.labelViewportRef.current.innerHTML = ''\n        }\n        this.labelViewer.cleanup()\n      }\n      const { volumeViewer, labelViewer } = _constructViewers({\n        clients: this.props.clients,\n        slide: this.props.slide,\n        preload: this.props.preload\n      })\n      this.volumeViewer = volumeViewer\n      this.labelViewer = labelViewer\n\n      const activeOpticalPathIdentifiers: Set<string> = new Set()\n      const visibleOpticalPathIdentifiers: Set<string> = new Set()\n      this.volumeViewer.getAllOpticalPaths().forEach(opticalPath => {\n        const identifier = opticalPath.identifier\n        if (this.volumeViewer.isOpticalPathVisible(identifier)) {\n          visibleOpticalPathIdentifiers.add(identifier)\n        }\n        if (this.volumeViewer.isOpticalPathActive(identifier)) {\n          activeOpticalPathIdentifiers.add(identifier)\n        }\n      })\n\n      const [offset, size] = this.volumeViewer.boundingBox\n\n      this.setState({\n        visibleRoiUIDs: new Set(),\n        visibleSegmentUIDs: new Set(),\n        visibleMappingUIDs: new Set(),\n        visibleAnnotationGroupUIDs: new Set(),\n        visibleOpticalPathIdentifiers,\n        activeOpticalPathIdentifiers,\n        presentationStates: [],\n        loadingFrames: new Set(),\n        validXCoordinateRange: [offset[0], offset[0] + size[0]],\n        validYCoordinateRange: [offset[1], offset[1] + size[1]]\n      })\n      this.populateViewports()\n    }\n  }\n\n  /**\n   * Retrieve Presentation State instances that reference the any images of\n   * the currently selected series.\n   */\n  loadPresentationStates = (): void => {\n    console.info('search for Presentation State instances')\n    const client = this.props.clients[\n      StorageClasses.ADVANCED_BLENDING_PRESENTATION_STATE\n    ]\n    client.searchForInstances({\n      studyInstanceUID: this.props.studyInstanceUID,\n      queryParams: {\n        Modality: 'PR'\n      }\n    }).then((matchedInstances): void => {\n      if (matchedInstances == null) {\n        matchedInstances = []\n      }\n      matchedInstances.forEach((rawInstance, index) => {\n        const { dataset } = dmv.metadata.formatMetadata(rawInstance)\n        const instance = dataset as dmv.metadata.Instance\n        console.info(`retrieve PR instance \"${instance.SOPInstanceUID}\"`)\n        client.retrieveInstance({\n          studyInstanceUID: this.props.studyInstanceUID,\n          seriesInstanceUID: instance.SeriesInstanceUID,\n          sopInstanceUID: instance.SOPInstanceUID\n        }).then((retrievedInstance): void => {\n          const data = dcmjs.data.DicomMessage.readFile(retrievedInstance)\n          const { dataset } = dmv.metadata.formatMetadata(data.dict)\n          if (this.props.slide.areVolumeImagesMonochrome) {\n            const presentationState = (\n              dataset as\n              unknown as\n              dmv.metadata.AdvancedBlendingPresentationState\n            )\n            let doesMatch = false\n            presentationState.AdvancedBlendingSequence.forEach(blendingItem => {\n              doesMatch = this.props.slide.seriesInstanceUIDs.includes(\n                blendingItem.SeriesInstanceUID\n              )\n            }\n            )\n            if (doesMatch) {\n              console.info(\n                'include Advanced Blending Presentation State instance ' +\n                `\"${presentationState.SOPInstanceUID}\"`\n              )\n              if (\n                index === 0 &&\n                this.props.selectedPresentationStateUID == null\n              ) {\n                this.setPresentationState(presentationState)\n              } else {\n                if (\n                  presentationState.SOPInstanceUID ===\n                  this.props.selectedPresentationStateUID\n                ) {\n                  this.setPresentationState(presentationState)\n                }\n              }\n              this.setState(state => {\n                const mapping: {\n                  [sopInstanceUID: string]:\n                  dmv.metadata.AdvancedBlendingPresentationState\n                } = {}\n                state.presentationStates.forEach(instance => {\n                  mapping[instance.SOPInstanceUID] = instance\n                })\n                mapping[presentationState.SOPInstanceUID] = presentationState\n                return { presentationStates: Object.values(mapping) }\n              })\n            }\n          } else {\n            console.info(\n              `ignore presentation state \"${instance.SOPInstanceUID}\", ` +\n              'application of presentation states for color images ' +\n              'has not (yet) been implemented'\n            )\n          }\n        }).catch((error) => {\n          // eslint-disable-next-line @typescript-eslint/no-floating-promises\n          NotificationMiddleware.onError(\n            NotificationMiddlewareContext.SLIM,\n            new CustomError(\n              errorTypes.VISUALIZATION,\n              'Presentation State could not be loaded'\n            )\n          )\n          console.error(\n            'failed to load presentation state ' +\n            `of SOP instance \"${instance.SOPInstanceUID}\" ` +\n            `of series \"${instance.SeriesInstanceUID}\" ` +\n            `of study \"${this.props.studyInstanceUID}\": `,\n            error\n          )\n        })\n      })\n    }).catch((error) => {\n      console.error(error)\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.VISUALIZATION,\n          'Presentation State could not be loaded'\n        )\n      )\n    })\n  }\n\n  /**\n   * Set presentation state as specified by a DICOM Presentation State instance.\n   */\n  setPresentationState = (\n    presentationState: dmv.metadata.AdvancedBlendingPresentationState\n  ): void => {\n    const opticalPaths = this.volumeViewer.getAllOpticalPaths()\n    console.info(\n      `apply Presentation State instance \"${presentationState.SOPInstanceUID}\"`\n    )\n    const opticalPathStyles: {\n      [opticalPathIdentifier: string]: {\n        opacity: number\n        paletteColorLookupTable?: dmv.color.PaletteColorLookupTable\n        limitValues?: number[]\n      } | null\n    } = {}\n    opticalPaths.forEach(opticalPath => {\n      // First, deactivate and hide all optical paths and reset style\n      const identifier = opticalPath.identifier\n      this.volumeViewer.hideOpticalPath(identifier)\n      this.volumeViewer.deactivateOpticalPath(identifier)\n      const style = this.volumeViewer.getOpticalPathDefaultStyle(identifier)\n      this.volumeViewer.setOpticalPathStyle(identifier, style)\n\n      presentationState.AdvancedBlendingSequence.forEach(blendingItem => {\n        /**\n         * Referenced Instance Sequence should be used instead of Referenced\n         * Image Sequence, but that's easy to mix up and we have encountered\n         * implementations that get it wrong.\n         */\n        let refInstanceItems = blendingItem.ReferencedInstanceSequence\n        if (refInstanceItems === undefined) {\n          refInstanceItems = blendingItem.ReferencedImageSequence\n        }\n        if (refInstanceItems === undefined) {\n          return\n        }\n        refInstanceItems.forEach(imageItem => {\n          const isReferenced = opticalPath.sopInstanceUIDs.includes(\n            imageItem.ReferencedSOPInstanceUID\n          ) as boolean\n          if (isReferenced) {\n            let paletteColorLUT\n            if (blendingItem.PaletteColorLookupTableSequence != null) {\n              const cpLUTItem = blendingItem.PaletteColorLookupTableSequence[0]\n              paletteColorLUT = new dmv.color.PaletteColorLookupTable({\n                uid: (\n                  cpLUTItem.PaletteColorLookupTableUID != null\n                    ? cpLUTItem.PaletteColorLookupTableUID\n                    : ''\n                ),\n                redDescriptor:\n                  cpLUTItem.RedPaletteColorLookupTableDescriptor,\n                greenDescriptor:\n                  cpLUTItem.GreenPaletteColorLookupTableDescriptor,\n                blueDescriptor:\n                  cpLUTItem.BluePaletteColorLookupTableDescriptor,\n                redData: (\n                  (cpLUTItem.RedPaletteColorLookupTableData != null)\n                    ? new Uint16Array(\n                      cpLUTItem.RedPaletteColorLookupTableData\n                    )\n                    : undefined\n                ),\n                greenData: (\n                  (cpLUTItem.GreenPaletteColorLookupTableData != null)\n                    ? new Uint16Array(\n                      cpLUTItem.GreenPaletteColorLookupTableData\n                    )\n                    : undefined\n                ),\n                blueData: (\n                  (cpLUTItem.BluePaletteColorLookupTableData != null)\n                    ? new Uint16Array(\n                      cpLUTItem.BluePaletteColorLookupTableData\n                    )\n                    : undefined\n                ),\n                redSegmentedData: (\n                  (cpLUTItem.SegmentedRedPaletteColorLookupTableData != null)\n                    ? new Uint16Array(\n                      cpLUTItem.SegmentedRedPaletteColorLookupTableData\n                    )\n                    : undefined\n                ),\n                greenSegmentedData: (\n                  (cpLUTItem.SegmentedGreenPaletteColorLookupTableData != null)\n                    ? new Uint16Array(\n                      cpLUTItem.SegmentedGreenPaletteColorLookupTableData\n                    )\n                    : undefined\n                ),\n                blueSegmentedData: (\n                  (cpLUTItem.SegmentedBluePaletteColorLookupTableData != null)\n                    ? new Uint16Array(\n                      cpLUTItem.SegmentedBluePaletteColorLookupTableData\n                    )\n                    : undefined\n                )\n              })\n            }\n\n            let limitValues\n            if (blendingItem.SoftcopyVOILUTSequence != null) {\n              const voiLUTItem = blendingItem.SoftcopyVOILUTSequence[0]\n              const windowCenter = voiLUTItem.WindowCenter\n              const windowWidth = voiLUTItem.WindowWidth\n              limitValues = [\n                windowCenter - windowWidth * 0.5,\n                windowCenter + windowWidth * 0.5\n              ]\n            }\n\n            opticalPathStyles[identifier] = {\n              opacity: 1,\n              paletteColorLookupTable: paletteColorLUT,\n              limitValues: limitValues\n            }\n          }\n        })\n      })\n    })\n\n    const selectedOpticalPathIdentifiers: Set<string> = new Set()\n    Object.keys(opticalPathStyles).forEach(identifier => {\n      const styleOptions = opticalPathStyles[identifier]\n      if (styleOptions != null) {\n        this.volumeViewer.setOpticalPathStyle(identifier, styleOptions)\n        this.volumeViewer.activateOpticalPath(identifier)\n        this.volumeViewer.showOpticalPath(identifier)\n        selectedOpticalPathIdentifiers.add(identifier)\n      } else {\n        this.volumeViewer.hideOpticalPath(identifier)\n        this.volumeViewer.deactivateOpticalPath(identifier)\n      }\n    })\n    const searchParams = new URLSearchParams(this.props.location.search)\n    searchParams.set('state', presentationState.SOPInstanceUID)\n    this.props.navigate(\n      {\n        pathname: this.props.location.pathname,\n        search: searchParams.toString()\n      },\n      { replace: true }\n    )\n    this.setState(state => ({\n      activeOpticalPathIdentifiers: selectedOpticalPathIdentifiers,\n      visibleOpticalPathIdentifiers: selectedOpticalPathIdentifiers,\n      selectedPresentationStateUID: presentationState.SOPInstanceUID\n    }))\n  }\n\n  getRoiStyle = (key?: string): dmv.viewer.ROIStyleOptions => {\n    if (key == null) {\n      return this.defaultRoiStyle\n    }\n    if (this.roiStyles[key] !== undefined) {\n      return this.roiStyles[key]\n    }\n    return this.defaultRoiStyle\n  }\n\n  loadDerivedDataset = (derivedDataset: dmv.metadata.Dataset): void => {\n    console.debug('Loading derived dataset')\n    const Comprehensive3DSR = '1.2.840.10008.5.1.4.1.1.88.34'\n    const MicroscopyBulkSimpleAnnotation = '1.2.840.10008.5.1.4.1.1.88.24'\n    const Segmentation = '1.2.840.10008.5.1.4.1.1.66.4'\n    const ParametricMap = '1.2.840.10008.5.1.4.1.1.88.22'\n    const OpticalPath = '1.2.840.10008.5.1.4.1.1.88.21'\n    if ((derivedDataset as { SOPClassUID: string }).SOPClassUID === Comprehensive3DSR) {\n      const allRois = this.volumeViewer.getAllROIs()\n      allRois.forEach((roi) => {\n        this.handleAnnotationVisibilityChange({ roiUID: roi.uid, isVisible: true })\n      })\n      console.debug('Loading Comprehensive 3D SR')\n    } else if ((derivedDataset as { SOPClassUID: string }).SOPClassUID === MicroscopyBulkSimpleAnnotation) {\n      const allAnnotationGroups = this.volumeViewer.getAllAnnotationGroups()\n      allAnnotationGroups.forEach((annotationGroup) => {\n        this.handleAnnotationGroupVisibilityChange({ annotationGroupUID: annotationGroup.uid, isVisible: true })\n      })\n      console.debug('Loading Microscopy Bulk Simple Annotation')\n    } else if ((derivedDataset as { SOPClassUID: string }).SOPClassUID === Segmentation) {\n      const allSegments = this.volumeViewer.getAllSegments()\n      allSegments.forEach((segment) => {\n        this.handleSegmentVisibilityChange({ segmentUID: segment.uid, isVisible: true })\n      })\n      console.debug('Loading Segmentation')\n    } else if ((derivedDataset as { SOPClassUID: string }).SOPClassUID === ParametricMap) {\n      const allParameterMappings = this.volumeViewer.getAllParameterMappings()\n      allParameterMappings.forEach((parameterMapping) => {\n        this.handleMappingVisibilityChange({ mappingUID: parameterMapping.uid, isVisible: true })\n      })\n      console.debug('Loading Parametric Map')\n    } else if ((derivedDataset as { SOPClassUID: string }).SOPClassUID === OpticalPath) {\n      const allOpticalPaths = this.volumeViewer.getAllOpticalPaths()\n      allOpticalPaths.forEach((opticalPath) => {\n        this.handleOpticalPathVisibilityChange({ opticalPathIdentifier: opticalPath.identifier, isVisible: true })\n      })\n      console.debug('Loading Optical Path')\n    }\n  }\n\n  /**\n   * Retrieve Structured Report instances that contain regions of interests\n   * with 3D spatial coordinates defined in the same frame of reference as the\n   * currently selected series and add them to the VOLUME image viewer.\n   */\n  async addAnnotations (): Promise<void> {\n    return await new Promise<void>((resolve, reject) => {\n      console.info('search for Comprehensive 3D SR instances')\n      const client = this.props.clients[StorageClasses.COMPREHENSIVE_3D_SR]\n      client.searchForInstances({\n        studyInstanceUID: this.props.studyInstanceUID,\n        queryParams: {\n          Modality: 'SR'\n        }\n      }).then((matchedInstances): void => {\n        if (matchedInstances == null) {\n          matchedInstances = []\n        }\n        matchedInstances.forEach(i => {\n          const { dataset } = dmv.metadata.formatMetadata(i)\n          const instance = dataset as dmv.metadata.Instance\n          if (instance.SOPClassUID === StorageClasses.COMPREHENSIVE_3D_SR) {\n            console.info(`retrieve SR instance \"${instance.SOPInstanceUID}\"`)\n            client.retrieveInstance({\n              studyInstanceUID: this.props.studyInstanceUID,\n              seriesInstanceUID: instance.SeriesInstanceUID,\n              sopInstanceUID: instance.SOPInstanceUID\n            }).then((retrievedInstance): void => {\n              const data = dcmjs.data.DicomMessage.readFile(retrievedInstance)\n              const { dataset } = dmv.metadata.formatMetadata(data.dict)\n              const report = dataset as unknown as dmv.metadata.Comprehensive3DSR\n              /*\n              * Perform a couple of checks to ensure the document content of the\n              * report fullfils the requirements of the application.\n              */\n              if (!_implementsTID1500(report)) {\n                console.debug(\n                  `ignore SR document \"${report.SOPInstanceUID}\" ` +\n                  'because it is not structured according to template ' +\n                  'TID 1500 \"MeasurementReport\"'\n                )\n                return\n              }\n              if (!_describesSpecimenSubject(report)) {\n                console.debug(\n                  `ignore SR document \"${report.SOPInstanceUID}\" ` +\n                  'because it does not describe a specimen subject'\n                )\n                return\n              }\n              if (!_containsROIAnnotations(report)) {\n                console.debug(\n                  `ignore SR document \"${report.SOPInstanceUID}\" ` +\n                  'because it does not contain any suitable ROI annotations'\n                )\n                return\n              }\n\n              const content = new MeasurementReport(report)\n              content.ROIs.forEach(roi => {\n                console.info(`add ROI \"${roi.uid}\"`)\n                const scoord3d = roi.scoord3d\n                const image = this.props.slide.volumeImages[0]\n                if (scoord3d.frameOfReferenceUID === image.FrameOfReferenceUID) {\n                  /*\n                  * ROIs may get assigned new UIDs upon re-rendering of the\n                  * page and we need to ensure that we don't add them twice.\n                  * The same ROI may be stored in multiple SR documents and\n                  * we don't want them to show up twice.\n                  * TODO: We should probably either \"merge\" measurements and\n                  * quantitative evaluations or pick the ROI from the \"best\"\n                  * available report (COMPLETE and VERIFIED).\n                  */\n                  const doesROIExist = this.volumeViewer.getAllROIs().some(\n                    (otherROI: dmv.roi.ROI): boolean => {\n                      return _areROIsEqual(otherROI, roi)\n                    }\n                  )\n                  if (!doesROIExist) {\n                    try {\n                      // Add ROI without style such that it won't be visible.\n                      this.volumeViewer.addROI(roi, {})\n                      const roiAsAnnotation = adaptRoiToAnnotation(roi)\n                      this.formatAnnotation(roiAsAnnotation)\n                    } catch {\n                      console.error(`could not add ROI \"${roi.uid}\"`)\n                    }\n                  } else {\n                    console.debug(`skip already existing ROI \"${roi.uid}\"`)\n                  }\n                } else {\n                  console.debug(\n                    `skip ROI \"${roi.uid}\" ` +\n                    `of SR document \"${report.SOPInstanceUID}\"` +\n                    'because it is defined in another frame of reference'\n                  )\n                }\n              })\n\n              resolve()\n            }).catch((error) => {\n              // eslint-disable-next-line @typescript-eslint/no-floating-promises\n              NotificationMiddleware.onError(\n                NotificationMiddlewareContext.SLIM,\n                new CustomError(\n                  errorTypes.VISUALIZATION,\n                  'Annotations could not be loaded'\n                )\n              )\n              console.error(\n                'failed to load ROIs ' +\n                `of SOP instance \"${instance.SOPInstanceUID}\" ` +\n                `of series \"${instance.SeriesInstanceUID}\" ` +\n                `of study \"${this.props.studyInstanceUID}\": `,\n                error\n              )\n            })\n            /*\n            * React is not aware of the fact that ROIs have been added via the\n            * viewer (the viewport is a ref object) and won't show the\n            * annotations in the user interface unless an update is forced.\n            */\n            this.forceUpdate()\n          }\n        })\n      }).catch((error) => {\n        console.error(error)\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        NotificationMiddleware.onError(\n          NotificationMiddlewareContext.SLIM,\n          new CustomError(\n            errorTypes.VISUALIZATION,\n            'Annotations could not be loaded'\n          )\n        )\n        reject(error instanceof Error ? error : new Error(String(error)))\n      })\n    })\n  }\n\n  /**\n   * Retrieve Microscopy Bulk Simple Annotations instances that contain\n   * annotation groups defined in the same frame of reference as the currently\n   * selected series and add them to the VOLUME image viewer.\n   */\n  addAnnotationGroups = async (): Promise<void> => {\n    return await new Promise<void>((resolve, reject) => {\n      console.info('search for Microscopy Bulk Simple Annotations instances')\n      const client = this.props.clients[\n        StorageClasses.MICROSCOPY_BULK_SIMPLE_ANNOTATION\n      ]\n      client.searchForSeries({\n        studyInstanceUID: this.props.studyInstanceUID,\n        queryParams: {\n          Modality: 'ANN'\n        }\n      }).then((matchedSeries): void => {\n        if (matchedSeries == null) {\n          matchedSeries = []\n        }\n        matchedSeries.forEach(s => {\n          const { dataset } = dmv.metadata.formatMetadata(s)\n          const series = dataset as dmv.metadata.Series\n          client.retrieveSeriesMetadata({\n            studyInstanceUID: this.props.studyInstanceUID,\n            seriesInstanceUID: series.SeriesInstanceUID\n          }).then((retrievedMetadata): void => {\n            const annotations: dmv.metadata.MicroscopyBulkSimpleAnnotations[] = retrievedMetadata.map(metadata => {\n              return new dmv.metadata.MicroscopyBulkSimpleAnnotations({\n                metadata\n              })\n            })\n            // annotations = annotations.filter(ann => {\n            //   const refImage = this.props.slide.volumeImages[0]\n            //   return (\n            //     ann.FrameOfReferenceUID === refImage.FrameOfReferenceUID &&\n            //     ann.ContainerIdentifier === refImage.ContainerIdentifier\n            //   )\n            // })\n            annotations.forEach(ann => {\n              try {\n                this.volumeViewer.addAnnotationGroups(ann)\n              } catch (error: any) {\n                // eslint-disable-next-line @typescript-eslint/no-floating-promises\n                NotificationMiddleware.onError(\n                  NotificationMiddlewareContext.SLIM,\n                  new CustomError(\n                    errorTypes.VISUALIZATION,\n                    'Microscopy Bulk Simple Annotations cannot be displayed.'\n                  )\n                )\n                // eslint-disable-next-line @typescript-eslint/no-floating-promises\n                console.error('failed to add annotation groups:', error)\n              }\n              ann.AnnotationGroupSequence.forEach(item => {\n                const annotationGroupUID = item.AnnotationGroupUID\n                const finding = item.AnnotationPropertyTypeCodeSequence[0]\n                const key = _buildKey(finding)\n                const style = this.roiStyles[key]\n                // eslint-disable-next-line @typescript-eslint/prefer-optional-chain\n                if (style != null && style.fill != null) {\n                  this.volumeViewer.setAnnotationGroupStyle(\n                    annotationGroupUID,\n                    { color: style.fill.color }\n                  )\n                }\n              })\n            })\n            /*\n            * React is not aware of the fact that annotation groups have been\n            * added via the viewer (the underlying HTML viewport element is a\n            * ref object) and won't show the annotation groups in the user\n            * interface unless an update is forced.\n            */\n            this.forceUpdate()\n            resolve()\n          }).catch((error) => {\n            console.error(error)\n            // eslint-disable-next-line @typescript-eslint/no-floating-promises\n            NotificationMiddleware.onError(\n              NotificationMiddlewareContext.SLIM,\n              new CustomError(\n                errorTypes.VISUALIZATION,\n                'Retrieval of metadata of Microscopy Bulk Simple Annotations ' +\n                'instances failed.'\n              )\n            )\n          })\n        })\n      }).catch((error) => {\n        console.error(error)\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        NotificationMiddleware.onError(\n          NotificationMiddlewareContext.SLIM,\n          new CustomError(\n            errorTypes.VISUALIZATION,\n            'Search for Microscopy Bulk Simple Annotations instances failed.'\n          )\n        )\n        reject(error instanceof Error ? error : new Error(String(error)))\n      })\n    })\n  }\n\n  /**\n   * Retrieve Segmentation instances that contain segments defined in the same\n   * frame of reference as the currently selected series and add them to the\n   * VOLUME image viewer.\n   */\n  addSegmentations = async (): Promise<void> => {\n    return await new Promise<void>((resolve, reject) => {\n      console.info('search for Segmentation instances')\n      const client = this.props.clients[StorageClasses.SEGMENTATION]\n      client.searchForSeries({\n        studyInstanceUID: this.props.studyInstanceUID,\n        queryParams: {\n          Modality: 'SEG'\n        }\n      }).then((matchedSeries): void => {\n        if (matchedSeries == null) {\n          matchedSeries = []\n        }\n        matchedSeries.forEach((s, i) => {\n          const { dataset } = dmv.metadata.formatMetadata(s)\n          const series = dataset as dmv.metadata.Series\n          client.retrieveSeriesMetadata({\n            studyInstanceUID: this.props.studyInstanceUID,\n            seriesInstanceUID: series.SeriesInstanceUID\n          }).then((retrievedMetadata): void => {\n            const segmentations: dmv.metadata.Segmentation[] = []\n            retrievedMetadata.forEach(metadata => {\n              const seg = new dmv.metadata.Segmentation({ metadata })\n              const refImage = this.props.slide.volumeImages[0]\n              if (\n                seg.FrameOfReferenceUID === refImage.FrameOfReferenceUID &&\n                seg.ContainerIdentifier === refImage.ContainerIdentifier\n              ) {\n                segmentations.push(seg)\n              }\n            })\n            if (segmentations.length > 0) {\n              try {\n                this.volumeViewer.addSegments(segmentations)\n              } catch (error: any) {\n                // eslint-disable-next-line @typescript-eslint/no-floating-promises\n                NotificationMiddleware.onError(\n                  NotificationMiddlewareContext.SLIM,\n                  new CustomError(\n                    errorTypes.VISUALIZATION,\n                    'Segmentations cannot be displayed'\n                  )\n                )\n                console.error('failed to add segments: ', error)\n              }\n              /*\n              * React is not aware of the fact that segments have been added via\n              * the viewer (the underlying HTML viewport element is a ref object)\n              * and won't show the segments in the user interface unless an update\n              * is forced.\n              */\n              this.forceUpdate()\n            }\n\n            resolve()\n          }).catch((error) => {\n            console.error(error)\n            // eslint-disable-next-line @typescript-eslint/no-floating-promises\n            NotificationMiddleware.onError(\n              NotificationMiddlewareContext.SLIM,\n              new CustomError(\n                errorTypes.VISUALIZATION,\n                'Retrieval of metadata of Segmentation instances failed.'\n              )\n            )\n          })\n        })\n      }).catch((error) => {\n        console.error(error)\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        NotificationMiddleware.onError(\n          NotificationMiddlewareContext.SLIM,\n          new CustomError(\n            errorTypes.VISUALIZATION,\n            'Search for Segmentation instances failed.'\n          )\n        )\n        reject(error instanceof Error ? error : new Error(String(error)))\n      })\n    })\n  }\n\n  /**\n   * Retrieve Parametric Map instances that contain mappings defined in the same\n   * frame of reference as the currently selected series and add them to the\n   * VOLUME image viewer.\n   */\n  addParametricMaps = async (): Promise<void> => {\n    return await new Promise<void>((resolve, reject) => {\n      console.info('search for Parametric Map instances')\n      const client = this.props.clients[StorageClasses.PARAMETRIC_MAP]\n      client.searchForSeries({\n        studyInstanceUID: this.props.studyInstanceUID,\n        queryParams: {\n          Modality: 'OT'\n        }\n      }).then((matchedSeries): void => {\n        if (matchedSeries == null) {\n          matchedSeries = []\n        }\n        matchedSeries.forEach(s => {\n          const { dataset } = dmv.metadata.formatMetadata(s)\n          const series = dataset as dmv.metadata.Series\n          client.retrieveSeriesMetadata({\n            studyInstanceUID: this.props.studyInstanceUID,\n            seriesInstanceUID: series.SeriesInstanceUID\n          }).then((retrievedMetadata): void => {\n            const parametricMaps: dmv.metadata.ParametricMap[] = []\n            retrievedMetadata.forEach(metadata => {\n              const pm = new dmv.metadata.ParametricMap({ metadata })\n              const refImage = this.props.slide.volumeImages[0]\n              if (\n                pm.FrameOfReferenceUID === refImage.FrameOfReferenceUID &&\n                pm.ContainerIdentifier === refImage.ContainerIdentifier\n              ) {\n                parametricMaps.push(pm)\n              } else {\n                console.warn(\n                  `skip Parametric Map instance \"${pm.SOPInstanceUID}\"`\n                )\n              }\n            })\n            if (parametricMaps.length > 0) {\n              try {\n                this.volumeViewer.addParameterMappings(parametricMaps)\n              } catch (error: any) {\n                // eslint-disable-next-line @typescript-eslint/no-floating-promises\n                NotificationMiddleware.onError(\n                  NotificationMiddlewareContext.SLIM,\n                  new CustomError(\n                    errorTypes.VISUALIZATION,\n                    'Parametric Map cannot be displayed'\n                  )\n                )\n                console.error('failed to add mappings: ', error)\n              }\n              /*\n               * React is not aware of the fact that mappings have been added via\n               * the viewer (the underlying HTML viewport element is a ref object)\n               * and won't show the mappings in the user interface unless an update\n               * is forced.\n               */\n              this.forceUpdate()\n            }\n            resolve()\n          }).catch((error) => {\n            console.error(error)\n            // eslint-disable-next-line @typescript-eslint/no-floating-promises\n            NotificationMiddleware.onError(\n              NotificationMiddlewareContext.SLIM,\n              new CustomError(\n                errorTypes.VISUALIZATION,\n                'Retrieval of metadata of Parametric Map instances failed.'\n              )\n            )\n          })\n        })\n      }).catch((error) => {\n        console.error(error)\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        NotificationMiddleware.onError(\n          NotificationMiddlewareContext.SLIM,\n          new CustomError(\n            errorTypes.VISUALIZATION,\n            'Search for Parametric Map instances failed.'\n          )\n        )\n        reject(error instanceof Error ? error : new Error(String(error)))\n      })\n    })\n  }\n\n  /**\n   * Populate viewports of the VOLUME and LABEL image viewers.\n   */\n  populateViewports = (): void => {\n    console.info('populate viewports...')\n    this.setState({\n      isLoading: true,\n      presentationStates: []\n    })\n\n    if (this.volumeViewportRef.current != null) {\n      this.volumeViewer.render({ container: this.volumeViewportRef.current })\n    }\n    if (\n      this.labelViewportRef.current != null &&\n      this.labelViewer != null\n    ) {\n      this.labelViewer.render({ container: this.labelViewportRef.current })\n    }\n\n    // State update will also ensure that the component is re-rendered.\n    this.setState({ isLoading: false })\n\n    this.setDefaultPresentationState()\n    this.loadPresentationStates()\n\n    // Handle promises properly with catch blocks\n    void this.addAnnotations()\n      .then(() => {\n        if (this.props.derivedDataset != null) {\n          this.loadDerivedDataset(this.props.derivedDataset)\n        }\n      })\n      .catch(error => {\n        console.error('Failed to add annotations:', error)\n      })\n\n    void this.addAnnotationGroups()\n      .then(() => {\n        if (this.props.derivedDataset != null) {\n          this.loadDerivedDataset(this.props.derivedDataset)\n        }\n      })\n      .catch(error => {\n        console.error('Failed to add annotation groups:', error)\n      })\n\n    void this.addSegmentations()\n      .then(() => {\n        if (this.props.derivedDataset != null) {\n          this.loadDerivedDataset(this.props.derivedDataset)\n        }\n      })\n      .catch(error => {\n        console.error('Failed to add segmentations:', error)\n      })\n\n    void this.addParametricMaps()\n      .then(() => {\n        if (this.props.derivedDataset != null) {\n          this.loadDerivedDataset(this.props.derivedDataset)\n        }\n      })\n      .catch(error => {\n        console.error('Failed to add parametric maps:', error)\n      })\n  }\n\n  onRoiModified = (event: CustomEventInit): void => {\n    // Update state to trigger rendering\n    this.setState(state => ({\n      visibleRoiUIDs: new Set(state.visibleRoiUIDs)\n    }))\n  }\n\n  onWindowResize = (event: Event): void => {\n    console.info('resize viewports')\n    this.volumeViewer.resize()\n    if (this.labelViewer != null) {\n      this.labelViewer.resize()\n    }\n  }\n\n  onRoiDrawn = (event: CustomEventInit): void => {\n    const roi = event.detail.payload as dmv.roi.ROI\n    const selectedFinding = this.state.selectedFinding\n    const selectedEvaluations = this.state.selectedEvaluations\n    if (roi !== undefined && selectedFinding !== undefined) {\n      console.debug(`add ROI \"${roi.uid}\"`)\n      const findingItem = new dcmjs.sr.valueTypes.CodeContentItem({\n        name: new dcmjs.sr.coding.CodedConcept({\n          value: '121071',\n          meaning: 'Finding',\n          schemeDesignator: 'DCM'\n        }),\n        value: selectedFinding,\n        relationshipType: 'CONTAINS'\n      })\n      roi.addEvaluation(findingItem)\n      selectedEvaluations.forEach((evaluation: Evaluation) => {\n        const item = new dcmjs.sr.valueTypes.CodeContentItem({\n          name: evaluation.name,\n          value: evaluation.value,\n          relationshipType: 'CONTAINS'\n        })\n        roi.addEvaluation(item)\n      })\n      const key = _buildKey(selectedFinding)\n      const style = this.getRoiStyle(key)\n      this.volumeViewer.addROI(roi, style)\n      this.setState(state => {\n        const visibleRoiUIDs = state.visibleRoiUIDs\n        visibleRoiUIDs.add(roi.uid)\n        return { visibleRoiUIDs }\n      })\n    } else {\n      console.debug(`could not add ROI \"${roi.uid}\"`)\n    }\n  }\n\n  onRoiDoubleClicked = (event: CustomEventInit): void => {\n    const selectedRoi = event.detail.payload as dmv.roi.ROI\n    if (selectedRoi != null) {\n      this.setState({\n        isSelectedRoiModalVisible: true\n      })\n    } else {\n      this.setState({\n        isSelectedRoiModalVisible: false\n      })\n    }\n  }\n\n  setHoveredRoiAttributes = (hoveredRois: dmv.roi.ROI[]): void => {\n    const rois = this.volumeViewer.getAllROIs()\n    if (rois.length === 0) {\n      this.setState({ hoveredRoiAttributes: [] })\n      return\n    }\n\n    const result = hoveredRois.map((roi) => {\n      const attributes: Array<{ name: string, value: string }> = []\n      const evaluations = roi.evaluations\n      evaluations.forEach((\n        item: (\n          dcmjs.sr.valueTypes.TextContentItem |\n          dcmjs.sr.valueTypes.CodeContentItem\n        )\n      ) => {\n        const nameValue = item.ConceptNameCodeSequence[0].CodeValue\n        const nameMeaning = item.ConceptNameCodeSequence[0].CodeMeaning\n        const name = `${nameMeaning}`\n        if (item.ValueType === dcmjs.sr.valueTypes.ValueTypes.CODE) {\n          const codeContentItem = item as dcmjs.sr.valueTypes.CodeContentItem\n          const valueMeaning = codeContentItem.ConceptCodeSequence[0].CodeMeaning\n          // For consistency with Segment and Annotation Group\n          if (nameValue === '276214006') {\n            attributes.push({\n              name: 'Property category',\n              value: `${valueMeaning}`\n            })\n          } else if (nameValue === '121071') {\n            attributes.push({\n              name: 'Property type',\n              value: `${valueMeaning}`\n            })\n          } else if (nameValue === '111001') {\n            attributes.push({\n              name: 'Algorithm Name',\n              value: `${valueMeaning}`\n            })\n          } else {\n            attributes.push({\n              name: name,\n              value: `${valueMeaning}`\n            })\n          }\n        } else if (item.ValueType === dcmjs.sr.valueTypes.ValueTypes.TEXT) {\n          const textContentItem = item as dcmjs.sr.valueTypes.TextContentItem\n          attributes.push({\n            name: name,\n            value: textContentItem.TextValue\n          })\n        }\n      })\n\n      const index = (rois.findIndex((r) => r.uid === roi.uid) ?? 0) + 1\n      return { index, roiUid: roi.uid, attributes }\n    }, [] as Array<dcmjs.sr.valueTypes.CodeContentItem | dcmjs.sr.valueTypes.TextContentItem>)\n\n    this.setState({ hoveredRoiAttributes: result })\n  }\n\n  clearHoveredRois = (): void => {\n    this.hoveredRois = [] as any\n  }\n\n  getUniqueHoveredRois = (newRoi: dmv.roi.ROI | null): dmv.roi.ROI[] => {\n    if (newRoi == null) {\n      return []\n    }\n    const allRois = [...this.hoveredRois, newRoi]\n    const uniqueIds = Array.from(new Set(allRois.map(roi => roi.uid)))\n    return uniqueIds.map(id => allRois.find(roi => roi.uid === id))\n      .filter((roi): roi is dmv.roi.ROI => roi !== undefined)\n  }\n\n  isSamePixelAsLast = (event: any): boolean => {\n    return event.clientX === this.lastPixel[0] && event.clientY === this.lastPixel[1]\n  }\n\n  onPointerMove = (event: CustomEventInit): void => {\n    const { feature: hoveredRoi, event: evt } = event.detail.payload\n    const originalEvent = evt.originalEvent\n\n    if (!this.isSamePixelAsLast(originalEvent)) {\n      this.lastPixel = [originalEvent.clientX, originalEvent.clientY]\n      this.clearHoveredRois()\n    }\n\n    this.hoveredRois = this.getUniqueHoveredRois(hoveredRoi)\n\n    if (this.hoveredRois.length > 0) {\n      this.setHoveredRoiAttributes(this.hoveredRois)\n      this.setState({\n        isHoveredRoiTooltipVisible: true,\n        hoveredRoiTooltipX: originalEvent.clientX,\n        hoveredRoiTooltipY: originalEvent.clientY\n      })\n    } else {\n      this.setState({\n        isHoveredRoiTooltipVisible: false\n      })\n    }\n  }\n\n  getUpdatedSelectedRois = (newSelectedRoiUid?: string): { selectedRoiUIDs: Set<string>, selectedRoi?: dmv.roi.ROI} => {\n    const selectedRoiUid = newSelectedRoiUid\n    const emptySelection = {\n      selectedRoiUIDs: new Set<string>(),\n      selectedRoi: undefined\n    }\n\n    if (selectedRoiUid === undefined) {\n      return emptySelection\n    }\n\n    const selectedRoi = this.volumeViewer.getROI(selectedRoiUid)\n    if (selectedRoi === undefined) {\n      return emptySelection\n    }\n\n    console.debug(`selected ROI \"${selectedRoi.uid}\"`)\n\n    if (!this.keysDown.has('Shift')) {\n      return {\n        selectedRoiUIDs: new Set([selectedRoi.uid]),\n        selectedRoi\n      }\n    }\n\n    const oldSelectedRois = Array.from(this.state.selectedRoiUIDs)\n    return {\n      selectedRoiUIDs: new Set([...oldSelectedRois, selectedRoi.uid]),\n      selectedRoi\n    }\n  }\n\n  resetUnselectedRoiStyles = (selectionState: { selectedRoiUIDs: Set<string> }): void => {\n    this.volumeViewer.getAllROIs().forEach(roi => {\n      const uid = roi.uid\n\n      if (selectionState.selectedRoiUIDs.has(uid) || !this.state.visibleRoiUIDs.has(uid)) {\n        return\n      }\n\n      const key = _getRoiKey(roi)\n      const style = this.getRoiStyle(key)\n      this.volumeViewer.setROIStyle(uid, style)\n    })\n  }\n\n  onMapClicked = (event: CustomEventInit): void => {\n    const roisClicked = (event.detail?.payload?.rois ?? []) as dmv.roi.ROI[]\n\n    if (roisClicked.length !== 0) {\n      return\n    }\n\n    const updatedSelectedRois = this.getUpdatedSelectedRois()\n    this.setState(updatedSelectedRois)\n\n    // @ts-expect-error\n    this.volumeViewer.clearSelections()\n\n    this.resetUnselectedRoiStyles(updatedSelectedRois)\n  }\n\n  onRoiSelected = (event: CustomEventInit): void => {\n    const selectedRoiUid = event.detail?.payload?.uid as string\n    const updatedSelectedRois = this.getUpdatedSelectedRois(selectedRoiUid)\n    this.setState(updatedSelectedRois)\n\n    this.resetUnselectedRoiStyles(updatedSelectedRois)\n  }\n\n  handleAnnotationSelection (uid: string): void {\n    // @ts-expect-error\n    this.volumeViewer.clearSelections()\n\n    const updatedSelectedRois = this.getUpdatedSelectedRois(uid)\n    this.setState(updatedSelectedRois)\n    this.volumeViewer.getAllROIs().forEach((roi) => {\n      let style = {}\n      if (updatedSelectedRois.selectedRoiUIDs.has(roi.uid)) {\n        style = this.selectedRoiStyle\n        this.setState(state => {\n          const visibleRoiUIDs = state.visibleRoiUIDs\n          visibleRoiUIDs.add(roi.uid)\n          return { visibleRoiUIDs }\n        })\n      } else {\n        if (this.state.visibleRoiUIDs.has(roi.uid)) {\n          const key = _getRoiKey(roi)\n          style = this.getRoiStyle(key)\n        }\n      }\n      this.volumeViewer.setROIStyle(roi.uid, style)\n    })\n  }\n\n  handleRoiSelectionCancellation (): void {\n    this.setState({\n      isSelectedRoiModalVisible: false\n    })\n  }\n\n  onLoadingStarted = (event: CustomEventInit): void => {\n    this.setState({ isLoading: true })\n  }\n\n  onLoadingEnded = (event: CustomEventInit): void => {\n    this.setState({ isLoading: false })\n  }\n\n  onFrameLoadingStarted = (event: CustomEventInit): void => {\n    const frameInfo: {\n      studyInstanceUID: string\n      seriesInstanceUID: string\n      sopInstanceUID: string\n      sopClassUID: string\n      frameNumber: string\n      channelIdentifier: string\n    } = event.detail.payload\n    const key: string = `${frameInfo.sopInstanceUID}-${frameInfo.frameNumber}`\n    this.setState(state => {\n      state.loadingFrames.add(key)\n      return state\n    })\n  }\n\n  onFrameLoadingError = (event: CustomEventInit): void => {\n    console.error('Failed to load frame')\n  }\n\n  onLoadingError = (event: CustomEventInit): void => {\n    const message = (event.detail?.payload?.message ?? 'Failed to load data') as string\n    console.error(message)\n    NotificationMiddleware.onError(\n      NotificationMiddlewareContext.SLIM,\n      new CustomError(\n        errorTypes.VISUALIZATION,\n        message\n      ) as any\n    )\n  }\n\n  onFrameLoadingEnded = (event: CustomEventInit): void => {\n    const frameInfo: {\n      studyInstanceUID: string\n      seriesInstanceUID: string\n      sopInstanceUID: string\n      sopClassUID: string\n      frameNumber: string\n      channelIdentifier: string\n      pixelArray: Uint8Array|Uint16Array|Float32Array|null\n    } = event.detail.payload\n    const key = `${frameInfo.sopInstanceUID}-${frameInfo.frameNumber}`\n    this.setState(state => {\n      state.loadingFrames.delete(key)\n      let isLoading: boolean = false\n      if (state.loadingFrames.size > 0) {\n        isLoading = true\n      }\n      return {\n        isLoading,\n        loadingFrames: state.loadingFrames\n      }\n    })\n    if (\n      frameInfo.sopClassUID === StorageClasses.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE &&\n      this.props.slide.areVolumeImagesMonochrome\n    ) {\n      const opticalPathIdentifier = frameInfo.channelIdentifier\n      if (\n        !(opticalPathIdentifier in this.state.pixelDataStatistics) &&\n        frameInfo.pixelArray != null\n      ) {\n        /*\n         * There are limits on the number of arguments Math.min and Math.max\n         * functions can accept. Therefore, we compute values in smaller chunks.\n         */\n        const size = 2 ** 16\n        const chunks = Math.ceil(frameInfo.pixelArray.length / size)\n        let offset = 0\n        const minValues: number[] = []\n        const maxValues: number[] = []\n        for (let i = 0; i < chunks; i++) {\n          offset = i * size\n          const pixels = frameInfo.pixelArray.slice(offset, offset + size)\n          minValues.push(Math.min(...pixels))\n          maxValues.push(Math.max(...pixels))\n        }\n        const min = Math.min(...minValues)\n        const max = Math.max(...maxValues)\n        this.setState(state => {\n          const stats = state.pixelDataStatistics\n          if (stats[opticalPathIdentifier] != null) {\n            stats[opticalPathIdentifier] = {\n              min: Math.min(stats[opticalPathIdentifier].min, min),\n              max: Math.max(stats[opticalPathIdentifier].max, max),\n              numFramesSampled: stats[opticalPathIdentifier].numFramesSampled + 1\n            }\n          } else {\n            stats[opticalPathIdentifier] = {\n              min: min,\n              max: max,\n              numFramesSampled: 1\n            }\n          }\n          if (state.selectedPresentationStateUID == null) {\n            const style = {\n              ...this.volumeViewer.getOpticalPathStyle(opticalPathIdentifier)\n            }\n            style.limitValues = [\n              stats[opticalPathIdentifier].min,\n              stats[opticalPathIdentifier].max\n            ]\n            this.volumeViewer.setOpticalPathStyle(opticalPathIdentifier, style)\n          }\n          return state\n        })\n      }\n    }\n  }\n\n  onRoiRemoved = (event: CustomEventInit): void => {\n    const roi = event.detail.payload as dmv.roi.ROI\n    console.debug(`removed ROI \"${roi.uid}\"`)\n  }\n\n  componentCleanup (): void {\n    document.body.removeEventListener(\n      'dicommicroscopyviewer_roi_drawn',\n      this.onRoiDrawn\n    )\n    document.body.removeEventListener(\n      'dicommicroscopyviewer_viewport_clicked',\n      this.onMapClicked\n    )\n    document.body.removeEventListener(\n      'dicommicroscopyviewer_roi_selected',\n      this.onRoiSelected\n    )\n    document.body.removeEventListener(\n      'dicommicroscopyviewer_roi_double_clicked',\n      this.onRoiDoubleClicked\n    )\n    document.body.removeEventListener(\n      'dicommicroscopyviewer_pointer_move',\n      this.onPointerMove\n    )\n    document.body.removeEventListener(\n      'dicommicroscopyviewer_roi_removed',\n      this.onRoiRemoved\n    )\n    document.body.removeEventListener(\n      'dicommicroscopyviewer_roi_modified',\n      this.onRoiModified\n    )\n    document.body.removeEventListener(\n      'dicommicroscopyviewer_loading_started',\n      this.onLoadingStarted\n    )\n    document.body.removeEventListener(\n      'dicommicroscopyviewer_loading_ended',\n      this.onLoadingEnded\n    )\n    document.body.removeEventListener(\n      'dicommicroscopyviewer_frame_loading_started',\n      this.onFrameLoadingStarted\n    )\n    document.body.removeEventListener(\n      'dicommicroscopyviewer_frame_loading_ended',\n      this.onFrameLoadingEnded\n    )\n    document.body.removeEventListener(\n      'keyup',\n      this.onKeyUp\n    )\n    document.body.removeEventListener(\n      'keyup',\n      this.onKeyDown\n    )\n    window.removeEventListener('resize', this.onWindowResize)\n\n    this.volumeViewer.cleanup()\n    if (this.labelViewer != null) {\n      this.labelViewer.cleanup()\n    }\n    /*\n     * FIXME: React appears to not clean the content of referenced\n     * HTMLDivElement objects when the page is reloaded. As a consequence,\n     * optical paths and other display items cannot be toggled or updated after\n     * a manual page reload. I have tried using ref callbacks and passing the\n     * ref objects from the parent component via the props. Both didn't work\n     * either.\n     */\n  }\n\n  onKeyDown = (event: KeyboardEvent): void => {\n    this.keysDown.add(event.key)\n  }\n\n  onKeyUp = (event: KeyboardEvent): void => {\n    this.keysDown.delete(event.key)\n    if (event.key === 'Escape') {\n      if (this.state.isRoiDrawingActive) {\n        console.info('deactivate drawing of ROIs')\n        this.volumeViewer.deactivateDrawInteraction()\n        this.volumeViewer.activateSelectInteraction({})\n      } else if (this.state.isRoiModificationActive) {\n        console.info('deactivate modification of ROIs')\n        this.volumeViewer.deactivateModifyInteraction()\n        this.volumeViewer.activateSelectInteraction({})\n      } else if (this.state.isRoiTranslationActive) {\n        console.info('deactivate modification of ROIs')\n        this.volumeViewer.deactivateTranslateInteraction()\n        this.volumeViewer.activateSelectInteraction({})\n      }\n      this.setState({\n        isAnnotationModalVisible: false,\n        isSelectedRoiModalVisible: false,\n        isRoiTranslationActive: false,\n        isRoiDrawingActive: false,\n        isRoiModificationActive: false,\n        isGoToModalVisible: false\n      })\n    } else if (event.altKey) {\n      if (event.code === 'KeyD') {\n        this.handleRoiDrawing()\n      } else if (event.code === 'KeyM') {\n        this.handleRoiModification()\n      } else if (event.code === 'KeyT') {\n        this.handleRoiTranslation()\n      } else if (event.code === 'KeyR') {\n        this.handleRoiRemoval()\n      } else if (event.code === 'KeyV') {\n        this.handleRoiVisibilityChange()\n      } else if (event.code === 'KeyS') {\n        this.handleReportGeneration()\n      } else if (event.code === 'KeyG') {\n        this.handleGoTo()\n      }\n    }\n  }\n\n  componentWillUnmount (): void {\n    this.volumeViewer.cleanup()\n    if (this.labelViewer != null) {\n      this.labelViewer.cleanup()\n    }\n    window.removeEventListener('beforeunload', this.componentCleanup)\n  }\n\n  componentSetup (): void {\n    document.body.addEventListener(\n      'dicommicroscopyviewer_roi_drawn',\n      this.onRoiDrawn\n    )\n    document.body.addEventListener(\n      'dicommicroscopyviewer_roi_selected',\n      this.onRoiSelected\n    )\n    document.body.addEventListener(\n      'dicommicroscopyviewer_viewport_clicked',\n      this.onMapClicked\n    )\n    document.body.addEventListener(\n      'dicommicroscopyviewer_roi_double_clicked',\n      this.onRoiDoubleClicked\n    )\n    document.body.addEventListener(\n      'dicommicroscopyviewer_pointer_move',\n      this.onPointerMove\n    )\n    document.body.addEventListener(\n      'dicommicroscopyviewer_roi_removed',\n      this.onRoiRemoved\n    )\n    document.body.addEventListener(\n      'dicommicroscopyviewer_roi_modified',\n      this.onRoiModified\n    )\n    document.body.addEventListener(\n      'dicommicroscopyviewer_loading_started',\n      this.onLoadingStarted\n    )\n    document.body.addEventListener(\n      'dicommicroscopyviewer_loading_ended',\n      this.onLoadingEnded\n    )\n    document.body.addEventListener(\n      'dicommicroscopyviewer_loading_error',\n      this.onLoadingError\n    )\n    document.body.addEventListener(\n      'dicommicroscopyviewer_frame_loading_started',\n      this.onFrameLoadingStarted\n    )\n    document.body.addEventListener(\n      'dicommicroscopyviewer_frame_loading_ended',\n      this.onFrameLoadingEnded\n    )\n    document.body.addEventListener(\n      'dicommicroscopyviewer_frame_loading_error',\n      this.onFrameLoadingError\n    )\n    document.body.addEventListener(\n      'keyup',\n      this.onKeyUp\n    )\n    document.body.addEventListener(\n      'keydown',\n      this.onKeyDown\n    )\n    window.addEventListener('beforeunload', this.componentCleanup)\n    window.addEventListener('resize', this.onWindowResize)\n  }\n\n  componentDidMount (): void {\n    this.componentSetup()\n    this.populateViewports()\n\n    if (!this.props.slide.areVolumeImagesMonochrome) {\n      let hasICCProfile = false\n      const image = this.props.slide.volumeImages[0]\n      const metadataItem = image.OpticalPathSequence[0]\n      if (metadataItem.ICCProfile == null) {\n        if ('OpticalPathSequence' in image.bulkdataReferences) {\n          // @ts-expect-error\n          const bulkdataItem = image.bulkdataReferences.OpticalPathSequence[0]\n          if ('ICCProfile' in bulkdataItem) {\n            hasICCProfile = true\n          }\n        }\n      } else {\n        hasICCProfile = true\n      }\n      if (!hasICCProfile) {\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        message.warning('No ICC Profile was found for color images')\n      }\n    }\n  }\n\n  /**\n   * Handler that gets called when a finding has been selected for annotation.\n   *\n   * @param value - Code value of the coded finding that got selected\n   * @param option - Option that got selected\n   */\n  handleAnnotationFindingSelection (\n    value: string,\n    option: any\n  ): void {\n    this.findingOptions.forEach(finding => {\n      if (finding.CodeValue === value) {\n        console.info(`selected finding \"${finding.CodeMeaning}\"`)\n        this.setState({\n          selectedFinding: finding,\n          selectedEvaluations: []\n        })\n      }\n    })\n  }\n\n  /**\n   * Handler that gets called when a geometry type has been selected for\n   * annotation.\n   *\n   * @param value - Code value of the coded finding that got selected\n   * @param option - Option that got selected\n   */\n  handleAnnotationGeometryTypeSelection (value: string, option: any): void {\n    this.setState({ selectedGeometryType: value })\n  }\n\n  /**\n   * Handler that gets called when measurements have been selected for\n   * annotation.\n   */\n  handleAnnotationMeasurementActivation (event: any): void {\n    const active: boolean = event.target.checked\n    if (active) {\n      this.setState({ selectedMarkup: 'measurement' })\n    } else {\n      this.setState({ selectedMarkup: undefined })\n    }\n  }\n\n  /**\n   * Handler that gets called when an evaluation has been selected for an\n   * annotation.\n   *\n   * @param value - Code value of the coded evaluation that got selected\n   * @param option - Option that got selected\n   */\n  handleAnnotationEvaluationSelection (\n    value: string,\n    option: any\n  ): void {\n    const selectedFinding = this.state.selectedFinding\n    if (selectedFinding !== undefined) {\n      const key = _buildKey(selectedFinding)\n      const name = option.label\n      this.evaluationOptions[key].forEach(evaluation => {\n        if (\n          evaluation.name.CodeValue === name.CodeValue &&\n          evaluation.name.CodingSchemeDesignator === name.CodingSchemeDesignator\n        ) {\n          evaluation.values.forEach(code => {\n            if (code.CodeValue === value) {\n              const filteredEvaluations = this.state.selectedEvaluations.filter(\n                (item: Evaluation) => item.name !== evaluation.name\n              )\n              this.setState({\n                selectedEvaluations: [\n                  ...filteredEvaluations,\n                  { name: name, value: code }\n                ]\n              })\n            }\n          })\n        }\n      })\n    }\n  }\n\n  /**\n   * Handler that gets called when an evaluation has been cleared for an\n   * annotation.\n   */\n  handleAnnotationEvaluationClearance (): void {\n    this.setState({\n      selectedEvaluations: []\n    })\n  }\n\n  handleXCoordinateSelection (value: any): void {\n    if (value != null) {\n      const x = Number(value)\n      const start = this.state.validXCoordinateRange[0]\n      const end = this.state.validXCoordinateRange[1]\n      if (x >= start && x <= end) {\n        this.setState({\n          selectedXCoordinate: x,\n          isSelectedXCoordinateValid: true\n        })\n        return\n      }\n    }\n    this.setState({\n      selectedXCoordinate: undefined,\n      isSelectedXCoordinateValid: false\n    })\n  }\n\n  handleYCoordinateSelection (value: any): void {\n    if (value != null) {\n      const y = Number(value)\n      const start = this.state.validYCoordinateRange[0]\n      const end = this.state.validYCoordinateRange[1]\n      if (y >= start && y <= end) {\n        this.setState({\n          selectedYCoordinate: y,\n          isSelectedYCoordinateValid: true\n        })\n        return\n      }\n    }\n    this.setState({\n      selectedYCoordinate: undefined,\n      isSelectedYCoordinateValid: false\n    })\n  }\n\n  handleMagnificationSelection (value: any): void {\n    if (value != null) {\n      if (value > 0 && value <= 40) {\n        this.setState({\n          selectedMagnification: Number(value),\n          isSelectedMagnificationValid: true\n        })\n        return\n      }\n    }\n    this.setState({\n      selectedMagnification: undefined,\n      isSelectedMagnificationValid: false\n    })\n  }\n\n  /**\n   * Handler that gets called when the selection of slide position was\n   * completed.\n   */\n  handleSlidePositionSelection (): void {\n    if (\n      this.state.isSelectedXCoordinateValid &&\n      this.state.isSelectedYCoordinateValid &&\n      this.state.isSelectedMagnificationValid &&\n      this.state.selectedXCoordinate != null &&\n      this.state.selectedYCoordinate != null &&\n      this.state.selectedMagnification != null\n    ) {\n      console.info(\n        'select slide position ' +\n        `(${this.state.selectedXCoordinate}, ` +\n        `${this.state.selectedYCoordinate}) ` +\n        `at ${this.state.selectedMagnification}x magnification`\n      )\n\n      const factor = this.state.selectedMagnification\n      /**\n       * On an optical microscope an objective with 1x magnification\n       * corresponds to approximately 10 micrometer pixel spacing\n       * (due to the ocular).\n       */\n      const targetPixelSpacing = 0.01 / factor\n      const diffs = []\n      for (let i = 0; i < this.volumeViewer.numLevels; i++) {\n        const actualPixelSpacing = this.volumeViewer.getPixelSpacing(i)[0]\n        diffs.push(Math.abs(targetPixelSpacing - actualPixelSpacing))\n      }\n      const level = diffs.indexOf(Math.min(...diffs))\n      this.volumeViewer.navigate({\n        position: [\n          this.state.selectedXCoordinate,\n          this.state.selectedYCoordinate\n        ],\n        level: level\n      })\n      const point = new dmv.scoord3d.Point({\n        coordinates: [\n          this.state.selectedXCoordinate,\n          this.state.selectedYCoordinate,\n          0\n        ],\n        frameOfReferenceUID: this.volumeViewer.frameOfReferenceUID\n      })\n      const roi = new dmv.roi.ROI({ scoord3d: point })\n      this.volumeViewer.addROI(roi, this.defaultRoiStyle)\n      this.setState(state => {\n        const visibleRoiUIDs = state.visibleRoiUIDs\n        visibleRoiUIDs.add(roi.uid)\n        return {\n          visibleRoiUIDs,\n          isGoToModalVisible: false\n        }\n      })\n    }\n  }\n\n  /**\n   * Handler that gets called when the selection of a slide position was\n   * canceled.\n   */\n  handleSlidePositionSelectionCancellation (): void {\n    console.log('cancel slide position selection')\n    this.setState({\n      isGoToModalVisible: false,\n      isSelectedXCoordinateValid: false,\n      isSelectedYCoordinateValid: false,\n      isSelectedMagnificationValid: false,\n      selectedXCoordinate: undefined,\n      selectedYCoordinate: undefined,\n      selectedMagnification: undefined\n    })\n  }\n\n  /**\n   * Handler that gets called when annotation configuration has been completed.\n   */\n  handleAnnotationConfigurationCompletion (): void {\n    console.debug('complete annotation configuration')\n    const finding = this.state.selectedFinding\n    const geometryType = this.state.selectedGeometryType\n    const markup = this.state.selectedMarkup\n    if (geometryType !== undefined && finding !== undefined) {\n      this.volumeViewer.activateDrawInteraction({ geometryType, markup })\n      this.setState({\n        isAnnotationModalVisible: false,\n        isRoiDrawingActive: true\n      })\n    } else {\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.VISUALIZATION,\n          'Could not complete annotation configuration'\n        )\n      )\n    }\n  }\n\n  /**\n   * Handler that gets called when annotation configuration has been cancelled.\n   */\n  handleAnnotationConfigurationCancellation (): void {\n    console.debug('cancel annotation configuration')\n    this.setState({\n      isAnnotationModalVisible: false,\n      isRoiDrawingActive: false\n    })\n  }\n\n  /**\n   * Handler that gets called when a report should be generated for the current\n   * set of annotations.\n   */\n  handleReportGeneration (): void {\n    console.info('save ROIs')\n    const rois = this.volumeViewer.getAllROIs()\n    const opticalPaths = this.volumeViewer.getAllOpticalPaths()\n    const metadata = this.volumeViewer.getOpticalPathMetadata(\n      opticalPaths[0].identifier\n    )\n    this.setState((prevState) => {\n      const report = generateReport({\n        rois,\n        metadata,\n        user: this.props.user,\n        app: this.props.app,\n        visibleRoiUIDs: prevState.visibleRoiUIDs\n      })\n      return {\n        isReportModalVisible: report.isReportModalVisible,\n        generatedReport: report.generatedReport\n      }\n    })\n  }\n\n  /**\n   * Handler that gets called when a report should be verified. The current\n   * list of annotations will be presented to the user together with other\n   * pertinent metadata about the patient, study, and specimen.\n   */\n  handleReportVerification (): void {\n    console.info('verfied report')\n\n    const report = this.state.generatedReport\n    if (report !== undefined) {\n      const dataset = report as unknown as dmv.metadata.Comprehensive3DSR\n      console.debug('create File Meta Information')\n      const fileMetaInformationVersionArray = new Uint8Array(2)\n      fileMetaInformationVersionArray[1] = 1\n      const fileMeta = {\n        // FileMetaInformationVersion\n        '00020001': {\n          Value: [fileMetaInformationVersionArray.buffer],\n          vr: 'OB'\n        },\n        // MediaStorageSOPClassUID\n        '00020002': {\n          Value: [dataset.SOPClassUID],\n          vr: 'UI'\n        },\n        // MediaStorageSOPInstanceUID\n        '00020003': {\n          Value: [dataset.SOPInstanceUID],\n          vr: 'UI'\n        },\n        // TransferSyntaxUID\n        '00020010': {\n          Value: ['1.2.840.10008.1.2.1'],\n          vr: 'UI'\n        },\n        // ImplementationClassUID\n        '00020012': {\n          Value: [this.props.app.uid],\n          vr: 'UI'\n        }\n      }\n\n      console.info('store Comprehensive 3D SR document')\n      const writer = new dcmjs.data.DicomDict(fileMeta)\n      writer.dict = dcmjs.data.DicomMetaDictionary.denaturalizeDataset(dataset)\n      const buffer = writer.write()\n      const client = this.props.clients[StorageClasses.COMPREHENSIVE_3D_SR]\n      client.storeInstances({ datasets: [buffer] }).then(\n        (response: any) => message.info('Annotations were saved.')\n      ).catch((error) => {\n        console.error(error)\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        NotificationMiddleware.onError(\n          NotificationMiddlewareContext.SLIM,\n          new CustomError(\n            errorTypes.ENCODINGANDDECODING,\n            'Annotations could not be saved'\n          )\n        )\n      })\n    }\n    this.setState({\n      isReportModalVisible: false,\n      generatedReport: undefined\n    })\n  }\n\n  /**\n   * Handler that gets called when report generation has been cancelled.\n   */\n  handleReportCancellation (): void {\n    this.setState({\n      isReportModalVisible: false,\n      generatedReport: undefined\n    })\n  }\n\n  /**\n   * Handle toggling of annotation visibility, i.e., whether a given\n   * annotation should be either displayed or hidden by the viewer.\n   */\n  handleAnnotationVisibilityChange ({ roiUID, isVisible }: {\n    roiUID: string\n    isVisible: boolean\n  }): void {\n    if (isVisible) {\n      console.info(`show ROI ${roiUID}`)\n      const roi = this.volumeViewer.getROI(roiUID)\n      const key = _getRoiKey(roi)\n      const style = this.getRoiStyle(key)\n      this.volumeViewer.setROIStyle(roi.uid, style)\n      this.setState(state => {\n        const visibleRoiUIDs = state.visibleRoiUIDs\n        visibleRoiUIDs.add(roi.uid)\n        return { visibleRoiUIDs }\n      })\n    } else {\n      console.info(`hide ROI ${roiUID}`)\n      this.setState(state => {\n        const selectedRoiUIDs = state.selectedRoiUIDs\n        selectedRoiUIDs.delete(roiUID)\n        const visibleRoiUIDs = state.visibleRoiUIDs\n        visibleRoiUIDs.delete(roiUID)\n        return { visibleRoiUIDs, selectedRoiUIDs }\n      })\n      this.volumeViewer.setROIStyle(roiUID, {})\n    }\n  }\n\n  /**\n   * Handle toggling of annotation group visibility, i.e., whether a given\n   * annotation group should be either displayed or hidden by the viewer.\n   */\n  handleAnnotationGroupVisibilityChange ({ annotationGroupUID, isVisible }: {\n    annotationGroupUID: string\n    isVisible: boolean\n  }): void {\n    console.log(`change visibility of annotation group ${annotationGroupUID}`)\n    if (isVisible) {\n      console.info(`show annotation group ${annotationGroupUID}`)\n      try {\n        this.volumeViewer.showAnnotationGroup(annotationGroupUID)\n      } catch (error) {\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        NotificationMiddleware.onError(\n          NotificationMiddlewareContext.SLIM,\n          new CustomError(\n            errorTypes.VISUALIZATION,\n            'Failed to show annotation group.'\n          )\n        )\n        throw error\n      }\n      this.setState(state => {\n        const visibleAnnotationGroupUIDs = new Set(\n          state.visibleAnnotationGroupUIDs\n        )\n        visibleAnnotationGroupUIDs.add(annotationGroupUID)\n        return { visibleAnnotationGroupUIDs }\n      })\n    } else {\n      console.info(`hide annotation group ${annotationGroupUID}`)\n      this.volumeViewer.hideAnnotationGroup(annotationGroupUID)\n      this.setState(state => {\n        const visibleAnnotationGroupUIDs = new Set(\n          state.visibleAnnotationGroupUIDs\n        )\n        visibleAnnotationGroupUIDs.delete(annotationGroupUID)\n        return { visibleAnnotationGroupUIDs }\n      })\n    }\n  }\n\n  /**\n   * Handle change of annotation group style.\n   */\n  handleAnnotationGroupStyleChange ({ uid, styleOptions }: {\n    uid: string\n    styleOptions: {\n      opacity?: number\n      color?: number[]\n      measurement?: dcmjs.sr.coding.CodedConcept\n    }\n  }): void {\n    console.log(`change style of annotation group ${uid}`)\n    try {\n      this.volumeViewer.setAnnotationGroupStyle(\n        uid,\n        styleOptions\n      )\n    } catch (error) {\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.VISUALIZATION,\n          'Failed to change style of annotation group.'\n        )\n      )\n      throw error\n    }\n  }\n\n  generateRoiStyle (\n    styleOptions: StyleOptions): dmv.viewer.ROIStyleOptions {\n    const opacity = styleOptions.opacity ?? DEFAULT_ANNOTATION_OPACITY\n    const strokeColor = styleOptions.color ?? DEFAULT_ANNOTATION_STROKE_COLOR\n    const fillColor = styleOptions.contourOnly ? [0, 0, 0, 0] : strokeColor.map((c) => Math.min(c + 25, 255))\n    const style = _formatRoiStyle({\n      fill: { color: [...fillColor, opacity] },\n      stroke: { color: [...strokeColor, opacity] },\n      radius: this.defaultRoiStyle.stroke?.width\n    })\n    return style\n  }\n\n  handleRoiStyleChange ({ uid, styleOptions }: {\n    uid: string\n    styleOptions: StyleOptions\n  }): void {\n    console.log(`change style of ROI ${uid}`)\n    try {\n      this.defaultAnnotationStyles[uid] = styleOptions\n      const style = this.generateRoiStyle(styleOptions)\n\n      const roi = this.volumeViewer.getROI(uid)\n      const key = _getRoiKey(roi) as string\n      this.roiStyles[key] = style\n      this.volumeViewer.setROIStyle(uid, style)\n      this.state.visibleRoiUIDs.add(uid)\n    } catch (error) {\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.VISUALIZATION,\n          'Failed to change style of ROI.'\n        )\n      )\n      throw error\n    }\n  }\n\n  /**\n   * Handle toggling of segment visibility, i.e., whether a given\n   * segment should be either displayed or hidden by the viewer.\n   */\n  handleSegmentVisibilityChange ({ segmentUID, isVisible }: {\n    segmentUID: string\n    isVisible: boolean\n  }): void {\n    console.log(`change visibility of segment ${segmentUID}`)\n    if (isVisible) {\n      console.info(`show segment ${segmentUID}`)\n      this.volumeViewer.showSegment(segmentUID)\n      this.setState(state => {\n        const visibleSegmentUIDs = new Set(state.visibleSegmentUIDs)\n        visibleSegmentUIDs.add(segmentUID)\n        return { visibleSegmentUIDs }\n      })\n    } else {\n      console.info(`hide segment ${segmentUID}`)\n      this.volumeViewer.hideSegment(segmentUID)\n      this.setState(state => {\n        const visibleSegmentUIDs = new Set(state.visibleSegmentUIDs)\n        visibleSegmentUIDs.delete(segmentUID)\n        return { visibleSegmentUIDs }\n      })\n    }\n  }\n\n  /**\n   * Handle change of segment style.\n   */\n  handleSegmentStyleChange ({ segmentUID, styleOptions }: {\n    segmentUID: string\n    styleOptions: {\n      opacity?: number\n    }\n  }): void {\n    console.log(`change style of segment ${segmentUID}`)\n    this.volumeViewer.setSegmentStyle(segmentUID, styleOptions)\n  }\n\n  /**\n   * Handle toggling of mapping visibility, i.e., whether a given\n   * mapping should be either displayed or hidden by the viewer.\n   */\n  handleMappingVisibilityChange ({ mappingUID, isVisible }: {\n    mappingUID: string\n    isVisible: boolean\n  }): void {\n    console.log(`change visibility of mapping ${mappingUID}`)\n    if (isVisible) {\n      console.info(`show mapping ${mappingUID}`)\n      this.volumeViewer.showParameterMapping(mappingUID)\n      this.setState(state => {\n        const visibleMappingUIDs = new Set(state.visibleMappingUIDs)\n        visibleMappingUIDs.add(mappingUID)\n        return { visibleMappingUIDs }\n      })\n    } else {\n      console.info(`hide mapping ${mappingUID}`)\n      this.volumeViewer.hideParameterMapping(mappingUID)\n      this.setState(state => {\n        const visibleMappingUIDs = new Set(state.visibleMappingUIDs)\n        visibleMappingUIDs.delete(mappingUID)\n        return { visibleMappingUIDs }\n      })\n    }\n  }\n\n  /**\n   * Handle change of mapping style.\n   */\n  handleMappingStyleChange ({ mappingUID, styleOptions }: {\n    mappingUID: string\n    styleOptions: {\n      opacity?: number\n    }\n  }): void {\n    console.log(`change style of mapping ${mappingUID}`)\n    this.volumeViewer.setParameterMappingStyle(mappingUID, styleOptions)\n  }\n\n  /**\n   * Handle toggling of optical path visibility, i.e., whether a given\n   * optical path should be either displayed or hidden by the viewer.\n   */\n  handleOpticalPathVisibilityChange ({ opticalPathIdentifier, isVisible }: {\n    opticalPathIdentifier: string\n    isVisible: boolean\n  }): void {\n    console.log(`change visibility of optical path ${opticalPathIdentifier}`)\n    if (isVisible) {\n      console.info(`show optical path ${opticalPathIdentifier}`)\n      this.volumeViewer.showOpticalPath(opticalPathIdentifier)\n      this.setState(state => {\n        const visibleOpticalPathIdentifiers = new Set(\n          state.visibleOpticalPathIdentifiers\n        )\n        visibleOpticalPathIdentifiers.add(opticalPathIdentifier)\n        return { visibleOpticalPathIdentifiers }\n      })\n    } else {\n      console.info(`hide optical path ${opticalPathIdentifier}`)\n      this.volumeViewer.hideOpticalPath(opticalPathIdentifier)\n      this.setState(state => {\n        const visibleOpticalPathIdentifiers = new Set(\n          state.visibleOpticalPathIdentifiers\n        )\n        visibleOpticalPathIdentifiers.delete(opticalPathIdentifier)\n        return { visibleOpticalPathIdentifiers }\n      })\n    }\n  }\n\n  /**\n   * Handle change of optical path style.\n   */\n  handleOpticalPathStyleChange ({ opticalPathIdentifier, styleOptions }: {\n    opticalPathIdentifier: string\n    styleOptions: {\n      opacity?: number\n      color?: number[]\n      limitValues?: number[]\n    }\n  }): void {\n    console.log(`change style of optical path ${opticalPathIdentifier}`)\n    this.volumeViewer.setOpticalPathStyle(opticalPathIdentifier, styleOptions)\n  }\n\n  /**\n   * Handle toggling of optical path activity, i.e., whether a given\n   * optical path should be either added or removed from the viewport.\n   */\n  handleOpticalPathActivityChange ({ opticalPathIdentifier, isActive }: {\n    opticalPathIdentifier: string\n    isActive: boolean\n  }): void {\n    console.log(`change activity of optical path ${opticalPathIdentifier}`)\n    if (isActive) {\n      console.info(`activate optical path ${opticalPathIdentifier}`)\n      this.volumeViewer.activateOpticalPath(opticalPathIdentifier)\n      this.setState(state => {\n        const activeOpticalPathIdentifiers = new Set(\n          state.activeOpticalPathIdentifiers\n        )\n        activeOpticalPathIdentifiers.add(opticalPathIdentifier)\n        return { activeOpticalPathIdentifiers }\n      })\n    } else {\n      console.info(`deactivate optical path ${opticalPathIdentifier}`)\n      this.volumeViewer.deactivateOpticalPath(opticalPathIdentifier)\n      this.setState(state => {\n        const activeOpticalPathIdentifiers = new Set(\n          state.activeOpticalPathIdentifiers\n        )\n        activeOpticalPathIdentifiers.delete(opticalPathIdentifier)\n        return { activeOpticalPathIdentifiers }\n      })\n    }\n  }\n\n  /**\n   * Set default presentation state that is either defined by metadata included\n   * in the DICOM Slide Microscopy instance or by the viewer.\n   */\n  setDefaultPresentationState (): void {\n    const visibleOpticalPathIdentifiers: Set<string> = new Set()\n    const opticalPaths = this.volumeViewer.getAllOpticalPaths()\n    opticalPaths.sort((a, b) => {\n      if (a.identifier.localeCompare(b.identifier) === 1) {\n        return 1\n      } else if (b.identifier.localeCompare(a.identifier) === 1) {\n        return -1\n      }\n      return 0\n    })\n    opticalPaths.forEach((item: dmv.opticalPath.OpticalPath) => {\n      const identifier = item.identifier\n      const style = this.volumeViewer.getOpticalPathDefaultStyle(identifier)\n      this.volumeViewer.setOpticalPathStyle(identifier, style)\n      this.volumeViewer.hideOpticalPath(identifier)\n      this.volumeViewer.deactivateOpticalPath(identifier)\n      if (item.isMonochromatic) {\n        /*\n         * If the image metadata contains a palette color lookup table for the\n         * optical path, then it will be displayed by default.\n         */\n        if (item.paletteColorLookupTableUID != null) {\n          visibleOpticalPathIdentifiers.add(identifier)\n        }\n      } else {\n        /* Color images will always be displayed by default. */\n        visibleOpticalPathIdentifiers.add(identifier)\n      }\n    })\n\n    /*\n     * If no optical paths have been selected for visualization so far, select\n     * first n optical paths and set a default value of interest (VOI) window\n     * (using pre-computed pixel data statistics) and a default color.\n     */\n    if (visibleOpticalPathIdentifiers.size === 0) {\n      const defaultColors = [\n        [255, 255, 255]\n      ]\n      opticalPaths.forEach((item: dmv.opticalPath.OpticalPath) => {\n        const identifier = item.identifier\n        if (item.isMonochromatic) {\n          const numVisible = visibleOpticalPathIdentifiers.size\n          if (numVisible < defaultColors.length) {\n            const style = {\n              ...this.volumeViewer.getOpticalPathStyle(identifier)\n            }\n            const index = numVisible\n            style.color = defaultColors[index]\n            const stats = this.state.pixelDataStatistics[item.identifier]\n            if (stats != null) {\n              style.limitValues = [stats.min, stats.max]\n            }\n            this.volumeViewer.setOpticalPathStyle(item.identifier, style)\n            visibleOpticalPathIdentifiers.add(item.identifier)\n          }\n        }\n      })\n    }\n\n    console.info(\n      `selected n=${visibleOpticalPathIdentifiers.size} optical paths ` +\n      'for visualization'\n    )\n    visibleOpticalPathIdentifiers.forEach(identifier => {\n      this.volumeViewer.showOpticalPath(identifier)\n    })\n    this.setState(state => ({\n      activeOpticalPathIdentifiers: new Set(visibleOpticalPathIdentifiers),\n      visibleOpticalPathIdentifiers: new Set(visibleOpticalPathIdentifiers)\n    }))\n  }\n\n  /**\n   * Handler that gets called when a presentation state has been selected from\n   * the current list of available presentation states.\n   */\n  handlePresentationStateReset (): void {\n    this.setState({ selectedPresentationStateUID: undefined })\n    const urlPath = this.props.location.pathname\n    this.props.navigate(urlPath)\n    this.setDefaultPresentationState()\n  }\n\n  /**\n   * Handler that gets called when a presentation state has been selected from\n   * the current list of available presentation states.\n   */\n  handlePresentationStateSelection (\n    value?: string,\n    option?: any\n  ): void {\n    if (value != null) {\n      console.info(`select Presentation State instance \"${value}\"`)\n      let presentationState\n      this.state.presentationStates.forEach(instance => {\n        if (instance.SOPInstanceUID === value) {\n          presentationState = instance\n        }\n      })\n      if (presentationState != null) {\n        let urlPath = this.props.location.pathname\n        urlPath += `?state=${value}`\n        this.props.navigate(urlPath)\n        this.setPresentationState(presentationState)\n      } else {\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        NotificationMiddleware.onError(\n          NotificationMiddlewareContext.SLIM,\n          new CustomError(\n            errorTypes.VISUALIZATION,\n            'Presentation State could not be found'\n          )\n        )\n        console.log(\n          'failed to handle section of presentation state: ' +\n          `could not find instance \"${value}\"`\n        )\n      }\n    } else {\n      this.handlePresentationStateReset()\n    }\n    this.setState({ selectedPresentationStateUID: value })\n  }\n\n  /**\n   * Handler that will toggle the ROI drawing tool, i.e., either activate or\n   * de-activate it, depending on its current state.\n   */\n  handleRoiDrawing (): void {\n    if (this.state.isRoiDrawingActive) {\n      console.info('deactivate drawing of ROIs')\n      this.volumeViewer.deactivateDrawInteraction()\n      this.volumeViewer.activateSelectInteraction({})\n      this.setState({\n        isAnnotationModalVisible: false,\n        isSelectedRoiModalVisible: false,\n        isRoiTranslationActive: false,\n        isRoiDrawingActive: false,\n        isRoiModificationActive: false,\n        isGoToModalVisible: false\n      })\n    } else {\n      console.info('activate drawing of ROIs')\n      this.setState({\n        isAnnotationModalVisible: true,\n        isSelectedRoiModalVisible: false,\n        isRoiDrawingActive: true,\n        isRoiModificationActive: false,\n        isRoiTranslationActive: false,\n        isGoToModalVisible: false\n      })\n      this.volumeViewer.deactivateSelectInteraction()\n      this.volumeViewer.deactivateSnapInteraction()\n      this.volumeViewer.deactivateTranslateInteraction()\n      this.volumeViewer.deactivateModifyInteraction()\n    }\n  }\n\n  /**\n   * Handler that will toggle the ROI modification tool, i.e., either activate\n   * or de-activate it, depending on its current state.\n   */\n  handleRoiModification (): void {\n    console.info('toggle modification of ROIs')\n    if (this.volumeViewer.isModifyInteractionActive) {\n      this.volumeViewer.deactivateModifyInteraction()\n      this.volumeViewer.deactivateSnapInteraction()\n      this.volumeViewer.activateSelectInteraction({})\n      this.setState({\n        isRoiTranslationActive: false,\n        isRoiDrawingActive: false,\n        isRoiModificationActive: false\n      })\n    } else {\n      this.setState({\n        isRoiModificationActive: true,\n        isRoiDrawingActive: false,\n        isRoiTranslationActive: false\n      })\n      this.volumeViewer.deactivateDrawInteraction()\n      this.volumeViewer.deactivateTranslateInteraction()\n      this.volumeViewer.deactivateSelectInteraction()\n      this.volumeViewer.activateSnapInteraction({})\n      this.volumeViewer.activateModifyInteraction({})\n    }\n  }\n\n  /**\n   * Handler that will toggle the ROI translation tool, i.e., either activate\n   * or de-activate it, depending on its current state.\n   */\n  handleRoiTranslation (): void {\n    console.info('toggle translation of ROIs')\n    if (this.volumeViewer.isTranslateInteractionActive) {\n      this.volumeViewer.deactivateTranslateInteraction()\n      this.setState({\n        isRoiTranslationActive: false,\n        isRoiDrawingActive: false,\n        isRoiModificationActive: false\n      })\n    } else {\n      this.setState({\n        isRoiTranslationActive: true,\n        isRoiDrawingActive: false,\n        isRoiModificationActive: false\n      })\n      this.volumeViewer.deactivateModifyInteraction()\n      this.volumeViewer.deactivateSnapInteraction()\n      this.volumeViewer.deactivateDrawInteraction()\n      this.volumeViewer.deactivateSelectInteraction()\n      this.volumeViewer.activateTranslateInteraction({})\n    }\n  }\n\n  handleGoTo (): void {\n    this.volumeViewer.deactivateDrawInteraction()\n    this.volumeViewer.deactivateModifyInteraction()\n    this.volumeViewer.deactivateSnapInteraction()\n    this.volumeViewer.deactivateTranslateInteraction()\n    this.volumeViewer.deactivateSelectInteraction()\n    this.setState({\n      isGoToModalVisible: true,\n      isAnnotationModalVisible: false,\n      isSelectedRoiModalVisible: false,\n      isReportModalVisible: false,\n      isRoiTranslationActive: false,\n      isRoiModificationActive: false,\n      isRoiDrawingActive: false\n    })\n  }\n\n  /**\n   * Handler that will toggle the ROI removal tool, i.e., either activate\n   * or de-activate it, depending on its current state.\n   */\n  handleRoiRemoval (): void {\n    this.volumeViewer.deactivateDrawInteraction()\n    this.volumeViewer.deactivateSnapInteraction()\n    this.volumeViewer.deactivateTranslateInteraction()\n    this.volumeViewer.deactivateModifyInteraction()\n    if (this.state.selectedRoiUIDs.size > 0) {\n      this.state.selectedRoiUIDs.forEach(uid => {\n        if (uid === undefined) {\n          // eslint-disable-next-line @typescript-eslint/no-floating-promises\n          message.warning('No annotation was selected for removal')\n          return\n        }\n        console.info(`remove ROI \"${uid}\"`)\n        this.volumeViewer.removeROI(uid)\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        message.info('Annotation was removed')\n      })\n      this.setState({\n        selectedRoiUIDs: new Set(),\n        isRoiTranslationActive: false,\n        isRoiDrawingActive: false,\n        isRoiModificationActive: false\n      })\n    } else {\n      this.state.visibleRoiUIDs.forEach(uid => {\n        console.info(`remove ROI \"${uid}\"`)\n        this.volumeViewer.removeROI(uid)\n      })\n      this.setState({\n        visibleRoiUIDs: new Set(),\n        isRoiTranslationActive: false,\n        isRoiDrawingActive: false,\n        isRoiModificationActive: false\n      })\n    }\n    this.volumeViewer.activateSelectInteraction({})\n  }\n\n  /**\n   * Handler that will toggle the ROI visibility tool, i.e., either activate\n   * or de-activate it, depending on its current state.\n   */\n  handleRoiVisibilityChange (): void {\n    console.info('toggle visibility of ROIs')\n    if (!this.state.areRoisHidden) {\n      this.volumeViewer.deactivateDrawInteraction()\n      this.volumeViewer.deactivateSnapInteraction()\n      this.volumeViewer.deactivateTranslateInteraction()\n      this.volumeViewer.deactivateSelectInteraction()\n      this.volumeViewer.deactivateModifyInteraction()\n      this.volumeViewer.hideROIs()\n      this.setState({\n        areRoisHidden: true,\n        isRoiDrawingActive: false,\n        isRoiModificationActive: false,\n        isRoiTranslationActive: false\n      })\n    } else {\n      this.volumeViewer.showROIs()\n      this.volumeViewer.activateSelectInteraction({})\n      this.state.selectedRoiUIDs.forEach(uid => {\n        if (uid !== undefined) {\n          this.volumeViewer.setROIStyle(uid, this.selectedRoiStyle)\n        }\n      })\n      this.setState({ areRoisHidden: false })\n    }\n  }\n\n  handleAnnotationGroupClick = (annotationGroupUID: string): void => {\n    this.volumeViewer.zoomToROI(annotationGroupUID)\n  }\n\n  /**\n   * Handler that will toggle the ICC profile color management, i.e., either\n   * enable or disable it, depending on its current state.\n   */\n  handleICCProfilesToggle = (event: CheckboxChangeEvent): void => {\n    const checked = event.target.checked\n    this.setState({ isICCProfilesEnabled: checked })\n    this.volumeViewer.toggleICCProfiles()\n  }\n\n  formatAnnotation = (annotation: AnnotationCategoryAndType | dmv.roi.ROI): void => {\n    const roi = this.volumeViewer.getROI(annotation.uid)\n    const key = _getRoiKey(roi) as string\n    const color = this.roiStyles[key] !== undefined\n      ? this.roiStyles[key].stroke?.color.slice(0, 3)\n      : DEFAULT_ANNOTATION_COLOR_PALETTE[\n        Object.keys(this.roiStyles).length % DEFAULT_ANNOTATION_COLOR_PALETTE.length\n      ]\n    this.defaultAnnotationStyles[annotation.uid] = {\n      color: color as number[],\n      opacity: DEFAULT_ANNOTATION_OPACITY,\n      contourOnly: false\n    }\n\n    this.roiStyles[key] = this.generateRoiStyle(\n      this.defaultAnnotationStyles[annotation.uid]\n    )\n  }\n\n  render (): React.ReactNode {\n    const rois: dmv.roi.ROI[] = []\n    const segments: dmv.segment.Segment[] = []\n    const mappings: dmv.mapping.ParameterMapping[] = []\n    const annotationGroups: dmv.annotation.AnnotationGroup[] = []\n    rois.push(...this.volumeViewer.getAllROIs())\n    segments.push(...this.volumeViewer.getAllSegments())\n    mappings.push(...this.volumeViewer.getAllParameterMappings())\n    const allAnnotationGroups = this.volumeViewer.getAllAnnotationGroups()\n    const filteredAnnotationGroups = allAnnotationGroups?.filter((annotationGroup) =>\n      annotationGroup.referencedSeriesInstanceUID === this.props.seriesInstanceUID\n    )\n    annotationGroups.push(...filteredAnnotationGroups)\n\n    const annotations = rois.map(roi => adaptRoiToAnnotation(roi))\n\n    const openSubMenuItems = [\n      'specimens', 'optical-paths', 'annotations', 'presentation-states'\n    ]\n\n    let report: React.ReactNode\n    const dataset = this.state.generatedReport\n    if (dataset !== undefined) {\n      report = <Report dataset={dataset} />\n    }\n\n    let annotationMenuItems: React.ReactNode\n    if (rois.length > 0) {\n      annotationMenuItems = (\n        <AnnotationList\n          rois={rois}\n          selectedRoiUIDs={this.state.selectedRoiUIDs}\n          visibleRoiUIDs={this.state.visibleRoiUIDs}\n          onSelection={this.handleAnnotationSelection}\n          onVisibilityChange={this.handleAnnotationVisibilityChange}\n        />\n      )\n    }\n\n    const findingOptions = this.findingOptions.map((finding, index) => {\n      return (\n        <Select.Option\n          key={(finding.CodeValue !== undefined && finding.CodeValue !== '') ? finding.CodeValue : `finding-${index}`}\n          value={finding.CodeValue}\n        >\n          {finding.CodeMeaning}\n        </Select.Option>\n      )\n    })\n\n    const geometryTypeOptionsMapping: { [key: string]: React.ReactNode } = {\n      point: <Select.Option key='point' value='point'>Point</Select.Option>,\n      circle: <Select.Option key='circle' value='circle'>Circle</Select.Option>,\n      box: <Select.Option key='box' value='box'>Box</Select.Option>,\n      polygon: <Select.Option key='polygon' value='polygon'>Polygon</Select.Option>,\n      line: <Select.Option key='line' value='line'>Line</Select.Option>,\n      freehandpolygon: (\n        <Select.Option key='freehandpolygon' value='freehandpolygon'>\n          Polygon (freehand)\n        </Select.Option>\n      ),\n      freehandline: (\n        <Select.Option key='freehandline' value='freehandline'>\n          Line (freehand)\n        </Select.Option>\n      )\n    }\n\n    const annotationConfigurations: React.ReactNode[] = [\n      (\n        <Select\n          style={{ minWidth: 130 }}\n          onSelect={this.handleAnnotationFindingSelection}\n          key='annotation-finding'\n          defaultActiveFirstOption\n          placeholder='Select finding'\n        >\n          {findingOptions}\n        </Select>\n      )\n    ]\n    const selectedFinding = this.state.selectedFinding\n    if (selectedFinding !== undefined) {\n      const key = _buildKey(selectedFinding)\n      this.evaluationOptions[key].forEach((evaluation, index) => {\n        const evaluationOptions = evaluation.values.map(code => {\n          return (\n            <Select.Option\n              key={(code.CodeValue !== undefined && code.CodeValue !== '') ? code.CodeValue : `evaluation-${index}`}\n              value={code.CodeValue}\n              label={evaluation.name}\n            >\n              {code.CodeMeaning}\n            </Select.Option>\n          )\n        })\n        annotationConfigurations.push(\n          <>\n            {evaluation.name.CodeMeaning}\n            <Select\n              style={{ minWidth: 130 }}\n              onSelect={this.handleAnnotationEvaluationSelection}\n              allowClear\n              onClear={this.handleAnnotationEvaluationClearance}\n              defaultActiveFirstOption={false}\n            >\n              {evaluationOptions}\n            </Select>\n          </>\n        )\n      })\n      const geometryTypeOptions = this.geometryTypeOptions[key].map(name => {\n        return geometryTypeOptionsMapping[name]\n      })\n      annotationConfigurations.push(\n        <>\n          ROI geometry type\n          <Select\n            style={{ minWidth: 130 }}\n            onSelect={this.handleAnnotationGeometryTypeSelection}\n            key='annotation-geometry-type'\n            placeholder='Select geometry type'\n          >\n            {geometryTypeOptions}\n          </Select>\n        </>\n      )\n      annotationConfigurations.push(\n        <Checkbox\n          onChange={this.handleAnnotationMeasurementActivation}\n          key='annotation-measurement'\n        >\n          measure\n        </Checkbox>\n      )\n    }\n\n    const specimenMenu = (\n      <Menu.SubMenu key='specimens' title='Specimens'>\n        <SpecimenList\n          metadata={this.props.slide.volumeImages[0]}\n          showstain={false}\n        />\n      </Menu.SubMenu>\n    )\n\n    const equipmentMenu = (\n      <Menu.SubMenu key='equipment' title='Equipment'>\n        <Equipment metadata={this.props.slide.volumeImages[0]} />\n      </Menu.SubMenu>\n    )\n\n    const opticalPaths = this.volumeViewer.getAllOpticalPaths()\n    opticalPaths.sort((a, b) => {\n      if (a.identifier.localeCompare(b.identifier) === 1) {\n        return 1\n      } else if (b.identifier.localeCompare(a.identifier) === 1) {\n        return -1\n      }\n      return 0\n    })\n    const opticalPathStyles: {\n      [identifier: string]: {\n        opacity: number\n        color?: number[]\n        limitValues?: number[]\n        paletteColorLookupTable?: dmv.color.PaletteColorLookupTable\n      }\n    } = {}\n    const opticalPathMetadata: {\n      [identifier: string]: dmv.metadata.VLWholeSlideMicroscopyImage[]\n    } = {}\n    opticalPaths.forEach(opticalPath => {\n      const identifier = opticalPath.identifier\n      const metadata = this.volumeViewer.getOpticalPathMetadata(identifier)\n      opticalPathMetadata[identifier] = metadata\n      const style = {\n        ...this.volumeViewer.getOpticalPathStyle(identifier)\n      }\n      opticalPathStyles[identifier] = style\n    })\n    const opticalPathMenu = (\n      <Menu.SubMenu key='optical-paths' title='Optical Paths'>\n        <OpticalPathList\n          metadata={opticalPathMetadata}\n          opticalPaths={opticalPaths}\n          defaultOpticalPathStyles={opticalPathStyles}\n          visibleOpticalPathIdentifiers={this.state.visibleOpticalPathIdentifiers}\n          activeOpticalPathIdentifiers={this.state.activeOpticalPathIdentifiers}\n          onOpticalPathVisibilityChange={this.handleOpticalPathVisibilityChange}\n          onOpticalPathStyleChange={this.handleOpticalPathStyleChange}\n          onOpticalPathActivityChange={this.handleOpticalPathActivityChange}\n          selectedPresentationStateUID={this.state.selectedPresentationStateUID}\n        />\n      </Menu.SubMenu>\n    )\n\n    let presentationStateMenu\n    if (this.state.presentationStates.length > 0) {\n      const presentationStateOptions = []\n      this.state.presentationStates.forEach((instance, index) => {\n        presentationStateOptions.push(\n          <Select.Option\n            key={(instance.SOPInstanceUID !== undefined && instance.SOPInstanceUID !== '') ? instance.SOPInstanceUID : `presentation-state-${index}`}\n            value={instance.SOPInstanceUID}\n            dropdownMatchSelectWidth={false}\n            size='small'\n          >\n            {instance.ContentDescription !== undefined && instance.ContentDescription !== '' ? instance.ContentDescription : 'Untitled'}\n          </Select.Option>\n        )\n      })\n      presentationStateOptions.push(\n        <Select.Option\n          key='default-presentation-state'\n          value={undefined}\n          dropdownMatchSelectWidth={false}\n          size='small'\n        >\n          <></>\n        </Select.Option>\n      )\n      presentationStateMenu = (\n        <Menu.SubMenu key='presentation-states' title='Presentation States'>\n          <Space align='center' size={20} style={{ padding: '14px' }}>\n            <Select\n              style={{ minWidth: 200, maxWidth: 200 }}\n              onSelect={this.handlePresentationStateSelection}\n              key='presentation-states'\n              value={this.state.selectedPresentationStateUID}\n            >\n              {presentationStateOptions}\n            </Select>\n            <Tooltip title='Reset'>\n              <Btn\n                icon={<UndoOutlined />}\n                type='primary'\n                onClick={this.handlePresentationStateReset}\n              />\n            </Tooltip>\n          </Space>\n        </Menu.SubMenu>\n      )\n    }\n\n    let segmentationMenu\n    if (segments.length > 0) {\n      const defaultSegmentStyles: {\n        [segmentUID: string]: {\n          opacity: number\n        }\n      } = {}\n      const segmentMetadata: {\n        [segmentUID: string]: dmv.metadata.Segmentation[]\n      } = {}\n      const segments = this.volumeViewer.getAllSegments()\n      segments.forEach(segment => {\n        defaultSegmentStyles[segment.uid] = this.volumeViewer.getSegmentStyle(\n          segment.uid\n        )\n        segmentMetadata[segment.uid] = this.volumeViewer.getSegmentMetadata(\n          segment.uid\n        )\n      })\n      segmentationMenu = (\n        <Menu.SubMenu key='segmentations' title='Segmentations'>\n          <SegmentList\n            segments={segments}\n            metadata={segmentMetadata}\n            defaultSegmentStyles={defaultSegmentStyles}\n            visibleSegmentUIDs={this.state.visibleSegmentUIDs}\n            onSegmentVisibilityChange={this.handleSegmentVisibilityChange}\n            onSegmentStyleChange={this.handleSegmentStyleChange}\n          />\n        </Menu.SubMenu>\n      )\n      openSubMenuItems.push('segmentations')\n    }\n\n    let parametricMapMenu\n    if (mappings.length > 0) {\n      const defaultMappingStyles: {\n        [mappingUID: string]: {\n          opacity: number\n        }\n      } = {}\n      const mappingMetadata: {\n        [mappingUID: string]: dmv.metadata.ParametricMap[]\n      } = {}\n      mappings.forEach(mapping => {\n        defaultMappingStyles[mapping.uid] = this.volumeViewer.getParameterMappingStyle(\n          mapping.uid\n        )\n        mappingMetadata[mapping.uid] = this.volumeViewer.getParameterMappingMetadata(\n          mapping.uid\n        )\n      })\n      parametricMapMenu = (\n        <Menu.SubMenu key='parmetric-maps' title='Parametric Maps'>\n          <MappingList\n            mappings={mappings}\n            metadata={mappingMetadata}\n            defaultMappingStyles={defaultMappingStyles}\n            visibleMappingUIDs={this.state.visibleMappingUIDs}\n            onMappingVisibilityChange={this.handleMappingVisibilityChange}\n            onMappingStyleChange={this.handleMappingStyleChange}\n          />\n        </Menu.SubMenu>\n      )\n      openSubMenuItems.push('parametric-maps')\n    }\n\n    let annotationGroupMenu\n\n    annotations?.forEach?.(this.formatAnnotation.bind(this))\n\n    if (annotationGroups.length > 0) {\n      const annotationGroupMetadata: {\n        [annotationGroupUID: string]: dmv.metadata.MicroscopyBulkSimpleAnnotations\n      } = {}\n      const defaultAnnotationGroupStyles: {\n        [annotationUID: string]: {\n          opacity: number\n          color: number[]\n        }\n      } = {}\n      annotationGroups.forEach(annotationGroup => {\n        defaultAnnotationGroupStyles[annotationGroup.uid] = this.volumeViewer.getAnnotationGroupStyle(\n          annotationGroup.uid\n        )\n        annotationGroupMetadata[annotationGroup.uid] = this.volumeViewer.getAnnotationGroupMetadata(\n          annotationGroup.uid\n        )\n      })\n      annotationGroupMenu = (\n        <Menu.SubMenu key='annotation-groups' title='Annotation Groups'>\n          <AnnotationGroupList\n            annotationGroups={annotationGroups}\n            metadata={annotationGroupMetadata}\n            onAnnotationGroupClick={this.handleAnnotationGroupClick}\n            // when adding annotationGroups to annotationCategory list,\n            // make so that this is uses this.defaultAnnotationStyles later instead of defaultAnnotationGroupStyles\n            defaultAnnotationGroupStyles={defaultAnnotationGroupStyles}\n            visibleAnnotationGroupUIDs={this.state.visibleAnnotationGroupUIDs}\n            onAnnotationGroupVisibilityChange={this.handleAnnotationGroupVisibilityChange}\n            onAnnotationGroupStyleChange={this.handleAnnotationGroupStyleChange}\n          />\n        </Menu.SubMenu>\n      )\n      openSubMenuItems.push('annotationGroups')\n    }\n\n    let toolbar\n    let toolbarHeight = '0px'\n    const annotationTools = [\n      <Button\n        tooltip='Draw ROI [Alt+D]'\n        icon={FaDrawPolygon}\n        onClick={this.handleRoiDrawing}\n        isSelected={this.state.isRoiDrawingActive}\n        key='draw-roi-button'\n      />,\n      <Button\n        tooltip='Modify ROIs [Alt+M]'\n        icon={FaHandPointer}\n        onClick={this.handleRoiModification}\n        isSelected={this.state.isRoiModificationActive}\n        key='modify-roi-button'\n      />,\n      <Button\n        tooltip='Translate ROIs [Alt+T]'\n        icon={FaHandPaper}\n        onClick={this.handleRoiTranslation}\n        isSelected={this.state.isRoiTranslationActive}\n        key='translate-roi-button'\n      />,\n      <Button\n        tooltip='Remove selected ROI [Alt+R]'\n        onClick={this.handleRoiRemoval}\n        icon={FaTrash}\n        key='remove-roi-button'\n      />,\n      <Button\n        tooltip='Show/Hide ROIs [Alt+V]'\n        icon={this.state.areRoisHidden ? FaEye : FaEyeSlash}\n        onClick={this.handleRoiVisibilityChange}\n        isSelected={this.state.areRoisHidden}\n        key='toggle-roi-visibility-button'\n      />,\n      <Button\n        tooltip='Save ROIs [Alt+S]'\n        icon={FaSave}\n        onClick={this.handleReportGeneration}\n        key='generate-report-button'\n      />\n    ]\n    const controlTools = [\n      <Button\n        tooltip='Go to [Alt+G]'\n        icon={FaCrosshairs}\n        onClick={this.handleGoTo}\n        key='go-to-slide-position-button'\n      />\n    ]\n    if (this.props.enableAnnotationTools) {\n      toolbar = (\n        <Row justify='start'>\n          {annotationTools.map((item, i) => {\n            return <React.Fragment key={i}>{item}</React.Fragment>\n          })}\n          {controlTools.map((item, i) => {\n            return <React.Fragment key={i}>{item}</React.Fragment>\n          })}\n        </Row>\n      )\n      toolbarHeight = '50px'\n    }\n\n    let cursor = 'default'\n    if (this.state.isLoading) {\n      cursor = 'progress'\n    }\n\n    let selectedRoiInformation\n    if (this.state.selectedRoi != null) {\n      const roiAttributes: Array<{\n        name: string\n        value: string\n        unit?: string\n      }> = [\n        {\n          name: 'UID',\n          value: this.state.selectedRoi.uid\n        }\n      ]\n      const roiScoordAttributes: Array<{\n        name: string\n        value: string\n      }> = [\n        {\n          name: 'Graphic type',\n          value: this.state.selectedRoi.scoord3d.graphicType\n        }\n      ]\n      const roiEvaluationAttributes: Array<{\n        name: string\n        value: string\n      }> = []\n      this.state.selectedRoi.evaluations.forEach(item => {\n        if (item.ValueType === 'CODE') {\n          const codeItem = item as dcmjs.sr.valueTypes.CodeContentItem\n          roiEvaluationAttributes.push({\n            name: codeItem.ConceptNameCodeSequence[0].CodeMeaning,\n            value: codeItem.ConceptCodeSequence[0].CodeMeaning\n          })\n        } else {\n          const textItem = item as dcmjs.sr.valueTypes.TextContentItem\n          roiEvaluationAttributes.push({\n            name: textItem.ConceptNameCodeSequence[0].CodeMeaning,\n            value: textItem.TextValue\n          })\n        }\n      })\n      const roiMeasurmentAttributesPerOpticalPath: {\n        [identifier: string]: Array<{\n          name: string\n          value: string\n          unit?: string\n        }>\n      } = {}\n      this.state.selectedRoi.measurements.forEach(item => {\n        let identifier = 'default'\n        if (item.ContentSequence != null) {\n          const refItems = findContentItemsByName({\n            content: item.ContentSequence,\n            name: new dcmjs.sr.coding.CodedConcept({\n              value: '121112',\n              meaning: 'Source of Measurement',\n              schemeDesignator: 'DCM'\n            })\n          })\n          if (refItems.length > 0) {\n            identifier = (\n              refItems[0]\n                // @ts-expect-error\n                .ReferencedSOPSequence[0]\n                .ReferencedOpticalPathIdentifier\n            )\n          }\n        }\n        if (!(identifier in roiMeasurmentAttributesPerOpticalPath)) {\n          roiMeasurmentAttributesPerOpticalPath[identifier] = []\n        }\n        const measuredValueItem = item.MeasuredValueSequence[0]\n        roiMeasurmentAttributesPerOpticalPath[identifier].push({\n          name: item.ConceptNameCodeSequence[0].CodeMeaning,\n          value: measuredValueItem.NumericValue.toString(),\n          unit: measuredValueItem.MeasurementUnitsCodeSequence[0].CodeMeaning\n        })\n      })\n      const createRoiDescription = (\n        attributes: Array<{ name: string, value: string, unit?: string }>\n      ): React.ReactNode[] => {\n        return attributes.map(item => {\n          let value\n          if (item.unit != null) {\n            value = `${item.value} [${item.unit}]`\n          } else {\n            value = item.value\n          }\n          return (\n            <Descriptions.Item\n              key={item.name}\n              label={item.name}\n            >\n              {value}\n            </Descriptions.Item>\n          )\n        })\n      }\n      const roiDescriptions = createRoiDescription(roiAttributes)\n      const roiScoordDescriptions = createRoiDescription(\n        roiScoordAttributes\n      )\n      const roiEvaluationDescriptions = createRoiDescription(\n        roiEvaluationAttributes\n      )\n      const roiMeasurementDescriptions = []\n      for (const identifier in roiMeasurmentAttributesPerOpticalPath) {\n        const descriptions = createRoiDescription(\n          roiMeasurmentAttributesPerOpticalPath[identifier]\n        )\n        if (identifier === 'default') {\n          roiMeasurementDescriptions.push(descriptions)\n        } else {\n          roiMeasurementDescriptions.push(\n            <>\n              <Divider orientation='left' orientationMargin={0} dashed plain>\n                {identifier}\n              </Divider>\n              {descriptions}\n            </>\n          )\n        }\n      }\n      selectedRoiInformation = (\n        <>\n          <Descriptions layout='horizontal' column={1}>\n            {roiDescriptions}\n          </Descriptions>\n          <Divider orientation='left' orientationMargin={0}>\n            Spatial coordinates\n          </Divider>\n          <Descriptions layout='horizontal' column={1}>\n            {roiScoordDescriptions}\n          </Descriptions>\n          <Divider orientation='left' orientationMargin={0}>\n            Evaluations\n          </Divider>\n          <Descriptions layout='horizontal' column={1}>\n            {roiEvaluationDescriptions}\n          </Descriptions>\n          <Divider orientation='left' orientationMargin={0}>\n            Measurements\n          </Divider>\n          <Descriptions layout='horizontal' column={1}>\n            {roiMeasurementDescriptions}\n          </Descriptions>\n        </>\n      )\n    }\n\n    const iccProfilesMenu = this.volumeViewer.getICCProfiles().length > 0 && (\n      <div style={{ margin: '0.9rem' }}>\n        <Checkbox\n          checked={this.state.isICCProfilesEnabled}\n          onChange={this.handleICCProfilesToggle}\n        >\n          ICC Profiles\n        </Checkbox>\n      </div>\n    )\n\n    return (\n      <Layout style={{ height: '100%' }} hasSider>\n        <Layout.Content style={{ height: '100%' }}>\n          {toolbar}\n\n          <div\n            style={{\n              height: `calc(100% - ${toolbarHeight})`,\n              overflow: 'hidden',\n              cursor: cursor\n            }}\n            ref={this.volumeViewportRef}\n          />\n\n          <Modal\n            open={this.state.isAnnotationModalVisible}\n            title='Configure annotations'\n            onOk={this.handleAnnotationConfigurationCompletion}\n            okButtonProps={{ disabled: !(this.state.selectedFinding !== undefined && this.state.selectedGeometryType !== undefined) }}\n            onCancel={this.handleAnnotationConfigurationCancellation}\n            okText='Select'\n          >\n            <Space align='start' direction='vertical'>\n              {annotationConfigurations}\n            </Space>\n          </Modal>\n\n          <Modal\n            open={this.state.isSelectedRoiModalVisible}\n            title='Selected ROI'\n            onCancel={this.handleRoiSelectionCancellation}\n            maskClosable\n            footer={null}\n          >\n            <Space align='start' direction='vertical'>\n              {selectedRoiInformation}\n            </Space>\n          </Modal>\n\n          <Modal\n            open={this.state.isGoToModalVisible}\n            title='Go to slide position'\n            onOk={this.handleSlidePositionSelection}\n            onCancel={this.handleSlidePositionSelectionCancellation}\n            okText='Select'\n          >\n            <Space align='start' direction='vertical'>\n              <InputNumber\n                placeholder={\n                  '[' +\n                  `${this.state.validXCoordinateRange[0]}` +\n                  ', ' +\n                  `${this.state.validXCoordinateRange[1]}` +\n                  ']'\n                }\n                prefix='X Coordinate [mm]'\n                onChange={this.handleXCoordinateSelection}\n                onPressEnter={this.handleXCoordinateSelection}\n                controls={false}\n                addonAfter={\n                  this.state.isSelectedXCoordinateValid\n                    ? (\n                      <CheckOutlined style={{ color: 'rgba(0,0,0,.45)' }} />\n                      )\n                    : (\n                      <StopOutlined style={{ color: 'rgba(0,0,0,.45)' }} />\n                      )\n                }\n              />\n              <InputNumber\n                placeholder={\n                  '[' +\n                  `${this.state.validYCoordinateRange[0]}` +\n                  ', ' +\n                  `${this.state.validYCoordinateRange[1]}` +\n                  ']'\n                }\n                prefix='Y Coordinate [mm]'\n                onChange={this.handleYCoordinateSelection}\n                onPressEnter={this.handleYCoordinateSelection}\n                controls={false}\n                addonAfter={\n                  this.state.isSelectedYCoordinateValid\n                    ? (\n                      <CheckOutlined style={{ color: 'rgba(0,0,0,.45)' }} />\n                      )\n                    : (\n                      <StopOutlined style={{ color: 'rgba(0,0,0,.45)' }} />\n                      )\n                }\n              />\n              <InputNumber\n                placeholder='[0 - 40]'\n                prefix='Magnification'\n                onChange={this.handleMagnificationSelection}\n                onPressEnter={this.handleMagnificationSelection}\n                controls={false}\n                addonAfter={\n                  this.state.isSelectedMagnificationValid\n                    ? (\n                      <CheckOutlined style={{ color: 'rgba(0,0,0,.45)' }} />\n                      )\n                    : (\n                      <StopOutlined style={{ color: 'rgba(0,0,0,.45)' }} />\n                      )\n                }\n              />\n            </Space>\n          </Modal>\n\n          <Modal\n            open={this.state.isReportModalVisible}\n            title='Verify and save report'\n            onOk={this.handleReportVerification}\n            onCancel={this.handleReportCancellation}\n            okText='Save'\n          >\n            {report}\n          </Modal>\n        </Layout.Content>\n\n        <Layout.Sider\n          width={300}\n          reverseArrow\n          style={{\n            borderLeft: 'solid',\n            borderLeftWidth: 0.25,\n            overflow: 'hidden',\n            background: 'none'\n          }}\n        >\n          <Menu\n            mode='inline'\n            defaultOpenKeys={openSubMenuItems}\n            style={{ height: '100%' }}\n            inlineIndent={14}\n            forceSubMenuRender\n            onOpenChange={() => {\n              // Give menu item time to render before updating viewer size\n              setTimeout(() => {\n                if (this.labelViewer != null) {\n                  this.labelViewer.resize()\n                }\n              }, 100)\n            }}\n          >\n            {this.labelViewportRef.current != null && (\n              <Menu.SubMenu key='label' title='Slide label'>\n                <Menu.Item style={{ height: '100%' }} key='image'>\n                  <div\n                    style={{ height: '220px' }}\n                    ref={this.labelViewportRef}\n                  />\n                </Menu.Item>\n              </Menu.SubMenu>\n            )}\n            {specimenMenu}\n            {iccProfilesMenu}\n            {equipmentMenu}\n            {opticalPathMenu}\n            {presentationStateMenu}\n            <Menu.SubMenu key='annotations' title='Annotations'>\n              {annotationMenuItems}\n            </Menu.SubMenu>\n            {annotationGroupMenu}\n            {annotations.length === 0\n              ? (\n                <></>\n                )\n              : (\n                <Menu.SubMenu\n                  key='annotation-categories'\n                  title='Annotation Categories'\n                >\n                  <AnnotationCategoryList\n                    annotations={annotations}\n                    onChange={this.handleAnnotationVisibilityChange}\n                    checkedAnnotationUids={this.state.visibleRoiUIDs}\n                    onStyleChange={this.handleRoiStyleChange}\n                    defaultAnnotationStyles={this.defaultAnnotationStyles}\n                  />\n                </Menu.SubMenu>\n                )}\n            {segmentationMenu}\n            {parametricMapMenu}\n          </Menu>\n        </Layout.Sider>\n        {this.state.isHoveredRoiTooltipVisible &&\n        this.state.hoveredRoiAttributes.length > 0\n          ? (\n            <HoveredRoiTooltip\n              xPosition={this.state.hoveredRoiTooltipX}\n              yPosition={this.state.hoveredRoiTooltipY}\n              rois={this.state.hoveredRoiAttributes}\n            />\n            )\n          : (\n            <></>\n            )}\n      </Layout>\n    )\n  }\n}\n\nexport default withRouter(SlideViewer)\n","import * as dmv from 'dicom-microscopy-viewer'\nimport { CustomError, errorTypes } from '../utils/CustomError'\nimport NotificationMiddleware, {\n  NotificationMiddlewareContext\n} from '../services/NotificationMiddleware'\n\nenum ImageFlavors {\n  VOLUME = 'VOLUME',\n  LABEL = 'LABEL',\n  OVERVIEW = 'OVERVIEW',\n  THUMBNAIL = 'THUMBNAIL'\n}\n\nconst hasImageFlavor = (\n  image: dmv.metadata.VLWholeSlideMicroscopyImage,\n  imageFlavor: ImageFlavors\n): boolean => {\n  return image.ImageType[2] === imageFlavor\n}\n\nconst areSameAcquisition = (\n  image: dmv.metadata.VLWholeSlideMicroscopyImage,\n  refImage: dmv.metadata.VLWholeSlideMicroscopyImage\n): boolean => {\n  if (image.AcquisitionUID != null) {\n    return image.AcquisitionUID === refImage.AcquisitionUID\n  }\n  return false\n}\n\ninterface SlideImageCollection {\n  acquisitionUID?: string\n  frameOfReferenceUID: string\n  containerIdentifier: string\n  volumeImages: dmv.metadata.VLWholeSlideMicroscopyImage[]\n  labelImages: dmv.metadata.VLWholeSlideMicroscopyImage[]\n  overviewImages: dmv.metadata.VLWholeSlideMicroscopyImage[]\n}\n\ninterface SlideOptions {\n  images: dmv.metadata.VLWholeSlideMicroscopyImage[]\n  description?: string\n}\n\n/**\n * Slide - collection of images with the same Frame of Reference UID and\n * Container Identifier.\n */\nclass Slide {\n  readonly description: string\n  readonly acquisitionUID: string | null | undefined\n  readonly frameOfReferenceUID: string\n  readonly containerIdentifier: string\n  readonly seriesInstanceUIDs: string[]\n  readonly opticalPathIdentifiers: string[]\n  readonly pyramidUIDs: string[] = []\n  readonly areVolumeImagesMonochrome: boolean\n  readonly volumeImages: dmv.metadata.VLWholeSlideMicroscopyImage[]\n  readonly labelImages: dmv.metadata.VLWholeSlideMicroscopyImage[]\n  readonly overviewImages: dmv.metadata.VLWholeSlideMicroscopyImage[]\n\n  /**\n   * @param options\n   * @param options.images - Metadata of images associated with the slide\n   * @param options.description - Description of the slide\n   */\n  constructor (\n    options: SlideOptions\n  ) {\n    if (options.images.length === 0) {\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.ENCODINGANDDECODING,\n          'Value of option \"images\" have been non-zero length.'\n        )\n      )\n    }\n\n    const seriesInstanceUIDs = new Set([] as string[])\n    const acquisitionUIDs = new Set([] as string[])\n    const opticalPathIdentifiers = new Set([] as string[])\n    const containerIdentifiers = new Set([] as string[])\n    const frameOfReferenceUIDs = {\n      VOLUME: new Set([] as string[]),\n      LABEL: new Set([] as string[]),\n      OVERVIEW: new Set([] as string[])\n    }\n    const pyramidUIDs: {\n      [key: string]: { [opticalPathIdentifier: string]: Set<string> }\n    } = {\n      VOLUME: {}\n    }\n    const volumeImages: dmv.metadata.VLWholeSlideMicroscopyImage[] = []\n    const labelImages: dmv.metadata.VLWholeSlideMicroscopyImage[] = []\n    const overviewImages: dmv.metadata.VLWholeSlideMicroscopyImage[] = []\n    options.images.forEach((image) => {\n      containerIdentifiers.add(image.ContainerIdentifier)\n      seriesInstanceUIDs.add(image.SeriesInstanceUID)\n      image.OpticalPathSequence.forEach(item => {\n        opticalPathIdentifiers.add(item.OpticalPathIdentifier)\n      })\n      if (image.AcquisitionUID != null) {\n        acquisitionUIDs.add(image.AcquisitionUID)\n      }\n      if (hasImageFlavor(image, ImageFlavors.VOLUME)) {\n        frameOfReferenceUIDs.VOLUME.add(image.FrameOfReferenceUID)\n        if (image.PyramidUID !== null && image.PyramidUID !== undefined) {\n          for (const identifier of Object.keys(opticalPathIdentifiers)) {\n            pyramidUIDs.VOLUME[identifier].add(image.PyramidUID)\n          }\n        }\n        volumeImages.push(image)\n      } else if (hasImageFlavor(image, ImageFlavors.THUMBNAIL)) {\n        const hasEquivalentVolume = options.images.some(img =>\n          hasImageFlavor(img, ImageFlavors.VOLUME) &&\n          img.FrameOfReferenceUID === image.FrameOfReferenceUID &&\n          img.OpticalPathSequence.every(opt => opt.OpticalPathIdentifier === image.OpticalPathSequence[0].OpticalPathIdentifier)\n        )\n        if (!hasEquivalentVolume) {\n          frameOfReferenceUIDs.VOLUME.add(image.FrameOfReferenceUID)\n          if (image.PyramidUID !== null && image.PyramidUID !== undefined) {\n            for (const identifier of Object.keys(opticalPathIdentifiers)) {\n              pyramidUIDs.VOLUME[identifier].add(image.PyramidUID)\n            }\n          }\n          volumeImages.push(image)\n        }\n      } else if (hasImageFlavor(image, ImageFlavors.LABEL)) {\n        frameOfReferenceUIDs.LABEL.add(image.FrameOfReferenceUID)\n        labelImages.push(image)\n      } else if (hasImageFlavor(image, ImageFlavors.OVERVIEW)) {\n        frameOfReferenceUIDs.OVERVIEW.add(image.FrameOfReferenceUID)\n        overviewImages.push(image)\n      }\n    })\n\n    if (volumeImages.length === 0) {\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.ENCODINGANDDECODING,\n          'At least one VOLUME image must be provided for a slide.'\n        )\n      )\n    } else {\n      if (acquisitionUIDs.size > 1) {\n        NotificationMiddleware.onError(\n          NotificationMiddlewareContext.SLIM,\n          new CustomError(\n            errorTypes.ENCODINGANDDECODING,\n            'All VOLUME images of a slide must have the same number of ' +\n            'Samples per Pixel.'\n          )\n        )\n      }\n\n      const samplesPerPixel = new Set([] as number[])\n      volumeImages.forEach((image) => {\n        samplesPerPixel.add(image.SamplesPerPixel)\n      })\n      if (samplesPerPixel.size > 1) {\n        NotificationMiddleware.onError(\n          NotificationMiddlewareContext.SLIM,\n          new CustomError(\n            errorTypes.ENCODINGANDDECODING,\n            'All VOLUME images of a slide must have the same number of ' +\n            'Samples per Pixel.'\n          )\n        )\n      }\n\n      const isNotResampled = volumeImages.filter(image => {\n        return image.ImageType[3] !== 'RESAMPLED'\n      })\n      if (isNotResampled.length > opticalPathIdentifiers.size) {\n        console.warn(\n          'the set of VOLUME images of a slide must contain only a single ' +\n            'image that has not been resampled per optical path'\n        )\n      }\n    }\n\n    this.volumeImages = volumeImages\n    this.labelImages = labelImages\n    this.overviewImages = overviewImages\n\n    this.seriesInstanceUIDs = [...seriesInstanceUIDs]\n    this.opticalPathIdentifiers = [...opticalPathIdentifiers]\n\n    if (containerIdentifiers.size !== 1) {\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.ENCODINGANDDECODING,\n          'All images of a slide must have the same Container Identifier.'\n        )\n      )\n    }\n    this.containerIdentifier = [...containerIdentifiers][0]\n\n    if (frameOfReferenceUIDs.VOLUME.size !== 1) {\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.ENCODINGANDDECODING,\n          'All VOLUME images of a slide must have ' +\n          'the same Frame of Reference UID.'\n        )\n      )\n    }\n    this.frameOfReferenceUID = [...frameOfReferenceUIDs.VOLUME][0]\n\n    let requirePyramidUID = false\n    if (Object.keys(pyramidUIDs.VOLUME).length > 0) {\n      requirePyramidUID = true\n    }\n    this.opticalPathIdentifiers.forEach(identifier => {\n      if (pyramidUIDs.VOLUME[identifier] != null) {\n        if (pyramidUIDs.VOLUME[identifier].size > 1) {\n          NotificationMiddleware.onError(\n            NotificationMiddlewareContext.SLIM,\n            new CustomError(\n              errorTypes.ENCODINGANDDECODING,\n              `All VOLUME images for optical path \"${identifier}\"` +\n              'must be part of the same multi-resolution pyramid.'\n            )\n          )\n        } else if (pyramidUIDs.VOLUME[identifier].size === 1) {\n          this.pyramidUIDs.push([...pyramidUIDs.VOLUME[identifier]][0])\n        } else {\n          NotificationMiddleware.onError(\n            NotificationMiddlewareContext.SLIM,\n            new CustomError(\n              errorTypes.ENCODINGANDDECODING,\n              `The VOLUME images for optical path \"${identifier}\" ` +\n              'lack the Pyramid UID, while the images for other optical paths ' +\n              'contain it.'\n            )\n          )\n        }\n      } else {\n        if (requirePyramidUID) {\n          NotificationMiddleware.onError(\n            NotificationMiddlewareContext.SLIM,\n            new CustomError(\n              errorTypes.ENCODINGANDDECODING,\n              `The VOLUME images for optical path \"${identifier}\" ` +\n              'lack the Pyramid UID, while the images for other optical paths ' +\n              'contain it.'\n            )\n          )\n        }\n      }\n    })\n\n    if (acquisitionUIDs.size > 1) {\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.ENCODINGANDDECODING,\n          'All VOLUME images of a slide must be part of the same  ' +\n          'acquisition and have the same Acquisition UID.'\n        )\n      )\n    } else if (acquisitionUIDs.size === 1) {\n      this.acquisitionUID = [...acquisitionUIDs][0]\n    } else {\n      this.acquisitionUID = null\n    }\n\n    this.areVolumeImagesMonochrome = (\n      this.volumeImages[0].SamplesPerPixel === 1 &&\n      this.volumeImages[0].PhotometricInterpretation === 'MONOCHROME2'\n    )\n\n    this.description = (\n      options.description !== undefined ? options.description : ''\n    )\n  }\n}\n\n/**\n * Create slides.\n *\n * @param imagesPerSeries - Image instances grouped per series\n * @param referenceSeriesInstanceUID - Unique identifier of the series that serves as a reference for the slide\n * @returns Slides\n */\nconst createSlides = (\n  images: dmv.metadata.VLWholeSlideMicroscopyImage[][]\n): Slide[] => {\n  const slideMetadata: SlideImageCollection[] = []\n  images.forEach((series) => {\n    if (series.length > 0) {\n      const volumeImages = series.filter((image) => {\n        return (\n          hasImageFlavor(image, ImageFlavors.VOLUME) ||\n          hasImageFlavor(image, ImageFlavors.THUMBNAIL)\n        )\n      })\n      if (volumeImages.length > 0) {\n        const refImage = volumeImages[0]\n        const filteredVolumeImages = volumeImages.filter((image) => {\n          return refImage.SamplesPerPixel === image.SamplesPerPixel\n        })\n        const slideMetadataIndex = slideMetadata.findIndex((slide) => {\n          return _doesImageBelongToSlide(slide, refImage)\n        })\n\n        const labelImages = series.filter((image) => {\n          return hasImageFlavor(image, ImageFlavors.LABEL)\n        })\n        let filteredLabelImages: dmv.metadata.VLWholeSlideMicroscopyImage[]\n        if (labelImages.length > 1) {\n          filteredLabelImages = labelImages.filter((image) => {\n            return areSameAcquisition(image, refImage)\n          })\n        } else {\n          filteredLabelImages = labelImages\n        }\n        const overviewImages = series.filter((image) => {\n          return hasImageFlavor(image, ImageFlavors.OVERVIEW)\n        })\n        let filteredOverviewImages: dmv.metadata.VLWholeSlideMicroscopyImage[]\n        if (overviewImages.length > 1) {\n          filteredOverviewImages = overviewImages.filter((image) => {\n            return areSameAcquisition(image, refImage)\n          })\n        } else {\n          filteredOverviewImages = overviewImages\n        }\n\n        if (slideMetadataIndex === -1) {\n          const slideMetadataItem: SlideImageCollection = {\n            acquisitionUID: refImage.AcquisitionUID,\n            frameOfReferenceUID: refImage.FrameOfReferenceUID,\n            containerIdentifier: refImage.ContainerIdentifier,\n            volumeImages: filteredVolumeImages,\n            labelImages: filteredLabelImages,\n            overviewImages: filteredOverviewImages\n          }\n          slideMetadata.push(slideMetadataItem)\n        } else {\n          const slideMetadataItem = slideMetadata[slideMetadataIndex]\n          slideMetadataItem.volumeImages.push(...filteredVolumeImages)\n          slideMetadataItem.labelImages.push(...filteredLabelImages)\n          slideMetadataItem.overviewImages.push(...filteredOverviewImages)\n        }\n      }\n    }\n  })\n\n  let slides: Slide[] = slideMetadata.map((item) => {\n    return new Slide({\n      images: [\n        ...item.volumeImages,\n        ...item.labelImages,\n        ...item.overviewImages\n      ]\n    })\n  })\n  slides = slides.sort((a, b) => {\n    const imgA = a.volumeImages[0]\n    const imgB = b.volumeImages[0]\n    if (imgA.ContainerIdentifier != null && imgB.ContainerIdentifier != null) {\n      return Number(imgA.ContainerIdentifier) - Number(imgB.ContainerIdentifier)\n    } else {\n      return 0\n    }\n  })\n\n  return slides\n}\n\n/**\n * Check if instance belongs to the slide.\n *\n * Compares values of Frame of Reference UID and Container Identifier attributes.\n *\n * @param slide - Slide metadata object\n * @param image - Metadata of VOLUME, LABEL or OVERVIEW image instance\n */\nfunction _doesImageBelongToSlide (\n  slide: SlideImageCollection,\n  image: dmv.metadata.VLWholeSlideMicroscopyImage\n): boolean {\n  if (\n    slide.frameOfReferenceUID === image.FrameOfReferenceUID &&\n    slide.containerIdentifier === image.ContainerIdentifier &&\n    slide.acquisitionUID === image.AcquisitionUID\n  ) {\n    return true\n  }\n  return false\n}\n\nexport { Slide, createSlides }\n","import * as dmv from 'dicom-microscopy-viewer'\n\nimport DicomWebManager from '../DicomWebManager'\nimport { StorageClasses } from '../data/uids'\nimport { CustomError, errorTypes } from '../utils/CustomError'\nimport NotificationMiddleware, {\n  NotificationMiddlewareContext\n} from './NotificationMiddleware'\nimport { createSlides, Slide } from '../data/slides'\n\ninterface FetchImageMetadataParams {\n  clients: { [key: string]: DicomWebManager }\n  studyInstanceUID: string\n  onSuccess: (slides: Slide[]) => void\n  onError: (error: Error) => void\n}\n\nexport const fetchImageMetadata = async ({\n  clients,\n  studyInstanceUID,\n  onSuccess,\n  onError\n}: FetchImageMetadataParams): Promise<void> => {\n  try {\n    const images: dmv.metadata.VLWholeSlideMicroscopyImage[][] = []\n    console.info(`search for series of study \"${studyInstanceUID}\"...`)\n\n    const client = clients[StorageClasses.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE]\n    const matchedSeries = await client.searchForSeries({\n      queryParams: {\n        Modality: 'SM',\n        StudyInstanceUID: studyInstanceUID\n      }\n    })\n\n    await Promise.all(\n      matchedSeries.map(async (s) => {\n        const { dataset } = dmv.metadata.formatMetadata(s)\n        const loadingSeries = dataset as dmv.metadata.Series\n        console.info(\n          `retrieve metadata of series \"${loadingSeries.SeriesInstanceUID}\"`\n        )\n        const retrievedMetadata = await client.retrieveSeriesMetadata({\n          studyInstanceUID: studyInstanceUID,\n          seriesInstanceUID: loadingSeries.SeriesInstanceUID\n        })\n\n        const seriesImages: dmv.metadata.VLWholeSlideMicroscopyImage[] = []\n        retrievedMetadata.forEach((item) => {\n          if (\n            item['00080016']?.Value?.[0] ===\n            StorageClasses.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE\n          ) {\n            const image = new dmv.metadata.VLWholeSlideMicroscopyImage({\n              metadata: item\n            })\n            seriesImages.push(image)\n          }\n        })\n\n        if (seriesImages.length > 0) {\n          images.push(seriesImages)\n        }\n      })\n    )\n    const newSlides = createSlides(images)\n    onSuccess(newSlides)\n  } catch (err) {\n    console.error(err)\n    const customError = new CustomError(\n      errorTypes.ENCODINGANDDECODING,\n      'Image metadata could not be retrieved or decoded.'\n    )\n    onError(customError)\n    NotificationMiddleware.onError(\n      NotificationMiddlewareContext.SLIM,\n      customError\n    )\n  }\n}\n","import { useState, useEffect } from 'react'\n\nimport DicomWebManager from '../DicomWebManager'\nimport { Slide } from '../data/slides'\nimport { fetchImageMetadata } from '../services/fetchImageMetadata'\n\ninterface UseSlidesProps {\n  clients: { [key: string]: DicomWebManager }\n  studyInstanceUID: string\n}\n\ninterface UseSlidesReturn {\n  slides: Slide[]\n  isLoading: boolean\n  error: Error | null\n}\n\nconst slidesCache = new Map<string, Slide[]>()\nconst pendingRequests = new Map<string, Promise<Slide[]>>()\n\n/**\n * Hook to fetch and manage whole slide microscopy images for a given study.\n * Values are cached so they can be reused if props are not provided.\n *\n * @param props - Hook configuration props\n * @param props.clients - Map of DICOM web clients keyed by storage class\n */\nexport const useSlides = ({ clients, studyInstanceUID }: UseSlidesProps): UseSlidesReturn => {\n  const [slides, setSlides] = useState<Slide[]>([])\n  const [isLoading, setIsLoading] = useState<boolean>(false)\n  const [error, setError] = useState<Error | null>(null)\n\n  useEffect(() => {\n    if (studyInstanceUID === undefined) {\n      setSlides([])\n      setIsLoading(false)\n      return\n    }\n\n    const cachedData = slidesCache.get(studyInstanceUID)\n    if (cachedData !== undefined) {\n      setSlides(cachedData)\n      setIsLoading(false)\n      return\n    }\n\n    setIsLoading(true)\n\n    const fetchSlides = async (): Promise<void> => {\n      // Check if there's already a pending request for this study\n      let pendingRequest = pendingRequests.get(studyInstanceUID)\n\n      if (pendingRequest === undefined) {\n        // Create a new promise for this request\n        pendingRequest = new Promise((resolve, reject): void => {\n          fetchImageMetadata({\n            clients,\n            studyInstanceUID,\n            onSuccess: (newSlides) => {\n              slidesCache.set(studyInstanceUID, newSlides)\n              resolve(newSlides)\n            },\n            onError: (err) => {\n              reject(err)\n            }\n          }).catch((err) => {\n            reject(err)\n          })\n        })\n        pendingRequests.set(studyInstanceUID, pendingRequest)\n      }\n\n      try {\n        const newSlides = await pendingRequest\n        setSlides(newSlides)\n        setError(null)\n      } catch (err) {\n        setError(err as Error)\n        setSlides([])\n      } finally {\n        pendingRequests.delete(studyInstanceUID)\n        setIsLoading(false)\n      }\n    }\n\n    void fetchSlides()\n  }, [clients, studyInstanceUID])\n\n  return { slides, isLoading, error }\n}\n","import { Routes, Route, useLocation, useParams } from 'react-router-dom'\nimport { Layout, Menu } from 'antd'\nimport * as dcmjs from 'dcmjs'\nimport { useEffect, useState } from 'react'\n\nimport { AnnotationSettings } from '../AppConfig'\nimport ClinicalTrial from './ClinicalTrial'\nimport DicomWebManager from '../DicomWebManager'\nimport Patient from './Patient'\nimport Study from './Study'\nimport SlideList from './SlideList'\nimport SlideViewer from './SlideViewer'\n\nimport { User } from '../auth'\nimport { Slide } from '../data/slides'\nimport { RouteComponentProps, withRouter } from '../utils/router'\nimport { useSlides } from '../hooks/useSlides'\nimport { StorageClasses } from '../data/uids'\n\nconst { naturalizeDataset } = dcmjs.data.DicomMetaDictionary\n\ninterface NaturalizedInstance {\n  SeriesInstanceUID: string\n  SOPInstanceUID: string\n  ReferencedSeriesSequence?: Array<{\n    SeriesInstanceUID: string\n  }>\n  ContentSequence?: Array<{\n    ConceptNameCodeSequence: Array<{\n      CodeValue: string\n    }>\n    ContentSequence?: Array<{\n      ContentSequence: Array<{\n        ReferencedSOPSequence: Array<{\n          ReferencedSOPInstanceUID: string\n        }>\n      }>\n    }>\n  }>\n}\n\ninterface ReferencedSlideResult {\n  slide: Slide | undefined\n  metadata: NaturalizedInstance\n}\n\nconst findSeriesSlide = (slides: Slide[], seriesInstanceUID: string): Slide | undefined => {\n  return slides.find((slide: Slide) => {\n    return slide.seriesInstanceUIDs.find((uid: string) => {\n      return uid === seriesInstanceUID\n    })\n  })\n}\n\nfunction ParametrizedSlideViewer ({\n  clients,\n  slides,\n  user,\n  app,\n  preload,\n  enableAnnotationTools,\n  annotations\n}: {\n  clients: { [key: string]: DicomWebManager }\n  slides: Slide[]\n  user?: User\n  app: {\n    name: string\n    version: string\n    uid: string\n    organization?: string\n  }\n  preload: boolean\n  enableAnnotationTools: boolean\n  annotations: AnnotationSettings[]\n}): JSX.Element | null {\n  const { studyInstanceUID = '', seriesInstanceUID = '' } = useParams<{ studyInstanceUID: string, seriesInstanceUID: string }>()\n  const location = useLocation()\n\n  const [selectedSlide, setSelectedSlide] = useState(findSeriesSlide(slides, seriesInstanceUID))\n  const [derivedDataset, setDerivedDataset] = useState<NaturalizedInstance | null>(null)\n\n  useEffect(() => {\n    const seriesSlide = findSeriesSlide(slides, seriesInstanceUID)\n    if (seriesSlide !== null) {\n      setSelectedSlide(seriesSlide)\n    }\n  }, [seriesInstanceUID, slides])\n\n  useEffect(() => {\n    const findReferencedSlide = async ({ clients, studyInstanceUID, seriesInstanceUID }: {\n      clients: { [key: string]: DicomWebManager }\n      studyInstanceUID: string\n      seriesInstanceUID: string\n    }): Promise<ReferencedSlideResult | null> => await new Promise<ReferencedSlideResult | null>((resolve, reject) => {\n      try {\n        const allClients = Object.values(StorageClasses).map((storageClass) => clients[storageClass])\n        Promise.all(allClients.map(async (client) => {\n          const seriesMetadata = await client.retrieveSeriesMetadata({\n            studyInstanceUID: studyInstanceUID,\n            seriesInstanceUID: seriesInstanceUID\n          })\n          const [naturalizedSeriesMetadata] = seriesMetadata.map((metadata) => naturalizeDataset(metadata)) as NaturalizedInstance[]\n\n          if (naturalizedSeriesMetadata.ReferencedSeriesSequence != null) {\n            const referencedSeriesInstanceUID = naturalizedSeriesMetadata.ReferencedSeriesSequence[0].SeriesInstanceUID\n            const referencedSlide = slides.find((slide: Slide) => {\n              return slide.seriesInstanceUIDs.find((uid: string) => {\n                return uid === referencedSeriesInstanceUID\n              })\n            })\n            resolve({ slide: referencedSlide, metadata: naturalizedSeriesMetadata })\n          }\n\n          const IMAGE_LIBRARY_CONCEPT_NAME_CODE = '111028'\n          const imageLibrary = naturalizedSeriesMetadata.ContentSequence?.find(\n            contentItem => contentItem.ConceptNameCodeSequence[0].CodeValue === IMAGE_LIBRARY_CONCEPT_NAME_CODE\n          )\n          if ((imageLibrary?.ContentSequence?.[0]?.ContentSequence?.[0]?.ReferencedSOPSequence?.[0]) != null) {\n            const referencedSOPInstanceUID = imageLibrary.ContentSequence[0].ContentSequence[0].ReferencedSOPSequence[0].ReferencedSOPInstanceUID\n            const referencedSlide = slides.find((slide: Slide) => {\n              return slide.volumeImages.find((image: { SOPInstanceUID: string }) => {\n                return image.SOPInstanceUID === referencedSOPInstanceUID\n              })\n            })\n            resolve({ slide: referencedSlide, metadata: naturalizedSeriesMetadata })\n          }\n        })).catch(reject)\n      } catch (error) {\n        reject(error)\n      }\n    })\n\n    if (selectedSlide === null || selectedSlide === undefined) {\n      void findReferencedSlide({ clients, studyInstanceUID, seriesInstanceUID }).then((result: ReferencedSlideResult | null) => {\n        if (result !== null) {\n          setSelectedSlide(result.slide)\n          setDerivedDataset(result.metadata)\n        }\n      }).catch(error => {\n        console.error('Error finding referenced slide:', error)\n      })\n    }\n  }, [slides, clients, selectedSlide, studyInstanceUID, seriesInstanceUID])\n\n  const searchParams = new URLSearchParams(location.search)\n  let presentationStateUID: string | null | undefined\n  if (!searchParams.has('access_token')) {\n    presentationStateUID = searchParams.get('state')\n    if (presentationStateUID === null) {\n      presentationStateUID = undefined\n    }\n  }\n\n  let viewer = null\n  if (selectedSlide != null) {\n    viewer = (\n      <SlideViewer\n        clients={clients}\n        studyInstanceUID={studyInstanceUID}\n        seriesInstanceUID={seriesInstanceUID}\n        selectedPresentationStateUID={presentationStateUID}\n        slide={selectedSlide}\n        preload={preload}\n        annotations={annotations}\n        enableAnnotationTools={enableAnnotationTools}\n        app={app}\n        user={user}\n        derivedDataset={derivedDataset}\n      />\n    )\n  }\n  return viewer\n}\n\ninterface ViewerProps extends RouteComponentProps {\n  clients: { [key: string]: DicomWebManager }\n  studyInstanceUID: string\n  app: {\n    name: string\n    version: string\n    uid: string\n    organization?: string\n  }\n  annotations: AnnotationSettings[]\n  enableAnnotationTools: boolean\n  preload: boolean\n  user?: {\n    name: string\n    email: string\n  }\n}\n\nfunction Viewer (props: ViewerProps): JSX.Element | null {\n  const { clients, studyInstanceUID, location, navigate } = props\n  const { slides, isLoading } = useSlides({ clients, studyInstanceUID })\n\n  const handleSeriesSelection = ({ seriesInstanceUID }: { seriesInstanceUID: string }): void => {\n    console.info(`switch to series \"${seriesInstanceUID}\"`)\n    let urlPath = (\n      `/studies/${studyInstanceUID}` +\n      `/series/${seriesInstanceUID}`\n    )\n\n    if (location.pathname.includes('/projects/')) {\n      urlPath = location.pathname\n      if (!location.pathname.includes('/series/')) {\n        urlPath += `/series/${seriesInstanceUID}`\n      } else {\n        urlPath = urlPath.replace(/\\/series\\/[^/]+/, `/series/${seriesInstanceUID}`)\n      }\n    }\n\n    if (\n      location.pathname.includes('/series/') &&\n      location.search != null\n    ) {\n      urlPath += location.search\n    }\n\n    navigate(urlPath, { replace: true })\n  }\n\n  if (isLoading) {\n    return null\n  }\n\n  if (slides.length === 0) {\n    return null\n  }\n\n  const firstSlide = slides[0]\n  const volumeInstances = firstSlide.volumeImages\n  if (volumeInstances.length === 0) {\n    return null\n  }\n  const refImage = volumeInstances[0]\n\n  /* If a series is encoded in the path, route the viewer to this series.\n   * Otherwise select the first series correspondent to\n   * the first slide contained in the study.\n   */\n  let selectedSeriesInstanceUID: string\n  if (location.pathname.includes('series/')) {\n    const seriesFragment = location.pathname.split('series/')[1]\n    selectedSeriesInstanceUID = seriesFragment.includes('/') ? seriesFragment.split('/')[0] : seriesFragment\n  } else {\n    selectedSeriesInstanceUID = volumeInstances[0].SeriesInstanceUID\n  }\n\n  let clinicalTrialMenu\n  if (refImage.ClinicalTrialSponsorName != null) {\n    clinicalTrialMenu = (\n      <Menu.SubMenu key='clinical-trial' title='Clinical Trial'>\n        <ClinicalTrial metadata={refImage} />\n      </Menu.SubMenu>\n    )\n  }\n\n  return (\n    <Layout style={{ height: '100%' }} hasSider>\n      <Layout.Sider\n        width={300}\n        style={{\n          height: '100%',\n          borderRight: 'solid',\n          borderRightWidth: 0.25,\n          overflow: 'hidden',\n          background: 'none'\n        }}\n      >\n        <Menu\n          mode='inline'\n          defaultOpenKeys={['patient', 'study', 'clinical-trial', 'slides']}\n          style={{ height: '100%' }}\n          inlineIndent={14}\n        >\n          <Menu.SubMenu key='patient' title='Patient'>\n            <Patient metadata={refImage} />\n          </Menu.SubMenu>\n          <Menu.SubMenu key='study' title='Study'>\n            <Study metadata={refImage} />\n          </Menu.SubMenu>\n          {clinicalTrialMenu}\n          <Menu.SubMenu key='slides' title='Slides'>\n            <SlideList\n              clients={props.clients}\n              metadata={slides}\n              selectedSeriesInstanceUID={selectedSeriesInstanceUID}\n              onSeriesSelection={handleSeriesSelection}\n            />\n          </Menu.SubMenu>\n        </Menu>\n      </Layout.Sider>\n\n      <Routes>\n        <Route\n          path='/series/:seriesInstanceUID'\n          element={\n            <ParametrizedSlideViewer\n              clients={props.clients}\n              slides={slides}\n              preload={props.preload}\n              annotations={props.annotations}\n              enableAnnotationTools={props.enableAnnotationTools}\n              app={props.app}\n              user={props.user}\n            />\n          }\n        />\n      </Routes>\n    </Layout>\n  )\n}\n\nexport default withRouter(Viewer)\n","import dcmjs from 'dcmjs'\n\nconst { DicomMetaDictionary } = dcmjs.data\n\ninterface TagInfo {\n  tag: string\n  vr: string\n  keyword: string\n  value: string\n  children?: TagInfo[]\n  level: number\n}\n\nexport interface DicomTag {\n  name: string\n  vr: string\n  Value?: any[]\n  [key: string]: any\n}\n\nconst formatValue = (val: any): string => {\n  if (typeof val === 'object' && val !== null) {\n    return JSON.stringify(val)\n  }\n  return String(val)\n}\n\nexport const formatTagValue = (tag: DicomTag): string => {\n  if (tag.Value == null) return ''\n\n  if (Array.isArray(tag.Value)) {\n    return tag.Value.map(formatValue).join(', ')\n  }\n\n  return formatValue(tag.Value)\n}\n\n/**\n * Processes DICOM metadata and returns a flattened array of tag information\n * @param metadata - The DICOM metadata object to process\n * @param depth - The current depth level for nested sequences (default: 0)\n * @returns Array of processed tag information\n */\nexport function getRows (metadata: Record<string, any>, depth = 0): TagInfo[] {\n  if (metadata === undefined || metadata === null) return []\n  const keywords = Object.keys(metadata).filter(key => key !== '_vrMap')\n\n  return keywords.flatMap(keyword => {\n    // @ts-expect-error\n    const tagInfo = DicomMetaDictionary.nameMap[keyword] as TagInfo | undefined\n    let value = metadata[keyword]\n\n    // Handle private or unknown tags\n    if (tagInfo === undefined) {\n      const regex = /[0-9A-Fa-f]{6}/g\n      if (keyword.match(regex) == null) return []\n\n      return [{\n        tag: `(${keyword.substring(0, 4)},${keyword.substring(4, 8)})`,\n        vr: '',\n        keyword: 'Private Tag',\n        value: value?.toString() ?? '',\n        level: depth\n      }]\n    }\n\n    // Handle sequence values (SQ VR)\n    if (tagInfo.vr === 'SQ' && value !== undefined) {\n      const sequenceItems = Array.isArray(value) ? value : [value]\n\n      // Create a parent sequence node\n      const sequenceNode: TagInfo = {\n        tag: tagInfo.tag,\n        vr: tagInfo.vr,\n        keyword,\n        value: `Sequence with ${sequenceItems.length} item(s)`,\n        level: depth,\n        children: []\n      }\n\n      // Create individual nodes for each sequence item\n      sequenceNode.children = sequenceItems.map((item, index) => {\n        const itemNode: TagInfo = {\n          tag: `${tagInfo.tag}.${index + 1}`,\n          vr: 'Item',\n          keyword: `Item ${index + 1}`,\n          value: `Sequence Item ${index + 1}`,\n          level: depth + 1,\n          children: getRows(item, depth + 2)\n        }\n        return itemNode\n      })\n\n      return [sequenceNode]\n    }\n\n    // Handle array values\n    if (Array.isArray(value)) {\n      value = value.map(formatValue).join('\\\\')\n    } else if (typeof value === 'object' && value !== null) {\n      value = formatValue(value)\n    }\n\n    return [{\n      tag: tagInfo.tag,\n      vr: tagInfo.vr,\n      keyword: keyword.replace('RETIRED_', ''),\n      value: value?.toString() ?? '',\n      level: depth\n    }]\n  })\n}\n\n/**\n * Sorts DICOM tags alphabetically by tag value\n * @param metadata - The DICOM metadata object to process\n * @returns Sorted array of tag information\n */\nexport function getSortedTags (metadata: Record<string, any>): TagInfo[] {\n  const tagList = getRows(metadata)\n  return tagList.sort((a, b) => a.tag.localeCompare(b.tag))\n}\n","/**\n * Formats a DICOM datetime string (YYYYMMDD:HHmmss) into a human-readable format\n *\n * @param dateStr - DICOM datetime string in format \"YYYYMMDD:HHmmss\"\n * @returns Formatted date string (e.g., \"Mon, Jan 1 2024\")\n * @example\n * formatDicomDate(\"20240101:120000\") // Returns \"Mon, Jan 1 2024\"\n * formatDicomDate(\"invalid\") // Returns \"invalid\"\n */\nexport const formatDicomDate = (dateStr: string): string => {\n  // Parse YYYYMMDD:HHmmss format\n  const match = dateStr.match(/^(\\d{4})(\\d{2})(\\d{2}):(\\d{2})(\\d{2})(\\d{2})/)\n  if (match == null) return dateStr\n\n  const [, year, month, day, hour, minute, second] = match\n\n  // Validate month and day\n  const monthNum = parseInt(month)\n  const dayNum = parseInt(day)\n  if (monthNum < 1 || monthNum > 12 || dayNum < 1 || dayNum > 31) {\n    return dateStr\n  }\n\n  const date = new Date(\n    parseInt(year),\n    monthNum - 1, // months are 0-based\n    dayNum,\n    parseInt(hour),\n    parseInt(minute),\n    parseInt(second)\n  )\n\n  // Check if the date is invalid or if the month/day combination is invalid\n  // This catches cases like February 31st where the date rolls over to March\n  if (\n    date.getMonth() !== monthNum - 1 || // month rolled over\n    date.getDate() !== dayNum // day rolled over\n  ) {\n    return dateStr\n  }\n\n  // Format parts separately to avoid the extra comma\n  const weekday = date.toLocaleDateString('en-US', { weekday: 'short' })\n  const monthName = date.toLocaleDateString('en-US', { month: 'short' })\n  const dayFormatted = date.getDate()\n  const yearNum = date.getFullYear()\n\n  return `${weekday}, ${monthName} ${dayFormatted} ${yearNum}`\n}\n","import { v4 as generateUUID } from 'uuid'\n\n/**\n * Consumer must implement:\n * this.listeners = {}\n * this.EVENTS = { \"EVENT_KEY\": \"EVENT_VALUE\" }\n */\nconst pubSubInterface = {\n  subscribe,\n  _broadcastEvent,\n  _unsubscribe,\n  _isValidEvent\n}\n\nexport default pubSubInterface\n\n/**\n * Subscribe to updates.\n *\n * @param {string} eventName The name of the event\n * @param {Function} callback Events callback\n * @return {Object} Observable object with actions\n */\nfunction subscribe (this: PubSubService, eventName: string, callback: Function): { unsubscribe: () => any } {\n  if (this._isValidEvent(eventName)) {\n    const listenerId = generateUUID()\n    const subscription = { id: listenerId, callback }\n\n    // console.info(`Subscribing to '${eventName}'.`);\n    if (Array.isArray(this.listeners[eventName])) {\n      this.listeners[eventName].push(subscription)\n    } else {\n      this.listeners[eventName] = [subscription]\n    }\n\n    return {\n      unsubscribe: () => this._unsubscribe(eventName, listenerId)\n    }\n  } else {\n    throw new Error(`Event ${eventName} not supported.`)\n  }\n}\n\n/**\n * Unsubscribe to measurement updates.\n *\n * @param {string} eventName The name of the event\n * @param {string} listenerId The listeners id\n * @return void\n */\nfunction _unsubscribe (this: PubSubService, eventName: string, listenerId: string): void {\n  if (this.listeners[eventName] === undefined) {\n    return\n  }\n\n  const listeners = this.listeners[eventName]\n  if (Array.isArray(listeners)) {\n    this.listeners[eventName] = listeners.filter(({ id }) => id !== listenerId)\n  } else {\n    this.listeners[eventName] = []\n  }\n}\n\n/**\n * Check if a given event is valid.\n *\n * @param {string} eventName The name of the event\n * @return {boolean} Event name validation\n */\nfunction _isValidEvent (this: PubSubService, eventName: string): boolean {\n  return Object.values(this.EVENTS).includes(eventName)\n}\n\n/**\n * Broadcasts changes.\n *\n * @param {string} eventName - The event name\n * @param {func} callbackProps - Properties to pass callback\n * @return void\n */\nfunction _broadcastEvent (this: PubSubService, eventName: string, callbackProps: any): void {\n  const hasListeners = Object.keys(this.listeners).length > 0\n  const hasCallbacks = Array.isArray(this.listeners[eventName])\n\n  if (hasListeners && hasCallbacks) {\n    this.listeners[eventName].forEach((listener: { id: string, callback: Function }) => {\n      listener.callback(callbackProps)\n    })\n  }\n}\n\n/** Export a PubSubService class to be used instead of the individual items */\nexport class PubSubService {\n  EVENTS: any\n  subscribe: (\n    eventName: string,\n    callback: Function\n  ) => { unsubscribe: () => any }\n\n  _broadcastEvent: (eventName: string, callbackProps: any) => void\n  _unsubscribe: (eventName: string, listenerId: string) => void\n  _isValidEvent: (eventName: string) => boolean\n  listeners: { [key: string]: Array<{ id: string, callback: Function }> }\n  unsubscriptions: any[]\n  constructor (EVENTS: Record<string, string>) {\n    this.EVENTS = EVENTS\n    this.subscribe = subscribe\n    this._broadcastEvent = _broadcastEvent\n    this._unsubscribe = _unsubscribe\n    this._isValidEvent = _isValidEvent\n    this.listeners = {}\n    this.unsubscriptions = []\n  }\n\n  reset (): void {\n    this.unsubscriptions.forEach((unsub) => unsub())\n    this.unsubscriptions = []\n  }\n\n  /**\n   * Creates an event that records whether or not someone\n   * has consumed it.  Call eventData.consume() to consume the event.\n   * Check eventData.isConsumed to see if it is consumed or not.\n   * @param props - to include in the event\n   */\n  protected createConsumableEvent (props: Record<string, any>): Record<string, any> {\n    return {\n      ...props,\n      isConsumed: false,\n      consume: function Consume () {\n        this.isConsumed = true\n      }\n    }\n  }\n}\n","import { Instance, Series } from '../services/DICOMMetadataStore'\n\nfunction createSeriesMetadata (SeriesInstanceUID: string, defaultInstances?: Instance[]): Series {\n  const instances: Instance[] = []\n  const instancesMap = new Map<string, Instance>()\n\n  return {\n    SeriesInstanceUID,\n    Modality: '',\n    SeriesNumber: 0,\n    SeriesDescription: '',\n    SeriesDate: '',\n    SeriesTime: '',\n    ...defaultInstances?.[0],\n    instances,\n    addInstance: function (newInstance: Instance) {\n      this.addInstances([newInstance])\n    },\n    addInstances: function (newInstances: Instance[]) {\n      for (let i = 0, len = newInstances.length; i < len; i++) {\n        const instance = newInstances[i]\n\n        if (!instancesMap.has(instance.SOPInstanceUID)) {\n          instancesMap.set(instance.SOPInstanceUID, instance)\n          instances.push(instance)\n        }\n      }\n    },\n    getInstance: function (SOPInstanceUID: string) {\n      return instancesMap.get(SOPInstanceUID)\n    }\n  }\n}\n\nexport default createSeriesMetadata\n","import createSeriesMetadata from './createSeriesMetadata'\n\nimport { Study, Series, Instance } from '../services/DICOMMetadataStore'\n\nfunction createStudyMetadata (StudyInstanceUID: string): Study {\n  return {\n    StudyInstanceUID,\n    StudyDescription: '',\n    PatientID: '',\n    PatientName: '',\n    StudyDate: '',\n    AccessionNumber: '',\n    NumInstances: 0,\n    ModalitiesInStudy: [],\n    isLoaded: false,\n    series: [] as Series[],\n    /**\n     * @param {object} instance\n     */\n    addInstanceToSeries: function (instance: Instance) {\n      this.addInstancesToSeries([instance])\n    },\n    /**\n     * @param {object[]} instances\n     * @param {string} instances[].SeriesInstanceUID\n     * @param {string} instances[].StudyDescription\n     */\n    addInstancesToSeries: function (instances: Instance[]) {\n      const { SeriesInstanceUID } = instances[0]\n\n      if (this.StudyDescription !== '' && this.StudyDescription !== undefined) {\n        this.StudyDescription = instances[0].StudyDescription\n      }\n\n      let series = this.series.find(\n        (s) => s.SeriesInstanceUID === SeriesInstanceUID\n      )\n\n      if (series == null) {\n        series = createSeriesMetadata(SeriesInstanceUID, instances)\n        this.series.push(series)\n      }\n\n      series.addInstances(instances)\n    },\n\n    setSeriesMetadata: function (\n      SeriesInstanceUID: string,\n      seriesMetadata: any\n    ) {\n      let existingSeries = this.series.find(\n        (s) => s.SeriesInstanceUID === SeriesInstanceUID\n      )\n\n      if (existingSeries != null) {\n        existingSeries = Object.assign(existingSeries, seriesMetadata)\n      } else {\n        const series = createSeriesMetadata(SeriesInstanceUID)\n        this.series.push(Object.assign(series, seriesMetadata))\n      }\n    }\n  }\n}\n\nexport default createStudyMetadata\n","import dcmjs from 'dcmjs'\n\nimport pubSubServiceInterface from '../utils/pubSubServiceInterface'\nimport createStudyMetadata from '../utils/createStudyMetadata'\n\nexport const EVENTS = {\n  STUDY_ADDED: 'event::dicomMetadataStore:studyAdded',\n  INSTANCES_ADDED: 'event::dicomMetadataStore:instancesAdded',\n  SERIES_ADDED: 'event::dicomMetadataStore:seriesAdded',\n  SERIES_UPDATED: 'event::dicomMetadataStore:seriesUpdated'\n}\n\nexport interface Instance {\n  SOPInstanceUID: string\n  SOPClassUID: string\n  Rows: number\n  Columns: number\n  PatientSex: string\n  Modality: string\n  InstanceNumber: string\n  imageId?: string\n  [key: string]: any // For dynamic metadata properties\n}\n\nexport interface Series {\n  Modality: string\n  SeriesInstanceUID: string\n  SeriesNumber: number\n  SeriesDate: string\n  SeriesTime: string\n  SeriesDescription: string\n  instances: Instance[]\n  addInstance: (newInstance: Instance) => void\n  addInstances: (newInstances: Instance[]) => void\n  getInstance: (SOPInstanceUID: string) => Instance | undefined\n}\n\nexport interface Study {\n  StudyInstanceUID: string\n  StudyDescription: string\n  PatientID: string\n  PatientName: string\n  StudyDate: string\n  AccessionNumber: string\n  NumInstances: number\n  ModalitiesInStudy: any[]\n  NumberOfStudyRelatedSeries?: number\n  isLoaded: boolean\n  series: Series[]\n  addInstanceToSeries: (instance: Instance) => void\n  addInstancesToSeries: (instances: Instance[]) => void\n  setSeriesMetadata: (SeriesInstanceUID: string, metadata: any) => void\n}\n\ninterface Model {\n  studies: Study[]\n}\n\nconst _model: Model = {\n  studies: []\n}\n\nfunction _getStudyInstanceUIDs (): string[] {\n  return _model.studies.map((aStudy) => aStudy.StudyInstanceUID)\n}\n\nfunction _getStudy (StudyInstanceUID: string): Study | undefined {\n  return _model.studies.find(\n    (aStudy) => aStudy.StudyInstanceUID === StudyInstanceUID\n  )\n}\n\nfunction _getSeries (StudyInstanceUID: string, SeriesInstanceUID: string): Series | undefined {\n  const study = _getStudy(StudyInstanceUID)\n\n  if (study == null) {\n    return\n  }\n\n  return study.series.find(\n    (aSeries) => aSeries.SeriesInstanceUID === SeriesInstanceUID\n  )\n}\n\nfunction _getInstance (\n  StudyInstanceUID: string,\n  SeriesInstanceUID: string,\n  SOPInstanceUID: string\n): Instance | undefined {\n  const series = _getSeries(StudyInstanceUID, SeriesInstanceUID)\n\n  if (series == null) {\n    return\n  }\n\n  return series.getInstance(SOPInstanceUID)\n}\n\nfunction _getInstanceByImageId (imageId: string): Instance | undefined {\n  for (const study of _model.studies) {\n    for (const series of study.series) {\n      for (const instance of series.instances) {\n        if (instance.imageId === imageId) {\n          return instance\n        }\n      }\n    }\n  }\n}\n\n/**\n * Update the metadata of a specific series\n * @param {*} StudyInstanceUID\n * @param {*} SeriesInstanceUID\n * @param {*} metadata metadata inform of key value pairs\n * @returns\n */\nfunction _updateMetadataForSeries (\n  StudyInstanceUID: string,\n  SeriesInstanceUID: string,\n  metadata: Record<string, any>\n): void {\n  const study = _getStudy(StudyInstanceUID)\n\n  if (study == null) {\n    return\n  }\n\n  const series = study.series.find(\n    (aSeries) => aSeries.SeriesInstanceUID === SeriesInstanceUID\n  )\n\n  if (series == null) {\n    return\n  }\n\n  const { instances } = series\n  instances.forEach((instance) => {\n    Object.keys(metadata).forEach((key) => {\n      if (typeof metadata[key] === 'object') {\n        instance[key] = { ...instance[key], ...metadata[key] }\n      } else {\n        instance[key] = metadata[key]\n      }\n    })\n  })\n}\n\ninterface BaseImplementationType {\n  EVENTS: typeof EVENTS\n  listeners: Record<string, any>\n  addInstance: (dicomJSONDatasetOrP10ArrayBuffer: ArrayBuffer | Record<string, any>) => void\n  addInstances: (instances: Instance[], madeInClient?: boolean) => void\n  updateSeriesMetadata: (seriesMetadata: Record<string, any>) => void\n  addSeriesMetadata: (seriesSummaryMetadata: Array<Record<string, any>>, madeInClient?: boolean) => void\n  addStudy: (study: Record<string, any>) => void\n  getStudyInstanceUIDs: typeof _getStudyInstanceUIDs\n  getStudy: typeof _getStudy\n  getSeries: typeof _getSeries\n  getInstance: typeof _getInstance\n  getInstanceByImageId: typeof _getInstanceByImageId\n  updateMetadataForSeries: typeof _updateMetadataForSeries\n  _broadcastEvent: (eventName: string, data: any) => void\n}\n\nconst BaseImplementation: BaseImplementationType = {\n  EVENTS,\n  listeners: {},\n  addInstance (dicomJSONDatasetOrP10ArrayBuffer) {\n    let dicomJSONDataset\n\n    // If Arraybuffer, parse to DICOMJSON before naturalizing.\n    if (dicomJSONDatasetOrP10ArrayBuffer instanceof ArrayBuffer) {\n      const dicomData = dcmjs.data.DicomMessage.readFile(\n        dicomJSONDatasetOrP10ArrayBuffer\n      )\n\n      dicomJSONDataset = dicomData.dict\n    } else {\n      dicomJSONDataset = dicomJSONDatasetOrP10ArrayBuffer\n    }\n\n    let naturalizedDataset: Instance\n\n    if (!('SeriesInstanceUID' in dicomJSONDataset)) {\n      naturalizedDataset =\n        dcmjs.data.DicomMetaDictionary.naturalizeDataset(dicomJSONDataset) as Instance\n    } else {\n      naturalizedDataset = dicomJSONDataset as unknown as Instance\n    }\n\n    const { StudyInstanceUID } = naturalizedDataset\n\n    let study = _model.studies.find(\n      (study) => study.StudyInstanceUID === StudyInstanceUID\n    )\n\n    if (study == null) {\n      _model.studies.push(createStudyMetadata(StudyInstanceUID))\n      study = _model.studies[_model.studies.length - 1]\n    }\n\n    study.addInstanceToSeries(naturalizedDataset)\n  },\n  addInstances (instances, madeInClient = false) {\n    const { StudyInstanceUID, SeriesInstanceUID } = instances[0]\n\n    let study = _model.studies.find(\n      (study) => study.StudyInstanceUID === StudyInstanceUID\n    )\n\n    if (study == null) {\n      _model.studies.push(createStudyMetadata(StudyInstanceUID))\n      study = _model.studies[_model.studies.length - 1]\n    }\n\n    study.addInstancesToSeries(instances)\n\n    // Broadcast an event even if we used cached data.\n    // This is because the mode needs to listen to instances that are added to build up its active displaySets.\n    // It will see there are cached displaySets and end early if this Series has already been fired in this\n    // Mode session for some reason.\n    this._broadcastEvent(EVENTS.INSTANCES_ADDED, {\n      StudyInstanceUID,\n      SeriesInstanceUID,\n      madeInClient\n    })\n  },\n  updateSeriesMetadata (seriesMetadata) {\n    const { StudyInstanceUID, SeriesInstanceUID } = seriesMetadata\n    const series = _getSeries(StudyInstanceUID, SeriesInstanceUID)\n    if (series == null) {\n      return\n    }\n\n    const study = _getStudy(StudyInstanceUID)\n    if (study != null) {\n      study.setSeriesMetadata(SeriesInstanceUID, seriesMetadata)\n    }\n  },\n  addSeriesMetadata (seriesSummaryMetadata, madeInClient = false) {\n    if (\n      seriesSummaryMetadata === undefined ||\n      seriesSummaryMetadata.length === 0 ||\n      seriesSummaryMetadata[0] === undefined\n    ) {\n      return\n    }\n\n    const { StudyInstanceUID } = seriesSummaryMetadata[0]\n    let study = _getStudy(StudyInstanceUID)\n    if (study == null) {\n      study = createStudyMetadata(StudyInstanceUID)\n      // Will typically be undefined with a compliant DICOMweb server, reset later\n      study.StudyDescription = seriesSummaryMetadata[0].StudyDescription\n      seriesSummaryMetadata?.forEach((item) => {\n        if (study !== undefined && !study.ModalitiesInStudy?.includes(item.Modality)) {\n          study.ModalitiesInStudy?.push(item.Modality)\n        }\n      })\n      study.NumberOfStudyRelatedSeries = seriesSummaryMetadata.length\n      _model.studies.push(study)\n    }\n\n    seriesSummaryMetadata.forEach((series) => {\n      const { SeriesInstanceUID } = series\n      study?.setSeriesMetadata(SeriesInstanceUID, series)\n    })\n\n    this._broadcastEvent(EVENTS.SERIES_ADDED, {\n      StudyInstanceUID,\n      seriesSummaryMetadata,\n      madeInClient\n    })\n  },\n  addStudy (study) {\n    const { StudyInstanceUID } = study\n\n    const existingStudy = _model.studies.find(\n      (study) => study.StudyInstanceUID === StudyInstanceUID\n    )\n\n    if (existingStudy == null) {\n      const newStudy = createStudyMetadata(StudyInstanceUID)\n\n      newStudy.PatientID = study.PatientID\n      newStudy.PatientName = study.PatientName\n      newStudy.StudyDate = study.StudyDate\n      newStudy.ModalitiesInStudy = study.ModalitiesInStudy\n      newStudy.StudyDescription = study.StudyDescription\n      newStudy.AccessionNumber = study.AccessionNumber\n      newStudy.NumInstances = study.NumInstances // todo: Correct naming?\n\n      _model.studies.push(newStudy)\n    }\n  },\n  getStudyInstanceUIDs: _getStudyInstanceUIDs,\n  getStudy: _getStudy,\n  getSeries: _getSeries,\n  getInstance: _getInstance,\n  getInstanceByImageId: _getInstanceByImageId,\n  updateMetadataForSeries: _updateMetadataForSeries,\n  _broadcastEvent (eventName: string, data: any): void {\n  }\n}\n\ninterface DicomMetadataStoreType extends BaseImplementationType {\n  subscribe: (event: string, callback: (data: any) => void) => { unsubscribe: () => any }\n  unsubscribe: (event: string, callback: (data: any) => void) => void\n}\n\nconst DicomMetadataStore = Object.assign(\n  {},\n  BaseImplementation,\n  pubSubServiceInterface\n) as unknown as DicomMetadataStoreType\n\nexport { DicomMetadataStore }\nexport default DicomMetadataStore\n","import { useState, useEffect } from 'react'\n\n/**\n * A hook that delays updating a value for the specified time\n * @param value The value to debounce\n * @param delay The delay time in milliseconds\n * @returns The debounced value\n * @example\n * const debouncedSearchTerm = useDebounce(searchTerm, 300)\n */\nexport const useDebounce = <T,>(value: T, delay: number): T => {\n  const [debouncedValue, setDebouncedValue] = useState<T>(value)\n\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setDebouncedValue(value)\n    }, delay)\n\n    return () => {\n      clearTimeout(timer)\n    }\n  }, [value, delay])\n\n  return debouncedValue\n}\n","import { useState, useMemo, useEffect } from 'react'\nimport { Select, Input, Slider, Typography, Table } from 'antd'\nimport { SearchOutlined } from '@ant-design/icons'\n\nimport DicomWebManager from '../../DicomWebManager'\nimport './DicomTagBrowser.css'\nimport { useSlides } from '../../hooks/useSlides'\nimport { getSortedTags } from './dicomTagUtils'\nimport { formatDicomDate } from '../../utils/formatDicomDate'\nimport DicomMetadataStore, { Series, Study } from '../../services/DICOMMetadataStore'\nimport { useDebounce } from '../../hooks/useDebounce'\n\nconst { Option } = Select\n\ninterface DisplaySet {\n  displaySetInstanceUID: number\n  SeriesDate?: string\n  SeriesTime?: string\n  SeriesNumber: string\n  SeriesDescription?: string\n  Modality: string\n  images: any[]\n}\n\ninterface TableDataItem {\n  key: string\n  tag: string\n  vr: string\n  keyword: string\n  value: string\n  children?: TableDataItem[]\n}\n\ninterface DicomTagBrowserProps {\n  clients: { [key: string]: DicomWebManager }\n  studyInstanceUID: string\n}\n\nconst DicomTagBrowser = ({ clients, studyInstanceUID }: DicomTagBrowserProps): JSX.Element => {\n  const { slides, isLoading } = useSlides({ clients, studyInstanceUID })\n  const [study, setStudy] = useState<Study | undefined>(undefined)\n\n  const [displaySets, setDisplaySets] = useState<DisplaySet[]>([])\n  const [selectedDisplaySetInstanceUID, setSelectedDisplaySetInstanceUID] = useState(0)\n  const [instanceNumber, setInstanceNumber] = useState(1)\n  const [filterValue, setFilterValue] = useState('')\n  const [expandedKeys, setExpandedKeys] = useState<string[]>([])\n  const [searchInput, setSearchInput] = useState('')\n\n  const debouncedSearchValue = useDebounce(searchInput, 300)\n\n  useEffect(() => {\n    if (debouncedSearchValue === '') {\n      setFilterValue('')\n      setExpandedKeys([])\n    } else {\n      setFilterValue(debouncedSearchValue)\n    }\n  }, [debouncedSearchValue])\n\n  useEffect(() => {\n    const handler = (event: any): void => {\n      const study: Study | undefined = Object.assign({}, DicomMetadataStore.getStudy(studyInstanceUID))\n      setStudy(study)\n    }\n    const seriesAddedSubscription = DicomMetadataStore.subscribe(DicomMetadataStore.EVENTS.SERIES_ADDED, handler)\n    const instancesAddedSubscription = DicomMetadataStore.subscribe(DicomMetadataStore.EVENTS.INSTANCES_ADDED, handler)\n\n    const study = Object.assign({}, DicomMetadataStore.getStudy(studyInstanceUID))\n    setStudy(study)\n\n    return () => {\n      seriesAddedSubscription.unsubscribe()\n      instancesAddedSubscription.unsubscribe()\n    }\n  }, [studyInstanceUID])\n\n  useEffect(() => {\n    let displaySets: DisplaySet[] = []\n    let derivedDisplaySets: DisplaySet[] = []\n    const processedSeries: string[] = []\n    let index = 0\n\n    if (slides.length > 0) {\n      displaySets = slides\n        .map((slide): DisplaySet | null => {\n          const { volumeImages } = slide\n          if (volumeImages?.[0] === undefined) return null\n\n          const {\n            SeriesDate,\n            SeriesTime,\n            SeriesNumber,\n            SeriesInstanceUID,\n            SeriesDescription,\n            Modality\n          } = volumeImages[0]\n\n          processedSeries.push(SeriesInstanceUID)\n\n          const ds: DisplaySet = {\n            displaySetInstanceUID: index,\n            SeriesDate,\n            SeriesTime,\n            SeriesInstanceUID,\n            // @ts-expect-error\n            SeriesNumber,\n            SeriesDescription,\n            Modality,\n            images: volumeImages\n          }\n          index++\n          return ds\n        })\n        .filter((set): set is DisplaySet => set !== null)\n    }\n\n    if (study !== undefined && study.series?.length > 0) {\n      derivedDisplaySets = study.series.filter(s => !processedSeries.includes(s.SeriesInstanceUID))\n        .map((series: Series): DisplaySet => {\n          const ds: DisplaySet = {\n            displaySetInstanceUID: index,\n            SeriesDate: series.SeriesDate,\n            SeriesTime: series.SeriesTime,\n            // @ts-expect-error\n            SeriesNumber: series.SeriesNumber,\n            SeriesDescription: series.SeriesDescription,\n            SeriesInstanceUID: series.SeriesInstanceUID,\n            Modality: series.Modality,\n            images: series?.instances?.length > 0 ? series.instances : [series]\n          }\n          index++\n          return ds\n        })\n    }\n\n    setDisplaySets([...displaySets, ...derivedDisplaySets])\n  }, [slides, study])\n\n  const displaySetList = useMemo(() => {\n    displaySets.sort((a, b) => Number(a.SeriesNumber) - Number(b.SeriesNumber))\n    return displaySets.map((displaySet, index) => {\n      const {\n        SeriesDate = '',\n        SeriesTime = '',\n        SeriesNumber = '',\n        SeriesDescription = '',\n        Modality = ''\n      } = displaySet\n\n      const dateStr = `${SeriesDate}:${SeriesTime}`.split('.')[0]\n      const displayDate = formatDicomDate(dateStr)\n\n      return {\n        value: index,\n        label: `${SeriesNumber} (${Modality}): ${SeriesDescription}`,\n        description: displayDate\n      }\n    })\n  }, [displaySets])\n\n  const showInstanceList =\n    displaySets[selectedDisplaySetInstanceUID]?.images.length > 1\n\n  console.debug('displaySets:', displaySets)\n\n  const instanceSliderMarks = useMemo(() => {\n    if (displaySets[selectedDisplaySetInstanceUID] === undefined) return {}\n    const totalInstances = displaySets[selectedDisplaySetInstanceUID].images.length\n\n    // Create marks for first, middle, and last instances\n    const marks: Record<number, string> = {\n      1: '1', // First\n      [Math.ceil(totalInstances / 2)]: String(Math.ceil(totalInstances / 2)), // Middle\n      [totalInstances]: String(totalInstances) // Last\n    }\n\n    return marks\n  }, [selectedDisplaySetInstanceUID, displaySets])\n\n  const columns = [\n    {\n      title: 'Tag',\n      dataIndex: 'tag',\n      key: 'tag',\n      width: '30%'\n    },\n    {\n      title: 'VR',\n      dataIndex: 'vr',\n      key: 'vr',\n      width: '5%'\n    },\n    {\n      title: 'Keyword',\n      dataIndex: 'keyword',\n      key: 'keyword',\n      width: '30%'\n    },\n    {\n      title: 'Value',\n      dataIndex: 'value',\n      key: 'value',\n      width: '40%'\n    }\n  ]\n\n  const tableData = useMemo(() => {\n    const transformTagsToTableData = (tags: any[], parentKey = ''): TableDataItem[] => {\n      return tags.map((tag, index) => {\n        // Create a unique key using tag value if available, otherwise use index\n        const keyBase: string = tag.tag !== '' ? tag.tag.replace(/[(),]/g, '') : index.toString()\n        const currentKey: string = parentKey !== '' ? `${parentKey}-${keyBase}` : keyBase\n\n        const item: TableDataItem = {\n          key: currentKey,\n          tag: tag.tag,\n          vr: tag.vr,\n          keyword: tag.keyword,\n          value: tag.value\n        }\n\n        if (tag.children !== undefined && tag.children.length > 0) {\n          item.children = transformTagsToTableData(tag.children, currentKey)\n        }\n\n        return item\n      })\n    }\n\n    if (displaySets[selectedDisplaySetInstanceUID] === undefined) return []\n    const metadata = displaySets[selectedDisplaySetInstanceUID]?.images[instanceNumber - 1]\n    const tags = getSortedTags(metadata)\n    return transformTagsToTableData(tags)\n  }, [instanceNumber, selectedDisplaySetInstanceUID, displaySets])\n\n  const filteredData = useMemo(() => {\n    if (filterValue === undefined || filterValue === '') return tableData\n\n    const searchLower = filterValue.toLowerCase()\n    const matchedKeys = new Set<string>()\n\n    const nodeMatches = (node: TableDataItem): boolean => {\n      return (\n        (node.tag?.toLowerCase() ?? '').includes(searchLower) ||\n        (node.vr?.toLowerCase() ?? '').includes(searchLower) ||\n        (node.keyword?.toLowerCase() ?? '').includes(searchLower) ||\n        (node.value?.toString().toLowerCase() ?? '').includes(searchLower)\n      )\n    }\n\n    // First pass: find all matching nodes and their parent paths\n    const findMatchingPaths = (\n      node: TableDataItem,\n      parentPath: TableDataItem[] = []\n    ): TableDataItem[][] => {\n      const currentPath = [...parentPath, node]\n      let matchingPaths: TableDataItem[][] = []\n\n      if (nodeMatches(node)) {\n        matchingPaths.push(currentPath)\n      }\n\n      if (node.children != null) {\n        node.children.forEach(child => {\n          const childPaths = findMatchingPaths(child, currentPath)\n          matchingPaths = [...matchingPaths, ...childPaths]\n        })\n      }\n\n      return matchingPaths\n    }\n\n    // Find all paths that contain matches\n    const matchingPaths = tableData.flatMap(node => findMatchingPaths(node))\n\n    // Second pass: reconstruct the tree with matching paths\n    const reconstructTree = (\n      paths: TableDataItem[][],\n      level = 0\n    ): TableDataItem[] => {\n      if (paths.length === 0 || level >= paths[0].length) return []\n\n      const nodesAtLevel = new Map<string, {\n        node: TableDataItem\n        childPaths: TableDataItem[][]\n      }>()\n\n      paths.forEach(path => {\n        if (level < path.length) {\n          const node = path[level]\n          if (!nodesAtLevel.has(node.key)) {\n            nodesAtLevel.set(node.key, {\n              node: { ...node },\n              childPaths: []\n            })\n          }\n          if (level + 1 < path.length) {\n            nodesAtLevel.get(node.key)?.childPaths.push(path)\n          }\n        }\n      })\n\n      return Array.from(nodesAtLevel.values()).map(({ node, childPaths }) => {\n        matchedKeys.add(node.key)\n        const children = reconstructTree(childPaths, level + 1)\n        return children.length > 0 ? { ...node, children } : node\n      })\n    }\n\n    const filtered = reconstructTree(matchingPaths)\n    setExpandedKeys(Array.from(matchedKeys))\n\n    return filtered\n  }, [tableData, filterValue])\n\n  if (isLoading) {\n    return <div>Loading...</div>\n  }\n\n  return (\n    <div className='dicom-tag-browser'>\n      <div\n        style={{\n          width: '100%',\n          padding: '16px 20px 20px'\n        }}\n      >\n        <div style={{ display: 'flex', gap: '24px', marginBottom: '32px' }}>\n          <div style={{ flex: 1 }}>\n            <Typography.Text strong style={{ display: 'block', marginBottom: '8px' }}>Slides</Typography.Text>\n            <Select\n              style={{ width: '100%' }}\n              value={selectedDisplaySetInstanceUID}\n              onChange={(value) => {\n                setSelectedDisplaySetInstanceUID(value)\n                setInstanceNumber(1)\n              }}\n              optionLabelProp='label'\n              optionFilterProp='label'\n            >\n              {displaySetList.map((item) => (\n                <Option key={item.value} value={item.value} label={item.label}>\n                  <div>\n                    <div>{item.label}</div>\n                    <div\n                      style={{ fontSize: '12px', color: 'rgba(0, 0, 0, 0.45)' }}\n                    >\n                      {item.description}\n                    </div>\n                  </div>\n                </Option>\n              ))}\n            </Select>\n          </div>\n\n          {showInstanceList && (\n            <div style={{ flex: 1 }}>\n              <Typography.Text strong style={{ display: 'block', marginBottom: '8px' }}>\n                Instance Number: {instanceNumber}\n              </Typography.Text>\n              <Slider\n                min={1}\n                max={displaySets[selectedDisplaySetInstanceUID]?.images.length}\n                value={instanceNumber}\n                onChange={(value) => setInstanceNumber(value)}\n                marks={instanceSliderMarks}\n                tooltip={{\n                  formatter: (value: number | undefined) => value !== undefined ? `Instance ${value}` : ''\n                }}\n              />\n            </div>\n          )}\n        </div>\n\n        <Input\n          style={{ marginBottom: '20px' }}\n          placeholder='Search DICOM tags...'\n          prefix={<SearchOutlined />}\n          onChange={(e) => setSearchInput(e.target.value)}\n          value={searchInput}\n        />\n\n        <Table\n          columns={columns}\n          dataSource={filteredData}\n          pagination={false}\n          expandable={{\n            expandedRowKeys: expandedKeys,\n            onExpandedRowsChange: (keys) => setExpandedKeys(keys as string[])\n          }}\n          size='small'\n          scroll={{ y: 500 }}\n        />\n      </div>\n    </div>\n  )\n}\n\nexport default DicomTagBrowser\n","import React from 'react'\nimport { NavLink } from 'react-router-dom'\nimport {\n  Col,\n  Descriptions,\n  Dropdown,\n  Input,\n  Layout,\n  Modal,\n  Row,\n  Space,\n  Badge,\n  Collapse,\n  Radio,\n  Tooltip\n} from 'antd'\nimport {\n  ApiOutlined,\n  CheckOutlined,\n  InfoOutlined,\n  StopOutlined,\n  FileSearchOutlined,\n  UnorderedListOutlined,\n  UserOutlined,\n  SettingOutlined\n} from '@ant-design/icons'\nimport { detect } from 'detect-browser'\n\nimport Button from './Button'\nimport { RouteComponentProps, withRouter } from '../utils/router'\nimport NotificationMiddleware, { NotificationMiddlewareEvents } from '../services/NotificationMiddleware'\nimport { CustomError } from '../utils/CustomError'\nimport { v4 as uuidv4 } from 'uuid'\nimport DicomTagBrowser from './DicomTagBrowser/DicomTagBrowser'\nimport DicomWebManager from '../DicomWebManager'\n\ninterface HeaderProps extends RouteComponentProps {\n  app: {\n    name: string\n    version: string\n    homepage: string\n    uid: string\n    organization?: string\n  }\n  user?: {\n    name: string\n    email: string\n  }\n  clients?: { [key: string]: DicomWebManager }\n  defaultClients?: { [key: string]: DicomWebManager }\n  showWorklistButton: boolean\n  onServerSelection: ({ url }: { url: string }) => void\n  onUserLogout?: () => void\n  showServerSelectionButton: boolean\n}\n\ninterface ExtendedCustomError extends CustomError {\n  source: string\n}\n\ninterface HeaderState {\n  selectedServerUrl?: string\n  isServerSelectionModalVisible: boolean\n  isServerSelectionDisabled: boolean\n  errorObj: ExtendedCustomError[]\n  errorCategory: string[]\n  warnings: string[]\n  serverSelectionMode: 'default' | 'custom'\n}\n\n/**\n * React component for the application header.\n */\nclass Header extends React.Component<HeaderProps, HeaderState> {\n  constructor (props: HeaderProps) {\n    super(props)\n    const cachedServerUrl = window.localStorage.getItem('slim_selected_server')\n    const cachedMode = window.localStorage.getItem('slim_server_selection_mode') as 'default' | 'custom' | null\n\n    this.state = {\n      errorObj: [],\n      errorCategory: [],\n      warnings: [],\n      selectedServerUrl: cachedServerUrl ?? '',\n      isServerSelectionModalVisible: false,\n      isServerSelectionDisabled: !this.isValidServerUrl(cachedServerUrl),\n      serverSelectionMode: cachedMode === 'custom' && cachedServerUrl !== null && cachedServerUrl !== '' ? 'custom' : 'default'\n    }\n\n    const onErrorHandler = ({ source, error }: {\n      source: string\n      error: CustomError\n    }): void => {\n      this.setState(state => ({\n        ...state,\n        errorObj: [...state.errorObj, { ...error, source }],\n        errorCategory: [...state.errorCategory, error.type]\n      }))\n    }\n\n    const onWarningHandler = (warning: string): void => {\n      this.setState(state => ({\n        ...state,\n        warnings: [...state.warnings, warning]\n      }))\n    }\n\n    NotificationMiddleware.subscribe(\n      NotificationMiddlewareEvents.OnError,\n      onErrorHandler\n    )\n\n    NotificationMiddleware.subscribe(\n      NotificationMiddlewareEvents.OnWarning,\n      onWarningHandler\n    )\n  }\n\n  componentDidUpdate (prevProps: Readonly<HeaderProps>, prevState: Readonly<HeaderState>): void {\n    if (((prevState.warnings.length > 0) || (prevState.errorObj.length > 0)) && this.props.location.pathname !== prevProps.location.pathname) {\n      this.setState({\n        isServerSelectionModalVisible: false,\n        isServerSelectionDisabled: true,\n        errorObj: [],\n        errorCategory: [],\n        warnings: []\n      })\n    }\n  }\n\n  isValidServerUrl = (url: string | null | undefined): boolean => {\n    if (url == null || url === '') {\n      return false\n    }\n    try {\n      const urlObj = new URL(url)\n      return urlObj.protocol.startsWith('http') && urlObj.pathname.length > 0\n    } catch (TypeError) {\n      return false\n    }\n  }\n\n  handleInfoButtonClick = (): void => {\n    const browser = detect()\n    const environment: {\n      browser: {\n        name?: string\n        version?: string\n      }\n      os: {\n        name?: string\n      }\n    } = {\n      browser: {},\n      os: {}\n    }\n    if (browser != null) {\n      environment.browser = {\n        name: browser.name != null ? browser.name : undefined,\n        version: browser.version != null ? browser.version : undefined\n      }\n      environment.os = {\n        name: browser.os != null ? browser.os : undefined\n      }\n    }\n\n    Modal.info({\n      title: 'About',\n      width: 600,\n      content: (\n        <>\n          <Descriptions title='Application' column={1}>\n            <Descriptions.Item label='Name'>\n              {this.props.app.name}\n            </Descriptions.Item>\n            <Descriptions.Item label='Version'>\n              {this.props.app.version}\n            </Descriptions.Item>\n            <Descriptions.Item label='Homepage'>\n              {this.props.app.homepage}\n            </Descriptions.Item>\n          </Descriptions>\n          <Descriptions title='Browser' column={1}>\n            <Descriptions.Item label='Name'>\n              {environment.browser.name}\n            </Descriptions.Item>\n            <Descriptions.Item label='Version'>\n              {environment.browser.version}\n            </Descriptions.Item>\n          </Descriptions>\n          <Descriptions title='Operating System' column={1}>\n            <Descriptions.Item label='Name'>\n              {environment.os.name}\n            </Descriptions.Item>\n          </Descriptions>\n        </>\n      ),\n      onOk (): void {}\n    })\n  }\n\n  handleDicomTagBrowserButtonClick = (): void => {\n    const width = window.innerWidth - 200\n    Modal.info({\n      title: 'DICOM Tag Browser',\n      width,\n      content: <DicomTagBrowser\n        clients={this.props.clients ?? {}}\n        studyInstanceUID={this.props.params.studyInstanceUID ?? ''}\n               />,\n      onOk (): void {}\n    })\n  }\n\n  handleDebugButtonClick = (): void => {\n    const errorMsgs: {\n      Authentication: string[]\n      Communication: string[]\n      EncodingDecoding: string[]\n      Visualization: string[]\n    } = {\n      Authentication: [],\n      Communication: [],\n      EncodingDecoding: [],\n      Visualization: []\n    }\n\n    type ObjectKey = keyof typeof errorMsgs\n    const errorNum = this.state.errorObj.length\n\n    if (errorNum > 0) {\n      for (let i = 0; i < errorNum; i++) {\n        const category = this.state.errorCategory[i] as ObjectKey\n        errorMsgs[category].push(`${this.state.errorObj[i].message as string} (Source: ${this.state.errorObj[i].source})`)\n      }\n    }\n\n    const { Panel } = Collapse\n\n    const showErrorCount = (errcount: number): JSX.Element => (\n      <Badge count={errcount} />\n    )\n\n    const showWarningCount = (warncount: number): JSX.Element => (\n      <Badge color='green' count={warncount} />\n    )\n\n    Modal.info({\n      title: 'Debug Information\\n (Check console for more information)',\n      width: 800,\n      content: (\n        <Collapse>\n          <Panel\n            header='Communication Error'\n            key='communicationerror'\n            extra={showErrorCount(errorMsgs.Communication.length)}\n          >\n            <ol>\n              {errorMsgs.Communication.map(e => (\n                <li key={uuidv4()}>{e}</li>\n              ))}\n            </ol>\n          </Panel>\n          <Panel\n            header='Data Encoding/Decoding error'\n            key='encodedecodeerror'\n            extra={showErrorCount(errorMsgs.EncodingDecoding.length)}\n          >\n            <ol>\n              {errorMsgs.EncodingDecoding.map(e => (\n                <li key={uuidv4()}>{e}</li>\n              ))}\n            </ol>\n          </Panel>\n          <Panel\n            header='Visualization error'\n            key='visualizationerror'\n            extra={showErrorCount(errorMsgs.Visualization.length)}\n          >\n            <ol>\n              {errorMsgs.Visualization.map(e => (\n                <li key={uuidv4()}>{e}</li>\n              ))}\n            </ol>\n          </Panel>\n          <Panel\n            header='Authentication error'\n            key='autherror'\n            extra={showErrorCount(errorMsgs.Authentication.length)}\n          >\n            <ol>\n              {errorMsgs.Authentication.map(e => (\n                <li key={uuidv4()}>{e}</li>\n              ))}\n            </ol>\n          </Panel>\n          <Panel\n            header='Warning'\n            key='warning'\n            extra={showWarningCount(this.state.warnings.length)}\n          >\n            <ol>\n              {this.state.warnings.map(warning => (\n                <li key={uuidv4()}>{warning}</li>\n              ))}\n            </ol>\n          </Panel>\n        </Collapse>\n      ),\n      onOk (): void {}\n    })\n  }\n\n  handleServerSelectionButtonClick = (): void => {\n    this.setState({ isServerSelectionModalVisible: true })\n  }\n\n  handleServerSelectionInput = (\n    event: React.FormEvent<HTMLInputElement>\n  ): void => {\n    const value = event.currentTarget.value\n    this.setState({\n      selectedServerUrl: value,\n      isServerSelectionDisabled: !this.isValidServerUrl(value)\n    })\n  }\n\n  handleServerSelectionCancellation = (): void => {\n    const cachedServerUrl = window.localStorage.getItem('slim_selected_server')\n    this.setState({\n      serverSelectionMode: cachedServerUrl !== null && cachedServerUrl !== '' ? 'custom' : 'default',\n      selectedServerUrl: cachedServerUrl ?? undefined,\n      isServerSelectionModalVisible: false,\n      isServerSelectionDisabled: !this.isValidServerUrl(cachedServerUrl)\n    })\n  }\n\n  handleServerSelectionModeChange = (e: any): void => {\n    const mode = e.target.value\n    this.setState({ serverSelectionMode: mode })\n  }\n\n  handleServerSelection = (): void => {\n    window.localStorage.setItem('slim_server_selection_mode', this.state.serverSelectionMode)\n\n    if (this.state.serverSelectionMode === 'default') {\n      this.props.onServerSelection({ url: '' })\n      this.setState({\n        isServerSelectionModalVisible: false,\n        isServerSelectionDisabled: false\n      })\n      return\n    }\n\n    const url = this.state.selectedServerUrl\n    let closeModal = false\n    if (url != null && url !== '') {\n      if (url.startsWith('http://') || url.startsWith('https://')) {\n        this.props.onServerSelection({ url })\n        closeModal = true\n      }\n    }\n    this.setState({\n      isServerSelectionModalVisible: !closeModal,\n      isServerSelectionDisabled: !closeModal\n    })\n  }\n\n  render (): React.ReactNode {\n    let user = null\n    if (this.props.user !== undefined) {\n      const userMenuItems = []\n      if (this.props.onUserLogout !== undefined) {\n        userMenuItems.push(\n          {\n            label: 'Logout',\n            key: 'user-logout',\n            onClick: () => {\n              if (this.props.onUserLogout !== undefined) {\n                this.props.onUserLogout()\n              }\n            }\n          }\n        )\n      }\n      const userMenu = { items: userMenuItems }\n      user = (\n        <Dropdown menu={userMenu} trigger={['click']}>\n          <Button\n            icon={UserOutlined}\n            onClick={e => e.preventDefault()}\n            label={`${this.props.user.name} (${this.props.user.email})`}\n          />\n        </Dropdown>\n      )\n    }\n\n    let worklistButton\n    if (this.props.showWorklistButton) {\n      worklistButton = (\n        <NavLink to='/'>\n          <Button icon={UnorderedListOutlined} tooltip='Go to worklist' />\n        </NavLink>\n      )\n    }\n\n    const infoButton = (\n      <Button\n        icon={InfoOutlined}\n        tooltip='Get app info'\n        onClick={this.handleInfoButtonClick}\n      />\n    )\n\n    const debugButton = (\n      <Badge count={this.state.errorObj.length} style={{ zIndex: 1000 }}>\n        <Badge color='green' count={this.state.warnings.length} style={{ zIndex: 1001 }}>\n          <Button\n            icon={SettingOutlined}\n            tooltip='Debug info'\n            onClick={this.handleDebugButtonClick}\n          />\n        </Badge>\n      </Badge>\n    )\n\n    const showDicomTagBrowser = this.props.location.pathname.includes('/studies/')\n\n    const dicomTagBrowserButton = showDicomTagBrowser\n      ? (\n        <Button\n          icon={FileSearchOutlined}\n          tooltip='Dicom Tag Browser'\n          onClick={this.handleDicomTagBrowserButtonClick}\n        />\n        )\n      : null\n\n    let serverSelectionButton\n    if (this.props.showServerSelectionButton) {\n      serverSelectionButton = (\n        <Button\n          icon={ApiOutlined}\n          tooltip='Select server'\n          onClick={this.handleServerSelectionButtonClick}\n        />\n      )\n    }\n\n    const logoUrl = process.env.PUBLIC_URL + '/logo.svg'\n\n    const selectedServerUrl = this.state.serverSelectionMode === 'custom'\n      ? this.state.selectedServerUrl\n      : this.props.clients?.default?.baseURL ?? this.props.defaultClients?.default?.baseURL\n\n    const urlInfo = selectedServerUrl != null && selectedServerUrl !== ''\n      ? (\n        <Tooltip title={selectedServerUrl}>\n          <div\n            style={{\n              overflow: 'hidden',\n              textOverflow: 'ellipsis',\n              whiteSpace: 'nowrap',\n              paddingRight: '20px',\n              paddingLeft: '20px'\n            }}\n            title={selectedServerUrl}\n          >\n            {selectedServerUrl}\n          </div>\n        </Tooltip>\n        )\n      : null\n\n    return (\n      <>\n        <Layout.Header style={{ width: '100%', padding: '0 14px' }}>\n          <Row style={{ flexWrap: 'nowrap' }}>\n            <Col style={{ flexShrink: 0 }}>\n              <Space align='center' direction='horizontal'>\n                <img\n                  src={logoUrl}\n                  alt=''\n                  style={{ height: '64px', margin: '-14px' }}\n                />\n              </Space>\n            </Col>\n            <Col flex='auto' style={{ minWidth: 0, overflow: 'hidden' }}>\n              <div style={{ width: '100%', overflow: 'hidden' }}>\n                {this.props.showServerSelectionButton ? urlInfo : ''}\n              </div>\n            </Col>\n            <Col style={{ flexShrink: 0 }}>\n              <Space direction='horizontal'>\n                {worklistButton}\n                {infoButton}\n                {debugButton}\n                {dicomTagBrowserButton}\n                {serverSelectionButton}\n                {user}\n              </Space>\n            </Col>\n          </Row>\n        </Layout.Header>\n\n        <Modal\n          open={this.state.isServerSelectionModalVisible}\n          title='Select DICOMweb server'\n          onOk={this.handleServerSelection}\n          onCancel={this.handleServerSelectionCancellation}\n        >\n          <Radio.Group\n            value={this.state.serverSelectionMode}\n            onChange={this.handleServerSelectionModeChange}\n            style={{ marginBottom: '16px' }}\n          >\n            <Radio value='default'>Use default server</Radio>\n            <Radio value='custom'>Use custom server</Radio>\n          </Radio.Group>\n\n          {this.state.serverSelectionMode === 'custom' && (\n            <Tooltip title={this.state.selectedServerUrl}>\n              <Input\n                placeholder='Enter base URL of DICOMweb Study Service'\n                value={this.state.selectedServerUrl}\n                onChange={this.handleServerSelectionInput}\n                onPressEnter={this.handleServerSelection}\n                addonAfter={\n                this.state.isServerSelectionDisabled\n                  ? <StopOutlined style={{ color: 'rgba(0,0,0,.45)' }} />\n                  : <CheckOutlined style={{ color: 'rgba(0,0,0,.45)' }} />\n                }\n              />\n            </Tooltip>\n          )}\n        </Modal>\n      </>\n    )\n  }\n}\n\nexport default withRouter(Header)\n","import React from 'react'\nimport { Result } from 'antd'\n\ninterface InfoPageProps {\n  type: string\n  title?: string\n  message?: string\n}\n\nconst InfoPage = ({ title, message }: InfoPageProps): JSX.Element => {\n  return (\n    <div style={{\n      height: '100vh',\n      display: 'flex',\n      alignItems: 'center',\n      justifyContent: 'center'\n    }}\n    >\n      <Result\n        title={title}\n        subTitle={message}\n      />\n    </div>\n  )\n}\n\nexport default InfoPage\n","import React from 'react'\nimport { Button, Input, Space, Table, TablePaginationConfig } from 'antd'\nimport { ColumnsType } from 'antd/es/table'\nimport { FilterConfirmProps } from 'antd/es/table/interface'\nimport { SearchOutlined } from '@ant-design/icons'\nimport DicomWebManager from '../DicomWebManager'\n\nimport * as dmv from 'dicom-microscopy-viewer'\n\nimport { StorageClasses } from '../data/uids'\nimport { withRouter, RouteComponentProps } from '../utils/router'\nimport { parseDate, parseName, parseSex, parseTime } from '../utils/values'\nimport { CustomError, errorTypes } from '../utils/CustomError'\nimport NotificationMiddleware, {\n  NotificationMiddlewareContext\n} from '../services/NotificationMiddleware'\n\ninterface WorklistProps extends RouteComponentProps {\n  clients: { [key: string]: DicomWebManager }\n}\n\ninterface WorklistState {\n  studies: dmv.metadata.Study[]\n  isLoading: boolean\n  numStudies: number\n  pageSize: number\n}\n\nclass Worklist extends React.Component<WorklistProps, WorklistState> {\n  private readonly defaultPageSize = 20\n\n  constructor (props: WorklistProps) {\n    super(props)\n    this.fetchData = this.fetchData.bind(this)\n    this.handleClick = this.handleClick.bind(this)\n    this.handleChange = this.handleChange.bind(this)\n    this.state = {\n      studies: [],\n      isLoading: false,\n      numStudies: 0,\n      pageSize: this.defaultPageSize\n    }\n  }\n\n  searchForStudies (): void {\n    const queryParams: { [key: string]: any } = { ModalitiesInStudy: 'SM' }\n    const searchOptions = { queryParams }\n    // TODO: retrieve remaining results\n    const client = this.props.clients[\n      StorageClasses.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE\n    ]\n    client.searchForStudies(searchOptions).then((studies) => {\n      this.setState({\n        numStudies: studies.length,\n        studies: studies.slice(0, this.state.pageSize).map(study => {\n          const { dataset } = dmv.metadata.formatMetadata(study)\n          return dataset as dmv.metadata.Study\n        })\n      })\n    })\n      .catch((error) => {\n        console.error(error)\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        NotificationMiddleware.onError(\n          NotificationMiddlewareContext.DICOMWEB,\n          new CustomError(\n            errorTypes.COMMUNICATION,\n            'An error occured. Search for studies failed.'\n          )\n        )\n      })\n  }\n\n  componentDidMount (): void {\n    this.searchForStudies()\n  }\n\n  componentDidUpdate (previousProps: WorklistProps): void {\n    if (this.props.clients !== previousProps.clients) {\n      this.searchForStudies()\n    }\n  }\n\n  handleClick (event: React.SyntheticEvent, study: dmv.metadata.Study): void {\n    this.props.navigate(`/studies/${study.StudyInstanceUID}`)\n  }\n\n  fetchData ({ offset, limit, searchCriteria }: {\n    offset: number\n    limit: number\n    searchCriteria?: { [attribute: string]: string }\n  }): void {\n    const queryParams: { [key: string]: any } = {\n      ModalitiesInStudy: 'SM',\n      offset: offset,\n      limit: limit\n    }\n    if (searchCriteria !== undefined) {\n      for (const key in searchCriteria) {\n        const value = searchCriteria[key]\n        if (key === 'PersonName') {\n          queryParams[key] = `*${value}*`\n        } else {\n          queryParams[key] = value\n        }\n      }\n      queryParams.fuzzymatching = 'true'\n    }\n    const searchOptions = { queryParams }\n    const client = this.props.clients[\n      StorageClasses.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE\n    ]\n    client.searchForStudies(searchOptions).then((studies) => {\n      this.setState({\n        studies: studies.map(study => {\n          const { dataset } = dmv.metadata.formatMetadata(study)\n          return dataset as dmv.metadata.Study\n        })\n      })\n    })\n      .catch((error) => {\n        console.error(error)\n        NotificationMiddleware.onError(\n          NotificationMiddlewareContext.DICOMWEB,\n          new CustomError(\n            errorTypes.COMMUNICATION,\n            'Request to search for studies failed.'\n          )\n        )\n      })\n  }\n\n  handleChange (\n    pagination: TablePaginationConfig,\n    filters: any\n  ): void {\n    this.setState({ isLoading: true })\n    let index = pagination.current\n    if (index === undefined) {\n      index = 1\n    }\n    let pageSize = pagination.pageSize\n    if (pageSize === undefined) {\n      pageSize = this.state.pageSize\n    }\n    const offset = pageSize * (index - 1)\n    const limit = pageSize\n    console.debug(`search for studies of page #${index}...`)\n    const searchCriteria: { [attribute: string]: string } = {}\n    for (const dataIndex in filters) {\n      if (filters[dataIndex] !== null) {\n        searchCriteria[dataIndex] = filters[dataIndex][0].toString()\n      }\n    }\n    this.fetchData({ offset, limit, searchCriteria })\n    this.setState({ isLoading: false, pageSize: pageSize })\n  }\n\n  handleSearch = (\n    selectedKeys: React.Key[],\n    confirm: (params?: FilterConfirmProps) => void,\n    dataIndex: string\n  ): void => {\n    confirm()\n  }\n\n  handleReset = (clearFilters: () => void): void => {\n    clearFilters()\n  }\n\n  render (): React.ReactNode {\n    const columns: ColumnsType<dmv.metadata.Study> = [\n      {\n        title: 'Accession Number',\n        dataIndex: 'AccessionNumber',\n        ...this.getColumnSearchProps('AccessionNumber')\n      },\n      {\n        title: 'Study ID',\n        dataIndex: 'StudyID',\n        ...this.getColumnSearchProps('StudyID')\n      },\n      {\n        title: 'Study Date',\n        dataIndex: 'StudyDate',\n        render: (value: string): string => parseDate(value)\n      },\n      {\n        title: 'Study Time',\n        dataIndex: 'StudyTime',\n        render: (value: string): string => parseTime(value)\n      },\n      {\n        title: 'Patient ID',\n        dataIndex: 'PatientID',\n        ...this.getColumnSearchProps('PatientID')\n      },\n      {\n        title: \"Patient's Name\",\n        dataIndex: 'PatientName',\n        render: (value: dmv.metadata.PersonName): string => parseName(value),\n        ...this.getColumnSearchProps('PatientName')\n      },\n      {\n        title: \"Patient's Sex\",\n        dataIndex: 'PatientSex',\n        render: (value: string): string => parseSex(value)\n      },\n      {\n        title: \"Patient's Birthdate\",\n        dataIndex: 'PatientBirthDate',\n        render: (value: string): string => parseDate(value)\n      },\n      {\n        title: \"Referring Physician's Name\",\n        dataIndex: 'ReferringPhysicianName',\n        render: (value: dmv.metadata.PersonName): string => parseName(value)\n      },\n      {\n        title: 'Modalities in Study',\n        dataIndex: 'ModalitiesInStudy',\n        render: (value: string[] | string): string => {\n          if (value === undefined) {\n            /*\n             * This should not happen, since the attribute is required.\n             * However, some origin servers don't include it.\n             */\n            return ''\n          } else {\n            return String(value)\n          }\n        }\n      }\n    ]\n\n    const pagination = {\n      defaultPageSize: this.defaultPageSize,\n      pageSize: this.state.pageSize,\n      hideOnSinglePage: true,\n      showSizeChanger: true,\n      showQuickJumper: true,\n      showTotal: (total: number, range: number[]) => {\n        return `${range[0]}-${range[1]} of ${total} studies`\n      },\n      total: this.state.numStudies\n    }\n\n    return (\n      <Table<dmv.metadata.Study>\n        style={{ cursor: 'pointer' }}\n        columns={columns}\n        rowKey={record => record.StudyInstanceUID}\n        dataSource={this.state.studies}\n        pagination={pagination}\n        onRow={(record: dmv.metadata.Study): object => {\n          return {\n            onClick: (event: React.SyntheticEvent): void => {\n              return this.handleClick(event, record)\n            }\n          }\n        }}\n        onChange={this.handleChange}\n        size='small'\n        loading={this.state.isLoading}\n      />\n    )\n  }\n\n  getColumnSearchProps = (dataIndex: string): object => ({\n    filterDropdown: ({ setSelectedKeys, selectedKeys, confirm, clearFilters }: {\n      setSelectedKeys: (selectedKeys: React.Key[]) => void\n      selectedKeys: React.Key[]\n      confirm: (params?: FilterConfirmProps) => void\n      clearFilters: () => void\n    }) => (\n      <div style={{ padding: 8 }}>\n        <Input\n          placeholder='Search'\n          value={selectedKeys[0]}\n          onChange={e => setSelectedKeys(\n            e.target.value !== undefined ? [e.target.value] : []\n          )}\n          onPressEnter={() => this.handleSearch(selectedKeys, confirm, dataIndex)}\n          style={{ width: 188, marginBottom: 8, display: 'block' }}\n        />\n        <Space>\n          <Button\n            type='primary'\n            onClick={() => this.handleSearch(selectedKeys, confirm, dataIndex)}\n            icon={<SearchOutlined />}\n            size='small'\n            style={{ width: 90 }}\n          >\n            Search\n          </Button>\n          <Button\n            onClick={() => this.handleReset(clearFilters)}\n            size='small'\n            style={{ width: 90 }}\n          >\n            Reset\n          </Button>\n        </Space>\n      </div>\n    ),\n    filterIcon: (filtered: boolean) => (\n      <SearchOutlined\n        style={{ color: filtered ? '#1890ff' : undefined }}\n      />\n    )\n  })\n}\n\nexport default withRouter(Worklist)\n","/**\n * Join a URI with a path to form a full URL.\n *\n * @param path - Path component\n * @param uri - Base URI to which the path component should be added\n */\nexport const joinUrl = (path: string, uri: string): string => {\n  let baseUri = uri\n  if (!baseUri.endsWith('/')) {\n    baseUri += '/'\n  }\n  const url = new URL(path, baseUri)\n  return url.toString()\n}\n\n/**\n * Check whether a URL contains an OAuth 2.0 authorization code.\n *\n * @param location - URL components (JavaScript location object)\n * @returns Whether the URL contains a code\n */\nexport const isAuthorizationCodeInUrl = (location: {\n  search: string\n  hash: string\n}): boolean => {\n  const searchParams = new URLSearchParams(location.search)\n  const hashParams = new URLSearchParams(location.hash.replace('#', '?'))\n\n  return Boolean(\n    searchParams.get('code') ??\n    searchParams.get('id_token') ??\n    searchParams.get('session_state') ??\n    hashParams.get('code') ??\n    hashParams.get('id_token') ??\n    hashParams.get('session_state')\n  )\n}\n","import { UserManager, User as UserData } from 'oidc-client'\n\nimport { OidcSettings } from '../AppConfig'\nimport { isAuthorizationCodeInUrl } from '../utils/url'\nimport { User, AuthManager, SignInCallback } from './'\nimport NotificationMiddleware,\n{ NotificationMiddlewareContext } from '../services/NotificationMiddleware'\nimport { CustomError, errorTypes } from '../utils/CustomError'\n\nconst createUser = (userData: UserData | null): User => {\n  let profile\n  if (userData !== null) {\n    profile = userData.profile\n  }\n\n  if (profile !== undefined) {\n    if (profile.name === undefined || profile.email === undefined) {\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.AUTH,\n        new CustomError(\n          errorTypes.AUTHENTICATION,\n          'Failed to obtain user \"name\" and \"email\".'\n        )\n      )\n    } else {\n      return {\n        name: profile.name,\n        email: profile.email\n      }\n    }\n  } else {\n    NotificationMiddleware.onError(\n      NotificationMiddlewareContext.AUTH,\n      new CustomError(\n        errorTypes.AUTHENTICATION,\n        'Failed to obtain user profile.'\n      )\n    )\n  }\n  return {\n    name: undefined,\n    email: undefined\n  }\n}\n\nexport default class OidcManager implements AuthManager {\n  private _oidc: UserManager\n\n  constructor (baseUri: string, settings: OidcSettings) {\n    let responseType = 'code'\n    if (settings.grantType !== undefined) {\n      if (settings.grantType === 'implicit') {\n        responseType = 'id_token token'\n      }\n    }\n    this._oidc = new UserManager({\n      authority: settings.authority,\n      client_id: settings.clientId,\n      redirect_uri: baseUri,\n      scope: settings.scope,\n      response_type: responseType,\n      loadUserInfo: true,\n      automaticSilentRenew: true,\n      revokeAccessTokenOnSignout: true,\n      post_logout_redirect_uri: `${baseUri}/logout`\n    })\n    if (settings.endSessionEndpoint != null) {\n      /*\n       * Unfortunately, the end session endpoint alone cannot be provided to\n       * the construction of UserManager and the other metadata parameters\n       * would need to be provided as well. However, configuring all of them\n       * individually would not be desirable and they will be automatically\n       * determined anyways. Therefore, we first construct an object, get the\n       * metadata, update the metadata, and then reconstruct an object with the\n       * updated metadata.\n       */\n      this._oidc.metadataService.getMetadata().then(metadata => {\n        if (settings.endSessionEndpoint != null) {\n          metadata.end_session_endpoint = settings.endSessionEndpoint\n          this._oidc = new UserManager({\n            authority: settings.authority,\n            client_id: settings.clientId,\n            redirect_uri: baseUri,\n            scope: settings.scope,\n            response_type: responseType,\n            loadUserInfo: true,\n            automaticSilentRenew: true,\n            revokeAccessTokenOnSignout: true,\n            post_logout_redirect_uri: `${baseUri}/logout`,\n            metadata\n          })\n        }\n      }).catch((error) => {\n        console.error(\n          'failed to get metadata from authorization server: ',\n          error\n        )\n      })\n    }\n  }\n\n  /**\n   * Sign-in to authenticate the user and obtain authorization.\n   */\n  signIn = async ({ onSignIn }: {\n    onSignIn?: SignInCallback\n  }): Promise<void> => {\n    const handleSignIn = (userData: UserData): void => {\n      const user = createUser(userData)\n      const authorization = `${userData.token_type} ${userData.access_token}`\n      if (onSignIn != null) {\n        console.info('handling sign-in using provided callback function')\n        onSignIn({ user: user, authorization: authorization })\n      } else {\n        console.warn('no callback function was provided to handle sign-in')\n      }\n    }\n\n    if (isAuthorizationCodeInUrl(window.location)) {\n      /* Handle the callback from the authorization server: extract the code\n       * from the callback URL, obtain user information and the access token\n       * for the DICOMweb server.\n       */\n      console.info('obtaining authorization')\n      const userData = await this._oidc.signinCallback()\n      if (userData != null) {\n        console.info('obtained user data: ', userData)\n        handleSignIn(userData)\n      }\n    } else {\n      /* Redirect to the authorization server to authenticate the user\n       * and authorize the application to obtain user information and access\n       * the DICOMweb server.\n       */\n      const userData = await this._oidc.getUser()\n      if (userData === null || userData.expired) {\n        console.info('authenticating user')\n        await this._oidc.signinRedirect()\n      } else {\n        console.info('user has already been authenticated')\n        handleSignIn(userData)\n      }\n    }\n  }\n\n  /**\n   * Sign-out to revoke authorization.\n   */\n  signOut = async (): Promise<void> => {\n    console.log('signing out user and revoking authorization')\n    return await this._oidc.signoutRedirect()\n  }\n\n  /**\n   * Get authorization. Requires prior sign-in.\n   */\n  getAuthorization = async (): Promise<string|undefined> => {\n    return await this._oidc.getUser().then((userData) => {\n      if (userData !== null) {\n        return userData.access_token\n      } else {\n        NotificationMiddleware.onError(\n          NotificationMiddlewareContext.AUTH,\n          new CustomError(\n            errorTypes.AUTHENTICATION,\n            'Failed to obtain user profile.'\n          )\n        )\n      }\n    })\n  }\n\n  /**\n   * Get user information. Requires prior sign-in.\n   */\n  getUser = async (): Promise<User> => {\n    return await this._oidc.getUser().then((userData) => {\n      if (userData === null) {\n        NotificationMiddleware.onError(\n          NotificationMiddlewareContext.AUTH,\n          new CustomError(\n            errorTypes.AUTHENTICATION,\n            'Failed to obtain user information.'\n          )\n        )\n      }\n      return createUser(userData)\n    })\n  }\n}\n","import retry from 'retry'\n\nimport {\n  RetryRequestSettings,\n  DICOMwebClientRequestHookMetadata\n} from '../AppConfig'\n\ntype RequestHook = (\n  request: XMLHttpRequest,\n  metadata: DICOMwebClientRequestHookMetadata\n) => XMLHttpRequest\n\n/**\n * Returns a configured retry request hook function\n * that can be used to add retry functionality to XHR request.\n *\n * Default options:\n *   retries: 5\n *   factor: 3\n *   minTimeout: 1 * 1000\n *   maxTimeout: 60 * 1000\n *   randomize: true\n *\n * @param options\n * @param options.retires - Number of retries\n * @param options.factor - Factor\n * @param options.minTimeout - Min number of seconds to wait before next retry\n * @param options.maxTimeout - Max number of seconds to wait before next retry\n * @param options.randomize - Whether randomization should be applied\n * @param options.retryableStatusCodes HTTP status codes that can trigger a retry\n * @returns Configured retry request function\n */\nexport const getXHRRetryHook = (options: RetryRequestSettings = {\n  retries: 5,\n  factor: 3,\n  minTimeout: 1 * 1000,\n  maxTimeout: 60 * 1000,\n  randomize: true,\n  retryableStatusCodes: [429, 500]\n}): RequestHook => {\n  const retryOptions = options\n\n  if (options.retries != null) {\n    retryOptions.retries = options.retries\n  }\n\n  if (options.factor != null) {\n    retryOptions.factor = options.factor\n  }\n\n  if (options.minTimeout != null) {\n    retryOptions.minTimeout = options.minTimeout\n  }\n\n  if (options.maxTimeout != null) {\n    retryOptions.maxTimeout = options.maxTimeout\n  }\n\n  if (options.randomize != null) {\n    retryOptions.randomize = options.randomize\n  }\n\n  if (options.retryableStatusCodes != null) {\n    retryOptions.retryableStatusCodes = options.retryableStatusCodes\n  }\n\n  /**\n   * Request hook used to add retry functionality to XHR requests.\n   *\n   * @param request - XHR request instance\n   * @param metadata - Metadata about the request\n   * @param metadata.url - URL\n   * @param metadata.method - HTTP method\n   * @returns - XHR request instance (potentially modified)\n   */\n  const xhrRetryHook = (\n    request: XMLHttpRequest,\n    metadata: DICOMwebClientRequestHookMetadata\n  ): XMLHttpRequest => {\n    const { url, method } = metadata\n\n    function faultTolerantRequestSend (...args: any): void {\n      const operation = retry.operation(retryOptions)\n\n      operation.attempt(function operationAttempt (currentAttempt) {\n        const originalOnReadyStateChange = request.onreadystatechange\n\n        /** Overriding/extending XHR function */\n        request.onreadystatechange = function onReadyStateChange (...args: any): void {\n          if (originalOnReadyStateChange != null) {\n            originalOnReadyStateChange.apply(request, args)\n          }\n\n          if (retryOptions.retryableStatusCodes.includes(request.status)) {\n            const errorMessage = `Attempt to request ${url} failed.`\n            const attemptFailedError = new Error(errorMessage)\n            operation.retry(attemptFailedError)\n          }\n        }\n\n        /** Call open only on retry (after headers and other things were set in the xhr instance) */\n        if (currentAttempt > 1) {\n          console.warn(`Requesting ${url}... (attempt: ${currentAttempt})`)\n          request.open(method, url, true)\n        }\n      })\n\n      originalRequestSend.apply(request, args)\n    }\n\n    /** Overriding/extending XHR function */\n    const originalRequestSend = request.send\n    request.send = faultTolerantRequestSend\n\n    return request\n  }\n\n  return xhrRetryHook\n}\n\nexport default getXHRRetryHook\n","import * as dwc from 'dicomweb-client'\nimport * as dcmjs from 'dcmjs'\nimport * as dmv from 'dicom-microscopy-viewer'\n\nimport { ServerSettings, DicomWebManagerErrorHandler } from './AppConfig'\nimport { joinUrl } from './utils/url'\nimport getXHRRetryHook from './utils/xhrRetryHook'\nimport { CustomError, errorTypes } from './utils/CustomError'\nimport NotificationMiddleware, {\n  NotificationMiddlewareContext\n} from './services/NotificationMiddleware'\nimport DicomMetadataStore, { Instance } from './services/DICOMMetadataStore'\n\nconst { naturalizeDataset } = dcmjs.data.DicomMetaDictionary\n\ninterface Store {\n  id: string\n  read: boolean\n  write: boolean\n  client: dwc.api.DICOMwebClient\n}\n\nexport default class DicomWebManager implements dwc.api.DICOMwebClient {\n  private readonly stores: Store[] = []\n\n  private readonly handleError: DicomWebManagerErrorHandler\n\n  constructor ({ baseUri, settings, onError }: {\n    baseUri: string\n    settings: ServerSettings[]\n    onError?: DicomWebManagerErrorHandler\n  }) {\n    if (onError != null) {\n      this.handleError = onError\n    } else {\n      this.handleError = (error, serverSettings) => {\n        console.error(error, serverSettings)\n      }\n    }\n\n    settings.forEach(serverSettings => {\n      if (serverSettings === undefined) {\n        NotificationMiddleware.onError(\n          NotificationMiddlewareContext.SLIM,\n          new CustomError(\n            errorTypes.COMMUNICATION,\n            'At least one server needs to be configured.'\n          )\n        )\n      }\n\n      let serviceUrl\n      if (serverSettings.url !== undefined) {\n        serviceUrl = serverSettings.url\n      } else if (serverSettings.path !== undefined) {\n        serviceUrl = joinUrl(serverSettings.path, baseUri)\n      } else {\n        NotificationMiddleware.onError(\n          NotificationMiddlewareContext.SLIM,\n          new CustomError(\n            errorTypes.COMMUNICATION,\n            'Either path or full URL needs to be configured for server.'\n          )\n        )\n      }\n\n      const hasHttpsUrl = (url?: string): boolean => url?.startsWith('https') ?? false\n\n      const clientSettings: dwc.api.DICOMwebClientOptions = {\n        url: serviceUrl\n      }\n\n      const shouldUpgradeInsecure = serverSettings.upgradeInsecureRequests === true && [\n        serviceUrl,\n        serverSettings.qidoPathPrefix,\n        serverSettings.wadoPathPrefix,\n        serverSettings.stowPathPrefix\n      ].some(hasHttpsUrl)\n\n      if (serverSettings.qidoPathPrefix !== undefined) {\n        clientSettings.qidoURLPrefix = serverSettings.qidoPathPrefix\n      }\n      if (serverSettings.wadoPathPrefix !== undefined) {\n        clientSettings.wadoURLPrefix = serverSettings.wadoPathPrefix\n      }\n      if (serverSettings.stowPathPrefix !== undefined) {\n        clientSettings.stowURLPrefix = serverSettings.stowPathPrefix\n      }\n\n      if (shouldUpgradeInsecure) {\n        clientSettings.headers = {\n          ...clientSettings.headers,\n          'Content-Security-Policy': 'upgrade-insecure-requests'\n        }\n      }\n\n      if (serverSettings.retry !== undefined) {\n        clientSettings.requestHooks = [getXHRRetryHook(serverSettings.retry)]\n      }\n\n      clientSettings.errorInterceptor = (error: dwc.api.DICOMwebClientError) => {\n        this.handleError(error, serverSettings)\n      }\n\n      this.stores.push({\n        id: serverSettings.id,\n        write: serverSettings.write ?? false,\n        read: serverSettings.read ?? true,\n        client: new dwc.api.DICOMwebClient(clientSettings)\n      })\n    })\n\n    if (this.stores.length > 1) {\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.COMMUNICATION,\n          'Only one store is supported for now.'\n        )\n      )\n    }\n  }\n\n  get baseURL (): string {\n    return this.stores[0].client.baseURL\n  }\n\n  updateHeaders = (fields: { [name: string]: string }): void => {\n    for (const f in fields) {\n      this.stores[0].client.headers[f] = fields[f]\n    }\n  }\n\n  get headers (): { [name: string]: string } {\n    return this.stores[0].client.headers\n  }\n\n  storeInstances = async (\n    options: dwc.api.StoreInstancesOptions\n  ): Promise<void> => {\n    if (this.stores[0].write) {\n      return await this.stores[0].client.storeInstances(options)\n    } else {\n      return await Promise.reject(\n        new Error('Store is not writable.')\n      )\n    }\n  }\n\n  searchForStudies = async (\n    options: dwc.api.SearchForStudiesOptions\n  ): Promise<dwc.api.Study[]> => {\n    return await this.stores[0].client.searchForStudies(options)\n  }\n\n  searchForSeries = async (\n    options: dwc.api.SearchForSeriesOptions\n  ): Promise<dwc.api.Series[]> => {\n    return await this.stores[0].client.searchForSeries(options)\n  }\n\n  searchForInstances = async (\n    options: dwc.api.SearchForInstancesOptions\n  ): Promise<dwc.api.Instance[]> => {\n    return await this.stores[0].client.searchForInstances(options)\n  }\n\n  retrieveStudyMetadata = async (\n    options: dwc.api.RetrieveStudyMetadataOptions\n  ): Promise<dwc.api.Metadata[]> => {\n    const studySummaryMetadata = await this.stores[0].client.retrieveStudyMetadata(options)\n    const naturalized = naturalizeDataset(studySummaryMetadata)\n    DicomMetadataStore.addStudy(naturalized)\n    return studySummaryMetadata\n  }\n\n  retrieveSeriesMetadata = async (\n    options: dwc.api.RetrieveSeriesMetadataOptions\n  ): Promise<dwc.api.Metadata[]> => {\n    const seriesSummaryMetadata = await this.stores[0].client.retrieveSeriesMetadata(options)\n    const naturalized = seriesSummaryMetadata.map(naturalizeDataset)\n    DicomMetadataStore.addSeriesMetadata(naturalized, true)\n    return seriesSummaryMetadata\n  }\n\n  retrieveInstanceMetadata = async (\n    options: dwc.api.RetrieveInstanceMetadataOptions\n  ): Promise<dwc.api.Metadata[]> => {\n    return await this.stores[0].client.retrieveInstanceMetadata(options)\n  }\n\n  retrieveInstance = async (\n    options: dwc.api.RetrieveInstanceOptions\n  ): Promise<dwc.api.Dataset> => {\n    const instance = await this.stores[0].client.retrieveInstance(options)\n    const data = dcmjs.data.DicomMessage.readFile(instance)\n    const { dataset } = dmv.metadata.formatMetadata(data.dict)\n    DicomMetadataStore.addInstances([dataset as Instance])\n    return instance\n  }\n\n  retrieveInstanceFrames = async (\n    options: dwc.api.RetrieveInstanceFramesOptions\n  ): Promise<dwc.api.Pixeldata[]> => {\n    return await this.stores[0].client.retrieveInstanceFrames(options)\n  }\n\n  retrieveInstanceRendered = async (\n    options: dwc.api.RetrieveInstanceRenderedOptions\n  ): Promise<dwc.api.Pixeldata> => {\n    return await this.stores[0].client.retrieveInstanceRendered(options)\n  }\n\n  retrieveInstanceFramesRendered = async (\n    options: dwc.api.RetrieveInstanceFramesRenderedOptions\n  ): Promise<dwc.api.Pixeldata> => {\n    return await this.stores[0].client.retrieveInstanceFramesRendered(options)\n  }\n\n  retrieveBulkData = async (\n    options: dwc.api.RetrieveBulkDataOptions\n  ): Promise<dwc.api.Bulkdata[]> => {\n    return await this.stores[0].client.retrieveBulkData(options)\n  }\n}\n","import React from 'react'\nimport {\n  BrowserRouter,\n  Navigate,\n  Route,\n  Routes,\n  useParams\n} from 'react-router-dom'\nimport { Layout, message } from 'antd'\nimport { FaSpinner } from 'react-icons/fa'\nimport * as dwc from 'dicomweb-client'\n\nimport AppConfig, { ServerSettings, ErrorMessageSettings } from './AppConfig'\nimport CaseViewer from './components/CaseViewer'\nimport Header from './components/Header'\nimport InfoPage from './components/InfoPage'\nimport Worklist from './components/Worklist'\n\nimport { User, AuthManager } from './auth'\nimport OidcManager from './auth/OidcManager'\nimport { StorageClasses } from './data/uids'\nimport DicomWebManager from './DicomWebManager'\nimport { joinUrl } from './utils/url'\nimport { CustomError, errorTypes } from './utils/CustomError'\nimport NotificationMiddleware, {\n  NotificationMiddlewareContext\n} from './services/NotificationMiddleware'\n\nfunction ParametrizedCaseViewer ({ clients, user, app, config }: {\n  clients: { [key: string]: DicomWebManager }\n  user?: User\n  app: {\n    name: string\n    version: string\n    uid: string\n    organization?: string\n  }\n  config: AppConfig\n}): JSX.Element {\n  const { studyInstanceUID } = useParams()\n\n  const enableAnnotationTools = !(config.disableAnnotationTools ?? false)\n  const preload = config.preload ?? false\n  return (\n    <CaseViewer\n      clients={clients}\n      user={user}\n      annotations={config.annotations}\n      preload={preload}\n      app={app}\n      enableAnnotationTools={enableAnnotationTools}\n      studyInstanceUID={studyInstanceUID}\n    />\n  )\n}\n\nfunction _createClientMapping ({ baseUri, gcpBaseUrl, settings, onError }: {\n  baseUri: string\n  gcpBaseUrl: string\n  settings: ServerSettings[]\n  onError: (\n    error: dwc.api.DICOMwebClientError,\n    serverSettings: ServerSettings\n  ) => void\n}): { [sopClassUID: string]: DicomWebManager } {\n  const storageClassMapping: { [key: string]: number } = { default: 0 }\n  const clientMapping: { [sopClassUID: string]: DicomWebManager } = {}\n\n  settings.forEach(serverSettings => {\n    if (serverSettings.storageClasses != null) {\n      serverSettings.storageClasses.forEach(sopClassUID => {\n        if (Object.values<string>(StorageClasses).includes(sopClassUID)) {\n          if (sopClassUID in storageClassMapping) {\n            storageClassMapping[sopClassUID] += 1\n          } else {\n            storageClassMapping[sopClassUID] = 1\n          }\n        } else {\n          console.warn(\n            `unknown storage class \"${sopClassUID}\" specified ` +\n            `for configured server \"${serverSettings.id}\"`\n          )\n        }\n      })\n    } else {\n      if (window.location.pathname.includes('/projects/')) {\n        const pathname = window.location.pathname.split('/study/')[0]\n        const pathUrl = `${gcpBaseUrl}${pathname}/dicomWeb`\n        serverSettings.url = pathUrl\n      }\n\n      storageClassMapping.default += 1\n      clientMapping.default = new DicomWebManager({\n        baseUri,\n        settings: [serverSettings],\n        onError\n      })\n    }\n  })\n\n  if (storageClassMapping.default > 1) {\n    NotificationMiddleware.onError(\n      NotificationMiddlewareContext.SLIM,\n      new CustomError(\n        errorTypes.COMMUNICATION,\n        'Only one default server can be configured without specification ' +\n        'of storage classes.'\n      )\n    )\n  }\n\n  for (const key in storageClassMapping) {\n    if (key === 'default') {\n      continue\n    }\n    if (storageClassMapping[key] > 1) {\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.COMMUNICATION,\n          'Only one configured server can specify a given storage class. ' +\n          `Storage class \"${key}\" is specified by more than one ` +\n          'of the configured servers.'\n        )\n      )\n    }\n  }\n\n  if (Object.keys(storageClassMapping).length > 1) {\n    settings.forEach(server => {\n      const client = new DicomWebManager({\n        baseUri,\n        settings: [server],\n        onError\n      })\n      if (server.storageClasses != null) {\n        server.storageClasses.forEach(sopClassUID => {\n          clientMapping[sopClassUID] = client\n        })\n      }\n    })\n  }\n\n  Object.values(StorageClasses).forEach(sopClassUID => {\n    if (!(sopClassUID in clientMapping)) {\n      clientMapping[sopClassUID] = clientMapping.default\n    }\n  })\n  return clientMapping\n}\n\ninterface AppProps {\n  name: string\n  homepage: string\n  version: string\n  config: AppConfig\n}\n\ninterface AppState {\n  clients: { [sopClassUID: string]: DicomWebManager }\n  defaultClients: { [sopClassUID: string]: DicomWebManager }\n  user?: User\n  isLoading: boolean\n  redirectTo?: string\n  wasAuthSuccessful: boolean\n  error?: ErrorMessageSettings\n}\n\nclass App extends React.Component<AppProps, AppState> {\n  private readonly auth?: AuthManager\n\n  private readonly handleDICOMwebError = (\n    error: dwc.api.DICOMwebClientError,\n    serverSettings: ServerSettings\n  ): void => {\n    if (error.status === 401) {\n      this.signIn()\n    } else if (error.status === 403) {\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.DICOMWEB,\n        new CustomError(\n          errorTypes.COMMUNICATION,\n          'User is not authorized to access DICOMweb resources.')\n      )\n    }\n\n    const logServerError = (): void => {\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.DICOMWEB,\n        new CustomError(\n          errorTypes.COMMUNICATION,\n          'An unexpected server error occured.'\n        )\n      )\n    }\n\n    if (serverSettings.errorMessages !== undefined) {\n      serverSettings.errorMessages.forEach((setting: ErrorMessageSettings) => {\n        if (error.status === setting.status) {\n          this.setState({\n            error: {\n              status: error.status,\n              message: setting.message\n            }\n          })\n        } else if (error.status === 500) {\n          logServerError()\n        }\n      })\n    } else if (error.status === 500) {\n      logServerError()\n    }\n  }\n\n  constructor (props: AppProps) {\n    super(props)\n\n    console.info('instatiate app')\n    console.info(`app is located at \"${props.config.path}\"`)\n    const { protocol, host } = window.location\n    const baseUri = `${protocol}//${host}`\n    const appUri = joinUrl(props.config.path, baseUri)\n\n    const oidcSettings = props.config.oidc\n    if (oidcSettings !== undefined) {\n      console.info(\n        'app uses the following OIDC configuration: ',\n        props.config.oidc\n      )\n      this.auth = new OidcManager(appUri, oidcSettings)\n    }\n\n    if (props.config.servers.length === 0) {\n      NotificationMiddleware.onError(\n        NotificationMiddlewareContext.SLIM,\n        new CustomError(\n          errorTypes.COMMUNICATION,\n          'One server needs to be configured.')\n      )\n    }\n    console.info(\n      'app uses the following DICOMweb server configuration: ',\n      props.config.servers\n    )\n\n    this.handleServerSelection = this.handleServerSelection.bind(this)\n\n    message.config({ duration: 5 })\n    this.addGcpSecondaryAnnotationServer(props.config)\n\n    const defaultClients = _createClientMapping({\n      baseUri,\n      gcpBaseUrl: props.config.gcpBaseUrl ?? 'https://healthcare.googleapis.com/v1',\n      settings: props.config.servers,\n      onError: this.handleDICOMwebError\n    })\n\n    this.state = {\n      clients: defaultClients,\n      defaultClients,\n      isLoading: true,\n      wasAuthSuccessful: false\n    }\n  }\n\n  addGcpSecondaryAnnotationServer (config: AppProps['config']): void {\n    const serverId = 'gcp_secondary_annotation_server'\n    const urlParams = new URLSearchParams(window.location.search)\n    const url = urlParams.get('gcp')\n    const gcpSecondaryAnnotationServer = config.servers.find(\n      (server) => server.id === serverId\n    )\n    if (gcpSecondaryAnnotationServer === undefined && typeof url === 'string') {\n      config.servers.push({\n        id: serverId,\n        write: true,\n        url,\n        storageClasses: [\n          StorageClasses.COMPREHENSIVE_SR,\n          StorageClasses.COMPREHENSIVE_3D_SR,\n          StorageClasses.SEGMENTATION,\n          StorageClasses.MICROSCOPY_BULK_SIMPLE_ANNOTATION,\n          StorageClasses.PARAMETRIC_MAP,\n          StorageClasses.ADVANCED_BLENDING_PRESENTATION_STATE,\n          StorageClasses.COLOR_SOFTCOPY_PRESENTATION_STATE,\n          StorageClasses.GRAYSCALE_SOFTCOPY_PRESENTATION_STATE,\n          StorageClasses.PSEUDOCOLOR_SOFTCOPY_PRESENTATION_STATE\n        ]\n      })\n    }\n  }\n\n  handleServerSelection ({ url }: { url: string }): void {\n    console.info('select DICOMweb server: ', url)\n    if (url === '' || window.localStorage.getItem('slim_server_selection_mode') === 'default') {\n      this.setState({ clients: this.state.defaultClients })\n      return\n    }\n    window.localStorage.setItem('slim_selected_server', url)\n    const tmpClient = new DicomWebManager({\n      baseUri: '',\n      settings: [{\n        id: 'tmp',\n        url,\n        read: true,\n        write: false\n      }],\n      onError: this.handleDICOMwebError\n    })\n    tmpClient.updateHeaders(this.state.clients.default.headers)\n    /**\n     * Use the newly created client for all storage classes. We may want to\n     * make this more sophisticated in the future to allow users to override\n     * the entire server configuration.\n     */\n    this.setState(state => {\n      const clients: { [key: string]: DicomWebManager } = {}\n      for (const key in state.clients) {\n        clients[key] = tmpClient\n      }\n      return { clients }\n    })\n  }\n\n  /**\n   * Handle successful authentication event.\n   *\n   * Authorizes the DICOMweb client to access the DICOMweb server and directs\n   * the user back to the App.\n   *\n   * @param user - Information about the user\n   * @param authorization - Value of the \"Authorization\" HTTP header field\n   */\n  handleSignIn = ({ user, authorization }: {\n    user: User\n    authorization: string\n  }): void => {\n    for (const key in this.state.clients) {\n      const client = this.state.clients[key]\n      client.updateHeaders({ Authorization: authorization })\n    }\n    const storedPath = window.localStorage.getItem('slim_path')\n    const storedSearch = window.localStorage.getItem('slim_search')\n    if (storedPath !== null && storedPath !== '') {\n      const currentPath = window.location.pathname\n      if (storedPath !== currentPath) {\n        let path = storedPath\n        if (storedSearch !== null && storedSearch !== '') {\n          path += storedSearch\n        }\n        window.location.href = path\n      }\n    }\n    window.localStorage.removeItem('slim_path')\n    window.localStorage.removeItem('slim_search')\n    this.setState({ user: user })\n  }\n\n  signIn (): void {\n    if (this.auth !== undefined) {\n      console.info('try to sign in user')\n      this.auth.signIn({ onSignIn: this.handleSignIn }).then(() => {\n        console.info('sign-in was successful')\n        this.setState({\n          isLoading: false,\n          wasAuthSuccessful: true\n        })\n      }).catch((error) => {\n        console.error(error)\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        NotificationMiddleware.onError(\n          NotificationMiddlewareContext.AUTH,\n          new CustomError(\n            errorTypes.AUTHENTICATION,\n            'Could not sign-in user.')\n        )\n        this.setState({\n          isLoading: false,\n          redirectTo: undefined,\n          wasAuthSuccessful: false\n        })\n      })\n    } else {\n      this.setState({\n        isLoading: false,\n        redirectTo: undefined,\n        wasAuthSuccessful: true\n      })\n    }\n  }\n\n  componentDidMount (): void {\n    const path = window.localStorage.getItem('slim_path')\n    if (path === null || path === '') {\n      window.localStorage.setItem('slim_path', window.location.pathname)\n      window.localStorage.setItem('slim_search', window.location.search)\n    }\n\n    // Restore cached server selection if it exists\n    const cachedServerUrl = window.localStorage.getItem('slim_selected_server')\n    if (cachedServerUrl !== null && cachedServerUrl !== '') {\n      this.handleServerSelection({ url: cachedServerUrl })\n    }\n\n    this.signIn()\n  }\n\n  render (): React.ReactNode {\n    const appInfo = {\n      name: this.props.name,\n      version: this.props.version,\n      homepage: this.props.homepage,\n      uid: '1.2.826.0.1.3680043.9.7433.1.5',\n      organization: this.props.config.organization\n    }\n\n    const enableWorklist = !(\n      this.props.config.disableWorklist ?? false\n    )\n    const enableServerSelection = (\n      this.props.config.enableServerSelection ?? false\n    )\n\n    let worklist\n    if (enableWorklist) {\n      worklist = <Worklist clients={this.state.clients} />\n    } else {\n      worklist = <div>Worklist has been disabled.</div>\n    }\n\n    let isLogoutPossible = false\n    let onLogout: () => void\n    if (\n      // eslint-disable-next-line @typescript-eslint/prefer-optional-chain\n      this.props.config.oidc != null &&\n      this.props.config.oidc.endSessionEndpoint != null\n    ) {\n      onLogout = (): void => {\n        if (this.auth != null) {\n          // eslint-disable-next-line @typescript-eslint/no-floating-promises\n          this.auth.signOut()\n        }\n      }\n      isLogoutPossible = true\n    } else {\n      onLogout = () => {}\n      isLogoutPossible = false\n    }\n\n    const layoutStyle = { height: '100vh' }\n    const layoutContentStyle = { height: '100%' }\n\n    if (this.state.redirectTo !== undefined) {\n      return (\n        <BrowserRouter basename={this.props.config.path}>\n          <Navigate to={this.state.redirectTo} replace />\n        </BrowserRouter>\n      )\n    } else if (this.state.isLoading) {\n      return (\n        <BrowserRouter basename={this.props.config.path}>\n          <Layout style={layoutStyle}>\n            <Header\n              app={appInfo}\n              user={this.state.user}\n              showWorklistButton={false}\n              onServerSelection={this.handleServerSelection}\n              showServerSelectionButton={false}\n              clients={this.state.clients}\n              defaultClients={this.state.defaultClients}\n            />\n            <Layout.Content style={layoutContentStyle}>\n              <FaSpinner />\n            </Layout.Content>\n          </Layout>\n        </BrowserRouter>\n      )\n    } else if (!this.state.wasAuthSuccessful) {\n      return (\n        <InfoPage type='error' message='Sign-in failed.' />\n      )\n    } else if (this.state.error != null) {\n      return (\n        <InfoPage type='error' message={this.state.error.message} />\n      )\n    } else {\n      return (\n        <BrowserRouter basename={this.props.config.path}>\n          <Routes>\n            <Route\n              path='/'\n              element={\n                <Layout style={layoutStyle}>\n                  <Header\n                    app={appInfo}\n                    user={this.state.user}\n                    showWorklistButton={false}\n                    onServerSelection={this.handleServerSelection}\n                    onUserLogout={isLogoutPossible ? onLogout : undefined}\n                    showServerSelectionButton={enableServerSelection}\n                    clients={this.state.clients}\n                    defaultClients={this.state.defaultClients}\n                  />\n                  <Layout.Content style={layoutContentStyle}>\n                    {worklist}\n                  </Layout.Content>\n                </Layout>\n              }\n            />\n            <Route\n              path='/studies/:studyInstanceUID/*'\n              element={\n                <Layout style={layoutStyle}>\n                  <Header\n                    app={appInfo}\n                    user={this.state.user}\n                    showWorklistButton={enableWorklist}\n                    onServerSelection={this.handleServerSelection}\n                    onUserLogout={isLogoutPossible ? onLogout : undefined}\n                    showServerSelectionButton={enableServerSelection}\n                    clients={this.state.clients}\n                    defaultClients={this.state.defaultClients}\n                  />\n                  <Layout.Content style={layoutContentStyle}>\n                    <ParametrizedCaseViewer\n                      clients={this.state.clients}\n                      user={this.state.user}\n                      config={this.props.config}\n                      app={appInfo}\n                    />\n                  </Layout.Content>\n                </Layout>\n              }\n            />\n            <Route\n              path='/projects/:project/locations/:location/datasets/:dataset/dicomStores/:dicomStore/study/:studyInstanceUID/*'\n              element={\n                <Layout style={layoutStyle}>\n                  <Header\n                    app={appInfo}\n                    user={this.state.user}\n                    showWorklistButton={enableWorklist}\n                    onServerSelection={this.handleServerSelection}\n                    onUserLogout={isLogoutPossible ? onLogout : undefined}\n                    showServerSelectionButton={enableServerSelection}\n                    clients={this.state.clients}\n                    defaultClients={this.state.defaultClients}\n                  />\n                  <Layout.Content style={layoutContentStyle}>\n                    <ParametrizedCaseViewer\n                      clients={this.state.clients}\n                      user={this.state.user}\n                      config={this.props.config}\n                      app={appInfo}\n                    />\n                  </Layout.Content>\n                </Layout>\n              }\n            />\n            <Route\n              path='/logout'\n              element={\n                <Layout style={layoutStyle}>\n                  <Header\n                    app={appInfo}\n                    user={this.state.user}\n                    showWorklistButton={false}\n                    onServerSelection={this.handleServerSelection}\n                    onUserLogout={isLogoutPossible ? onLogout : undefined}\n                    showServerSelectionButton={enableServerSelection}\n                    clients={this.state.clients}\n                    defaultClients={this.state.defaultClients}\n                  />\n                  Logged out\n                </Layout>\n              }\n            />\n          </Routes>\n        </BrowserRouter>\n      )\n    }\n  }\n}\n\nexport default App\n"],"names":["Description","layout","labelLineHeight","undefined","this","props","hasLongValues","items","attributes","map","item","index","uid","generateUUID","label","name","labelStyle","lineHeight","contentStyle","fontWeight","whiteSpace","span","value","icon","title","header","extra","size","hoverable","selectable","bordered","actions","methods","column","children","React","metadata","ClinicalTrialSponsorName","push","ClinicalTrialProtocolID","ClinicalTrialProtocolName","ClinicalTrialSiteName","ClinicalTrialTimePointID","parseName","Alphabetic","split","join","parseDate","year","substring","month","day","parseTime","hours","minutes","seconds","parseSex","F","M","O","PatientID","PatientName","PatientSex","PatientBirthDate","AccessionNumber","StudyID","StudyDate","StudyTime","StorageClasses","_subscriptions","Symbol","_lastSubscriptionId","PubSub","eventName","callback","Error","hasOwnProperty","subscriptionId","callbacks","payload","errorTypes","CustomError","type","message","stack","NotificationMiddlewareEvents","NotificationMiddlewareContext","NotificationType","NotificationSourceDefinition","sources","category","notificationType","outerContext","args","publish","Array","from","warn","console","JSON","stringify","arguments","includes","apply","prototype","slice","call","source","error","notificationMsg","errorCategory","find","s","String","notification","description","duration","state","isLoading","overviewViewportRef","overviewViewer","setState","slide","overviewImages","length","current","innerHTML","info","ContainerIdentifier","dmv","client","clients","VL_WHOLE_SLIDE_MICROSCOPY_IMAGE","disableInteractions","resizeFactor","errorInterceptor","NotificationMiddleware","render","container","resize","style","height","containerIdentifier","ref","textAlign","display","alignItems","justifyContent","fontSize","color","letterSpacing","seriesInstanceUIDs","selectedSeriesInstanceUID","onSeriesSelection","seriesInstanceUID","slideList","slideItemList","i","slideItem","selectedKeys","width","onSelect","key","keyPath","domEvent","toString","mode","inlineIndent","handleVisibilityChange","bind","checked","event","onVisibilityChange","roiUID","roi","isVisible","identifier","otherProps","evaluations","forEach","nameValue","ConceptNameCodeSequence","CodeValue","nameMeaning","CodeMeaning","ValueType","dcmjs","valueMeaning","ConceptCodeSequence","textContentItem","TextValue","measurements","seq","MeasuredValueSequence","NumericValue","toPrecision","unit","MeasurementUnitsCodeSequence","align","paddingLeft","onChange","checkedChildren","unCheckedChildren","handleMenuItemSelection","rois","visibleRoiUIDs","object","onSelection","has","paddingTop","paddingBottom","selectedRoiUIDs","values","onClick","handleMeasurementSelection","handleOpacityChange","handleColorRChange","handleColorGChange","handleColorBChange","getCurrentColor","handleAnnotationGroupClick","currentStyle","opacity","defaultStyle","annotationGroupUID","annotationGroup","onStyleChange","styleOptions","limitValues","isArray","onAnnotationGroupClick","option","codeComponents","measurement","schemeDesignator","meaning","colorSettings","windowSettings","explorationSettings","AnnotationGroupSequence","findIndex","AnnotationGroupUID","propertyType","propertyCategory","GraphicType","AnnotationCoordinateType","measurementsSequence","MeasurementsSequence","measurementOptions","measurementItem","CodingSchemeDesignator","dropdownMatchSelectWidth","disabled","plain","justify","gutter","range","min","max","step","handleLowerLimitChange","handleLimitChange","handleUpperLimitChange","minWidth","defaultValue","settings","isBadgeVisible","direction","placement","content","overlayStyle","shape","SettingOutlined","offset","count","borderStyle","borderWidth","borderColor","visibility","backgroundImage","annotationGroups","onAnnotationGroupVisibilityChange","visibleAnnotationGroupUIDs","defaultAnnotationGroupStyles","onAnnotationGroupStyleChange","handleClick","text","button","Icon","isSelected","tooltip","Manufacturer","ManufacturerModelName","DeviceSerialNumber","SoftwareVersions","InstitutionName","findContentItemsByName","concept","hasName","hasValueType","valueType","getROIs","report","matches","ContentSequence","measurementsItem","measurementGroupItems","observerType","group","trackingUIDItem","algorithmNameItem","algorithmVersionItem","scoord3d","regionItem","frameOfReferenceUID","ReferencedFrameOfReferenceUID","coordinates","GraphicData","evaluation","findEvaluationItems","findMeasurementItems","properties","trackingUID","UID","MeasurementReport","PersonObserverName","PersonObserverLoginName","DeviceObserverUID","DeviceObserverName","SpecimenUID","SpecimenIdentifier","ROIs","specimenUIDItem","specimenIdItem","containerIdItem","personNameItem","PersonName","personLoginNameItem","deviceUIDItem","deviceNameItem","dataset","containerAttrs","specimenAttrs","observerAttrs","annotations","id","attrs","orientation","groups","SpecimenPreparationAdditives","FIXATIVE","EMBEDDING_MEDIUM","SpecimenPreparationStepItems","SPECIMEN_IDENTIFIER","PARENT_SPECIMEN_IDENTIFIER","PROCESSING_TYPE","DATETIME_OF_PROCESSING","PROCESSING_STEP_DESCRIPTION","COLLECTION_METHOD","SAMPLING_METHOD","STAIN","specimenDescription","SpecimenDescriptionSequence","SpecimenShortDescription","PrimaryAnatomicStructureSequence","structures","SpecimenPreparationSequence","SpecimenPreparationStepContentItemSequence","equals","showstain","overflowY","handleRemoval","getCurrentColors","paletteColorLookupTable","previousProps","previousState","opticalPath","opticalPathIdentifier","rgb2hex","data","onRemoval","illuminationWaveLength","illuminationColor","specimenDescriptions","maxValue","Math","pow","BitsAllocated","isMonochromatic","colors","buttons","isRemovable","DeleteOutlined","EyeOutlined","EyeInvisibleOutlined","Option","Select","selectedOpticalPathIdentifier","handleItemAddition","handleItemRemoval","handleItemSelectionChange","onOpticalPathActivityChange","isActive","opticalPathSelector","isSelectable","opticalPaths","opticalPathItems","optionItems","images","SeriesInstanceUID","OpticalPathSequence","opticalPathItem","OpticalPathIdentifier","OpticalPathDescription","activeOpticalPathIdentifiers","visibleOpticalPathIdentifiers","defaultOpticalPathStyles","onOpticalPathVisibilityChange","onOpticalPathStyleChange","padding","allowClear","AppstoreAddOutlined","mappingUID","mapping","mappings","visibleMappingUIDs","defaultMappingStyles","onMappingVisibilityChange","onMappingStyleChange","segmentUID","segment","algorithmName","segments","visibleSegmentUIDs","defaultSegmentStyles","onSegmentVisibilityChange","onSegmentStyleChange","withRouter","Component","location","useLocation","navigate","useNavigate","params","useParams","contourOnly","annotationGroupsUIDs","updateCurrentStyle","handleShowOutlineOnly","target","checkedAnnotationUids","defaultAnnotationStyles","types","checkAll","every","uids","indeterminate","some","handleChangeCheckedType","e","mouseEnterDelay","reduce","acc","marginLeft","shortenedCodeMeaning","displayCodeMeaning","isChecked","indeterminateType","flexDirection","categories","categoriesAcc","annotation","categoryKey","typeKey","oldCategory","oldType","Object","keys","typesArr","getCategories","xPosition","yPosition","position","top","left","backgroundColor","minHeight","pointerEvents","attr","roiUid","adaptRoiToAnnotation","result","user","app","refImage","observer","refSpecimen","debug","loginName","email","observationContext","observerPersonContext","observerIdentifyingAttributes","observerDeviceContext","manufacturerName","modelName","subjectContext","subjectClass","subjectClassSpecificContext","imagingMeasurements","findingType","trackingIdentifier","referencedRegion","graphicType","graphicData","qualitativeEvaluations","filter","ContentTemplateSequence","MappingResource","TemplateIdentifier","measurementReport","languageOfContentItemAndDescendants","procedureReported","isReportModalVisible","generatedReport","evidence","seriesNumber","seriesDescription","sopInstanceUID","instanceNumber","manufacturer","previousVersions","DEFAULT_ROI_STROKE_COLOR","DEFAULT_ROI_FILL_COLOR","DEFAULT_ANNOTATION_STROKE_COLOR","DEFAULT_ANNOTATION_COLOR_PALETTE","_buildKey","codingScheme","codeValue","_getRoiKey","findingName","_areROIsEqual","a","b","s1","s2","j","_formatRoiStyle","stroke","fill","image","circle","radius","_constructViewers","preload","volumeImages","labelViewer","volumeViewer","clientMapping","controls","activateSelectInteraction","labelImages","_implementsTID1500","templateSeq","_describesSpecimenSubject","subjectClassValue","retrievedConcept","expectedConcept","_containsROIAnnotations","measurementGroups","foundRegion","regions","SlideViewer","findingOptions","evaluationOptions","geometryTypeOptions","volumeViewportRef","labelViewportRef","hoveredRois","lastPixel","keysDown","Set","defaultRoiStyle","roiStyles","selectionStrokeColor","selectionFillColor","selectedRoiStyle","loadPresentationStates","ADVANCED_BLENDING_PRESENTATION_STATE","searchForInstances","studyInstanceUID","queryParams","Modality","then","matchedInstances","rawInstance","instance","SOPInstanceUID","retrieveInstance","retrievedInstance","dict","areVolumeImagesMonochrome","presentationState","doesMatch","AdvancedBlendingSequence","blendingItem","selectedPresentationStateUID","setPresentationState","presentationStates","catch","getAllOpticalPaths","opticalPathStyles","hideOpticalPath","deactivateOpticalPath","getOpticalPathDefaultStyle","setOpticalPathStyle","refInstanceItems","ReferencedInstanceSequence","ReferencedImageSequence","imageItem","sopInstanceUIDs","ReferencedSOPInstanceUID","paletteColorLUT","PaletteColorLookupTableSequence","cpLUTItem","PaletteColorLookupTableUID","redDescriptor","RedPaletteColorLookupTableDescriptor","greenDescriptor","GreenPaletteColorLookupTableDescriptor","blueDescriptor","BluePaletteColorLookupTableDescriptor","redData","RedPaletteColorLookupTableData","Uint16Array","greenData","GreenPaletteColorLookupTableData","blueData","BluePaletteColorLookupTableData","redSegmentedData","SegmentedRedPaletteColorLookupTableData","greenSegmentedData","SegmentedGreenPaletteColorLookupTableData","blueSegmentedData","SegmentedBluePaletteColorLookupTableData","SoftcopyVOILUTSequence","voiLUTItem","windowCenter","WindowCenter","windowWidth","WindowWidth","selectedOpticalPathIdentifiers","activateOpticalPath","showOpticalPath","add","searchParams","URLSearchParams","search","set","pathname","replace","getRoiStyle","loadDerivedDataset","derivedDataset","SOPClassUID","getAllROIs","handleAnnotationVisibilityChange","getAllAnnotationGroups","handleAnnotationGroupVisibilityChange","getAllSegments","handleSegmentVisibilityChange","getAllParameterMappings","parameterMapping","handleMappingVisibilityChange","handleOpticalPathVisibilityChange","addAnnotationGroups","Promise","resolve","reject","MICROSCOPY_BULK_SIMPLE_ANNOTATION","searchForSeries","matchedSeries","series","retrieveSeriesMetadata","retrievedMetadata","ann","finding","AnnotationPropertyTypeCodeSequence","setAnnotationGroupStyle","forceUpdate","addSegmentations","SEGMENTATION","segmentations","seg","FrameOfReferenceUID","addSegments","addParametricMaps","PARAMETRIC_MAP","parametricMaps","pm","addParameterMappings","populateViewports","setDefaultPresentationState","addAnnotations","onRoiModified","onWindowResize","onRoiDrawn","detail","selectedFinding","selectedEvaluations","findingItem","relationshipType","addEvaluation","addROI","onRoiDoubleClicked","isSelectedRoiModalVisible","setHoveredRoiAttributes","r","hoveredRoiAttributes","clearHoveredRois","getUniqueHoveredRois","newRoi","allRois","isSamePixelAsLast","clientX","clientY","onPointerMove","hoveredRoi","feature","originalEvent","isHoveredRoiTooltipVisible","hoveredRoiTooltipX","hoveredRoiTooltipY","getUpdatedSelectedRois","newSelectedRoiUid","selectedRoiUid","emptySelection","selectedRoi","getROI","oldSelectedRois","resetUnselectedRoiStyles","selectionState","setROIStyle","onMapClicked","updatedSelectedRois","clearSelections","onRoiSelected","onLoadingStarted","onLoadingEnded","onFrameLoadingStarted","frameInfo","frameNumber","loadingFrames","onFrameLoadingError","onLoadingError","onFrameLoadingEnded","delete","sopClassUID","channelIdentifier","pixelDataStatistics","pixelArray","chunks","ceil","minValues","maxValues","pixels","stats","numFramesSampled","getOpticalPathStyle","onRoiRemoved","onKeyDown","onKeyUp","isRoiDrawingActive","deactivateDrawInteraction","isRoiModificationActive","deactivateModifyInteraction","isRoiTranslationActive","deactivateTranslateInteraction","isAnnotationModalVisible","isGoToModalVisible","altKey","code","handleRoiDrawing","handleRoiModification","handleRoiTranslation","handleRoiRemoval","handleRoiVisibilityChange","handleReportGeneration","handleGoTo","zoomToROI","handleICCProfilesToggle","isICCProfilesEnabled","toggleICCProfiles","formatAnnotation","generateRoiStyle","geometryTypes","componentSetup","componentCleanup","handleRoiSelectionCancellation","handleAnnotationConfigurationCancellation","handleAnnotationGeometryTypeSelection","handleAnnotationMeasurementActivation","handleAnnotationFindingSelection","handleAnnotationEvaluationSelection","handleAnnotationEvaluationClearance","handleAnnotationConfigurationCompletion","handleAnnotationGroupStyleChange","handleRoiStyleChange","handleXCoordinateSelection","handleYCoordinateSelection","handleMagnificationSelection","handleSlidePositionSelection","handleSlidePositionSelectionCancellation","handleReportVerification","handleReportCancellation","handleSegmentStyleChange","handleMappingStyleChange","handleOpticalPathStyleChange","handleOpticalPathActivityChange","handlePresentationStateSelection","handlePresentationStateReset","handleAnnotationSelection","boundingBox","isSelectedMagnificationValid","isSelectedXCoordinateValid","isSelectedYCoordinateValid","selectedXCoordinate","validXCoordinateRange","selectedYCoordinate","validYCoordinateRange","selectedMagnification","areRoisHidden","cleanup","isOpticalPathVisible","isOpticalPathActive","COMPREHENSIVE_3D_SR","otherROI","roiAsAnnotation","document","body","removeEventListener","window","addEventListener","hasICCProfile","ICCProfile","bulkdataReferences","selectedGeometryType","selectedMarkup","filteredEvaluations","x","Number","start","end","y","targetPixelSpacing","diffs","numLevels","actualPixelSpacing","getPixelSpacing","abs","level","indexOf","point","log","geometryType","markup","activateDrawInteraction","getOpticalPathMetadata","prevState","generateReport","fileMetaInformationVersionArray","Uint8Array","fileMeta","Value","buffer","vr","writer","write","storeInstances","datasets","response","showAnnotationGroup","hideAnnotationGroup","strokeColor","fillColor","c","showSegment","hideSegment","setSegmentStyle","showParameterMapping","hideParameterMapping","setParameterMappingStyle","sort","localeCompare","paletteColorLookupTableUID","defaultColors","numVisible","urlPath","deactivateSelectInteraction","deactivateSnapInteraction","isModifyInteractionActive","activateSnapInteraction","activateModifyInteraction","isTranslateInteractionActive","activateTranslateInteraction","removeROI","showROIs","hideROIs","allAnnotationGroups","filteredAnnotationGroups","referencedSeriesInstanceUID","annotationMenuItems","openSubMenuItems","geometryTypeOptionsMapping","box","polygon","line","freehandpolygon","freehandline","annotationConfigurations","defaultActiveFirstOption","placeholder","onClear","specimenMenu","equipmentMenu","opticalPathMetadata","presentationStateMenu","segmentationMenu","parametricMapMenu","annotationGroupMenu","toolbar","opticalPathMenu","presentationStateOptions","ContentDescription","maxWidth","UndoOutlined","segmentMetadata","getSegmentStyle","getSegmentMetadata","mappingMetadata","getParameterMappingStyle","getParameterMappingMetadata","annotationGroupMetadata","getAnnotationGroupStyle","getAnnotationGroupMetadata","toolbarHeight","annotationTools","FaDrawPolygon","FaHandPointer","FaHandPaper","FaTrash","FaEye","FaEyeSlash","FaSave","controlTools","FaCrosshairs","enableAnnotationTools","selectedRoiInformation","cursor","roiAttributes","roiScoordAttributes","roiEvaluationAttributes","codeItem","textItem","roiMeasurmentAttributesPerOpticalPath","refItems","ReferencedSOPSequence","ReferencedOpticalPathIdentifier","measuredValueItem","createRoiDescription","roiDescriptions","roiScoordDescriptions","roiEvaluationDescriptions","roiMeasurementDescriptions","descriptions","orientationMargin","dashed","iccProfilesMenu","getICCProfiles","margin","hasSider","overflow","open","onOk","okButtonProps","onCancel","okText","maskClosable","footer","prefix","onPressEnter","addonAfter","CheckOutlined","StopOutlined","reverseArrow","borderLeft","borderLeftWidth","background","defaultOpenKeys","forceSubMenuRender","onOpenChange","setTimeout","ImageFlavors","hasImageFlavor","imageFlavor","ImageType","areSameAcquisition","AcquisitionUID","Slide","options","acquisitionUID","opticalPathIdentifiers","pyramidUIDs","acquisitionUIDs","containerIdentifiers","frameOfReferenceUIDs","VOLUME","LABEL","OVERVIEW","PyramidUID","THUMBNAIL","img","opt","samplesPerPixel","SamplesPerPixel","requirePyramidUID","PhotometricInterpretation","createSlides","slideMetadata","filteredLabelImages","filteredVolumeImages","slideMetadataIndex","_doesImageBelongToSlide","filteredOverviewImages","slideMetadataItem","slides","imgA","imgB","fetchImageMetadata","onSuccess","onError","StudyInstanceUID","all","loadingSeries","seriesImages","newSlides","customError","slidesCache","Map","pendingRequests","useSlides","useState","setSlides","setIsLoading","setError","useEffect","cachedData","get","fetchSlides","pendingRequest","err","naturalizeDataset","findSeriesSlide","ParametrizedSlideViewer","selectedSlide","setSelectedSlide","setDerivedDataset","seriesSlide","findReferencedSlide","allClients","storageClass","seriesMetadata","naturalizedSeriesMetadata","ReferencedSeriesSequence","referencedSlide","imageLibrary","contentItem","referencedSOPInstanceUID","presentationStateUID","viewer","volumeInstances","clinicalTrialMenu","seriesFragment","borderRight","borderRightWidth","path","element","DicomMetaDictionary","formatValue","val","getRows","depth","keywords","flatMap","keyword","tagInfo","nameMap","match","tag","sequenceItems","sequenceNode","getSortedTags","subscribe","_broadcastEvent","_unsubscribe","_isValidEvent","listenerId","subscription","listeners","unsubscribe","EVENTS","callbackProps","hasListeners","hasCallbacks","listener","defaultInstances","instances","instancesMap","SeriesNumber","SeriesDescription","SeriesDate","SeriesTime","addInstance","newInstance","addInstances","newInstances","len","getInstance","StudyDescription","NumInstances","ModalitiesInStudy","isLoaded","addInstanceToSeries","addInstancesToSeries","createSeriesMetadata","setSeriesMetadata","existingSeries","assign","STUDY_ADDED","INSTANCES_ADDED","SERIES_ADDED","SERIES_UPDATED","_model","studies","_getStudy","aStudy","_getSeries","study","aSeries","BaseImplementation","dicomJSONDatasetOrP10ArrayBuffer","dicomJSONDataset","naturalizedDataset","ArrayBuffer","createStudyMetadata","madeInClient","updateSeriesMetadata","addSeriesMetadata","seriesSummaryMetadata","NumberOfStudyRelatedSeries","addStudy","existingStudy","newStudy","getStudyInstanceUIDs","getStudy","getSeries","getInstanceByImageId","imageId","updateMetadataForSeries","pubSubServiceInterface","setStudy","displaySets","setDisplaySets","selectedDisplaySetInstanceUID","setSelectedDisplaySetInstanceUID","setInstanceNumber","filterValue","setFilterValue","expandedKeys","setExpandedKeys","searchInput","setSearchInput","debouncedSearchValue","delay","debouncedValue","setDebouncedValue","timer","clearTimeout","useDebounce","handler","DicomMetadataStore","seriesAddedSubscription","instancesAddedSubscription","derivedDisplaySets","processedSeries","ds","displaySetInstanceUID","displaySetList","useMemo","displaySet","displayDate","dateStr","hour","minute","second","monthNum","parseInt","dayNum","date","Date","getMonth","getDate","weekday","toLocaleDateString","monthName","dayFormatted","yearNum","getFullYear","formatDicomDate","showInstanceList","instanceSliderMarks","totalInstances","tableData","transformTagsToTableData","tags","parentKey","keyBase","currentKey","filteredData","searchLower","toLowerCase","matchedKeys","nodeMatches","node","findMatchingPaths","parentPath","currentPath","matchingPaths","child","childPaths","filtered","reconstructTree","paths","nodesAtLevel","className","gap","marginBottom","flex","strong","optionLabelProp","optionFilterProp","marks","formatter","SearchOutlined","columns","dataIndex","dataSource","pagination","expandable","expandedRowKeys","onExpandedRowsChange","scroll","isValidServerUrl","url","urlObj","URL","protocol","startsWith","TypeError","handleInfoButtonClick","browser","detect","environment","os","version","Modal","homepage","handleDicomTagBrowserButtonClick","innerWidth","handleDebugButtonClick","errorMsgs","Authentication","Communication","EncodingDecoding","Visualization","errorNum","errorObj","warncount","Panel","Collapse","showErrorCount","errcount","uuidv4","warnings","warning","handleServerSelectionButtonClick","isServerSelectionModalVisible","handleServerSelectionInput","currentTarget","selectedServerUrl","isServerSelectionDisabled","handleServerSelectionCancellation","cachedServerUrl","localStorage","getItem","serverSelectionMode","handleServerSelectionModeChange","handleServerSelection","setItem","onServerSelection","closeModal","cachedMode","prevProps","worklistButton","userMenuItems","onUserLogout","userMenu","menu","trigger","UserOutlined","preventDefault","showWorklistButton","to","UnorderedListOutlined","serverSelectionButton","infoButton","InfoOutlined","debugButton","zIndex","dicomTagBrowserButton","FileSearchOutlined","showServerSelectionButton","ApiOutlined","default","baseURL","defaultClients","urlInfo","textOverflow","paddingRight","flexWrap","flexShrink","src","process","alt","subTitle","defaultPageSize","handleSearch","confirm","handleReset","clearFilters","getColumnSearchProps","filterDropdown","setSelectedKeys","filterIcon","fetchData","handleChange","numStudies","pageSize","searchOptions","searchForStudies","limit","searchCriteria","fuzzymatching","filters","hideOnSinglePage","showSizeChanger","showQuickJumper","showTotal","total","rowKey","record","onRow","loading","joinUrl","uri","baseUri","endsWith","isAuthorizationCodeInUrl","hashParams","hash","Boolean","createUser","userData","profile","OidcManager","_oidc","signIn","onSignIn","handleSignIn","authorization","token_type","access_token","signinCallback","getUser","expired","signinRedirect","signOut","signoutRedirect","getAuthorization","responseType","grantType","UserManager","authority","client_id","clientId","redirect_uri","scope","response_type","loadUserInfo","automaticSilentRenew","revokeAccessTokenOnSignout","post_logout_redirect_uri","endSessionEndpoint","metadataService","getMetadata","end_session_endpoint","retries","factor","minTimeout","maxTimeout","randomize","retryableStatusCodes","retryOptions","xhrRetryHook","request","method","originalRequestSend","send","operation","retry","attempt","currentAttempt","originalOnReadyStateChange","onreadystatechange","status","errorMessage","attemptFailedError","DicomWebManager","stores","handleError","updateHeaders","fields","f","headers","retrieveStudyMetadata","studySummaryMetadata","naturalized","retrieveInstanceMetadata","retrieveInstanceFrames","retrieveInstanceRendered","retrieveInstanceFramesRendered","retrieveBulkData","serverSettings","serviceUrl","clientSettings","shouldUpgradeInsecure","upgradeInsecureRequests","qidoPathPrefix","wadoPathPrefix","stowPathPrefix","qidoURLPrefix","wadoURLPrefix","stowURLPrefix","requestHooks","getXHRRetryHook","read","dwc","ParametrizedCaseViewer","config","disableAnnotationTools","CaseViewer","auth","handleDICOMwebError","logServerError","errorMessages","setting","Authorization","storedPath","storedSearch","href","removeItem","host","appUri","oidcSettings","oidc","servers","addGcpSecondaryAnnotationServer","gcpBaseUrl","storageClassMapping","storageClasses","pathUrl","server","_createClientMapping","wasAuthSuccessful","serverId","COMPREHENSIVE_SR","COLOR_SOFTCOPY_PRESENTATION_STATE","GRAYSCALE_SOFTCOPY_PRESENTATION_STATE","PSEUDOCOLOR_SOFTCOPY_PRESENTATION_STATE","tmpClient","redirectTo","worklist","appInfo","organization","enableWorklist","disableWorklist","enableServerSelection","onLogout","isLogoutPossible","layoutStyle","layoutContentStyle","basename"],"sourceRoot":""}