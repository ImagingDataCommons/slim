"use strict";(self.webpackChunkslim=self.webpackChunkslim||[]).push([[273],{6273:(e,t,n)=>{n.d(t,{Z:()=>Ii});var i=n(5671),o=n(3144),a=n(7326),r=n(136),s=n(7277),l=n(3695),c=n(586),u=n(2791),d=n(9135),p=n(7689),h=n(1087),v=n(4165),m=n(5861),f=n(5685),g=n(3085),S=n(8737),y="Authentication",I="Communication",C="EncodingDecoding",b="Visualization",w=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e,o){var a;return(0,i.Z)(this,n),(a=t.call(this)).message=o,a.stack=(new Error).stack,a.type=e,a}return(0,o.Z)(n)}((0,S.Z)(Error)),D=Symbol("subscriptions"),x=Symbol("lastSubscriptionId"),V="onError",M="onWarning",R="dicomweb-client",O="dicom-microscopy-viewer",Z="dcmjs",P="slim",U="authentication",E="toast",j="console",A={sources:[{category:y,notificationType:E},{category:I,notificationType:E},{category:b,notificationType:E},{category:C,notificationType:j},{category:"Warning",notificationType:E}]},T=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;(0,i.Z)(this,n),e=t.call(this);var o=function(t){e.publish(M,Array.from(t).join(" "))};return function(){var e=console.warn;console.warn=function(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];JSON.stringify(n).includes("request")||o(n),e.apply(this,n)}}(),e}return(0,o.Z)(n,[{key:"onError",value:function(e,t){var n,i=t.type,o=A.sources.find((function(e){return e.category===i})).notificationType;if(this.publish(V,{source:e,error:t}),n=t instanceof w?t.message:String(t),o===E)return g.Z.error({message:"".concat(i," error"),description:n,duration:3})}}]),n}(function(){function e(){(0,i.Z)(this,e),this[D]={},this[x]=0}return(0,o.Z)(e,[{key:"subscribe",value:function(e,t){if(void 0===e)throw new Error("Trying to subscribe to an inexistent event");if("function"!==typeof t)throw new Error("The provided callback must be a function");Object.hasOwn(this[D],e)||(this[D][e]={});var n="sub".concat(this[x]++);this[D][e][n]=t}},{key:"unsubscribe",value:function(e,t){var n=this[D][e]||{};for(var i in n)t?n[i]===t&&delete n[i]:delete n[i]}},{key:"publish",value:function(e){if(void 0===e)throw new Error("Trying to publish an inexistent event");for(var t=this[D][e]||{},n=arguments.length,i=new Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];for(var a in t)t[a].apply(t,i)}},{key:"unsubscribeFromAll",value:function(){for(var e in this[D]){var t=this[D][e];for(var n in t)delete t[n]}}}]),e}());const k=new T;var L,N=function(e,t){var n=t;return n.endsWith("/")||(n+="/"),new URL(e,n).toString()},_=function(e){var t,n,i,o,a,r=new URLSearchParams(e.search),s=new URLSearchParams(e.hash.replace("#","?"));return Boolean(null!==(t=null!==(n=null!==(i=null!==(o=null!==(a=r.get("code"))&&void 0!==a?a:r.get("id_token"))&&void 0!==o?o:r.get("session_state"))&&void 0!==i?i:s.get("code"))&&void 0!==n?n:s.get("id_token"))&&void 0!==t?t:s.get("session_state"))},G=function(e){var t;if(null!==e&&(t=e.profile),void 0!==t){if(void 0!==t.name&&void 0!==t.email)return{name:t.name,email:t.email};k.onError(U,new w(y,'Failed to obtain user "name" and "email".'))}else k.onError(U,new w(y,"Failed to obtain user profile."));return{name:void 0,email:void 0}},q=(0,o.Z)((function e(t,n){var o=this;(0,i.Z)(this,e),this._oidc=void 0,this.signIn=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){var n,i,a,r;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.onSignIn,i=function(e){var t=G(e),i="".concat(e.token_type," ").concat(e.access_token);null!=n?(console.info("handling sign-in using provided callback function"),n({user:t,authorization:i})):console.warn("no callback function was provided to handle sign-in")},!_(window.location)){e.next=10;break}return console.info("obtaining authorization"),e.next=6,o._oidc.signinCallback();case 6:null!=(a=e.sent)&&(console.info("obtained user data: ",a),i(a)),e.next=21;break;case 10:return e.next=12,o._oidc.getUser();case 12:if(null!==(r=e.sent)&&void 0!==r&&!r.expired){e.next=19;break}return console.info("authenticating user"),e.next=17,o._oidc.signinRedirect();case 17:e.next=21;break;case 19:console.info("user has already been authenticated"),i(r);case 21:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.signOut=(0,m.Z)((0,v.Z)().mark((function e(){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("signing out user and revoking authorization"),e.next=3,o._oidc.signoutRedirect();case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e)}))),this.getAuthorization=(0,m.Z)((0,v.Z)().mark((function e(){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o._oidc.getUser().then((function(e){if(null!==e&&void 0!==e)return e.access_token;k.onError(U,new w(y,"Failed to obtain user profile."))}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))),this.getUser=(0,m.Z)((0,v.Z)().mark((function e(){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o._oidc.getUser().then((function(e){return null!==e&&void 0!==e||k.onError(U,new w(y,"Failed to obtain user information.")),G(e)}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));var a="code";void 0!==n.grantType&&"implicit"===n.grantType&&(a="id_token token"),this._oidc=new f.UserManager({authority:n.authority,client_id:n.clientId,redirect_uri:t,scope:n.scope,response_type:a,loadUserInfo:!0,automaticSilentRenew:!0,revokeAccessTokenOnSignout:!0,post_logout_redirect_uri:"".concat(t,"/logout")}),null!==n.endSessionEndpoint&&void 0!==n.endSessionEndpoint&&this._oidc.metadataService.getMetadata().then((function(e){null!==n.endSessionEndpoint&&void 0!==n.endSessionEndpoint&&(e.end_session_endpoint=n.endSessionEndpoint,o._oidc=new f.UserManager({authority:n.authority,client_id:n.clientId,redirect_uri:t,scope:n.scope,response_type:a,loadUserInfo:!0,automaticSilentRenew:!0,revokeAccessTokenOnSignout:!0,post_logout_redirect_uri:"".concat(t,"/logout"),metadata:e}))})).catch((function(e){console.error("failed to get metadata from authorization server: ",e)}))})),z=n(7762),F=n(9439),B=n(6014),H=n(8954);!function(e){e.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE="1.2.840.10008.5.1.4.1.1.77.1.6",e.COMPREHENSIVE_SR="1.2.840.10008.5.1.4.1.1.88.33",e.COMPREHENSIVE_3D_SR="1.2.840.10008.5.1.4.1.1.88.34",e.SEGMENTATION="1.2.840.10008.5.1.4.1.1.66.4",e.MICROSCOPY_BULK_SIMPLE_ANNOTATION="1.2.840.10008.5.1.4.1.1.91.1",e.PARAMETRIC_MAP="1.2.840.10008.5.1.4.1.1.30",e.ADVANCED_BLENDING_PRESENTATION_STATE="1.2.840.10008.5.1.4.1.1.11.8",e.COLOR_SOFTCOPY_PRESENTATION_STATE="1.2.840.10008.5.1.4.1.1.11.2",e.GRAYSCALE_SOFTCOPY_PRESENTATION_STATE="1.2.840.10008.5.1.4.1.1.11.1",e.PSEUDOCOLOR_SOFTCOPY_PRESENTATION_STATE="1.2.840.10008.5.1.4.1.1.11.3",e.OPTICAL_PATH="1.2.840.10008.5.1.4.1.1.88.21"}(L||(L={}));var W,Y=n(6658),X=n(3433);!function(e){e.VOLUME="VOLUME",e.LABEL="LABEL",e.OVERVIEW="OVERVIEW",e.THUMBNAIL="THUMBNAIL"}(W||(W={}));var K=function(e,t){return e.ImageType[2]===t},J=function(e,t){return null!==e.AcquisitionUID&&void 0!==e.AcquisitionUID&&e.AcquisitionUID===t.AcquisitionUID},Q=(0,o.Z)((function e(t){var n=this;(0,i.Z)(this,e),this.description=void 0,this.acquisitionUID=void 0,this.frameOfReferenceUID=void 0,this.containerIdentifier=void 0,this.seriesInstanceUIDs=void 0,this.opticalPathIdentifiers=void 0,this.pyramidUIDs=[],this.areVolumeImagesMonochrome=void 0,this.volumeImages=void 0,this.labelImages=void 0,this.overviewImages=void 0,this.thumbnailImages=void 0,0===t.images.length&&k.onError(P,new w(C,'Value of option "images" have been non-zero length.'));var o=new Set([]),a=new Set([]),r=new Set([]),s=new Set([]),l={VOLUME:new Set([]),LABEL:new Set([]),OVERVIEW:new Set([])},c={VOLUME:{}},u=[],d=[],p=[],h=[];if(t.images.forEach((function(e){if(s.add(e.ContainerIdentifier),o.add(e.SeriesInstanceUID),e.OpticalPathSequence.forEach((function(e){r.add(e.OpticalPathIdentifier)})),null!==e.AcquisitionUID&&void 0!==e.AcquisitionUID&&a.add(e.AcquisitionUID),K(e,W.VOLUME)||K(e,W.THUMBNAIL)){if(K(e,W.THUMBNAIL)&&h.push(e),l.VOLUME.add(e.FrameOfReferenceUID),null!==e.PyramidUID&&void 0!==e.PyramidUID)for(var t=0,n=Object.keys(r);t<n.length;t++){var i=n[t];c.VOLUME[i].add(e.PyramidUID)}u.push(e)}else K(e,W.LABEL)?(l.LABEL.add(e.FrameOfReferenceUID),d.push(e)):K(e,W.OVERVIEW)&&(l.OVERVIEW.add(e.FrameOfReferenceUID),p.push(e))})),0===u.length)k.onError(P,new w(C,"At least one VOLUME image must be provided for a slide."));else{a.size>1&&k.onError(P,new w(C,"All VOLUME images of a slide must have the same number of Samples per Pixel."));var v=new Set([]);u.forEach((function(e){v.add(e.SamplesPerPixel)})),v.size>1&&k.onError(P,new w(C,"All VOLUME images of a slide must have the same number of Samples per Pixel.")),u.filter((function(e){return"RESAMPLED"!==e.ImageType[3]})).length>r.size&&console.warn("the set of VOLUME images of a slide must contain only a single image that has not been resampled per optical path")}this.volumeImages=u,this.labelImages=d,this.overviewImages=p,this.thumbnailImages=h,this.seriesInstanceUIDs=(0,X.Z)(o),this.opticalPathIdentifiers=(0,X.Z)(r),1!==s.size&&k.onError(P,new w(C,"All images of a slide must have the same Container Identifier.")),this.containerIdentifier=(0,X.Z)(s)[0],1!==l.VOLUME.size&&k.onError(P,new w(C,"All VOLUME images of a slide must have the same Frame of Reference UID.")),this.frameOfReferenceUID=(0,X.Z)(l.VOLUME)[0];var m=!1;Object.keys(c.VOLUME).length>0&&(m=!0),this.opticalPathIdentifiers.forEach((function(e){null!=c.VOLUME[e]?c.VOLUME[e].size>1?k.onError(P,new w(C,'All VOLUME images for optical path "'.concat(e,'"')+"must be part of the same multi-resolution pyramid.")):1===c.VOLUME[e].size?n.pyramidUIDs.push((0,X.Z)(c.VOLUME[e])[0]):k.onError(P,new w(C,'The VOLUME images for optical path "'.concat(e,'" ')+"lack the Pyramid UID, while the images for other optical paths contain it.")):m&&k.onError(P,new w(C,'The VOLUME images for optical path "'.concat(e,'" ')+"lack the Pyramid UID, while the images for other optical paths contain it."))})),a.size>1?k.onError(P,new w(C,"All VOLUME images of a slide must be part of the same  acquisition and have the same Acquisition UID.")):1===a.size?this.acquisitionUID=(0,X.Z)(a)[0]:this.acquisitionUID=null,this.areVolumeImagesMonochrome=1===this.volumeImages[0].SamplesPerPixel&&"MONOCHROME2"===this.volumeImages[0].PhotometricInterpretation,this.description=void 0!==t.description?t.description:""})),$=function(e){var t=[];e.forEach((function(e){if(e.length>0){var n=e.filter((function(e){return K(e,W.VOLUME)||K(e,W.THUMBNAIL)})),i=e.filter((function(e){return K(e,W.THUMBNAIL)}));if(n.length>0){var o,a=n[0],r=n.filter((function(e){return a.SamplesPerPixel===e.SamplesPerPixel})),s=t.findIndex((function(e){return function(e,t){if(e.frameOfReferenceUID===t.FrameOfReferenceUID&&e.containerIdentifier===t.ContainerIdentifier&&e.acquisitionUID===t.AcquisitionUID)return!0;return!1}(e,a)})),l=e.filter((function(e){return K(e,W.LABEL)}));o=l.length>1?l.filter((function(e){return J(e,a)})):l;var c,u=e.filter((function(e){return K(e,W.OVERVIEW)}));if(c=u.length>1?u.filter((function(e){return J(e,a)})):u,-1===s){var d={acquisitionUID:a.AcquisitionUID,frameOfReferenceUID:a.FrameOfReferenceUID,containerIdentifier:a.ContainerIdentifier,volumeImages:r,labelImages:o,overviewImages:c,thumbnailImages:i};t.push(d)}else{var p,h,v,m,f=t[s];(p=f.volumeImages).push.apply(p,(0,X.Z)(r)),(h=f.labelImages).push.apply(h,(0,X.Z)(o)),(v=f.overviewImages).push.apply(v,(0,X.Z)(c)),(m=f.thumbnailImages).push.apply(m,(0,X.Z)(i))}}}}));var n=t.map((function(e){return new Q({images:[].concat((0,X.Z)(e.volumeImages),(0,X.Z)(e.labelImages),(0,X.Z)(e.overviewImages))})}));return n=n.sort((function(e,t){var n=e.volumeImages[0],i=t.volumeImages[0];return null!=n.ContainerIdentifier&&null!=i.ContainerIdentifier?Number(n.ContainerIdentifier)-Number(i.ContainerIdentifier):0}))};var ee=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){var n,i,o,a,r,s,l,c,u;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.clients,i=t.studyInstanceUID,o=t.onSuccess,a=t.onError,e.prev=1,r=[],console.info('search for series of study "'.concat(i,'"...')),s=n[L.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE],e.next=7,s.searchForSeries({queryParams:{Modality:"SM",StudyInstanceUID:i}});case 7:return l=e.sent,e.next=10,Promise.all(l.map(function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){var n,o,a,l,c;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Y.metadata.formatMetadata(t),o=n.dataset,a=o,console.info('retrieve metadata of series "'.concat(a.SeriesInstanceUID,'"')),e.next=5,s.retrieveSeriesMetadata({studyInstanceUID:i,seriesInstanceUID:a.SeriesInstanceUID});case 5:l=e.sent,c=[],l.forEach((function(e){var t,n;if((null===(t=e["00080016"])||void 0===t||null===(n=t.Value)||void 0===n?void 0:n[0])===L.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE){var i=new Y.metadata.VLWholeSlideMicroscopyImage({metadata:e});c.push(i)}})),c.length>0&&r.push(c);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 10:c=$(r),o(c),e.next=20;break;case 14:e.prev=14,e.t0=e.catch(1),console.error(e.t0),u=new w(C,"Image metadata could not be retrieved or decoded."),a(u),k.onError(P,u);case 20:case"end":return e.stop()}}),e,null,[[1,14]])})));return function(t){return e.apply(this,arguments)}}(),te=new Map,ne=new Map,ie=new Map,oe=function(){var e,t=Date.now(),n=(0,z.Z)(ie.entries());try{for(n.s();!(e=n.n()).done;){var i=(0,F.Z)(e.value,2),o=i[0];t-i[1]>18e5&&(te.delete(o),ie.delete(o))}}catch(a){n.e(a)}finally{n.f()}},ae=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.clients,n=e.studyInstanceUID,i=(0,u.useState)([]),o=(0,F.Z)(i,2),a=o[0],r=o[1],s=(0,u.useState)(!1),l=(0,F.Z)(s,2),c=l[0],d=l[1],p=(0,u.useState)(null),h=(0,F.Z)(p,2),f=h[0],g=h[1];return(0,u.useEffect)((function(){if(oe(),null!==t&&void 0!==t&&null!==n&&void 0!==n&&""!==n&&0!==n.length){var e=te.get(n);if(void 0!==e)return r(e),d(!1),void g(null);d(!0),g(null);var i=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(){var i,o;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===(i=ne.get(n))&&(i=new Promise((function(e,i){ee({clients:t,studyInstanceUID:n,onSuccess:function(t){te.set(n,t),ie.set(n,Date.now()),e(t)},onError:function(e){i(e)}}).catch((function(e){i(e)}))})),ne.set(n,i)),e.prev=2,e.next=5,i;case 5:o=e.sent,r(o),g(null),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(2),g(e.t0),r([]);case 14:return e.prev=14,ne.delete(n),d(!1),e.finish(14);case 18:case"end":return e.stop()}}),e,null,[[2,10,14,18]])})));return function(){return e.apply(this,arguments)}}();i()}else{var o=Array.from(te.entries());if(o.length>0){var a=o[o.length-1][1];r(a),d(!1),g(null)}else r([]),d(!1),g(null)}}),[t,n]),(0,u.useMemo)((function(){return{slides:a,isLoading:c,error:f}}),[a,c,f])},re=n(1413),se=n(184);function le(e){return function(t){var n=(0,p.TH)(),i=(0,p.s0)(),o=(0,p.UO)(),a=(0,re.Z)((0,re.Z)({},t),{},{location:n,navigate:i,params:o});return(0,se.jsx)(e,(0,re.Z)({},a))}}var ce=n(394),ue=n(4970),de=n(4261),pe=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,o.Z)(n,[{key:"render",value:function(){var e="horizontal",t="14px";void 0!==this.props.hasLongValues&&this.props.hasLongValues&&(e="vertical",t="20px");var n=this.props.attributes.map((function(e,n){var i=(0,de.Z)();return(0,se.jsx)(ce.Z.Item,{label:e.name,labelStyle:{lineHeight:t},contentStyle:{fontWeight:600,whiteSpace:"pre-line",lineHeight:"14px"},span:1,children:e.value},i)})),i=null;return void 0!==this.props.icon&&(i=(0,se.jsx)(this.props.icon,{})),(0,se.jsxs)(ue.Z,{title:this.props.header,extra:i,size:"small",hoverable:this.props.selectable,bordered:void 0!==this.props.header,actions:this.props.methods,children:[(0,se.jsx)(ce.Z,{column:1,size:"small",layout:e,bordered:!1,children:n}),this.props.children]})}}]),n}(u.Component);const he=pe;const ve=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,o.Z)(n,[{key:"render",value:function(){var e=[];return null!=this.props.metadata.ClinicalTrialSponsorName&&e.push.apply(e,[{name:"Sponsor Name",value:this.props.metadata.ClinicalTrialSponsorName},{name:"Protocol ID",value:this.props.metadata.ClinicalTrialProtocolID},{name:"Protocol Name",value:this.props.metadata.ClinicalTrialProtocolName},{name:"Site Name",value:this.props.metadata.ClinicalTrialSiteName}]),null!=this.props.metadata.ClinicalTrialTimePointID&&e.push({name:"Time Point ID",value:this.props.metadata.ClinicalTrialTimePointID}),(0,se.jsx)(he,{attributes:e})}}]),n}(u.Component);function me(e){return"object"===typeof e&&null!==e&&void 0!==e&&void 0!==e.Alphabetic?e.Alphabetic.split("^").join(" "):""}function fe(e){if(null!==e&&void 0!==e){var t=e.substring(0,4),n=e.substring(4,6),i=e.substring(6,8);return"".concat(t,"-").concat(n,"-").concat(i)}return""}function ge(e){if(null!==e&&void 0!==e){var t=e.substring(0,2),n=e.substring(2,4),i=e.substring(4,6);return"".concat(t,":").concat(n,":").concat(i)}return""}function Se(e){return null!==e&&void 0!==e?{F:"Female",M:"Male",O:"Other"}[e]:""}const ye=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,o.Z)(n,[{key:"render",value:function(){var e=[{name:"ID",value:this.props.metadata.PatientID},{name:"Name",value:me(this.props.metadata.PatientName)},{name:"Sex",value:Se(this.props.metadata.PatientSex)},{name:"Birthdate",value:fe(this.props.metadata.PatientBirthDate)},{name:"Age",value:this.props.metadata.PatientAge}];return(0,se.jsx)(he,{attributes:e})}}]),n}(u.Component);var Ie=n(5945),Ce=n(6784),be=(0,u.createContext)(void 0),we=null;var De=function(e){var t=e.children,n=e.clients,i=e.studyInstanceUID,o=(0,u.useState)(!1),a=(0,F.Z)(o,2),r=a[0],s=a[1],l=(0,u.useState)(null),c=(0,F.Z)(l,2),d=c[0],p=c[1],h=ae({clients:n,studyInstanceUID:i}).slides,v=(0,u.useMemo)((function(){return h}),[h]),m=(0,u.useMemo)((function(){var e=null===h||void 0===h?void 0:h.length,t=!1;return null===h||void 0===h||"number"!==typeof e||Number.isNaN(e)||(t=0!==e),{hasSlides:t,slidesLength:null!==e&&void 0!==e?e:0}}),[h]),f=(0,u.useCallback)((function(e){p(e),s(!0)}),[]),g=(0,u.useCallback)((function(e){var t,n;return(null!==(t=null===e||void 0===e||null===(n=e.volumeImages)||void 0===n?void 0:n.length)&&void 0!==t?t:0)<=1?{isValid:!1,message:"This slide is missing a multi-resolution pyramid. Display and performance may be degraded.",type:"warning"}:{isValid:!0,type:"info"}}),[]),S=(0,u.useCallback)((function(e){if(null!==e&&void 0!==e&&m.hasSlides){if(!v.some((function(t){var n;return null===(n=t.volumeImages)||void 0===n?void 0:n.some((function(t){return null!==t.SOPInstanceUID&&void 0!==t.SOPInstanceUID&&t.SOPInstanceUID===e.referencedSOPInstanceUID}))})))return{isValid:!1,message:"The annotation group is not associated with any slide.",type:"warning"}}return{isValid:!0,type:"info"}}),[v,m.hasSlides]),y=(0,u.useCallback)((function(e){var t=e.dialog,n=void 0!==t&&t,i=e.context,o=i.annotationGroup,a=i.slide;if(null!==a&&void 0!==a){var r=g(a);if(!r.isValid)return n&&f(r),r}var s=S(o);return s.isValid?{isValid:!0,type:"info"}:(n&&f(s),s)}),[g,S,f]);(0,u.useEffect)((function(){!function(e){we=e}({runValidations:y})}),[y]);var I=(0,u.useCallback)((function(){s(!1),p(null)}),[]);var C={runValidations:y};return(0,se.jsxs)(be.Provider,{value:C,children:[t,null!==d&&void 0!==d&&(0,se.jsx)(Ce.Z,(0,re.Z)((0,re.Z)({open:r,onCancel:I,onOk:I,title:"Validation ".concat(d.type.charAt(0).toUpperCase()+d.type.slice(1)),okText:"OK",cancelButtonProps:{style:{display:"none"}}},function(e){switch(e){case"error":return{error:!0};case"warning":return{warning:!0};default:return{info:!0}}}(d.type)),{},{children:(0,se.jsx)("p",{children:d.message})}))]})};const xe=function(e){var t=e.slide,n=e.annotationGroup,i=e.iconColor,o=void 0===i?"#e69500":i,a=e.iconSize,r=void 0===a?"1.3em":a,s=e.position,l=void 0===s?{top:"4px",right:"4px"}:s,c=e.style,p=(0,u.useState)(!1),h=(0,F.Z)(p,2),v=h[0],m=h[1],f=(0,u.useState)(void 0),g=(0,F.Z)(f,2),S=g[0],y=g[1],I=function(){var e=(0,u.useContext)(be);if(void 0===e)throw new Error("useValidation must be used within a ValidationProvider");return e}().runValidations;return(0,u.useEffect)((function(){var e=I({dialog:!1,context:{annotationGroup:n,slide:t}});e.isValid?(m(!1),y(void 0)):(m(!0),y(e.message))}),[t,n,I]),v?(0,se.jsx)(Ie.Z,{title:S,children:(0,se.jsx)("div",{style:(0,re.Z)((0,re.Z)({},c),{},{position:"absolute",top:l.top,right:l.right,zIndex:2,pointerEvents:"auto"}),children:(0,se.jsx)(d.gJy,{style:{color:o,fontSize:r,textShadow:"0 2px 6px rgba(0,0,0,0.25), 0 0px 2px #fff"}})})}):null};var Ve=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var o;return(0,i.Z)(this,n),(o=t.call(this,e)).state={isLoading:!1},o.overviewViewportRef=u.createRef(),o.overviewViewer=void 0,o.overviewViewer=void 0,o}return(0,o.Z)(n,[{key:"componentDidMount",value:function(){this.setState({isLoading:!0});var e=this.props.slide.overviewImages.length>0?this.props.slide.overviewImages:this.props.slide.thumbnailImages;if(e.length>0){var t=e[0];if(null!==this.overviewViewportRef.current&&void 0!==this.overviewViewportRef.current){this.overviewViewportRef.current.innerHTML="";var n=this.props.slide.overviewImages.length>0?"OVERVIEW":"THUMBNAIL";console.info("instantiate viewer for ".concat(n," image of slide ")+'"'.concat(t.ContainerIdentifier,'"'));this.overviewViewer=new Y.viewer.OverviewImageViewer({client:this.props.clients[L.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE],disableInteractions:!0,metadata:t,resizeFactor:1,errorInterceptor:function(e){k.onError(O,e)}}),this.overviewViewer.render({container:this.overviewViewportRef.current})}}this.setState({isLoading:!1})}},{key:"render",value:function(){void 0!==this.overviewViewer&&this.overviewViewer.resize();var e=[],t=this.props.slide.description;return null!==t&&void 0!==t&&""!==t&&e.push({name:"Description",value:t}),this.state.isLoading?(0,se.jsx)(d.fCD,{}):(0,se.jsx)(B.Z.Item,(0,re.Z)((0,re.Z)({style:{height:"100%"}},this.props),{},{children:(0,se.jsx)(he,{header:this.props.slide.containerIdentifier,attributes:e,selectable:!0,children:(0,se.jsxs)("div",{style:{position:"relative",height:"100px"},children:[this.props.slide.overviewImages.length>0||this.props.slide.thumbnailImages.length>0?(0,se.jsx)("div",{ref:this.overviewViewportRef,style:{height:"100%"}}):(0,se.jsx)("div",{style:{height:"100%",textAlign:"center",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"1.5rem",fontWeight:300,color:"#8F9BA8",letterSpacing:"0.1em"},children:"SM"}),(0,se.jsx)(xe,{slide:this.props.slide})]})})}),this.props.slide.seriesInstanceUIDs[0])}}]),n}(u.Component);const Me=Ve;const Re=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;(0,i.Z)(this,n);for(var o=arguments.length,a=new Array(o),r=0;r<o;r++)a[r]=arguments[r];return(e=t.call.apply(t,[this].concat(a))).state={selectedSeriesInstanceUID:e.props.selectedSeriesInstanceUID},e}return(0,o.Z)(n,[{key:"componentDidMount",value:function(){this.props.onSeriesSelection({seriesInstanceUID:this.state.selectedSeriesInstanceUID})}},{key:"render",value:function(){for(var e=this,t=this.props.metadata,n=[],i=0;i<t.length;++i){var o=t[i],a=(0,se.jsx)(Me,{slide:o,clients:this.props.clients},o.seriesInstanceUIDs[0]);n.push(a)}var r=[];return null!==this.state.selectedSeriesInstanceUID&&void 0!==this.state.selectedSeriesInstanceUID&&(r=[this.state.selectedSeriesInstanceUID]),(0,se.jsx)(B.Z,{style:{width:"100%"},selectedKeys:r,onSelect:function(t){var n=t.key;t.keyPath,t.domEvent,t.selectedKeys;console.info('select slide "'.concat(n,'"')),e.setState({selectedSeriesInstanceUID:n.toString()}),e.props.onSeriesSelection({seriesInstanceUID:n.toString()})},mode:"inline",inlineIndent:0,children:n})}}]),n}(u.Component);var Oe=n(4942),Ze=n(8030),Pe=n(3734),Ue=n(2014),Ee=n(3099),je=n(6106),Ae=n(914),Te=n(5581),ke=n(3344),Le=n(1333),Ne=n(8573),_e=n.n(Ne);const Ge=function(e,t){var n=[],i=new Map;return(0,re.Z)((0,re.Z)({SeriesInstanceUID:e,Modality:"",SeriesNumber:0,SeriesDescription:"",SeriesDate:"",SeriesTime:""},null===t||void 0===t?void 0:t[0]),{},{instances:n,addInstance:function(e){this.addInstances([e])},addInstances:function(e){for(var t=0,o=e.length;t<o;t++){var a=e[t];i.has(a.SOPInstanceUID)||(i.set(a.SOPInstanceUID,a),n.push(a))}},getInstance:function(e){return i.get(e)}})};const qe=function(e){return{StudyInstanceUID:e,StudyDescription:"",PatientID:"",PatientName:"",StudyDate:"",AccessionNumber:"",NumInstances:0,ModalitiesInStudy:[],isLoaded:!1,series:[],addInstanceToSeries:function(e){this.addInstancesToSeries([e])},addInstancesToSeries:function(e){var t,n=e[0].SeriesInstanceUID;""!==this.StudyDescription&&void 0!==this.StudyDescription&&(this.StudyDescription=String(null!==(t=e[0].StudyDescription)&&void 0!==t?t:""));var i=String(n),o=this.series.find((function(e){return e.SeriesInstanceUID===i}));null==o&&(o=Ge(i,e),this.series.push(o)),o.addInstances(e)},setSeriesMetadata:function(e,t){var n=this.series.find((function(t){return t.SeriesInstanceUID===e}));if(null!=n)n=Object.assign(n,t);else{var i=Ge(e);this.series.push(Object.assign(i,t))}}}};const ze={subscribe:Fe,_broadcastEvent:We,_unsubscribe:Be,_isValidEvent:He};function Fe(e,t){var n=this;if(this._isValidEvent(e)){var i=(0,de.Z)(),o={id:i,callback:t};return Array.isArray(this.listeners[e])?this.listeners[e].push(o):this.listeners[e]=[o],{unsubscribe:function(){return n._unsubscribe(e,i)}}}throw new Error("Event ".concat(e," not supported."))}function Be(e,t){if(void 0!==this.listeners[e]){var n=this.listeners[e];Array.isArray(n)?this.listeners[e]=n.filter((function(e){return e.id!==t})):this.listeners[e]=[]}}function He(e){return Object.values(this.EVENTS).includes(e)}function We(e,t){var n=Object.keys(this.listeners).length>0,i=Array.isArray(this.listeners[e]);n&&i&&this.listeners[e].forEach((function(e){e.callback(t)}))}var Ye={STUDY_ADDED:"event::dicomMetadataStore:studyAdded",INSTANCES_ADDED:"event::dicomMetadataStore:instancesAdded",SERIES_ADDED:"event::dicomMetadataStore:seriesAdded",SERIES_UPDATED:"event::dicomMetadataStore:seriesUpdated"},Xe={studies:[]};function Ke(e){return Xe.studies.find((function(t){return t.StudyInstanceUID===e}))}function Je(e,t){var n=Ke(e);if(null!=n)return n.series.find((function(e){return e.SeriesInstanceUID===t}))}var Qe={EVENTS:Ye,listeners:{},addInstance:function(e){var t,n;e instanceof ArrayBuffer?t=H.ZP.data.DicomMessage.readFile(e).dict:t=e;var i=(n="SeriesInstanceUID"in t?t:H.ZP.data.DicomMetaDictionary.naturalizeDataset(t)).StudyInstanceUID,o=Xe.studies.find((function(e){return e.StudyInstanceUID===i}));null==o&&(Xe.studies.push(qe(String(i))),o=Xe.studies[Xe.studies.length-1]),o.addInstanceToSeries(n)},addInstances:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=e[0],i=n.StudyInstanceUID,o=n.SeriesInstanceUID,a=Xe.studies.find((function(e){return e.StudyInstanceUID===i}));null==a&&(Xe.studies.push(qe(String(i))),a=Xe.studies[Xe.studies.length-1]),a.addInstancesToSeries(e),this._broadcastEvent(Ye.INSTANCES_ADDED,{StudyInstanceUID:i,SeriesInstanceUID:o,madeInClient:t})},updateSeriesMetadata:function(e){var t=e.StudyInstanceUID,n=e.SeriesInstanceUID,i=String(t),o=String(n);if(null!=Je(i,o)){var a=Ke(i);null!=a&&a.setSeriesMetadata(o,e)}},addSeriesMetadata:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(void 0!==e&&0!==e.length&&void 0!==e[0]){var n,i=e[0].StudyInstanceUID,o=String(i),a=Ke(o);if(null==a)(a=qe(o)).StudyDescription=String(null!==(n=e[0].StudyDescription)&&void 0!==n?n:""),null===e||void 0===e||e.forEach((function(e){var t,n,i,o;void 0===a||null!==(t=a.ModalitiesInStudy)&&void 0!==t&&t.includes(String(null!==(n=e.Modality)&&void 0!==n?n:""))||(null===(i=a.ModalitiesInStudy)||void 0===i||i.push(String(null!==(o=e.Modality)&&void 0!==o?o:"")))})),a.NumberOfStudyRelatedSeries=e.length,Xe.studies.push(a);e.forEach((function(e){var t,n=e.SeriesInstanceUID;null===(t=a)||void 0===t||t.setSeriesMetadata(String(n),e)})),this._broadcastEvent(Ye.SERIES_ADDED,{StudyInstanceUID:o,seriesSummaryMetadata:e,madeInClient:t})}},addStudy:function(e){var t=e.StudyInstanceUID,n=Xe.studies.find((function(e){return e.StudyInstanceUID===t}));if(null==n){var i,o,a,r,s,l,c=qe(String(t));c.PatientID=String(null!==(i=e.PatientID)&&void 0!==i?i:""),c.PatientName=String(null!==(o=e.PatientName)&&void 0!==o?o:""),c.StudyDate=String(null!==(a=e.StudyDate)&&void 0!==a?a:""),c.ModalitiesInStudy=Array.isArray(e.ModalitiesInStudy)?e.ModalitiesInStudy.map(String):[],c.StudyDescription=String(null!==(r=e.StudyDescription)&&void 0!==r?r:""),c.AccessionNumber=String(null!==(s=e.AccessionNumber)&&void 0!==s?s:""),c.NumInstances=null!==(l=Number(e.NumInstances))&&void 0!==l?l:0,Xe.studies.push(c)}},getStudyInstanceUIDs:function(){return Xe.studies.map((function(e){return e.StudyInstanceUID}))},getStudy:Ke,getSeries:Je,getInstance:function(e,t,n){var i=Je(e,t);if(null!=i)return i.getInstance(n)},getInstanceByImageId:function(e){var t,n=(0,z.Z)(Xe.studies);try{for(n.s();!(t=n.n()).done;){var i,o=t.value,a=(0,z.Z)(o.series);try{for(a.s();!(i=a.n()).done;){var r,s=i.value,l=(0,z.Z)(s.instances);try{for(l.s();!(r=l.n()).done;){var c=r.value;if(c.imageId===e)return c}}catch(u){l.e(u)}finally{l.f()}}}catch(u){a.e(u)}finally{a.f()}}}catch(u){n.e(u)}finally{n.f()}},updateMetadataForSeries:function(e,t,n){var i=Ke(e);if(null!=i){var o=i.series.find((function(e){return e.SeriesInstanceUID===t}));if(null!=o)o.instances.forEach((function(e){Object.keys(n).forEach((function(t){if("object"===typeof n[t]&&null!==n[t]){var i=e[t];e[t]=(0,re.Z)((0,re.Z)({},"object"===typeof i&&null!==i?i:{}),n[t])}else e[t]=n[t]}))}))}},_broadcastEvent:function(e,t){}};const $e=Object.assign({},Qe,ze);var et=function(e){var t=e.uid,n=e.evaluations,i={category:{CodeValue:"undefined",CodeMeaning:"undefined",CodingSchemeDesignator:"undefined"},type:{CodeValue:"undefined",CodeMeaning:"undefined",CodingSchemeDesignator:"undefined"}};return n.forEach((function(e){var t=e.ConceptNameCodeSequence[0].CodeValue;if(e.ValueType===H.sr.valueTypes.ValueTypes.CODE){var n=e.ConceptCodeSequence[0];"276214006"===t?i.category=(0,re.Z)({},n):"121071"===t&&(i.type=(0,re.Z)({},n))}})),(0,re.Z)((0,re.Z)({},i),{},{uid:t})};const tt=function(e){var t,n,i=e.rois,o=e.metadata,a=e.user,r=e.app,s=e.visibleRoiUIDs,l=o[o.length-1];(null!==(t=null===(n=l.SpecimenDescriptionSequence)||void 0===n?void 0:n.length)&&void 0!==t?t:0)>1&&k.onError(P,new w(b,"More than one specimen has been described for the slide"));var c,u,d,p=l.SpecimenDescriptionSequence[0];(console.debug("create Observation Context"),void 0!==a)?c=new H.sr.templates.PersonObserverIdentifyingAttributes({name:null!==(u=a.name)&&void 0!==u?u:"ANONYMOUS",loginName:null!==(d=a.email)&&void 0!==d?d:""}):(console.warn("no user information available"),c=new H.sr.templates.PersonObserverIdentifyingAttributes({name:"ANONYMOUS"}));var h=new H.sr.templates.ObservationContext({observerPersonContext:new H.sr.templates.ObserverContext({observerType:new H.sr.coding.CodedConcept({value:"121006",schemeDesignator:"DCM",meaning:"Person"}),observerIdentifyingAttributes:c}),observerDeviceContext:new H.sr.templates.ObserverContext({observerType:new H.sr.coding.CodedConcept({value:"121007",schemeDesignator:"DCM",meaning:"Device"}),observerIdentifyingAttributes:new H.sr.templates.DeviceObserverIdentifyingAttributes({uid:r.uid,manufacturerName:"MGH Computational Pathology",modelName:r.name})}),subjectContext:new H.sr.templates.SubjectContext({subjectClass:new H.sr.coding.CodedConcept({value:"121027",schemeDesignator:"DCM",meaning:"Specimen"}),subjectClassSpecificContext:new H.sr.templates.SubjectContextSpecimen({uid:p.SpecimenUID,identifier:p.SpecimenIdentifier,containerIdentifier:l.ContainerIdentifier})})});console.debug("encode Imaging Measurements");for(var v=[],m=0;m<i.length;m++){var f,g=i[m];if(s.has(g.uid)){var S=g.evaluations.find((function(e){return"121071"===e.ConceptNameCodeSequence[0].CodeValue}));void 0===S&&k.onError(P,new w(C,'No finding type was specified for ROI "'.concat(String(g.uid),'"')));var y=new H.sr.templates.TrackingIdentifier({uid:null!==(f=g.properties.trackingUID)&&void 0!==f?f:g.uid,identifier:"ROI #".concat(m+1)}),I=new H.sr.templates.PlanarROIMeasurementsAndQualitativeEvaluations({trackingIdentifier:y,referencedRegion:new H.sr.contentItems.ImageRegion3D({graphicType:g.scoord3d.graphicType,graphicData:g.scoord3d.graphicData,frameOfReferenceUID:g.scoord3d.frameOfReferenceUID}),findingType:new H.sr.coding.CodedConcept({value:S.ConceptCodeSequence[0].CodeValue,schemeDesignator:S.ConceptCodeSequence[0].CodingSchemeDesignator,meaning:S.ConceptCodeSequence[0].CodeMeaning}),qualitativeEvaluations:g.evaluations.filter((function(e){return"121071"!==e.ConceptNameCodeSequence[0].CodeValue})),measurements:g.measurements});I[0].ContentTemplateSequence=[{MappingResource:"DCMR",TemplateIdentifier:"1410"}],v.push.apply(v,(0,X.Z)(I))}}console.debug("create Measurement Report document content");var D=new H.sr.templates.MeasurementReport({languageOfContentItemAndDescendants:new H.sr.templates.LanguageOfContentItemAndDescendants({}),observationContext:h,procedureReported:new H.sr.coding.CodedConcept({value:"112703",schemeDesignator:"DCM",meaning:"Whole Slide Imaging"}),imagingMeasurements:v});return console.info("create Comprehensive 3D SR document"),{isReportModalVisible:!0,generatedReport:new H.sr.documents.Comprehensive3DSR({content:D[0],evidence:[l],seriesInstanceUID:H.aT.DicomMetaDictionary.uid(),seriesNumber:1,seriesDescription:"Annotation",sopInstanceUID:H.aT.DicomMetaDictionary.uid(),instanceNumber:1,manufacturer:"MGH Computational Pathology",previousVersions:void 0})}};var nt;!function(e){e[e.DEBUG=0]="DEBUG",e[e.LOG=1]="LOG",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e[e.NONE=4]="NONE"}(nt||(nt={}));var it=new(function(){function e(){var t;(0,i.Z)(this,e),this.config=void 0;var n=null===(t=window.config)||void 0===t?void 0:t.logger,o="DEBUG";o=null!=(null===n||void 0===n?void 0:n.level)&&""!==String(n.level)?n.level:"ERROR",this.config={level:this.parseLogLevel(o),enableInProduction:Boolean(null===n||void 0===n?void 0:n.enableInProduction),enableInDevelopment:!1!==(null===n||void 0===n?void 0:n.enableInDevelopment)}}return(0,o.Z)(e,[{key:"parseLogLevel",value:function(e){switch(e.toUpperCase()){case"DEBUG":default:return nt.DEBUG;case"LOG":return nt.LOG;case"WARN":return nt.WARN;case"ERROR":return nt.ERROR;case"NONE":return nt.NONE}}},{key:"configure",value:function(e){this.config=(0,re.Z)((0,re.Z)({},this.config),e)}},{key:"shouldLog",value:function(e){return!(e<this.config.level)&&this.config.enableInProduction}},{key:"debug",value:function(){var e;this.shouldLog(nt.DEBUG)&&(e=console).debug.apply(e,arguments)}},{key:"log",value:function(){var e;this.shouldLog(nt.LOG)&&(e=console).log.apply(e,arguments)}},{key:"warn",value:function(){var e;this.shouldLog(nt.WARN)&&(e=console).warn.apply(e,arguments)}},{key:"error",value:function(){var e;this.shouldLog(nt.ERROR)&&(e=console).error.apply(e,arguments)}}]),e}()),ot=function(e){return void 0!==e&&null!==e},at=function(e){var t=Math.max(0,Math.min(255,Math.round(e[0]))),n=Math.max(0,Math.min(255,Math.round(e[1]))),i=Math.max(0,Math.min(255,Math.round(e[2])));return"#".concat((16777216+(t<<16)+(n<<8)+i).toString(16).slice(1))},rt=function(e,t){var n=function(e,t){try{if(void 0!==e.SegmentSequence&&Array.isArray(e.SegmentSequence)){var n=e.SegmentSequence.find((function(e){return e.SegmentNumber===t}));if(ot(n)&&ot(n.RecommendedDisplayCIELabValue)&&Array.isArray(n.RecommendedDisplayCIELabValue)){var i=n.RecommendedDisplayCIELabValue;if(i.length>=3)try{var o=H.ZP.data.Colors.dicomlab2RGB(i);return[Math.max(0,Math.min(255,Math.round(255*o[0]))),Math.max(0,Math.min(255,Math.round(255*o[1]))),Math.max(0,Math.min(255,Math.round(255*o[2])))]}catch(a){return console.warn("Failed to convert CIELab to RGB using dcmjs:",a),null}}}}catch(a){console.warn("Failed to extract color from segment ".concat(t,":"),a)}return null}(e,t);return null!==n?n:null},st=function(e){return void 0!==(null===e||void 0===e?void 0:e.SegmentationType)&&null!==(null===e||void 0===e?void 0:e.SegmentationType)?e.SegmentationType:"BINARY"},lt=function(e){var t=e.content,n=e.name,i=[];return t.forEach((function(e){(function(e,t){var n=e.ConceptNameCodeSequence[0];return n.CodeValue===t.CodeValue&&n.CodingSchemeDesignator===t.CodingSchemeDesignator})(e,n)&&i.push(e)})),i},ct=n(4925),ut=n(2414),dt=n(3020),pt=n(7309),ht=n(5594),vt=n(6272);const mt=function(e){var t=e.color,n=e.onChange,i=(0,u.useCallback)((function(e,i){if(null!==i){var o=(0,X.Z)(t);o[e]=i,n(o)}}),[t,n]),o=(0,u.useCallback)((function(e){return function(t){return i(e,t)}}),[i]);return(0,se.jsx)(se.Fragment,{children:["Red","Green","Blue"].map((function(e,n){return(0,se.jsxs)(je.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,se.jsx)(Ae.Z,{span:5,children:e}),(0,se.jsx)(Ae.Z,{span:14,children:(0,se.jsx)(vt.Z,{range:!1,min:0,max:255,step:1,value:t[n],onChange:o(n)})}),(0,se.jsx)(Ae.Z,{span:5,children:(0,se.jsx)(ke.Z,{min:0,max:255,size:"small",style:{width:"65px"},value:t[n],onChange:o(n)})})]},e)}))})};const ft=function(e){var t=e.opacity,n=e.onChange,i=e.label,o=void 0===i?"Opacity":i;return(0,se.jsxs)(je.Z,{justify:"center",align:"middle",children:[(0,se.jsx)(Ae.Z,{span:6,children:o}),(0,se.jsx)(Ae.Z,{span:12,children:(0,se.jsx)(vt.Z,{range:!1,min:0,max:1,step:.01,value:t,onChange:n})}),(0,se.jsx)(Ae.Z,{span:6,children:(0,se.jsx)(ke.Z,{min:0,max:1,size:"small",step:.1,style:{width:"65px"},value:t,onChange:n})})]})};var gt=["annotationGroup","defaultStyle","isVisible","metadata","onVisibilityChange","onStyleChange","onAnnotationGroupClick"];function St(e){var t=e.isVisible,n=e.onVisibilityChange,i=e.settings,o=e.color;return(0,se.jsxs)(Ee.Z,{direction:"vertical",align:"center",children:[(0,se.jsx)(Te.Z,{size:"small",onChange:n,checked:t,checkedChildren:(0,se.jsx)(d.dSq,{}),unCheckedChildren:(0,se.jsx)(d.tgn,{})}),(0,se.jsx)(dt.Z,{placement:"left",content:i,overlayStyle:{width:"350px"},title:"Display Settings",children:(0,se.jsx)(pt.Z,{type:"primary",shape:"circle",icon:(0,se.jsx)(ut.Z,{})})}),(0,se.jsx)("div",{style:{width:"20px",height:"20px",backgroundColor:at(o),border:"1px solid #d9d9d9",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center"},title:"Annotation group color: ".concat(at(o))})]})}function yt(e){var t=e.annotationGroup,n=e.onClick,i=e.isBadgeVisible,o=e.color,a=e.label,r=e.attributes,s=(0,u.useCallback)((function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),n())}),[n]);return(0,se.jsx)("button",{type:"button",onClick:n,onKeyDown:s,"aria-label":"Annotation group ".concat(a),style:{background:"none",border:"none",padding:0,cursor:"pointer",textAlign:"left",width:"100%"},children:(0,se.jsxs)(ht.Z,{offset:[-20,20],count:" ",style:{borderStyle:"solid",borderWidth:"1px",borderColor:"gray",visibility:i?"visible":"hidden",backgroundImage:"linear-gradient(to bottom, ".concat(o,", ").concat(o)},children:[(0,se.jsx)(xe,{annotationGroup:t,style:{padding:"0.3rem"}}),(0,se.jsx)(he,{header:a,attributes:r,selectable:!0,hasLongValues:!0})]})})}const It=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var o;return(0,i.Z)(this,n),(o=t.call(this,e)).handleVisibilityChange=function(e,t){o.props.onVisibilityChange({annotationGroupUID:o.props.annotationGroup.uid,isVisible:e}),o.setState({isVisible:e})},o.handleColorChange=function(e){o.setState((function(t){return{currentStyle:{color:e,opacity:t.currentStyle.opacity,limitValues:t.currentStyle.limitValues}}})),o.props.onStyleChange({uid:o.props.annotationGroup.uid,styleOptions:{color:e}})},o.handleOpacityChange=function(e){null!==e&&(o.props.onStyleChange({uid:o.props.annotationGroup.uid,styleOptions:{opacity:e}}),o.setState({currentStyle:{opacity:e,color:o.state.currentStyle.color,limitValues:o.state.currentStyle.limitValues}}))},o.getCurrentColor=function(){return null!==o.state.currentStyle.color&&void 0!==o.state.currentStyle.color?function(e){var t=e[0],n=e[1],i=e[2];return"#".concat((16777216+(t<<16)+(n<<8)+i).toString(16).slice(1))}(o.state.currentStyle.color):"white"},o.handleLowerLimitChange=function(e){null!==e&&void 0!==e&&void 0!==o.state.currentStyle.limitValues&&(o.setState((function(t){return void 0!==t.currentStyle.limitValues?{currentStyle:{color:t.currentStyle.color,opacity:t.currentStyle.opacity,limitValues:[e,t.currentStyle.limitValues[1]]}}:{currentStyle:{color:t.currentStyle.color,opacity:t.currentStyle.opacity,limitValues:t.currentStyle.limitValues}}})),o.props.onStyleChange({uid:o.props.annotationGroup.uid,styleOptions:{limitValues:[e,o.state.currentStyle.limitValues[1]]}}))},o.handleUpperLimitChange=function(e){null!==e&&void 0!==e&&void 0!==o.state.currentStyle.limitValues&&(o.setState((function(t){return void 0!==t.currentStyle.limitValues?{currentStyle:{color:t.currentStyle.color,opacity:t.currentStyle.opacity,limitValues:[t.currentStyle.limitValues[0],e]}}:{currentStyle:{color:t.currentStyle.color,opacity:t.currentStyle.opacity,limitValues:t.currentStyle.limitValues}}})),o.props.onStyleChange({uid:o.props.annotationGroup.uid,styleOptions:{limitValues:[o.state.currentStyle.limitValues[0],e]}}))},o.handleLimitChange=function(e){o.setState((function(t){return{currentStyle:{color:t.currentStyle.color,opacity:t.currentStyle.opacity,limitValues:e}}})),o.props.onStyleChange({uid:o.props.annotationGroup.uid,styleOptions:{limitValues:e}})},o.handleAnnotationGroupClick=function(){o.props.onAnnotationGroupClick(o.props.annotationGroup.uid)},o.handleMeasurementSelection=function(e,t){if(null!==e&&void 0!==e&&null!==t&&void 0!==t&&Array.isArray(t)&&t.length>0&&null!==t[0]&&void 0!==t[0]&&null!==t[0].children&&void 0!==t[0].children){var n=e.split("-"),i=new H.sr.coding.CodedConcept({value:n[1],schemeDesignator:n[0],meaning:Array.isArray(t[0].children)?String(t[0].children[0]):String(t[0].children)});o.props.onStyleChange({uid:o.props.annotationGroup.uid,styleOptions:{measurement:i}}),o.setState((function(e){return{currentStyle:{opacity:e.currentStyle.opacity,measurement:i}}}))}else o.props.onStyleChange({uid:o.props.annotationGroup.uid,styleOptions:{color:o.props.defaultStyle.color}}),o.setState((function(e){return{currentStyle:{opacity:e.currentStyle.opacity,color:o.props.defaultStyle.color,limitValues:void 0}}}))},o.state={isVisible:o.props.isVisible,currentStyle:{opacity:o.props.defaultStyle.opacity,color:o.props.defaultStyle.color}},o}return(0,o.Z)(n,[{key:"render",value:function(){var e,t,n,i,o,a=this,r=this.props.metadata.AnnotationGroupSequence.findIndex((function(e){return e.AnnotationGroupUID===a.props.annotationGroup.uid})),s=this.props.metadata.AnnotationGroupSequence[r],l=[{name:"Property type",value:this.props.annotationGroup.propertyType.CodeMeaning},{name:"Property category",value:this.props.annotationGroup.propertyCategory.CodeMeaning},{name:"Graphic type",value:s.GraphicType},{name:"Annotation coordinate type",value:this.props.metadata.AnnotationCoordinateType}],c=null!==(e=s.MeasurementsSequence)&&void 0!==e?e:[],u=c.map((function(e){var t=e.ConceptNameCodeSequence[0],n="".concat(t.CodingSchemeDesignator,"-").concat(t.CodeValue);return(0,se.jsx)(Pe.Z.Option,{value:n,dropdownMatchSelectWidth:!1,size:"small",disabled:!a.props.isVisible,children:t.CodeMeaning},n)}));if(u.push((0,se.jsx)(Pe.Z.Option,{value:void 0,dropdownMatchSelectWidth:!1,size:"small",disabled:!this.props.isVisible,children:null},"-")),null!==this.state.currentStyle.color&&void 0!==this.state.currentStyle.color&&3===this.state.currentStyle.color.length&&(n=(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)(Le.Z,{plain:!0,children:"Color"}),(0,se.jsx)(mt,{color:this.state.currentStyle.color,onChange:this.handleColorChange}),(0,se.jsx)(Le.Z,{plain:!0})]})),c.length>0){if(null!==this.state.currentStyle.limitValues&&void 0!==this.state.currentStyle.limitValues){i=(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)(Le.Z,{plain:!0,children:"Values of interest"}),(0,se.jsxs)(je.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,se.jsx)(Ae.Z,{span:6,children:(0,se.jsx)(ke.Z,{min:0,max:this.state.currentStyle.limitValues[1],size:"small",style:{width:"75px"},value:this.state.currentStyle.limitValues[0],onChange:this.handleLowerLimitChange})}),(0,se.jsx)(Ae.Z,{span:12,children:(0,se.jsx)(vt.Z,{range:!0,min:0,max:1e3,step:1,value:[this.state.currentStyle.limitValues[0],this.state.currentStyle.limitValues[1]],onChange:this.handleLimitChange})}),(0,se.jsx)(Ae.Z,{span:6,children:(0,se.jsx)(ke.Z,{min:this.state.currentStyle.limitValues[0],max:1e3,size:"small",style:{width:"75px"},value:this.state.currentStyle.limitValues[1],onChange:this.handleUpperLimitChange})})]})]})}o=(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)(Le.Z,{plain:!0,children:"Exploration"}),(0,se.jsxs)(je.Z,{justify:"start",align:"middle",gutter:[8,8],children:[(0,se.jsx)(Ae.Z,{span:8,children:"Measurement"}),(0,se.jsx)(Ae.Z,{span:16,children:(0,se.jsx)(Pe.Z,{style:{minWidth:"65px",width:"90%"},onSelect:this.handleMeasurementSelection,defaultValue:void 0,children:u},"annotation-group-measurements")})]})]})}var d=(0,se.jsxs)("div",{children:[n,i,(0,se.jsx)(ft,{opacity:this.state.currentStyle.opacity,onChange:this.handleOpacityChange}),o]}),p=this.getCurrentColor(),h=this.state.isVisible&&null===this.state.currentStyle.measurement,v=this.props,m=(v.annotationGroup,v.defaultStyle,v.isVisible,v.metadata,v.onVisibilityChange,v.onStyleChange,v.onAnnotationGroupClick,(0,ct.Z)(v,gt));return(0,se.jsx)(B.Z.Item,(0,re.Z)((0,re.Z)({style:{height:"100%",paddingLeft:"3px"}},m),{},{children:(0,se.jsxs)(Ee.Z,{align:"start",children:[(0,se.jsx)("div",{style:{paddingLeft:"14px"},children:(0,se.jsx)(St,{isVisible:this.props.isVisible,onVisibilityChange:this.handleVisibilityChange,settings:d,color:null!==(t=this.state.currentStyle.color)&&void 0!==t?t:[255,255,255]})}),(0,se.jsx)(yt,{onClick:this.handleAnnotationGroupClick,annotationGroup:this.props.annotationGroup,isBadgeVisible:h,color:p,label:this.props.annotationGroup.label,attributes:l})]})}),this.props.annotationGroup.uid)}}]),n}(u.Component);const Ct=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;(0,i.Z)(this,n);for(var o=arguments.length,a=new Array(o),r=0;r<o;r++)a[r]=arguments[r];return(e=t.call.apply(t,[this].concat(a))).handleVisibilityChange=function(t){t?e.props.annotationGroups.forEach((function(n){e.props.onAnnotationGroupVisibilityChange({annotationGroupUID:n.uid,isVisible:t})})):e.props.visibleAnnotationGroupUIDs.forEach((function(n){e.props.onAnnotationGroupVisibilityChange({annotationGroupUID:n,isVisible:t})}))},e}return(0,o.Z)(n,[{key:"render",value:function(){var e=this,t=this.props.annotationGroups.map((function(t,n){var i=t.uid;return(0,se.jsx)(It,{annotationGroup:t,onAnnotationGroupClick:e.props.onAnnotationGroupClick,metadata:e.props.metadata[i],isVisible:e.props.visibleAnnotationGroupUIDs.has(i),defaultStyle:e.props.defaultAnnotationGroupStyles[i],onVisibilityChange:e.props.onAnnotationGroupVisibilityChange,onStyleChange:e.props.onAnnotationGroupStyleChange},t.uid)}));return(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)("div",{style:{paddingLeft:"14px",paddingTop:"7px",paddingBottom:"7px"},children:(0,se.jsx)(Te.Z,{size:"small",onChange:this.handleVisibilityChange,checked:this.props.visibleAnnotationGroupUIDs.size>0,checkedChildren:(0,se.jsx)(d.dSq,{}),unCheckedChildren:(0,se.jsx)(d.tgn,{})})}),(0,se.jsx)(B.Z,{selectable:!1,children:t})]})}}]),n}(u.Component);var bt=["isVisible","onVisibilityChange"];const wt=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var o;return(0,i.Z)(this,n),(o=t.call(this,e)).handleVisibilityChange=o.handleVisibilityChange.bind((0,a.Z)(o)),o}return(0,o.Z)(n,[{key:"handleVisibilityChange",value:function(e,t){this.props.onVisibilityChange({roiUID:this.props.roi.uid,isVisible:e})}},{key:"render",value:function(){var e="ROI ".concat(this.props.index+1),t=[],n=this.props,i=(n.isVisible,n.onVisibilityChange,(0,ct.Z)(n,bt));return this.props.roi.evaluations.forEach((function(e){var n=e.ConceptNameCodeSequence[0].CodeValue,i=e.ConceptNameCodeSequence[0].CodeMeaning,o="".concat(i);if(e.ValueType===H.sr.valueTypes.ValueTypes.CODE){var a=e.ConceptCodeSequence[0].CodeMeaning;"276214006"===n?t.push({name:"Property category",value:"".concat(a)}):"121071"===n?t.push({name:"Property type",value:"".concat(a)}):"111001"===n?t.push({name:"Algorithm Name",value:"".concat(a)}):t.push({name:o,value:"".concat(a)})}else if(e.ValueType===H.sr.valueTypes.ValueTypes.TEXT){var r=e;t.push({name:o,value:r.TextValue})}})),this.props.roi.measurements.forEach((function(e){var n=e.ConceptNameCodeSequence[0].CodeMeaning,i="".concat(n),o=e.MeasuredValueSequence[0],a=o.NumericValue.toPrecision(6),r=o.MeasurementUnitsCodeSequence[0].CodeValue;t.push({name:i,value:"".concat(a," ").concat(r)})})),(0,se.jsxs)(Ee.Z,{align:"start",children:[(0,se.jsx)("div",{style:{paddingLeft:"14px"},children:(0,se.jsx)(Te.Z,{size:"small",onChange:this.handleVisibilityChange,checked:this.props.isVisible,checkedChildren:(0,se.jsx)(d.dSq,{}),unCheckedChildren:(0,se.jsx)(d.tgn,{})})}),(0,se.jsx)(B.Z.Item,(0,re.Z)((0,re.Z)({style:{height:"100%",paddingLeft:"3px"}},i),{},{children:(0,se.jsx)(he,{header:e,attributes:t,selectable:!0,hasLongValues:!0})}),this.props.roi.uid)]})}}]),n}(u.Component);const Dt=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var o;return(0,i.Z)(this,n),(o=t.call(this,e)).handleMenuItemSelection=o.handleMenuItemSelection.bind((0,a.Z)(o)),o.handleVisibilityChange=o.handleVisibilityChange.bind((0,a.Z)(o)),o}return(0,o.Z)(n,[{key:"handleVisibilityChange",value:function(e,t){var n=this;e?this.props.rois.forEach((function(t){n.props.onVisibilityChange({roiUID:t.uid,isVisible:e})})):this.props.visibleRoiUIDs.forEach((function(t){n.props.onVisibilityChange({roiUID:t,isVisible:e})}))}},{key:"handleMenuItemSelection",value:function(e){this.props.onSelection(e.key)}},{key:"render",value:function(){var e=this,t=this.props.rois.map((function(t,n){return(0,se.jsx)(wt,{roi:t,index:n,isVisible:e.props.visibleRoiUIDs.has(t.uid),onVisibilityChange:e.props.onVisibilityChange},t.uid)}));return(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)("div",{style:{paddingLeft:"14px",paddingTop:"7px",paddingBottom:"7px"},children:(0,se.jsx)(Te.Z,{size:"small",onChange:this.handleVisibilityChange,checked:this.props.visibleRoiUIDs.size>0,checkedChildren:(0,se.jsx)(d.dSq,{}),unCheckedChildren:(0,se.jsx)(d.tgn,{})})}),(0,se.jsx)(B.Z,{selectedKeys:(0,X.Z)(this.props.selectedRoiUIDs.values()),onSelect:this.handleMenuItemSelection,onClick:this.handleMenuItemSelection,children:t})]})}}]),n}(u.Component);const xt=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var o;return(0,i.Z)(this,n),(o=t.call(this,e)).handleClick=o.handleClick.bind((0,a.Z)(o)),o}return(0,o.Z)(n,[{key:"handleClick",value:function(e){void 0!==this.props.onClick&&this.props.onClick(e)}},{key:"render",value:function(){var e,t,n,i=this.props.icon;return void 0===i?null:(null!=this.props.label&&(t=(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)(Le.Z,{type:"vertical"}),this.props.label]})),n=null!==(e=this.props.isSelected)&&void 0!==e&&e?(0,se.jsx)(pt.Z,{onClick:this.handleClick,icon:(0,se.jsx)(i,{}),type:"primary",style:{lineHeight:"1.0"},children:t}):(0,se.jsx)(pt.Z,{onClick:this.handleClick,icon:(0,se.jsx)(i,{}),type:"default",style:{lineHeight:"1.0"},children:t}),void 0!==this.props.tooltip?(0,se.jsx)(Ie.Z,{title:this.props.tooltip,children:n}):n)}}]),n}(u.Component);const Vt=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,o.Z)(n,[{key:"render",value:function(){if(void 0===this.props.metadata)return null;var e=[{name:"Manufacturer",value:this.props.metadata.Manufacturer},{name:"Model Name",value:this.props.metadata.ManufacturerModelName},{name:"Device Serial Number",value:this.props.metadata.DeviceSerialNumber},{name:"Software Versions",value:this.props.metadata.SoftwareVersions}];return null!=this.props.metadata.InstitutionName&&e.push({name:"Institution Name",value:this.props.metadata.InstitutionName}),(0,se.jsx)(he,{attributes:e,hasLongValues:!0})}}]),n}(u.Component);const Mt=function(e){var t=e.xPosition,n=e.yPosition,i=e.rois.reduce((function(e,t){var n=null!==t.seriesDescription&&void 0!==t.seriesDescription&&""!==t.seriesDescription?t.seriesDescription:"Unknown Series";return void 0===e[n]&&(e[n]=[]),e[n].push(t),e}),{}),o={position:"fixed",top:"".concat(n,"px"),left:"".concat(t,"px"),backgroundColor:"rgba(230, 230, 230, 0.95)",padding:"10px",fontWeight:"bold",pointerEvents:"none",borderRadius:"4px",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.15)",zIndex:1e4};return(0,se.jsx)("div",{style:(0,re.Z)((0,re.Z)({},o),{},{minWidth:"200px",maxWidth:"400px"}),children:Object.entries(i).map((function(e,t){var n=(0,F.Z)(e,2),i=n[0],o=n[1];return(0,se.jsxs)("div",{style:{marginBottom:t>0?"12px":"0"},children:[t>0&&(0,se.jsx)("hr",{style:{margin:"10px 0",border:"none",borderTop:"1px solid rgba(0, 0, 0, 0.2)"}}),(0,se.jsx)("div",{style:{fontSize:"13px",fontWeight:"bold",color:"rgba(0, 0, 0, 0.8)",marginBottom:"8px",paddingBottom:"4px",borderBottom:"1px solid rgba(0, 0, 0, 0.15)"},children:i}),(0,se.jsx)("div",{style:{marginLeft:"4px"},children:o.map((function(e,t){var n=e.attributes.find((function(e){return"Annotation Group Label"===e.name})),i=e.attributes.filter((function(e){return"Series Description"!==e.name&&"Annotation Group Label"!==e.name}));return(0,se.jsxs)("div",{style:{marginBottom:t<o.length-1?"6px":"0",fontSize:"12px"},children:[(0,se.jsxs)("div",{style:{fontWeight:"bold"},children:["ROI ",e.index,null!==n&&void 0!==n&&(0,se.jsxs)("span",{style:{fontWeight:500,marginLeft:"6px",color:"rgba(0, 0, 0, 0.7)"},children:["- ",n.value]})]}),i.length>0&&(0,se.jsx)("div",{style:{marginLeft:"12px",fontSize:"11px",color:"rgba(0, 0, 0, 0.8)",marginTop:"2px"},children:i.map((function(t){return(0,se.jsxs)("div",{children:[t.name,":"," ",(0,se.jsx)("span",{style:{fontWeight:500},children:t.value})]},"".concat(String(t.name),"-").concat(String(e.roiUid)))}))})]},e.roiUid)}))})]},i)}))})};var Rt=["defaultStyle","isVisible","mapping","metadata","onVisibilityChange","onStyleChange"];const Ot=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var o;return(0,i.Z)(this,n),(o=t.call(this,e)).handleVisibilityChange=function(e,t){o.props.onVisibilityChange({mappingUID:o.props.mapping.uid,isVisible:e}),o.setState({isVisible:e})},o.handleOpacityChange=function(e){null!==e&&(o.props.onStyleChange({mappingUID:o.props.mapping.uid,styleOptions:{opacity:e}}),o.setState((function(t){return{currentStyle:{opacity:e}}})))},o.state={isVisible:o.props.isVisible,currentStyle:{opacity:o.props.defaultStyle.opacity}},o}return(0,o.Z)(n,[{key:"render",value:function(){var e=[{name:"Description",value:this.props.mapping.description}],t=(0,se.jsx)("div",{children:(0,se.jsx)(ft,{opacity:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})}),n=this.props,i=(n.defaultStyle,n.isVisible,n.mapping,n.metadata,n.onVisibilityChange,n.onStyleChange,(0,ct.Z)(n,Rt));return(0,se.jsx)(B.Z.Item,(0,re.Z)((0,re.Z)({style:{height:"100%",paddingLeft:"3px"}},i),{},{children:(0,se.jsxs)(Ee.Z,{align:"start",children:[(0,se.jsx)("div",{style:{paddingLeft:"14px"},children:(0,se.jsx)(Ee.Z,{direction:"vertical",align:"end",size:100,children:(0,se.jsxs)(Ee.Z,{direction:"vertical",align:"end",children:[(0,se.jsx)(Te.Z,{size:"small",onChange:this.handleVisibilityChange,checked:this.props.isVisible,checkedChildren:(0,se.jsx)(d.dSq,{}),unCheckedChildren:(0,se.jsx)(d.tgn,{})}),(0,se.jsx)(dt.Z,{placement:"left",content:t,overlayStyle:{width:"350px"},title:"Display Settings",children:(0,se.jsx)(pt.Z,{type:"primary",shape:"circle",icon:(0,se.jsx)(ut.Z,{})})})]})})}),(0,se.jsx)(he,{header:this.props.mapping.label,attributes:e,selectable:!0,hasLongValues:!0})]})}),this.props.mapping.uid)}}]),n}(u.Component);const Zt=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,o.Z)(n,[{key:"render",value:function(){var e=this,t=this.props.mappings.map((function(t,n){var i=t.uid;return(0,se.jsx)(Ot,{mapping:t,metadata:e.props.metadata[i],isVisible:e.props.visibleMappingUIDs.has(i),defaultStyle:e.props.defaultMappingStyles[i],onVisibilityChange:e.props.onMappingVisibilityChange,onStyleChange:e.props.onMappingStyleChange},t.uid)}));return(0,se.jsx)(B.Z,{selectable:!1,children:t})}}]),n}(u.Component);var Pt=n(681),Ut=n(2622),Et=n(4215),jt=n(8272),At=(new H.sr.coding.CodedConcept({value:"17636008",schemeDesignator:"SCT",meaning:"Specimen collection"}),new H.sr.coding.CodedConcept({value:"433465004",schemeDesignator:"SCT",meaning:"Sampling of tissue specimen"}),new H.sr.coding.CodedConcept({value:"127790008",schemeDesignator:"SCT",meaning:"Specimen staining"}),new H.sr.coding.CodedConcept({value:"9265001",schemeDesignator:"SCT",meaning:"Specimen processing"}),{FIXATIVE:new H.sr.coding.CodedConcept({value:"430864009",schemeDesignator:"SCT",meaning:"Tissue fixative"}),EMBEDDING_MEDIUM:new H.sr.coding.CodedConcept({value:"430863003",schemeDesignator:"SCT",meaning:"Embedding medium"})}),Tt=(0,re.Z)({SPECIMEN_IDENTIFIER:new H.sr.coding.CodedConcept({value:"121041",schemeDesignator:"DCM",meaning:"Specimen identifier"}),PARENT_SPECIMEN_IDENTIFIER:new H.sr.coding.CodedConcept({value:"111705",schemeDesignator:"DCM",meaning:"Parent specimen identifier"}),PROCESSING_TYPE:new H.sr.coding.CodedConcept({value:"111701",schemeDesignator:"DCM",meaning:"Processing type"}),DATETIME_OF_PROCESSING:new H.sr.coding.CodedConcept({value:"111702",schemeDesignator:"DCM",meaning:"Datetime of processing"}),PROCESSING_STEP_DESCRIPTION:new H.sr.coding.CodedConcept({value:"111703",schemeDesignator:"DCM",meaning:"Processing step description"}),COLLECTION_METHOD:new H.sr.coding.CodedConcept({value:"17636008",schemeDesignator:"SCT",meaning:"Specimen collection"}),SAMPLING_METHOD:new H.sr.coding.CodedConcept({value:"111704",schemeDesignator:"DCM",meaning:"Sampling method"}),STAIN:new H.sr.coding.CodedConcept({value:"424361007",schemeDesignator:"SCT",meaning:"Using substance"})},At),kt=["defaultStyle","isRemovable","isVisible","metadata","onVisibilityChange","onStyleChange","onRemoval","opticalPath"],Lt=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var o;return(0,i.Z)(this,n),(o=t.call(this,e)).handleVisibilityChange=function(e,t){var n=o.props.opticalPath.identifier;o.setState({isVisible:e}),o.props.onVisibilityChange({opticalPathIdentifier:n,isVisible:e})},o.handleOpacityChange=function(e){if(null!=e){var t=o.props.opticalPath.identifier;o.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{opacity:e}}),o.setState((function(t){return{currentStyle:{color:t.currentStyle.color,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:e,limitValues:t.currentStyle.limitValues}}}))}},o.handleColorChange=function(e){var t=o.props.opticalPath.identifier;o.setState((function(t){return{currentStyle:{color:e,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:t.currentStyle.opacity,limitValues:t.currentStyle.limitValues}}})),o.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{color:e}})},o.getCurrentColors=function(){var e=function(e){var t=e[0],n=e[1],i=e[2];return"#".concat((16777216+(t<<16)+(n<<8)+i).toString(16).slice(1))};return null!=o.props.defaultStyle.paletteColorLookupTable?o.props.defaultStyle.paletteColorLookupTable.data.map((function(t){return e(t)})):null!=o.state.currentStyle.color?["#000000",e(o.state.currentStyle.color)]:["white","white"]},o.handleLowerLimitChange=function(e){var t=o.props.opticalPath.identifier;null!=e&&void 0!==o.state.currentStyle.limitValues&&(o.setState((function(t){return void 0!==t.currentStyle.limitValues?{currentStyle:{color:t.currentStyle.color,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:t.currentStyle.opacity,limitValues:[e,t.currentStyle.limitValues[1]]}}:{currentStyle:{color:t.currentStyle.color,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:t.currentStyle.opacity,limitValues:t.currentStyle.limitValues}}})),o.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{limitValues:[e,o.state.currentStyle.limitValues[1]]}}))},o.handleUpperLimitChange=function(e){var t=o.props.opticalPath.identifier;null!=e&&void 0!==o.state.currentStyle.limitValues&&(o.setState((function(t){return void 0!==t.currentStyle.limitValues?{currentStyle:{color:t.currentStyle.color,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:t.currentStyle.opacity,limitValues:[t.currentStyle.limitValues[0],e]}}:{currentStyle:{color:t.currentStyle.color,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:t.currentStyle.opacity,limitValues:t.currentStyle.limitValues}}})),o.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{limitValues:[o.state.currentStyle.limitValues[0],e]}}))},o.handleLimitChange=function(e){var t=o.props.opticalPath.identifier;o.setState((function(t){return{currentStyle:{color:t.currentStyle.color,paletteColorLookupTable:t.currentStyle.paletteColorLookupTable,opacity:t.currentStyle.opacity,limitValues:e}}})),o.props.onStyleChange({opticalPathIdentifier:t,styleOptions:{limitValues:e}})},o.handleRemoval=function(){var e=o.props.opticalPath.identifier;o.props.onRemoval(e)},o.state={isVisible:o.props.isVisible,currentStyle:{opacity:o.props.defaultStyle.opacity,color:o.props.defaultStyle.color,paletteColorLookupTable:o.props.defaultStyle.paletteColorLookupTable,limitValues:o.props.defaultStyle.limitValues}},o}return(0,o.Z)(n,[{key:"componentDidUpdate",value:function(e,t){this.props.defaultStyle!==e.defaultStyle&&this.setState({currentStyle:this.props.defaultStyle})}},{key:"render",value:function(){var e,t=this.props.opticalPath.identifier,n=this.props.opticalPath.description,i=[];void 0!==this.props.opticalPath.illuminationWaveLength&&i.push({name:"Illumination wavelength",value:"".concat(this.props.opticalPath.illuminationWaveLength," nm")}),void 0!==this.props.opticalPath.illuminationColor&&i.push({name:"Illumination color",value:this.props.opticalPath.illuminationColor.CodeMeaning});var o=null!==(e=this.props.metadata[0].SpecimenDescriptionSequence)&&void 0!==e?e:[];try{o.forEach((function(e){var t;(null!==(t=e.SpecimenPreparationSequence)&&void 0!==t?t:[]).forEach((function(e,t){e.SpecimenPreparationStepContentItemSequence.forEach((function(e,t){var n=new H.sr.coding.CodedConcept({value:e.ConceptNameCodeSequence[0].CodeValue,schemeDesignator:e.ConceptNameCodeSequence[0].CodingSchemeDesignator,meaning:e.ConceptNameCodeSequence[0].CodeMeaning});if(e.ValueType===H.sr.valueTypes.ValueTypes.CODE){var o=new H.sr.coding.CodedConcept({value:e.ConceptCodeSequence[0].CodeValue,schemeDesignator:e.ConceptCodeSequence[0].CodingSchemeDesignator,meaning:e.ConceptCodeSequence[0].CodeMeaning});n.equals(Tt.PROCESSING_TYPE)||n.equals(Tt.STAIN)&&i.push({name:"Tissue stain",value:o.CodeMeaning})}else e.ValueType===H.sr.valueTypes.ValueTypes.TEXT&&(n.equals(Tt.PROCESSING_TYPE)||n.equals(Tt.STAIN)&&i.push({name:"Tissue stain",value:e.TextValue}))}))}))}))}catch(m){k.onError(Z,new w(C,m instanceof Error?m.message:String(m)))}var a,r,s=Math.pow(2,this.props.metadata[0].BitsAllocated)-1,l=null!=n?"".concat(t,": ").concat(n):t;if(this.props.opticalPath.isMonochromatic){var c,u;c=null!=this.state.currentStyle.color?(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)(Le.Z,{plain:!0,children:"Color"}),(0,se.jsx)(mt,{color:this.state.currentStyle.color,onChange:this.handleColorChange})]}):(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)(Le.Z,{plain:!0,children:"Color"}),"Custom pseudo-coloring is disabled because pixels are colorized via a provided palette color lookup table."]}),null!=this.state.currentStyle.limitValues&&(u=(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)(Le.Z,{plain:!0,children:"Values of interest"}),(0,se.jsxs)(je.Z,{justify:"center",align:"middle",gutter:[8,8],children:[(0,se.jsx)(Ae.Z,{span:6,children:(0,se.jsx)(ke.Z,{min:0,max:this.state.currentStyle.limitValues[1],size:"small",style:{width:"75px"},value:this.state.currentStyle.limitValues[0],onChange:this.handleLowerLimitChange})}),(0,se.jsx)(Ae.Z,{span:12,children:(0,se.jsx)(vt.Z,{range:!0,min:0,max:s,step:1,value:[this.state.currentStyle.limitValues[0],this.state.currentStyle.limitValues[1]],onChange:this.handleLimitChange})}),(0,se.jsx)(Ae.Z,{span:6,children:(0,se.jsx)(ke.Z,{min:this.state.currentStyle.limitValues[0],max:s,size:"small",style:{width:"75px"},value:this.state.currentStyle.limitValues[1],onChange:this.handleUpperLimitChange})})]})]})),a=(0,se.jsxs)("div",{children:[u,c,(0,se.jsx)(Le.Z,{plain:!0}),(0,se.jsx)(ft,{opacity:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})]});var d=this.getCurrentColors();r=(0,se.jsx)(ht.Z,{offset:[-20,20],count:" ",style:{borderStyle:"solid",borderWidth:"1px",borderColor:"gray",visibility:this.state.isVisible?"visible":"hidden",backgroundImage:"linear-gradient(to right, ".concat(d.toString(),")")},children:(0,se.jsx)(he,{header:l,attributes:i,selectable:!0,hasLongValues:!0})})}else a=(0,se.jsx)("div",{children:(0,se.jsx)(ft,{opacity:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})}),r=(0,se.jsx)(he,{header:l,attributes:i,selectable:!0,hasLongValues:!0});var p=[];this.props.isRemovable&&p.push((0,se.jsx)(Ie.Z,{title:"Remove Optical Path",children:(0,se.jsx)(pt.Z,{type:"default",shape:"circle",icon:(0,se.jsx)(Ut.Z,{}),onClick:this.handleRemoval})}));var h=this.props,v=(h.defaultStyle,h.isRemovable,h.isVisible,h.metadata,h.onVisibilityChange,h.onStyleChange,h.onRemoval,h.opticalPath,(0,ct.Z)(h,kt));return(0,se.jsx)(B.Z.Item,(0,re.Z)((0,re.Z)({style:{height:"100%",paddingLeft:"3px"}},v),{},{children:(0,se.jsxs)(Ee.Z,{align:"start",children:[(0,se.jsx)("div",{style:{paddingLeft:"14px"},children:(0,se.jsxs)(Ee.Z,{direction:"vertical",align:"end",children:[(0,se.jsx)(Te.Z,{size:"small",checked:this.state.isVisible,onChange:this.handleVisibilityChange,checkedChildren:(0,se.jsx)(Et.Z,{}),unCheckedChildren:(0,se.jsx)(jt.Z,{})}),(0,se.jsx)(dt.Z,{placement:"left",content:a,overlayStyle:{width:"350px"},title:"Display Settings",children:(0,se.jsx)(pt.Z,{type:"primary",shape:"circle",icon:(0,se.jsx)(ut.Z,{})})}),p]})}),r]})}),this.props.opticalPath.identifier)}}]),n}(u.Component);const Nt=Lt;var _t=Pe.Z.Option;const Gt=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var o;return(0,i.Z)(this,n),(o=t.call(this,e)).state={selectedOpticalPathIdentifier:void 0},o.handleItemAddition=o.handleItemAddition.bind((0,a.Z)(o)),o.handleItemRemoval=o.handleItemRemoval.bind((0,a.Z)(o)),o.handleItemSelectionChange=o.handleItemSelectionChange.bind((0,a.Z)(o)),o}return(0,o.Z)(n,[{key:"handleItemRemoval",value:function(e){this.props.onOpticalPathActivityChange({opticalPathIdentifier:e,isActive:!1})}},{key:"handleItemSelectionChange",value:function(e){this.setState({selectedOpticalPathIdentifier:e})}},{key:"handleItemAddition",value:function(){var e=this.state.selectedOpticalPathIdentifier;void 0!==e&&(this.props.onOpticalPathActivityChange({opticalPathIdentifier:e,isActive:!0}),this.setState({selectedOpticalPathIdentifier:void 0}))}},{key:"render",value:function(){var e=this;if(void 0===this.props.metadata)return null;var t,n=this.props.opticalPaths.length>1,i=[],o=[];return this.props.opticalPaths.forEach((function(t){var a=t.identifier,r=e.props.metadata[a],s=r[0].SeriesInstanceUID;r[0].OpticalPathSequence.forEach((function(a){var l,c=a.OpticalPathIdentifier,u=a.OpticalPathDescription;t.identifier===c&&(e.props.activeOpticalPathIdentifiers.has(c)?i.push((0,se.jsx)(Nt,{opticalPath:t,metadata:r,isVisible:e.props.visibleOpticalPathIdentifiers.has(c),defaultStyle:e.props.defaultOpticalPathStyles[c],onVisibilityChange:e.props.onOpticalPathVisibilityChange,onStyleChange:e.props.onOpticalPathStyleChange,onRemoval:e.handleItemRemoval,isRemovable:n},"".concat(s,"-").concat(c))):(l=""!==u?"".concat(c," - ").concat(u):"".concat(c),o.push((0,se.jsx)(_t,{value:c,children:l},c))))}))})),n&&(t=(0,se.jsxs)(Ee.Z,{align:"center",size:20,style:{padding:"14px"},children:[(0,se.jsx)(Pe.Z,{defaultValue:"",style:{width:200},onChange:this.handleItemSelectionChange,value:this.state.selectedOpticalPathIdentifier,allowClear:!0,children:o}),(0,se.jsx)(Ie.Z,{title:"Add",children:(0,se.jsx)(pt.Z,{icon:(0,se.jsx)(Pt.Z,{}),type:"primary",onClick:this.handleItemAddition})})]})),(0,se.jsxs)(B.Z,{selectable:!1,children:[i,t]})}}]),n}(u.Component);const qt=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,o.Z)(n,[{key:"render",value:function(){var e=[{name:"Accession #",value:this.props.metadata.AccessionNumber},{name:"ID",value:this.props.metadata.StudyID},{name:"Date",value:fe(this.props.metadata.StudyDate)},{name:"Time",value:ge(this.props.metadata.StudyTime)}];return(0,se.jsx)(he,{attributes:e})}}]),n}(u.Component);var zt=function(e,t){return e.ValueType===t},Ft=function(e){var t=lt({content:e.ContentSequence,name:new H.sr.coding.CodedConcept({value:"126010",schemeDesignator:"DCM",meaning:"Imaging Measurements"})});1!==t.length&&k.onError(P,new w(C,'Content item "Imaging Measurements" not found.Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report".'));var n=t[0],i=lt({content:n.ContentSequence,name:new H.sr.coding.CodedConcept({value:"125007",schemeDesignator:"DCM",meaning:"Measurement Group"})}),o=[];return i.forEach((function(e){var t,n=[],i=e,a=lt({content:i.ContentSequence,name:new H.sr.coding.CodedConcept({value:"112040",schemeDesignator:"DCM",meaning:"Tracking Unique Identifier"})});0===a.length&&k.onError(P,new w(C,'Content item "Tracking Unique Identifier" not found. Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1410 "Planar ROI Measurements and Qualitative Evaluations".'));var r=a[0];if(0===(a=lt({content:i.ContentSequence,name:new H.sr.coding.CodedConcept({value:"121071",schemeDesignator:"DCM",meaning:"Finding"})})).length&&k.onError(P,new w(C,'Content item "Finding" not found. Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1410 "Planar ROI Measurements and Qualitative Evaluations".')),0!==(a=lt({content:i.ContentSequence,name:new H.sr.coding.CodedConcept({value:"111001",schemeDesignator:"DCM",meaning:"Algorithm Name"})})).length){var s=a[0];n.push(s),t="Device"}else t="Person";if(0!==(a=lt({content:i.ContentSequence,name:new H.sr.coding.CodedConcept({value:"111003",schemeDesignator:"DCM",meaning:"Algorithm Version"})})).length){var l=a[0];n.push(l)}0===(a=lt({content:i.ContentSequence,name:new H.sr.coding.CodedConcept({value:"111030",schemeDesignator:"DCM",meaning:"Image Region"})})).length&&k.onError(P,new w(C,'Content item "Image Region" not found. Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1410 "Planar ROI Measurements and Qualitative Evaluations".'));var c,u=a[0];if("POINT"===u.GraphicType)c=new Y.scoord3d.Point({frameOfReferenceUID:u.ReferencedFrameOfReferenceUID,coordinates:u.GraphicData});else{for(var d=[],p=0;p<u.GraphicData.length;p+=3)d.push(u.GraphicData.slice(p,p+3));if("POLYGON"===u.GraphicType)c=new Y.scoord3d.Polygon({frameOfReferenceUID:u.ReferencedFrameOfReferenceUID,coordinates:d});else if("MULTIPOINT"===u.GraphicType)c=new Y.scoord3d.MultiPoint({frameOfReferenceUID:u.ReferencedFrameOfReferenceUID,coordinates:d});else if("POLYLINE"===u.GraphicType)c=new Y.scoord3d.Polyline({frameOfReferenceUID:u.ReferencedFrameOfReferenceUID,coordinates:d});else if("ELLIPSE"===u.GraphicType)c=new Y.scoord3d.Ellipse({frameOfReferenceUID:u.ReferencedFrameOfReferenceUID,coordinates:d});else{if("ELLIPSOID"!==u.GraphicType)return void k.onError(P,new w(C,'Content item "Image Region" has unknown graphic type '+'"'.concat(u.GraphicType,'". ')+'Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1410 "Planar ROI Measurements and Qualitative Evaluations".'));c=new Y.scoord3d.Ellipsoid({frameOfReferenceUID:u.ReferencedFrameOfReferenceUID,coordinates:d})}}n.push.apply(n,(0,X.Z)(function(e){var t=e.content,n=[];return t.forEach((function(e){if(zt(e,H.sr.valueTypes.ValueTypes.CODE)){var t=e;n.push(t)}})),n}({content:i.ContentSequence})));var h=function(e){var t=e.content,n=[];return t.forEach((function(e){if(zt(e,H.sr.valueTypes.ValueTypes.NUM)){var t=e;n.push(t)}})),n}({content:i.ContentSequence}),v=new Y.roi.ROI({scoord3d:c,uid:(0,de.Z)(),properties:{trackingUID:r.UID,observerType:t,evaluations:n,measurements:h}});o.push(v)})),o},Bt=(0,o.Z)((function e(t){(0,i.Z)(this,e),this.PersonObserverName=void 0,this.PersonObserverLoginName=void 0,this.DeviceObserverUID=void 0,this.DeviceObserverName=void 0,this.SpecimenUID=void 0,this.SpecimenIdentifier=void 0,this.ContainerIdentifier=void 0,this.ROIs=[];var n=lt({content:t.ContentSequence,name:new H.sr.coding.CodedConcept({value:"121039",schemeDesignator:"DCM",meaning:"Specimen UID"})});0===n.length&&k.onError(P,new w(C,'Content item "Specimen UID" not found. Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1001 "Observation Context" -> TID 1006 "Subject Context" -> TID 1009 "Subject Context, Specimen".'));var o=n[0];this.SpecimenUID=o.UID,0===(n=lt({content:t.ContentSequence,name:new H.sr.coding.CodedConcept({value:"121041",schemeDesignator:"DCM",meaning:"Specimen Identifier"})})).length&&k.onError(P,new w(C,'Content item "Specimen Identifier" not found. Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1001 "Observation Context" -> TID 1006 "Subject Context" -> TID 1009 "Subject Context, Specimen".'));var a=n[0];this.SpecimenIdentifier=a.TextValue,0===(n=lt({content:t.ContentSequence,name:new H.sr.coding.CodedConcept({value:"111700",schemeDesignator:"DCM",meaning:"Specimen Container Identifier"})})).length&&k.onError(P,new w(C,'Content item "Specimen Container Identifier" not found. Content of Comprehensive 3D SR document is not structured based on TID 1500 "Measurement Report" -> TID 1001 "Observation Context" -> TID 1006 "Subject Context" -> TID 1009 "Subject Context, Specimen".'));var r=n[0];if(this.ContainerIdentifier=r.TextValue,0!==(n=lt({content:t.ContentSequence,name:new H.sr.coding.CodedConcept({value:"121008",schemeDesignator:"DCM",meaning:"Person Observer Name"})})).length){var s=n[0];this.PersonObserverName=s.PersonName}if(0!==(n=lt({content:t.ContentSequence,name:new H.sr.coding.CodedConcept({value:"128774",schemeDesignator:"DCM",meaning:"Person Observer's Login Name"})})).length){var l=n[0];this.PersonObserverLoginName=l.TextValue}if((n=lt({content:t.ContentSequence,name:new H.sr.coding.CodedConcept({value:"121012",schemeDesignator:"DCM",meaning:"Device Observer UID"})})).length>0){var c=n[0];this.DeviceObserverUID=c.UID}if(0!==(n=lt({content:t.ContentSequence,name:new H.sr.coding.CodedConcept({value:"121013",schemeDesignator:"DCM",meaning:"Device Observer Name"})})).length){var u=n[0];this.DeviceObserverName=u.TextValue}this.ROIs=Ft(t)}));const Ht=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,o.Z)(n,[{key:"render",value:function(){var e=new Bt(this.props.dataset),t=[{name:"ID",value:e.ContainerIdentifier}],n=[{name:"ID",value:e.SpecimenIdentifier}],i=[{name:"Name",value:e.PersonObserverName}],o=e.ROIs.map((function(e,t){var n="Region ".concat(t+1),i=[];return e.evaluations.forEach((function(e){e.ValueType===H.sr.valueTypes.ValueTypes.CODE?i.push({name:e.ConceptNameCodeSequence[0].CodeMeaning,value:e.ConceptCodeSequence[0].CodeMeaning}):e.ValueType===H.sr.valueTypes.ValueTypes.TEXT&&i.push({name:e.ConceptNameCodeSequence[0].CodeMeaning,value:e.TextValue})})),(0,se.jsx)(he,{header:n,attributes:i},e.uid)}));return(0,se.jsxs)("div",{children:[(0,se.jsx)(Le.Z,{orientation:"left",children:"Patient"}),(0,se.jsx)(ye,{metadata:this.props.dataset}),(0,se.jsx)(Le.Z,{orientation:"left",children:"Case"}),(0,se.jsx)(qt,{metadata:this.props.dataset}),(0,se.jsx)(Le.Z,{orientation:"left",children:"Slide"}),(0,se.jsx)(he,{attributes:t}),(0,se.jsx)(Le.Z,{orientation:"left",children:"Specimen"}),(0,se.jsx)(he,{attributes:n}),(0,se.jsx)(Le.Z,{orientation:"left",children:"Observer"}),(0,se.jsx)(he,{attributes:i}),(0,se.jsx)(Le.Z,{orientation:"left",children:"Annotations"}),o]})}}]),n}(u.Component);var Wt=["defaultStyle","isVisible","segment","metadata","onVisibilityChange","onStyleChange"];const Yt=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var o,a;(0,i.Z)(this,n),(a=t.call(this,e)).handleVisibilityChange=function(e,t){a.props.onVisibilityChange({segmentUID:a.props.segment.uid,isVisible:e}),a.setState({isVisible:e})},a.handleColorChange=function(e){a.setState((function(t){return{currentStyle:(0,re.Z)((0,re.Z)({},t.currentStyle),{},{color:e})}}),(function(){a.props.onStyleChange({segmentUID:a.props.segment.uid,styleOptions:{opacity:a.state.currentStyle.opacity,color:e}})}))},a.handleOpacityChange=function(e){null!==e&&a.setState((function(t){return{currentStyle:(0,re.Z)((0,re.Z)({},t.currentStyle),{},{opacity:e})}}),(function(){a.props.onStyleChange({segmentUID:a.props.segment.uid,styleOptions:{opacity:e,color:a.state.currentStyle.color}})}))};var r=null!==(o=a.props.defaultStyle.color)&&void 0!==o?o:[255,255,0];return a.state={isVisible:a.props.isVisible,currentStyle:{opacity:a.props.defaultStyle.opacity,color:r}},a}return(0,o.Z)(n,[{key:"render",value:function(){var e,t=[{name:"Property Type",value:this.props.segment.propertyType.CodeMeaning},{name:"Property Category",value:this.props.segment.propertyCategory.CodeMeaning},{name:"Algorithm Name",value:this.props.segment.algorithmName},{name:"Algorithm Type",value:this.props.segment.algorithmType}],n=null===(e=this.props.metadata)||void 0===e?void 0:e[0],i=st(n);void 0!==(null===n||void 0===n?void 0:n.SegmentationType)&&t.push({name:"Segmentation Type",value:n.SegmentationType});var o=(0,se.jsxs)("div",{children:["FRACTIONAL"!==i&&(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)(Le.Z,{plain:!0,children:"Color"}),(0,se.jsx)(mt,{color:this.state.currentStyle.color,onChange:this.handleColorChange}),(0,se.jsx)(Le.Z,{plain:!0})]}),(0,se.jsx)(ft,{opacity:this.state.currentStyle.opacity,onChange:this.handleOpacityChange})]}),a=this.props,r=(a.defaultStyle,a.isVisible,a.segment,a.metadata,a.onVisibilityChange,a.onStyleChange,(0,ct.Z)(a,Wt));return(0,se.jsx)(B.Z.Item,(0,re.Z)((0,re.Z)({style:{height:"100%",paddingLeft:"3px"}},r),{},{children:(0,se.jsxs)(Ee.Z,{align:"start",children:[(0,se.jsx)("div",{style:{paddingLeft:"14px"},children:(0,se.jsxs)(Ee.Z,{direction:"vertical",align:"center",children:[(0,se.jsx)(Te.Z,{size:"small",onChange:this.handleVisibilityChange,checked:this.props.isVisible,checkedChildren:(0,se.jsx)(d.dSq,{}),unCheckedChildren:(0,se.jsx)(d.tgn,{})}),(0,se.jsx)(dt.Z,{placement:"left",content:o,overlayStyle:{width:"350px"},title:"Display Settings",children:(0,se.jsx)(pt.Z,{type:"primary",shape:"circle",icon:(0,se.jsx)(ut.Z,{})})}),"FRACTIONAL"!==i&&(0,se.jsx)("div",{style:{width:"20px",height:"20px",backgroundColor:at(this.state.currentStyle.color),border:"1px solid #d9d9d9",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center"},title:"Segment color: ".concat(at(this.state.currentStyle.color))})]})}),(0,se.jsx)("div",{style:{flex:1},children:(0,se.jsx)(he,{header:this.props.segment.label,attributes:t,selectable:!0,hasLongValues:!0})})]})}),this.props.segment.uid)}}]),n}(u.Component);const Xt=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;(0,i.Z)(this,n);for(var o=arguments.length,a=new Array(o),r=0;r<o;r++)a[r]=arguments[r];return(e=t.call.apply(t,[this].concat(a))).handleVisibilityChange=function(t){t?e.props.segments.forEach((function(n){e.props.onSegmentVisibilityChange({segmentUID:n.uid,isVisible:t})})):e.props.visibleSegmentUIDs.forEach((function(n){e.props.onSegmentVisibilityChange({segmentUID:n,isVisible:t})}))},e}return(0,o.Z)(n,[{key:"render",value:function(){var e=this,t=this.props.segments.map((function(t,n){var i=t.uid;return(0,se.jsx)(Yt,{segment:t,metadata:e.props.metadata[i],isVisible:e.props.visibleSegmentUIDs.has(i),defaultStyle:e.props.defaultSegmentStyles[i],onVisibilityChange:e.props.onSegmentVisibilityChange,onStyleChange:e.props.onSegmentStyleChange},t.uid)}));return(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)("div",{style:{paddingLeft:"14px",paddingTop:"7px",paddingBottom:"7px"},children:(0,se.jsx)(Te.Z,{size:"small",onChange:this.handleVisibilityChange,checked:this.props.visibleSegmentUIDs.size>0,checkedChildren:(0,se.jsx)(d.dSq,{}),unCheckedChildren:(0,se.jsx)(d.tgn,{})})}),(0,se.jsx)(B.Z,{selectable:!1,children:t})]})}}]),n}(u.Component);var Kt=[255,234,0],Jt=[255,234,0,.2],Qt=[0,0,0],$t=[[255,0,0],[0,255,0],[0,0,255],[255,255,0],[0,255,255],[0,0,0]];const en=function(e){var t=e.toolbar,n=e.toolbarHeight,i=e.cursor,o=e.volumeViewportRef,a=e.children;return(0,se.jsxs)(c.Z.Content,{style:{height:"100%"},children:[t,(0,se.jsx)("div",{style:{height:"calc(100% - ".concat(n,")"),overflow:"hidden",cursor:i},ref:o}),a]})};const tn=function(e){var t=e.isVisible,n=e.onOk,i=e.onCancel,o=e.isOkDisabled,a=e.children;return(0,se.jsx)(Ce.Z,{open:t,title:"Configure annotations",onOk:n,okButtonProps:{disabled:o},onCancel:i,okText:"Select",children:(0,se.jsx)(Ee.Z,{align:"start",direction:"vertical",children:a})})};var nn=n(7575),on=n(1515);const an=function(e){var t=e.isVisible,n=e.onOk,i=e.onCancel,o=e.validXCoordinateRange,a=e.validYCoordinateRange,r=e.isSelectedXCoordinateValid,s=e.isSelectedYCoordinateValid,l=e.isSelectedMagnificationValid,c=e.onXCoordinateSelection,d=e.onYCoordinateSelection,p=e.onMagnificationSelection,h=(0,u.useCallback)((function(e){var t=e.target;c(""!==t.value?Number(t.value):null)}),[c]),v=(0,u.useCallback)((function(e){var t=e.target;d(""!==t.value?Number(t.value):null)}),[d]),m=(0,u.useCallback)((function(e){var t=e.target;p(""!==t.value?Number(t.value):null)}),[p]);return(0,se.jsx)(Ce.Z,{open:t,title:"Go to slide position",onOk:n,onCancel:i,okText:"Select",children:(0,se.jsxs)(Ee.Z,{align:"start",direction:"vertical",children:[(0,se.jsx)(ke.Z,{placeholder:"["+"".concat(o[0])+", "+"".concat(o[1])+"]",prefix:"X Coordinate [mm]",onChange:c,onPressEnter:h,controls:!1,addonAfter:r?(0,se.jsx)(nn.Z,{style:{color:"rgba(0,0,0,.45)"}}):(0,se.jsx)(on.Z,{style:{color:"rgba(0,0,0,.45)"}})}),(0,se.jsx)(ke.Z,{placeholder:"["+"".concat(a[0])+", "+"".concat(a[1])+"]",prefix:"Y Coordinate [mm]",onChange:d,onPressEnter:v,controls:!1,addonAfter:s?(0,se.jsx)(nn.Z,{style:{color:"rgba(0,0,0,.45)"}}):(0,se.jsx)(on.Z,{style:{color:"rgba(0,0,0,.45)"}})}),(0,se.jsx)(ke.Z,{placeholder:"[0 - 40]",prefix:"Magnification",onChange:p,onPressEnter:m,controls:!1,addonAfter:l?(0,se.jsx)(nn.Z,{style:{color:"rgba(0,0,0,.45)"}}):(0,se.jsx)(on.Z,{style:{color:"rgba(0,0,0,.45)"}})})]})})};const rn=function(e){var t=e.isVisible,n=e.onOk,i=e.onCancel,o=e.children;return(0,se.jsx)(Ce.Z,{open:t,title:"Verify and save report",onOk:n,onCancel:i,okText:"Save",children:o})};const sn=function(e){var t=e.isVisible,n=e.onCancel,i=e.children;return(0,se.jsx)(Ce.Z,{open:t,title:"Selected ROI",onCancel:n,maskClosable:!0,footer:null,children:(0,se.jsx)(Ee.Z,{align:"start",direction:"vertical",children:i})})};const ln=function(e){var t=e.isAnnotationModalVisible,n=e.onAnnotationConfigurationCompletion,i=e.onAnnotationConfigurationCancellation,o=e.isAnnotationOkDisabled,a=e.annotationConfigurations,r=e.isSelectedRoiModalVisible,s=e.onRoiSelectionCancellation,l=e.selectedRoiInformation,c=e.isGoToModalVisible,u=e.onSlidePositionSelection,d=e.onSlidePositionSelectionCancellation,p=e.validXCoordinateRange,h=e.validYCoordinateRange,v=e.isSelectedXCoordinateValid,m=e.isSelectedYCoordinateValid,f=e.isSelectedMagnificationValid,g=e.onXCoordinateSelection,S=e.onYCoordinateSelection,y=e.onMagnificationSelection,I=e.isReportModalVisible,C=e.onReportVerification,b=e.onReportCancellation,w=e.report;return(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)(tn,{isVisible:t,onOk:n,onCancel:i,isOkDisabled:o,children:a}),(0,se.jsx)(sn,{isVisible:r,onCancel:s,children:l}),(0,se.jsx)(an,{isVisible:c,onOk:u,onCancel:d,validXCoordinateRange:p,validYCoordinateRange:h,isSelectedXCoordinateValid:v,isSelectedYCoordinateValid:m,isSelectedMagnificationValid:f,onXCoordinateSelection:g,onYCoordinateSelection:S,onMagnificationSelection:y}),(0,se.jsx)(rn,{isVisible:I,onOk:C,onCancel:b,children:w})]})};const cn=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var o;return(0,i.Z)(this,n),(o=t.call(this,e)).handleColorChange=function(e){o.updateCurrentStyle({color:e}),o.props.annotationGroupsUIDs.forEach((function(t){var n;o.props.onStyleChange({uid:t,styleOptions:{color:e,opacity:null!==(n=o.state.currentStyle.opacity)&&void 0!==n?n:o.props.defaultStyle.opacity,contourOnly:o.state.currentStyle.contourOnly}})}))},o.handleOpacityChange=function(e){null!==e&&(o.props.annotationGroupsUIDs.forEach((function(t){var n;o.props.onStyleChange({uid:t,styleOptions:{color:null!==(n=o.state.currentStyle.color)&&void 0!==n?n:o.props.defaultStyle.color,opacity:e,contourOnly:o.state.currentStyle.contourOnly}})})),o.updateCurrentStyle({opacity:e}))},o.handleShowOutlineOnly=function(e){o.updateCurrentStyle({contourOnly:e}),o.props.annotationGroupsUIDs.forEach((function(t){var n,i;o.props.onStyleChange({uid:t,styleOptions:{color:null!==(n=o.state.currentStyle.color)&&void 0!==n?n:o.props.defaultStyle.color,opacity:null!==(i=o.state.currentStyle.opacity)&&void 0!==i?i:o.props.defaultStyle.opacity,contourOnly:e}})}))},o.handleShowOutlineOnlyCheckbox=function(e){o.handleShowOutlineOnly(e.target.checked)},o.getCurrentColor=function(){return null!==o.state.currentStyle.color&&void 0!==o.state.currentStyle.color?function(e){var t=e[0],n=e[1],i=e[2];return"#".concat((16777216+(t<<16)+(n<<8)+i).toString(16).slice(1))}(o.state.currentStyle.color):"white"},o.updateCurrentStyle=function(e){var t=e.color,n=e.opacity,i=e.contourOnly;o.setState((function(e){return{currentStyle:{opacity:null!==n&&void 0!==n?n:e.currentStyle.opacity,color:null!==t&&void 0!==t?t:e.currentStyle.color,contourOnly:null!==i&&void 0!==i?i:e.currentStyle.contourOnly}}}))},o.state={currentStyle:{opacity:o.props.defaultStyle.opacity,color:o.props.defaultStyle.color,contourOnly:o.props.defaultStyle.contourOnly}},o}return(0,o.Z)(n,[{key:"render",value:function(){var e;return null!==this.state.currentStyle.color&&void 0!==this.state.currentStyle.color&&(e=(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)(Le.Z,{plain:!0,children:"Color"}),(0,se.jsx)(mt,{color:this.state.currentStyle.color,onChange:this.handleColorChange}),(0,se.jsx)(Le.Z,{plain:!0})]})),(0,se.jsxs)("div",{children:[e,(0,se.jsx)(ft,{opacity:this.state.currentStyle.opacity,onChange:this.handleOpacityChange}),(0,se.jsx)(je.Z,{justify:"start",align:"middle",gutter:[8,8],children:(0,se.jsx)(Ue.Z,{value:this.state.currentStyle.contourOnly,onChange:this.handleShowOutlineOnlyCheckbox,children:"Show outline only"})})]})}}]),n}(u.Component);var un=["category","onChange","checkedAnnotationUids","onStyleChange","defaultAnnotationStyles"];function dn(e){var t=e.type,n=e.checkedAnnotationUids,i=e.onCheckboxChange,o=e.onStyleChange,a=e.defaultAnnotationStyles,r=t.CodeMeaning,s=t.CodingSchemeDesignator,l=t.CodeValue,c=t.uids,d=r.slice(0,22),p=d===r?r:"".concat(d,"..."),h=c.every((function(e){return n.has(e)})),v=!h&&c.some((function(e){return n.has(e)})),m=(0,u.useCallback)((function(e){return i(t,e)}),[t,i]);return(0,se.jsxs)("div",{style:{paddingLeft:"25px",width:"100%",display:"flex",flexDirection:"row"},children:[(0,se.jsx)(Ue.Z,{indeterminate:v,checked:h,onChange:m}),(0,se.jsxs)("div",{style:{paddingLeft:"5px"},children:[(0,se.jsx)(Ie.Z,{title:"".concat(l,":").concat(s),mouseEnterDelay:1,children:p}),(0,se.jsx)(dt.Z,{placement:"topLeft",overlayStyle:{width:"350px"},title:"Display Settings",content:(0,se.jsx)(cn,{annotationGroupsUIDs:t.uids,onStyleChange:o,defaultStyle:a[t.uids[0]]}),children:(0,se.jsx)(pt.Z,{type:"primary",shape:"circle",style:{marginLeft:"10px"},icon:(0,se.jsx)(ut.Z,{})})})]})]})}const pn=function(e){var t=e.category,n=e.onChange,i=e.checkedAnnotationUids,o=e.onStyleChange,a=e.defaultAnnotationStyles,r=(0,ct.Z)(e,un),s=t.types,l=s.every((function(e){return e.uids.every((function(e){return i.has(e)}))})),c=!l&&s.some((function(e){return e.uids.some((function(e){return i.has(e)}))})),u=function(e){var t=e.type,i=e.isVisible;t.uids.forEach((function(e){n({roiUID:e,isVisible:i})}))},d=(0,se.jsx)(cn,{annotationGroupsUIDs:s.reduce((function(e,t){return e.push.apply(e,(0,X.Z)(t.uids)),e}),[]),onStyleChange:o,defaultStyle:a[s[0].uids[0]]});function p(e,t){u({type:e,isVisible:t.target.checked})}var h=(0,se.jsxs)(Ue.Z,{indeterminate:c,checked:l,onChange:function(e){var t=e.target.checked;s.forEach((function(e){u({type:e,isVisible:t})}))},children:[(0,se.jsx)(Ie.Z,{title:"".concat(t.CodeValue,":").concat(t.CodingSchemeDesignator),mouseEnterDelay:1,children:t.CodeMeaning}),(0,se.jsx)(dt.Z,{placement:"topLeft",overlayStyle:{width:"350px"},title:"Display Settings",content:d,children:(0,se.jsx)(pt.Z,{type:"primary",shape:"circle",style:{marginLeft:"10px"},icon:(0,se.jsx)(ut.Z,{})})})]});return(0,se.jsx)(B.Z.Item,(0,re.Z)((0,re.Z)({style:{height:"100%",paddingLeft:"3px"}},r),{},{children:(0,se.jsx)(Ee.Z,{align:"start",children:(0,se.jsx)("div",{style:{paddingLeft:"14px",color:"black"},children:(0,se.jsxs)(Ee.Z,{direction:"vertical",align:"end",children:[h,s.map((function(e){return(0,se.jsx)(dn,{type:e,checkedAnnotationUids:i,onCheckboxChange:p,onStyleChange:o,defaultAnnotationStyles:a},"".concat(e.CodingSchemeDesignator,":").concat(e.CodeMeaning))}))]})})})}))};const hn=function(e){var t=e.annotations,n=e.onChange,i=e.onStyleChange,o=e.defaultAnnotationStyles,a=e.checkedAnnotationUids,r=function(e){var t,n={},i=(0,z.Z)(null!==e&&void 0!==e?e:[]);try{for(i.s();!(t=i.n()).done;){var o=t.value,a=o.category,r=o.type,s=o.uid,l=a.CodeMeaning,c=r.CodeMeaning;l in n||(n[l]=(0,re.Z)((0,re.Z)({},a),{},{types:{}}));var u=n[l];c in u.types||(u.types[c]=(0,re.Z)((0,re.Z)({},r),{},{uids:[]})),u.types[c].uids.push(s)}}catch(m){i.e(m)}finally{i.f()}for(var d={},p=function(){var e=v[h],t=n[e],i=Object.keys(t.types).map((function(e){return t.types[e]}));d[e]=(0,re.Z)((0,re.Z)({},t),{},{types:i})},h=0,v=Object.keys(n);h<v.length;h++)p();return d}(t);if(0===Object.keys(r).length)return null;var s=Object.keys(r).map((function(e){var t=r[e];return(0,se.jsx)(pn,{category:t,onChange:n,onStyleChange:i,defaultAnnotationStyles:o,checkedAnnotationUids:a},""!==t.CodeMeaning?t.CodeMeaning:"category-".concat(e))}));return(0,se.jsx)(B.Z,{selectable:!1,children:s})};const vn=function(e){var t=e.labelViewportRef,n=e.labelViewer,i=e.openSubMenuItems,o=e.specimenMenu,a=e.iccProfilesMenu,r=e.segmentationInterpolationMenu,s=e.parametricMapInterpolationMenu,l=e.equipmentMenu,d=e.opticalPathMenu,p=e.presentationStateMenu,h=e.annotationMenuItems,v=e.annotationGroupMenu,m=e.segmentationMenu,f=e.parametricMapMenu,g=e.annotations,S=e.visibleRoiUIDs,y=e.onAnnotationVisibilityChange,I=e.onRoiStyleChange,C=e.defaultAnnotationStyles,b=(0,u.useCallback)((function(){setTimeout((function(){null!==n&&void 0!==n&&n.resize()}),100)}),[n]);return(0,se.jsx)(c.Z.Sider,{width:300,reverseArrow:!0,style:{borderLeft:"solid",borderLeftWidth:.25,overflow:"hidden",background:"none"},children:(0,se.jsxs)(B.Z,{mode:"inline",defaultOpenKeys:i,style:{height:"100%"},inlineIndent:14,forceSubMenuRender:!0,onOpenChange:b,children:[null!==t.current&&(0,se.jsx)(B.Z.SubMenu,{title:"Slide label",children:(0,se.jsx)(B.Z.Item,{style:{height:"100%"},children:(0,se.jsx)("div",{style:{height:"220px"},ref:t})},"image")},"label"),o,a,r,s,l,d,p,(0,se.jsx)(B.Z.SubMenu,{title:"Annotations",children:h},"annotations"),v,0===g.length?null:(0,se.jsx)(B.Z.SubMenu,{title:"Annotation Categories",children:(0,se.jsx)(hn,{annotations:g,onChange:y,checkedAnnotationUids:S,onStyleChange:I,defaultAnnotationStyles:C})},"annotation-categories"),m,f]})})};var mn=function(e){var t=e.CodingSchemeDesignator,n=e.CodeValue;return"".concat(t,"-").concat(n)},fn=function(e){var t=lt({content:e.evaluations,name:new H.sr.coding.CodedConcept({value:"121071",meaning:"Finding",schemeDesignator:"DCM"})});if(0!==t.length){var n=t[0].ConceptCodeSequence[0];return mn(n)}console.warn("no finding found for ROI ".concat(e.uid))},gn=function(e,t){if(e.scoord3d.graphicType!==t.scoord3d.graphicType)return!1;if(e.scoord3d.frameOfReferenceUID!==t.scoord3d.frameOfReferenceUID)return!1;if(e.scoord3d.graphicData.length!==t.scoord3d.graphicData.length)return!1;for(var n=0;n<e.scoord3d.graphicData.length;++n)if("POINT"===e.scoord3d.graphicType){var i=e.scoord3d,o=t.scoord3d;if(i.graphicData[n].toPrecision(6)!==o.graphicData[n].toPrecision(6))return!1}else for(var a=e.scoord3d,r=t.scoord3d,s=0;s<a.graphicData[n].length;++s){if(a.graphicData[n][s].toPrecision(6)!==r.graphicData[n][s].toPrecision(6))return!1}return!0},Sn=function(e){var t,n,i,o,a,r,s,l={color:null!==(t=null===(n=e.stroke)||void 0===n?void 0:n.color)&&void 0!==t?t:[255,234,0],width:null!==(i=null===(o=e.stroke)||void 0===o?void 0:o.width)&&void 0!==i?i:2},c={color:null!==(a=null===(r=e.fill)||void 0===r?void 0:r.color)&&void 0!==a?a:[255,234,0,.2]};return{stroke:l,fill:c,image:{circle:{radius:null!==(s=e.radius)&&void 0!==s?s:Math.max(5-l.width,1),stroke:l,fill:c}}}},yn=function(e){var t=e.clients,n=e.slide,i=e.preload,o=e.clusteringPixelSizeThreshold;console.info("instantiate viewer for VOLUME images of slide "+'"'.concat(n.volumeImages[0].ContainerIdentifier,'"'));try{var a,r=new Y.viewer.VolumeImageViewer({clientMapping:t,metadata:n.volumeImages,controls:["overview","position"],skipThumbnails:!0,preload:i,annotationOptions:void 0!==o?{clusteringPixelSizeThreshold:o}:void 0,errorInterceptor:function(e){k.onError(O,e)}});return r.activateSelectInteraction({}),n.labelImages.length>0&&(console.info("instantiate viewer for LABEL image of slide "+'"'.concat(n.labelImages[0].ContainerIdentifier,'"')),a=new Y.viewer.LabelImageViewer({client:t[L.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE],metadata:n.labelImages[0],resizeFactor:1,orientation:"vertical",errorInterceptor:function(e){k.onError(O,e)}})),{volumeViewer:r,labelViewer:a}}catch(s){throw k.onError(P,new w(b,"Failed to instantiate viewer")),s}},In=function(e){var t=e.ContentTemplateSequence;if(t.length>0&&"1500"===t[0].TemplateIdentifier)return!0;return!1},Cn=function(e){var t=lt({content:e.ContentSequence,name:new H.sr.coding.CodedConcept({value:"121024",schemeDesignator:"DCM",meaning:"Subject Class"})});if(0===t.length)return!1;var n=t[0].ConceptCodeSequence[0],i=new H.sr.coding.CodedConcept({value:n.CodeValue,meaning:n.CodeMeaning,schemeDesignator:n.CodingSchemeDesignator}),o=new H.sr.coding.CodedConcept({value:"121027",meaning:"Specimen",schemeDesignator:"DCM"});return i.equals(o)},bn=function(e){var t=lt({content:e.ContentSequence,name:new H.sr.coding.CodedConcept({value:"126010",schemeDesignator:"DCM",meaning:"Imaging Measurements"})});if(0===t.length)return!1;var n=t[0],i=lt({content:n.ContentSequence,name:new H.sr.coding.CodedConcept({value:"125007",schemeDesignator:"DCM",meaning:"Measurement Group"})}),o=!1;return i.forEach((function(e){var t=lt({content:e.ContentSequence,name:new H.sr.coding.CodedConcept({value:"111030",schemeDesignator:"DCM",meaning:"Image Region"})});t.length>0&&t[0].ValueType===H.sr.valueTypes.ValueTypes.SCOORD3D&&(o=!0)})),o},wn=n(2126);const Dn=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,o.Z)(n,[{key:"render",value:function(){var e,t=null;return void 0!==this.props.groups&&(t=this.props.groups.map((function(e){return(0,se.jsx)(he,{header:e.name,attributes:e.attributes},e.name)}))),e=void 0!==this.props.type?"".concat(this.props.type,": ").concat(this.props.identifier):this.props.identifier,(0,se.jsxs)(wn.ZP.Item,{children:[(0,se.jsx)(he,{header:e,attributes:this.props.attributes,hasLongValues:this.props.hasLongValues,children:t}),this.props.children]},this.props.uid)}}]),n}(u.Component);const xn=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,o.Z)(n,[{key:"render",value:function(){var e,t=this;if(void 0===this.props.metadata)return null;var n=this.props.metadata.SpecimenDescriptionSequence[this.props.index],i=[];if(void 0!==n.SpecimenShortDescription&&i.push({name:"Description",value:n.SpecimenShortDescription}),void 0!==n.PrimaryAnatomicStructureSequence&&n.PrimaryAnatomicStructureSequence.length>0){var o=n.PrimaryAnatomicStructureSequence;i.push({name:"Anatomical structure",value:o.map((function(e){return e.CodeMeaning})).join(", ")})}var a=n.PrimaryAnatomicStructureSequence;if(void 0!==a&&a.length>0){var r=a.find((function(e){return void 0!==e.PrimaryAnatomicStructureModifierSequence}));if(null!=r){var s=r.PrimaryAnatomicStructureModifierSequence;s.length>0&&i.push({name:"Primary Anatomic Structure Modifier",value:s.map((function(e){return e.CodeMeaning})).join(", ")})}}(null!==(e=n.SpecimenPreparationSequence)&&void 0!==e?e:[]).forEach((function(e,n){e.SpecimenPreparationStepContentItemSequence.forEach((function(e,n){var o=new H.sr.coding.CodedConcept({value:e.ConceptNameCodeSequence[0].CodeValue,schemeDesignator:e.ConceptNameCodeSequence[0].CodingSchemeDesignator,meaning:e.ConceptNameCodeSequence[0].CodeMeaning});if(e.ValueType===H.sr.valueTypes.ValueTypes.CODE){var a=new H.sr.coding.CodedConcept({value:e.ConceptCodeSequence[0].CodeValue,schemeDesignator:e.ConceptCodeSequence[0].CodingSchemeDesignator,meaning:e.ConceptCodeSequence[0].CodeMeaning});o.equals(Tt.PROCESSING_TYPE)||(o.equals(Tt.COLLECTION_METHOD)?i.push({name:"Collection method",value:a.CodeMeaning}):o.equals(Tt.FIXATIVE)?i.push({name:"Tissue fixative",value:a.CodeMeaning}):o.equals(Tt.EMBEDDING_MEDIUM)?i.push({name:"Tissue embedding medium",value:a.CodeMeaning}):o.equals(Tt.STAIN)&&t.props.showstain&&i.push({name:"Tissue stain",value:a.CodeMeaning}))}else e.ValueType===H.sr.valueTypes.ValueTypes.TEXT&&(o.equals(Tt.STAIN)&&t.props.showstain?i.push({name:"Tissue stain",value:e.TextValue}):o.equals(Tt.PARENT_SPECIMEN_IDENTIFIER)&&i.push({name:"Parent specimen",value:e.TextValue}))}))})),void 0!==this.props.metadata.AdmittingDiagnosesDescription&&i.push({name:"Admitting Diagnoses",value:this.props.metadata.AdmittingDiagnosesDescription});var l=n.SpecimenUID,c=n.SpecimenIdentifier;return(0,se.jsx)(Dn,{uid:l,identifier:c,attributes:i,hasLongValues:!0},l)}}]),n}(u.Component);const Vn=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,o.Z)(n,[{key:"render",value:function(){var e,t=this;if(void 0===this.props.metadata)return null;var n=(null!==(e=this.props.metadata.SpecimenDescriptionSequence)&&void 0!==e?e:[]).map((function(e,n){return(0,se.jsx)(xn,{index:n,metadata:t.props.metadata,showstain:t.props.showstain},e.SpecimenUID)}));return(0,se.jsx)(wn.ZP,{style:{overflowY:"auto"},children:n})}}]),n}(u.Component);var Mn=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var o;(0,i.Z)(this,n),(o=t.call(this,e)).findingOptions=[],o.evaluationOptions={},o.measurements=[],o.geometryTypeOptions={},o.volumeViewportRef=void 0,o.labelViewportRef=void 0,o.volumeViewer=void 0,o.labelViewer=void 0,o.hoveredRois=[],o.lastPixel=[0,0],o.keysDown=new Set,o.handlePointerMoveDebounced=void 0,o.lastHoveredRoiSignature=null,o.annotationGroupMetadataCache=new Map,o.defaultRoiStyle={stroke:{color:Kt,width:2},fill:{color:Jt},image:{circle:{fill:{color:Kt},radius:5}}},o.roiStyles={},o.defaultAnnotationStyles={},o.selectionStrokeColor=[0,153,255],o.selectionFillColor=[255,255,255],o.selectedRoiStyle={stroke:{color:[].concat((0,X.Z)(o.selectionStrokeColor),[1]),width:3},fill:{color:[].concat((0,X.Z)(o.selectionFillColor),[.5])},image:{circle:{radius:5,fill:{color:[].concat((0,X.Z)(o.selectionStrokeColor),[1])}}}},o.loadPresentationStates=function(){it.log("search for Presentation State instances");var e=o.props.clients[L.ADVANCED_BLENDING_PRESENTATION_STATE];e.searchForInstances({studyInstanceUID:o.props.studyInstanceUID,queryParams:{Modality:"PR"}}).then((function(t){null!==t&&void 0!==t||(t=[]),t.forEach((function(t,n){var i=Y.metadata.formatMetadata(t).dataset;it.log('retrieve PR instance "'.concat(i.SOPInstanceUID,'"')),e.retrieveInstance({studyInstanceUID:o.props.studyInstanceUID,seriesInstanceUID:i.SeriesInstanceUID,sopInstanceUID:i.SOPInstanceUID}).then((function(e){var t=H.aT.DicomMessage.readFile(e),a=Y.metadata.formatMetadata(t.dict).dataset;if(o.props.slide.areVolumeImagesMonochrome){var r=a,s=!1;r.AdvancedBlendingSequence.forEach((function(e){s=o.props.slide.seriesInstanceUIDs.includes(e.SeriesInstanceUID)})),s&&(it.log("include Advanced Blending Presentation State instance "+'"'.concat(r.SOPInstanceUID,'"')),0!==n||null!==o.props.selectedPresentationStateUID&&void 0!==o.props.selectedPresentationStateUID?r.SOPInstanceUID===o.props.selectedPresentationStateUID&&o.setPresentationState(r):o.setPresentationState(r),o.setState((function(e){var t={};return e.presentationStates.forEach((function(e){t[e.SOPInstanceUID]=e})),t[r.SOPInstanceUID]=r,{presentationStates:Object.values(t)}})))}else it.log('ignore presentation state "'.concat(i.SOPInstanceUID,'", ')+"application of presentation states for color images has not (yet) been implemented")})).catch((function(e){k.onError(P,new w(b,"Presentation State could not be loaded")),it.error("failed to load presentation state "+'of SOP instance "'.concat(i.SOPInstanceUID,'" ')+'of series "'.concat(i.SeriesInstanceUID,'" ')+'of study "'.concat(o.props.studyInstanceUID,'": '),e)}))}))})).catch((function(e){it.error(e),k.onError(P,new w(b,"Presentation State could not be loaded"))}))},o.setPresentationState=function(e){var t=o.volumeViewer.getAllOpticalPaths();it.log('apply Presentation State instance "'.concat(e.SOPInstanceUID,'"'));var n={};t.forEach((function(t){var i=t.identifier;o.volumeViewer.hideOpticalPath(i),o.volumeViewer.deactivateOpticalPath(i);var a=o.volumeViewer.getOpticalPathDefaultStyle(i);o.volumeViewer.setOpticalPathStyle(i,a),e.AdvancedBlendingSequence.forEach((function(e){var o=e.ReferencedInstanceSequence;void 0===o&&(o=e.ReferencedImageSequence),void 0!==o&&o.forEach((function(o){if(t.sopInstanceUIDs.includes(o.ReferencedSOPInstanceUID)){var a,r;if(null!==e.PaletteColorLookupTableSequence&&void 0!==e.PaletteColorLookupTableSequence){var s=e.PaletteColorLookupTableSequence[0];a=new Y.color.PaletteColorLookupTable({uid:null!==s.PaletteColorLookupTableUID&&void 0!==s.PaletteColorLookupTableUID?s.PaletteColorLookupTableUID:"",redDescriptor:s.RedPaletteColorLookupTableDescriptor,greenDescriptor:s.GreenPaletteColorLookupTableDescriptor,blueDescriptor:s.BluePaletteColorLookupTableDescriptor,redData:null!==s.RedPaletteColorLookupTableData&&void 0!==s.RedPaletteColorLookupTableData?new Uint16Array(s.RedPaletteColorLookupTableData):void 0,greenData:null!==s.GreenPaletteColorLookupTableData&&void 0!==s.GreenPaletteColorLookupTableData?new Uint16Array(s.GreenPaletteColorLookupTableData):void 0,blueData:null!==s.BluePaletteColorLookupTableData&&void 0!==s.BluePaletteColorLookupTableData?new Uint16Array(s.BluePaletteColorLookupTableData):void 0,redSegmentedData:null!==s.SegmentedRedPaletteColorLookupTableData&&void 0!==s.SegmentedRedPaletteColorLookupTableData?new Uint16Array(s.SegmentedRedPaletteColorLookupTableData):void 0,greenSegmentedData:null!==s.SegmentedGreenPaletteColorLookupTableData&&void 0!==s.SegmentedGreenPaletteColorLookupTableData?new Uint16Array(s.SegmentedGreenPaletteColorLookupTableData):void 0,blueSegmentedData:null!==s.SegmentedBluePaletteColorLookupTableData&&void 0!==s.SegmentedBluePaletteColorLookupTableData?new Uint16Array(s.SegmentedBluePaletteColorLookupTableData):void 0})}if(null!==e.SoftcopyVOILUTSequence&&void 0!==e.SoftcopyVOILUTSequence){var l=e.SoftcopyVOILUTSequence[0],c=l.WindowCenter,u=l.WindowWidth;r=[c-.5*u,c+.5*u]}n[i]={opacity:1,paletteColorLookupTable:a,limitValues:r}}}))}))}));var i=new Set;Object.keys(n).forEach((function(e){var t=n[e];null!==t?(o.volumeViewer.setOpticalPathStyle(e,t),o.volumeViewer.activateOpticalPath(e),o.volumeViewer.showOpticalPath(e),i.add(e)):(o.volumeViewer.hideOpticalPath(e),o.volumeViewer.deactivateOpticalPath(e))}));var a=new URLSearchParams(o.props.location.search);a.set("state",e.SOPInstanceUID),o.props.navigate({pathname:o.props.location.pathname,search:a.toString()},{replace:!0}),o.setState((function(t){return{activeOpticalPathIdentifiers:i,visibleOpticalPathIdentifiers:i,selectedPresentationStateUID:e.SOPInstanceUID}}))},o.getRoiStyle=function(e){return null===e||void 0===e?o.defaultRoiStyle:void 0!==o.roiStyles[e]?o.roiStyles[e]:o.defaultRoiStyle},o.loadDerivedDataset=function(e){it.debug("Loading derived dataset:",e);var t=L.COMPREHENSIVE_3D_SR,n=L.COMPREHENSIVE_SR,i=L.MICROSCOPY_BULK_SIMPLE_ANNOTATION,a=L.SEGMENTATION,r=L.PARAMETRIC_MAP,s=L.OPTICAL_PATH,l=L.ADVANCED_BLENDING_PRESENTATION_STATE,c=L.COLOR_SOFTCOPY_PRESENTATION_STATE,u=L.GRAYSCALE_SOFTCOPY_PRESENTATION_STATE,d=L.PSEUDOCOLOR_SOFTCOPY_PRESENTATION_STATE;if(e.SOPClassUID===t)o.volumeViewer.getAllROIs().forEach((function(e){o.handleAnnotationVisibilityChange({roiUID:e.uid,isVisible:!0})})),it.debug("Loading Comprehensive 3D SR");else if(e.SOPClassUID===i){var p=o.volumeViewer.getAllAnnotationGroups().find((function(t){return t.seriesInstanceUID===e.SeriesInstanceUID}));void 0!==p&&o.handleAnnotationGroupVisibilityChange({annotationGroupUID:p.uid,isVisible:!0}),it.debug("Loading Microscopy Bulk Simple Annotation")}else if(e.SOPClassUID===a){var h=o.volumeViewer.getAllSegments(),v=e.SeriesInstanceUID;h.filter((function(e){return e.seriesInstanceUID===v})).forEach((function(e){o.handleSegmentVisibilityChange({segmentUID:e.uid,isVisible:!0})})),it.debug("Loading Segmentation")}else if(e.SOPClassUID===r){var m=o.volumeViewer.getAllParameterMappings(),f=e.SeriesInstanceUID;m.filter((function(e){return e.seriesInstanceUID===f})).forEach((function(e){o.handleMappingVisibilityChange({mappingUID:e.uid,isVisible:!0})})),it.debug("Loading Parametric Map")}else if(e.SOPClassUID===s){var g=o.volumeViewer.getAllOpticalPaths(),S=e.SeriesInstanceUID;g.filter((function(e){return e.seriesInstanceUID===S})).forEach((function(e){o.handleOpticalPathVisibilityChange({opticalPathIdentifier:e.identifier,isVisible:!0})})),it.debug("Loading Optical Path")}else e.SOPClassUID===n?it.debug("TODO: Loading Comprehensive SR"):e.SOPClassUID===l?it.debug("TODO: Loading Advanced Blending Presentation State"):e.SOPClassUID===c?it.debug("TODO: Loading Color Softcopy Presentation State"):e.SOPClassUID===u?it.debug("TODO: Loading Grayscale Softcopy Presentation State"):e.SOPClassUID===d&&it.debug("TODO: Loading Pseudocolor Softcopy Presentation State")},o.addAnnotationGroups=(0,m.Z)((0,v.Z)().mark((function e(){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e,t){it.log("search for Microscopy Bulk Simple Annotations instances");var n=o.props.clients[L.MICROSCOPY_BULK_SIMPLE_ANNOTATION];n.searchForSeries({studyInstanceUID:o.props.studyInstanceUID,queryParams:{Modality:"ANN"}}).then((function(t){null!==t&&void 0!==t||(t=[]),0!==t.length?t.forEach((function(t){var i=Y.metadata.formatMetadata(t).dataset;n.retrieveSeriesMetadata({studyInstanceUID:o.props.studyInstanceUID,seriesInstanceUID:i.SeriesInstanceUID}).then((function(t){t.map((function(e){return new Y.metadata.MicroscopyBulkSimpleAnnotations({metadata:e})})).forEach((function(t){try{o.volumeViewer.addAnnotationGroups(t),e()}catch(n){k.onError(P,new w(b,"Microscopy Bulk Simple Annotations cannot be displayed.")),it.error("failed to add annotation groups:",n)}t.AnnotationGroupSequence.forEach((function(e){var t=e.AnnotationGroupUID,n=e.AnnotationPropertyTypeCodeSequence[0],i=mn(n),a=o.roiStyles[i];null!==a&&void 0!==a&&null!==a.fill&&void 0!==a.fill&&o.volumeViewer.setAnnotationGroupStyle(t,{color:a.fill.color})}))})),o.forceUpdate()})).catch((function(e){console.error(e),k.onError(P,new w(b,"Retrieval of metadata of Microscopy Bulk Simple Annotations instances failed."))}))})):e()})).catch((function(e){console.error(e),k.onError(P,new w(b,"Search for Microscopy Bulk Simple Annotations instances failed.")),t(e instanceof Error?e:new Error(String(e)))}))}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))),o.addSegmentations=(0,m.Z)((0,v.Z)().mark((function e(){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e,t){console.info("search for Segmentation instances");var n=o.props.clients[L.SEGMENTATION];n.searchForSeries({studyInstanceUID:o.props.studyInstanceUID,queryParams:{Modality:"SEG"}}).then((function(t){null!==t&&void 0!==t||(t=[]),0!==t.length?t.forEach((function(t,i){var a=Y.metadata.formatMetadata(t).dataset;n.retrieveSeriesMetadata({studyInstanceUID:o.props.studyInstanceUID,seriesInstanceUID:a.SeriesInstanceUID}).then((function(t){var n=[];if(t.forEach((function(e){var t=new Y.metadata.Segmentation({metadata:e}),i=o.props.slide.volumeImages[0];t.FrameOfReferenceUID===i.FrameOfReferenceUID&&t.ContainerIdentifier===i.ContainerIdentifier&&n.push(t)})),n.length>0){try{o.volumeViewer.addSegments(n),e()}catch(i){k.onError(P,new w(b,"Segmentations cannot be displayed")),console.error("failed to add segments: ",i)}o.forceUpdate()}})).catch((function(e){console.error(e),k.onError(P,new w(b,"Retrieval of metadata of Segmentation instances failed."))}))})):e()})).catch((function(e){console.error(e),k.onError(P,new w(b,"Search for Segmentation instances failed.")),t(e instanceof Error?e:new Error(String(e)))}))}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))),o.addParametricMaps=(0,m.Z)((0,v.Z)().mark((function e(){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e,t){console.info("search for Parametric Map instances");var n=o.props.clients[L.PARAMETRIC_MAP];n.searchForSeries({studyInstanceUID:o.props.studyInstanceUID,queryParams:{Modality:"OT"}}).then((function(t){null!==t&&void 0!==t||(t=[]),0!==t.length?t.forEach((function(t){var i=Y.metadata.formatMetadata(t).dataset;n.retrieveSeriesMetadata({studyInstanceUID:o.props.studyInstanceUID,seriesInstanceUID:i.SeriesInstanceUID}).then((function(t){var n=[];if(t.forEach((function(e){var t=new Y.metadata.ParametricMap({metadata:e}),i=o.props.slide.volumeImages[0];t.FrameOfReferenceUID===i.FrameOfReferenceUID&&t.ContainerIdentifier===i.ContainerIdentifier?n.push(t):console.warn('skip Parametric Map instance "'.concat(t.SOPInstanceUID,'"'))})),n.length>0){try{o.volumeViewer.addParameterMappings(n),e()}catch(i){k.onError(P,new w(b,"Parametric Map cannot be displayed")),console.error("failed to add mappings: ",i)}o.forceUpdate()}})).catch((function(e){console.error(e),k.onError(P,new w(b,"Retrieval of metadata of Parametric Map instances failed."))}))})):e()})).catch((function(e){console.error(e),k.onError(P,new w(b,"Search for Parametric Map instances failed.")),t(e instanceof Error?e:new Error(String(e)))}))}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))),o.populateViewports=function(){console.info("populate viewports..."),o.setState({isLoading:!0,presentationStates:[]}),null!==o.volumeViewportRef.current&&o.volumeViewer.render({container:o.volumeViewportRef.current}),null!==o.labelViewportRef.current&&null!==o.labelViewer&&void 0!==o.labelViewer&&o.labelViewer.render({container:o.labelViewportRef.current}),o.setState({isLoading:!1}),o.setDefaultPresentationState(),o.loadPresentationStates(),Promise.allSettled([o.addAnnotations(),o.addAnnotationGroups(),o.addSegmentations(),o.addParametricMaps()]).then((function(){console.debug("Loaded annotations, annotation groups, segmentations, and parametric maps!"),null!==o.props.derivedDataset&&void 0!==o.props.derivedDataset&&o.loadDerivedDataset(o.props.derivedDataset)})).catch((function(e){console.error("Failed to add derived data:",e)}))},o.onRoiModified=function(e){o.setState((function(e){return{visibleRoiUIDs:new Set(e.visibleRoiUIDs)}}))},o.onWindowResize=function(e){console.info("resize viewports"),o.volumeViewer.resize(),null!==o.labelViewer&&void 0!==o.labelViewer&&o.labelViewer.resize()},o.onRoiDrawn=function(e){var t=e.detail.payload,n=o.state.selectedFinding,i=o.state.selectedEvaluations;if(void 0!==t&&void 0!==n){it.debug('add ROI "'.concat(t.uid,'"'));var a=new H.sr.valueTypes.CodeContentItem({name:new H.sr.coding.CodedConcept({value:"121071",meaning:"Finding",schemeDesignator:"DCM"}),value:n,relationshipType:"CONTAINS"});t.addEvaluation(a),i.forEach((function(e){var n=new H.sr.valueTypes.CodeContentItem({name:e.name,value:e.value,relationshipType:"CONTAINS"});t.addEvaluation(n)}));var r=mn(n),s=o.getRoiStyle(r);o.volumeViewer.addROI(t,s),o.setState((function(e){var n=e.visibleRoiUIDs;return n.add(t.uid),{visibleRoiUIDs:n}}))}else it.debug('could not add ROI "'.concat(t.uid,'"'))},o.onRoiDoubleClicked=function(e){var t=e.detail.payload;if(null!==t){var n=t.uid;if(o.volumeViewer.getAllAnnotationGroups().some((function(e){return null===n||void 0===n?void 0:n.startsWith("".concat(String(e.uid),"-"))})))return;o.setState({selectedRoi:t,isSelectedRoiModalVisible:!0})}else o.setState({selectedRoi:void 0,isSelectedRoiModalVisible:!1})},o.setHoveredRoiAttributes=function(e){var t=o.volumeViewer.getAllROIs();if(0!==e.length){var n=e.map((function(e){var n,i=e.roi,a=e.annotationGroupUID;if(null!==a&&void 0!==a)try{var r=o.annotationGroupMetadataCache.get(a);void 0===r&&(r=o.volumeViewer.getAnnotationGroupMetadata(a),o.annotationGroupMetadataCache.set(a,r));var s=r.AnnotationGroupSequence.find((function(e){return e.AnnotationGroupUID===a}));if(null!=s){var l=[],c="";if(void 0!==r.SeriesInstanceUID&&null!==r.SeriesInstanceUID&&void 0!==(c=o.getSeriesDescription(r.SeriesInstanceUID))&&null!==c&&""!==c&&l.push({name:"Series Description",value:c}),void 0!==s.AnnotationGroupLabel&&""!==s.AnnotationGroupLabel&&l.push({name:"Annotation Group Label",value:s.AnnotationGroupLabel}),void 0!==s.AnnotationPropertyCategoryCodeSequence&&s.AnnotationPropertyCategoryCodeSequence.length>0){var u=s.AnnotationPropertyCategoryCodeSequence[0],d=void 0!==u.CodeMeaning&&""!==u.CodeMeaning?u.CodeMeaning:u.CodeValue;l.push({name:"Property category",value:d})}if(void 0!==s.AnnotationPropertyTypeCodeSequence&&s.AnnotationPropertyTypeCodeSequence.length>0){var p=s.AnnotationPropertyTypeCodeSequence[0],h=void 0!==p.CodeMeaning&&""!==p.CodeMeaning?p.CodeMeaning:p.CodeValue;l.push({name:"Property type",value:h})}var v=i.uid,m=0;if(void 0!==v&&null!==v&&""!==v&&v.includes("-")){var f=v.split("-"),g=f[f.length-1],S=parseInt(g,10);Number.isNaN(S)||(m=S)}return{index:m+1,roiUid:v,attributes:l,seriesDescription:c}}}catch(I){it.warn("Failed to get annotation group metadata for ".concat(a,":"),I)}if(0===t.length)return{index:0,roiUid:i.uid,attributes:[],seriesDescription:""};var y=[];return i.evaluations.forEach((function(e){var t=e.ConceptNameCodeSequence[0].CodeValue,n=e.ConceptNameCodeSequence[0].CodeMeaning,i="".concat(n);if(e.ValueType===H.sr.valueTypes.ValueTypes.CODE){var o=e.ConceptCodeSequence[0].CodeMeaning;"276214006"===t?y.push({name:"Property category",value:"".concat(o)}):"121071"===t?y.push({name:"Property type",value:"".concat(o)}):"111001"===t?y.push({name:"Algorithm Name",value:"".concat(o)}):y.push({name:i,value:"".concat(o)})}else if(e.ValueType===H.sr.valueTypes.ValueTypes.TEXT){var a=e;y.push({name:i,value:a.TextValue})}})),{index:(null!==(n=t.findIndex((function(e){return e.uid===i.uid})))&&void 0!==n?n:0)+1,roiUid:i.uid,attributes:y,seriesDescription:""}}));n.sort((function(e,t){var n=e.index-t.index;if(0!==n)return n;var i=null!==e.seriesDescription&&void 0!==e.seriesDescription&&""!==e.seriesDescription?e.seriesDescription:"",o=null!==t.seriesDescription&&void 0!==t.seriesDescription&&""!==t.seriesDescription?t.seriesDescription:"";return i.localeCompare(o)})),o.setState({hoveredRoiAttributes:n})}else o.setState({hoveredRoiAttributes:[]})},o.clearHoveredRois=function(){o.hoveredRois=[]},o.isSamePixelAsLast=function(e){return e.clientX===o.lastPixel[0]&&e.clientY===o.lastPixel[1]},o.onPointerMove=function(e){o.handlePointerMoveDebounced(e)},o.handlePointerMoveEvent=function(e){var t=e.detail.payload,n=t.features,i=t.event.originalEvent;o.isSamePixelAsLast(i)||(o.lastPixel=[i.clientX,i.clientY],o.clearHoveredRois());var a=[];if(null!==n&&void 0!==n&&n.length>0){var r,s=(0,z.Z)(n);try{for(s.s();!(r=s.n()).done;){var l=r.value;null!==l.feature&&void 0!==l.feature&&a.push({roi:l.feature,annotationGroupUID:null!==l.annotationGroupUID&&void 0!==l.annotationGroupUID?l.annotationGroupUID:null})}}catch(m){s.e(m)}finally{s.f()}}for(var c=new Map,u=0,d=a;u<d.length;u++){var p=d[u];c.has(p.roi.uid)||c.set(p.roi.uid,p)}var h=Array.from(c.values()).filter((function(e){var t=e.roi,n=e.annotationGroupUID;return null!==n&&void 0!==n?o.state.visibleAnnotationGroupUIDs.has(n):o.state.visibleRoiUIDs.has(t.uid)}));if(o.hoveredRois=h,o.hoveredRois.length>0){var v=o.hoveredRois.map((function(e){var t=e.roi,n=e.annotationGroupUID;return"".concat(t.uid,":").concat(null!==n&&void 0!==n?n:"")})).sort((function(e,t){return e.localeCompare(t)})).join("|");if(o.lastHoveredRoiSignature===v&&o.state.isHoveredRoiTooltipVisible)return void o.setState({hoveredRoiTooltipX:i.clientX,hoveredRoiTooltipY:i.clientY});o.lastHoveredRoiSignature=v,o.setHoveredRoiAttributes(o.hoveredRois),o.setState({isHoveredRoiTooltipVisible:!0,hoveredRoiTooltipX:i.clientX,hoveredRoiTooltipY:i.clientY})}else o.lastHoveredRoiSignature=null,o.setState({isHoveredRoiTooltipVisible:!1})},o.getUpdatedSelectedRois=function(e){var t=e,n={selectedRoiUIDs:new Set,selectedRoi:void 0};if(void 0===t)return n;var i=o.volumeViewer.getROI(t);if(void 0===i)return n;if(it.debug('selected ROI "'.concat(i.uid,'"')),!o.keysDown.has("Shift"))return{selectedRoiUIDs:new Set([i.uid]),selectedRoi:i};var a=Array.from(o.state.selectedRoiUIDs);return{selectedRoiUIDs:new Set([].concat(a,[i.uid])),selectedRoi:i}},o.resetUnselectedRoiStyles=function(e){o.volumeViewer.getAllROIs().forEach((function(t){var n=t.uid;if(!e.selectedRoiUIDs.has(n)&&o.state.visibleRoiUIDs.has(n)){var i=fn(t),a=o.getRoiStyle(i);o.volumeViewer.setROIStyle(n,a)}}))},o.onMapClicked=function(e){var t,n,i;if(0===(null!==(t=null===(n=e.detail)||void 0===n||null===(i=n.payload)||void 0===i?void 0:i.rois)&&void 0!==t?t:[]).length){var a=o.getUpdatedSelectedRois();o.setState(a),o.volumeViewer.clearSelections(),o.resetUnselectedRoiStyles(a)}},o.onRoiSelected=function(e){var t,n=null===(t=e.detail)||void 0===t?void 0:t.payload;if(null!==n&&void 0!==n&&"object"===typeof n&&"uid"in n&&"scoord3d"in n){var i=n,a=o.keysDown.has("Shift")?{selectedRoiUIDs:new Set([].concat((0,X.Z)(Array.from(o.state.selectedRoiUIDs)),[i.uid])),selectedRoi:i}:{selectedRoiUIDs:new Set([i.uid]),selectedRoi:i};o.setState(a),o.resetUnselectedRoiStyles(a)}else{var r=null===n||void 0===n?void 0:n.uid,s=o.getUpdatedSelectedRois(r);o.setState(s),o.resetUnselectedRoiStyles(s)}},o.handleAnnotationSelection=function(e){o.volumeViewer.clearSelections();var t=o.getUpdatedSelectedRois(e);o.setState(t),o.volumeViewer.getAllROIs().forEach((function(e){var n={};if(t.selectedRoiUIDs.has(e.uid))n=o.selectedRoiStyle,o.setState((function(t){var n=t.visibleRoiUIDs;return n.add(e.uid),{visibleRoiUIDs:n}}));else if(o.state.visibleRoiUIDs.has(e.uid)){var i=fn(e);n=o.getRoiStyle(i)}o.volumeViewer.setROIStyle(e.uid,n)}))},o.handleRoiSelectionCancellation=function(){it.log("cancel ROI selection"),o.setState({isSelectedRoiModalVisible:!1})},o.onLoadingStarted=function(e){o.setState({isLoading:!0})},o.onLoadingEnded=function(e){o.setState({isLoading:!1})},o.onFrameLoadingStarted=function(e){var t=e.detail.payload,n="".concat(t.sopInstanceUID,"-").concat(t.frameNumber);o.setState((function(e){return e.loadingFrames.add(n),e}))},o.onFrameLoadingError=function(e){console.error("Failed to load frame")},o.onLoadingError=function(e){var t,n,i,o=null!==(t=null===(n=e.detail)||void 0===n||null===(i=n.payload)||void 0===i?void 0:i.message)&&void 0!==t?t:"Failed to load data";console.error(o),k.onError(P,new w(b,o))},o.onFrameLoadingEnded=function(e){var t=e.detail.payload,n="".concat(t.sopInstanceUID,"-").concat(t.frameNumber);if(o.setState((function(e){e.loadingFrames.delete(n);var t=!1;return e.loadingFrames.size>0&&(t=!0),{isLoading:t,loadingFrames:e.loadingFrames}})),t.sopClassUID===L.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE&&o.props.slide.areVolumeImagesMonochrome){var i=t.channelIdentifier;if(!(i in o.state.pixelDataStatistics)&&null!==t.pixelArray){for(var a=Math.pow(2,16),r=Math.ceil(t.pixelArray.length/a),s=0,l=[],c=[],u=0;u<r;u++){s=u*a;var d=t.pixelArray.slice(s,s+a);l.push(Math.min.apply(Math,(0,X.Z)(d))),c.push(Math.max.apply(Math,(0,X.Z)(d)))}var p=Math.min.apply(Math,l),h=Math.max.apply(Math,c);o.setState((function(e){var t=e.pixelDataStatistics;if(null!==t[i]&&void 0!==t[i]?t[i]={min:Math.min(t[i].min,p),max:Math.max(t[i].max,h),numFramesSampled:t[i].numFramesSampled+1}:t[i]={min:p,max:h,numFramesSampled:1},null===e.selectedPresentationStateUID){var n=(0,re.Z)({},o.volumeViewer.getOpticalPathStyle(i));n.limitValues=[t[i].min,t[i].max],o.volumeViewer.setOpticalPathStyle(i,n)}return e}))}}},o.onRoiRemoved=function(e){var t=e.detail.payload;it.debug('removed ROI "'.concat(t.uid,'"'))},o.componentCleanup=function(){document.body.removeEventListener("dicommicroscopyviewer_roi_drawn",o.onRoiDrawn),document.body.removeEventListener("dicommicroscopyviewer_viewport_clicked",o.onMapClicked),document.body.removeEventListener("dicommicroscopyviewer_roi_selected",o.onRoiSelected),document.body.removeEventListener("dicommicroscopyviewer_roi_double_clicked",o.onRoiDoubleClicked),document.body.removeEventListener("dicommicroscopyviewer_pointer_move",o.onPointerMove),document.body.removeEventListener("dicommicroscopyviewer_roi_removed",o.onRoiRemoved),document.body.removeEventListener("dicommicroscopyviewer_roi_modified",o.onRoiModified),document.body.removeEventListener("dicommicroscopyviewer_loading_started",o.onLoadingStarted),document.body.removeEventListener("dicommicroscopyviewer_loading_ended",o.onLoadingEnded),document.body.removeEventListener("dicommicroscopyviewer_frame_loading_started",o.onFrameLoadingStarted),document.body.removeEventListener("dicommicroscopyviewer_frame_loading_ended",o.onFrameLoadingEnded),document.body.removeEventListener("keyup",o.onKeyUp),document.body.removeEventListener("keyup",o.onKeyDown),window.removeEventListener("resize",o.onWindowResize),o.volumeViewer.cleanup(),null!==o.labelViewer&&void 0!==o.labelViewer&&o.labelViewer.cleanup()},o.onKeyDown=function(e){o.keysDown.add(e.key)},o.onKeyUp=function(e){o.keysDown.delete(e.key),"Escape"===e.key?(o.state.isRoiDrawingActive?(it.log("deactivate drawing of ROIs"),o.volumeViewer.deactivateDrawInteraction(),o.volumeViewer.activateSelectInteraction({})):o.state.isRoiModificationActive?(it.log("deactivate modification of ROIs"),o.volumeViewer.deactivateModifyInteraction(),o.volumeViewer.activateSelectInteraction({})):o.state.isRoiTranslationActive&&(it.log("deactivate translation of ROIs"),o.volumeViewer.deactivateTranslateInteraction(),o.volumeViewer.activateSelectInteraction({})),o.setState({isAnnotationModalVisible:!1,isSelectedRoiModalVisible:!1,isRoiTranslationActive:!1,isRoiDrawingActive:!1,isRoiModificationActive:!1,isGoToModalVisible:!1})):e.altKey&&("KeyD"===e.code?o.handleRoiDrawing():"KeyM"===e.code?o.handleRoiModification():"KeyT"===e.code?o.handleRoiTranslation():"KeyR"===e.code?o.handleRoiRemoval():"KeyV"===e.code?o.handleRoiVisibilityChange():"KeyS"===e.code?o.handleReportGeneration():"KeyG"===e.code&&o.handleGoTo())},o.componentWillUnmount=function(){o.volumeViewer.cleanup(),null!==o.labelViewer&&void 0!==o.labelViewer&&o.labelViewer.cleanup(),o.handlePointerMoveDebounced.cancel(),window.removeEventListener("beforeunload",o.componentCleanup)},o.componentSetup=function(){document.body.addEventListener("dicommicroscopyviewer_roi_drawn",o.onRoiDrawn),document.body.addEventListener("dicommicroscopyviewer_roi_selected",o.onRoiSelected),document.body.addEventListener("dicommicroscopyviewer_viewport_clicked",o.onMapClicked),document.body.addEventListener("dicommicroscopyviewer_roi_double_clicked",o.onRoiDoubleClicked),document.body.addEventListener("dicommicroscopyviewer_pointer_move",o.onPointerMove),document.body.addEventListener("dicommicroscopyviewer_roi_removed",o.onRoiRemoved),document.body.addEventListener("dicommicroscopyviewer_roi_modified",o.onRoiModified),document.body.addEventListener("dicommicroscopyviewer_loading_started",o.onLoadingStarted),document.body.addEventListener("dicommicroscopyviewer_loading_ended",o.onLoadingEnded),document.body.addEventListener("dicommicroscopyviewer_loading_error",o.onLoadingError),document.body.addEventListener("dicommicroscopyviewer_frame_loading_started",o.onFrameLoadingStarted),document.body.addEventListener("dicommicroscopyviewer_frame_loading_ended",o.onFrameLoadingEnded),document.body.addEventListener("dicommicroscopyviewer_frame_loading_error",o.onFrameLoadingError),document.body.addEventListener("keyup",o.onKeyUp),document.body.addEventListener("keydown",o.onKeyDown),window.addEventListener("beforeunload",o.componentCleanup),window.addEventListener("resize",o.onWindowResize)},o.componentDidMount=function(){if(o.componentSetup(),o.populateViewports(),!o.props.slide.areVolumeImagesMonochrome){var e=!1,t=o.props.slide.volumeImages[0],n=t.OpticalPathSequence[0];if(null===n.ICCProfile||void 0===n.ICCProfile){if("OpticalPathSequence"in t.bulkdataReferences)"ICCProfile"in t.bulkdataReferences.OpticalPathSequence[0]&&(e=!0)}else e=!0;e||l.ZP.warning("No ICC Profile was found for color images")}},o.handleAnnotationFindingSelection=function(e,t){o.findingOptions.forEach((function(t){t.CodeValue===e&&(console.info('selected finding "'.concat(t.CodeMeaning,'"')),o.setState({selectedFinding:t,selectedEvaluations:[]}))}))},o.handleAnnotationGeometryTypeSelection=function(e,t){o.setState({selectedGeometryType:e})},o.handleAnnotationMeasurementActivation=function(e){e.target.checked?o.setState({selectedMarkup:"measurement"}):o.setState({selectedMarkup:void 0})},o.handleAnnotationEvaluationSelection=function(e,t){var n=o.state.selectedFinding;if(void 0!==n){var i=mn(n),a=t.label;o.evaluationOptions[i].forEach((function(t){t.name.CodeValue===a.CodeValue&&t.name.CodingSchemeDesignator===a.CodingSchemeDesignator&&t.values.forEach((function(n){if(n.CodeValue===e){var i=o.state.selectedEvaluations.filter((function(e){return e.name!==t.name}));o.setState({selectedEvaluations:[].concat((0,X.Z)(i),[{name:a,value:n}])})}}))}))}},o.handleAnnotationEvaluationClearance=function(){o.setState({selectedEvaluations:[]})},o.handleXCoordinateSelection=function(e){if(null!==e&&void 0!==e){var t=Number(e);o.setState((function(e){var n=t>=e.validXCoordinateRange[0]&&t<=e.validXCoordinateRange[1];return{selectedXCoordinate:t,isSelectedXCoordinateValid:n}}))}else o.setState({selectedXCoordinate:void 0,isSelectedXCoordinateValid:!1})},o.handleYCoordinateSelection=function(e){if(null!==e&&void 0!==e){var t=Number(e);o.setState((function(e){var n=t>=e.validYCoordinateRange[0]&&t<=e.validYCoordinateRange[1];return{selectedYCoordinate:t,isSelectedYCoordinateValid:n}}))}else o.setState({selectedYCoordinate:void 0,isSelectedYCoordinateValid:!1})},o.handleMagnificationSelection=function(e){if(null!==e&&void 0!==e){var t=Number(e);o.setState((function(){return{selectedMagnification:t,isSelectedMagnificationValid:t>=0&&t<=40}}))}else o.setState({selectedMagnification:void 0,isSelectedMagnificationValid:!1})},o.handleSlidePositionSelection=function(){if(o.state.isSelectedXCoordinateValid&&o.state.isSelectedYCoordinateValid&&o.state.isSelectedMagnificationValid&&null!==o.state.selectedXCoordinate&&void 0!==o.state.selectedXCoordinate&&null!==o.state.selectedYCoordinate&&void 0!==o.state.selectedYCoordinate&&null!==o.state.selectedMagnification&&void 0!==o.state.selectedMagnification){console.info("select slide position "+"(".concat(o.state.selectedXCoordinate,", ")+"".concat(o.state.selectedYCoordinate,") ")+"at ".concat(o.state.selectedMagnification,"x magnification"));for(var e=.01/o.state.selectedMagnification,t=[],n=0;n<o.volumeViewer.numLevels;n++){var i=o.volumeViewer.getPixelSpacing(n)[0];t.push(Math.abs(e-i))}var a=t.indexOf(Math.min.apply(Math,t));o.volumeViewer.navigate({position:[o.state.selectedXCoordinate,o.state.selectedYCoordinate],level:a});var r=new Y.scoord3d.Point({coordinates:[o.state.selectedXCoordinate,o.state.selectedYCoordinate,0],frameOfReferenceUID:o.volumeViewer.frameOfReferenceUID}),s=new Y.roi.ROI({scoord3d:r});o.volumeViewer.addROI(s,o.defaultRoiStyle),o.setState((function(e){var t=e.visibleRoiUIDs;return t.add(s.uid),{visibleRoiUIDs:t,isGoToModalVisible:!1}}))}},o.handleSlidePositionSelectionCancellation=function(){console.info("cancel slide position selection"),o.setState({isGoToModalVisible:!1,selectedXCoordinate:void 0,selectedYCoordinate:void 0,selectedMagnification:void 0})},o.handleAnnotationConfigurationCompletion=function(){it.debug("complete annotation configuration");var e=o.state.selectedFinding,t=o.state.selectedGeometryType,n=o.state.selectedMarkup;void 0!==t&&void 0!==e?(o.volumeViewer.activateDrawInteraction({geometryType:t,markup:n}),o.setState({isAnnotationModalVisible:!1,isRoiDrawingActive:!0})):k.onError(P,new w(b,"Could not complete annotation configuration"))},o.handleAnnotationConfigurationCancellation=function(){it.log("cancel annotation configuration"),o.volumeViewer.activateSelectInteraction({}),o.setState({isAnnotationModalVisible:!1,isRoiDrawingActive:!1})},o.handleReportGeneration=function(){it.log("save ROIs");var e=o.volumeViewer.getAllROIs(),t=o.volumeViewer.getAllOpticalPaths(),n=o.volumeViewer.getOpticalPathMetadata(t[0].identifier);o.setState((function(t){var i=tt({rois:e,metadata:n,user:o.props.user,app:o.props.app,visibleRoiUIDs:t.visibleRoiUIDs});return{isReportModalVisible:i.isReportModalVisible,generatedReport:i.generatedReport}}))},o.handleReportVerification=function(){(it.log("verify report generation"),void 0!==o.state.generatedReport)&&o.props.clients[L.COMPREHENSIVE_3D_SR].storeInstances({datasets:[o.state.generatedReport.write()]}).then((function(){return l.ZP.info("Annotations were saved.")})).catch((function(e){it.error(e),k.onError(P,new w(C,"Annotations could not be saved"))}));o.setState({isReportModalVisible:!1,generatedReport:void 0})},o.handleReportCancellation=function(){o.setState({isReportModalVisible:!1,generatedReport:void 0})},o.handleAnnotationVisibilityChange=function(e){var t=e.roiUID;if(e.isVisible){it.log("show ROI ".concat(t));var n=o.volumeViewer.getROI(t),i=fn(n),a=o.getRoiStyle(i);o.volumeViewer.setROIStyle(n.uid,a),o.setState((function(e){var t=e.visibleRoiUIDs;return t.add(n.uid),{visibleRoiUIDs:t}}))}else it.log("hide ROI ".concat(t)),o.setState((function(e){var n=e.selectedRoiUIDs;n.delete(t);var i=e.visibleRoiUIDs;return i.delete(t),{visibleRoiUIDs:i,selectedRoiUIDs:n}})),o.volumeViewer.setROIStyle(t,{})},o.handleAnnotationGroupVisibilityChange=function(e){var t,n=e.annotationGroupUID,i=e.isVisible,a=o.volumeViewer.getAllAnnotationGroups().find((function(e){return e.uid===n}));if(null!==a&&void 0!==a&&(t={dialog:!0,context:{annotationGroup:a,slide:o.props.slide}},null===we||void 0===we?console.warn("Validation context not available. Make sure ValidationProvider is mounted."):we.runValidations(t)),it.log("change visibility of annotation group ".concat(n)),i){it.log("show annotation group ".concat(n));try{o.volumeViewer.showAnnotationGroup(n)}catch(r){throw k.onError(P,new w(b,"Failed to show annotation group.")),r}o.setState((function(e){var t=new Set(e.visibleAnnotationGroupUIDs);return t.add(n),{visibleAnnotationGroupUIDs:t}}))}else it.log("hide annotation group ".concat(n)),o.volumeViewer.hideAnnotationGroup(n),o.setState((function(e){var t=new Set(e.visibleAnnotationGroupUIDs);return t.delete(n),{visibleAnnotationGroupUIDs:t}}))},o.handleAnnotationGroupStyleChange=function(e){var t=e.uid,n=e.styleOptions;it.log("change style of annotation group ".concat(t));try{o.volumeViewer.setAnnotationGroupStyle(t,n)}catch(i){throw k.onError(P,new w(b,"Failed to change style of annotation group.")),i}},o.generateRoiStyle=function(e){var t,n,i,a=null!==(t=e.opacity)&&void 0!==t?t:.4,r=null!==(n=e.color)&&void 0!==n?n:Qt,s=e.contourOnly?[0,0,0,0]:r.map((function(e){return Math.min(e+25,255)}));return Sn({fill:{color:[].concat((0,X.Z)(s),[a])},stroke:{color:[].concat((0,X.Z)(r),[a])},radius:null===(i=o.defaultRoiStyle.stroke)||void 0===i?void 0:i.width})},o.handleRoiStyleChange=function(e){var t=e.uid,n=e.styleOptions;it.log("change style of ROI ".concat(t));try{o.defaultAnnotationStyles[t]=n;var i=o.generateRoiStyle(n),a=o.volumeViewer.getROI(t),r=fn(a);o.roiStyles[r]=i,o.volumeViewer.setROIStyle(t,i),o.state.visibleRoiUIDs.add(t)}catch(s){throw k.onError(P,new w(b,"Failed to change style of ROI.")),s}},o.handleSegmentVisibilityChange=function(e){var t=e.segmentUID,n=e.isVisible;it.log("change visibility of segment ".concat(t)),n?(it.log("show segment ".concat(t)),o.volumeViewer.showSegment(t),o.setState((function(e){var n=new Set(e.visibleSegmentUIDs);return n.add(t),{visibleSegmentUIDs:n}}))):(it.log("hide segment ".concat(t)),o.volumeViewer.hideSegment(t),o.setState((function(e){var n=new Set(e.visibleSegmentUIDs);return n.delete(t),{visibleSegmentUIDs:n}})))},o.handleSegmentStyleChange=function(e){var t,i=e.segmentUID,a=e.styleOptions;if(it.log("change style of segment ".concat(i)),void 0!==a.color){var r=a.color;o.setState((function(e){return{customizedSegmentColors:(0,re.Z)((0,re.Z)({},e.customizedSegmentColors),{},(0,Oe.Z)({},i,r))}}))}void 0!==a.color&&(t=n.createSegmentPaletteColorLookupTable(a.color)),o.volumeViewer.setSegmentStyle(i,{opacity:a.opacity,paletteColorLookupTable:t})},o.handleMappingVisibilityChange=function(e){var t=e.mappingUID,n=e.isVisible;it.log("change visibility of mapping ".concat(t)),n?(it.log("show mapping ".concat(t)),o.volumeViewer.showParameterMapping(t),o.setState((function(e){var n=new Set(e.visibleMappingUIDs);return n.add(t),{visibleMappingUIDs:n}}))):(it.log("hide mapping ".concat(t)),o.volumeViewer.hideParameterMapping(t),o.setState((function(e){var n=new Set(e.visibleMappingUIDs);return n.delete(t),{visibleMappingUIDs:n}})))},o.handleMappingStyleChange=function(e){var t=e.mappingUID,n=e.styleOptions;it.log("change style of mapping ".concat(t)),o.volumeViewer.setParameterMappingStyle(t,n)},o.handleOpticalPathVisibilityChange=function(e){var t=e.opticalPathIdentifier,n=e.isVisible;it.log("change visibility of optical path ".concat(t)),n?(it.log("show optical path ".concat(t)),o.volumeViewer.showOpticalPath(t),o.setState((function(e){var n=new Set(e.visibleOpticalPathIdentifiers);return n.add(t),{visibleOpticalPathIdentifiers:n}}))):(it.log("hide optical path ".concat(t)),o.volumeViewer.hideOpticalPath(t),o.setState((function(e){var n=new Set(e.visibleOpticalPathIdentifiers);return n.delete(t),{visibleOpticalPathIdentifiers:n}})))},o.handleOpticalPathStyleChange=function(e){var t=e.opticalPathIdentifier,n=e.styleOptions;it.log("change style of optical path ".concat(t)),o.volumeViewer.setOpticalPathStyle(t,n)},o.handleOpticalPathActivityChange=function(e){var t=e.opticalPathIdentifier,n=e.isActive;it.log("change activity of optical path ".concat(t)),n?(it.log("activate optical path ".concat(t)),o.volumeViewer.activateOpticalPath(t),o.setState((function(e){var n=new Set(e.activeOpticalPathIdentifiers);return n.add(t),{activeOpticalPathIdentifiers:n}}))):(it.log("deactivate optical path ".concat(t)),o.volumeViewer.deactivateOpticalPath(t),o.setState((function(e){var n=new Set(e.activeOpticalPathIdentifiers);return n.delete(t),{activeOpticalPathIdentifiers:n}})))},o.setDefaultPresentationState=function(){var e=new Set,t=o.volumeViewer.getAllOpticalPaths();if(t.sort((function(e,t){return 1===e.identifier.localeCompare(t.identifier)?1:1===t.identifier.localeCompare(e.identifier)?-1:0})),t.forEach((function(t){var n=t.identifier,i=o.volumeViewer.getOpticalPathDefaultStyle(n);o.volumeViewer.setOpticalPathStyle(n,i),o.volumeViewer.hideOpticalPath(n),o.volumeViewer.deactivateOpticalPath(n),t.isMonochromatic?null!==t.paletteColorLookupTableUID&&void 0!==t.paletteColorLookupTableUID&&e.add(n):e.add(n)})),0===e.size){var n=[[255,255,255]];t.forEach((function(t){var i=t.identifier;if(t.isMonochromatic){var a=e.size;if(a<n.length){var r=(0,re.Z)({},o.volumeViewer.getOpticalPathStyle(i)),s=a;r.color=n[s];var l=o.state.pixelDataStatistics[t.identifier];null!==l&&void 0!==l&&(r.limitValues=[l.min,l.max]),o.volumeViewer.setOpticalPathStyle(t.identifier,r),e.add(t.identifier)}}}))}console.info("selected n=".concat(e.size," optical paths ")+"for visualization"),e.forEach((function(e){o.volumeViewer.showOpticalPath(e)})),o.setState((function(t){return{activeOpticalPathIdentifiers:new Set(e),visibleOpticalPathIdentifiers:new Set(e)}}))},o.handlePresentationStateReset=function(){o.setState({selectedPresentationStateUID:void 0});var e=o.props.location.pathname;o.props.navigate(e),o.setDefaultPresentationState()},o.handlePresentationStateSelection=function(e,t){var n;if(null!==e)if(console.info('select Presentation State instance "'.concat(null!==e&&void 0!==e?e:"undefined",'"')),o.state.presentationStates.forEach((function(t){t.SOPInstanceUID===e&&(n=t)})),null!==n&&void 0!==n){var i=o.props.location.pathname;i+="?state=".concat(null!==e&&void 0!==e?e:""),o.props.navigate(i),o.setPresentationState(n)}else k.onError(P,new w(b,"Presentation State could not be found")),console.log("failed to handle section of presentation state: "+'could not find instance "'.concat(null!==e&&void 0!==e?e:"undefined",'"'));else o.handlePresentationStateReset();o.setState({selectedPresentationStateUID:e})},o.handleRoiDrawing=function(){o.state.isRoiDrawingActive?(console.info("deactivate drawing of ROIs"),o.volumeViewer.deactivateDrawInteraction(),o.volumeViewer.activateSelectInteraction({}),o.setState({isAnnotationModalVisible:!1,isSelectedRoiModalVisible:!1,isRoiTranslationActive:!1,isRoiDrawingActive:!1,isRoiModificationActive:!1,isGoToModalVisible:!1})):(console.info("activate drawing of ROIs"),o.setState({isAnnotationModalVisible:!0,isSelectedRoiModalVisible:!1,isRoiDrawingActive:!0,isRoiModificationActive:!1,isRoiTranslationActive:!1,isGoToModalVisible:!1}),o.volumeViewer.deactivateSelectInteraction(),o.volumeViewer.deactivateSnapInteraction(),o.volumeViewer.deactivateTranslateInteraction(),o.volumeViewer.deactivateModifyInteraction())},o.handleRoiModification=function(){console.info("toggle modification of ROIs"),o.volumeViewer.isModifyInteractionActive?(o.volumeViewer.deactivateModifyInteraction(),o.volumeViewer.deactivateSnapInteraction(),o.volumeViewer.activateSelectInteraction({}),o.setState({isRoiTranslationActive:!1,isRoiDrawingActive:!1,isRoiModificationActive:!1})):(o.setState({isRoiModificationActive:!0,isRoiDrawingActive:!1,isRoiTranslationActive:!1}),o.volumeViewer.deactivateDrawInteraction(),o.volumeViewer.deactivateTranslateInteraction(),o.volumeViewer.deactivateSelectInteraction(),o.volumeViewer.activateSnapInteraction({}),o.volumeViewer.activateModifyInteraction({}))},o.handleRoiTranslation=function(){console.info("toggle translation of ROIs"),o.volumeViewer.isTranslateInteractionActive?(o.volumeViewer.deactivateTranslateInteraction(),o.setState({isRoiTranslationActive:!1,isRoiDrawingActive:!1,isRoiModificationActive:!1})):(o.setState({isRoiTranslationActive:!0,isRoiDrawingActive:!1,isRoiModificationActive:!1}),o.volumeViewer.deactivateModifyInteraction(),o.volumeViewer.deactivateSnapInteraction(),o.volumeViewer.deactivateDrawInteraction(),o.volumeViewer.deactivateSelectInteraction(),o.volumeViewer.activateTranslateInteraction({}))},o.handleGoTo=function(){o.volumeViewer.deactivateDrawInteraction(),o.volumeViewer.deactivateModifyInteraction(),o.volumeViewer.deactivateSnapInteraction(),o.volumeViewer.deactivateTranslateInteraction(),o.volumeViewer.deactivateSelectInteraction(),o.setState({isGoToModalVisible:!0,isAnnotationModalVisible:!1,isSelectedRoiModalVisible:!1,isReportModalVisible:!1,isRoiTranslationActive:!1,isRoiModificationActive:!1,isRoiDrawingActive:!1})},o.handleRoiRemoval=function(){o.volumeViewer.deactivateDrawInteraction(),o.volumeViewer.deactivateSnapInteraction(),o.volumeViewer.deactivateTranslateInteraction(),o.volumeViewer.deactivateModifyInteraction(),o.state.selectedRoiUIDs.size>0?(o.state.selectedRoiUIDs.forEach((function(e){void 0!==e?(console.info('remove ROI "'.concat(e,'"')),o.volumeViewer.removeROI(e),l.ZP.info("Annotation was removed")):l.ZP.warning("No annotation was selected for removal")})),o.setState({selectedRoiUIDs:new Set,isRoiTranslationActive:!1,isRoiDrawingActive:!1,isRoiModificationActive:!1})):(o.state.visibleRoiUIDs.forEach((function(e){console.info('remove ROI "'.concat(e,'"')),o.volumeViewer.removeROI(e)})),o.setState({visibleRoiUIDs:new Set,isRoiTranslationActive:!1,isRoiDrawingActive:!1,isRoiModificationActive:!1})),o.volumeViewer.activateSelectInteraction({})},o.handleRoiVisibilityChange=function(){console.info("toggle visibility of ROIs"),o.state.areRoisHidden?(o.volumeViewer.showROIs(),o.volumeViewer.activateSelectInteraction({}),o.state.selectedRoiUIDs.forEach((function(e){void 0!==e&&o.volumeViewer.setROIStyle(e,o.selectedRoiStyle)})),o.setState({areRoisHidden:!1})):(o.volumeViewer.deactivateDrawInteraction(),o.volumeViewer.deactivateSnapInteraction(),o.volumeViewer.deactivateTranslateInteraction(),o.volumeViewer.deactivateSelectInteraction(),o.volumeViewer.deactivateModifyInteraction(),o.volumeViewer.hideROIs(),o.setState({areRoisHidden:!0,isRoiDrawingActive:!1,isRoiModificationActive:!1,isRoiTranslationActive:!1}))},o.handleAnnotationGroupClick=function(e){o.volumeViewer.zoomToROI(e)},o.handleAnnotationGroupSelection=function(e){o.state.visibleAnnotationGroupUIDs.forEach((function(e){o.volumeViewer.hideAnnotationGroup(e)})),o.setState({selectedSeriesInstanceUID:e,visibleAnnotationGroupUIDs:new Set})},o.handleSegmentationSeriesSelection=function(e){var t;o.state.visibleSegmentUIDs.forEach((function(e){o.volumeViewer.hideSegment(e)}));var n=o.volumeViewer.getAllSegments(),i={},a={};n.forEach((function(e){var t,n,r;i[e.uid]=o.volumeViewer.getSegmentMetadata(e.uid);var s=null!==(t=null===(n=i[e.uid])||void 0===n||null===(r=n[0])||void 0===r?void 0:r.SeriesInstanceUID)&&void 0!==t?t:"unknown";s in a||(a[s]=[]),a[s].push(e)}));var r="all"===e?n:null!==(t=a[e])&&void 0!==t?t:[],s=o.state.visibleSegmentUIDs.size>0,l=new Set;s&&r.length>0&&r.forEach((function(e){l.add(e.uid)})),o.setState({selectedSegmentationSeriesInstanceUID:e,visibleSegmentUIDs:l}),l.forEach((function(e){o.volumeViewer.showSegment(e)}))},o.getSeriesDescription=function(e){var t=$e.getStudy(o.props.studyInstanceUID);if(null!==(null===t||void 0===t?void 0:t.series)&&null!==t&&void 0!==t){var n=t.series.find((function(t){return t.SeriesInstanceUID===e}));if(void 0!==(null===n||void 0===n?void 0:n.SeriesDescription)&&""!==n.SeriesDescription)return n.SeriesDescription}return"Series ".concat(e.slice(0,8),"...")},o.handleICCProfilesToggle=function(e){var t=e.target.checked;o.setState({isICCProfilesEnabled:t}),o.volumeViewer.toggleICCProfiles()},o.handleSegmentationInterpolationToggle=function(e){var t=e.target.checked;o.setState({isSegmentationInterpolationEnabled:t}),o.volumeViewer.toggleSegmentationInterpolation()},o.handleParametricMapInterpolationToggle=function(e){var t=e.target.checked;o.setState({isParametricMapInterpolationEnabled:t}),o.volumeViewer.toggleParametricMapInterpolation()},o.handleClusteringToggle=function(e){var t=!!e;o.setState((function(e){var n;if(e.isClusteringEnabled===t)return null;var i=t?null!==(n=e.clusteringPixelSizeThreshold)&&void 0!==n?n:.001:void 0;if(null!==o.volumeViewer&&void 0!==o.volumeViewer&&"function"===typeof o.volumeViewer.setAnnotationOptions)try{o.volumeViewer.setAnnotationOptions({clusteringPixelSizeThreshold:i})}catch(a){console.error("Failed to update annotation options:",a)}return{isClusteringEnabled:t}}))},o.handleClusteringPixelSizeThresholdChange=function(e){var t,n;(o.setState({clusteringPixelSizeThreshold:e}),o.state.isClusteringEnabled)&&(null===(t=(n=o.volumeViewer).setAnnotationOptions)||void 0===t||t.call(n,{clusteringPixelSizeThreshold:null!==e&&void 0!==e?e:void 0}))},o.formatAnnotation=function(e){var t,n=o.volumeViewer.getROI(e.uid),i=fn(n),a=void 0!==o.roiStyles[i]?null===(t=o.roiStyles[i].stroke)||void 0===t?void 0:t.color.slice(0,3):$t[Object.keys(o.roiStyles).length%$t.length];o.defaultAnnotationStyles[e.uid]={color:a,opacity:.4,contourOnly:!1},o.roiStyles[i]=o.generateRoiStyle(o.defaultAnnotationStyles[e.uid])},o.getDataFromViewer=function(){var e=[],t=[],n=[],i=[];e.push.apply(e,(0,X.Z)(o.volumeViewer.getAllROIs())),t.push.apply(t,(0,X.Z)(o.volumeViewer.getAllSegments())),n.push.apply(n,(0,X.Z)(o.volumeViewer.getAllParameterMappings()));var a=o.volumeViewer.getAllAnnotationGroups(),r=null===a||void 0===a?void 0:a.filter((function(e){return o.props.slide.seriesInstanceUIDs.includes(e.referencedSeriesInstanceUID)}));i.push.apply(i,(0,X.Z)(r));var s=e.map((function(e){return et(e)}));return{rois:e,segments:t,mappings:n,annotationGroups:i,annotations:s}},o.getReport=function(){var e=o.state.generatedReport;if(void 0!==e)return(0,se.jsx)(Ht,{dataset:e})},o.getAnnotationMenuItems=function(e){if(e.length>0)return(0,se.jsx)(Dt,{rois:e,selectedRoiUIDs:o.state.selectedRoiUIDs,visibleRoiUIDs:o.state.visibleRoiUIDs,onSelection:o.handleAnnotationSelection,onVisibilityChange:o.handleAnnotationVisibilityChange})},o.getFindingOptions=function(){return o.findingOptions.map((function(e,t){return(0,se.jsx)(Pe.Z.Option,{value:e.CodeValue,children:e.CodeMeaning},void 0!==e.CodeValue&&""!==e.CodeValue?e.CodeValue:"finding-".concat(t))}))},o.getAnnotationConfigurations=function(){var e=o.getFindingOptions(),t=n.getGeometryTypeOptionsMapping(),i=[(0,se.jsx)(Pe.Z,{style:{minWidth:130},onSelect:o.handleAnnotationFindingSelection,defaultActiveFirstOption:!0,placeholder:"Select finding",children:e},"annotation-finding")],a=o.state.selectedFinding;if(void 0!==a){var r=mn(a);o.evaluationOptions[r].forEach((function(e,t){var n=e.values.map((function(n){return(0,se.jsx)(Pe.Z.Option,{value:n.CodeValue,label:e.name,children:n.CodeMeaning},void 0!==n.CodeValue&&""!==n.CodeValue?n.CodeValue:"evaluation-".concat(t))}));i.push((0,se.jsxs)(se.Fragment,{children:[e.name.CodeMeaning,(0,se.jsx)(Pe.Z,{style:{minWidth:130},onSelect:o.handleAnnotationEvaluationSelection,allowClear:!0,onClear:o.handleAnnotationEvaluationClearance,defaultActiveFirstOption:!1,children:n})]}))}));var s=o.geometryTypeOptions[r].map((function(e){return t[e]}));i.push((0,se.jsxs)(se.Fragment,{children:["ROI geometry type",(0,se.jsx)(Pe.Z,{style:{minWidth:130},onSelect:o.handleAnnotationGeometryTypeSelection,placeholder:"Select geometry type",children:s},"annotation-geometry-type")]})),i.push((0,se.jsx)(Ue.Z,{onChange:o.handleAnnotationMeasurementActivation,children:"measure"},"annotation-measurement"))}return i},o.getSpecimenMenu=function(){return(0,se.jsx)(B.Z.SubMenu,{title:"Specimens",children:(0,se.jsx)(Vn,{metadata:o.props.slide.volumeImages[0],showstain:!1})},"specimens")},o.getEquipmentMenu=function(){return(0,se.jsx)(B.Z.SubMenu,{title:"Equipment",children:(0,se.jsx)(Vt,{metadata:o.props.slide.volumeImages[0]})},"equipment")},o.getOpticalPathMenu=function(){var e=o.volumeViewer.getAllOpticalPaths();e.sort((function(e,t){return 1===e.identifier.localeCompare(t.identifier)?1:1===t.identifier.localeCompare(e.identifier)?-1:0}));var t={},n={};return e.forEach((function(e){var i=e.identifier,a=o.volumeViewer.getOpticalPathMetadata(i);n[i]=a;var r=(0,re.Z)({},o.volumeViewer.getOpticalPathStyle(i));t[i]=r})),(0,se.jsx)(B.Z.SubMenu,{title:"Optical Paths",children:(0,se.jsx)(Gt,{metadata:n,opticalPaths:e,defaultOpticalPathStyles:t,visibleOpticalPathIdentifiers:o.state.visibleOpticalPathIdentifiers,activeOpticalPathIdentifiers:o.state.activeOpticalPathIdentifiers,onOpticalPathVisibilityChange:o.handleOpticalPathVisibilityChange,onOpticalPathStyleChange:o.handleOpticalPathStyleChange,onOpticalPathActivityChange:o.handleOpticalPathActivityChange,selectedPresentationStateUID:o.state.selectedPresentationStateUID})},"optical-paths")},o.getPresentationStateMenu=function(){if(o.state.presentationStates.length>0){var e=[];return o.state.presentationStates.forEach((function(t,n){e.push((0,se.jsx)(Pe.Z.Option,{value:t.SOPInstanceUID,dropdownMatchSelectWidth:!1,size:"small",children:void 0!==t.ContentDescription&&""!==t.ContentDescription?t.ContentDescription:"Untitled"},void 0!==t.SOPInstanceUID&&""!==t.SOPInstanceUID?t.SOPInstanceUID:"presentation-state-".concat(n)))})),e.push((0,se.jsx)(Pe.Z.Option,{value:void 0,dropdownMatchSelectWidth:!1,size:"small",children:null},"default-presentation-state")),(0,se.jsx)(B.Z.SubMenu,{title:"Presentation States",children:(0,se.jsxs)(Ee.Z,{align:"center",size:20,style:{padding:"14px"},children:[(0,se.jsx)(Pe.Z,{style:{minWidth:200,maxWidth:200},onSelect:o.handlePresentationStateSelection,value:o.state.selectedPresentationStateUID,children:e},"presentation-states"),(0,se.jsx)(Ie.Z,{title:"Reset",children:(0,se.jsx)(xt,{icon:Ze.Z,onClick:o.handlePresentationStateReset})})]})},"presentation-states")}},o.getSegmentationMenu=function(e){if(0!==e.length&&null!==o.volumeViewer&&void 0!==o.volumeViewer&&e.length>0){var t,i={},a={},r={};e.forEach((function(e,t){var s,l,c;a[e.uid]=o.volumeViewer.getSegmentMetadata(e.uid);var u=null!==(s=null===(l=a[e.uid])||void 0===l||null===(c=l[0])||void 0===c?void 0:c.SeriesInstanceUID)&&void 0!==s?s:"unknown";if(void 0===r[u]&&(r[u]=[]),r[u].push(e),"BINARY"!==st(a[e.uid][0])){var d=o.volumeViewer.getSegmentStyle(e.uid);i[e.uid]={opacity:d.opacity,color:void 0}}else{var p,h,v,m=o.volumeViewer.getSegmentStyle(e.uid),f=rt(null!==(p=null===(h=a[e.uid])||void 0===h?void 0:h[0])&&void 0!==p?p:{},e.number),g=null!==(v=o.state.customizedSegmentColors[e.uid])&&void 0!==v?v:f;i[e.uid]={opacity:m.opacity,color:g},o.volumeViewer.setSegmentStyle(e.uid,{opacity:i[e.uid].opacity,paletteColorLookupTable:null!==i[e.uid].color&&void 0!==i[e.uid].color?n.createSegmentPaletteColorLookupTable(i[e.uid].color):void 0})}})),void 0===o.state.selectedSegmentationSeriesInstanceUID&&0!==e.length&&o.setState({selectedSegmentationSeriesInstanceUID:"all"});var s=[{value:"all",label:"All Series (".concat(e.length," segments)")}].concat((0,X.Z)(Object.keys(r).map((function(e){var t,n;return{value:e,label:"".concat(o.getSeriesDescription(e)," (").concat(null!==(t=null===(n=r[e])||void 0===n?void 0:n.length)&&void 0!==t?t:0," segments)")}})))),l="all"===o.state.selectedSegmentationSeriesInstanceUID?e:void 0!==o.state.selectedSegmentationSeriesInstanceUID&&null!==(t=r[o.state.selectedSegmentationSeriesInstanceUID])&&void 0!==t?t:[];return(0,se.jsxs)(B.Z.SubMenu,{title:"Segmentations",children:[(0,se.jsx)("div",{style:{paddingLeft:"14px",paddingRight:"14px",paddingTop:"7px",paddingBottom:"7px"},children:(0,se.jsx)(Pe.Z,{style:{width:"100%"},placeholder:"Select a series",value:o.state.selectedSegmentationSeriesInstanceUID,onChange:o.handleSegmentationSeriesSelection,options:s})}),l.length>0&&(0,se.jsx)(Xt,{segments:l,metadata:a,defaultSegmentStyles:i,visibleSegmentUIDs:o.state.visibleSegmentUIDs,onSegmentVisibilityChange:o.handleSegmentVisibilityChange,onSegmentStyleChange:o.handleSegmentStyleChange})]},"segmentations")}},o.getParametricMapMenu=function(e){if(e.length>0){var t={},n={};return e.forEach((function(e){t[e.uid]=o.volumeViewer.getParameterMappingStyle(e.uid),n[e.uid]=o.volumeViewer.getParameterMappingMetadata(e.uid)})),(0,se.jsx)(B.Z.SubMenu,{title:"Parametric Maps",children:(0,se.jsx)(Zt,{mappings:e,metadata:n,defaultMappingStyles:t,visibleMappingUIDs:o.state.visibleMappingUIDs,onMappingVisibilityChange:o.handleMappingVisibilityChange,onMappingStyleChange:o.handleMappingStyleChange})},"parmetric-maps")}},o.getAnnotationGroupMenu=function(e){if(e.length>0){var t,n,i={},a={};e.forEach((function(e){a[e.uid]=o.volumeViewer.getAnnotationGroupStyle(e.uid),i[e.uid]=o.volumeViewer.getAnnotationGroupMetadata(e.uid)}));var r={};e.forEach((function(e){var t=e.seriesInstanceUID;t in r||(r[t]=[]),r[t].push(e)})),void 0===o.state.selectedSeriesInstanceUID&&0!==e.length&&o.setState({selectedSeriesInstanceUID:"all"});var s=[{value:"all",label:"All"}].concat((0,X.Z)(Object.keys(r).map((function(e){var t,n;return{value:e,label:"".concat(o.getSeriesDescription(e)," (").concat(null!==(t=null===(n=r[e])||void 0===n?void 0:n.length)&&void 0!==t?t:0," groups)")}})))),l="all"===o.state.selectedSeriesInstanceUID?e:void 0!==o.state.selectedSeriesInstanceUID&&null!==(t=r[o.state.selectedSeriesInstanceUID])&&void 0!==t?t:[];return(0,se.jsxs)(B.Z.SubMenu,{title:"Annotation Groups",children:[(0,se.jsx)("div",{style:{paddingLeft:"14px",paddingRight:"14px",paddingTop:"7px",paddingBottom:"7px"},children:(0,se.jsx)(Pe.Z,{style:{width:"100%"},placeholder:"Select a series",value:o.state.selectedSeriesInstanceUID,onChange:o.handleAnnotationGroupSelection,options:s})}),l.length>0&&(0,se.jsx)(Ct,{annotationGroups:l,metadata:i,onAnnotationGroupClick:o.handleAnnotationGroupClick,defaultAnnotationGroupStyles:a,visibleAnnotationGroupUIDs:o.state.visibleAnnotationGroupUIDs,onAnnotationGroupVisibilityChange:o.handleAnnotationGroupVisibilityChange,onAnnotationGroupStyleChange:o.handleAnnotationGroupStyleChange}),(0,se.jsx)(B.Z.Item,{className:"slim-multiline-menu-item",style:{height:"auto",padding:"0.9rem"},children:(0,se.jsx)(je.Z,{justify:"start",align:"middle",gutter:[8,8],children:(0,se.jsx)(Ae.Z,{span:24,children:(0,se.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"0.5rem"},children:[(0,se.jsx)("span",{children:"Enable Clustering"}),(0,se.jsx)(Te.Z,{checked:!!o.state.isClusteringEnabled,onChange:o.handleClusteringToggle})]})})})},"clustering-enabled"),o.state.isClusteringEnabled&&(0,se.jsx)(B.Z.Item,{className:"slim-multiline-menu-item",style:{height:"auto",padding:"0.9rem"},children:(0,se.jsxs)(je.Z,{justify:"start",align:"middle",gutter:[8,8],children:[(0,se.jsx)(Ae.Z,{span:24,children:(0,se.jsx)("div",{style:{marginBottom:"0.5rem"},children:"Clustering Pixel Size Threshold (mm)"})}),(0,se.jsx)(Ae.Z,{span:24,children:(0,se.jsx)(ke.Z,{min:0,max:100,step:.001,precision:3,style:{width:"100%"},value:null!==(n=o.state.clusteringPixelSizeThreshold)&&void 0!==n?n:void 0,onChange:o.handleClusteringPixelSizeThresholdChange,placeholder:"Auto (zoom-based)",addonAfter:"mm"})}),(0,se.jsx)(Ae.Z,{span:24,children:(0,se.jsx)("div",{style:{fontSize:"0.75rem",color:"#8c8c8c",marginTop:"0.5rem"},children:"When pixel size \u2264 threshold, clustering is disabled. Leave empty for zoom-based detection."})})]})},"clustering-threshold")]},"annotation-groups")}},o.getToolbar=function(){var e,t=[(0,se.jsx)(xt,{tooltip:"Draw ROI [Alt+D]",icon:d.vuA,onClick:o.handleRoiDrawing,isSelected:o.state.isRoiDrawingActive},"draw-roi-button"),(0,se.jsx)(xt,{tooltip:"Modify ROIs [Alt+M]",icon:d.eAi,onClick:o.handleRoiModification,isSelected:o.state.isRoiModificationActive},"modify-roi-button"),(0,se.jsx)(xt,{tooltip:"Translate ROIs [Alt+T]",icon:d.Jd7,onClick:o.handleRoiTranslation,isSelected:o.state.isRoiTranslationActive},"translate-roi-button"),(0,se.jsx)(xt,{tooltip:"Remove selected ROI [Alt+R]",onClick:o.handleRoiRemoval,icon:d.Xm5},"remove-roi-button"),(0,se.jsx)(xt,{tooltip:"Show/Hide ROIs [Alt+V]",icon:o.state.areRoisHidden?d.dSq:d.tgn,onClick:o.handleRoiVisibilityChange,isSelected:o.state.areRoisHidden},"toggle-roi-visibility-button"),(0,se.jsx)(xt,{tooltip:"Save ROIs [Alt+S]",icon:d.TvB,onClick:o.handleReportGeneration},"generate-report-button")],n=[(0,se.jsx)(xt,{tooltip:"Go to [Alt+G]",icon:d.Xe,onClick:o.handleGoTo},"go-to-slide-position-button")],i="0px";return o.props.enableAnnotationTools&&(e=(0,se.jsxs)(je.Z,{justify:"start",children:[t.map((function(e){return(0,se.jsx)(u.Fragment,{children:e},e.key)})),n.map((function(e){return(0,se.jsx)(u.Fragment,{children:e},e.key)}))]}),i="50px"),{toolbar:e,toolbarHeight:i}},o.getCursor=function(){return o.state.isLoading?"progress":"default"},o.getSelectedRoiInformation=function(){if(null!==o.state.selectedRoi&&void 0!==o.state.selectedRoi){var e=o.volumeViewer.getAllROIs().findIndex((function(e){var t;return e.uid===(null===(t=o.state.selectedRoi)||void 0===t?void 0:t.uid)})),t=[{name:"",value:"ROI ".concat(e>=0?e+1:"N/A")}],n=[{name:"Graphic type",value:o.state.selectedRoi.scoord3d.graphicType}],i=[];o.state.selectedRoi.evaluations.forEach((function(e){if("CODE"===e.ValueType){var t=e;i.push({name:t.ConceptNameCodeSequence[0].CodeMeaning,value:t.ConceptCodeSequence[0].CodeMeaning})}else{var n=e;i.push({name:n.ConceptNameCodeSequence[0].CodeMeaning,value:n.TextValue})}}));var a={};o.state.selectedRoi.measurements.forEach((function(e){var t="default";if(null!==e.ContentSequence&&void 0!==e.ContentSequence){var n=lt({content:e.ContentSequence,name:new H.sr.coding.CodedConcept({value:"121112",meaning:"Source of Measurement",schemeDesignator:"DCM"})});n.length>0&&(t=n[0].ReferencedSOPSequence[0].ReferencedOpticalPathIdentifier)}t in a||(a[t]=[]);var i=e.MeasuredValueSequence[0];a[t].push({name:e.ConceptNameCodeSequence[0].CodeMeaning,value:i.NumericValue.toString(),unit:i.MeasurementUnitsCodeSequence[0].CodeMeaning})}));var r=function(e){return e.map((function(e){var t;return t=null!==e.unit&&void 0!==e.unit?"".concat(e.value," [").concat(e.unit,"]"):e.value,(0,se.jsx)(ce.Z.Item,{label:e.name,children:t},e.name)}))},s=r(t),l=r(n),c=r(i),u=[];for(var d in a){var p=r(a[d]);"default"===d?u.push(p):u.push((0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)(Le.Z,{orientation:"left",orientationMargin:0,dashed:!0,plain:!0,children:d}),p]}))}return(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)(ce.Z,{layout:"horizontal",column:1,children:s}),(0,se.jsx)(Le.Z,{orientation:"left",orientationMargin:0,children:"Spatial coordinates"}),(0,se.jsx)(ce.Z,{layout:"horizontal",column:1,children:l}),(0,se.jsx)(Le.Z,{orientation:"left",orientationMargin:0,children:"Evaluations"}),(0,se.jsx)(ce.Z,{layout:"horizontal",column:1,children:c}),(0,se.jsx)(Le.Z,{orientation:"left",orientationMargin:0,children:"Measurements"}),(0,se.jsx)(ce.Z,{layout:"horizontal",column:1,children:u})]})}},o.getICCProfilesMenu=function(){return o.volumeViewer.getICCProfiles().length>0&&(0,se.jsx)("div",{style:{margin:"0.9rem"},children:(0,se.jsx)(Ue.Z,{checked:o.state.isICCProfilesEnabled,onChange:o.handleICCProfilesToggle,children:"ICC Profiles"})})},o.getSegmentationInterpolationMenu=function(){return o.volumeViewer.getAllSegments().length>0&&(0,se.jsx)("div",{style:{margin:"0.9rem"},children:(0,se.jsx)(Ue.Z,{checked:o.state.isSegmentationInterpolationEnabled,onChange:o.handleSegmentationInterpolationToggle,children:"Segmentation Interpolation"})})},o.getParametricMapInterpolationMenu=function(){return o.volumeViewer.getAllParameterMappings().length>0&&(0,se.jsx)("div",{style:{margin:"0.9rem"},children:(0,se.jsx)(Ue.Z,{checked:o.state.isParametricMapInterpolationEnabled,onChange:o.handleParametricMapInterpolationToggle,children:"Parametric Map Interpolation"})})},o.render=function(){var e,t=o.getDataFromViewer(),i=t.rois,a=t.segments,r=t.mappings,s=t.annotationGroups,l=t.annotations,u=n.getOpenSubMenuItems(),d=o.getReport(),p=o.getAnnotationMenuItems(i),h=o.getAnnotationConfigurations(),v=o.getSpecimenMenu(),m=o.getEquipmentMenu(),f=o.getOpticalPathMenu(),g=o.getPresentationStateMenu(),S=o.getSegmentationMenu(a),y=o.getParametricMapMenu(r),I=o.getAnnotationGroupMenu(s),C=o.getToolbar(),b=C.toolbar,w=C.toolbarHeight,D=o.getCursor(),x=o.getSelectedRoiInformation(),V=o.getICCProfilesMenu(),M=o.getSegmentationInterpolationMenu(),R=o.getParametricMapInterpolationMenu();return null!==S&&void 0!==S&&u.push("segmentations"),null!==y&&void 0!==y&&u.push("parametric-maps"),null!==I&&void 0!==I&&u.push("annotationGroups"),null===l||void 0===l||null===(e=l.forEach)||void 0===e||e.call(l,o.formatAnnotation),(0,se.jsxs)(c.Z,{style:{height:"100%"},hasSider:!0,children:[(0,se.jsx)(en,{toolbar:b,toolbarHeight:w,cursor:D,volumeViewportRef:o.volumeViewportRef,children:(0,se.jsx)(ln,{isAnnotationModalVisible:o.state.isAnnotationModalVisible,onAnnotationConfigurationCompletion:o.handleAnnotationConfigurationCompletion,onAnnotationConfigurationCancellation:o.handleAnnotationConfigurationCancellation,isAnnotationOkDisabled:!(void 0!==o.state.selectedFinding&&void 0!==o.state.selectedGeometryType),annotationConfigurations:h,isSelectedRoiModalVisible:o.state.isSelectedRoiModalVisible,onRoiSelectionCancellation:o.handleRoiSelectionCancellation,selectedRoiInformation:x,isGoToModalVisible:o.state.isGoToModalVisible,onSlidePositionSelection:o.handleSlidePositionSelection,onSlidePositionSelectionCancellation:o.handleSlidePositionSelectionCancellation,validXCoordinateRange:o.state.validXCoordinateRange,validYCoordinateRange:o.state.validYCoordinateRange,isSelectedXCoordinateValid:o.state.isSelectedXCoordinateValid,isSelectedYCoordinateValid:o.state.isSelectedYCoordinateValid,isSelectedMagnificationValid:o.state.isSelectedMagnificationValid,onXCoordinateSelection:o.handleXCoordinateSelection,onYCoordinateSelection:o.handleYCoordinateSelection,onMagnificationSelection:o.handleMagnificationSelection,isReportModalVisible:o.state.isReportModalVisible,onReportVerification:o.handleReportVerification,onReportCancellation:o.handleReportCancellation,report:d})}),(0,se.jsx)(vn,{labelViewportRef:o.labelViewportRef,labelViewer:o.labelViewer,openSubMenuItems:u,specimenMenu:v,iccProfilesMenu:V,segmentationInterpolationMenu:M,parametricMapInterpolationMenu:R,equipmentMenu:m,opticalPathMenu:f,presentationStateMenu:g,annotationMenuItems:p,annotationGroupMenu:I,segmentationMenu:S,parametricMapMenu:y,annotations:l,visibleRoiUIDs:o.state.visibleRoiUIDs,onAnnotationVisibilityChange:o.handleAnnotationVisibilityChange,onRoiStyleChange:o.handleRoiStyleChange,defaultAnnotationStyles:o.defaultAnnotationStyles}),o.state.isHoveredRoiTooltipVisible&&o.state.hoveredRoiAttributes.length>0?(0,se.jsx)(Mt,{xPosition:o.state.hoveredRoiTooltipX,yPosition:o.state.hoveredRoiTooltipY,rois:o.state.hoveredRoiAttributes}):null]})},it.log('view slide "'.concat(o.props.slide.containerIdentifier,'": '),o.props.slide);var a=["point","circle","box","polygon","line","freehandpolygon","freehandline"];e.annotations.forEach((function(e){var t=new H.sr.coding.CodedConcept(e.finding);o.findingOptions.push(t);var n=mn(t);void 0!==e.geometryTypes?o.geometryTypeOptions[n]=e.geometryTypes:o.geometryTypeOptions[n]=a,o.evaluationOptions[n]=[],void 0!==e.evaluations&&e.evaluations.forEach((function(e){o.evaluationOptions[n].push({name:new H.sr.coding.CodedConcept(e.name),values:e.values.map((function(e){return new H.sr.coding.CodedConcept(e)}))})})),void 0!==e.measurements&&e.measurements.forEach((function(e){o.measurements.push({name:new H.sr.coding.CodedConcept(e.name),value:void 0,unit:new H.sr.coding.CodedConcept(e.unit)})})),null!==e.style&&void 0!==e.style?o.roiStyles[n]=Sn(e.style):o.roiStyles[n]=o.defaultRoiStyle}));var r=yn({clients:o.props.clients,slide:o.props.slide,preload:o.props.preload,clusteringPixelSizeThreshold:void 0}),s=r.volumeViewer,p=r.labelViewer;o.volumeViewer=s,o.labelViewer=p,o.volumeViewportRef=u.createRef(),o.labelViewportRef=u.createRef(),o.volumeViewer.getAllOpticalPaths().forEach((function(e){o.volumeViewer.deactivateOpticalPath(e.identifier)}));var h=(0,F.Z)(o.volumeViewer.boundingBox,2),f=h[0],g=h[1];return o.state={selectedRoiUIDs:new Set,visibleRoiUIDs:new Set,visibleSegmentUIDs:new Set,visibleMappingUIDs:new Set,visibleAnnotationGroupUIDs:new Set,visibleOpticalPathIdentifiers:new Set,activeOpticalPathIdentifiers:new Set,presentationStates:[],selectedFinding:void 0,selectedEvaluations:[],generatedReport:void 0,isLoading:!1,isAnnotationModalVisible:!1,isSelectedRoiModalVisible:!1,isHoveredRoiTooltipVisible:!1,hoveredRoiTooltipX:0,hoveredRoiTooltipY:0,hoveredRoiAttributes:[],isSelectedMagnificationValid:!1,isReportModalVisible:!1,isRoiDrawingActive:!1,isRoiTranslationActive:!1,isRoiModificationActive:!1,isGoToModalVisible:!1,isSelectedXCoordinateValid:!1,isSelectedYCoordinateValid:!1,selectedXCoordinate:void 0,validXCoordinateRange:[f[0],f[0]+g[0]],selectedYCoordinate:void 0,validYCoordinateRange:[f[1],f[1]+g[1]],selectedMagnification:void 0,areRoisHidden:!1,selectedSeriesInstanceUID:void 0,selectedSegmentationSeriesInstanceUID:void 0,pixelDataStatistics:{},selectedPresentationStateUID:o.props.selectedPresentationStateUID,loadingFrames:new Set,isICCProfilesEnabled:!0,isSegmentationInterpolationEnabled:!1,isParametricMapInterpolationEnabled:!0,customizedSegmentColors:{},clusteringPixelSizeThreshold:null,isClusteringEnabled:!0},o.handlePointerMoveDebounced=_e()(o.handlePointerMoveEvent,0,{leading:!0,trailing:!0}),o}return(0,o.Z)(n,[{key:"componentDidUpdate",value:function(e,t){var n=this;if(this.props.location.pathname!==e.location.pathname||this.props.studyInstanceUID!==e.studyInstanceUID||this.props.seriesInstanceUID!==e.seriesInstanceUID||this.props.slide!==e.slide||this.props.clients!==e.clients){var i;null!==this.volumeViewportRef.current&&void 0!==this.volumeViewportRef.current&&(this.volumeViewportRef.current.innerHTML=""),this.volumeViewer.cleanup(),null!==this.labelViewer&&void 0!==this.labelViewer&&(null!==this.labelViewportRef.current&&void 0!==this.labelViewportRef.current&&(this.labelViewportRef.current.innerHTML=""),this.labelViewer.cleanup());var o=yn({clients:this.props.clients,slide:this.props.slide,preload:this.props.preload,clusteringPixelSizeThreshold:this.state.isClusteringEnabled&&null!==(i=this.state.clusteringPixelSizeThreshold)&&void 0!==i?i:void 0}),a=o.volumeViewer,r=o.labelViewer;this.volumeViewer=a,this.labelViewer=r;var s=new Set,l=new Set;this.volumeViewer.getAllOpticalPaths().forEach((function(e){var t=e.identifier;n.volumeViewer.isOpticalPathVisible(t)&&l.add(t),n.volumeViewer.isOpticalPathActive(t)&&s.add(t)}));var c=(0,F.Z)(this.volumeViewer.boundingBox,2),u=c[0],d=c[1];this.setState({visibleRoiUIDs:new Set,visibleSegmentUIDs:new Set,visibleMappingUIDs:new Set,visibleAnnotationGroupUIDs:new Set,visibleOpticalPathIdentifiers:l,activeOpticalPathIdentifiers:s,presentationStates:[],loadingFrames:new Set,selectedSeriesInstanceUID:void 0,validXCoordinateRange:[u[0],u[0]+d[0]],validYCoordinateRange:[u[1],u[1]+d[1]]}),this.populateViewports()}}},{key:"addAnnotations",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(){var t=this;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e,n){it.log("search for Comprehensive 3D SR instances");var i=t.props.clients[L.COMPREHENSIVE_3D_SR];i.searchForInstances({studyInstanceUID:t.props.studyInstanceUID,queryParams:{Modality:"SR"}}).then((function(n){null!==n&&void 0!==n||(n=[]),0!==n.length?n.forEach((function(n){var o=Y.metadata.formatMetadata(n).dataset;o.SOPClassUID===L.COMPREHENSIVE_3D_SR&&(it.log('retrieve SR instance "'.concat(o.SOPInstanceUID,'"')),i.retrieveInstance({studyInstanceUID:t.props.studyInstanceUID,seriesInstanceUID:o.SeriesInstanceUID,sopInstanceUID:o.SOPInstanceUID}).then((function(n){var i=H.aT.DicomMessage.readFile(n),o=Y.metadata.formatMetadata(i.dict).dataset;In(o)?Cn(o)?bn(o)?(new Bt(o).ROIs.forEach((function(e){it.log('add ROI "'.concat(e.uid,'"'));var n=e.scoord3d,i=t.props.slide.volumeImages[0];if(n.frameOfReferenceUID===i.FrameOfReferenceUID)if(t.volumeViewer.getAllROIs().some((function(t){return gn(t,e)})))it.debug('skip already existing ROI "'.concat(e.uid,'"'));else try{t.volumeViewer.addROI(e,{});var a=et(e);t.formatAnnotation(a)}catch(r){it.error('could not add ROI "'.concat(e.uid,'"'))}else it.debug('skip ROI "'.concat(e.uid,'" ')+'of SR document "'.concat(o.SOPInstanceUID,'"')+"because it is defined in another frame of reference")})),e()):it.debug('ignore SR document "'.concat(o.SOPInstanceUID,'" ')+"because it does not contain any suitable ROI annotations"):it.debug('ignore SR document "'.concat(o.SOPInstanceUID,'" ')+"because it does not describe a specimen subject"):it.debug('ignore SR document "'.concat(o.SOPInstanceUID,'" ')+'because it is not structured according to template TID 1500 "MeasurementReport"')})).catch((function(e){k.onError(P,new w(b,"Annotations could not be loaded")),it.error("failed to load ROIs "+'of SOP instance "'.concat(o.SOPInstanceUID,'" ')+'of series "'.concat(o.SeriesInstanceUID,'" ')+'of study "'.concat(t.props.studyInstanceUID,'": '),e)})),t.forceUpdate())})):e()})).catch((function(e){console.error(e),k.onError(P,new w(b,"Annotations could not be loaded")),n(e instanceof Error?e:new Error(String(e)))}))}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()}],[{key:"getOpenSubMenuItems",value:function(){return["specimens","optical-paths","annotations","presentation-states"]}},{key:"getGeometryTypeOptionsMapping",value:function(){return{point:(0,se.jsx)(Pe.Z.Option,{value:"point",children:"Point"},"point"),circle:(0,se.jsx)(Pe.Z.Option,{value:"circle",children:"Circle"},"circle"),box:(0,se.jsx)(Pe.Z.Option,{value:"box",children:"Box"},"box"),polygon:(0,se.jsx)(Pe.Z.Option,{value:"polygon",children:"Polygon"},"polygon"),line:(0,se.jsx)(Pe.Z.Option,{value:"line",children:"Line"},"line"),freehandpolygon:(0,se.jsx)(Pe.Z.Option,{value:"freehandpolygon",children:"Polygon (freehand)"},"freehandpolygon"),freehandline:(0,se.jsx)(Pe.Z.Option,{value:"freehandline",children:"Line (freehand)"},"freehandline")}}}]),n}(u.Component);Mn.createSegmentPaletteColorLookupTable=function(e){var t=[[0,0,0],e];return Y.color.buildPaletteColorLookupTable({data:t,firstValueMapped:0})};const Rn=le(Mn);var On=H.aT.DicomMetaDictionary.naturalizeDataset,Zn=function(e,t){return e.find((function(e){return e.seriesInstanceUIDs.find((function(e){return e===t}))}))};function Pn(e){var t=e.clients,n=e.slides,i=e.user,o=e.app,a=e.preload,r=e.enableAnnotationTools,s=e.annotations,l=(0,p.UO)(),c=l.studyInstanceUID,d=void 0===c?"":c,h=l.seriesInstanceUID,f=void 0===h?"":h,g=(0,p.TH)(),S=(0,u.useState)(Zn(n,f)),y=(0,F.Z)(S,2),I=y[0],C=y[1],b=(0,u.useState)(null),w=(0,F.Z)(b,2),D=w[0],x=w[1];(0,u.useEffect)((function(){var e,i=null!==(e=null===I||void 0===I?void 0:I.seriesInstanceUIDs.some((function(e){return e===f})))&&void 0!==e&&e;if(null===I||void 0===I||!i){var o=Zn(n,f);if(null!==o&&void 0!==o)return C(o),void x(null);var a=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(){var i,o,a,r,s,l,c,u,p,h,m,g,S,y,I,b,w,D,V,M,R;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return g=t[L.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE],e.next=3,g.retrieveSeriesMetadata({studyInstanceUID:d,seriesInstanceUID:f});case 3:if(S=e.sent,!(null!=(y=On(S[0])).ReferencedSeriesSequence&&y.ReferencedSeriesSequence.length>0)){e.next=24;break}I=(0,z.Z)(y.ReferencedSeriesSequence),e.prev=7,w=function(){var e=b.value.SeriesInstanceUID,t=n.find((function(t){return t.seriesInstanceUIDs.some((function(t){return t===e}))}));if(null!==t&&void 0!==t)return C(t),x(y),{v:void 0}},I.s();case 10:if((b=I.n()).done){e.next=16;break}if("object"!==typeof(D=w())){e.next=14;break}return e.abrupt("return",D.v);case 14:e.next=10;break;case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(7),I.e(e.t0);case 21:return e.prev=21,I.f(),e.finish(21);case 24:"111028",void 0!==(null===(V=null===(i=y.ContentSequence)||void 0===i?void 0:i.find((function(e){return"111028"===e.ConceptNameCodeSequence[0].CodeValue})))||void 0===V||null===(o=V.ContentSequence)||void 0===o||null===(a=o[0])||void 0===a||null===(r=a.ContentSequence)||void 0===r||null===(s=r[0])||void 0===s||null===(l=s.ReferencedSOPSequence)||void 0===l?void 0:l[0])&&null!==(null===V||void 0===V||null===(c=V.ContentSequence)||void 0===c||null===(u=c[0])||void 0===u||null===(p=u.ContentSequence)||void 0===p||null===(h=p[0])||void 0===h||null===(m=h.ReferencedSOPSequence)||void 0===m?void 0:m[0])&&(M=V.ContentSequence[0].ContentSequence[0].ReferencedSOPSequence[0].ReferencedSOPInstanceUID,R=n.find((function(e){return e.volumeImages.find((function(e){return e.SOPInstanceUID===M}))})),C(R),x(y));case 27:case"end":return e.stop()}}),e,null,[[7,18,21,24]])})));return function(){return e.apply(this,arguments)}}();a()}}),[n,t,d,f,I]);var V,M=new URLSearchParams(g.search);if(!M.has("access_token")){var R=M.get("state");V=null!==R?R:void 0}var O=null;return null!=I&&void 0!==I&&(O=(0,se.jsx)(Rn,{clients:t,studyInstanceUID:d,seriesInstanceUID:f,selectedPresentationStateUID:V,slide:I,preload:a,annotations:s,enableAnnotationTools:r,app:o,user:i,derivedDataset:null!==D&&void 0!==D?D:void 0})),O}const Un=le((function(e){var t=e.clients,n=e.studyInstanceUID,i=e.location,o=e.navigate,a=ae({clients:t,studyInstanceUID:n}),r=a.slides;if(a.isLoading)return null;if(0===r.length)return null;var s=r[0].volumeImages;if(0===s.length)return null;var l,u,d=s[0];if(i.pathname.includes("series/")){var h=i.pathname.split("series/")[1];l=h.includes("/")?h.split("/")[0]:h}else l=s[0].SeriesInstanceUID;return null!=d.ClinicalTrialSponsorName&&(u=(0,se.jsx)(B.Z.SubMenu,{title:"Clinical Trial",children:(0,se.jsx)(ve,{metadata:d})},"clinical-trial")),(0,se.jsxs)(c.Z,{style:{height:"100%"},hasSider:!0,children:[(0,se.jsx)(c.Z.Sider,{width:300,style:{height:"100%",borderRight:"solid",borderRightWidth:.25,overflow:"hidden",background:"none"},children:(0,se.jsxs)(B.Z,{mode:"inline",defaultOpenKeys:["patient","study","clinical-trial","slides"],style:{height:"100%"},inlineIndent:14,children:[(0,se.jsx)(B.Z.SubMenu,{title:"Patient",children:(0,se.jsx)(ye,{metadata:d})},"patient"),(0,se.jsx)(B.Z.SubMenu,{title:"Study",children:(0,se.jsx)(qt,{metadata:d})},"study"),u,(0,se.jsx)(B.Z.SubMenu,{title:"Slides",children:(0,se.jsx)(Re,{clients:e.clients,metadata:r,selectedSeriesInstanceUID:l,onSeriesSelection:function(e){var t=e.seriesInstanceUID;console.info('switch to series "'.concat(t,'"'));var a="/studies/".concat(n,"/series/").concat(t);i.pathname.includes("/projects/")&&(a=i.pathname,i.pathname.includes("/series/")?a=a.replace(/\/series\/[^/]+/,"/series/".concat(t)):a+="/series/".concat(t)),i.pathname.includes("/series/")&&null!==i.search&&void 0!==i.search&&(a+=i.search),o(a,{replace:!0})}})},"slides")]})}),(0,se.jsx)(p.Z5,{children:(0,se.jsx)(p.AW,{path:"/series/:seriesInstanceUID",element:(0,se.jsx)(Pn,{clients:e.clients,slides:r,preload:e.preload,annotations:e.annotations,enableAnnotationTools:e.enableAnnotationTools,app:e.app,user:e.user})})})]})}));var En=n(9529),jn=n(127),An=n(4541),Tn=n(8527),kn=n(161),Ln=n(5485),Nn=n(63),_n=n(7382),Gn=n(3231),qn=n(6005),zn=n(9761),Fn=n(4147),Bn=n(1730),Hn=n(5208),Wn=H.ZP.data.DicomMetaDictionary,Yn=function(e){return"object"===typeof e&&null!==e?JSON.stringify(e):String(e)};function Xn(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(void 0===e||null===e)return[];var n=Object.keys(e).filter((function(e){return"_vrMap"!==e}));return n.flatMap((function(n){var i,o,a=Wn.nameMap[n],r=e[n];if(void 0===a){var s,l;return null==n.match(/[0-9A-Fa-f]{6}/g)?[]:[{tag:"(".concat(n.substring(0,4),",").concat(n.substring(4,8),")"),vr:"",keyword:"Private Tag",value:null!==(s=null===(l=r)||void 0===l?void 0:l.toString())&&void 0!==s?s:"",level:t}]}if("SQ"===a.vr&&void 0!==r){var c=Array.isArray(r)?r:[r],u={tag:a.tag,vr:a.vr,keyword:n,value:"Sequence with ".concat(c.length," item(s)"),level:t,children:[]};return u.children=c.map((function(e,n){return{tag:"".concat(a.tag,".").concat(n+1),vr:"Item",keyword:"Item ".concat(n+1),value:"Sequence Item ".concat(n+1),level:t+1,children:Xn(e,t+2)}})),[u]}return Array.isArray(r)?r=r.map(Yn).join("\\"):"object"===typeof r&&null!==r&&(r=Yn(r)),[{tag:a.tag,vr:a.vr,keyword:n.replace("RETIRED_",""),value:null!==(i=null===(o=r)||void 0===o?void 0:o.toString())&&void 0!==i?i:"",level:t}]}))}function Kn(e){var t=Xn(e);if(void 0!==e.bulkdataReferences&&null!==e.bulkdataReferences){var n=e.bulkdataReferences,i={tag:"bulkdataReferences",vr:"OB",keyword:"bulkdataReferences",value:"Object with ".concat(Object.keys(n).length," bulk data reference(s)"),level:0,children:Object.keys(n).map((function(e){return{tag:"bulkdataReferences.".concat(e),vr:"OB",keyword:e,value:JSON.stringify(n[e]),level:1}}))};t.push(i)}return t.sort((function(e,t){return e.tag.localeCompare(t.tag)}))}var Jn=Pe.Z.Option;const Qn=function(e){var t,n,i=e.clients,o=e.studyInstanceUID,a=e.seriesInstanceUID,r=void 0===a?"":a,s=ae({clients:i,studyInstanceUID:o}),l=s.slides,c=s.isLoading,d=(0,u.useState)(void 0),p=(0,F.Z)(d,2),h=p[0],v=p[1],m=(0,u.useState)([]),f=(0,F.Z)(m,2),g=f[0],S=f[1],y=(0,u.useState)(0),I=(0,F.Z)(y,2),C=I[0],b=I[1],w=(0,u.useState)(1),D=(0,F.Z)(w,2),x=D[0],V=D[1],M=(0,u.useState)(""),R=(0,F.Z)(M,2),O=R[0],Z=R[1],P=(0,u.useState)([]),U=(0,F.Z)(P,2),E=U[0],j=U[1],A=(0,u.useState)(""),T=(0,F.Z)(A,2),k=T[0],L=T[1],N=function(e,t){var n=(0,u.useState)(e),i=(0,F.Z)(n,2),o=i[0],a=i[1];return(0,u.useEffect)((function(){var n=setTimeout((function(){a(e)}),t);return function(){clearTimeout(n)}}),[e,t]),o}(k,300);(0,u.useEffect)((function(){""===N?(Z(""),j([])):Z(N)}),[N]),(0,u.useEffect)((function(){var e=function(e){var t=Object.assign({},$e.getStudy(o));v(t)},t=$e.subscribe(Ye.SERIES_ADDED,e),n=$e.subscribe(Ye.INSTANCES_ADDED,e),i=Object.assign({},$e.getStudy(o));return v(i),function(){t.unsubscribe(),n.unsubscribe()}}),[o]),(0,u.useEffect)((function(){var e,t=[],n=[],i=[],o=0;l.length>0&&(t=l.flatMap((function(e){var t=[],n=function(n,a){if(void 0!==(null===n||void 0===n?void 0:n[0])){console.info("Found ".concat(n.length," ").concat(a," image(s) for slide ").concat(e.containerIdentifier));var r=n[0],s=r.SeriesDate,l=r.SeriesTime,c=r.SeriesNumber,u=r.SeriesInstanceUID,d=r.SeriesDescription,p=r.Modality;i.push(u);var h={displaySetInstanceUID:o,SeriesDate:s,SeriesTime:l,SeriesInstanceUID:u,SeriesNumber:String(c),SeriesDescription:d,Modality:p,images:n};t.push(h),o++}};return n(e.volumeImages,"volume"),n(e.overviewImages,"overview"),n(e.labelImages,"label"),t})).filter((function(e){return null!==e&&void 0!==e}))),void 0!==h&&(null===(e=h.series)||void 0===e?void 0:e.length)>0&&(n=h.series.filter((function(e){return!i.includes(e.SeriesInstanceUID)})).map((function(e){var t,n={displaySetInstanceUID:o,SeriesDate:e.SeriesDate,SeriesTime:e.SeriesTime,SeriesNumber:String(e.SeriesNumber),SeriesDescription:e.SeriesDescription,SeriesInstanceUID:e.SeriesInstanceUID,Modality:e.Modality,images:(null===e||void 0===e||null===(t=e.instances)||void 0===t?void 0:t.length)>0?e.instances:[e]};return o++,n}))),S([].concat((0,X.Z)(t),(0,X.Z)(n)))}),[l,h]);var _=(0,u.useMemo)((function(){return(0,X.Z)(g).sort((function(e,t){var n=Number(e.SeriesNumber),i=Number(t.SeriesNumber);return(Number.isNaN(n)||void 0===e.SeriesNumber||""===e.SeriesNumber?1/0:n)-(Number.isNaN(i)||void 0===t.SeriesNumber||""===t.SeriesNumber?1/0:i)}))}),[g]),G=(0,u.useMemo)((function(){return _.map((function(e,t){var n=e.SeriesDate,i=void 0===n?"":n,o=e.SeriesTime,a=void 0===o?"":o,r=e.SeriesNumber,s=void 0===r?"":r,l=e.SeriesDescription,c=void 0===l?"":l,u=e.Modality,d=void 0===u?"":u,p=function(e){var t=e.match(/^(\d{4})(\d{2})(\d{2}):(\d{2})(\d{2})(\d{2})/);if(null==t)return e;var n=(0,F.Z)(t,7),i=n[1],o=n[2],a=n[3],r=n[4],s=n[5],l=n[6],c=parseInt(o,10),u=parseInt(a,10);if(c<1||c>12||u<1||u>31)return e;var d=new Date(parseInt(i,10),c-1,u,parseInt(r,10),parseInt(s,10),parseInt(l,10));if(d.getMonth()!==c-1||d.getDate()!==u)return e;var p=d.toLocaleDateString("en-US",{weekday:"short"}),h=d.toLocaleDateString("en-US",{month:"short"}),v=d.getDate(),m=d.getFullYear();return"".concat(p,", ").concat(h," ").concat(v," ").concat(m)}("".concat(i,":").concat(a).split(".")[0]);return{value:t,label:"".concat(s," (").concat(d,"): ").concat(c),description:p}}))}),[_]);(0,u.useEffect)((function(){if(0!==_.length){if(""!==r){var e=_.findIndex((function(e){return e.SeriesInstanceUID===r}));if(-1!==e)return b(e),void V(1)}b((function(e){return e>=_.length||e<0?0:e}))}}),[r,_]),(0,u.useEffect)((function(){var e=C;(e>=_.length||e<0)&&_.length>0&&V(1)}),[C,_.length]);var q=(null===(t=_[C])||void 0===t?void 0:t.images.length)>1,z=(0,u.useMemo)((function(){var e;if(void 0===_[C])return{};var t=_[C].images.length;return e={1:"1"},(0,Oe.Z)(e,Math.ceil(t/2),String(Math.ceil(t/2))),(0,Oe.Z)(e,t,String(t)),e}),[C,_]),B=(0,u.useMemo)((function(){var e;if(void 0===_[C])return[];var t=null===(e=_[C])||void 0===e?void 0:e.images;return function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return t.map((function(t,i){var o=""!==t.tag?t.tag.replace(/[(),]/g,""):i.toString(),a=""!==n?"".concat(n,"-").concat(o):o,r={key:a,tag:t.tag,vr:t.vr,keyword:t.keyword,value:t.value};return void 0!==t.children&&t.children.length>0&&(r.children=e(t.children,a)),r}))}(Kn((Array.isArray(t)?(0,X.Z)(t).sort((function(e,t){return void 0!==e.InstanceNumber&&void 0!==t.InstanceNumber?Number(e.InstanceNumber)-Number(t.InstanceNumber):0})):[])[x-1]))}),[x,C,_]),H=(0,u.useMemo)((function(){if(void 0===O||""===O)return B;var e=O.toLowerCase(),t=new Set,n=function(t){var n,i,o,a,r,s,l,c;return(null!==(n=null===(i=t.tag)||void 0===i?void 0:i.toLowerCase())&&void 0!==n?n:"").includes(e)||(null!==(o=null===(a=t.vr)||void 0===a?void 0:a.toLowerCase())&&void 0!==o?o:"").includes(e)||(null!==(r=null===(s=t.keyword)||void 0===s?void 0:s.toLowerCase())&&void 0!==r?r:"").includes(e)||(null!==(l=null===(c=t.value)||void 0===c?void 0:c.toString().toLowerCase())&&void 0!==l?l:"").includes(e)},i=function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],o=[].concat((0,X.Z)(i),[t]),a=[];return n(t)&&a.push(o),null!=t.children&&t.children.forEach((function(t){var n=e(t,o);a=[].concat((0,X.Z)(a),(0,X.Z)(n))})),a},o=function e(n){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(0===n.length||i>=n[0].length)return[];var o=new Map;return n.forEach((function(e){if(i<e.length){var t,n=e[i];if(o.has(n.key)||o.set(n.key,{node:(0,re.Z)({},n),childPaths:[]}),i+1<e.length)null===(t=o.get(n.key))||void 0===t||t.childPaths.push(e)}})),Array.from(o.values()).map((function(n){var o=n.node,a=n.childPaths;t.add(o.key);var r=e(a,i+1);return r.length>0?(0,re.Z)((0,re.Z)({},o),{},{children:r}):o}))}(B.flatMap((function(e){return i(e)})));return j(Array.from(t)),o}),[B,O]);return c?(0,se.jsx)("div",{children:"Loading..."}):(0,se.jsx)("div",{className:"dicom-tag-browser",children:(0,se.jsxs)("div",{style:{width:"100%",padding:"16px 20px 20px"},children:[(0,se.jsxs)("div",{style:{display:"flex",gap:"24px",marginBottom:"32px"},children:[(0,se.jsxs)("div",{style:{flex:1},children:[(0,se.jsx)(Ln.Z.Text,{strong:!0,style:{display:"block",marginBottom:"8px"},children:"Series"}),(0,se.jsx)(Pe.Z,{style:{width:"100%"},value:C,onChange:function(e){b(e),V(1)},optionLabelProp:"label",optionFilterProp:"label",children:G.map((function(e){return(0,se.jsx)(Jn,{value:e.value,label:e.label,children:(0,se.jsxs)("div",{children:[(0,se.jsx)("div",{children:e.label}),(0,se.jsx)("div",{style:{fontSize:"12px",color:"rgba(0, 0, 0, 0.45)"},children:e.description})]})},e.value)}))})]}),q&&(0,se.jsxs)("div",{style:{flex:1},children:[(0,se.jsxs)(Ln.Z.Text,{strong:!0,style:{display:"block",marginBottom:"8px"},children:["Instance Number: ",x]}),(0,se.jsx)(vt.Z,{min:1,max:null===(n=_[C])||void 0===n?void 0:n.images.length,value:x,onChange:function(e){return V(e)},marks:z,tooltip:{formatter:function(e){return void 0!==e?"Instance ".concat(e):""}}})]})]}),(0,se.jsx)(qn.Z,{style:{marginBottom:"20px"},placeholder:"Search DICOM tags...",prefix:(0,se.jsx)(Bn.Z,{}),onChange:function(e){return L(e.target.value)},value:k}),(0,se.jsx)(Hn.Z,{columns:[{title:"Tag",dataIndex:"tag",key:"tag",width:"30%"},{title:"VR",dataIndex:"vr",key:"vr",width:"5%"},{title:"Keyword",dataIndex:"keyword",key:"keyword",width:"30%"},{title:"Value",dataIndex:"value",key:"value",width:"40%"}],dataSource:H,pagination:!1,expandable:{expandedRowKeys:E,onExpandedRowsChange:function(e){return j(e)}},size:"small",scroll:{y:500}})]})})};var $n=["Copy hash","Copied!"],ei={container:{textAlign:"center",lineHeight:1.6,paddingRight:25,fontSize:"1rem"},title:{fontSize:"1.4rem",fontWeight:700,marginBottom:4},subtitle:{fontSize:"1.15rem",fontWeight:600,marginBottom:12},link:{display:"inline-block",marginBottom:16},section:{marginBottom:12},label:{fontWeight:600,display:"block",marginBottom:4},bodyText:{marginBottom:4},code:{display:"inline-block",wordBreak:"break-all",fontSize:"0.85rem"}},ti=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var o,a;(0,i.Z)(this,n),(a=t.call(this,e)).isValidServerUrl=function(e){if(null==e||""===e)return!1;var t=e.trim();if(""===t)return!1;try{var n=new URL(t);return n.protocol.startsWith("http")&&n.pathname.length>0}catch(i){return!1}},a.handleUserMenuButtonClick=function(e){e.preventDefault()},a.handleInfoButtonClick=function(){var e,t,n,i,o,r=(0,zn.qY)(),s={browser:{},os:{}};null!==r&&void 0!==r&&(s.browser={name:null!==r.name&&void 0!==r.name?r.name:void 0,version:null!==r.version&&void 0!==r.version?r.version:void 0},s.os={name:null!==r.os&&void 0!==r.os?r.os:void 0});var l=Fn.v6,c=Fn.HO,u=(null!==(e=null!==(t=null===l||void 0===l?void 0:l["dicom-microscopy-viewer"])&&void 0!==t?t:null===c||void 0===c?void 0:c["dicom-microscopy-viewer"])&&void 0!==e?e:"unknown").replace(/^[^0-9]*/,""),d=function(e){return null==e?(0,se.jsx)(Ln.Z.Text,{code:!0,style:ei.code,children:"unknown"}):(0,se.jsx)(Ln.Z.Text,{code:!0,style:ei.code,copyable:{text:e,tooltips:$n},children:e})};Ce.Z.info({width:480,title:null,centered:!0,content:(0,se.jsxs)("div",{style:ei.container,children:[(0,se.jsx)(Ln.Z.Title,{level:3,style:ei.title,children:(0,se.jsx)(Ln.Z.Link,{href:a.props.app.homepage,target:"_blank",rel:"noreferrer",children:a.props.app.name})}),(0,se.jsx)(Ln.Z.Text,{style:ei.subtitle,children:a.props.app.version}),(0,se.jsxs)("div",{style:ei.section,children:[(0,se.jsx)(Ln.Z.Text,{style:ei.label,children:"Commit Hash"}),d("cfa0eaf57267ab2e725700f938e7cd3f28788586")]}),(0,se.jsxs)("div",{style:ei.section,children:[(0,se.jsx)(Ln.Z.Text,{style:ei.label,children:(0,se.jsx)("a",{href:"https://github.com/MGHComputationalPathology/dicom-microscopy-viewer",target:"_blank",rel:"noreferrer",children:"DICOM Microscopy Viewer"})}),(0,se.jsxs)(Ln.Z.Text,{style:ei.bodyText,children:["Version ",u]}),d(null)]}),(0,se.jsxs)("div",{style:ei.section,children:[(0,se.jsx)(Ln.Z.Text,{style:ei.label,children:"Current Browser & OS"}),(0,se.jsxs)(Ln.Z.Text,{style:ei.bodyText,children:[null!==(n=s.browser.name)&&void 0!==n?n:"Unknown"," ",null!==(i=s.browser.version)&&void 0!==i?i:""]}),(0,se.jsx)(Ln.Z.Text,{style:ei.bodyText,children:null!==(o=s.os.name)&&void 0!==o?o:"Unknown OS"})]})]}),onOk:function(){var e;null===(e=Ce.Z.destroyAll)||void 0===e||e.call(Ce.Z)}})},a.handleDicomTagBrowserButtonClick=function(){var e,t,n=window.innerWidth-200,i="";if(a.props.location.pathname.includes("series/")){var o=a.props.location.pathname.split("series/")[1];i=o.includes("/")?o.split("/")[0]:o}Ce.Z.info({title:"DICOM Tag Browser",width:n,content:(0,se.jsx)(Qn,{clients:null!==(e=a.props.clients)&&void 0!==e?e:{},studyInstanceUID:null!==(t=a.props.params.studyInstanceUID)&&void 0!==t?t:"",seriesInstanceUID:i}),onOk:function(){var e;null===(e=Ce.Z.destroyAll)||void 0===e||e.call(Ce.Z)}})},a.handleDebugButtonClick=function(){var e={Authentication:[],Communication:[],EncodingDecoding:[],Visualization:[]},t=a.state.errorObj.length;if(t>0)for(var n=0;n<t;n++){e[a.state.errorCategory[n]].push("".concat(a.state.errorObj[n].message," (Source: ").concat(a.state.errorObj[n].source,")"))}var i,o=Nn.Z.Panel,r=function(e){return(0,se.jsx)(ht.Z,{count:e})};Ce.Z.info({title:"Debug Information\n (Check console for more information)",width:800,content:(0,se.jsxs)(Nn.Z,{children:[(0,se.jsx)(o,{header:"Communication Error",extra:r(e.Communication.length),children:(0,se.jsx)("ol",{children:e.Communication.map((function(e){return(0,se.jsx)("li",{children:e},(0,de.Z)())}))})},"communicationerror"),(0,se.jsx)(o,{header:"Data Encoding/Decoding error",extra:r(e.EncodingDecoding.length),children:(0,se.jsx)("ol",{children:e.EncodingDecoding.map((function(e){return(0,se.jsx)("li",{children:e},(0,de.Z)())}))})},"encodedecodeerror"),(0,se.jsx)(o,{header:"Visualization error",extra:r(e.Visualization.length),children:(0,se.jsx)("ol",{children:e.Visualization.map((function(e){return(0,se.jsx)("li",{children:e},(0,de.Z)())}))})},"visualizationerror"),(0,se.jsx)(o,{header:"Authentication error",extra:r(e.Authentication.length),children:(0,se.jsx)("ol",{children:e.Authentication.map((function(e){return(0,se.jsx)("li",{children:e},(0,de.Z)())}))})},"autherror"),(0,se.jsx)(o,{header:"Warning",extra:(i=a.state.warnings.length,(0,se.jsx)(ht.Z,{color:"green",count:i})),children:(0,se.jsx)("ol",{children:a.state.warnings.map((function(e){return(0,se.jsx)("li",{children:e},(0,de.Z)())}))})},"warning")]}),onOk:function(){var e;null===(e=Ce.Z.destroyAll)||void 0===e||e.call(Ce.Z)}})},a.handleServerSelectionButtonClick=function(){a.setState({isServerSelectionModalVisible:!0})},a.handleServerSelectionInput=function(e){var t=e.currentTarget.value.trim();a.setState({selectedServerUrl:t,isServerSelectionDisabled:!a.isValidServerUrl(t)})},a.handleServerSelectionCancellation=function(){var e,t=null===(e=window.localStorage.getItem("slim_selected_server"))||void 0===e?void 0:e.trim();a.setState({serverSelectionMode:null!==t&&void 0!==t&&""!==t?"custom":"default",selectedServerUrl:null!==t&&void 0!==t?t:void 0,isServerSelectionModalVisible:!1,isServerSelectionDisabled:!a.isValidServerUrl(t)})},a.handleServerSelectionModeChange=function(e){var t,n,i=null!==(t=null===(n=e.target)||void 0===n?void 0:n.value)&&void 0!==t?t:"default";a.setState({serverSelectionMode:i})},a.handleServerSelection=function(){var e;if(window.localStorage.setItem("slim_server_selection_mode",a.state.serverSelectionMode),"default"===a.state.serverSelectionMode)return a.props.onServerSelection({url:""}),void a.setState({isServerSelectionModalVisible:!1,isServerSelectionDisabled:!1});var t=null===(e=a.state.selectedServerUrl)||void 0===e?void 0:e.trim(),n=!1;null!==t&&void 0!==t&&""!==t&&(t.startsWith("http://")||t.startsWith("https://"))&&(a.props.onServerSelection({url:t}),n=!0),a.setState({isServerSelectionModalVisible:!n,isServerSelectionDisabled:!n})};var r=null===(o=window.localStorage.getItem("slim_selected_server"))||void 0===o?void 0:o.trim(),s=window.localStorage.getItem("slim_server_selection_mode");a.state={errorObj:[],errorCategory:[],warnings:[],selectedServerUrl:null!==r&&void 0!==r?r:"",isServerSelectionModalVisible:!1,isServerSelectionDisabled:!a.isValidServerUrl(r),serverSelectionMode:"custom"===s&&null!==r&&void 0!==r&&""!==r?"custom":"default"};return k.subscribe(V,(function(e){var t=e.source,n=e.error;a.setState((function(e){return(0,re.Z)((0,re.Z)({},e),{},{errorObj:[].concat((0,X.Z)(e.errorObj),[(0,re.Z)((0,re.Z)({},n),{},{source:t})]),errorCategory:[].concat((0,X.Z)(e.errorCategory),[n.type])})}))})),k.subscribe(M,(function(e){a.setState((function(t){return(0,re.Z)((0,re.Z)({},t),{},{warnings:[].concat((0,X.Z)(t.warnings),[e])})}))})),a}return(0,o.Z)(n,[{key:"componentDidUpdate",value:function(e,t){(t.warnings.length>0||t.errorObj.length>0)&&this.props.location.pathname!==e.location.pathname&&this.setState({isServerSelectionModalVisible:!1,isServerSelectionDisabled:!0,errorObj:[],errorCategory:[],warnings:[]})}},{key:"render",value:function(){var e,t,n,i,o,a,r,s,l=this,u=null;if(void 0!==this.props.user){var d=[];void 0!==this.props.onUserLogout&&d.push({label:"Logout",key:"user-logout",onClick:function(){void 0!==l.props.onUserLogout&&l.props.onUserLogout()}});var p={items:d};u=(0,se.jsx)(_n.Z,{menu:p,trigger:["click"],children:(0,se.jsx)(xt,{icon:En.Z,onClick:this.handleUserMenuButtonClick,label:"".concat(this.props.user.name," (").concat(this.props.user.email,")")})})}this.props.showWorklistButton&&(s=(0,se.jsx)(h.OL,{to:"/",children:(0,se.jsx)(xt,{icon:jn.Z,tooltip:"Go to worklist"})}));var v,m=(0,se.jsx)(xt,{icon:An.Z,tooltip:"Get app info",onClick:this.handleInfoButtonClick}),f=(0,se.jsx)(ht.Z,{count:this.state.errorObj.length,style:{zIndex:1e3},children:(0,se.jsx)(ht.Z,{color:"green",count:this.state.warnings.length,style:{zIndex:1001},children:(0,se.jsx)(xt,{icon:ut.Z,tooltip:"Debug info",onClick:this.handleDebugButtonClick})})}),g=this.props.location.pathname.includes("/studies/")?(0,se.jsx)(xt,{icon:Tn.Z,tooltip:"Dicom Tag Browser",onClick:this.handleDicomTagBrowserButtonClick}):null;this.props.showServerSelectionButton&&(v=(0,se.jsx)(xt,{icon:kn.Z,tooltip:"Select server",onClick:this.handleServerSelectionButtonClick}));var S="".concat("https://imagingdatacommons.github.io/slim","/logo.svg"),y="custom"===this.state.serverSelectionMode?null===(e=this.state.selectedServerUrl)||void 0===e?void 0:e.trim():null!==(t=null===(n=this.props.clients)||void 0===n||null===(i=n.default)||void 0===i?void 0:i.baseURL)&&void 0!==t?t:null===(o=this.props.defaultClients)||void 0===o||null===(a=o.default)||void 0===a?void 0:a.baseURL,I=null!==y&&void 0!==y&&""!==y?(0,se.jsx)(Ie.Z,{title:y,children:(0,se.jsx)("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",paddingRight:"20px",paddingLeft:"20px"},title:y,children:y})}):null;return(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)(c.Z.Header,{style:{width:"100%",padding:"0 14px"},children:(0,se.jsxs)(je.Z,{style:{flexWrap:"nowrap"},children:[(0,se.jsx)(Ae.Z,{style:{flexShrink:0},children:(0,se.jsx)(Ee.Z,{align:"center",direction:"horizontal",children:(0,se.jsx)("img",{src:S,alt:"",style:{height:"64px",margin:"-14px"}})})}),(0,se.jsx)(Ae.Z,{flex:"auto",style:{minWidth:0,overflow:"hidden"},children:(0,se.jsx)("div",{style:{width:"100%",overflow:"hidden"},children:this.props.showServerSelectionButton?I:""})}),(0,se.jsx)(Ae.Z,{style:{flexShrink:0},children:(0,se.jsxs)(Ee.Z,{direction:"horizontal",children:[s,m,f,g,v,u]})})]})}),(0,se.jsxs)(Ce.Z,{open:this.state.isServerSelectionModalVisible,title:"Select DICOMweb server",onOk:this.handleServerSelection,onCancel:this.handleServerSelectionCancellation,children:[(0,se.jsxs)(Gn.ZP.Group,{value:this.state.serverSelectionMode,onChange:this.handleServerSelectionModeChange,style:{marginBottom:"16px"},children:[(0,se.jsx)(Gn.ZP,{value:"default",children:"Use default server"}),(0,se.jsx)(Gn.ZP,{value:"custom",children:"Use custom server"})]}),"custom"===this.state.serverSelectionMode&&(0,se.jsx)(Ie.Z,{title:null===(r=this.state.selectedServerUrl)||void 0===r?void 0:r.trim(),children:(0,se.jsx)(qn.Z,{placeholder:"Enter base URL of DICOMweb Study Service",value:this.state.selectedServerUrl,onChange:this.handleServerSelectionInput,onPressEnter:this.handleServerSelection,addonAfter:this.state.isServerSelectionDisabled?(0,se.jsx)(on.Z,{style:{color:"rgba(0,0,0,.45)"}}):(0,se.jsx)(nn.Z,{style:{color:"rgba(0,0,0,.45)"}})})})]})]})}}]),n}(u.Component);const ni=le(ti);var ii=n(7063);const oi=function(e){var t=e.title,n=e.message;return(0,se.jsx)("div",{style:{height:"100vh",display:"flex",alignItems:"center",justifyContent:"center"},children:(0,se.jsx)(ii.ZP,{title:t,subTitle:n})})};var ai=n(7528),ri=function(){function e(){(0,i.Z)(this,e),this.updateCallbacks=new Set,this.monitoringTimeoutId=null,this.monitoringActive=!1,this.updateInterval=5e3,this.lastMeasurement=null,this.highUsageThreshold=.8,this.criticalUsageThreshold=.9}return(0,o.Z)(e,[{key:"isModernAPIAvailable",value:function(){return"undefined"!==typeof performance&&"function"===typeof performance.measureUserAgentSpecificMemory&&"undefined"!==typeof window&&window.crossOriginIsolated}},{key:"isChromeAPIAvailable",value:function(){return"undefined"!==typeof performance&&void 0!==performance.memory&&"number"===typeof performance.memory.usedJSHeapSize}},{key:"formatBytes",value:function(e){if(null===e||void 0===e)return"N/A";if(0===e)return"0 Bytes";var t=Math.floor(Math.log(e)/Math.log(1024));return"".concat((e/Math.pow(1024,t)).toFixed(2)," ").concat(["Bytes","KB","MB","GB","TB"][t])}},{key:"getMemoryModernFromResult",value:function(e){var t,n,i=null==e.bytes||Number.isNaN(e.bytes)?0:e.bytes,o=i/(n=this.isChromeAPIAvailable()&&null!=(null===(t=performance.memory)||void 0===t?void 0:t.jsHeapSizeLimit)&&performance.memory.jsHeapSizeLimit>0?performance.memory.jsHeapSizeLimit:8589934592)*100;return{usedJSHeapSize:i,jsHeapSizeLimit:n,totalJSHeapSize:i,usagePercentage:Math.min(o,100),remainingBytes:Math.max(0,n-i),isHighUsage:o>100*this.highUsageThreshold,isCriticalUsage:o>100*this.criticalUsageThreshold,apiMethod:"modern",timestamp:Date.now()}}},{key:"getMemoryChrome",value:function(){var e=performance.memory;if(null==e)throw new Error("performance.memory not available");var t=e.usedJSHeapSize,n=e.totalJSHeapSize,i=e.jsHeapSizeLimit,o=t/i*100,a=i-t;return{usedJSHeapSize:t,jsHeapSizeLimit:i,totalJSHeapSize:n,usagePercentage:o,remainingBytes:Math.max(0,a),isHighUsage:o>100*this.highUsageThreshold,isCriticalUsage:o>100*this.criticalUsageThreshold,apiMethod:"chrome",timestamp:Date.now()}}},{key:"getMemoryUnavailable",value:function(){return{usedJSHeapSize:null,jsHeapSizeLimit:null,totalJSHeapSize:null,usagePercentage:null,remainingBytes:null,isHighUsage:!1,isCriticalUsage:!1,apiMethod:"unavailable",timestamp:Date.now()}}},{key:"measure",value:function(){var e=(0,m.Z)((0,v.Z)().mark((function e(){var t,n,i;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isModernAPIAvailable()){e.next=16;break}if(e.prev=1,null!=performance.measureUserAgentSpecificMemory){e.next=4;break}throw new Error("measureUserAgentSpecificMemory not available");case 4:return e.next=6,performance.measureUserAgentSpecificMemory();case 6:i=e.sent,t=this.getMemoryModernFromResult(i),null!=i.breakdown&&(n=i.breakdown.map((function(e){return{bytes:e.bytes,userAgentSpecificTypes:null!=e.userAgentSpecificTypes?e.userAgentSpecificTypes:[]}}))),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t=this.isChromeAPIAvailable()?this.getMemoryChrome():this.getMemoryUnavailable();case 14:e.next=17;break;case 16:t=this.isChromeAPIAvailable()?this.getMemoryChrome():this.getMemoryUnavailable();case 17:return this.lastMeasurement=t,this.updateCallbacks.forEach((function(e){try{e(t)}catch(n){console.error("Error in memory update callback:",n)}})),e.abrupt("return",{memory:t,breakdown:n});case 20:case"end":return e.stop()}}),e,this,[[1,11]])})));return function(){return e.apply(this,arguments)}}()},{key:"getLastMeasurement",value:function(){return this.lastMeasurement}},{key:"subscribe",value:function(e){var t=this;return this.updateCallbacks.add(e),function(){t.updateCallbacks.delete(e)}}},{key:"startMonitoring",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.updateInterval;null!=this.monitoringTimeoutId&&this.stopMonitoring(),this.monitoringActive=!0;var n=function n(){e.monitoringActive&&(e.monitoringTimeoutId=setTimeout((function(){e.monitoringTimeoutId=null,e.measure().then((function(){n()})).catch((function(e){console.error("Error in periodic memory measurement:",e),n()}))}),t))};this.measure().then((function(){n()})).catch((function(e){console.error("Error in initial memory measurement:",e),n()}))}},{key:"stopMonitoring",value:function(){this.monitoringActive=!1,null!=this.monitoringTimeoutId&&(clearTimeout(this.monitoringTimeoutId),this.monitoringTimeoutId=null)}},{key:"isMonitoring",value:function(){return this.monitoringActive}},{key:"getStatusMessage",value:function(e){if(null===e||"unavailable"===e.apiMethod)return"Memory monitoring unavailable";if(e.isCriticalUsage){var t=null!=e.usagePercentage?e.usagePercentage.toFixed(1):"N/A";return"Critical: ".concat(t,"% used (").concat(this.formatBytes(e.remainingBytes)," remaining)")}if(e.isHighUsage){var n=null!=e.usagePercentage?e.usagePercentage.toFixed(1):"N/A";return"High: ".concat(n,"% used (").concat(this.formatBytes(e.remainingBytes)," remaining)")}var i=null!=e.usagePercentage?e.usagePercentage.toFixed(1):"N/A";return"Memory: ".concat(i,"% used (").concat(this.formatBytes(e.remainingBytes)," remaining)")}},{key:"getWarningLevel",value:function(e){return null===e||"unavailable"===e.apiMethod?"none":e.isCriticalUsage?"critical":e.isHighUsage?"high":"none"}}]),e}(),si=new ri,li=Ln.Z.Text;const ci=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var o;return(0,i.Z)(this,n),(o=t.call(this,e)).unsubscribeMemory=void 0,o.lastWarningLevel="none",o.lastCriticalWarningTime=0,o.criticalWarningThrottleMs=3e4,o.didStartMonitoring=!1,o.state={memoryInfo:null},o}return(0,o.Z)(n,[{key:"componentDidMount",value:function(){var e=this;!0===this.props.enabled&&(this.unsubscribeMemory=si.subscribe((function(t){e.setState({memoryInfo:t});var n=si.getWarningLevel(t);if(n!==e.lastWarningLevel)if(e.lastWarningLevel=n,"critical"===n&&null!==t.usagePercentage){var i=Date.now();i-e.lastCriticalWarningTime>=e.criticalWarningThrottleMs&&(e.lastCriticalWarningTime=i,k.publish(M,"Critical memory usage: ".concat(t.usagePercentage.toFixed(1),"% used. ")+"Only ".concat(si.formatBytes(t.remainingBytes)," remaining. ")+"Consider refreshing the page or closing other tabs."))}else"high"===n&&null!==t.usagePercentage&&k.publish(M,"High memory usage: ".concat(t.usagePercentage.toFixed(1),"% used. ")+"".concat(si.formatBytes(t.remainingBytes)," remaining."))})),si.startMonitoring(),this.didStartMonitoring=!0)}},{key:"componentWillUnmount",value:function(){null!==this.unsubscribeMemory&&void 0!==this.unsubscribeMemory&&this.unsubscribeMemory(),this.didStartMonitoring&&(si.stopMonitoring(),this.didStartMonitoring=!1)}},{key:"render",value:function(){if(!0!==this.props.enabled)return null;var e=this.state.memoryInfo;if(null===e||"unavailable"===e.apiMethod)return null;var t,n=si.getWarningLevel(e);return t="critical"===n?"red":"high"===n?"orange":"green",(0,se.jsx)(c.Z.Footer,{style:{padding:"4px 16px",lineHeight:"24px",backgroundColor:"#fafafa",borderTop:"1px solid #f0f0f0",fontSize:"12px"},children:(0,se.jsxs)(Ee.Z,{split:(0,se.jsx)("span",{style:{color:"#d9d9d9"},children:"|"}),size:"small",wrap:!0,children:[(0,se.jsx)(li,{type:"secondary",style:{fontSize:"12px"},children:"Memory:"}),(0,se.jsx)(ai.Z,{color:t,style:{margin:0},children:si.formatBytes(e.usedJSHeapSize)}),(0,se.jsx)(li,{type:"secondary",style:{fontSize:"12px"},children:"of"}),(0,se.jsx)(li,{style:{fontSize:"12px"},children:si.formatBytes(e.jsHeapSizeLimit)}),(0,se.jsxs)(li,{type:"secondary",style:{fontSize:"12px"},children:["(",null!==e.usagePercentage?"".concat(e.usagePercentage.toFixed(1),"%"):"N/A",")"]}),null!==e.remainingBytes&&(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)(li,{type:"secondary",style:{fontSize:"12px"},children:"Remaining:"}),(0,se.jsx)(li,{style:{fontSize:"12px"},children:si.formatBytes(e.remainingBytes)})]})]})})}}]),n}(u.Component);var ui=function(e){return e.StudyInstanceUID},di=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var o;return(0,i.Z)(this,n),(o=t.call(this,e)).defaultPageSize=20,o.handleClick=function(e,t){o.props.navigate("/studies/".concat(t.StudyInstanceUID))},o.fetchData=function(e){var t=e.offset,n=e.limit,i=e.searchCriteria,a={ModalitiesInStudy:"SM",offset:t,limit:n};if(void 0!==i){for(var r in i){var s=i[r];a[r]="PersonName"===r?"*".concat(s,"*"):s}a.fuzzymatching="true"}var l={queryParams:a};o.props.clients[L.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE].searchForStudies(l).then((function(e){o.setState({studies:e.map((function(e){return Y.metadata.formatMetadata(e).dataset}))})})).catch((function(e){console.error(e),k.onError(R,new w(I,"Request to search for studies failed."))}))},o.handleChange=function(e,t){o.setState({isLoading:!0});var n=e.current;void 0===n&&(n=1);var i=e.pageSize;void 0===i&&(i=o.state.pageSize);var a=i*(n-1),r=i;console.debug("search for studies of page #".concat(n,"..."));var s={};for(var l in t){var c=t[l];null!==c&&void 0!==c&&c.length>0&&(s[l]=c[0].toString())}o.fetchData({offset:a,limit:r,searchCriteria:s}),o.setState({isLoading:!1,pageSize:i})},o.handleSearch=function(e,t,n){t()},o.handleReset=function(e){e()},o.handleRowProps=function(e){return{onClick:function(t){o.handleClick(t,e)}}},o.handlePressEnter=function(e,t,n){o.handleSearch(e,t,n)},o.getFilterPressEnterHandler=function(e,t,n){return function(){return o.handlePressEnter(e,t,n)}},o.getFilterSearchHandler=function(e,t,n){return function(){return o.handleSearch(e,t,n)}},o.getFilterResetHandler=function(e){return function(){return o.handleReset(e)}},o.getColumnSearchProps=function(e){return{filterDropdown:function(t){var i=t.setSelectedKeys,a=t.selectedKeys,r=t.confirm,s=t.clearFilters;return(0,se.jsxs)("div",{style:{padding:8},children:[(0,se.jsx)(qn.Z,{placeholder:"Search",value:a[0],onChange:n.getFilterInputChangeHandler(i),onPressEnter:o.getFilterPressEnterHandler(a,r,e),style:{width:188,marginBottom:8,display:"block"}}),(0,se.jsxs)(Ee.Z,{children:[(0,se.jsx)(pt.Z,{type:"primary",onClick:o.getFilterSearchHandler(a,r,e),icon:(0,se.jsx)(Bn.Z,{}),size:"small",style:{width:90},children:"Search"}),(0,se.jsx)(pt.Z,{onClick:o.getFilterResetHandler(s),size:"small",style:{width:90},children:"Reset"})]})]})},filterIcon:function(e){return(0,se.jsx)(Bn.Z,{style:{color:e?"#1890ff":void 0}})}}},o.state={studies:[],isLoading:!1,numStudies:0,pageSize:o.defaultPageSize},o}return(0,o.Z)(n,[{key:"searchForStudies",value:function(){var e=this,t={queryParams:{ModalitiesInStudy:"SM"}};this.props.clients[L.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE].searchForStudies(t).then((function(t){e.setState({numStudies:t.length,studies:t.slice(0,e.state.pageSize).map((function(e){return Y.metadata.formatMetadata(e).dataset}))})})).catch((function(e){console.error(e),k.onError(R,new w(I,"An error occured. Search for studies failed."))}))}},{key:"componentDidMount",value:function(){this.searchForStudies()}},{key:"componentDidUpdate",value:function(e){this.props.clients!==e.clients&&this.searchForStudies()}},{key:"render",value:function(){var e=[(0,re.Z)({title:"Accession Number",dataIndex:"AccessionNumber"},this.getColumnSearchProps("AccessionNumber")),(0,re.Z)({title:"Study ID",dataIndex:"StudyID"},this.getColumnSearchProps("StudyID")),{title:"Study Date",dataIndex:"StudyDate",render:function(e){return fe(e)}},{title:"Study Time",dataIndex:"StudyTime",render:function(e){return ge(e)}},(0,re.Z)({title:"Patient ID",dataIndex:"PatientID"},this.getColumnSearchProps("PatientID")),(0,re.Z)({title:"Patient's Name",dataIndex:"PatientName",render:function(e){return me(e)}},this.getColumnSearchProps("PatientName")),{title:"Patient's Sex",dataIndex:"PatientSex",render:function(e){return Se(e)}},{title:"Patient's Birthdate",dataIndex:"PatientBirthDate",render:function(e){return fe(e)}},{title:"Referring Physician's Name",dataIndex:"ReferringPhysicianName",render:function(e){return me(e)}},{title:"Modalities in Study",dataIndex:"ModalitiesInStudy",render:function(e){return void 0===e?"":String(e)}}],t={defaultPageSize:this.defaultPageSize,pageSize:this.state.pageSize,hideOnSinglePage:!0,showSizeChanger:!0,showQuickJumper:!0,showTotal:function(e,t){return"".concat(t[0],"-").concat(t[1]," of ").concat(e," studies")},total:this.state.numStudies};return(0,se.jsx)(Hn.Z,{style:{cursor:"pointer"},columns:e,rowKey:ui,dataSource:this.state.studies,pagination:t,onRow:this.handleRowProps,onChange:this.handleChange,size:"small",loading:this.state.isLoading})}}],[{key:"handleInputChange",value:function(e,t){t(void 0!==e.target.value?[e.target.value]:[])}},{key:"getFilterInputChangeHandler",value:function(e){return function(t){return n.handleInputChange(t,e)}}}]),n}(u.Component);const pi=le(di);var hi=n(7659),vi=n(9158);const mi=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{retries:5,factor:3,minTimeout:1e3,maxTimeout:6e4,randomize:!0,retryableStatusCodes:[429,500]},t=e;return null!=e.retries&&(t.retries=e.retries),null!=e.factor&&(t.factor=e.factor),null!=e.minTimeout&&(t.minTimeout=e.minTimeout),null!=e.maxTimeout&&(t.maxTimeout=e.maxTimeout),null!=e.randomize&&(t.randomize=e.randomize),null!=e.retryableStatusCodes&&(t.retryableStatusCodes=e.retryableStatusCodes),function(e,n){var i=n.url,o=n.method;var a=e.send;return e.send=function(){var n=vi.operation(t);n.attempt((function(a){var r=e.onreadystatechange;e.onreadystatechange=function(o){if(null!=r&&r.call(e,o),t.retryableStatusCodes.includes(e.status)){var a="Attempt to request ".concat(i," failed."),s=new Error(a);n.retry(s)}},a>1&&(console.warn("Requesting ".concat(i,"... (attempt: ").concat(a,")")),e.open(o,i,!0))}));for(var r=arguments.length,s=new Array(r),l=0;l<r;l++)s[l]=arguments[l];a.apply(e,s)},e}};var fi=H.aT.DicomMetaDictionary.naturalizeDataset,gi=function(){function e(t){var n=this,o=t.baseUri,a=t.settings,r=t.onError;(0,i.Z)(this,e),this.stores=[],this.handleError=void 0,this.updateHeaders=function(e){for(var t in e)n.stores[0].client.headers[t]=e[t]},this.storeInstances=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.stores[0].write){e.next=6;break}return e.next=3,n.stores[0].client.storeInstances(t);case 3:case 8:return e.abrupt("return",e.sent);case 6:return e.next=8,Promise.reject(new Error("Store is not writable."));case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.searchForStudies=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.searchForStudies(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.searchForSeries=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.searchForSeries(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.searchForInstances=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.searchForInstances(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveStudyMetadata=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){var i,o;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveStudyMetadata(t);case 2:return i=e.sent,o=fi(i),$e.addStudy(o),e.abrupt("return",i);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveSeriesMetadata=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){var i,o;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveSeriesMetadata(t);case 2:return i=e.sent,o=i.map(fi),$e.addSeriesMetadata(o,!0),e.abrupt("return",i);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveInstanceMetadata=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveInstanceMetadata(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveInstance=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){var i,o,a,r;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveInstance(t);case 2:return i=e.sent,o=H.aT.DicomMessage.readFile(i),a=Y.metadata.formatMetadata(o.dict),r=a.dataset,$e.addInstances([r]),e.abrupt("return",i);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveInstanceFrames=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveInstanceFrames(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveInstanceRendered=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveInstanceRendered(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveInstanceFramesRendered=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveInstanceFramesRendered(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.retrieveBulkData=function(){var e=(0,m.Z)((0,v.Z)().mark((function e(t){return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.stores[0].client.retrieveBulkData(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.handleError=null!=r?r:function(e,t){0},a.forEach((function(e){var t,i,a;if(void 0===e&&k.onError(P,new w(I,"At least one server needs to be configured.")),void 0!==e.url)a=e.url;else{if(void 0===e.path)throw k.onError(P,new w(I,"Either path or full URL needs to be configured for server.")),new w(I,"Either path or full URL needs to be configured for server.");a=N(e.path,o)}var r={url:a},s=!0===e.upgradeInsecureRequests&&[a,e.qidoPathPrefix,e.wadoPathPrefix,e.stowPathPrefix].some((function(e){var t;return null!==(t=null===e||void 0===e?void 0:e.startsWith("https"))&&void 0!==t&&t}));void 0!==e.qidoPathPrefix&&(r.qidoURLPrefix=e.qidoPathPrefix),void 0!==e.wadoPathPrefix&&(r.wadoURLPrefix=e.wadoPathPrefix),void 0!==e.stowPathPrefix&&(r.stowURLPrefix=e.stowPathPrefix),s&&(r.headers=(0,re.Z)((0,re.Z)({},r.headers),{},{"Content-Security-Policy":"upgrade-insecure-requests"})),void 0!==e.retry&&(r.requestHooks=[mi(e.retry)]),r.errorInterceptor=function(t){n.handleError(t,e)},n.stores.push({id:e.id,write:null!==(t=e.write)&&void 0!==t&&t,read:null===(i=e.read)||void 0===i||i,client:new hi.hi.DICOMwebClient(r)})})),this.stores.length>1&&k.onError(P,new w(I,"Only one store is supported for now."))}return(0,o.Z)(e,[{key:"baseURL",get:function(){return this.stores[0].client.baseURL}},{key:"headers",get:function(){return this.stores[0].client.headers}}]),e}();function Si(e){var t,n,i=e.clients,o=e.user,a=e.app,r=e.config,s=(0,p.UO)().studyInstanceUID;if(void 0===s)return(0,se.jsx)(p.Fg,{to:"/",replace:!0});var l=!(null!==(t=r.disableAnnotationTools)&&void 0!==t&&t),c=null!==(n=r.preload)&&void 0!==n&&n;return(0,se.jsx)(De,{clients:i,studyInstanceUID:s,children:(0,se.jsx)(Un,{clients:i,user:o,annotations:r.annotations,preload:c,app:a,enableAnnotationTools:l,studyInstanceUID:s})})}var yi=function(e){(0,r.Z)(n,e);var t=(0,s.Z)(n);function n(e){var o,r;(0,i.Z)(this,n),(r=t.call(this,e)).auth=void 0,r.handleDICOMwebError=function(e,t){401===e.status?r.signIn():403===e.status&&k.onError(R,new w(I,"User is not authorized to access DICOMweb resources."));var n=function(){k.onError(R,new w(I,"An unexpected server error occured."))};void 0!==t.errorMessages?t.errorMessages.forEach((function(t){e.status===t.status?r.setState({error:{status:e.status,message:t.message}}):500===e.status&&n()})):500===e.status&&n()},r.handleSignIn=function(e){var t=e.user,n=e.authorization;for(var i in r.state.clients){r.state.clients[i].updateHeaders({Authorization:n})}var o=window.localStorage.getItem("slim_path"),a=window.localStorage.getItem("slim_search");if(null!==o&&""!==o&&o!==window.location.pathname){var s=o;null!==a&&""!==a&&(s+=a),window.location.href=s}window.localStorage.removeItem("slim_path"),window.localStorage.removeItem("slim_search"),r.setState({user:t})};var s=window.location,c=s.protocol,u=s.host,d="".concat(c,"//").concat(u),p=N(e.config.path,d),h=e.config.oidc;void 0!==h&&(r.auth=new q(p,h)),0===e.config.servers.length&&k.onError(P,new w(I,"One server needs to be configured.")),r.handleServerSelection=r.handleServerSelection.bind((0,a.Z)(r)),l.ZP.config({duration:5}),n.addGcpSecondaryAnnotationServer(e.config);var v=function(e){var t=e.baseUri,n=e.gcpBaseUrl,i=e.settings,o=e.onError,a={default:0},r={};for(var s in i.forEach((function(e){if(null!=e.storageClasses)e.storageClasses.forEach((function(t){Object.values(L).includes(t)?t in a?a[t]+=1:a[t]=1:console.warn('unknown storage class "'.concat(t,'" specified ')+'for configured server "'.concat(e.id,'"'))}));else{if(window.location.pathname.includes("/projects/")){var i=window.location.pathname.split("/study/")[0],s="".concat(n).concat(i,"/dicomWeb");e.url=s}a.default+=1,r.default=new gi({baseUri:t,settings:[e],onError:o})}})),a.default>1&&k.onError(P,new w(I,"Only one default server can be configured without specification of storage classes.")),a)"default"!==s&&a[s]>1&&k.onError(P,new w(I,"Only one configured server can specify a given storage class. "+'Storage class "'.concat(s,'" is specified by more than one ')+"of the configured servers."));return Object.keys(a).length>1&&i.forEach((function(e){var n=new gi({baseUri:t,settings:[e],onError:o});null!=e.storageClasses&&e.storageClasses.forEach((function(e){r[e]=n}))})),Object.values(L).forEach((function(e){e in r||(r[e]=r.default)})),r}({baseUri:d,gcpBaseUrl:null!==(o=e.config.gcpBaseUrl)&&void 0!==o?o:"https://healthcare.googleapis.com/v1",settings:e.config.servers,onError:r.handleDICOMwebError});return r.state={clients:v,defaultClients:v,isLoading:!0,wasAuthSuccessful:!1},r}return(0,o.Z)(n,[{key:"handleServerSelection",value:function(e){var t=e.url.trim();if(console.info("select DICOMweb server: ",t),""!==t&&"default"!==window.localStorage.getItem("slim_server_selection_mode")){window.localStorage.setItem("slim_selected_server",t);var n=new gi({baseUri:"",settings:[{id:"tmp",url:t,read:!0,write:!1}],onError:this.handleDICOMwebError});n.updateHeaders(this.state.clients.default.headers),this.setState((function(e){var t={};for(var i in e.clients)t[i]=n;return{clients:t}}))}else this.setState({clients:this.state.defaultClients})}},{key:"signIn",value:function(){var e=this;void 0!==this.auth?(console.info("try to sign in user"),this.auth.signIn({onSignIn:this.handleSignIn}).then((function(){console.info("sign-in was successful"),e.setState({isLoading:!1,wasAuthSuccessful:!0})})).catch((function(t){console.error(t),k.onError(U,new w(y,"Could not sign-in user.")),e.setState({isLoading:!1,redirectTo:void 0,wasAuthSuccessful:!1})}))):this.setState({isLoading:!1,redirectTo:void 0,wasAuthSuccessful:!0})}},{key:"componentDidMount",value:function(){var e=window.localStorage.getItem("slim_path");null!==e&&void 0!==e&&""!==e||(window.localStorage.setItem("slim_path",window.location.pathname),window.localStorage.setItem("slim_search",window.location.search));var t=window.localStorage.getItem("slim_selected_server");null!==t&&void 0!==t&&""!==t&&this.handleServerSelection({url:t}),this.signIn()}},{key:"render",value:function(){var e,t,n,i,o=this,a={name:this.props.name,version:this.props.version,homepage:this.props.homepage,uid:"1.2.826.0.1.3680043.9.7433.1.5",organization:this.props.config.organization},r=!(null!==(e=this.props.config.disableWorklist)&&void 0!==e&&e),s=null!==(t=this.props.config.enableServerSelection)&&void 0!==t&&t,l=null===(n=this.props.config.enableMemoryMonitoring)||void 0===n||n;i=r?(0,se.jsx)(pi,{clients:this.state.clients}):(0,se.jsx)("div",{children:"Worklist has been disabled."});var u,v=!1;null!=this.props.config.oidc&&null!=this.props.config.oidc.endSessionEndpoint?(u=function(){null!=o.auth&&o.auth.signOut()},v=!0):(u=function(){},v=!1);var m={height:"100vh"},f={height:"100%"};return void 0!==this.state.redirectTo?(0,se.jsx)(h.VK,{basename:this.props.config.path,children:(0,se.jsx)(p.Fg,{to:this.state.redirectTo,replace:!0})}):this.state.isLoading?(0,se.jsx)(h.VK,{basename:this.props.config.path,children:(0,se.jsxs)(c.Z,{style:m,children:[(0,se.jsx)(ni,{app:a,user:this.state.user,showWorklistButton:!1,onServerSelection:this.handleServerSelection,showServerSelectionButton:!1,clients:this.state.clients,defaultClients:this.state.defaultClients}),(0,se.jsx)(c.Z.Content,{style:f,children:(0,se.jsx)(d.fCD,{})})]})}):this.state.wasAuthSuccessful?null!=this.state.error?(0,se.jsx)(oi,{type:"error",message:this.state.error.message}):(0,se.jsx)(h.VK,{basename:this.props.config.path,children:(0,se.jsxs)(p.Z5,{children:[(0,se.jsx)(p.AW,{path:"/",element:(0,se.jsxs)(c.Z,{style:m,children:[(0,se.jsx)(ni,{app:a,user:this.state.user,showWorklistButton:!1,onServerSelection:this.handleServerSelection,onUserLogout:v?u:void 0,showServerSelectionButton:s,clients:this.state.clients,defaultClients:this.state.defaultClients}),(0,se.jsx)(c.Z.Content,{style:f,children:i}),l&&(0,se.jsx)(ci,{enabled:l})]})}),(0,se.jsx)(p.AW,{path:"/studies/:studyInstanceUID/*",element:(0,se.jsxs)(c.Z,{style:m,children:[(0,se.jsx)(ni,{app:a,user:this.state.user,showWorklistButton:r,onServerSelection:this.handleServerSelection,onUserLogout:v?u:void 0,showServerSelectionButton:s,clients:this.state.clients,defaultClients:this.state.defaultClients}),(0,se.jsx)(c.Z.Content,{style:f,children:(0,se.jsx)(Si,{clients:this.state.clients,user:this.state.user,config:this.props.config,app:a})}),l&&(0,se.jsx)(ci,{enabled:l})]})}),(0,se.jsx)(p.AW,{path:"/projects/:project/locations/:location/datasets/:dataset/dicomStores/:dicomStore/study/:studyInstanceUID/*",element:(0,se.jsxs)(c.Z,{style:m,children:[(0,se.jsx)(ni,{app:a,user:this.state.user,showWorklistButton:r,onServerSelection:this.handleServerSelection,onUserLogout:v?u:void 0,showServerSelectionButton:s,clients:this.state.clients,defaultClients:this.state.defaultClients}),(0,se.jsx)(c.Z.Content,{style:f,children:(0,se.jsx)(Si,{clients:this.state.clients,user:this.state.user,config:this.props.config,app:a})}),l&&(0,se.jsx)(ci,{enabled:l})]})}),(0,se.jsx)(p.AW,{path:"/logout",element:(0,se.jsxs)(c.Z,{style:m,children:[(0,se.jsx)(ni,{app:a,user:this.state.user,showWorklistButton:!1,onServerSelection:this.handleServerSelection,onUserLogout:v?u:void 0,showServerSelectionButton:s,clients:this.state.clients,defaultClients:this.state.defaultClients}),(0,se.jsx)(c.Z.Content,{style:f,children:"Logged out"}),l&&(0,se.jsx)(ci,{enabled:l})]})})]})}):(0,se.jsx)(oi,{type:"error",message:"Sign-in failed."})}}],[{key:"addGcpSecondaryAnnotationServer",value:function(e){var t="gcp_secondary_annotation_server",n=new URLSearchParams(window.location.search).get("gcp");void 0===e.servers.find((function(e){return e.id===t}))&&"string"===typeof n&&e.servers.push({id:t,write:!0,url:n,storageClasses:[L.COMPREHENSIVE_SR,L.COMPREHENSIVE_3D_SR,L.SEGMENTATION,L.MICROSCOPY_BULK_SIMPLE_ANNOTATION,L.PARAMETRIC_MAP,L.ADVANCED_BLENDING_PRESENTATION_STATE,L.COLOR_SOFTCOPY_PRESENTATION_STATE,L.GRAYSCALE_SOFTCOPY_PRESENTATION_STATE,L.PSEUDOCOLOR_SOFTCOPY_PRESENTATION_STATE]})}}]),n}(u.Component);const Ii=yi}}]);
//# sourceMappingURL=273.22868715.chunk.js.map